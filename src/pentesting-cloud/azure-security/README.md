# Azure Pentesting

{{#include ../../banners/hacktricks-training.md}}

## Temel Bilgiler

Azure ve Entra ID'nin temellerini öğrenmek için aşağıdaki sayfayı ziyaret edin:

{{#ref}}
az-basic-information/
{{#endref}}

## Azure Pentester/Kırmızı Ekip Metodolojisi

AZURE ortamını denetlemek için bilmek çok önemlidir: hangi **hizmetlerin kullanıldığı**, neyin **açık olduğu**, kimin neye **erişimi** olduğu ve iç Azure hizmetlerinin ve **dış hizmetlerin** nasıl bağlandığı.

Kırmızı Ekip perspektifinden, bir Azure ortamını ele geçirmenin **ilk adımı** bazı **ayak izleri** elde etmektir.

### Dış Enum & İlk Erişim

İlk adım, elbette, saldırdığınız kiracı hakkında bilgi toplamak ve bir ayak izi elde etmeye çalışmaktır.

Alan adı temelinde, **şirketin Azure kullanıp kullanmadığını**, **kiracı ID'sini** öğrenmek, aynı kiracıda başka **geçerli alan adlarını** (varsa) bulmak ve SSO'nun etkin olup olmadığını, e-posta yapılandırmalarını, geçerli kullanıcı e-postalarını gibi **ilgili bilgileri** elde etmek mümkündür...

**Dış enum** gerçekleştirmek için aşağıdaki sayfayı kontrol edin:

{{#ref}}
az-unauthenticated-enum-and-initial-entry/
{{#endref}}

Bu bilgilerle, bir ayak izi elde etmeye çalışmanın en yaygın yolları şunlardır:
- **OSINT**: **leak**'leri Github veya başka herhangi bir açık kaynak platformda kontrol edin, bu platformlar **kimlik bilgileri** veya ilginç bilgiler içerebilir.
- **Şifre** yeniden kullanımı, sızıntılar veya [şifre püskürtme](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)
- Bir çalışandan kimlik bilgileri satın almak
- [**Yaygın Phishing**](https://book.hacktricks.wiki/en/generic-methodologies-and-resources/phishing-methodology/index.html) (kimlik bilgileri veya Oauth Uygulaması)
- [Cihaz Kodu Kimlik Avı](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
- 3. tarafların **ihlal edilmesi**
- Azure'da Barındırılan Uygulamalardaki Güvenlik Açıkları
- [**Sunucu Tarafı İstek Sahteciliği**](https://book.hacktricks.wiki/en/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf.html) ile meta veri uç noktasına erişim
- **Alt alan ele geçirmeleri** gibi [https://godiego.co/posts/STO-Azure/](https://godiego.co/posts/STO-Azure/)
- Eğer bir geliştirici dizüstü bilgisayarı ele geçirilmişse ([WinPEAS ve LinPEAS](https://github.com/peass-ng/PEASS-ng) bu bilgiyi bulabilir):
- İçinde **`<HOME>/.Azure`**
- **`azureProfile.json`** geçmişte oturum açmış kullanıcılar hakkında bilgi içerir
- **`clouds.config`** abonelikler hakkında bilgi içerir
- **`service_principal_entries.json`** uygulama kimlik bilgilerini içerir (kiracı id, istemciler ve gizli anahtar). Sadece Linux & macOS'ta
- **`msal_token_cache.json`** erişim jetonları ve yenileme jetonlarını içerir. Sadece Linux & macOS'ta
- **`service_principal_entries.bin`** ve msal_token_cache.bin Windows'ta kullanılır ve DPAPI ile şifrelenmiştir
- **`msal_http_cache.bin`** HTTP isteği önbelleğidir
- Yükleyin: `with open("msal_http_cache.bin", 'rb') as f: pickle.load(f)`
- **`AzureRmContext.json`** Az PowerShell kullanarak önceki oturum açma bilgilerini içerir (ancak kimlik bilgileri yoktur)
- İçinde **`C:\Users\<username>\AppData\Local\Microsoft\IdentityCache\*`** kullanıcıların DPAPI ile şifrelenmiş **erişim jetonları**, ID jetonları ve hesap bilgileri içeren birkaç `.bin` dosyası vardır.
- **`C:\Users\<username>\AppData\Local\Microsoft\TokenBroken\Cache\`** içindeki `.tbres` dosyalarında daha fazla **erişim jetonu** bulmak mümkündür; bu dosyalar DPAPI ile şifrelenmiş base64 içerir.
- Linux ve macOS'ta, Az PowerShell kullanarak **erişim jetonları, yenileme jetonları ve id jetonları** elde edebilirsiniz (kullanıldıysa) `pwsh -Command "Save-AzContext -Path /tmp/az-context.json"` komutunu çalıştırarak
- Windows'ta bu sadece id jetonları üretir.
- Linux ve macOS'ta Az PowerShell'in kullanılıp kullanılmadığını kontrol etmek mümkündür; `$HOME/.local/share/.IdentityService/` var mı diye bakarak (içindeki dosyalar boş ve işe yaramaz olsa da)

> [!NOTE]
> Unutmayın ki genellikle **en gürültülü** kısım **giriş** kısmıdır, kendisi değil.

### Azure & Entra ID Araçları

Aşağıdaki araçlar, hem Entra ID kiracılarını hem de Azure ortamlarını yavaş (tespit edilmemek için) veya otomatik olarak (zaman kazanmak için) listelemek için çok faydalı olacaktır:

{{#ref}}
az-enumeration-tools.md
{{#endref}}

### Giriş Koşullarını Aşma

<figure><img src="../../images/image (268).png" alt=""><figcaption></figcaption></figure>

Geçerli kimlik bilgileriniz olsa da giriş yapamadığınız durumlarda, mevcut olabilecek bazı yaygın korumalar şunlardır:

- **IP beyaz listeleme** -- Geçerli bir IP'yi ele geçirmeniz gerekir
- **Coğrafi kısıtlamalar** -- Kullanıcının nerede yaşadığını veya şirketin ofislerinin nerede olduğunu bulmak ve aynı şehirden (veya en azından aynı ülkeden) bir IP almak
- **Tarayıcı** -- Belki de yalnızca belirli bir işletim sisteminden (Windows, Linux, Mac, Android, iOS) bir tarayıcıya izin verilmektedir. Kurbanın/şirketin hangi işletim sistemini kullandığını öğrenin.
- Ayrıca, genellikle daha az sınırlı olan ve girişi daha az denetlenen **Hizmet Prensibi kimlik bilgilerini** ele geçirmeyi de deneyebilirsiniz.

Bunu aştıktan sonra, başlangıç ayarlarınıza geri dönebilir ve hala erişiminiz olabilir.

### Whoami

> [!CAUTION]
> [**Az - Entra ID**](az-services/az-azuread.md) bölümünde az cli, AzureAD ve Az PowerShell'in **nasıl kurulacağını** öğrenin.

Bilmeniz gereken ilk şey **kim olduğunuzdur** (hangi ortamda olduğunuz):

{{#tabs }}
{{#tab name="az cli" }}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{{#endtab }}

{{#tab name="Az" }}
```bash
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
```
{{#endtab }}

{{#tab name="Mg" }}
```bash
#Get the current session
Get-MgContext
```
{{#endtab }}

{{#tab name="AzureAD" }}
```bash
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{{#endtab }}
{{#endtabs }}


### Entra ID Sayımı ve Yetki Yükseltme

Varsayılan olarak, herhangi bir kullanıcının **kullanıcılar, gruplar, roller, hizmet ilkeleri gibi şeyleri saymak için yeterli izinlere sahip olması gerekir**... (bakınız [varsayılan AzureAD izinleri](az-basic-information/index.html#default-user-permissions)).\
Burada bir kılavuz bulabilirsiniz:

{{#ref}}
az-services/az-azuread.md
{{#endref}}

Entra ID'de yetki yükseltmek için **AzureHound** gibi araçlar bulmak için **Post-Exploitation araçlarına** göz atın:

{{#ref}}
az-enumeration-tools.md#automated-post-exploitation-tools
{{#endref}}


### Azure Hizmetlerini Sayma

Kendinizi tanıdıktan sonra, **erişim sağladığınız Azure hizmetlerini saymaya** başlayabilirsiniz.

Az PowerShell komutu **`Get-AzResource`**, **mevcut kullanıcınızın görünürlüğü olan kaynakları bilmenizi sağlar**.

Ayrıca, **web konsolunda** [https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll) adresine giderek veya "Tüm kaynaklar" araması yaparak ya da `az rest --method GET --url "https://management.azure.com/subscriptions/<subscription-id>/resources?api-version=2021-04-01"` komutunu çalıştırarak aynı bilgiyi alabilirsiniz.

Dahası, yeterli izinlere sahip olduğunuzda, **`Get-AzRoleAssignment`** rolü, abonelikteki **tüm rolleri saymak veya belirli bir kaynak üzerindeki izinleri** belirtmek için kullanılabilir; bunu şu şekilde gösterebilirsiniz: **`Get-AzRoleAssignment -Scope /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.RecoveryServices/vaults/vault-m3ww8ut4`**

Aşağıdaki bölümde, en yaygın Azure hizmetleri ve bunları nasıl sayacağınız hakkında bilgi bulabilirsiniz:

{{#ref}}
az-services/
{{#endref}}

### Yetki Yükseltme, Post-Exploitation ve Azure Hizmetlerinde Süreklilik

Azure ortamının nasıl yapılandığını ve hangi hizmetlerin kullanıldığını öğrendikten sonra, **yetki yükseltme, yan hareket etme, diğer post-exploitation saldırılarını gerçekleştirme ve sürekliliği sağlama** yollarını aramaya başlayabilirsiniz.

Aşağıdaki bölümde, en yaygın Azure hizmetlerinde yetki yükseltme hakkında bilgi bulabilirsiniz:

{{#ref}}
az-privilege-escalation/
{{#endref}}

Aşağıdaki bölümde, en yaygın Azure hizmetlerinde post-exploitation saldırılarını nasıl gerçekleştireceğiniz hakkında bilgi bulabilirsiniz:

{{#ref}}
az-post-exploitation/
{{#endref}}

Aşağıdaki bölümde, en yaygın Azure hizmetlerinde sürekliliği nasıl sağlayacağınız hakkında bilgi bulabilirsiniz:

{{#ref}}
az-persistence/
{{#endref}}

{{#include ../../banners/hacktricks-training.md}}
