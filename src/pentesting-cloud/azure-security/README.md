# Azure Pentesting

{{#include ../../banners/hacktricks-training.md}}

## Temel Bilgiler

{{#ref}}
az-basic-information/
{{#endref}}

## Azure Pentester/Kırmızı Ekip Metodolojisi

AZURE ortamını denetlemek için bilmek çok önemlidir: hangi **hizmetlerin kullanıldığı**, neyin **açık olduğu**, kimin neye **erişimi** olduğu ve iç Azure hizmetlerinin ve **dış hizmetlerin** nasıl bağlandığı.

Kırmızı Ekip perspektifinden, bir Azure ortamını ele geçirmenin **ilk adımı**, Azure AD için bazı **kimlik bilgilerini** elde etmeyi başarmaktır. Bunu nasıl yapacağınıza dair bazı fikirler:

- GitHub'daki **sızıntılar** (veya benzeri) - OSINT
- **Sosyal** Mühendislik
- **Şifre** yeniden kullanımı (şifre sızıntıları)
- Azure'da Barındırılan Uygulamalardaki Güvenlik Açıkları
- [**Sunucu Tarafı İstek Sahteciliği**](https://book.hacktricks.wiki/en/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf.html) ile meta veri uç noktasına erişim
- **Yerel Dosya Okuma**
- `/home/KULLANICI_ADI/.azure`
- `C:\Users\KULLANICI_ADI\.azure`
- **`accessTokens.json`** dosyası `az cli` 2.30'dan önce - Ocak 2022 - **açık metin** olarak **erişim jetonları** saklıyordu
- **`azureProfile.json`** dosyası oturum açmış kullanıcı hakkında **bilgi** içerir.
- **`az logout`** jetonu kaldırır.
- Eski sürümler **`Az PowerShell`** **erişim jetonlarını** **açık** metin olarak **`TokenCache.dat`** dosyasında saklıyordu. Ayrıca **ServicePrincipalSecret**'i **açık** metin olarak **`AzureRmContext.json`** dosyasında saklar. **`Save-AzContext`** cmdlet'i **jetonları** **saklamak** için kullanılabilir.\
`Disconnect-AzAccount` kullanarak bunları kaldırın.
- 3. taraflar **ihlal edildi**
- **İç** Çalışan
- [**Yaygın Phishing**](https://book.hacktricks.wiki/en/generic-methodologies-and-resources/phishing-methodology/index.html) (kimlik bilgileri veya Oauth Uygulaması)
- [Cihaz Kodu Kimlik Doğrulama Phishing](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
- [Azure **Şifre Spraying**](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

Azure kiracısında **hiçbir kullanıcıyı ele geçirmediyseniz** bile, ondan **bazı bilgiler** toplayabilirsiniz:

{{#ref}}
az-unauthenticated-enum-and-initial-entry/
{{#endref}}

> [!NOTE]
> Kimlik bilgilerini elde etmeyi başardıktan sonra, bu kimlik bilgilerin kime ait olduğunu ve **neye erişim sağladıklarını** bilmeniz gerekir, bu nedenle bazı temel sayım işlemleri yapmanız gerekir:

## Temel Sayım

> [!NOTE]
> Sayımın **en gürültülü** kısmının **giriş** olduğunu, sayımın kendisi olmadığını unutmayın.

### SSRF

Azure içindeki bir makinede bir SSRF bulursanız, bu sayfayı hileler için kontrol edin:

{{#ref}}
https://book.hacktricks.wiki/en/generic-methodologies-and-resources/phishing-methodology/index.html
{{#endref}}

### Giriş Koşullarını Aşma

<figure><img src="../../images/image (268).png" alt=""><figcaption></figcaption></figure>

Geçerli kimlik bilgilerine sahip olduğunuz ancak giriş yapamadığınız durumlarda, mevcut olabilecek bazı yaygın korumalar şunlardır:

- **IP beyaz listeleme** -- Geçerli bir IP'yi ele geçirmeniz gerekir
- **Coğrafi kısıtlamalar** -- Kullanıcının nerede yaşadığını veya şirketin ofislerinin nerede olduğunu bulup aynı şehirden (veya en azından aynı ülkeden) bir IP alın
- **Tarayıcı** -- Belki de yalnızca belirli bir işletim sisteminden (Windows, Linux, Mac, Android, iOS) bir tarayıcıya izin verilmektedir. Kurbanın/şirketin hangi işletim sistemini kullandığını öğrenin.
- Ayrıca, genellikle daha az sınırlı olan ve girişinin daha az incelendiği **Service Principal kimlik bilgilerini** ele geçirmeyi de deneyebilirsiniz.

Bunu aştıktan sonra, başlangıç ayarınıza geri dönebilir ve hala erişiminiz olabilir.

### Alt Alan Ele Geçirme

- [https://godiego.co/posts/STO-Azure/](https://godiego.co/posts/STO-Azure/)

### Whoami

> [!CAUTION]
> az cli, AzureAD ve Az PowerShell'i [**Az - Entra ID**](az-services/az-azuread.md) bölümünde **nasıl kuracağınızı** öğrenin.

Bilmeniz gereken ilk şey **kim olduğunuzdur** (hangi ortamda olduğunuz):

{{#tabs }}
{{#tab name="az cli" }}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{{#endtab }}

{{#tab name="AzureAD" }}
```bash
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{{#endtab }}

{{#tab name="Az PowerShell" }}
```bash
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
{{#endtab }}
{{#endtabs }}

> [!CAUTION]
> Azure'ı listelemek için en önemli komutlardan biri **`Get-AzResource`**'dır, çünkü bu komut **mevcut kullanıcınızın görünürlüğü olan kaynakları bilmenizi sağlar**.
>
> Aynı bilgiyi **web konsolunda** [https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll) adresine giderek veya "Tüm kaynaklar" araması yaparak alabilirsiniz.

### Entra ID Listeleme

Varsayılan olarak, herhangi bir kullanıcının **kullanıcılar, gruplar, roller, hizmet ilkeleri gibi şeyleri listelemek için yeterli izinlere sahip olması gerekir**... (bakınız [varsayılan AzureAD izinleri](az-basic-information/index.html#default-user-permissions)).\
Burada bir kılavuz bulabilirsiniz:

{{#ref}}
az-services/az-azuread.md
{{#endref}}

> [!NOTE]
> Artık **kimlik bilgileriniz hakkında bazı bilgilere sahipsiniz** (ve eğer bir kırmızı takım üyesiyseniz umarım **tespit edilmemişsinizdir**). Ortamda hangi hizmetlerin kullanıldığını anlamanın zamanı geldi.\
> Aşağıdaki bölümde **bazı yaygın hizmetleri listelemek için bazı yolları** kontrol edebilirsiniz.

## App Service SCM

App Service 'konteynerine' giriş yapmak için Kudu konsolu.

## Webshell

portal.azure.com'u kullanın ve shell'i seçin veya bash veya powershell için shell.azure.com'u kullanın. Bu shell'in 'diskleri', bir depolama hesabında bir görüntü dosyası olarak saklanır.

## Azure DevOps

Azure DevOps, Azure'dan ayrıdır. Depolar, boru hatları (yaml veya sürüm), panolar, wiki ve daha fazlasını içerir. Değişken Grupları, değişken değerlerini ve gizli bilgileri saklamak için kullanılır.

{{#include ../../banners/hacktricks-training.md}}
