# Azure Pentesting

{{#include ../../banners/hacktricks-training.md}}

## 基本情報

{{#ref}}
az-basic-information/
{{#endref}}

## Azure ペンテスター/レッドチームの方法論

AZURE 環境を監査するためには、どの **サービスが使用されているか**、何が **公開されているか**、誰が **何にアクセスできるか**、内部の Azure サービスと **外部サービス** がどのように接続されているかを知ることが非常に重要です。

レッドチームの観点から、**Azure 環境を侵害するための最初のステップ**は、Azure AD の **資格情報**を取得することです。以下はその方法に関するいくつかのアイデアです：

- GitHub（または類似の）での **漏洩** - OSINT
- **ソーシャル** エンジニアリング
- **パスワード** の再利用（パスワード漏洩）
- Azure ホスティングアプリケーションの脆弱性
- [**サーバーサイドリクエストフォージェリ**](https://book.hacktricks.wiki/en/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf.html) メタデータエンドポイントへのアクセス
- **ローカルファイル読み取り**
- `/home/USERNAME/.azure`
- `C:\Users\USERNAME\.azure`
- **`accessTokens.json`** ファイル（az cli 2.30以前 - 2022年1月） - **アクセス トークンを平文で保存**
- **`azureProfile.json`** ファイルには **ログインユーザー** に関する **情報** が含まれています。
- **`az logout`** はトークンを削除します。
- 古いバージョンの **`Az PowerShell`** は **アクセス トークン** を **平文** で **`TokenCache.dat`** に保存していました。また、**`AzureRmContext.json`** に **ServicePrincipalSecret** を **平文** で保存します。コマンドレット **`Save-AzContext`** を使用して **トークン** を **保存** できます。\
`Disconnect-AzAccount` を使用してそれらを削除します。
- 第三者が **侵害された**
- **内部** 従業員
- [**一般的なフィッシング**](https://book.hacktricks.wiki/en/generic-methodologies-and-resources/phishing-methodology/index.html)（資格情報または Oauth アプリ）
- [デバイスコード認証フィッシング](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
- [Azure **パスワードスプレー**](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

攻撃している Azure テナント内で **ユーザーを侵害していなくても**、そこから **情報を収集** することができます：

{{#ref}}
az-unauthenticated-enum-and-initial-entry/
{{#endref}}

> [!NOTE]
> 資格情報を取得した後は、その資格情報が **誰のものであるか**、および **何にアクセスできるか** を知る必要があるため、いくつかの基本的な列挙を行う必要があります：

## 基本的な列挙

> [!NOTE]
> 列挙の **最も騒がしい** 部分は **ログイン** であり、列挙自体ではありません。

### SSRF

Azure 内のマシンで SSRF を見つけた場合は、トリックについてこのページを確認してください：

{{#ref}}
https://book.hacktricks.wiki/en/generic-methodologies-and-resources/phishing-methodology/index.html
{{#endref}}

### ログイン条件のバイパス

<figure><img src="../../images/image (268).png" alt=""><figcaption></figcaption></figure>

有効な資格情報があるがログインできない場合、以下は考えられる一般的な保護です：

- **IP ホワイトリスト** -- 有効な IP を侵害する必要があります
- **地理的制限** -- ユーザーが住んでいる場所や会社のオフィスがある場所を見つけ、同じ都市（または少なくとも同じ国）の IP を取得します
- **ブラウザ** -- 特定の OS（Windows、Linux、Mac、Android、iOS）からのブラウザのみが許可されているかもしれません。被害者/会社が使用している OS を特定します。
- **サービスプリンシパルの資格情報を侵害する**ことも試みることができます。通常、制限が少なく、ログインがあまりレビューされません。

バイパスした後、初期設定に戻り、引き続きアクセスできる可能性があります。

### サブドメインの乗っ取り

- [https://godiego.co/posts/STO-Azure/](https://godiego.co/posts/STO-Azure/)

### Whoami

> [!CAUTION]
> az cli、AzureAD、および Az PowerShell の **インストール方法** を [**Az - Entra ID**](az-services/az-azuread.md) セクションで学んでください。

最初に知っておくべきことは **自分が誰であるか**（どの環境にいるか）です：

{{#tabs }}
{{#tab name="az cli" }}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{{#endtab }}

{{#tab name="AzureAD" }}
```bash
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{{#endtab }}

{{#tab name="Az PowerShell" }}
```bash
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
{{#endtab }}
{{#endtabs }}

> [!CAUTION]
> Azureを列挙するための最も重要なコマンドの1つは**`Get-AzResource`**であり、これにより**現在のユーザーが可視性を持つリソースを知ることができます**。
>
> 同じ情報を**ウェブコンソール**で取得するには、[https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll)にアクセスするか、「すべてのリソース」を検索してください。

### Entra ID Enumeration

デフォルトでは、任意のユーザーは**ユーザー、グループ、ロール、サービスプリンシパルなどを列挙するのに十分な権限を持っているはずです**（[デフォルトのAzureAD権限](az-basic-information/index.html#default-user-permissions)を確認してください）。\
ここにガイドがあります：

{{#ref}}
az-services/az-azuread.md
{{#endref}}

> [!NOTE]
> これで**資格情報に関する情報を持っている**（そして、もしあなたがレッドチームであれば、幸運にも**検出されていないことを願っています**）。環境で使用されているサービスを特定する時が来ました。\
> 次のセクションでは、**一般的なサービスを列挙する方法**をいくつか確認できます。

## App Service SCM

App Service 'コンテナ'にログインするためのKuduコンソール。

## Webshell

portal.azure.comを使用してシェルを選択するか、bashまたはpowershell用にshell.azure.comを使用します。このシェルの'disk'は、ストレージアカウント内のイメージファイルとして保存されます。

## Azure DevOps

Azure DevOpsはAzureとは別です。リポジトリ、パイプライン（yamlまたはリリース）、ボード、ウィキなどがあります。変数グループは、変数値と秘密を保存するために使用されます。

{{#include ../../banners/hacktricks-training.md}}
