# Azure Pentesting

{{#include ../../banners/hacktricks-training.md}}

## Basic Information

{{#ref}}
az-basic-information/
{{#endref}}

## Azure Pentester/Red Team Methodology

Για να ελέγξετε ένα περιβάλλον AZURE, είναι πολύ σημαντικό να γνωρίζετε: ποιες **υπηρεσίες χρησιμοποιούνται**, τι **εκτίθεται**, ποιος έχει **πρόσβαση** σε τι και πώς συνδέονται οι εσωτερικές υπηρεσίες Azure με τις **εξωτερικές υπηρεσίες**.

Από την οπτική γωνία της Red Team, το **πρώτο βήμα για να συμβιβαστεί ένα περιβάλλον Azure** είναι να καταφέρετε να αποκτήσετε κάποια **διαπιστευτήρια** για το Azure AD. Εδώ έχετε μερικές ιδέες για το πώς να το κάνετε αυτό:

- **Leaks** στο github (ή παρόμοια) - OSINT
- **Social** Engineering
- **Password** reuse (password leaks)
- Ευπάθειες σε εφαρμογές που φιλοξενούνται στο Azure
- [**Server Side Request Forgery**](https://book.hacktricks.wiki/en/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf.html) με πρόσβαση στο endpoint μεταδεδομένων
- **Local File Read**
- `/home/USERNAME/.azure`
- `C:\Users\USERNAME\.azure`
- Το αρχείο **`accessTokens.json`** στο `az cli` πριν από την 2.30 - Ιαν2022 - αποθηκευμένα **access tokens σε καθαρό κείμενο**
- Το αρχείο **`azureProfile.json`** περιέχει **info** για τον συνδεδεμένο χρήστη.
- **`az logout`** αφαιρεί το token.
- Παλαιότερες εκδόσεις του **`Az PowerShell`** αποθήκευαν **access tokens** σε **καθαρό** κείμενο στο **`TokenCache.dat`**. Αποθηκεύει επίσης το **ServicePrincipalSecret** σε **καθαρό** κείμενο στο **`AzureRmContext.json`**. Η cmdlet **`Save-AzContext`** μπορεί να χρησιμοποιηθεί για να **αποθηκεύσει** **tokens**.\
Χρησιμοποιήστε το `Disconnect-AzAccount` για να τα αφαιρέσετε.
- 3rd parties **breached**
- **Internal** Employee
- [**Common Phishing**](https://book.hacktricks.wiki/en/generic-methodologies-and-resources/phishing-methodology/index.html) (credentials or Oauth App)
- [Device Code Authentication Phishing](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
- [Azure **Password Spraying**](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

Ακόμα και αν δεν έχετε **συμβιβάσει κανέναν χρήστη** μέσα στο Azure tenant που επιτίθεστε, μπορείτε να **συγκεντρώσετε κάποιες πληροφορίες** από αυτό:

{{#ref}}
az-unauthenticated-enum-and-initial-entry/
{{#endref}}

> [!NOTE]
> Αφού καταφέρετε να αποκτήσετε διαπιστευτήρια, πρέπει να γνωρίζετε **σε ποιον ανήκουν αυτά τα creds**, και **σε τι έχουν πρόσβαση**, οπότε πρέπει να εκτελέσετε κάποια βασική αρίθμηση:

## Basic Enumeration

> [!NOTE]
> Θυμηθείτε ότι το **θορυβώδες** μέρος της αρίθμησης είναι η **σύνδεση**, όχι η ίδια η αρίθμηση.

### SSRF

Αν βρείτε μια SSRF σε μια μηχανή μέσα στο Azure, ελέγξτε αυτή τη σελίδα για κόλπα:

{{#ref}}
https://book.hacktricks.wiki/en/generic-methodologies-and-resources/phishing-methodology/index.html
{{#endref}}

### Bypass Login Conditions

<figure><img src="../../images/image (268).png" alt=""><figcaption></figcaption></figure>

Σε περιπτώσεις όπου έχετε κάποια έγκυρα διαπιστευτήρια αλλά δεν μπορείτε να συνδεθείτε, αυτές είναι μερικές κοινές προστασίες που θα μπορούσαν να είναι σε εφαρμογή:

- **IP whitelisting** -- Πρέπει να συμβιβάσετε μια έγκυρη IP
- **Geo restrictions** -- Βρείτε πού ζει ο χρήστης ή πού βρίσκονται τα γραφεία της εταιρείας και αποκτήστε μια IP από την ίδια πόλη (ή τουλάχιστον από την ίδια χώρα)
- **Browser** -- Ίσως μόνο ένας περιηγητής από ορισμένα OS (Windows, Linux, Mac, Android, iOS) να επιτρέπεται. Ανακαλύψτε ποιο OS χρησιμοποιεί το θύμα/εταιρεία.
- Μπορείτε επίσης να προσπαθήσετε να **συμβιβάσετε τα διαπιστευτήρια του Service Principal** καθώς συνήθως είναι λιγότερο περιορισμένα και η σύνδεσή τους ελέγχεται λιγότερο.

Αφού το παρακάμψετε, μπορεί να είστε σε θέση να επιστρέψετε στην αρχική σας ρύθμιση και θα έχετε ακόμα πρόσβαση.

### Subdomain Takeover

- [https://godiego.co/posts/STO-Azure/](https://godiego.co/posts/STO-Azure/)

### Whoami

> [!CAUTION]
> Μάθετε **πώς να εγκαταστήσετε** το az cli, AzureAD και Az PowerShell στην ενότητα [**Az - Entra ID**](az-services/az-azuread.md).

Ένα από τα πρώτα πράγματα που πρέπει να γνωρίζετε είναι **ποιος είστε** (σε ποιο περιβάλλον βρίσκεστε):

{{#tabs }}
{{#tab name="az cli" }}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{{#endtab }}

{{#tab name="AzureAD" }}
```bash
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{{#endtab }}

{{#tab name="Az PowerShell" }}
```bash
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
{{#endtab }}
{{#endtabs }}

> [!CAUTION]
> Ένα από τα πιο σημαντικά εντολές για την καταμέτρηση του Azure είναι **`Get-AzResource`** από το Az PowerShell καθώς σας επιτρέπει να **γνωρίζετε τους πόρους που έχει ο τρέχων χρήστης ορατούς**.
>
> Μπορείτε να αποκτήσετε τις ίδιες πληροφορίες στην **ιστοσελίδα κονσόλας** πηγαίνοντας στο [https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll) ή αναζητώντας "Όλοι οι πόροι"

### Entra ID Enumeration

Από προεπιλογή, οποιοσδήποτε χρήστης θα πρέπει να έχει **αρκετά δικαιώματα για να καταμετρήσει** πράγματα όπως, χρήστες, ομάδες, ρόλους, υπηρεσιακούς εκπροσώπους... (ελέγξτε [προεπιλεγμένα δικαιώματα AzureAD](az-basic-information/index.html#default-user-permissions)).\
Μπορείτε να βρείτε εδώ έναν οδηγό:

{{#ref}}
az-services/az-azuread.md
{{#endref}}

> [!NOTE]
> Τώρα που **έχετε κάποιες πληροφορίες σχετικά με τα διαπιστευτήριά σας** (και αν είστε red team ελπίζω να **δεν έχετε ανιχνευθεί**). Είναι καιρός να καταλάβετε ποιες υπηρεσίες χρησιμοποιούνται στο περιβάλλον.\
> Στην επόμενη ενότητα μπορείτε να ελέγξετε μερικούς τρόπους για να **καταμετρήσετε κάποιες κοινές υπηρεσίες.**

## App Service SCM

Kudu console για να συνδεθείτε στο 'container' της Υπηρεσίας Εφαρμογών.

## Webshell

Χρησιμοποιήστε το portal.azure.com και επιλέξτε το shell, ή χρησιμοποιήστε το shell.azure.com, για bash ή powershell. Ο 'δίσκος' αυτού του shell αποθηκεύεται ως αρχείο εικόνας σε έναν λογαριασμό αποθήκευσης.

## Azure DevOps

Το Azure DevOps είναι ξεχωριστό από το Azure. Έχει αποθετήρια, pipelines (yaml ή release), πίνακες, wiki και άλλα. Οι Ομάδες Μεταβλητών χρησιμοποιούνται για να αποθηκεύουν τιμές μεταβλητών και μυστικά.

{{#include ../../banners/hacktricks-training.md}}
