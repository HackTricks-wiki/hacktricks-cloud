# Azure Pentesting

{{#include ../../banners/hacktricks-training.md}}

## 기본 정보

{{#ref}}
az-basic-information/
{{#endref}}

## Azure 펜테스터/레드 팀 방법론

AZURE 환경을 감사하기 위해서는 **어떤 서비스가 사용되고 있는지**, **무엇이 노출되고 있는지**, **누가 무엇에 접근할 수 있는지**, 그리고 내부 Azure 서비스와 **외부 서비스**가 어떻게 연결되어 있는지를 아는 것이 매우 중요합니다.

레드 팀 관점에서 **Azure 환경을 침해하기 위한 첫 번째 단계**는 Azure AD에 대한 **자격 증명**을 얻는 것입니다. 이를 수행하는 방법에 대한 몇 가지 아이디어는 다음과 같습니다:

- github(또는 유사한 곳)의 **누출** - OSINT
- **소셜** 엔지니어링
- **비밀번호** 재사용 (비밀번호 누출)
- Azure 호스팅 애플리케이션의 취약점
- [**서버 측 요청 위조**](https://book.hacktricks.wiki/en/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf.html) 메타데이터 엔드포인트에 접근
- **로컬 파일 읽기**
- `/home/USERNAME/.azure`
- `C:\Users\USERNAME\.azure`
- **`accessTokens.json`** 파일은 `az cli` 2.30 이전 - 2022년 1월 - **명확한 텍스트**로 저장된 **액세스 토큰**
- **`azureProfile.json`** 파일은 로그인한 사용자에 대한 **정보**를 포함합니다.
- **`az logout`**는 토큰을 제거합니다.
- 이전 버전의 **`Az PowerShell`**은 **`TokenCache.dat`**에 **명확한** 텍스트로 **액세스 토큰**을 저장했습니다. 또한 **`AzureRmContext.json`**에 **명확한** 텍스트로 **ServicePrincipalSecret**을 저장합니다. **`Save-AzContext`** cmdlet을 사용하여 **토큰**을 **저장**할 수 있습니다.\
`Disconnect-AzAccount`를 사용하여 제거합니다.
- 제3자 **침해**
- **내부** 직원
- [**일반 피싱**](https://book.hacktricks.wiki/en/generic-methodologies-and-resources/phishing-methodology/index.html) (자격 증명 또는 Oauth 앱)
- [장치 코드 인증 피싱](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
- [Azure **비밀번호 스프레이**](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

Azure 테넌트 내에서 **어떤 사용자도 침해하지 않았다 하더라도**, 여전히 **정보를 수집할 수 있습니다**:

{{#ref}}
az-unauthenticated-enum-and-initial-entry/
{{#endref}}

> [!NOTE]
> 자격 증명을 얻은 후에는 **그 자격 증명이 누구에게 속하는지**와 **그들이 무엇에 접근할 수 있는지** 알아야 하므로, 기본적인 열거 작업을 수행해야 합니다:

## 기본 열거

> [!NOTE]
> 열거의 **가장 시끄러운** 부분은 **로그인**이며, 열거 자체는 아닙니다.

### SSRF

Azure 내의 머신에서 SSRF를 발견했다면, 이 페이지에서 요령을 확인하세요:

{{#ref}}
https://book.hacktricks.wiki/en/generic-methodologies-and-resources/phishing-methodology/index.html
{{#endref}}

### 로그인 조건 우회

<figure><img src="../../images/image (268).png" alt=""><figcaption></figcaption></figure>

유효한 자격 증명이 있지만 로그인할 수 없는 경우, 다음은 적용될 수 있는 일반적인 보호 조치입니다:

- **IP 화이트리스트** -- 유효한 IP를 침해해야 합니다.
- **지리적 제한** -- 사용자가 거주하는 곳이나 회사의 사무실이 있는 곳을 찾아 같은 도시(또는 최소한 같은 국가)의 IP를 얻습니다.
- **브라우저** -- 특정 OS(Windows, Linux, Mac, Android, iOS)에서만 허용될 수 있습니다. 피해자/회사가 사용하는 OS를 알아내세요.
- **서비스 주체 자격 증명**을 침해하려고 시도할 수도 있습니다. 일반적으로 제한이 적고 로그인 검토가 덜합니다.

이를 우회한 후, 초기 설정으로 돌아가 여전히 접근할 수 있을 것입니다.

### 서브도메인 인수

- [https://godiego.co/posts/STO-Azure/](https://godiego.co/posts/STO-Azure/)

### Whoami

> [!CAUTION]
> [**Az - Entra ID**](az-services/az-azuread.md) 섹션에서 az cli, AzureAD 및 Az PowerShell을 **설치하는 방법**을 배우세요.

가장 먼저 알아야 할 것은 **당신이 누구인지** (어떤 환경에 있는지)입니다:

{{#tabs }}
{{#tab name="az cli" }}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{{#endtab }}

{{#tab name="AzureAD" }}
```bash
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{{#endtab }}

{{#tab name="Az PowerShell" }}
```bash
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
{{#endtab }}
{{#endtabs }}

> [!CAUTION]
> Azure를 열거하는 데 가장 중요한 명령 중 하나는 **`Get-AzResource`**입니다. 이 명령은 **현재 사용자가 볼 수 있는 리소스를 알 수 있게 해줍니다**.
>
> 동일한 정보를 **웹 콘솔**에서 [https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll)으로 가거나 "모든 리소스"를 검색하여 얻을 수 있습니다.

### Entra ID 열거

기본적으로, 모든 사용자는 **사용자, 그룹, 역할, 서비스 주체**와 같은 항목을 열거할 수 있는 **충분한 권한을 가져야 합니다**... ( [기본 AzureAD 권한](az-basic-information/index.html#default-user-permissions)을 확인하세요).\
여기에서 가이드를 찾을 수 있습니다:

{{#ref}}
az-services/az-azuread.md
{{#endref}}

> [!NOTE]
> 이제 **자격 증명에 대한 정보가 있습니다** (그리고 레드 팀이라면 **발견되지 않았기를 바랍니다**). 환경에서 사용 중인 서비스가 무엇인지 파악할 시간입니다.\
> 다음 섹션에서는 **일반 서비스 열거 방법**을 확인할 수 있습니다.

## App Service SCM

App Service '컨테이너'에 로그인하기 위한 Kudu 콘솔입니다.

## Webshell

portal.azure.com을 사용하여 셸을 선택하거나 shell.azure.com을 사용하여 bash 또는 powershell을 사용할 수 있습니다. 이 셸의 '디스크'는 스토리지 계정에 이미지 파일로 저장됩니다.

## Azure DevOps

Azure DevOps는 Azure와 별개입니다. 리포지토리, 파이프라인(yaml 또는 릴리스), 보드, 위키 등이 있습니다. 변수 그룹은 변수 값과 비밀을 저장하는 데 사용됩니다.

{{#include ../../banners/hacktricks-training.md}}
