# Azure Pentesting

{{#include ../../banners/hacktricks-training.md}}

## Temel Bilgiler

Azure ve Entra ID'nin temellerini öğrenmek için aşağıdaki sayfayı ziyaret edin:

{{#ref}}
az-basic-information/
{{#endref}}

## Azure Pentester/Kırmızı Takım Metodolojisi

AZURE ortamını denetlemek için bilmek çok önemlidir: hangi **hizmetlerin kullanıldığı**, neyin **açık olduğu**, kimin neye **erişimi olduğu** ve iç Azure hizmetlerinin ve **dış hizmetlerin** nasıl bağlandığı.

Kırmızı takım bakış açısıyla, bir Azure ortamını ele geçirmenin **ilk adımı** bazı **ayak izleri** elde etmektir.

### Dış Enum & İlk Erişim

İlk adım, elbette, saldırdığınız kiracı hakkında bilgi toplamak ve bir ayak izi elde etmeye çalışmaktır.

Alan adı temelinde, **şirketin Azure kullanıp kullanmadığını**, **kiracı ID'sini**, aynı kiracıda (varsa) diğer **geçerli alan adlarını** ve SSO'nun etkin olup olmadığını, e-posta yapılandırmalarını, geçerli kullanıcı e-postalarını gibi **ilgili bilgileri** öğrenmek mümkündür.

**Dış enum** gerçekleştirmek için aşağıdaki sayfayı kontrol edin:

{{#ref}}
az-unauthenticated-enum-and-initial-entry/
{{#endref}}

Bu bilgilerle, bir ayak izi elde etmeye çalışmanın en yaygın yolları şunlardır:
- **OSINT**: **leak**'leri Github veya başka bir açık kaynak platformda kontrol edin; bu platformlar **kimlik bilgileri** veya ilginç bilgiler içerebilir.
- **Şifre** tekrar kullanımı, sızıntılar veya [şifre püskürtme](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)
- Bir çalışandan kimlik bilgileri satın almak
- [**Yaygın Phishing**](https://book.hacktricks.wiki/en/generic-methodologies-and-resources/phishing-methodology/index.html) (kimlik bilgileri veya Oauth Uygulaması)
- [Cihaz Kodu Kimlik Doğrulama Phishing](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
- 3. tarafların **ihlal edilmesi**
- Azure'da barındırılan uygulamalardaki güvenlik açıkları
- [**Sunucu Tarafı İstek Sahteciliği**](https://book.hacktricks.wiki/en/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf.html) ile meta veri uç noktasına erişim
- [https://godiego.co/posts/STO-Azure/](https://godiego.co/posts/STO-Azure/) gibi **alt alan ele geçirmeleri**
- **Diğer azure hizmetleri yanlış yapılandırmaları**
- Bazı geliştirici dizüstü bilgisayarları ele geçirilmişse ([WinPEAS ve LinPEAS](https://github.com/peass-ng/PEASS-ng) bu bilgiyi bulabilir):
- **`<HOME>/.Azure`** içinde
- **`azureProfile.json`** geçmişte oturum açmış kullanıcılar hakkında bilgi içerir
- **`clouds.config`** abonelikler hakkında bilgi içerir
- **`service_principal_entries.json`** uygulama kimlik bilgilerini (kiracı id'si, istemciler ve gizli anahtar) içerir. Sadece Linux & macOS'ta
- **`msal_token_cache.json`** erişim jetonları ve yenileme jetonlarını içerir. Sadece Linux & macOS'ta
- **`service_principal_entries.bin`** ve msal_token_cache.bin Windows'ta kullanılır ve DPAPI ile şifrelenmiştir
- **`msal_http_cache.bin`** HTTP isteği önbelleğidir
- Yükleyin: `with open("msal_http_cache.bin", 'rb') as f: pickle.load(f)`
- **`AzureRmContext.json`** Az PowerShell kullanarak önceki oturum açma bilgilerini içerir (ancak kimlik bilgileri yoktur)
- **`C:\Users\<username>\AppData\Local\Microsoft\IdentityCache\*`** içinde, kullanıcıların DPAPI ile şifrelenmiş **erişim jetonları**, ID jetonları ve hesap bilgileri içeren birkaç `.bin` dosyası bulunmaktadır.
- **`C:\Users\<username>\AppData\Local\Microsoft\TokenBroken\Cache\`** içindeki `.tbres` dosyalarında daha fazla **erişim jetonu** bulmak mümkündür; bu dosyalar DPAPI ile şifrelenmiş erişim jetonları içeren bir base64 içerir.
- Linux ve macOS'ta, Az PowerShell'den (kullanıldıysa) `pwsh -Command "Save-AzContext -Path /tmp/az-context.json"` komutunu çalıştırarak **erişim jetonları, yenileme jetonları ve id jetonları** alabilirsiniz.
- Windows'ta bu sadece id jetonları üretir.
- Linux ve macOS'ta Az PowerShell'in kullanılıp kullanılmadığını kontrol etmek için `$HOME/.local/share/.IdentityService/` dizininin var olup olmadığını kontrol edebilirsiniz (içindeki dosyalar boş ve işe yaramaz olsa da).

Aşağıdaki sayfada bir ayak izi elde etmeye yol açabilecek **diğer Azure Hizmetleri yanlış yapılandırmalarını** bulun:

{{#ref}}
az-unauthenticated-enum-and-initial-entry/
{{#endref}}

> [!NOTE]
> Genellikle **en gürültülü** bölümün **giriş** olduğunu, kendisinin değil, enum olduğunu unutmayın.

### Azure & Entra ID Araçları

Aşağıdaki araçlar, hem Entra ID kiracılarını hem de Azure ortamlarını yavaşça (tespit edilmemek için) veya otomatik olarak (zaman kazanmak için) listelemek için çok yararlı olacaktır:

{{#ref}}
az-enumeration-tools.md
{{#endref}}

### Erişim Politikalarını Aşma

<figure><img src="../../images/image (268).png" alt=""><figcaption></figcaption></figure>

Geçerli kimlik bilgileriniz olsa bile giriş yapamadığınız durumlarda, mevcut olabilecek bazı yaygın korumalar şunlardır:

- **IP beyaz listeleme** -- Geçerli bir IP'yi ele geçirmeniz gerekir
- **Coğrafi kısıtlamalar** -- Kullanıcının nerede yaşadığını veya şirketin ofislerinin nerede olduğunu bulup aynı şehirden (veya en azından aynı ülkeden) bir IP alın
- **Tarayıcı** -- Belki de yalnızca belirli bir işletim sisteminden (Windows, Linux, Mac, Android, iOS) bir tarayıcıya izin verilmektedir. Kurbanın/şirketin hangi işletim sistemini kullandığını öğrenin.
- Ayrıca, genellikle daha az sınırlı olan ve girişleri daha az incelenen **Hizmet Prensibi kimlik bilgilerini** ele geçirmeyi de deneyebilirsiniz.

Bunu aştıktan sonra, başlangıç ayarlarınıza geri dönebilir ve hala erişiminiz olabilir.

Kontrol edin:

{{#ref}}
az-privilege-escalation/az-entraid-privesc/az-conditional-access-policies-mfa-bypass.md
{{#endref}}

### Whoami

> [!CAUTION]
> [**Az - Entra ID**](az-services/az-azuread.md) bölümünde az cli, AzureAD ve Az PowerShell'in **nasıl kurulacağını** öğrenin.

Bilmeniz gereken ilk şey **kim olduğunuzdur** (hangi ortamda olduğunuz):

{{#tabs }}
{{#tab name="az cli" }}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{{#endtab }}

{{#tab name="Az" }}
```bash
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
```
{{#endtab }}

{{#tab name="Mg" }}
```bash
#Get the current session
Get-MgContext
```
{{#endtab }}

{{#tab name="AzureAD" }}
```bash
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{{#endtab }}
{{#endtabs }}


### Entra ID Enumeration & Privesc

Varsayılan olarak, herhangi bir kullanıcının **kullanıcılar, gruplar, roller, hizmet ilkeleri gibi şeyleri listelemek için yeterli izinlere sahip olması gerekir**... (bakınız [varsayılan AzureAD izinleri](az-basic-information/index.html#default-user-permissions)).\
Burada bir kılavuz bulabilirsiniz:

{{#ref}}
az-services/az-azuread.md
{{#endref}}

**Post-Exploitation araçlarını** kontrol edin, Entra ID'de ayrıcalıkları artırmak için **AzureHound** gibi araçlar bulabilirsiniz:

{{#ref}}
az-enumeration-tools.md#automated-post-exploitation-tools
{{#endref}}


### Azure Enumeration

Kendinizi tanıdıktan sonra, **erişim sağladığınız Azure hizmetlerini listelemeye** başlayabilirsiniz.

**Kaynaklar üzerindeki izinlerinizi** öğrenmeye başlamalısınız. Bunun için:

1. **Erişim sağladığınız kaynağı bulun**:

Az PowerShell komutu **`Get-AzResource`**, **mevcut kullanıcınızın görünürlüğe sahip olduğu kaynakları bilmenizi sağlar**.

Ayrıca, aynı bilgiyi **web konsolunda** [https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll) adresine giderek veya "Tüm kaynaklar" araması yaparak ya da şu komutu çalıştırarak alabilirsiniz:
```bash
az rest --method GET --url "https://management.azure.com/subscriptions/<subscription-id>/resources?api-version=2021-04-01"
```
2. **Erişim sağladığınız kaynaklar üzerindeki izinlerinizi bulun ve size atanan rolleri belirleyin**:

Bu işlemi gerçekleştirmek için **`Microsoft.Authorization/roleAssignments/read`** iznine ihtiyacınız olduğunu unutmayın.

Ayrıca, yeterli izinlerle, **`Get-AzRoleAssignment`** rolü, abonelikteki **tüm rolleri** listelemek veya belirli bir kaynak üzerindeki izni belirtmek için kullanılabilir:
```bash
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/Resource_Group_1/providers/Microsoft.RecoveryServices/vaults/vault-m3ww8ut4
```
Bu bilgiyi çalıştırarak almak da mümkündür:
```bash
az rest --method GET --uri "https://management.azure.com/<Scope>/providers/Microsoft.Authorization/roleAssignments?api-version=2020-08-01-preview" | jq ".value"
```
gibi:
```bash
az rest --method GET --uri "https://management.azure.com//subscriptions/<subscription-id>/resourceGroups/Resource_Group_1/providers/Microsoft.KeyVault/vaults/vault-m3ww8ut4/providers/Microsoft.Authorization/roleAssignments?api-version=2020-08-01-preview" | jq ".value"
```
Başka bir seçenek, azure'da size bağlı olan rolleri almak için:
```bash
az role assignment list --assignee "<email>" --all --output table
```
Aşağıdakileri çalıştırarak (Eğer sonuçlar boşsa, bunun nedeni onları almak için izninizin olmaması olabilir):
```bash
az rest --method GET --uri 'https://management.azure.com/subscriptions/<subscription-id>/providers/Microsoft.Authorization/roleAssignments?api-version=2022-04-01&$filter=principalId eq '<user-id>'
```
3. **Sizeye bağlı rollerin ayrıntılı izinlerini bulun**:

Ayrıntılı izinleri almak için **`(Get-AzRoleDefinition -Id "<RoleDefinitionId>").Actions`** komutunu çalıştırabilirsiniz.

Ya da API'yi doğrudan çağırabilirsiniz.
```bash
az rest --method GET --uri "https://management.azure.com//subscriptions/<subscription-id>/providers/Microsoft.Authorization/roleDefinitions/<RoleDefinitionId>?api-version=2020-08-01-preview" | jq ".properties"
```
Aşağıdaki bölümde **en yaygın Azure hizmetleri hakkında bilgi ve bunları nasıl listeleyeceğinizi** bulabilirsiniz:

{{#ref}}
az-services/
{{#endref}}

### Ayrıcalık Yükseltme, Sonrası Sömürü & Süreklilik

Azure ortamının nasıl yapılandığını ve hangi hizmetlerin kullanıldığını öğrendikten sonra, **ayrıcalıkları yükseltme, yan hareket etme, diğer sonrası sömürü saldırılarını gerçekleştirme ve sürekliliği sağlama** yollarını aramaya başlayabilirsiniz.

Aşağıdaki bölümde en yaygın Azure hizmetlerinde ayrıcalıkları nasıl yükselteceğinize dair bilgi bulabilirsiniz:

{{#ref}}
az-privilege-escalation/
{{#endref}}

Aşağıdaki bölümde en yaygın Azure hizmetlerinde sonrası sömürü saldırılarını nasıl gerçekleştireceğinize dair bilgi bulabilirsiniz:

{{#ref}}
az-post-exploitation/
{{#endref}}

Aşağıdaki bölümde en yaygın Azure hizmetlerinde sürekliliği nasıl sağlayacağınıza dair bilgi bulabilirsiniz:

{{#ref}}
az-persistence/
{{#endref}}

{{#include ../../banners/hacktricks-training.md}}
