# Azure Pentesting

{{#include ../../banners/hacktricks-training.md}}

## Podstawowe informacje

{{#ref}}
az-basic-information/
{{#endref}}

## Metodologia Pentestera/Red Team w Azure

Aby audytować środowisko AZURE, bardzo ważne jest, aby wiedzieć: które **usługi są używane**, co jest **eksponowane**, kto ma **dostęp** do czego i jak są połączone wewnętrzne usługi Azure oraz **usługi zewnętrzne**.

Z punktu widzenia Red Team, **pierwszym krokiem do skompromitowania środowiska Azure** jest uzyskanie jakichś **poświadczeń** dla Azure AD. Oto kilka pomysłów, jak to zrobić:

- **Wycieki** w githubie (lub podobnych) - OSINT
- **Inżynieria** społeczna
- Ponowne użycie **hasła** (wycieki haseł)
- Luki w aplikacjach hostowanych w Azure
- [**Server Side Request Forgery**](https://book.hacktricks.wiki/en/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf.html) z dostępem do punktu końcowego metadanych
- **Odczyt lokalnych plików**
- `/home/USERNAME/.azure`
- `C:\Users\USERNAME\.azure`
- Plik **`accessTokens.json`** w `az cli` przed 2.30 - Jan2022 - przechowywał **tokeny dostępu w czystym tekście**
- Plik **`azureProfile.json`** zawiera **informacje** o zalogowanym użytkowniku.
- **`az logout`** usuwa token.
- Starsze wersje **`Az PowerShell`** przechowywały **tokeny dostępu** w **czystym** tekście w **`TokenCache.dat`**. Przechowuje również **ServicePrincipalSecret** w **czystym** tekście w **`AzureRmContext.json`**. Cmdlet **`Save-AzContext`** może być użyty do **przechowywania** **tokenów**.\
Użyj `Disconnect-AzAccount`, aby je usunąć.
- Naruszenia danych przez **osoby trzecie**
- **Wewnętrzny** pracownik
- [**Typowe Phishing**](https://book.hacktricks.wiki/en/generic-methodologies-and-resources/phishing-methodology/index.html) (poświadczenia lub aplikacja Oauth)
- [Phishing z użyciem kodu urządzenia](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
- [**Password Spraying** w Azure](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

Nawet jeśli **nie skompromitowałeś żadnego użytkownika** w atakowanym tenantcie Azure, możesz **zgromadzić pewne informacje** z niego:

{{#ref}}
az-unauthenticated-enum-and-initial-entry/
{{#endref}}

> [!NOTE]
> Po uzyskaniu poświadczeń musisz wiedzieć **do kogo należą te poświadczenia** i **do czego mają dostęp**, więc musisz przeprowadzić podstawową enumerację:

## Podstawowa enumeracja

> [!NOTE]
> Pamiętaj, że **najgłośniejszą** częścią enumeracji jest **logowanie**, a nie sama enumeracja.

### SSRF

Jeśli znalazłeś SSRF na maszynie w Azure, sprawdź tę stronę w poszukiwaniu wskazówek:

{{#ref}}
https://book.hacktricks.wiki/en/generic-methodologies-and-resources/phishing-methodology/index.html
{{#endref}}

### Ominięcie warunków logowania

<figure><img src="../../images/image (268).png" alt=""><figcaption></figcaption></figure>

W przypadkach, gdy masz ważne poświadczenia, ale nie możesz się zalogować, oto kilka typowych zabezpieczeń, które mogą być wprowadzone:

- **Biała lista IP** -- Musisz skompromitować ważny adres IP
- **Ograniczenia geograficzne** -- Dowiedz się, gdzie mieszka użytkownik lub gdzie znajdują się biura firmy i uzyskaj adres IP z tego samego miasta (lub przynajmniej kraju)
- **Przeglądarka** -- Może być dozwolona tylko przeglądarka z określonego systemu operacyjnego (Windows, Linux, Mac, Android, iOS). Dowiedz się, z jakiego systemu operacyjnego korzysta ofiara/firmy.
- Możesz również spróbować **skomplikować poświadczenia Service Principal**, ponieważ zazwyczaj są mniej ograniczone, a ich logowanie jest mniej kontrolowane.

Po ominięciu tego, możesz być w stanie wrócić do swojego początkowego ustawienia i nadal mieć dostęp.

### Przejęcie subdomeny

- [https://godiego.co/posts/STO-Azure/](https://godiego.co/posts/STO-Azure/)

### Whoami

> [!CAUTION]
> Dowiedz się **jak zainstalować** az cli, AzureAD i Az PowerShell w sekcji [**Az - Entra ID**](az-services/az-azuread.md).

Jedną z pierwszych rzeczy, które musisz wiedzieć, jest **kim jesteś** (w jakim środowisku się znajdujesz):

{{#tabs }}
{{#tab name="az cli" }}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{{#endtab }}

{{#tab name="AzureAD" }}
```bash
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{{#endtab }}

{{#tab name="Az PowerShell" }}
```bash
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
{{#endtab }}
{{#endtabs }}

> [!CAUTION]
> Jednym z najważniejszych poleceń do enumeracji Azure jest **`Get-AzResource`** z Az PowerShell, ponieważ pozwala **poznać zasoby, które są widoczne dla twojego aktualnego użytkownika**.
>
> Możesz uzyskać te same informacje w **konsoli internetowej**, przechodząc do [https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll) lub wyszukując "Wszystkie zasoby".

### Entra ID Enumeration

Domyślnie każdy użytkownik powinien mieć **wystarczające uprawnienia do enumeracji** rzeczy takich jak użytkownicy, grupy, role, usługi principal... (sprawdź [domyślne uprawnienia AzureAD](az-basic-information/index.html#default-user-permissions)).\
Możesz znaleźć tutaj przewodnik:

{{#ref}}
az-services/az-azuread.md
{{#endref}}

> [!NOTE]
> Teraz, gdy **masz pewne informacje o swoich poświadczeniach** (a jeśli jesteś w red team, miejmy nadzieję, że **nie zostałeś wykryty**). Czas dowiedzieć się, które usługi są używane w środowisku.\
> W następnej sekcji możesz sprawdzić kilka sposobów na **enumerację niektórych powszechnych usług.**

## App Service SCM

Konsola Kudu do logowania się do 'kontenera' App Service.

## Webshell

Użyj portal.azure.com i wybierz powłokę, lub użyj shell.azure.com, aby uzyskać dostęp do bash lub powershell. 'Dysk' tej powłoki jest przechowywany jako plik obrazu w koncie magazynu.

## Azure DevOps

Azure DevOps jest oddzielony od Azure. Ma repozytoria, potoki (yaml lub release), tablice, wiki i inne. Grupy zmiennych są używane do przechowywania wartości zmiennych i sekretów.

{{#include ../../banners/hacktricks-training.md}}
