# Az - VMs & Network Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## VMs & Network

Для отримання додаткової інформації про Azure VMs та мережі перегляньте наступну сторінку:

{{#ref}}
../az-services/vms/
{{#endref}}

### VM Application Pivoting

VM додатки можуть бути спільно використані з іншими підписками та орендарями. Якщо додаток ділиться, ймовірно, це тому, що його використовують. Тому, якщо зловмисник вдається **зламати додаток і завантажити версію з бекдором**, можливо, що вона буде **виконана в іншому орендарі або підписці**.

### Sensitive information in images

Можливо, що можна знайти **чутливу інформацію всередині зображень**, зроблених з VMs у минулому.

1. **Список зображень** з галерей
```bash
# Get galleries
az sig list -o table

# List images inside gallery
az sig image-definition list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
-o table

# Get images versions
az sig image-version list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
--gallery-image-definition <IMAGE_DEFINITION> \
-o table
```
2. **Список користувацьких зображень**
```bash
az image list -o table
```
3. **Створити VM з ID зображення** та шукати чутливу інформацію всередині нього
```bash
# Create VM from image
az vm create \
--resource-group <RESOURCE_GROUP> \
--name <VM_NAME> \
--image /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/galleries/<GALLERY_NAME>/images/<IMAGE_DEFINITION>/versions/<IMAGE_VERSION> \
--admin-username <ADMIN_USERNAME> \
--generate-ssh-keys
```
### Чутлива інформація в точках відновлення

Можливо, що можна знайти **чутливу інформацію всередині точок відновлення**.

1. **Перелічити точки відновлення**
```bash
az restore-point list \
--resource-group <RESOURCE_GROUP> \
--restore-point-collection-name <COLLECTION_NAME> \
-o table
```
2. **Створити диск** з точки відновлення
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <NEW_DISK_NAME> \
--source /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/restorePointCollections/<COLLECTION_NAME>/restorePoints/<RESTORE_POINT_NAME>
```
3. **Прикріпіть диск до ВМ** (зловмисник вже повинен зламати ВМ всередині облікового запису)
```bash
az vm disk attach \
--resource-group <RESOURCE_GROUP> \
--vm-name <VM_NAME> \
--name <DISK_NAME>
```
4. **Підключіть** диск і **шукайте чутливу інформацію**

{{#tabs }}
{{#tab name="Linux" }}
```bash
# List all available disks
sudo fdisk -l

# Check disk format
sudo file -s /dev/sdX

# Mount it
sudo mkdir /mnt/mydisk
sudo mount /dev/sdX1 /mnt/mydisk
```
{{#endtab }}

{{#tab name="Windows" }}

#### **1. Відкрийте Керування дисками**

1. Клацніть правою кнопкою миші на **Пуск** і виберіть **Керування дисками**.
2. Приєднаний диск повинен з'явитися як **Офлайн** або **Невиділений**.

#### **2. Переведіть диск в онлайн**

1. Знайдіть диск у нижній панелі.
2. Клацніть правою кнопкою миші на диск (наприклад, **Диск 1**) і виберіть **Онлайн**.

#### **3. Ініціалізуйте диск**

1. Якщо диск не ініціалізований, клацніть правою кнопкою миші і виберіть **Ініціалізувати диск**.
2. Виберіть стиль розділу:
- **MBR** (Основний завантажувальний запис) або **GPT** (GUID таблиця розділів). Рекомендується використовувати GPT для сучасних систем.

#### **4. Створіть новий том**

1. Клацніть правою кнопкою миші на невиділеному просторі на диску і виберіть **Новий простий том**.
2. Слідуйте інструкціям майстра, щоб:
- Призначити літеру диска (наприклад, `D:`).
- Форматувати диск (виберіть NTFS у більшості випадків).
{{#endtab }}
{{#endtabs }}

### Чутлива інформація на дисках та знімках

Можливо, ви зможете знайти **чутливу інформацію всередині дисків або навіть старих знімків дисків**.

1. **Список знімків**
```bash
az snapshot list \
--resource-group <RESOURCE_GROUP> \
-o table
```
2. **Створити диск з моментального знімка** (якщо потрібно)
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <DISK_NAME> \
--source <SNAPSHOT_ID> \
--size-gb <DISK_SIZE>
```
3. **Прикріпіть і змонтуйте диск** до ВМ і шукайте чутливу інформацію (перегляньте попередній розділ, щоб дізнатися, як це зробити)

### Чутлива інформація в розширеннях ВМ та додатках ВМ

Можливо, ви зможете знайти **чутливу інформацію всередині розширень ВМ та додатків ВМ**.

1. **Перерахуйте всі додатки ВМ**
```bash
## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table
```
2. Встановіть розширення у віртуальній машині та **шукайте чутливу інформацію**
```bash
az vm application set \
--resource-group <rsc-group> \
--name <vm-name> \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellApp/versions/1.0.2 \
--treat-deployment-as-failure true
```
{{#include ../../../banners/hacktricks-training.md}}
