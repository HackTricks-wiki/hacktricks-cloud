# Az - VMs & Network Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## VMs & Network

Aby uzyskać więcej informacji na temat Azure VMs i sieci, sprawdź następującą stronę:

{{#ref}}
../az-services/vms/
{{#endref}}

### VM Application Pivoting

Aplikacje VM mogą być udostępniane innym subskrypcjom i najemcom. Jeśli aplikacja jest udostępniana, prawdopodobnie dlatego, że jest używana. Więc jeśli atakujący uda się **skompromitować aplikację i przesłać wersję z backdoorem**, może być możliwe, że zostanie ona **wykonana w innym najemcy lub subskrypcji**.

### Sensitive information in images

Możliwe, że można znaleźć **wrażliwe informacje w obrazach** pobranych z VM w przeszłości.

1. **List images** from galleries
```bash
# Get galleries
az sig list -o table

# List images inside gallery
az sig image-definition list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
-o table

# Get images versions
az sig image-version list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
--gallery-image-definition <IMAGE_DEFINITION> \
-o table
```
2. **Lista niestandardowych obrazów**
```bash
az image list -o table
```
3. **Utwórz VM z identyfikatorem obrazu** i przeszukaj go w poszukiwaniu wrażliwych informacji.
```bash
# Create VM from image
az vm create \
--resource-group <RESOURCE_GROUP> \
--name <VM_NAME> \
--image /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/galleries/<GALLERY_NAME>/images/<IMAGE_DEFINITION>/versions/<IMAGE_VERSION> \
--admin-username <ADMIN_USERNAME> \
--generate-ssh-keys
```
### Wrażliwe informacje w punktach przywracania

Możliwe, że można znaleźć **wrażliwe informacje w punktach przywracania**.

1. **Lista punktów przywracania**
```bash
az restore-point list \
--resource-group <RESOURCE_GROUP> \
--restore-point-collection-name <COLLECTION_NAME> \
-o table
```
2. **Utwórz dysk** z punktu przywracania
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <NEW_DISK_NAME> \
--source /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/restorePointCollections/<COLLECTION_NAME>/restorePoints/<RESTORE_POINT_NAME>
```
3. **Podłącz dysk do VM** (atakujący musi już mieć skompromitowane VM w obrębie konta)
```bash
az vm disk attach \
--resource-group <RESOURCE_GROUP> \
--vm-name <VM_NAME> \
--name <DISK_NAME>
```
4. **Zamontuj** dysk i **przeszukaj w poszukiwaniu wrażliwych informacji**

{{#tabs }}
{{#tab name="Linux" }}
```bash
# List all available disks
sudo fdisk -l

# Check disk format
sudo file -s /dev/sdX

# Mount it
sudo mkdir /mnt/mydisk
sudo mount /dev/sdX1 /mnt/mydisk
```
{{#endtab }}

{{#tab name="Windows" }}

#### **1. Otwórz Zarządzanie dyskami**

1. Kliknij prawym przyciskiem myszy **Start** i wybierz **Zarządzanie dyskami**.
2. Podłączony dysk powinien pojawić się jako **Offline** lub **Nieprzydzielony**.

#### **2. Włącz dysk**

1. Zlokalizuj dysk w dolnym panelu.
2. Kliknij prawym przyciskiem myszy na dysk (np. **Dysk 1**) i wybierz **Online**.

#### **3. Zainicjuj dysk**

1. Jeśli dysk nie jest zainicjowany, kliknij prawym przyciskiem myszy i wybierz **Zainicjuj dysk**.
2. Wybierz styl partycji:
- **MBR** (Master Boot Record) lub **GPT** (GUID Partition Table). GPT jest zalecane dla nowoczesnych systemów.

#### **4. Utwórz nową woluminę**

1. Kliknij prawym przyciskiem myszy na nieprzydzielonym miejscu na dysku i wybierz **Nowy prosty wolumin**.
2. Postępuj zgodnie z kreatorem, aby:
- Przypisać literę dysku (np. `D:`).
- Sformatować dysk (wybierz NTFS w większości przypadków).
{{#endtab }}
{{#endtabs }}

### Wrażliwe informacje na dyskach i migawkach

Możliwe jest znalezienie **wrażliwych informacji wewnątrz dysków lub nawet starych migawek dysków**.

1. **Lista migawek**
```bash
az snapshot list \
--resource-group <RESOURCE_GROUP> \
-o table
```
2. **Utwórz dysk z migawki** (jeśli potrzebne)
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <DISK_NAME> \
--source <SNAPSHOT_ID> \
--size-gb <DISK_SIZE>
```
3. **Dołącz i zamontuj dysk** do VM i przeszukaj w poszukiwaniu wrażliwych informacji (sprawdź poprzednią sekcję, aby zobaczyć, jak to zrobić)

### Wrażliwe informacje w rozszerzeniach VM i aplikacjach VM

Możliwe, że można znaleźć **wrażliwe informacje wewnątrz rozszerzeń VM i aplikacji VM**.

1. **Wypisz wszystkie aplikacje VM**
```bash
## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table
```
2. Zainstaluj rozszerzenie w VM i **wyszukaj wrażliwe informacje**
```bash
az vm application set \
--resource-group <rsc-group> \
--name <vm-name> \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellApp/versions/1.0.2 \
--treat-deployment-as-failure true
```
{{#include ../../../banners/hacktricks-training.md}}
