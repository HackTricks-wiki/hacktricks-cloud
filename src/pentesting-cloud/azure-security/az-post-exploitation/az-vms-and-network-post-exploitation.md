# Az - VMs & Network Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## VMs & Network

Azure VMs 및 네트워킹에 대한 자세한 정보는 다음 페이지를 확인하세요:

{{#ref}}
../az-services/vms/
{{#endref}}

### VM Application Pivoting

VM 애플리케이션은 다른 구독 및 테넌트와 공유될 수 있습니다. 애플리케이션이 공유되고 있다면, 아마도 사용되고 있기 때문일 것입니다. 따라서 공격자가 **애플리케이션을 침해하고 백도어가 포함된** 버전을 업로드하면 **다른 테넌트나 구독에서 실행될 가능성이** 있습니다.

### 이미지 내 민감한 정보

과거에 VM에서 촬영된 **이미지 내에서 민감한 정보를 찾는 것이** 가능할 수 있습니다.

1. **갤러리에서 이미지 나열**
```bash
# Get galleries
az sig list -o table

# List images inside gallery
az sig image-definition list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
-o table

# Get images versions
az sig image-version list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
--gallery-image-definition <IMAGE_DEFINITION> \
-o table
```
2. **사용자 정의 이미지 목록**
```bash
az image list -o table
```
3. **이미지 ID로 VM 생성** 및 그 안에서 민감한 정보 검색
```bash
# Create VM from image
az vm create \
--resource-group <RESOURCE_GROUP> \
--name <VM_NAME> \
--image /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/galleries/<GALLERY_NAME>/images/<IMAGE_DEFINITION>/versions/<IMAGE_VERSION> \
--admin-username <ADMIN_USERNAME> \
--generate-ssh-keys
```
### 복원 지점의 민감한 정보

**복원 지점 안에 민감한 정보가 있을 수 있습니다.**

1. **복원 지점 나열**
```bash
az restore-point list \
--resource-group <RESOURCE_GROUP> \
--restore-point-collection-name <COLLECTION_NAME> \
-o table
```
2. **복원 지점에서 디스크 생성**
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <NEW_DISK_NAME> \
--source /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/restorePointCollections/<COLLECTION_NAME>/restorePoints/<RESTORE_POINT_NAME>
```
3. **디스크를 VM에 연결하기** (공격자는 이미 계정 내에서 VM을 침해해야 함)
```bash
az vm disk attach \
--resource-group <RESOURCE_GROUP> \
--vm-name <VM_NAME> \
--name <DISK_NAME>
```
4. **디스크를 마운트하고** **민감한 정보 검색하기**

{{#tabs }}
{{#tab name="Linux" }}
```bash
# List all available disks
sudo fdisk -l

# Check disk format
sudo file -s /dev/sdX

# Mount it
sudo mkdir /mnt/mydisk
sudo mount /dev/sdX1 /mnt/mydisk
```
{{#endtab }}

{{#tab name="Windows" }}

#### **1. 디스크 관리 열기**

1. **시작**을 마우스 오른쪽 버튼으로 클릭하고 **디스크 관리**를 선택합니다.
2. 연결된 디스크가 **오프라인** 또는 **할당되지 않음**으로 표시되어야 합니다.

#### **2. 디스크 온라인으로 전환**

1. 하단 창에서 디스크를 찾습니다.
2. 디스크(예: **디스크 1**)를 마우스 오른쪽 버튼으로 클릭하고 **온라인**을 선택합니다.

#### **3. 디스크 초기화**

1. 디스크가 초기화되지 않은 경우, 마우스 오른쪽 버튼을 클릭하고 **디스크 초기화**를 선택합니다.
2. 파티션 스타일을 선택합니다:
- **MBR** (마스터 부트 레코드) 또는 **GPT** (GUID 파티션 테이블). 현대 시스템에는 GPT를 권장합니다.

#### **4. 새 볼륨 만들기**

1. 디스크의 할당되지 않은 공간을 마우스 오른쪽 버튼으로 클릭하고 **새 단순 볼륨**을 선택합니다.
2. 마법사를 따라:
- 드라이브 문자 할당 (예: `D:`).
- 디스크 포맷 (대부분의 경우 NTFS 선택).
{{#endtab }}
{{#endtabs }}

### 디스크 및 스냅샷의 민감한 정보

**디스크 또는 이전 디스크의 스냅샷 안에 민감한 정보를 찾는 것이 가능할 수 있습니다.**

1. **스냅샷 목록**
```bash
az snapshot list \
--resource-group <RESOURCE_GROUP> \
-o table
```
2. **스냅샷에서 디스크 생성** (필요한 경우)
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <DISK_NAME> \
--source <SNAPSHOT_ID> \
--size-gb <DISK_SIZE>
```
3. **디스크를 VM에 연결하고 마운트**하여 민감한 정보를 검색합니다(이 방법에 대한 내용은 이전 섹션을 참조하세요).

### VM 확장 및 VM 애플리케이션의 민감한 정보

**VM 확장 및 VM 애플리케이션 내부에서 민감한 정보를 찾는 것이 가능할 수 있습니다.**

1. **모든 VM 앱 나열**
```bash
## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table
```
2. VM에 확장을 설치하고 **민감한 정보 검색**
```bash
az vm application set \
--resource-group <rsc-group> \
--name <vm-name> \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellApp/versions/1.0.2 \
--treat-deployment-as-failure true
```
{{#include ../../../banners/hacktricks-training.md}}
