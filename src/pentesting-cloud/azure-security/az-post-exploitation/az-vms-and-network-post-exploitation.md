# Az - VMs & Network Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## VMs & Network

Για περισσότερες πληροφορίες σχετικά με τα Azure VMs και το δίκτυο, ελέγξτε την παρακάτω σελίδα:

{{#ref}}
../az-services/vms/
{{#endref}}

### VM Application Pivoting

Οι εφαρμογές VM μπορούν να μοιραστούν με άλλες συνδρομές και ενοικιαστές. Εάν μια εφαρμογή μοιράζεται, πιθανότατα συμβαίνει επειδή χρησιμοποιείται. Έτσι, εάν ο επιτιθέμενος καταφέρει να **συμβιβάσει την εφαρμογή και να ανεβάσει μια εκδοχή με backdoor**, μπορεί να είναι δυνατό να **εκτελεστεί σε άλλο ενοικιαστή ή συνδρομή**.

### Ευαίσθητες πληροφορίες σε εικόνες

Μπορεί να είναι δυνατό να βρείτε **ευαίσθητες πληροφορίες μέσα σε εικόνες** που έχουν ληφθεί από VMs στο παρελθόν.

1. **Λίστα εικόνων** από γκαλερί
```bash
# Get galleries
az sig list -o table

# List images inside gallery
az sig image-definition list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
-o table

# Get images versions
az sig image-version list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
--gallery-image-definition <IMAGE_DEFINITION> \
-o table
```
2. **Λίστα προσαρμοσμένων εικόνων**
```bash
az image list -o table
```
3. **Δημιουργία VM από το ID εικόνας** και αναζήτηση ευαίσθητων πληροφοριών μέσα σε αυτό
```bash
# Create VM from image
az vm create \
--resource-group <RESOURCE_GROUP> \
--name <VM_NAME> \
--image /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/galleries/<GALLERY_NAME>/images/<IMAGE_DEFINITION>/versions/<IMAGE_VERSION> \
--admin-username <ADMIN_USERNAME> \
--generate-ssh-keys
```
### Ευαίσθητες πληροφορίες σε σημεία επαναφοράς

Μπορεί να είναι δυνατό να βρείτε **ευαίσθητες πληροφορίες μέσα σε σημεία επαναφοράς**.

1. **Λίστα σημείων επαναφοράς**
```bash
az restore-point list \
--resource-group <RESOURCE_GROUP> \
--restore-point-collection-name <COLLECTION_NAME> \
-o table
```
2. **Δημιουργία δίσκου** από ένα σημείο αποκατάστασης
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <NEW_DISK_NAME> \
--source /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/restorePointCollections/<COLLECTION_NAME>/restorePoints/<RESTORE_POINT_NAME>
```
3. **Συνδέστε τον δίσκο σε μια VM** (ο επιτιθέμενος πρέπει να έχει ήδη παραβιάσει μια VM μέσα στον λογαριασμό)
```bash
az vm disk attach \
--resource-group <RESOURCE_GROUP> \
--vm-name <VM_NAME> \
--name <DISK_NAME>
```
4. **Συνδέστε** τον δίσκο και **αναζητήστε ευαίσθητες πληροφορίες**

{{#tabs }}
{{#tab name="Linux" }}
```bash
# List all available disks
sudo fdisk -l

# Check disk format
sudo file -s /dev/sdX

# Mount it
sudo mkdir /mnt/mydisk
sudo mount /dev/sdX1 /mnt/mydisk
```
{{#endtab }}

{{#tab name="Windows" }}

#### **1. Άνοιγμα Διαχείρισης Δίσκων**

1. Κάντε δεξί κλικ στο **Έναρξη** και επιλέξτε **Διαχείριση Δίσκων**.
2. Ο συνδεδεμένος δίσκος θα πρέπει να εμφανίζεται ως **Εκτός σύνδεσης** ή **Μη κατανεμημένος**.

#### **2. Φέρτε τον Δίσκο Online**

1. Εντοπίστε τον δίσκο στο κάτω πάνελ.
2. Κάντε δεξί κλικ στον δίσκο (π.χ., **Δίσκος 1**) και επιλέξτε **Online**.

#### **3. Αρχικοποίηση του Δίσκου**

1. Εάν ο δίσκος δεν είναι αρχικοποιημένος, κάντε δεξί κλικ και επιλέξτε **Αρχικοποίηση Δίσκου**.
2. Επιλέξτε το στυλ διαμερίσματος:
- **MBR** (Master Boot Record) ή **GPT** (GUID Partition Table). Συνιστάται το GPT για σύγχρονα συστήματα.

#### **4. Δημιουργία Νέου Τόμου**

1. Κάντε δεξί κλικ στον μη κατανεμημένο χώρο στον δίσκο και επιλέξτε **Νέος Απλ Τόμος**.
2. Ακολουθήστε τον οδηγό για να:
- Αναθέσετε ένα γράμμα δίσκου (π.χ., `D:`).
- Μορφοποιήσετε τον δίσκο (επιλέξτε NTFS για τις περισσότερες περιπτώσεις).
{{#endtab }}
{{#endtabs }}

### Ευαίσθητες πληροφορίες σε δίσκους & στιγμιότυπα

Ενδέχεται να είναι δυνατή η εύρεση **ευαίσθητων πληροφοριών μέσα σε δίσκους ή ακόμη και παλαιά στιγμιότυπα δίσκων**.

1. **Λίστα στιγμιότυπων**
```bash
az snapshot list \
--resource-group <RESOURCE_GROUP> \
-o table
```
2. **Δημιουργία δίσκου από στιγμιότυπο** (αν χρειάζεται)
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <DISK_NAME> \
--source <SNAPSHOT_ID> \
--size-gb <DISK_SIZE>
```
3. **Συνδέστε και τοποθετήστε τον δίσκο** σε μια VM και αναζητήστε ευαίσθητες πληροφορίες (ελέγξτε την προηγούμενη ενότητα για να δείτε πώς να το κάνετε αυτό)

### Ευαίσθητες πληροφορίες σε VM Extensions & VM Applications

Ενδέχεται να είναι δυνατή η εύρεση **ευαίσθητων πληροφοριών μέσα σε VM extensions και VM applications**.

1. **Καταγράψτε όλες τις εφαρμογές VM**
```bash
## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table
```
2. Εγκαταστήστε την επέκταση σε μια VM και **αναζητήστε ευαίσθητες πληροφορίες**
```bash
az vm application set \
--resource-group <rsc-group> \
--name <vm-name> \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellApp/versions/1.0.2 \
--treat-deployment-as-failure true
```
{{#include ../../../banners/hacktricks-training.md}}
