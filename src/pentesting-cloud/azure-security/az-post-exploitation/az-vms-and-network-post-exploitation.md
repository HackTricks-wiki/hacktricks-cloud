# Az - VMs & Network Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## VMs & Network

有关 Azure VMs 和网络的更多信息，请查看以下页面：

{{#ref}}
../az-services/vms/
{{#endref}}

### VM 应用程序转发

VM 应用程序可以与其他订阅和租户共享。如果一个应用程序正在被共享，可能是因为它正在被使用。因此，如果攻击者成功地 **破坏了应用程序并上传了一个后门** 版本，可能会 **在另一个租户或订阅中执行**。

### 图像中的敏感信息

可能会发现 **过去从 VMs 拍摄的图像中包含敏感信息**。

1. **列出图库中的图像**
```bash
# Get galleries
az sig list -o table

# List images inside gallery
az sig image-definition list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
-o table

# Get images versions
az sig image-version list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
--gallery-image-definition <IMAGE_DEFINITION> \
-o table
```
2. **列出自定义镜像**
```bash
az image list -o table
```
3. **从镜像 ID 创建 VM** 并在其中搜索敏感信息
```bash
# Create VM from image
az vm create \
--resource-group <RESOURCE_GROUP> \
--name <VM_NAME> \
--image /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/galleries/<GALLERY_NAME>/images/<IMAGE_DEFINITION>/versions/<IMAGE_VERSION> \
--admin-username <ADMIN_USERNAME> \
--generate-ssh-keys
```
### 恢复点中的敏感信息

可能会在**恢复点中找到敏感信息**。

1. **列出恢复点**
```bash
az restore-point list \
--resource-group <RESOURCE_GROUP> \
--restore-point-collection-name <COLLECTION_NAME> \
-o table
```
2. **从还原点创建磁盘**
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <NEW_DISK_NAME> \
--source /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/restorePointCollections/<COLLECTION_NAME>/restorePoints/<RESTORE_POINT_NAME>
```
3. **将磁盘附加到虚拟机**（攻击者需要已经入侵了帐户内的虚拟机）
```bash
az vm disk attach \
--resource-group <RESOURCE_GROUP> \
--vm-name <VM_NAME> \
--name <DISK_NAME>
```
4. **挂载**磁盘并**搜索敏感信息**

{{#tabs }}
{{#tab name="Linux" }}
```bash
# List all available disks
sudo fdisk -l

# Check disk format
sudo file -s /dev/sdX

# Mount it
sudo mkdir /mnt/mydisk
sudo mount /dev/sdX1 /mnt/mydisk
```
{{#endtab }}

{{#tab name="Windows" }}

#### **1. 打开磁盘管理**

1. 右键单击 **开始**，选择 **磁盘管理**。
2. 附加的磁盘应显示为 **离线** 或 **未分配**。

#### **2. 将磁盘上线**

1. 在底部窗格中找到磁盘。
2. 右键单击磁盘（例如，**磁盘 1**）并选择 **在线**。

#### **3. 初始化磁盘**

1. 如果磁盘未初始化，右键单击并选择 **初始化磁盘**。
2. 选择分区样式：
- **MBR**（主引导记录）或 **GPT**（GUID 分区表）。建议现代系统使用 GPT。

#### **4. 创建新卷**

1. 右键单击磁盘上的未分配空间，选择 **新建简单卷**。
2. 按照向导操作：
- 分配驱动器字母（例如，`D:`）。
- 格式化磁盘（大多数情况下选择 NTFS）。
{{#endtab }}
{{#endtabs }}

### 磁盘和快照中的敏感信息

可能会在 **磁盘或旧磁盘快照中找到敏感信息**。

1. **列出快照**
```bash
az snapshot list \
--resource-group <RESOURCE_GROUP> \
-o table
```
2. **从快照创建磁盘**（如有需要）
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <DISK_NAME> \
--source <SNAPSHOT_ID> \
--size-gb <DISK_SIZE>
```
3. **将磁盘附加并挂载**到虚拟机并搜索敏感信息（查看上一节以了解如何执行此操作）

### 虚拟机扩展和虚拟机应用中的敏感信息

可能会在**虚拟机扩展和虚拟机应用中找到敏感信息**。

1. **列出所有虚拟机应用**
```bash
## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table
```
2. 在虚拟机中安装扩展并**搜索敏感信息**
```bash
az vm application set \
--resource-group <rsc-group> \
--name <vm-name> \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellApp/versions/1.0.2 \
--treat-deployment-as-failure true
```
{{#include ../../../banners/hacktricks-training.md}}
