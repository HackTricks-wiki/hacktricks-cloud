# Az - CosmosDB Post Exploitation

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}

## CosmosDB Post Exploitation
SQL ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../az-services/az-cosmosDB.md" %}
[az-cosmosDB.md](../az-services/az-cosmosDB.md)
{% endcontent-ref %}


### "Microsoft.DocumentDB/databaseAccounts/read" && "Microsoft.DocumentDB/databaseAccounts/write"
ì´ ê¶Œí•œìœ¼ë¡œ Azure Cosmos DB ê³„ì •ì„ ìƒì„±í•˜ê±°ë‚˜ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì—ëŠ” ê³„ì • ìˆ˜ì¤€ ì„¤ì • ìˆ˜ì •, ì§€ì—­ ì¶”ê°€ ë˜ëŠ” ì œê±°, ì¼ê´€ì„± ìˆ˜ì¤€ ë³€ê²½, ë‹¤ì¤‘ ì§€ì—­ ì“°ê¸°ì™€ ê°™ì€ ê¸°ëŠ¥ í™œì„±í™” ë˜ëŠ” ë¹„í™œì„±í™”ê°€ í¬í•¨ë©ë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az cosmosdb update \
--name <account_name> \
--resource-group <resource_group_name> \
--public-network-access ENABLED
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/read" && "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/write"
ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ë©´ Azure Cosmos DB ê³„ì •ì˜ SQL ë°ì´í„°ë² ì´ìŠ¤ ë‚´ì—ì„œ ì»¨í…Œì´ë„ˆ(ì»¬ë ‰ì…˜)ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì»¨í…Œì´ë„ˆëŠ” ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë° ì‚¬ìš©ë˜ë©°, ì´ë“¤ì— ëŒ€í•œ ë³€ê²½ì€ ë°ì´í„°ë² ì´ìŠ¤ì˜ êµ¬ì¡°ì™€ ì ‘ê·¼ íŒ¨í„´ì— ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
# Create
az cosmosdb sql container create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <database_name> \
--name <container_name> \
--partition-key-path <partition_key_path>

#Update
az cosmosdb sql container update \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <database_name> \
--name <container_name> \
--ttl 3600
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/write" && "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/read"
ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ë©´ Azure Cosmos DB ê³„ì • ë‚´ì—ì„œ SQL ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°ë¥¼ ê´€ë¦¬í•˜ê³  ê³„ì •ì— ìƒˆë¡œìš´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê¶Œí•œì€ ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ì§€ë§Œ, ë¶€ì ì ˆí•˜ê±°ë‚˜ ë¬´ë‹¨ ì‚¬ìš©ì€ ë¶ˆí•„ìš”í•œ ë¦¬ì†ŒìŠ¤ ì†Œë¹„, ë¹„ìš© ì¦ê°€ ë˜ëŠ” ìš´ì˜ ë¹„íš¨ìœ¨ì„±ì„ ì´ˆë˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az cosmosdb sql database create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--name <database_name>
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/failoverPriorityChange/action"

ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ë©´ Azure Cosmos DB ë°ì´í„°ë² ì´ìŠ¤ ê³„ì •ì˜ ì§€ì—­ ì¥ì•  ì¡°ì¹˜ ìš°ì„  ìˆœìœ„ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì‘ì—…ì€ ì¥ì•  ì¡°ì¹˜ ì´ë²¤íŠ¸ ì¤‘ì— ì§€ì—­ì´ ê¸°ë³¸ì´ ë˜ëŠ” ìˆœì„œë¥¼ ê²°ì •í•©ë‹ˆë‹¤. ì´ ê¶Œí•œì„ ë¶€ì ì ˆí•˜ê²Œ ì‚¬ìš©í•˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ì˜ ê³ ê°€ìš©ì„±ì´ ì¤‘ë‹¨ë˜ê±°ë‚˜ ì˜ë„í•˜ì§€ ì•Šì€ ìš´ì˜ ì˜í–¥ì„ ì´ˆë˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az cosmosdb failover-priority-change \
--name <database_account_name> \
--resource-group <resource_group_name> \
--failover-policies <region1=priority1> <region2=priority2>

```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/regenerateKey/action"
ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ë©´ Azure Cosmos DB ê³„ì •ì˜ ê¸°ë³¸ ë˜ëŠ” ë³´ì¡° í‚¤ë¥¼ ì¬ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì¼ë°˜ì ìœ¼ë¡œ ì´ì „ í‚¤ë¥¼ êµì²´í•˜ì—¬ ë³´ì•ˆì„ ê°•í™”í•˜ëŠ” ë° ì‚¬ìš©ë˜ì§€ë§Œ, í˜„ì¬ í‚¤ì— ì˜ì¡´í•˜ëŠ” ì„œë¹„ìŠ¤ë‚˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì ‘ê·¼ì„ ë°©í•´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az cosmosdb keys regenerate \
--name <account_name> \
--resource-group <resource_group_name> \
--key-kind <primary|secondary>

```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/userDefinedFunctions/write" && "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/userDefinedFunctions/read"

ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ë©´ Azure Cosmos DB ê³„ì •ì˜ SQL ë°ì´í„°ë² ì´ìŠ¤ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ íŠ¸ë¦¬ê±°ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŠ¸ë¦¬ê±°ëŠ” ì‘ì—…ì— ëŒ€í•œ ì‘ë‹µìœ¼ë¡œ ì„œë²„ ì¸¡ ë…¼ë¦¬ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az cosmosdb sql trigger create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <sql_database_name> \
--container-name <container_name> \
--name <trigger_name> \
--body 'function trigger() { var context = getContext(); var request = context.getRequest(); request.setBody("Triggered operation!"); }' \
--type Pre \
--operation All
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/storedProcedures/write" && "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/storedProcedures/read"
ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ë©´ Azure Cosmos DB ê³„ì •ì˜ SQL ë°ì´í„°ë² ì´ìŠ¤ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ì €ì¥ í”„ë¡œì‹œì €ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Cosmos DBì˜ ì €ì¥ í”„ë¡œì‹œì €ëŠ” ë°ì´í„° ì²˜ë¦¬ ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ë‚´ì—ì„œ ì§ì ‘ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ë¡œì§ì„ ìº¡ìŠí™”í•  ìˆ˜ ìˆëŠ” ì„œë²„ ì¸¡ JavaScript í•¨ìˆ˜ì…ë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az cosmosdb sql stored-procedure create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <sql_database_name> \
--container-name <container_name> \
--name <stored_procedure_name> \
--body 'function sample() { return "Hello, Cosmos!"; }'
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/triggers/write" && "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/triggers/read"
ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ë©´ Azure Cosmos DB ê³„ì •ì˜ SQL ë°ì´í„°ë² ì´ìŠ¤ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ íŠ¸ë¦¬ê±°ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŠ¸ë¦¬ê±°ëŠ” ì‚½ì…, ì—…ë°ì´íŠ¸ ë˜ëŠ” ì‚­ì œì™€ ê°™ì€ ì‘ì—…ì— ëŒ€í•œ ì‘ë‹µìœ¼ë¡œ ì„œë²„ ì¸¡ ë¡œì§ì„ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az cosmosdb sql trigger create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <sql_database_name> \
--container-name <container_name> \
--name <trigger_name> \
--body 'function trigger() { var context = getContext(); var request = context.getRequest(); request.setBody("Triggered operation!"); }' \
--type Pre \
--operation All
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections/read" && "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections/write"
ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ë©´ Azure Cosmos DB ê³„ì • ë‚´ì˜ MongoDB ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì»¬ë ‰ì…˜ì„ ìƒì„±í•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì»¬ë ‰ì…˜ì€ ë¬¸ì„œë¥¼ ì €ì¥í•˜ê³  ë°ì´í„°ì˜ êµ¬ì¡°ì™€ íŒŒí‹°ì…”ë‹ì„ ì •ì˜í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az cosmosdb mongodb collection create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <mongodb_database_name> \
--name <collection_name>
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/write" && "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/read"
ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ë©´ Azure Cosmos DB ê³„ì • ë‚´ì—ì„œ ìƒˆë¡œìš´ MongoDB ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì»¬ë ‰ì…˜ê³¼ ë¬¸ì„œë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•  ìƒˆë¡œìš´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í”„ë¡œë¹„ì €ë‹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az cosmosdb mongodb database create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--name <database_name>
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/mongodbRoleDefinitions/write" && "Microsoft.DocumentDB/databaseAccounts/mongodbRoleDefinitions/read"
ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ë©´ Azure Cosmos DB ê³„ì • ë‚´ì—ì„œ ìƒˆë¡œìš´ MongoDB ì—­í•  ì •ì˜ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ MongoDB ì‚¬ìš©ìì— ëŒ€í•œ íŠ¹ì • ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ì ì •ì˜ ì—­í• ì„ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% code overflow="wrap" %}
```bash
az cosmosdb mongodb role definition create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--body '{
"Id": "<mydatabase>.readWriteRole",
"RoleName": "readWriteRole",
"Type": "CustomRole",
"DatabaseName": "<mydatabase>",
"Privileges": [
{
"Resource": {
"Db": "<mydatabase>",
"Collection": "mycollection"
},
"Actions": [
"insert",
"find",
"update"
]
}
],
"Roles": []
}'
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/mongodbUserDefinitions/write" && "Microsoft.DocumentDB/databaseAccounts/mongodbUserDefinitions/read"
ì´ ê¶Œí•œì„ ì‚¬ìš©í•˜ë©´ Azure Cosmos DB ê³„ì • ë‚´ì—ì„œ ìƒˆë¡œìš´ MongoDB ì‚¬ìš©ì ì •ì˜ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ MongoDB ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•œ íŠ¹ì • ì—­í• ê³¼ ì ‘ê·¼ ìˆ˜ì¤€ì„ ê°€ì§„ ì‚¬ìš©ìë¥¼ í”„ë¡œë¹„ì €ë‹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% code overflow="wrap" %}
```bash
az cosmosdb mongodb user definition create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--body '{
"Id": "<mydatabase>.myUser",
"UserName": "myUser",
"Password": "mySecurePassword",
"DatabaseName": "<mydatabase>",
"CustomData": "TestCustomData",
"Mechanisms": "SCRAM-SHA-256",
"Roles": [
{
"Role": "readWriteRole",
"Db": "<mydatabase>"
}
]
}'
```
{% endcode %}

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
