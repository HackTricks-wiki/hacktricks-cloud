# Az - CosmosDB Post Exploitation

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* V√©rifiez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## CosmosDB Post Exploitation
Pour plus d'informations sur SQL Database, consultez :

{% content-ref url="../az-services/az-cosmosDB.md" %}
[az-cosmosDB.md](../az-services/az-cosmosDB.md)
{% endcontent-ref %}


### "Microsoft.DocumentDB/databaseAccounts/read" && "Microsoft.DocumentDB/databaseAccounts/write"
Avec cette permission, vous pouvez cr√©er ou mettre √† jour des comptes Azure Cosmos DB. Cela inclut la modification des param√®tres au niveau du compte, l'ajout ou la suppression de r√©gions, le changement des niveaux de coh√©rence et l'activation ou la d√©sactivation de fonctionnalit√©s telles que les √©critures multi-r√©gions.

{% code overflow="wrap" %}
```bash
az cosmosdb update \
--name <account_name> \
--resource-group <resource_group_name> \
--public-network-access ENABLED
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/read" && "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/write"
Avec cette autorisation, vous pouvez cr√©er ou modifier des conteneurs (collections) au sein d'une base de donn√©es SQL d'un compte Azure Cosmos DB. Les conteneurs sont utilis√©s pour stocker des donn√©es, et les modifications apport√©es peuvent affecter la structure de la base de donn√©es et les mod√®les d'acc√®s.

{% code overflow="wrap" %}
```bash
# Create
az cosmosdb sql container create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <database_name> \
--name <container_name> \
--partition-key-path <partition_key_path>

#Update
az cosmosdb sql container update \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <database_name> \
--name <container_name> \
--ttl 3600
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/write" && "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/read"
Avec cette autorisation, vous pouvez cr√©er ou modifier des bases de donn√©es SQL au sein d'un compte Azure Cosmos DB. Cela permet de g√©rer la structure de la base de donn√©es et d'ajouter de nouvelles bases de donn√©es au compte. Bien que cette autorisation permette la cr√©ation de bases de donn√©es, une utilisation inappropri√©e ou non autoris√©e pourrait entra√Æner une consommation de ressources inutile, des co√ªts accrus ou des inefficacit√©s op√©rationnelles.

{% code overflow="wrap" %}
```bash
az cosmosdb sql database create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--name <database_name>
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/failoverPriorityChange/action"

Avec cette autorisation, vous pouvez changer la priorit√© de basculement des r√©gions pour un compte de base de donn√©es Azure Cosmos DB. Cette action d√©termine l'ordre dans lequel les r√©gions deviennent primaires lors d'un √©v√©nement de basculement. Une utilisation incorrecte de cette autorisation peut perturber la haute disponibilit√© de la base de donn√©es ou entra√Æner des impacts op√©rationnels non souhait√©s.

{% code overflow="wrap" %}
```bash
az cosmosdb failover-priority-change \
--name <database_account_name> \
--resource-group <resource_group_name> \
--failover-policies <region1=priority1> <region2=priority2>

```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/regenerateKey/action"
Avec cette autorisation, vous pouvez r√©g√©n√©rer les cl√©s primaire ou secondaire pour un compte Azure Cosmos DB. Cela est g√©n√©ralement utilis√© pour am√©liorer la s√©curit√© en rempla√ßant les anciennes cl√©s, mais cela peut perturber l'acc√®s pour les services ou applications qui d√©pendent des cl√©s actuelles.

{% code overflow="wrap" %}
```bash
az cosmosdb keys regenerate \
--name <account_name> \
--resource-group <resource_group_name> \
--key-kind <primary|secondary>

```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/userDefinedFunctions/write" && "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/userDefinedFunctions/read"

Avec cette autorisation, vous pouvez cr√©er ou modifier des d√©clencheurs au sein d'un conteneur d'une base de donn√©es SQL dans un compte Azure Cosmos DB. Les d√©clencheurs vous permettent d'ex√©cuter une logique c√¥t√© serveur en r√©ponse √† des op√©rations.

{% code overflow="wrap" %}
```bash
az cosmosdb sql trigger create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <sql_database_name> \
--container-name <container_name> \
--name <trigger_name> \
--body 'function trigger() { var context = getContext(); var request = context.getRequest(); request.setBody("Triggered operation!"); }' \
--type Pre \
--operation All
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/storedProcedures/write" && "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/storedProcedures/read"
Avec cette autorisation, vous pouvez cr√©er ou modifier des proc√©dures stock√©es dans un conteneur d'une base de donn√©es SQL dans un compte Azure Cosmos DB. Les proc√©dures stock√©es dans Cosmos DB sont des fonctions JavaScript c√¥t√© serveur qui vous permettent d'encapsuler la logique pour le traitement des donn√©es ou l'ex√©cution d'op√©rations directement dans la base de donn√©es.

{% code overflow="wrap" %}
```bash
az cosmosdb sql stored-procedure create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <sql_database_name> \
--container-name <container_name> \
--name <stored_procedure_name> \
--body 'function sample() { return "Hello, Cosmos!"; }'
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/triggers/write" && "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/triggers/read"
Avec cette autorisation, vous pouvez cr√©er ou modifier des d√©clencheurs au sein d'un conteneur d'une base de donn√©es SQL dans un compte Azure Cosmos DB. Les d√©clencheurs vous permettent d'ex√©cuter une logique c√¥t√© serveur en r√©ponse √† des op√©rations telles que des insertions, des mises √† jour ou des suppressions.

{% code overflow="wrap" %}
```bash
az cosmosdb sql trigger create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <sql_database_name> \
--container-name <container_name> \
--name <trigger_name> \
--body 'function trigger() { var context = getContext(); var request = context.getRequest(); request.setBody("Triggered operation!"); }' \
--type Pre \
--operation All
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections/read" && "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections/write"
Avec cette autorisation, vous pouvez cr√©er ou modifier des collections au sein des bases de donn√©es MongoDB dans un compte Azure Cosmos DB. Les collections sont utilis√©es pour stocker des documents et d√©finir la structure et le partitionnement des donn√©es.

{% code overflow="wrap" %}
```bash
az cosmosdb mongodb collection create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <mongodb_database_name> \
--name <collection_name>
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/write" && "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/read"
Avec cette autorisation, vous pouvez cr√©er de nouvelles bases de donn√©es MongoDB au sein d'un compte Azure Cosmos DB. Cela permet de provisionner de nouvelles bases de donn√©es pour stocker et g√©rer des collections et des documents.

{% code overflow="wrap" %}
```bash
az cosmosdb mongodb database create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--name <database_name>
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/mongodbRoleDefinitions/write" && "Microsoft.DocumentDB/databaseAccounts/mongodbRoleDefinitions/read"
Avec cette autorisation, vous pouvez cr√©er de nouvelles d√©finitions de r√¥le MongoDB au sein d'un compte Azure Cosmos DB. Cela permet de d√©finir des r√¥les personnalis√©s avec des autorisations sp√©cifiques pour les utilisateurs MongoDB.

{% code overflow="wrap" %}
```bash
az cosmosdb mongodb role definition create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--body '{
"Id": "<mydatabase>.readWriteRole",
"RoleName": "readWriteRole",
"Type": "CustomRole",
"DatabaseName": "<mydatabase>",
"Privileges": [
{
"Resource": {
"Db": "<mydatabase>",
"Collection": "mycollection"
},
"Actions": [
"insert",
"find",
"update"
]
}
],
"Roles": []
}'
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/mongodbUserDefinitions/write" && "Microsoft.DocumentDB/databaseAccounts/mongodbUserDefinitions/read"
Avec cette autorisation, vous pouvez cr√©er de nouvelles d√©finitions d'utilisateur MongoDB au sein d'un compte Azure Cosmos DB. Cela permet de provisionner des utilisateurs avec des r√¥les et des niveaux d'acc√®s sp√©cifiques aux bases de donn√©es MongoDB.
{% code overflow="wrap" %}
```bash
az cosmosdb mongodb user definition create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--body '{
"Id": "<mydatabase>.myUser",
"UserName": "myUser",
"Password": "mySecurePassword",
"DatabaseName": "<mydatabase>",
"CustomData": "TestCustomData",
"Mechanisms": "SCRAM-SHA-256",
"Roles": [
{
"Role": "readWriteRole",
"Db": "<mydatabase>"
}
]
}'
```
{% endcode %}

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
