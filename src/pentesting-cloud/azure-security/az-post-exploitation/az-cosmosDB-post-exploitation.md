# Az - CosmosDB Post Exploitation

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## CosmosDB Post Exploitation
Aby uzyska wicej informacji na temat SQL Database, sprawd藕:

{% content-ref url="../az-services/az-cosmosDB.md" %}
[az-cosmosDB.md](../az-services/az-cosmosDB.md)
{% endcontent-ref %}


### "Microsoft.DocumentDB/databaseAccounts/read" && "Microsoft.DocumentDB/databaseAccounts/write"
Dziki temu uprawnieniu mo偶esz tworzy lub aktualizowa konta Azure Cosmos DB. Obejmuje to modyfikacj ustawie na poziomie konta, dodawanie lub usuwanie region贸w, zmian poziom贸w sp贸jnoci oraz wczanie lub wyczanie funkcji, takich jak zapisy w wielu regionach.

{% code overflow="wrap" %}
```bash
az cosmosdb update \
--name <account_name> \
--resource-group <resource_group_name> \
--public-network-access ENABLED
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/read" && "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/write"
Dziki temu uprawnieniu mo偶esz tworzy lub modyfikowa kontenery (kolekcje) w bazie danych SQL konta Azure Cosmos DB. Kontenery su偶 do przechowywania danych, a zmiany w nich mog wpywa na struktur bazy danych i wzorce dostpu.

{% code overflow="wrap" %}
```bash
# Create
az cosmosdb sql container create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <database_name> \
--name <container_name> \
--partition-key-path <partition_key_path>

#Update
az cosmosdb sql container update \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <database_name> \
--name <container_name> \
--ttl 3600
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/write" && "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/read"
Dziki temu uprawnieniu mo偶esz tworzy lub modyfikowa bazy danych SQL w ramach konta Azure Cosmos DB. Umo偶liwia to zarzdzanie struktur bazy danych oraz dodawanie nowych baz danych do konta. Chocia偶 to uprawnienie umo偶liwia tworzenie baz danych, niewaciwe lub nieautoryzowane u偶ycie mo偶e prowadzi do niepotrzebnego zu偶ycia zasob贸w, zwikszonych koszt贸w lub nieefektywnoci operacyjnych.

{% code overflow="wrap" %}
```bash
az cosmosdb sql database create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--name <database_name>
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/failoverPriorityChange/action"

Dziki temu uprawnieniu mo偶esz zmieni priorytet awaryjny region贸w dla konta bazy danych Azure Cosmos DB. Ta akcja okrela kolejno, w jakiej regiony staj si g贸wne podczas zdarzenia awaryjnego. Niewaciwe u偶ycie tego uprawnienia mo偶e zak贸ci wysok dostpno bazy danych lub prowadzi do niezamierzonych skutk贸w operacyjnych.

{% code overflow="wrap" %}
```bash
az cosmosdb failover-priority-change \
--name <database_account_name> \
--resource-group <resource_group_name> \
--failover-policies <region1=priority1> <region2=priority2>

```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/regenerateKey/action"
Dziki temu uprawnieniu mo偶esz regenerowa klucze g贸wne lub pomocnicze dla konta Azure Cosmos DB. Zazwyczaj jest to u偶ywane w celu zwikszenia bezpieczestwa poprzez zastpienie starych kluczy, ale mo偶e to zak贸ci dostp do usug lub aplikacji, kt贸re polegaj na bie偶cych kluczach.

{% code overflow="wrap" %}
```bash
az cosmosdb keys regenerate \
--name <account_name> \
--resource-group <resource_group_name> \
--key-kind <primary|secondary>

```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/userDefinedFunctions/write" && "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/userDefinedFunctions/read"

Dziki temu uprawnieniu mo偶esz tworzy lub modyfikowa wyzwalacze w obrbie kontenera bazy danych SQL w koncie Azure Cosmos DB. Wyzwalacze pozwalaj na wykonywanie logiki po stronie serwera w odpowiedzi na operacje.

{% code overflow="wrap" %}
```bash
az cosmosdb sql trigger create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <sql_database_name> \
--container-name <container_name> \
--name <trigger_name> \
--body 'function trigger() { var context = getContext(); var request = context.getRequest(); request.setBody("Triggered operation!"); }' \
--type Pre \
--operation All
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/storedProcedures/write" && "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/storedProcedures/read"
Dziki temu uprawnieniu mo偶esz tworzy lub modyfikowa procedury skadowane w kontenerze bazy danych SQL w koncie Azure Cosmos DB. Procedury skadowane w Cosmos DB to funkcje JavaScript po stronie serwera, kt贸re pozwalaj na enkapsulacj logiki przetwarzania danych lub wykonywania operacji bezporednio w bazie danych.

{% code overflow="wrap" %}
```bash
az cosmosdb sql stored-procedure create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <sql_database_name> \
--container-name <container_name> \
--name <stored_procedure_name> \
--body 'function sample() { return "Hello, Cosmos!"; }'
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/triggers/write" && "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/triggers/read"
Dziki temu uprawnieniu mo偶esz tworzy lub modyfikowa wyzwalacze w obrbie kontenera bazy danych SQL w koncie Azure Cosmos DB. Wyzwalacze pozwalaj na wykonywanie logiki po stronie serwera w odpowiedzi na operacje takie jak wstawienia, aktualizacje lub usunicia.

{% code overflow="wrap" %}
```bash
az cosmosdb sql trigger create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <sql_database_name> \
--container-name <container_name> \
--name <trigger_name> \
--body 'function trigger() { var context = getContext(); var request = context.getRequest(); request.setBody("Triggered operation!"); }' \
--type Pre \
--operation All
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections/read" && "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections/write"
Dziki temu uprawnieniu mo偶esz tworzy lub modyfikowa kolekcje w bazach danych MongoDB w koncie Azure Cosmos DB. Kolekcje su偶 do przechowywania dokument贸w oraz definiowania struktury i partycjonowania danych.

{% code overflow="wrap" %}
```bash
az cosmosdb mongodb collection create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--database-name <mongodb_database_name> \
--name <collection_name>
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/write" && "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/read"
Dziki temu uprawnieniu mo偶esz tworzy nowe bazy danych MongoDB w ramach konta Azure Cosmos DB. Umo偶liwia to provisionowanie nowych baz danych do przechowywania i zarzdzania kolekcjami oraz dokumentami.

{% code overflow="wrap" %}
```bash
az cosmosdb mongodb database create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--name <database_name>
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/mongodbRoleDefinitions/write" && "Microsoft.DocumentDB/databaseAccounts/mongodbRoleDefinitions/read"
Dziki temu uprawnieniu mo偶esz tworzy nowe definicje r贸l MongoDB w ramach konta Azure Cosmos DB. Umo偶liwia to definiowanie niestandardowych r贸l z okrelonymi uprawnieniami dla u偶ytkownik贸w MongoDB.

{% code overflow="wrap" %}
```bash
az cosmosdb mongodb role definition create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--body '{
"Id": "<mydatabase>.readWriteRole",
"RoleName": "readWriteRole",
"Type": "CustomRole",
"DatabaseName": "<mydatabase>",
"Privileges": [
{
"Resource": {
"Db": "<mydatabase>",
"Collection": "mycollection"
},
"Actions": [
"insert",
"find",
"update"
]
}
],
"Roles": []
}'
```
{% endcode %}

### "Microsoft.DocumentDB/databaseAccounts/mongodbUserDefinitions/write" && "Microsoft.DocumentDB/databaseAccounts/mongodbUserDefinitions/read"
Dziki temu uprawnieniu mo偶esz tworzy nowe definicje u偶ytkownik贸w MongoDB w ramach konta Azure Cosmos DB. Umo偶liwia to przydzielanie u偶ytkownik贸w z okrelonymi rolami i poziomami dostpu do baz danych MongoDB.
{% code overflow="wrap" %}
```bash
az cosmosdb mongodb user definition create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--body '{
"Id": "<mydatabase>.myUser",
"UserName": "myUser",
"Password": "mySecurePassword",
"DatabaseName": "<mydatabase>",
"CustomData": "TestCustomData",
"Mechanisms": "SCRAM-SHA-256",
"Roles": [
{
"Role": "readWriteRole",
"Db": "<mydatabase>"
}
]
}'
```
{% endcode %}

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}
