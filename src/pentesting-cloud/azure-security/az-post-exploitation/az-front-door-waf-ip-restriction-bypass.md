# Az - Front Door WAF IP Restriction Bypass

{{#include ../../../banners/hacktricks-training.md}}

## Overview

When creating a **Custom Web Application Firewall (WAF) Policy** for **Azure Front Door (AFD)** it is very common to restrict access to specific IP ranges (e.g. corporate VPN, jump-boxes, etc.).

In the **IP Restriction** rule you must choose a **Match Variable** that will be compared with the allow/deny list:

* `RemoteAddr`  ➜ **default** option – *AFD will trust the value contained in the `X-Forwarded-For` HTTP header, **if present***.
* `SocketAddr`  ➜ only the **real TCP source IP** seen by AFD is used (header is ignored).

Because `RemoteAddr` **honours the client-supplied header**, an attacker can **spoof any IP address** and therefore **bypass the allowlist** by simply adding an `X-Forwarded-For: <allowed_ip>` header.

> This behaviour only affects **Front Door WAF**. In **Application Gateway WAF** the single `RemoteAddr` option behaves like `SocketAddr` (header ignored).

## Proof-of-Concept

1. WAF custom rule allowing only `203.0.113.0/24` and using **Match Variable** `RemoteAddr`.
2. Access without header:

```bash
$ curl -v https://example.azurefd.net/
< HTTP/1.1 403 Forbidden
```

3. Spoof the source IP via header:

```bash
$ curl -v -H "X-Forwarded-For: 203.0.113.5" https://example.azurefd.net/
< HTTP/1.1 200 OK
```

The request is processed as if it originated from `203.0.113.5` and the WAF rule is satisfied.

## Brute-Forcing Allowed IPs

If the authorised range is unknown you can enumerate it by fuzzing the header value, for example with **Burp Suite Intruder**:

1. Load a request to the protected endpoint.
2. Add `X-Forwarded-For: §PAYLOAD§` header and mark the payload position.
3. Wordlist: a `/16` CIDR (65 536 IPs) or your own list of candidate addresses.
4. Grep-match on `HTTP 200`, content length, or any identifier of a successful response.

A full `/16` (~65k requests) usually finishes in <40 minutes.

## Detection

* Compare **AFD diagnostic logs**: `clientIp` (socket) vs. `xForwardedFor` fields – a mismatch where the header contains an allowed IP but the socket IP does not belongs to the allowlist indicates exploitation.
* Enable **Azure Monitor alerts** on such discrepancies or on unexpected source IPs reaching restricted endpoints.

## Remediation / Hardening

1. In the IP restriction custom rule **change Match Variable to `SocketAddr`**.
2. Alternatively, create an **AFD routing rule** that strips `X-Forwarded-For` before evaluation.
3. Use **Application Gateway WAF** or another control that ignores the header when IP matching is required.
4. Do not rely solely on source IP filtering – implement additional authentication (HTTP auth, Azure AD, etc.).

## References

- [TrustedSec – Azure's Front Door WAF WTF: IP Restriction Bypass](https://trustedsec.com/blog/azures-front-door-waf-wtf-ip-restriction-bypass)

{{#include ../../../banners/hacktricks-training.md}}
