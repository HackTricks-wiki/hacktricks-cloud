# Az - Service Bus Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Service Bus

자세한 내용은 다음을 확인하세요:

{{#ref}}
../az-services/az-servicebus-enum.md
{{#endref}}

### Actions: `Microsoft.ServiceBus/namespaces/Delete`

이 권한을 가진 공격자는 전체 Azure Service Bus 네임스페이스를 삭제할 수 있습니다. 이 작업은 네임스페이스와 모든 관련 리소스(큐, 주제, 구독 및 해당 메시지 포함)를 제거하여 모든 종속 시스템 및 워크플로우에서 광범위한 중단과 영구적인 데이터 손실을 초래합니다.
```bash
az servicebus namespace delete --resource-group <ResourceGroupName> --name <NamespaceName>
```
### Actions: `Microsoft.ServiceBus/namespaces/topics/Delete`

이 권한을 가진 공격자는 Azure Service Bus 주제를 삭제할 수 있습니다. 이 작업은 주제와 그와 관련된 모든 구독 및 메시지를 제거하여, 중요한 데이터 손실을 초래하고 주제에 의존하는 시스템 및 워크플로를 방해할 수 있습니다.
```bash
az servicebus topic delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
### Actions: `Microsoft.ServiceBus/namespaces/queues/Delete`

이 권한을 가진 공격자는 Azure Service Bus 큐를 삭제할 수 있습니다. 이 작업은 큐와 그 안의 모든 메시지를 제거하여, 중요한 데이터 손실을 초래하고 큐에 의존하는 시스템 및 워크플로우를 방해할 수 있습니다.
```bash
az servicebus queue delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
### Actions: `Microsoft.ServiceBus/namespaces/topics/subscriptions/Delete`

이 권한을 가진 공격자는 Azure Service Bus 구독을 삭제할 수 있습니다. 이 작업은 구독과 그에 연결된 모든 메시지를 제거하여 구독에 의존하는 워크플로, 데이터 처리 및 시스템 운영에 잠재적으로 중단을 초래할 수 있습니다.
```bash
az servicebus topic subscription delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
### Actions: `Microsoft.ServiceBus/namespaces/write` & `Microsoft.ServiceBus/namespaces/read`

Azure Service Bus 네임스페이스를 생성하거나 수정할 수 있는 권한이 있는 공격자는 이를 이용해 운영을 방해하거나, 무단 리소스를 배포하거나, 민감한 데이터를 노출할 수 있습니다. 그들은 공용 네트워크 접근을 활성화하거나, 암호화 설정을 낮추거나, 성능을 저하시켜 비용을 증가시키기 위해 SKU를 변경하는 등 중요한 구성을 변경할 수 있습니다. 또한, 그들은 로컬 인증을 비활성화하거나, 복제 위치를 조작하거나, TLS 버전을 조정하여 보안 통제를 약화시킬 수 있으며, 이는 네임스페이스 잘못 구성의 중요한 사후 활용 위험이 됩니다.
```bash
az servicebus namespace create --resource-group <ResourceGroupName> --name <NamespaceName> --location <Location>
az servicebus namespace update --resource-group <ResourceGroupName> --name <NamespaceName> --tags <Key=Value>
```
### Actions: `Microsoft.ServiceBus/namespaces/queues/write` (`Microsoft.ServiceBus/namespaces/queues/read`)

Azure Service Bus 큐를 생성하거나 수정할 수 있는 권한이 있는 공격자는 데이터를 가로채거나, 워크플로를 방해하거나, 무단 액세스를 가능하게 하는 데 이를 악용할 수 있습니다. 그들은 악의적인 엔드포인트로 메시지를 전달하거나, 데이터를 부적절하게 유지하거나 삭제하기 위해 메시지 TTL을 조정하거나, 오류 처리를 방해하기 위해 데드레터링을 활성화하는 등 중요한 구성을 변경할 수 있습니다. 또한, 서비스 기능을 방해하거나 탐지를 피하기 위해 큐 크기, 잠금 기간 또는 상태를 조작할 수 있어, 이는 중요한 포스트 익스플로잇 위험입니다.
```bash
az servicebus queue create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
az servicebus queue update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
### Actions: `Microsoft.ServiceBus/namespaces/topics/write` (`Microsoft.ServiceBus/namespaces/topics/read`)

Azure Service Bus 네임스페이스 내에서 주제를 생성하거나 수정할 수 있는 권한이 있는 공격자는 이를 이용해 메시지 워크플로를 방해하거나, 민감한 데이터를 노출시키거나, 무단 작업을 수행할 수 있습니다. az servicebus topic update와 같은 명령을 사용하여, 확장성을 위한 파티셔닝 활성화, 메시지를 부적절하게 유지하거나 폐기하기 위한 TTL 설정 변경, 또는 제어를 우회하기 위한 중복 감지 비활성화와 같은 구성을 조작할 수 있습니다. 또한, 주제 크기 제한을 조정하거나, 가용성을 방해하기 위해 상태를 변경하거나, 가로챈 메시지를 임시로 저장하기 위해 익스프레스 주제를 구성할 수 있어, 주제 관리는 사후 활용 완화를 위한 중요한 초점이 됩니다.
```bash
az servicebus topic create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
az servicebus topic update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
### Actions: `Microsoft.ServiceBus/namespaces/topics/subscriptions/write` (`Microsoft.ServiceBus/namespaces/topics/subscriptions/read`)

구독을 생성하거나 수정할 수 있는 권한이 있는 공격자는 Azure Service Bus 주제 내에서 구독을 수정하기 위해 Action: `Microsoft.ServiceBus/namespaces/topics/subscriptions/read`도 필요합니다. 이를 통해 메시지 워크플로를 가로채거나, 재배치하거나, 방해할 수 있습니다. az servicebus topic subscription update와 같은 명령을 사용하여 메시지를 전환하기 위해 데드 레터링을 활성화하거나, 메시지를 무단 엔드포인트로 전달하거나, TTL 및 잠금 기간을 수정하여 메시지 전달을 유지하거나 방해할 수 있습니다. 또한, 상태 또는 최대 전달 수 설정을 변경하여 운영을 방해하거나 탐지를 피할 수 있으며, 구독 제어는 사후 활용 시나리오에서 중요한 측면이 됩니다.
```bash
az servicebus topic subscription create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
az servicebus topic subscription update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
### 작업: `AuthorizationRules` 메시지 전송 및 수신

여기를 확인하세요:

{{#ref}}
../az-privilege-escalation/az-queue-privesc.md
{{#endref}}

## 참조

- https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues
- https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api
- https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes
- https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-python-how-to-use-topics-subscriptions?tabs=passwordless
- https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/integration#microsoftservicebus
- https://learn.microsoft.com/en-us/cli/azure/servicebus/namespace?view=azure-cli-latest
- https://learn.microsoft.com/en-us/cli/azure/servicebus/queue?view=azure-cli-latest

{{#include ../../../banners/hacktricks-training.md}}
