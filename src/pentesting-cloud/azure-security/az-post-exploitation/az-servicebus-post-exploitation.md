# Az - Service Bus Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Service Bus

Aby uzyskać więcej informacji, sprawdź:

{{#ref}}
../az-services/az-servicebus-enum.md
{{#endref}}

### Actions: `Microsoft.ServiceBus/namespaces/Delete`

Atakujący z tym uprawnieniem może usunąć cały namespace Azure Service Bus. Ta akcja usuwa namespace oraz wszystkie powiązane zasoby, w tym kolejki, tematy, subskrypcje i ich wiadomości, powodując szerokie zakłócenia i trwałą utratę danych we wszystkich zależnych systemach i przepływach pracy.
```bash
az servicebus namespace delete --resource-group <ResourceGroupName> --name <NamespaceName>
```
### Actions: `Microsoft.ServiceBus/namespaces/topics/Delete`

Atakujący z tym uprawnieniem może usunąć temat Azure Service Bus. Ta akcja usuwa temat oraz wszystkie jego powiązane subskrypcje i wiadomości, co może prowadzić do utraty krytycznych danych i zakłócenia systemów oraz przepływów pracy opartych na tym temacie.
```bash
az servicebus topic delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
### Actions: `Microsoft.ServiceBus/namespaces/queues/Delete`

Atakujący z tym uprawnieniem może usunąć kolejkę Azure Service Bus. Ta akcja usuwa kolejkę oraz wszystkie wiadomości w niej, co może prowadzić do utraty krytycznych danych i zakłócenia systemów oraz procesów zależnych od kolejki.
```bash
az servicebus queue delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
### Actions: `Microsoft.ServiceBus/namespaces/topics/subscriptions/Delete`

Napastnik z tym uprawnieniem może usunąć subskrypcję Azure Service Bus. Ta akcja usuwa subskrypcję oraz wszystkie jej powiązane wiadomości, co może zakłócić przepływy pracy, przetwarzanie danych i operacje systemowe polegające na subskrypcji.
```bash
az servicebus topic subscription delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
### Actions: `Microsoft.ServiceBus/namespaces/write` & `Microsoft.ServiceBus/namespaces/read`

Napastnik z uprawnieniami do tworzenia lub modyfikowania przestrzeni nazw Azure Service Bus może to wykorzystać do zakłócania operacji, wdrażania nieautoryzowanych zasobów lub ujawniania wrażliwych danych. Mogą zmieniać krytyczne konfiguracje, takie jak włączanie dostępu do sieci publicznej, obniżanie ustawień szyfrowania lub zmiana SKU w celu pogorszenia wydajności lub zwiększenia kosztów. Dodatkowo mogą wyłączyć lokalną autoryzację, manipulować lokalizacjami replik lub dostosowywać wersje TLS, aby osłabić kontrole bezpieczeństwa, co sprawia, że błędna konfiguracja przestrzeni nazw stanowi istotne ryzyko po eksploatacji.
```bash
az servicebus namespace create --resource-group <ResourceGroupName> --name <NamespaceName> --location <Location>
az servicebus namespace update --resource-group <ResourceGroupName> --name <NamespaceName> --tags <Key=Value>
```
### Actions: `Microsoft.ServiceBus/namespaces/queues/write` (`Microsoft.ServiceBus/namespaces/queues/read`)

Atakujący z uprawnieniami do tworzenia lub modyfikowania kolejek Azure Service Bus (aby zmodyfikować kolejkę, będziesz również potrzebować akcji: `Microsoft.ServiceBus/namespaces/queues/read`) może to wykorzystać do przechwytywania danych, zakłócania przepływów pracy lub umożliwienia nieautoryzowanego dostępu. Mogą zmieniać krytyczne konfiguracje, takie jak przekazywanie wiadomości do złośliwych punktów końcowych, dostosowywanie TTL wiadomości w celu niewłaściwego przechowywania lub usuwania danych, lub włączanie dead-lettering w celu zakłócania obsługi błędów. Dodatkowo mogą manipulować rozmiarami kolejek, czasami blokady lub statusami, aby zakłócać funkcjonalność usługi lub unikać wykrycia, co czyni to istotnym ryzykiem po eksploatacji.
```bash
az servicebus queue create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
az servicebus queue update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
### Actions: `Microsoft.ServiceBus/namespaces/topics/write` (`Microsoft.ServiceBus/namespaces/topics/read`)

Atakujący z uprawnieniami do tworzenia lub modyfikowania tematów (aby zmodyfikować temat, będziesz również potrzebować akcji: `Microsoft.ServiceBus/namespaces/topics/read`) w obrębie przestrzeni nazw Azure Service Bus może to wykorzystać do zakłócania przepływów wiadomości, ujawniania wrażliwych danych lub umożliwienia nieautoryzowanych działań. Używając poleceń takich jak az servicebus topic update, mogą manipulować konfiguracjami, takimi jak włączanie partycjonowania w celu nadużycia skalowalności, zmiana ustawień TTL, aby niewłaściwie zatrzymywać lub odrzucać wiadomości, lub wyłączanie wykrywania duplikatów, aby obejść kontrole. Dodatkowo mogą dostosować limity rozmiaru tematów, zmienić status, aby zakłócić dostępność, lub skonfigurować tematy ekspresowe do tymczasowego przechowywania przechwyconych wiadomości, co sprawia, że zarządzanie tematami jest kluczowym punktem w zakresie łagodzenia skutków po eksploatacji.
```bash
az servicebus topic create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
az servicebus topic update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
### Actions: `Microsoft.ServiceBus/namespaces/topics/subscriptions/write` (`Microsoft.ServiceBus/namespaces/topics/subscriptions/read`)

Atakujący z uprawnieniami do tworzenia lub modyfikowania subskrypcji (aby zmodyfikować subskrypcję, będziesz również potrzebować akcji: `Microsoft.ServiceBus/namespaces/topics/subscriptions/read`) w obrębie tematu Azure Service Bus może to wykorzystać do przechwytywania, przekierowywania lub zakłócania przepływów wiadomości. Używając poleceń takich jak az servicebus topic subscription update, mogą manipulować konfiguracjami, takimi jak włączanie dead lettering w celu przekierowania wiadomości, przesyłanie wiadomości do nieautoryzowanych punktów końcowych lub modyfikowanie TTL i czasu blokady, aby zatrzymać lub zakłócić dostarczanie wiadomości. Dodatkowo mogą zmieniać ustawienia statusu lub maksymalnej liczby dostarczeń, aby zakłócać operacje lub unikać wykrycia, co sprawia, że kontrola subskrypcji jest kluczowym aspektem scenariuszy po eksploatacji.
```bash
az servicebus topic subscription create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
az servicebus topic subscription update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
### Działania: `AuthorizationRules` Wysyłanie i Odbieranie Wiadomości

Zobacz tutaj:

{{#ref}}
../az-privilege-escalation/az-queue-privesc.md
{{#endref}}

## Odniesienia

- https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues
- https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api
- https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes
- https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-python-how-to-use-topics-subscriptions?tabs=passwordless
- https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/integration#microsoftservicebus
- https://learn.microsoft.com/en-us/cli/azure/servicebus/namespace?view=azure-cli-latest
- https://learn.microsoft.com/en-us/cli/azure/servicebus/queue?view=azure-cli-latest

{{#include ../../../banners/hacktricks-training.md}}
