# Az - Service Bus Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Service Bus

Для отримання додаткової інформації перегляньте:

{{#ref}}
../az-services/az-servicebus-enum.md
{{#endref}}

### Дії: `Microsoft.ServiceBus/namespaces/Delete`

Зловмисник з цим дозволом може видалити ціле простір імен Azure Service Bus. Ця дія видаляє простір імен та всі пов'язані ресурси, включаючи черги, теми, підписки та їх повідомлення, що призводить до широкомасштабних збоїв і постійної втрати даних у всіх залежних системах і робочих процесах.
```bash
az servicebus namespace delete --resource-group <ResourceGroupName> --name <NamespaceName>
```
### Дії: `Microsoft.ServiceBus/namespaces/topics/Delete`

Зловмисник з цим дозволом може видалити тему Azure Service Bus. Ця дія видаляє тему та всі її асоційовані підписки і повідомлення, що може призвести до втрати критично важливих даних і порушення роботи систем і робочих процесів, що залежать від теми.
```bash
az servicebus topic delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
### Дії: `Microsoft.ServiceBus/namespaces/queues/Delete`

Зловмисник з цим дозволом може видалити чергу Azure Service Bus. Ця дія видаляє чергу та всі повідомлення в ній, що може призвести до втрати критично важливих даних і порушення роботи систем та робочих процесів, що залежать від черги.
```bash
az servicebus queue delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
### Дії: `Microsoft.ServiceBus/namespaces/topics/subscriptions/Delete`

Зловмисник з цим дозволом може видалити підписку Azure Service Bus. Ця дія видаляє підписку та всі її асоційовані повідомлення, що може порушити робочі процеси, обробку даних та операції системи, які залежать від підписки.
```bash
az servicebus topic subscription delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
### Дії: `Microsoft.ServiceBus/namespaces/queues/write` (`Microsoft.ServiceBus/namespaces/queues/read`)

Зловмисник з правами на створення або модифікацію черг Azure Service Bus (для модифікації черги вам також знадобиться дія: `Microsoft.ServiceBus/namespaces/queues/read`) може використати це для перехоплення даних, порушення робочих процесів або надання несанкціонованого доступу. Вони можуть змінювати критичні конфігурації, такі як пересилання повідомлень на шкідливі кінцеві точки, налаштування TTL повідомлень для неналежного збереження або видалення даних, або активація механізму "мертвих листів" для втручання в обробку помилок. Крім того, вони можуть маніпулювати розмірами черг, тривалістю блокувань або статусами, щоб порушити функціональність служби або уникнути виявлення, що робить це значним ризиком після експлуатації.
```bash
az servicebus queue create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
az servicebus queue update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
### Дії: `Microsoft.ServiceBus/namespaces/topics/write` (`Microsoft.ServiceBus/namespaces/topics/read`)

Зловмисник з правами на створення або модифікацію тем (для модифікації теми вам також знадобиться дія: `Microsoft.ServiceBus/namespaces/topics/read`) в межах простору імен Azure Service Bus може використати це для порушення робочих процесів повідомлень, розкриття чутливих даних або дозволу несанкціонованих дій. Використовуючи команди, такі як az servicebus topic update, вони можуть маніпулювати конфігураціями, такими як увімкнення розподілу для зловживання масштабованістю, зміна налаштувань TTL для неналежного збереження або відкидання повідомлень, або вимкнення виявлення дублікатів для обходу контролю. Крім того, вони можуть налаштувати обмеження розміру теми, змінити статус для порушення доступності або налаштувати експрес-теми для тимчасового зберігання перехоплених повідомлень, що робить управління темами критично важливим аспектом для пом'якшення наслідків після експлуатації.
```bash
az servicebus topic create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
az servicebus topic update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
### Дії: `Microsoft.ServiceBus/namespaces/topics/subscriptions/write` (`Microsoft.ServiceBus/namespaces/topics/subscriptions/read`)

Зловмисник з правами на створення або модифікацію підписок (для модифікації підписки вам також знадобиться дія: `Microsoft.ServiceBus/namespaces/topics/subscriptions/read`) в рамках теми Azure Service Bus може використати це для перехоплення, перенаправлення або порушення робочих процесів повідомлень. Використовуючи команди, такі як az servicebus topic subscription update, вони можуть маніпулювати конфігураціями, такими як увімкнення мертвого листування для відволікання повідомлень, пересилання повідомлень на несанкціоновані кінцеві точки або модифікація TTL і тривалості блокування для збереження або втручання в доставку повідомлень. Крім того, вони можуть змінювати налаштування статусу або максимального ліміту доставки, щоб порушити операції або уникнути виявлення, що робить контроль підписок критично важливим аспектом сценаріїв після експлуатації.
```bash
az servicebus topic subscription create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
az servicebus topic subscription update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
### Дії: `AuthorizationRules` Надсилання та Отримання Повідомлень

Подивіться сюди:

{{#ref}}
../az-privilege-escalation/az-queue-privesc.md
{{#endref}}

## Посилання

- [https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues](https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues)
- [https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api](https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api)
- [https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes](https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes)
- [https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-python-how-to-use-topics-subscriptions?tabs=passwordless](https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-python-how-to-use-topics-subscriptions?tabs=passwordless)
- [https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/integration#microsoftservicebus](https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/integration#microsoftservicebus)
- [https://learn.microsoft.com/en-us/cli/azure/servicebus/namespace?view=azure-cli-latest](https://learn.microsoft.com/en-us/cli/azure/servicebus/namespace?view=azure-cli-latest)
- [https://learn.microsoft.com/en-us/cli/azure/servicebus/queue?view=azure-cli-latest](https://learn.microsoft.com/en-us/cli/azure/servicebus/queue?view=azure-cli-latest)

{{#include ../../../banners/hacktricks-training.md}}
