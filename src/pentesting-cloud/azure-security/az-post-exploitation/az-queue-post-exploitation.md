# Az - Queue Storage Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Queue

자세한 정보는 다음을 확인하세요:

{{#ref}}
../az-services/az-queue-enum.md
{{#endref}}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/read`

이 권한을 가진 공격자는 Azure Storage Queue에서 메시지를 엿볼 수 있습니다. 이를 통해 공격자는 메시지를 처리된 것으로 표시하거나 상태를 변경하지 않고 메시지의 내용을 볼 수 있습니다. 이는 민감한 정보에 대한 무단 접근으로 이어질 수 있으며, 데이터 유출 또는 추가 공격을 위한 정보 수집을 가능하게 합니다.
```bash
az storage message peek --queue-name <queue_name> --account-name <storage_account>
```
**잠재적 영향**: 큐에 대한 무단 접근, 메시지 노출 또는 무단 사용자 또는 서비스에 의한 큐 조작.

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/process/action`

이 권한을 통해 공격자는 Azure Storage Queue에서 메시지를 검색하고 처리할 수 있습니다. 이는 그들이 메시지 내용을 읽고 이를 처리된 것으로 표시하여 합법적인 시스템에서 숨길 수 있음을 의미합니다. 이로 인해 민감한 데이터가 노출되거나 메시지 처리 방식에 중단이 발생하거나, 메시지를 의도된 사용자에게 사용할 수 없게 만들어 중요한 워크플로가 중단될 수 있습니다.
```bash
az storage message get --queue-name <queue_name> --account-name <storage_account>
```
### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/add/action`

이 권한을 통해 공격자는 Azure Storage Queue에 새로운 메시지를 추가할 수 있습니다. 이를 통해 악의적이거나 승인되지 않은 데이터를 큐에 주입할 수 있으며, 이는 의도하지 않은 작업을 유발하거나 메시지를 처리하는 하위 서비스에 방해를 줄 수 있습니다.
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>
```
### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/write`

이 권한은 공격자가 Azure Storage Queue에 새로운 메시지를 추가하거나 기존 메시지를 업데이트할 수 있게 해줍니다. 이를 사용하여 해로운 콘텐츠를 삽입하거나 기존 메시지를 변경할 수 있으며, 이는 큐에 의존하는 애플리케이션을 오도하거나 시스템에서 원치 않는 동작을 유발할 수 있습니다.
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>

#Update the message
az storage message update --queue-name <queue-name> \
--id <message-id> \
--pop-receipt <pop-receipt> \
--content "Updated message content" \
--visibility-timeout <timeout-in-seconds> \
--account-name <storage-account>
```
### Actions: `Microsoft.Storage/storageAccounts/queueServices/queues/delete`

이 권한은 공격자가 스토리지 계정 내의 큐를 삭제할 수 있게 해줍니다. 이 기능을 활용함으로써 공격자는 큐와 그에 연결된 모든 메시지를 영구적으로 제거할 수 있으며, 이는 워크플로우에 상당한 중단을 초래하고 영향을 받는 큐에 의존하는 애플리케이션에 대한 중요한 데이터 손실을 초래할 수 있습니다. 이 작업은 시스템의 필수 구성 요소를 제거하여 서비스를 방해하는 데에도 사용될 수 있습니다.
```bash
az storage queue delete --name <queue-name> --account-name <storage-account>
```
### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/delete`

이 권한을 사용하면 공격자가 Azure Storage Queue에서 모든 메시지를 삭제할 수 있습니다. 이 작업은 모든 메시지를 제거하여 워크플로를 방해하고 큐에 의존하는 시스템의 데이터 손실을 초래합니다.
```bash
az storage message clear --queue-name <queue-name> --account-name <storage-account>
```
### Actions: `Microsoft.Storage/storageAccounts/queueServices/queues/write`

이 권한은 공격자가 스토리지 계정 내에서 큐 및 그 속성을 생성하거나 수정할 수 있게 해줍니다. 이를 통해 무단 큐를 생성하거나 메타데이터를 수정하거나 접근 제어 목록(ACL)을 변경하여 접근을 허용하거나 제한할 수 있습니다. 이 기능은 워크플로를 방해하거나 악성 데이터를 주입하거나 민감한 정보를 유출하거나 큐 설정을 조작하여 추가 공격을 가능하게 할 수 있습니다.
```bash
az storage queue create --name <new-queue-name> --account-name <storage-account>

az storage queue metadata update --name <queue-name> --metadata key1=value1 key2=value2 --account-name <storage-account>

az storage queue policy set --name <queue-name> --permissions rwd --expiry 2024-12-31T23:59:59Z --account-name <storage-account>
```
## References

- https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues
- https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api
- https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes

{{#include ../../../banners/hacktricks-training.md}}
