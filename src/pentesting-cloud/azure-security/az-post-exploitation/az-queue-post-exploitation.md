# Az - Queue Storage Pós Exploração

{{#include ../../../banners/hacktricks-training.md}}

## Fila

Para mais informações, consulte:

{{#ref}}
../az-services/az-queue-enum.md
{{#endref}}

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/read`

Um atacante com esta permissão pode visualizar mensagens de uma Azure Storage Queue. Isso permite que o atacante veja o conteúdo das mensagens sem marcá-las como processadas ou alterar seu estado. Isso pode levar ao acesso não autorizado a informações sensíveis, possibilitando a exfiltração de dados ou a coleta de inteligência para ataques futuros.
```bash
az storage message peek --queue-name <queue_name> --account-name <storage_account>
```
**Impacto Potencial**: Acesso não autorizado à fila, exposição de mensagens ou manipulação da fila por usuários ou serviços não autorizados.

### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/process/action`

Com esta permissão, um atacante pode recuperar e processar mensagens de uma Azure Storage Queue. Isso significa que eles podem ler o conteúdo da mensagem e marcá-la como processada, efetivamente ocultando-a de sistemas legítimos. Isso pode levar à exposição de dados sensíveis, interrupções na forma como as mensagens são tratadas ou até mesmo parar fluxos de trabalho importantes ao tornar mensagens indisponíveis para seus usuários pretendidos.
```bash
az storage message get --queue-name <queue_name> --account-name <storage_account>
```
### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/add/action`

Com essa permissão, um atacante pode adicionar novas mensagens a uma Azure Storage Queue. Isso permite que eles injetem dados maliciosos ou não autorizados na fila, potencialmente acionando ações não intencionais ou interrompendo serviços subsequentes que processam as mensagens.
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>
```
### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/write`

Esta permissão permite que um atacante adicione novas mensagens ou atualize as existentes em uma Azure Storage Queue. Ao usar isso, eles poderiam inserir conteúdo prejudicial ou alterar mensagens existentes, potencialmente enganando aplicativos ou causando comportamentos indesejados em sistemas que dependem da fila.
```bash
az storage message put --queue-name <queue-name> --content "Injected malicious message" --account-name <storage-account>

#Update the message
az storage message update --queue-name <queue-name> \
--id <message-id> \
--pop-receipt <pop-receipt> \
--content "Updated message content" \
--visibility-timeout <timeout-in-seconds> \
--account-name <storage-account>
```
### Ações: `Microsoft.Storage/storageAccounts/queueServices/queues/delete`

Esta permissão permite que um atacante exclua filas dentro da conta de armazenamento. Ao aproveitar essa capacidade, um atacante pode remover permanentemente filas e todas as suas mensagens associadas, causando uma interrupção significativa nos fluxos de trabalho e resultando em perda crítica de dados para aplicativos que dependem das filas afetadas. Esta ação também pode ser usada para sabotar serviços, removendo componentes essenciais do sistema.
```bash
az storage queue delete --name <queue-name> --account-name <storage-account>
```
### DataActions: `Microsoft.Storage/storageAccounts/queueServices/queues/messages/delete`

Com esta permissão, um atacante pode limpar todas as mensagens de uma Azure Storage Queue. Esta ação remove todas as mensagens, interrompendo fluxos de trabalho e causando perda de dados para sistemas dependentes da fila.
```bash
az storage message clear --queue-name <queue-name> --account-name <storage-account>
```
### Ações: `Microsoft.Storage/storageAccounts/queueServices/queues/write`

Esta permissão permite que um atacante crie ou modifique filas e suas propriedades dentro da conta de armazenamento. Pode ser usada para criar filas não autorizadas, modificar metadados ou alterar listas de controle de acesso (ACLs) para conceder ou restringir acesso. Essa capacidade pode interromper fluxos de trabalho, injetar dados maliciosos, exfiltrar informações sensíveis ou manipular configurações de fila para permitir novos ataques.
```bash
az storage queue create --name <new-queue-name> --account-name <storage-account>

az storage queue metadata update --name <queue-name> --metadata key1=value1 key2=value2 --account-name <storage-account>

az storage queue policy set --name <queue-name> --permissions rwd --expiry 2024-12-31T23:59:59Z --account-name <storage-account>
```
## Referências

- https://learn.microsoft.com/pt-br/azure/storage/queues/storage-powershell-how-to-use-queues
- https://learn.microsoft.com/pt-br/rest/api/storageservices/queue-service-rest-api
- https://learn.microsoft.com/pt-br/azure/storage/queues/queues-auth-abac-attributes

{{#include ../../../banners/hacktricks-training.md}}
