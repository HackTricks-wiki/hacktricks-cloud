# Az - Azure Container Instances Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Azure Container Instances

Για περισσότερες πληροφορίες ελέγξτε:

{{#ref}}
../az-services/az-container-instances.md
{{#endref}}

### `Microsoft.ContainerInstance/containerGroups/read`, `Microsoft.ContainerInstance/containerGroups/containers/exec/action`

Αυτές οι άδειες επιτρέπουν στον χρήστη να **εκτελεί μια εντολή** σε ένα τρέχον κοντέινερ. Αυτό μπορεί να χρησιμοποιηθεί για **αναβάθμιση δικαιωμάτων** στο κοντέινερ αν έχει οποιαδήποτε διαχειριζόμενη ταυτότητα συνδεδεμένη. Φυσικά, είναι επίσης δυνατό να αποκτήσετε πρόσβαση στον πηγαίο κώδικα και σε οποιαδήποτε άλλη ευαίσθητη πληροφορία αποθηκευμένη μέσα στο κοντέινερ.

Για να εκτελέσετε ένα `ls` και να λάβετε την έξοδο είναι τόσο απλό όσο:
```bash
az container exec --name <container-name> --resource-group <res-group>  --exec-command 'ls'
```
Είναι επίσης δυνατό να **διαβάσετε την έξοδο** του κοντέινερ με:
```bash
az container attach --name <container-name> --resource-group <res-group>
```
Ή αποκτήστε τα αρχεία καταγραφής με:
```bash
az container logs --name <container-name> --resource-group <res-group>
```
### `Microsoft.ContainerInstance/containerGroups/write`, `Microsoft.ManagedIdentity/userAssignedIdentities/assign/action`

Αυτές οι άδειες επιτρέπουν να **συνδεθεί μια ταυτότητα που διαχειρίζεται ο χρήστης** σε μια ομάδα κοντέινερ. Αυτό είναι πολύ χρήσιμο για την αναβάθμιση δικαιωμάτων στο κοντέινερ.

Για να συνδέσετε μια ταυτότητα που διαχειρίζεται ο χρήστης σε μια ομάδα κοντέινερ:
```bash
az rest \
--method PATCH \
--url "/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.ContainerInstance/containerGroups/<container-name>?api-version=2021-09-01" \
--body '{
"identity": {
"type": "UserAssigned",
"userAssignedIdentities": {
"/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.ManagedIdentity/userAssignedIdentities/<user-namaged-identity-name>": {}
}
}
}' \
--headers "Content-Type=application/json"
```
### `Microsoft.Resources/subscriptions/resourcegroups/read`, `Microsoft.ContainerInstance/containerGroups/write`, `Microsoft.ManagedIdentity/userAssignedIdentities/assign/action`

Αυτές οι άδειες επιτρέπουν να **δημιουργηθεί ή να ενημερωθεί μια ομάδα κοντέινερ** με μια **ταυτότητα διαχειριζόμενη από χρήστη** συνδεδεμένη σε αυτήν. Αυτό είναι πολύ χρήσιμο για την κλιμάκωση δικαιωμάτων στο κοντέινερ.
```bash
az container create \
--resource-group <res-group>> \
--name nginx2 \
--image mcr.microsoft.com/oss/nginx/nginx:1.9.15-alpine \
--assign-identity "/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.ManagedIdentity/userAssignedIdentities/<user-namaged-identity-name>" \
--restart-policy OnFailure \
--os-type Linux \
--cpu 1 \
--memory 1.0
```
Επιπλέον, είναι επίσης δυνατή η ενημέρωση μιας υπάρχουσας ομάδας κοντέινερ προσθέτοντας για παράδειγμα το **`--command-line` επιχείρημα** με ένα reverse shell.

{{#include ../../../banners/hacktricks-training.md}}
