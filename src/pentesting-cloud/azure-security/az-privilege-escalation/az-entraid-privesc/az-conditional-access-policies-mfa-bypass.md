# Az - Conditional Access Policies & MFA Bypass

{{#include ../../../../banners/hacktricks-training.md}}

## Taarifa za Msingi

Azure Conditional Access policies ni kanuni zilizowekwa katika Microsoft Azure kutekeleza udhibiti wa upatikanaji kwa Azure services na programu kulingana na certain **masharti**. Sera hizi husaidia mashirika kulinda rasilimali zao kwa kutumia udhibiti sahihi wa upatikanaji katika mazingira sahihi.\
Conditional access policies kwa msingi hufafanua **Nani** anaweza kufikia **Nini** kutoka **Wapi** na **Jinsi**.

Hapa kuna mifano michache:

1. **Sign-In Risk Policy**: Sera hii inaweza kuwekwa kuhitaji multi-factor authentication (MFA) wakati hatari ya kuingia inapotambuliwa. Kwa mfano, ikiwa tabia ya kuingia ya mtumiaji ni isiyo ya kawaida ukilinganisha na muundo wao wa kawaida, kama kuingia kutoka nchi tofauti, mfumo unaweza kuomba uthibitisho wa ziada.
2. **Device Compliance Policy**: Sera hii inaweza kuzuiwa upatikanaji kwa Azure services tu kwa vifaa vinavyokubaliana na viwango vya usalama vya shirika. Kwa mfano, upatikanaji unaweza kuruhusiwa tu kutoka kwa vifaa ambavyo vina antivirus iliyosasishwa au vinatumia toleo fulani la mfumo wa uendeshaji.

## Enumeration
```bash
# Get all the policies from Azure without needing any special permission with (idea from https://github.com/LuemmelSec/APEX/blob/main/APEX.ps1)
az rest --method GET --uri 'https://graph.windows.net/<tenant-id>/policies?api-version=1.61-internal' | jq '.value[] | select(.policyType == 18) | {displayName, policyDetail: (.policyDetail[] | fromjson)}'

# You need Policy.Read.ConditionalAccess or Policy.Read.All permission in Entra ID
az rest --method get --uri "https://graph.microsoft.com/beta/identity/conditionalAccess/policies"
```
## Njia za Kuvuka Sera za Conditional Access

Inawezekana kwamba sera ya conditional access inakuwa **ikikagua baadhi ya taarifa ambazo zinaweza kubadilishwa kwa urahisi na kuruhusu kuvuka sera**. Na kwa mfano, ikiwa sera ilikuwa ikisanidi MFA, mshambuliaji ataweza kuipita.

Unaposanidi sera ya conditional access inahitajika kubainisha **watumiaji** walioathirika na **rasilimali lengwa** (kama programu zote za cloud).

Pia inahitajika kusanidi **masharti** ambayo yata**chochea** sera:

- **Network**: IP, IP ranges na maeneo kijiografia
- Inaweza kuvukwa kwa kutumia VPN au Proxy kuunganishwa na nchi iliyoruhusiwa au kwa kufanikiwa kuingia kutoka anwani ya IP iliyoruhusiwa
- **Microsoft risks**: User risk, Sign-in risk, Insider risk
- **Device platforms**: Any device au chagua Android, iOS, Windows phone, Windows, macOS, Linux
- Ikiwa “Any device” haishachaguliwa lakini chaguo zote nyingine zimetengwa, inawezekana kuzipita kwa kutumia user-agent isiyohusiana na yale majukwaa
- **Client apps**: Options are “Browser”, “Mobiles apps and desktop clients”, “Exchange ActiveSync clients” and Other clients”
- Kuipita kwa kuingia kwa chaguo ambacho hakijachaguliwa
- **Filter for devices**: Inawezekana kutengeneza rule inayohusiana na kifaa kinachotumika
- **Authentication flows**: Options are “Device code flow” and “Authentication transfer”
- Hii haitamkera mshambuliaji isipokuwa anajaribu kuabusu moja ya protokoli hizo katika jaribio la phishing ili kupata akaunti ya mwathirika

Matokeo yanayowezekana ni: Kuzuia au Kutoa ufikiaji kwa masharti kama kuhitaji MFA, kifaa kiwe compliant…

### Device Platforms - Device Condition

Inawezekana kuweka masharti kulingana na **device platform** (Android, iOS, Windows, macOS...), hata hivyo, hii inategemea **user-agent** hivyo ni rahisi kuipita. Hata **kufanya chaguo zote zifanye MFA iwe lazima**, ikiwa utatumia **user-agent ambayo haijatambuliwa,** utaweza kuipita MFA au kuzuia:

<figure><img src="../../../../images/image (352).png" alt=""><figcaption></figcaption></figure>

Kwa kufanya tu browser **itume user-agent isiyojulikana** (kama `Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone 8.0; Trident/6.0; IEMobile/10.0; ARM; Touch; NOKIA; Lumia 920) UCBrowser/10.1.0.563 Mobile`) inatosha kutoanzisha masharti haya.\
Unaweza kubadilisha user agent kwa **mikono** katika developer tools:

<figure><img src="../../../../images/image (351).png" alt="" width="375"><figcaption></figcaption></figure>

Au tumia [browser extension kama hii](https://chromewebstore.google.com/detail/user-agent-switcher-and-m/bhchdcejhohfmigjafbampogmaanbfkg?hl=en).

### Locations: Countries, IP ranges - Device Condition

Ikiwa hili limewekwa kwenye sera ya conditional, mshambuliaji anaweza kutumia VPN katika nchi iliyoruhusiwa au kujaribu kupata njia ya kuingia kutoka anwani ya IP iliyoruhusiwa kuvuka masharti haya.

### Cloud Apps

Inawezekana kusanidi **conditional access policies ili kuzuia au kulazimisha** kwa mfano MFA wakati mtumiaji anajaribu kufikia **app maalum**:

<figure><img src="../../../../images/image (353).png" alt=""><figcaption></figcaption></figure>

Ili kujaribu kuipita ulinzi huu unapaswa kuona kama unaweza **ingia kwenye programu yoyote**.\
Tool [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep) ina **kumi na kumi za application IDs zilizowekwa (hardcoded)** na itajaribu kuingia nazo na kukuarifu na hata kukupatia token ikiwa itafanikiwa.

Ili **kuuza specific application IDs katika rasilimali maalum** pia unaweza kutumia tool kama:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokens-stdout

<token>
```
Zaidi ya hayo, pia inawezekana kulinda njia ya kuingia (kwa mfano ikiwa unajaribu kuingia kutoka kwa browser au kutoka kwa desktop application). Zana [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) hufanya ukaguzi kadhaa ili kujaribu kupita (bypass) ulinzi huu pia.

Zana [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) pia inaweza kutumika kwa madhumuni sawa ingawa inaonekana haendelezwi.

Zana [**ROPCI**](https://github.com/wunderwuzzi23/ropci) pia inaweza kutumika kujaribu ulinzi huu na kuona kama inawezekana kupita MFA au vizuizi, lakini zana hii inafanya kazi kutoka mtazamo wa **whitebox**. Kwanza unahitaji kupakua orodha ya Apps zilizoruhusiwa katika tenant kisha itajaribu kuingia ndani yao.

## Njia Nyingine za Kupita za Az MFA

### Toni ya simu

Moja ya chaguo za Azure MFA ni **kupokea simu kwenye namba ya simu iliyosanidiwa** ambapo mtumiaji ataombwa **kutuma alama `#`**.

> [!CAUTION]
> Kwa kuwa alama ni tu **tones**, mshambuliaji anaweza **kuingilia** ujumbe wa sauti (voicemail) wa namba ya simu, kusanidi ujumbe kuwa **tone ya `#`** na kisha, anapokuomba MFA hakikisha simu ya mwathirika iko **busy** (ikiwa inapigiwa) ili simu ya Azure ipelekwe kwenye ujumbe wa sauti.

### Vifaa vinavyokubalika

Sera mara nyingi zinaomba kifaa kinachokubalika au MFA, hivyo mshambuliaji anaweza kusajili kifaa kinachokubalika, kupata token ya **PRT** na kwa njia hiyo **kupita (bypass) MFA**.

Anza kwa kusajili **kifaa kinachokubalika katika Intune**, kisha **pata PRT** na:
```bash
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Pata taarifa zaidi kuhusu aina hii ya shambulio kwenye ukurasa ufuatao:

{{#ref}}
../../az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md
{{#endref}}

## Zana

### [**AzureAppsSweep**](https://github.com/carlospolop/AzureAppsSweep)

Script hii hupata baadhi ya credentials za watumiaji na kuangalia kama inaweza kuingia kwenye baadhi ya applications.

Hii ni muhimu kuona ikiwa **MFA hainahitajiki kuingia kwenye baadhi ya applications** ambazo unaweza baadaye kuzitumia vibaya ili **escalate privileges**.

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Pata sera zote
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep ni PowerShell script ambayo inajaribu **kuingia kwenye huduma mbalimbali za Microsoft kwa kutumia seti ya credentials zilizotolewa na itajaribu kubaini ikiwa MFA imewezeshwa**. Kulingana na jinsi conditional access policies na mipangilio mingine ya multi-factor authentication imewekwa, baadhi ya protocols zinaweza kubaki kuwa single-factor. Pia ina ukaguzi wa ziada kwa konfigurisho za ADFS na inaweza kujaribu kuingia kwenye on-prem ADFS server ikiwa itagunduliwa.
```bash
Invoke-Expression (Invoke-WebRequest -Uri "https://raw.githubusercontent.com/dafthack/MFASweep/master/MFASweep.ps1").Content
Invoke-MFASweep -Username <username> -Password <pass>
```
### [ROPCI](https://github.com/wunderwuzzi23/ropci)

Kifaa hiki kimewasaidia kutambua MFA bypasses na kisha kutumia APIs kwa uabusu katika multiple production AAD tenants, ambapo wateja wa AAD waliamini walikuwa na MFA iliyotekelezwa, lakini ROPC based authentication ilifanikiwa.

> [!TIP]
> Unahitaji kuwa na ruhusa za kuorodhesha applications zote ili uweze kuunda orodha ya apps za brute-force.
```bash
./ropci configure
./ropci apps list --all --format json -o apps.json
./ropci apps list --all --format json | jq -r '.value[] | [.displayName,.appId] | @csv' > apps.csv
./ropci auth bulk -i apps.csv -o results.json
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token ni seti ya functions inayolenga kusaidia washauri wa usalama ambao wanahitaji kuthibitisha Conditional Access Policies, kufanya majaribio kwa 2FA-enabled Microsoft portals, n.k..

<pre class="language-powershell"><code class="lang-powershell"><strong>git clone https://github.com/silverhack/donkeytoken.git
</strong><strong>Import-Module '.\donkeytoken' -Force
</strong></code></pre>

**Jaribu kila portal** ikiwa inawezekana **login bila MFA**:
```bash
$username = "conditional-access-app-user@azure.hacktricks-training.com"
$password = ConvertTo-SecureString "Poehurgi78633" -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential($username, $password)
Invoke-MFATest -credential $cred -Verbose -Debug -InformationAction Continue
```
Kwa sababu **Azure** **portal** haijawekewa vizingiti, inawezekana **kukusanya token kutoka kwenye endpoint ya portal ili kufikia huduma yoyote iliyogunduliwa** na utekelezaji uliopita. Katika kesi hii Sharepoint ilitambuliwa, na token ya kuifikia imeombwa:
```bash
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
Ikiwa token ina ruhusa Sites.Read.All (kutoka Sharepoint), hata kama huwezi kufikia Sharepoint kupitia wavuti kwa sababu ya MFA, inawezekana kutumia token hiyo kufikia faili kwa kutumia token iliyotengenezwa:
```bash
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Marejeo

- [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM&t=296s)
- [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

{{#include ../../../../banners/hacktricks-training.md}}
