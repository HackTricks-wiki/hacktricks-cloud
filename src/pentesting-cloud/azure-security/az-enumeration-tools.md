# Az - Enumeration Tools

{{#include ../../banners/hacktricks-training.md}}

## 在 Linux 中安装 PowerShell

> [!TIP]
> 在 Linux 中，您需要安装 PowerShell Core：
```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
## 在 MacOS 上安装 PowerShell

来自 [**文档**](https://learn.microsoft.com/en-us/powershell/scripting/install/installing-powershell-on-macos?view=powershell-7.4) 的说明：

1. 如果尚未安装，请安装 `brew`：
```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```
2. 安装最新的稳定版 PowerShell：
```sh
brew install powershell/tap/powershell
```
3. 运行 PowerShell:
```sh
pwsh
```
4. 更新：
```sh
brew update
brew upgrade powershell
```
## 主要枚举工具

### az cli

[**Azure 命令行界面 (CLI)**](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli) 是一个跨平台工具，使用 Python 编写，用于管理和管理 (大多数) Azure 和 Entra ID 资源。它连接到 Azure 并通过命令行或脚本执行管理命令。

请访问此链接以获取 [**安装说明¡**](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli#install)。

Azure CLI 中的命令结构模式为： `az <service> <action> <parameters>`

#### 调试 | MitM az cli

使用参数 **`--debug`** 可以查看工具 **`az`** 发送的所有请求：
```bash
az account management-group list --output table --debug
```
为了对工具进行**MitM**并**手动检查所有发送的请求**，您可以执行： 

{{#tabs }}
{{#tab name="Bash" }}
```bash
export ADAL_PYTHON_SSL_NO_VERIFY=1
export AZURE_CLI_DISABLE_CONNECTION_VERIFICATION=1
export HTTPS_PROXY="http://127.0.0.1:8080"
export HTTP_PROXY="http://127.0.0.1:8080"

# If this is not enough
# Download the certificate from Burp and convert it into .pem format
# And export the following env variable
openssl x509 -in ~/Downloads/cacert.der -inform DER -out ~/Downloads/cacert.pem -outform PEM
export REQUESTS_CA_BUNDLE=/Users/user/Downloads/cacert.pem
```
{{#endtab }}

{{#tab name="PS" }}
```bash
$env:ADAL_PYTHON_SSL_NO_VERIFY=1
$env:AZURE_CLI_DISABLE_CONNECTION_VERIFICATION=1
$env:HTTPS_PROXY="http://127.0.0.1:8080"
$env:HTTP_PROXY="http://127.0.0.1:8080"
```
{{#endtab }}
{{#endtabs }}

### Az PowerShell

Azure PowerShell 是一个模块，包含用于直接从 PowerShell 命令行管理 Azure 资源的 cmdlets。

请访问此链接以获取 [**安装说明**](https://learn.microsoft.com/en-us/powershell/azure/install-azure-powershell)。

Azure PowerShell AZ 模块中的命令结构如下：`<Action>-Az<Service> <parameters>`

#### Debug | MitM Az PowerShell

使用参数 **`-Debug`** 可以查看工具发送的所有请求：
```bash
Get-AzResourceGroup -Debug
```
为了对工具进行**MitM**并手动**检查所有发送的请求**，您可以根据[**文档**](https://learn.microsoft.com/en-us/powershell/azure/az-powershell-proxy)设置环境变量`HTTPS_PROXY`和`HTTP_PROXY`。

### Microsoft Graph PowerShell

Microsoft Graph PowerShell是一个跨平台SDK，能够访问所有Microsoft Graph API，包括SharePoint、Exchange和Outlook等服务，使用单一端点。它支持PowerShell 7+、通过MSAL的现代身份验证、外部身份和高级查询。专注于最小权限访问，确保安全操作，并定期更新以与最新的Microsoft Graph API功能保持一致。

请访问此链接以获取[**安装说明**](https://learn.microsoft.com/en-us/powershell/microsoftgraph/installation)。

Microsoft Graph PowerShell中的命令结构如下：`<Action>-Mg<Service> <parameters>`

#### 调试Microsoft Graph PowerShell

使用参数**`-Debug`**可以查看工具发送的所有请求：
```bash
Get-MgUser -Debug
```
### ~~**AzureAD Powershell**~~

Azure Active Directory (AD) 模块，现在 **已弃用**，是用于管理 Azure AD 资源的 Azure PowerShell 的一部分。它提供了用于管理用户、组和 Entra ID 中的应用程序注册的 cmdlet。

> [!TIP]
> 这被 Microsoft Graph PowerShell 替代

Follow this link for the [**installation instructions**](https://www.powershellgallery.com/packages/AzureAD).

{{#include ../../banners/hacktricks-training.md}}
