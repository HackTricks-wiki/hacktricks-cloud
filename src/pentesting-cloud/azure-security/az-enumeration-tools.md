# Az - Herramientas de Enumeración

{{#include ../../banners/hacktricks-training.md}}

## Instalar PowerShell en Linux

> [!TIP]
> En Linux necesitarás instalar PowerShell Core:
```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
## Instalar PowerShell en MacOS

Instrucciones de la [**documentación**](https://learn.microsoft.com/en-us/powershell/scripting/install/installing-powershell-on-macos?view=powershell-7.4):

1. Instala `brew` si aún no está instalado:
```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```
2. Instala la última versión estable de PowerShell:
```sh
brew install powershell/tap/powershell
```
3. Ejecutar PowerShell:
```sh
pwsh
```
4. Actualización:
```sh
brew update
brew upgrade powershell
```
## Herramientas Principales de Enumeración

### az cli

[**Interfaz de Línea de Comandos de Azure (CLI)**](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli) es una herramienta multiplataforma escrita en Python para gestionar y administrar (la mayoría de) los recursos de Azure y Entra ID. Se conecta a Azure y ejecuta comandos administrativos a través de la línea de comandos o scripts.

Sigue este enlace para las [**instrucciones de instalación¡**](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli#install).

Los comandos en Azure CLI están estructurados utilizando un patrón de: `az <servicio> <acción> <parámetros>`

#### Depurar | MitM az cli

Usando el parámetro **`--debug`** es posible ver todas las solicitudes que la herramienta **`az`** está enviando:
```bash
az account management-group list --output table --debug
```
Para realizar un **MitM** a la herramienta y **verificar todas las solicitudes** que está enviando manualmente, puedes hacer:

{{#tabs }}
{{#tab name="Bash" }}
```bash
export ADAL_PYTHON_SSL_NO_VERIFY=1
export AZURE_CLI_DISABLE_CONNECTION_VERIFICATION=1
export HTTPS_PROXY="http://127.0.0.1:8080"
export HTTP_PROXY="http://127.0.0.1:8080"

# If this is not enough
# Download the certificate from Burp and convert it into .pem format
# And export the following env variable
openssl x509 -in ~/Downloads/cacert.der -inform DER -out ~/Downloads/cacert.pem -outform PEM
export REQUESTS_CA_BUNDLE=/Users/user/Downloads/cacert.pem
```
{{#endtab }}

{{#tab name="PS" }}
```bash
$env:ADAL_PYTHON_SSL_NO_VERIFY=1
$env:AZURE_CLI_DISABLE_CONNECTION_VERIFICATION=1
$env:HTTPS_PROXY="http://127.0.0.1:8080"
$env:HTTP_PROXY="http://127.0.0.1:8080"
```
{{#endtab }}
{{#endtabs }}

### Az PowerShell

Azure PowerShell es un módulo con cmdlets para gestionar recursos de Azure directamente desde la línea de comandos de PowerShell.

Sigue este enlace para las [**instrucciones de instalación**](https://learn.microsoft.com/en-us/powershell/azure/install-azure-powershell).

Los comandos en el módulo AZ de Azure PowerShell están estructurados como: `<Action>-Az<Service> <parameters>`

#### Debug | MitM Az PowerShell

Usando el parámetro **`-Debug`** es posible ver todas las solicitudes que la herramienta está enviando:
```bash
Get-AzResourceGroup -Debug
```
Para realizar un **MitM** a la herramienta y **ver todas las solicitudes** que está enviando manualmente, puedes establecer las variables de entorno `HTTPS_PROXY` y `HTTP_PROXY` de acuerdo con la [**documentación**](https://learn.microsoft.com/en-us/powershell/azure/az-powershell-proxy).

### Microsoft Graph PowerShell

Microsoft Graph PowerShell es un SDK multiplataforma que permite el acceso a todas las API de Microsoft Graph, incluidos servicios como SharePoint, Exchange y Outlook, utilizando un único punto final. Soporta PowerShell 7+, autenticación moderna a través de MSAL, identidades externas y consultas avanzadas. Con un enfoque en el acceso de menor privilegio, garantiza operaciones seguras y recibe actualizaciones regulares para alinearse con las últimas características de la API de Microsoft Graph.

Sigue este enlace para las [**instrucciones de instalación**](https://learn.microsoft.com/en-us/powershell/microsoftgraph/installation).

Los comandos en Microsoft Graph PowerShell están estructurados como: `<Action>-Mg<Service> <parameters>`

#### Depurar Microsoft Graph PowerShell

Usando el parámetro **`-Debug`** es posible ver todas las solicitudes que la herramienta está enviando:
```bash
Get-MgUser -Debug
```
### ~~**AzureAD Powershell**~~

El módulo de Azure Active Directory (AD), ahora **obsoleto**, es parte de Azure PowerShell para gestionar recursos de Azure AD. Proporciona cmdlets para tareas como gestionar usuarios, grupos y registros de aplicaciones en Entra ID.

> [!TIP]
> Esto es reemplazado por Microsoft Graph PowerShell

Sigue este enlace para las [**instrucciones de instalación**](https://www.powershellgallery.com/packages/AzureAD).
