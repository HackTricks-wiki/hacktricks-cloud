# Az - 認証されていない列挙と初期エントリー

{{#include ../../../banners/hacktricks-training.md}}

## Azure テナント

### テナント列挙

攻撃者がテナントの**ドメイン**を知っているだけで、より多くの情報を収集するためにクエリできる**公開Azure API**があります。\
APIに直接クエリするか、PowerShellライブラリ[**AADInternals**](https://github.com/Gerenios/AADInternals)**を使用できます。**

| API                                                                  | 情報                                                                                                                                                                                                                                           | AADInternals 関数                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **ログイン情報**、テナントIDを含む                                                                                                                                                                                                            | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | テナントの**すべてのドメイン**                                                                                                                                                                                                                         | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>テナントのログイン情報</strong>、テナント名とドメイン<strong>認証タイプ</strong>を含む。<br><code>NameSpaceType</code>が<strong><code>Managed</code></strong>の場合、<strong>AzureAD</strong>が使用されていることを意味します。</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | **デスクトップSSO情報**を含むログイン情報                                                                                                                                                                                              | `Get-AADIntLoginInformation -UserName <UserName>` |

**AADInternals**ライブラリの**1つのコマンド**でAzureテナントのすべての情報をクエリできます。
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Azure テナント情報の例:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
テナントの名前、ID、および「ブランド」名に関する詳細を観察することが可能です。さらに、デスクトップシングルサインオン（SSO）、別名[**シームレスSSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)のステータスが表示されます。この機能が有効になっている場合、ターゲット組織内の特定のユーザーの存在（列挙）を判断するのが容易になります。

さらに、出力にはターゲットテナントに関連付けられたすべての検証済みドメインの名前と、それぞれのアイデンティティタイプが表示されます。フェデレーテッドドメインの場合、使用中のアイデンティティプロバイダーの完全修飾ドメイン名（FQDN）、通常はADFSサーバーも開示されます。「MX」列は、メールがExchange Onlineにルーティングされるかどうかを指定し、「SPF」列はExchange Onlineがメール送信者としてリストされていることを示します。現在の偵察機能はSPFレコード内の「include」ステートメントを解析しないため、偽陰性が発生する可能性があることに注意が必要です。

### ユーザー列挙

テナント内に**ユーザー名が存在するかどうかを確認する**ことが可能です。これには**ゲストユーザー**も含まれ、そのユーザー名は次の形式です：
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
メールは、ユーザーのメールアドレスで、「@」がアンダースコア「\_」に置き換えられています。

[**AADInternals**](https://github.com/Gerenios/AADInternals)を使用すると、ユーザーが存在するかどうかを簡単に確認できます：
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
申し訳ありませんが、具体的な内容が提供されていないため、翻訳を行うことができません。翻訳が必要なテキストを提供してください。
```
UserName         Exists
--------         ------
user@company.com True
```
1行ごとに1つのメールアドレスを含むテキストファイルを使用することもできます:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
**3つの異なる列挙方法**から選択できます：

| 方法      | 説明                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | これは上記で言及されたGetCredentialType APIを指します。デフォルトの方法です。                                                                                                                           |
| Login     | <p>この方法はユーザーとしてログインしようとします。<br><strong>注意：</strong>クエリはサインインログに記録されます。</p>                                                                                       |
| Autologon | <p>この方法はオートログオンエンドポイントを介してユーザーとしてログインしようとします。<br><strong>クエリはサインインログに記録されません</strong>！そのため、パスワードスプレーやブルートフォース攻撃にも適しています。</p> |

有効なユーザー名を発見した後、次の方法で**ユーザーに関する情報**を取得できます：
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
スクリプト [**o365creeper**](https://github.com/LMGsec/o365creeper) は、**メールが有効かどうか**を確認することもできます。
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**Microsoft Teamsによるユーザー列挙**

もう一つの良い情報源はMicrosoft Teamsです。

Microsoft TeamsのAPIはユーザーを検索することを可能にします。特に「ユーザー検索」エンドポイントの**externalsearchv3**と**searchUsers**は、Teamsに登録されたユーザーアカウントに関する一般的な情報をリクエストするために使用できます。

APIのレスポンスに応じて、存在しないユーザーと有効なTeamsサブスクリプションを持つ既存のユーザーを区別することが可能です。

スクリプト[**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum)は、指定されたユーザー名のセットをTeams APIに対して検証するために使用できます。
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
申し訳ありませんが、翻訳する内容が提供されていません。翻訳したいテキストを提供してください。
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
さらに、次のような既存ユーザーの可用性情報を列挙することが可能です：

- 利用可能
- 不在
- 取り込み中
- 忙しい
- オフライン

**不在通知メッセージ**が設定されている場合、TeamsEnumを使用してメッセージを取得することも可能です。出力ファイルが指定されている場合、不在通知メッセージは自動的にJSONファイルに保存されます：
```
jq . teamsenum-output.json
```
申し訳ありませんが、具体的なテキストが提供されていないため、翻訳を行うことができません。翻訳が必要なテキストを提供してください。
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": ["Audio", "Video"],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Azure Services

**Azureテナント**が使用している**ドメイン**がわかったので、**公開されているAzureサービス**を探す時が来ました。

この目的のために、[**MicroBust**](https://github.com/NetSPI/MicroBurst)のメソッドを使用できます。この関数は、いくつかの**Azureサービスドメイン**でベースドメイン名（およびいくつかの変種）を検索します。
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## オープンストレージ

オープンストレージを発見するには、[**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1)のようなツールを使用できます。このツールは、ファイル**`Microburst/Misc/permitations.txt`**を使用して、オープンストレージアカウントを**見つける**ための非常にシンプルな順列を生成します。
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URLs

_**共有アクセス署名**_ (SAS) URLは、特定のストレージアカウントの一部（完全なコンテナやファイルなど）への**アクセスを提供する**URLであり、リソースに対する特定の権限（読み取り、書き込みなど）を持っています。漏洩した場合、機密情報にアクセスできる可能性があります。これらは次のようになります（これはコンテナにアクセスするためのもので、ファイルへのアクセスを許可する場合は、URLのパスにもそのファイルが含まれます）：

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

[**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/)を使用してデータにアクセスします

## Compromise Credentials

### Phishing

- [**一般的なフィッシング**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology)（資格情報またはOAuthアプリ -[不正同意付与攻撃](az-oauth-apps-phishing.md)-）
- [**デバイスコード認証** フィッシング](az-device-code-authentication-phishing.md)

### Password Spraying / Brute-Force

{{#ref}}
az-password-spraying.md
{{#endref}}

## References

- [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
- [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

{{#include ../../../banners/hacktricks-training.md}}
