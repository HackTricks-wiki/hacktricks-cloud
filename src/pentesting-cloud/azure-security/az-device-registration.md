# Az - Cihaz Kaydı

{{#include ../../banners/hacktricks-training.md}}

## Temel Bilgiler

Bir cihaz AzureAD'ye katıldığında, AzureAD'de yeni bir nesne oluşturulur.

Bir cihaz kaydedilirken, **kullanıcıdan hesabıyla giriş yapması istenir** (gerekirse MFA istenir), ardından cihaz kaydı hizmeti için token'lar talep edilir ve son bir onay istemi gösterilir.

Ardından, cihazda iki RSA anahtar çifti oluşturulur: **cihaz anahtarı** (**açık** anahtar) **AzureAD**'ye gönderilir ve **taşıma** anahtarı (**özel** anahtar) mümkünse TPM'de saklanır.

Sonra, **nesne** **AzureAD**'de (Intune'da değil) oluşturulur ve AzureAD, cihaza imzalı bir **sertifika** geri verir. **Cihazın AzureAD'ye katıldığını** ve **sertifika** hakkında (örneğin, TPM ile korunup korunmadığı) bilgi kontrol edebilirsiniz.
```bash
dsregcmd /status
```
Cihaz kaydından sonra **Primary Refresh Token** LSASS CloudAP modülü tarafından talep edilir ve cihaza verilir. PRT ile birlikte **sadece cihazın şifreyi çözebileceği şekilde şifrelenmiş oturum anahtarı** da teslim edilir (taşıma anahtarının açık anahtarını kullanarak) ve **PRT'yi kullanmak için gereklidir.**

PRT'nin ne olduğu hakkında daha fazla bilgi için kontrol edin:

{{#ref}}
az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md
{{#endref}}

### TPM - Güvenilir Platform Modülü

**TPM**, kapalı bir cihazdan (PIN ile korunuyorsa) anahtar **çıkarma** ve OS katmanından özel materyali çıkarmaya karşı **korur**.\
Ancak, **TPM ile CPU arasındaki fiziksel bağlantıyı dinlemek** veya sistem çalışırken **SYSTEM** haklarına sahip bir süreçten TPM'deki **kriptografik materyali** kullanmaya karşı **korumaz.**

Aşağıdaki sayfayı kontrol ederseniz, **PRT'yi çalmanın** **kullanıcı** gibi erişim sağlamak için kullanılabileceğini göreceksiniz, bu harika çünkü **PRT cihazlarda** bulunur, bu nedenle onlardan çalınabilir (veya çalınmazsa yeni imza anahtarları oluşturmak için kötüye kullanılabilir):

{{#ref}}
az-lateral-movement-cloud-on-prem/pass-the-prt.md
{{#endref}}

## SSO jetonları ile bir cihaz kaydetme

Bir saldırganın, ele geçirilmiş cihazdan Microsoft cihaz kayıt hizmeti için bir jeton talep etmesi ve kaydetmesi mümkün olacaktır:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Hangi, size **gelecekte PRT'ler talep etmek için kullanabileceğiniz bir sertifika verecektir**. Bu nedenle kalıcılığı sağlamakta ve **MFA'yı atlamakta** çünkü yeni cihazı kaydetmek için kullanılan orijinal PRT token'ı **zaten MFA izinleri verilmişti**.

> [!TIP]
> Bu saldırıyı gerçekleştirmek için **yeni cihazlar kaydetme** izinlerine ihtiyacınız olacağını unutmayın. Ayrıca, bir cihaz kaydetmek, cihazın **Intune'a kaydolmasına izin verileceği** anlamına gelmez.

> [!CAUTION]
> Bu saldırı Eylül 2021'de düzeltildi çünkü artık SSO token'ları kullanarak yeni cihazlar kaydedemezsiniz. Ancak, cihazları meşru bir şekilde kaydetmek hala mümkündür (gerekirse kullanıcı adı, şifre ve MFA ile). Kontrol edin: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).

## Bir cihaz biletini geçersiz kılma

**Bir cihaz bileti talep etmek**, cihazın mevcut olanını **geçersiz kılmak** ve akış sırasında **PRT'yi çalmak** mümkündü (bu nedenle TPM'den çalmaya gerek yoktur. Daha fazla bilgi için [**bu konuşmaya bakın**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../images/image (32).png" alt=""><figcaption></figcaption></figure>

> [!CAUTION]
> Ancak, bu düzeltildi.

## WHFB anahtarını geçersiz kılma

[**Orijinal slaytlara buradan bakın**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side_nsec_v1.0.pdf)

Saldırı özeti:

- **SSO** aracılığıyla bir **cihazdan kaydedilmiş WHFB** anahtarını **geçersiz kılmak** mümkündür
- Anahtar, yeni anahtarın **üretimi sırasında** **sniffed** olduğu için TPM korumasını **aşar**
- Bu ayrıca **kalıcılık** sağlar

<figure><img src="../../images/image (34).png" alt=""><figcaption></figcaption></figure>

Kullanıcılar, Azure AD Graph aracılığıyla kendi searchableDeviceKey özelliklerini değiştirebilir, ancak saldırganın kiracıda bir cihaza (anlık olarak kaydedilmiş veya meşru bir cihazdan çalınmış sertifika + anahtar) ve AAD Graph için geçerli bir erişim token'ına sahip olması gerekir.

Sonra, yeni bir anahtar oluşturmak mümkündür:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
ve ardından searchableDeviceKey'in bilgilerini PATCH edin:

<figure><img src="../../images/image (36).png" alt=""><figcaption></figcaption></figure>

**Cihaz kodu phishing** aracılığıyla bir kullanıcıdan erişim token'ı almak ve önceki adımları kötüye kullanarak **erişimini çalmak** mümkündür. Daha fazla bilgi için kontrol edin:

{{#ref}}
az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md
{{#endref}}

<figure><img src="../../images/image (37).png" alt=""><figcaption></figcaption></figure>

## Referanslar

- [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
- [https://www.youtube.com/watch?v=x609c-MUZ_g](https://www.youtube.com/watch?v=x609c-MUZ_g)
- [https://www.youtube.com/watch?v=AFay_58QubY](https://www.youtube.com/watch?v=AFay_58QubY)

{{#include ../../banners/hacktricks-training.md}}
