# Az - 设备注册

{{#include ../../banners/hacktricks-training.md}}

## 基本信息

当设备加入 AzureAD 时，会在 AzureAD 中创建一个新对象。

在注册设备时，**用户需要使用他的账户登录**（如有需要会要求 MFA），然后请求设备注册服务的令牌，最后询问最终确认提示。

然后，在设备中生成两个 RSA 密钥对：**设备密钥**（**公**钥），该密钥发送到 **AzureAD**，以及 **传输**密钥（**私**钥），如果可能的话存储在 TPM 中。

接着，在 **AzureAD** 中生成 **对象**（而不是在 Intune 中），AzureAD 会向设备返回一个由其签名的 **证书**。您可以检查 **设备是否已加入 AzureAD** 以及有关 **证书** 的信息（例如，是否由 TPM 保护）。
```bash
dsregcmd /status
```
在设备注册后，**LSASS CloudAP**模块请求一个**主刷新令牌**并将其提供给设备。与PRT一起交付的还有**会话密钥，只有设备可以解密**（使用传输密钥的公钥），并且**使用PRT是必需的。**

有关PRT的更多信息，请查看：

{{#ref}}
az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md
{{#endref}}

### TPM - 受信任的平台模块

**TPM** **保护**防止从关闭的设备中**提取**密钥（如果由PIN保护）以及从操作系统层提取私有材料。\
但它**不保护**防止**嗅探**TPM与CPU之间的物理连接或**在系统运行时使用TPM中的加密材料**，这可能来自具有**SYSTEM**权限的进程。

如果您查看以下页面，您将看到**窃取PRT**可以像**用户**一样访问，这很好，因为**PRT位于设备上**，因此可以从它们中窃取（或者如果没有被窃取，则被滥用以生成新的签名密钥）：

{{#ref}}
az-lateral-movement-cloud-on-prem/pass-the-prt.md
{{#endref}}

## 使用SSO令牌注册设备

攻击者可以从被攻陷的设备请求Microsoft设备注册服务的令牌并注册它。
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
将为您提供一个**可以用来请求未来PRT的证书**。因此，保持持久性并**绕过MFA**，因为用于注册新设备的原始PRT令牌**已经获得了MFA权限**。

> [!TIP]
> 请注意，要执行此攻击，您需要有**注册新设备**的权限。此外，注册设备并不意味着该设备将被**允许注册到Intune**。

> [!CAUTION]
> 此攻击在2021年9月被修复，因为您无法再使用SSO令牌注册新设备。然而，仍然可以以合法方式注册设备（如果需要，拥有用户名、密码和MFA）。请查看：[**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md)。

## 覆盖设备票证

可以**请求设备票证**，**覆盖**设备的当前票证，并在流程中**窃取PRT**（因此无需从TPM中窃取它。有关更多信息，请[**查看此演讲**](https://youtu.be/BduCn8cLV1A)。

<figure><img src="../../images/image (32).png" alt=""><figcaption></figcaption></figure>

> [!CAUTION]
> 然而，这已被修复。

## 覆盖WHFB密钥

[**在这里查看原始幻灯片**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side_nsec_v1.0.pdf)

攻击摘要：

- 可以通过SSO**覆盖**来自**设备**的**注册WHFB**密钥
- 它**击败TPM保护**，因为密钥在新密钥生成期间被**嗅探**
- 这也提供了**持久性**

<figure><img src="../../images/image (34).png" alt=""><figcaption></figcaption></figure>

用户可以通过Azure AD Graph修改自己的searchableDeviceKey属性，但是，攻击者需要在租户中拥有一个设备（即时注册或从合法设备窃取证书和密钥）以及AAD Graph的有效访问令牌。

然后，可以使用以下方式生成新密钥：
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
然后PATCH可搜索的DeviceKey的信息：

<figure><img src="../../images/image (36).png" alt=""><figcaption></figcaption></figure>

可以通过**设备代码钓鱼**从用户那里获取访问令牌，并利用之前的步骤**窃取他的访问权限**。有关更多信息，请查看：

{{#ref}}
az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md
{{#endref}}

<figure><img src="../../images/image (37).png" alt=""><figcaption></figcaption></figure>

## 参考文献

- [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
- [https://www.youtube.com/watch?v=x609c-MUZ_g](https://www.youtube.com/watch?v=x609c-MUZ_g)
- [https://www.youtube.com/watch?v=AFay_58QubY](https://www.youtube.com/watch?v=AFay_58QubY)

{{#include ../../banners/hacktricks-training.md}}
