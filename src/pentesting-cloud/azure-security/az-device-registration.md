# Az - Реєстрація пристрою

{{#include ../../banners/hacktricks-training.md}}

## Основна інформація

Коли пристрій приєднується до AzureAD, у AzureAD створюється новий об'єкт.

Під час реєстрації пристрою **користувача просять увійти у свій обліковий запис** (за потреби з MFA), далі запитуються токени для служби реєстрації пристроїв і наприкінці з'являється запит на підтвердження.

Потім на пристрої генеруються два RSA ключові пари: **ключ пристрою** (**публічний** ключ), який відправляється в **AzureAD**, та **транспортний ключ** (**приватний** ключ), який зберігається в TPM, якщо це можливо.

Потім в **AzureAD** (не в Intune) створюється **об'єкт**, і AzureAD повертає пристрою **сертифікат**, підписаний ним. Ви можете перевірити, що **пристрій приєднаний до AzureAD** та інформацію про **сертифікат** (наприклад, чи захищений він TPM).:
```bash
dsregcmd /status
```
After the device registration a **Primary Refresh Token** is requested by the LSASS CloudAP module and given to the device. With the PRT is also delivered the **session key encrypted so only the device can decrypt it** (using the public key of the transport key) and it's **needed to use the PRT.**

For more information about what is a PRT check:

{{#ref}}
az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md
{{#endref}}

### TPM — модуль довіреної платформи

The **TPM** **protects** against key **extraction** from a powered down device (if protected by PIN) and from extracting the private material from the OS layer.\
But it **doesn't protect** against **sniffing** the physical connection between the TPM and CPU or **using the cryptographic material** in the TPM while the system is running from a process with **SYSTEM** rights.

If you check the following page you will see that **stealing the PRT** can be used to access like a the **user**, which is great because the **PRT is located devices**, so it can be stolen from them (or if not stolen abused to generate new signing keys):

{{#ref}}
az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md
{{#endref}}

## Registering a device with SSO tokens

It would be possible for an attacker to request a token for the Microsoft device registration service from the compromised device and register it:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Який дасть вам **сертифікат, який ви зможете використати для запиту PRTs у майбутньому**. Отже, це забезпечує персистентність і **обхід MFA**, оскільки оригінальний PRT токен, використаний для реєстрації нового пристрою, **вже мав надані права MFA**.

> [!TIP]
> Зауважте, що для виконання цієї атаки вам знадобляться права на **реєстрацію нових пристроїв**. Також реєстрація пристрою не означає, що пристрій буде **дозволено зареєструватися в Intune**.

> [!CAUTION]
> Цю атаку виправили у вересні 2021 року — тепер ви більше не можете реєструвати нові пристрої, використовуючи SSO токени. Однак все ще можливо легітимно реєструвати пристрої (маючи username, password та MFA, якщо потрібно). Див.: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).

## Перезапис квитка пристрою

Було можливо **запитати device ticket**, **перезаписати** поточний на пристрої, і під час процесу **вкрасти PRT** (тобто немає потреби вкрадати його з TPM). Для детальнішої інформації [**див. цю доповідь**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../images/image (32).png" alt=""><figcaption></figcaption></figure>

> [!CAUTION]
> Однак це було виправлено.

## Перезаписати ключ WHFB

[**Перегляньте оригінальні слайди тут**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side_nsec_v1.0.pdf)

Короткий опис атаки:

- Можливо **перезаписати** зареєстрований ключ **WHFB** з **пристрою** через **SSO**
- Це **обминає захист TPM**, оскільки ключ **перехоплюється під час генерації** нового ключа
- Це також забезпечує **персистентність**

<figure><img src="../../images/image (34).png" alt=""><figcaption></figcaption></figure>

Користувачі можуть змінювати власну властивість searchableDeviceKey через Azure AD Graph, однак атакуючий повинен мати пристрій у tenant (зареєстрований на ходу або маючи вкрадений cert + key з легітимного пристрою) та дійсний access token для AAD Graph.

Тоді можливо згенерувати новий ключ за допомогою:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
а потім PATCH інформації searchableDeviceKey:

<figure><img src="../../images/image (36).png" alt=""><figcaption></figcaption></figure>

Можна отримати access token від користувача через **device code phishing** і скористатися попередніми кроками, щоб **вкрасти його доступ**. Для додаткової інформації дивіться:

{{#ref}}
az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md
{{#endref}}

<figure><img src="../../images/image (37).png" alt=""><figcaption></figcaption></figure>

## Посилання

- [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
- [https://www.youtube.com/watch?v=x609c-MUZ_g](https://www.youtube.com/watch?v=x609c-MUZ_g)
- [https://www.youtube.com/watch?v=AFay_58QubY](https://www.youtube.com/watch?v=AFay_58QubY)

{{#include ../../banners/hacktricks-training.md}}
