# Az - Akaunti za Hifadhi & Blobs

{{#include ../../../banners/hacktricks-training.md}}

## Taarifa za Msingi

Akaunti za Hifadhi za Azure ni huduma za msingi katika Microsoft Azure zinazotoa **hifadhi ya wingu inayoweza kupanuka, salama, na inayopatikana kwa urahisi kwa aina mbalimbali za data**, ikiwa ni pamoja na blobs (vitu vikubwa vya binary), faili, foleni, na meza. Zinatumika kama vyombo vinavyokutanisha huduma hizi tofauti za hifadhi chini ya jina moja kwa usimamizi rahisi.

**Chaguzi kuu za usanidi**:

- Kila akaunti ya hifadhi lazima iwe na **jina la kipekee katika Azure yote**.
- Kila akaunti ya hifadhi inapelekwa katika **eneo** au katika eneo la kupanua la Azure.
- Inawezekana kuchagua toleo la **premium** la akaunti ya hifadhi kwa utendaji bora.
- Inawezekana kuchagua kati ya **aina 4 za upungufu wa hatari ili kulinda** dhidi ya **kuanguka** kwa rack, diski na kituo cha data.

**Chaguzi za usanidi wa Usalama**:

- **Hitaji usafirishaji salama kwa shughuli za REST API**: Hitaji TLS katika mawasiliano yoyote na hifadhi.
- **Inaruhusu kuwezesha ufikiaji wa siri kwenye vyombo vya kibinafsi**: Ikiwa sivyo, haitakuwa na uwezo wa kuwezesha ufikiaji wa siri katika siku zijazo.
- **Weka ufikiaji wa funguo za akaunti ya hifadhi**: Ikiwa sivyo, ufikiaji kwa Funguo za Kushiriki utafungiwa.
- **Tofauti ya chini ya TLS**.
- **Muktadha unaoruhusiwa kwa shughuli za nakala**: Ruhusu kutoka akaunti yoyote ya hifadhi, kutoka akaunti yoyote ya hifadhi kutoka kwa mpangilio mmoja wa Entra au kutoka akaunti ya hifadhi yenye viunganishi vya kibinafsi katika mtandao mmoja wa virtual.

**Chaguzi za Hifadhi ya Blob**:

- **Ruhusu upatanishi wa kuvuka mpangilio**.
- **Kiwango cha ufikiaji**: Moto (data inayofikiwa mara kwa mara), Baridi na Baridi (data inayofikiwa mara chache).

**Chaguzi za Mtandao**:

- **Ufikiaji wa Mtandao**:
- Ruhusu kutoka mitandao yote.
- Ruhusu kutoka mitandao maalum ya virtual na anwani za IP.
- Zima ufikiaji wa umma na tumia ufikiaji wa kibinafsi.
- **Viunganishi vya Kibinafsi**: Inaruhusu muunganisho wa kibinafsi kwa akaunti ya hifadhi kutoka mtandao wa virtual.

**Chaguzi za Ulinzi wa Data**:

- **Kurejesha kwa wakati kwa vyombo**: Inaruhusu kurejesha vyombo katika hali ya awali.
- Inahitaji toleo, mabadiliko ya chakula, na kufutwa kwa blob kwa urahisi kuwezeshwe.
- **Weka kufutwa kwa urahisi kwa blobs**: Inaruhusu kipindi cha uhifadhi kwa siku kwa blobs zilizofutwa (hata zilizofutwa).
- **Weka kufutwa kwa urahisi kwa vyombo**: Inaruhusu kipindi cha uhifadhi kwa siku kwa vyombo vilivyofutwa.
- **Weka kufutwa kwa urahisi kwa sehemu za faili**: Inaruhusu kipindi cha uhifadhi kwa siku kwa sehemu za faili zilizofutwa.
- **Weka toleo kwa blobs**: Hifadhi toleo za awali za blobs zako.
- **Weka chakula cha mabadiliko ya blob**: Hifadhi kumbukumbu za kuunda, kubadilisha, na kufuta mabadiliko kwa blobs.
- **Weka msaada wa kutokuweza kubadilika kwa kiwango cha toleo**: Inaruhusu kuweka sera ya uhifadhi kulingana na muda kwenye kiwango cha akaunti ambayo itatumika kwa toleo zote za blob.
- Msaada wa kutokuweza kubadilika kwa kiwango cha toleo na kurejesha kwa wakati kwa vyombo haiwezi kuwezeshwa kwa wakati mmoja.

**Chaguzi za Usimbaji**:

- **Aina ya Usimbaji**: Inawezekana kutumia funguo zinazodhibitiwa na Microsoft (MMK) au funguo zinazodhibitiwa na Mteja (CMK).
- **Weka usimbaji wa miundombinu**: Inaruhusu kusimbwa mara mbili kwa data "kwa usalama zaidi".

### Viunganishi vya Hifadhi

<table data-header-hidden><thead><tr><th width="197">Huduma ya Hifadhi</th><th>Kiunganishi</th></tr></thead><tbody><tr><td><strong>Hifadhi ya Blob</strong></td><td><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></td></tr><tr><td><strong>Hifadhi ya Ziwa la Data</strong></td><td><code>https://&#x3C;storage-account>.dfs.core.windows.net</code></td></tr><tr><td><strong>Faili za Azure</strong></td><td><code>https://&#x3C;storage-account>.file.core.windows.net</code></td></tr><tr><td><strong>Hifadhi ya Foleni</strong></td><td><code>https://&#x3C;storage-account>.queue.core.windows.net</code></td></tr><tr><td><strong>Hifadhi ya Meza</strong></td><td><code>https://&#x3C;storage-account>.table.core.windows.net</code></td></tr></tbody></table>

### Ufunuo wa Umma

Ikiwa "Ruhusu ufikiaji wa umma wa Blob" umewezesha (imezimwa kwa default), unapounda chombo inawezekana:

- Kutoa **ufikiaji wa umma kusoma blobs** (unahitaji kujua jina).
- **Orodhesha blobs za chombo** na **uzisome**.
- Kufanya iwe **binafsi kabisa**.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfoetUnYBPWQpRrWNnnlbqWpl8Rdoaeg5uBrCVlvcNDlnKwQHjZe8nUb2SfPspBgbu-lCZLmUei-hFi_Jl2eKbaxUtBGTjdUSDmkrcwr90VZkmuMjk9tyh92p75btfyzGiUTa0-=s2048?key=m8TV59TrCFPlkiNnmhYx3aZt" alt=""><figcaption></figcaption></figure>

### Unganisha na Hifadhi

Ikiwa unapata **hifadhi** yoyote unayoweza kuunganishwa nayo unaweza kutumia zana [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) kufanya hivyo.

## Ufikiaji wa Hifadhi <a href="#about-blob-storage" id="about-blob-storage"></a>

### RBAC

Inawezekana kutumia wahusika wa Entra ID na **majukumu ya RBAC** kufikia akaunti za hifadhi na ni njia inayopendekezwa.

### Funguo za Ufikiaji

Akaunti za hifadhi zina funguo za ufikiaji ambazo zinaweza kutumika kuziunganisha. Hii inatoa **ufikiaji kamili kwa akaunti ya hifadhi.**

<figure><img src="../../../images/image (5).png" alt=""><figcaption></figcaption></figure>

### **Funguo za Kushiriki & Funguo za Kushiriki za Lite**

Inawezekana [**kuunda Funguo za Kushiriki**](https://learn.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key) zilizotiwa saini na funguo za ufikiaji ili kuidhinisha ufikiaji wa rasilimali fulani kupitia URL iliyotiwa saini.

> [!NOTE]
> Kumbuka kwamba sehemu ya `CanonicalizedResource` inawakilisha rasilimali ya huduma za hifadhi (URI). Na ikiwa sehemu yoyote katika URL imeandikwa, inapaswa pia kuandikwa ndani ya `CanonicalizedResource`.

> [!NOTE]
> Hii **inatumiwa kwa default na `az` cli** kuthibitisha maombi. Ili kufanya itumie akidi za wahusika wa Entra ID onyesha paramu `--auth-mode login`.

- Inawezekana kuunda **funguo za kushiriki kwa huduma za blob, foleni na faili** kwa kusaini taarifa zifuatazo:
```bash
StringToSign = VERB + "\n" +
Content-Encoding + "\n" +
Content-Language + "\n" +
Content-Length + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
If-Modified-Since + "\n" +
If-Match + "\n" +
If-None-Match + "\n" +
If-Unmodified-Since + "\n" +
Range + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
- Inawezekana kuunda **funguo iliyopewa kwa huduma za meza** kwa kusaini taarifa zifuatazo:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedResource;
```
- Inawezekana kuunda **lite shared key kwa huduma za blob, queue na file** kwa kusaini taarifa zifuatazo:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
- Inawezekana kuunda **lite shared key for table services** kwa kusaini taarifa zifuatazo:
```bash
StringToSign = Date + "\n"
CanonicalizedResource
```
Kisha, ili kutumia funguo, inaweza kufanywa katika kichwa cha Uidhinishaji ikifuatia muundo:
```bash
Authorization="[SharedKey|SharedKeyLite] <AccountName>:<Signature>"
#e.g.
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=

PUT http://myaccount/mycontainer?restype=container&timeout=30 HTTP/1.1
x-ms-version: 2014-02-14
x-ms-date: Fri, 26 Jun 2015 23:39:12 GMT
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=
Content-Length: 0
```
### **Shared Access Signature** (SAS)

Shared Access Signatures (SAS) ni URL salama, zenye muda wa kikomo ambazo **zinatoa ruhusa maalum za kufikia rasilimali** katika akaunti ya Azure Storage bila kufichua funguo za ufikiaji za akaunti. Wakati funguo za ufikiaji zinatoa ufikiaji wa kiutawala kwa rasilimali zote, SAS inaruhusu udhibiti wa kina kwa kubainisha ruhusa (kama kusoma au kuandika) na kufafanua muda wa kumalizika.

#### Aina za SAS

- **User delegation SAS**: Hii inaundwa kutoka kwa **Entra ID principal** ambayo itatia saini SAS na kuhamasisha ruhusa kutoka kwa mtumiaji hadi SAS. Inaweza kutumika tu na **blob na data lake storage** ([docs](https://learn.microsoft.com/en-us/rest/api/storageservices/create-user-delegation-sas)). Inawezekana **kufuta** SAS zote zilizozalishwa za mtumiaji.
- Hata kama inawezekana kuunda SAS ya uwakilishi yenye ruhusa "zaidi" kuliko zile ambazo mtumiaji ana. Hata hivyo, ikiwa principal hana hizo, haitafanya kazi (hakuna privesc).
- **Service SAS**: Hii inatiwa saini kwa kutumia moja ya **funguo za ufikiaji** za akaunti ya uhifadhi. Inaweza kutumika kutoa ufikiaji kwa rasilimali maalum katika huduma moja ya uhifadhi. Ikiwa funguo itarejelewa, SAS itakoma kufanya kazi.
- **Account SAS**: Pia inatiwa saini kwa moja ya **funguo za ufikiaji** za akaunti ya uhifadhi. Inatoa ufikiaji kwa rasilimali katika huduma za akaunti ya uhifadhi (Blob, Queue, Table, File) na inaweza kujumuisha operesheni za kiwango cha huduma.

URL ya SAS iliyotiwa saini na **funguo za ufikiaji** inaonekana kama hii:

- `https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

URL ya SAS iliyotiwa saini kama **user delegation** inaonekana kama hii:

- `https://<container_name>.blob.core.windows.net/testing-container?sp=r&st=2024-11-22T15:07:40Z&se=2024-11-22T23:07:40Z&skoid=d77c71a1-96e7-483d-bd51-bd753aa66e62&sktid=fdd066e1-ee37-49bc-b08f-d0e152119b04&skt=2024-11-22T15:07:40Z&ske=2024-11-22T23:07:40Z&sks=b&skv=2022-11-02&spr=https&sv=2022-11-02&sr=c&sig=7s5dJyeE6klUNRulUj9TNL0tMj2K7mtxyRc97xbYDqs%3D`

Kumbuka baadhi ya **http params**:

- **`se`** param inaonyesha **tarehe ya kumalizika** ya SAS
- **`sp`** param inaonyesha **ruhusa** za SAS
- **`sig`** ni **saini** inayothibitisha SAS

#### Ruhusa za SAS

Wakati wa kuunda SAS inahitajika kubainisha ruhusa ambazo inapaswa kutoa. Kulingana na kitu ambacho SAS inaundwa juu yake, ruhusa tofauti zinaweza kujumuishwa. Kwa mfano:

- (a)dd, (c)reate, (d)elete, (e)xecute, (f)ilter_by_tags, (i)set_immutability_policy, (l)ist, (m)ove, (r)ead, (t)ag, (w)rite, (x)delete_previous_version, (y)permanent_delete

## SFTP Support for Azure Blob Storage

Azure Blob Storage sasa inasaidia Protokali ya Uhamishaji Faili ya SSH (SFTP), ikiruhusu uhamishaji wa faili salama na usimamizi moja kwa moja kwa Blob Storage bila kuhitaji suluhisho maalum au bidhaa za upande wa tatu.

### Vipengele Muhimu

- Msaada wa Protokali: SFTP inafanya kazi na akaunti za Blob Storage zilizowekwa na namespace ya kihierarkia (HNS). Hii inaratibu blobs katika saraka na saraka ndogo kwa urahisi wa kuvinjari.
- Usalama: SFTP inatumia vitambulisho vya watumiaji wa ndani kwa uthibitisho na haijumuishi na RBAC au ABAC. Kila mtumiaji wa ndani anaweza kuthibitisha kupitia:
- Nywila zinazozalishwa na Azure
- Mifumo ya funguo za SSH za umma na binafsi
- Ruhusa za Kina: Ruhusa kama Kusoma, Kuandika, Kufuta, na Kuorodhesha zinaweza kutolewa kwa watumiaji wa ndani kwa hadi kontena 100.
- Mambo ya Mtandao: Munganisho wa SFTP unafanywa kupitia bandari 22. Azure inasaidia usanidi wa mtandao kama vile moto, maeneo ya kibinafsi, au mitandao ya virtual ili kulinda trafiki ya SFTP.

### Mahitaji ya Usanidi

- Namespace ya Kihierarkia: HNS lazima iwe imewezeshwa wakati wa kuunda akaunti ya uhifadhi.
- Ulinzi wa Kusaidia: Inahitaji algorithimu za cryptographic zilizothibitishwa na Microsoft Security Development Lifecycle (SDL) (mfano, rsa-sha2-256, ecdsa-sha2-nistp256).
- Usanidi wa SFTP:
- Wezesha SFTP kwenye akaunti ya uhifadhi.
- Unda vitambulisho vya watumiaji wa ndani na ruhusa zinazofaa.
- Sanidi saraka za nyumbani kwa watumiaji ili kufafanua eneo lao la kuanzia ndani ya kontena.

### Ruhusa

| Ruhusa                | Alama  | Maelezo                             |
| --------------------- | ------ | ------------------------------------ |
| **Kusoma**            | `r`    | Soma maudhui ya faili.              |
| **Kuandika**         | `w`    | Pakia faili na uunde saraka.        |
| **Kuorodhesha**      | `l`    | Orodhesha maudhui ya saraka.        |
| **Kufuta**           | `d`    | Futa faili au saraka.               |
| **Kuunda**           | `c`    | Unda faili au saraka.               |
| **Badilisha Umiliki**| `o`    | Badilisha mtumiaji au kundi linalomiliki. |
| **Badilisha Ruhusa** | `p`    | Badilisha ACLs kwenye faili au saraka. |

## Enumeration

{{#tabs }}
{{#tab name="az cli" }}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# BLOB STORAGE
## List containers
az storage container list --account-name <name>
## Check if public access is allowed
az storage container show-permission \
--account-name <acc-name> \
-n <container-name>
## Make a container public
az storage container set-permission \
--public-access container \
--account-name <acc-name> \
-n <container-name>
## List blobs in a container
az storage blob list \
--container-name <container name> \
--account-name <account name>
## Download blob
az storage blob download \
--account-name <account name> \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Create container policy
az storage container policy create \
--account-name mystorageaccount \
--container-name mycontainer \
--name fullaccesspolicy \
--permissions racwdl \
--start 2023-11-22T00:00Z \
--expiry 2024-11-22T00:00Z

# QUEUE
az storage queue list --account-name <name>
az storage message peek --account-name <name> --queue-name <queue-name>

# ACCESS KEYS
az storage account keys list --account-name <name>
## Check key policies (expiration time?)
az storage account show -n <name> --query "{KeyPolicy:keyPolicy}"
## Once having the key, it's possible to use it with the argument --account-key
## Enum blobs with account key
az storage blob list \
--container-name <container name> \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw=="
## Download a file using an account key
az storage blob download \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Upload a file using an account key
az storage blob upload \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--file </path/to/local/file>

# SAS
## List access policies
az storage <container|queue|share|table> policy list \
--account-name <acc name> \
--container-name <container name>

## Generate SAS with all permissions using an access key
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
-n <container-name>

## Generate SAS with all permissions using via user delegation
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
--as-user --auth-mode login \
-n <container-name>

## Generate account SAS
az storage account generate-sas \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name>  \
--services qt \
--resource-types sco \
--permissions acdfilrtuwxy

## Use the returned SAS key with the param --sas-token
## e.g.
az storage blob show \
--account-name <account name> \
--container-name <container name> \
--sas-token 'se=2024-12-31T23%3A59%3A00Z&sp=racwdxyltfmei&sv=2022-11-02&sr=c&sig=ym%2Bu%2BQp5qqrPotIK5/rrm7EMMxZRwF/hMWLfK1VWy6E%3D' \
--name 'asd.txt'

#Local-Users
## List users
az storage account local-user list \
--account-name <storage-account-name> \
--resource-group <resource-group-name>
## Get user
az storage account local-user show \
--account-name <storage-account-name> \
--resource-group <resource-group-name> \
--name <local-user-name>

## List keys
az storage account local-user list \
--account-name <storage-account-name> \
--resource-group <resource-group-name>
```
{{#endtab }}

{{#tab name="Az PowerShell" }}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt

# Create a Container Policy
New-AzStorageContainerStoredAccessPolicy `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context `
-Container <container-name> `
-Policy <policy-name> `
-Permission racwdl `
-StartTime (Get-Date "2023-11-22T00:00Z") `
-ExpiryTime (Get-Date "2024-11-22T00:00Z")
#Get Container policy
Get-AzStorageContainerStoredAccessPolicy `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context `
-Container "storageaccount1994container"

# Queue Management
Get-AzStorageQueue -Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context
(Get-AzStorageQueue -Name <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).Context).QueueClient.PeekMessage().Value

#Blob Container
Get-AzStorageBlob -Container <container-name> -Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context
Get-AzStorageBlobContent `
-Container <container-name> `
-Blob <blob-name> `
-Destination <local-path> `
-Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context

Set-AzStorageBlobContent `
-Container <container-name> `
-File <local-file-path> `
-Blob <blob-name> `
-Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context

# Shared Access Signatures (SAS)
Get-AzStorageContainerAcl `
-Container <container-name> `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context

New-AzStorageBlobSASToken `
-Context $ctx `
-Container <container-name> `
-Blob <blob-name> `
-Permission racwdl `
-ExpiryTime (Get-Date "2024-12-31T23:59:00Z")
```
{{#endtab }}
{{#endtabs }}

### File Shares

{{#ref}}
az-file-shares.md
{{#endref}}

## Privilege Escalation

{{#ref}}
../az-privilege-escalation/az-storage-privesc.md
{{#endref}}

## Post Exploitation

{{#ref}}
../az-post-exploitation/az-blob-storage-post-exploitation.md
{{#endref}}

## Persistence

{{#ref}}
../az-persistence/az-storage-persistence.md
{{#endref}}

## References

- [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
- [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)
- [https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support](https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support)

{{#include ../../../banners/hacktricks-training.md}}
