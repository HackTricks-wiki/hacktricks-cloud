# Az - Storage Accounts & Blobs

{{#include ../../../banners/hacktricks-training.md}}

## Basic Information

Azure Storage Accounts są podstawową usługą w Microsoft Azure, która zapewnia skalowalną, bezpieczną i wysoce dostępną chmurową **przestrzeń storage dla różnych typów danych**, w tym bloby (duże obiekty binarne), pliki, kolejki i tabele. Służą jako kontenery grupujące te różne usługi storage pod jedną przestrzenią nazw, co ułatwia zarządzanie.

**Główne opcje konfiguracji**:

- Każde konto storage musi mieć **unikalną nazwę w całym Azure**.
- Każde konto storage jest wdrażane w **regionie** lub w rozszerzonej strefie Azure.
- Można wybrać wersję **premium** konta storage dla lepszej wydajności.
- Można wybrać spośród **4 typów redundancji** chroniących przed awariami rack, dysku i centrum danych.

**Opcje konfiguracji zabezpieczeń**:

- **Require secure transfer for REST API operations**: Wymaga TLS w każdej komunikacji ze storage.
- **Allows enabling anonymous access on individual containers**: Jeśli nie, nie będzie można w przyszłości włączyć dostępu anonimowego.
- **Enable storage account key access**: Jeśli nie, dostęp przy użyciu Shared Keys będzie zabroniony.
- **Minimum TLS version**
- **Permitted scope for copy operations**: Zezwól z dowolnego konta storage, z dowolnego konta storage z tego samego Entra tenant lub z konta storage z private endpoints w tej samej virtual network.

**Opcje Blob Storage**:

- **Allow cross-tenant replication**
- **Access tier**: Hot (dane często dostępne), Cool i Cold (dane rzadko dostępne)

**Opcje sieciowe**:

- **Network access**:
- Zezwalaj ze wszystkich sieci
- Zezwalaj z wybranych virtual networks i adresów IP
- Wyłącz dostęp publiczny i użyj dostępu prywatnego
- **Private endpoints**: Pozwala na prywatne połączenie do konta storage z virtual network

**Opcje ochrony danych**:

- **Point-in-time restore for containers**: Pozwala odtworzyć kontenery do wcześniejszego stanu
- Wymaga włączenia versioning, change feed oraz blob soft delete.
- **Enable soft delete for blobs**: Włącza okres przechowywania (w dniach) dla usuniętych blobów (nawet nadpisanych)
- **Enable soft delete for containers**: Włącza okres przechowywania (w dniach) dla usuniętych kontenerów
- **Enable soft delete for file shares**: Włącza okres przechowywania (w dniach) dla usuniętych udostępnień plików
- **Enable versioning for blobs**: Przechowuje poprzednie wersje blobów
- **Enable blob change feed**: Zachowuje logi tworzenia, modyfikacji i usuwania blobów
- **Enable version-level immutability support**: Pozwala ustawić politykę retencji opartą na czasie na poziomie konta, która będzie miała zastosowanie do wszystkich wersji blobów.
- Version-level immutability support i point-in-time restore for containers nie mogą być włączone jednocześnie.

**Opcje szyfrowania**:

- **Encryption type**: Można użyć Microsoft-managed keys (MMK) lub Customer-managed keys (CMK)
- **Enable infrastructure encryption**: Pozwala podwójnie zaszyfrować dane „dla większego bezpieczeństwa”

### Storage endpoints

<table data-header-hidden><thead><tr><th width="197">Storage Service</th><th>Endpoint</th></tr></thead><tbody><tr><td><strong>Blob storage</strong></td><td><code>https://<storage-account>.blob.core.windows.net</code><br><br><code>https://<stg-acc>.blob.core.windows.net/<container-name>?restype=container&comp=list</code></td></tr><tr><td><strong>Data Lake Storage</strong></td><td><code>https://<storage-account>.dfs.core.windows.net</code></td></tr><tr><td><strong>Azure Files</strong></td><td><code>https://<storage-account>.file.core.windows.net</code></td></tr><tr><td><strong>Queue storage</strong></td><td><code>https://<storage-account>.queue.core.windows.net</code></td></tr><tr><td><strong>Table storage</strong></td><td><code>https://<storage-account>.table.core.windows.net</code></td></tr></tbody></table>

### Public Exposure

Jeśli "Allow Blob public access" jest **włączone** (domyślnie wyłączone), podczas tworzenia kontenera można:

- Nadać **publiczny dostęp do odczytu blobów** (trzeba znać nazwę).
- **Wylistować bloby kontenera** i **odczytać** je.
- Uczynić go całkowicie **private**

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfoetUnYBPWQpRrWNnnlbqWpl8Rdoaeg5uBrCVlvcNDlnKwQHjZe8nUb2SfPspBgbu-lCZLmUei-hFi_Jl2eKbaxUtBGTjdUSDmkrcwr90VZkmuMjk9tyh92p75btfyzGiUTa0-=s2048?key=m8TV59TrCFPlkiNnmhYx3aZt" alt=""><figcaption></figcaption></figure>

#### Auditing anonymous blob exposure

- **Locate storage accounts** that can expose data: `az storage account list | jq -r '.[] | select(.properties.allowBlobPublicAccess==true) | .name'`. If `allowBlobPublicAccess` is `false` you cannot turn containers public.
- **Inspect risky accounts** to confirm the flag and other weak settings: `az storage account show --name <acc> --query '{allow:properties.allowBlobPublicAccess, minTls:properties.minimumTlsVersion}'`.
- **Enumerate container-level exposure** where the flag is enabled:
```bash
az storage container list --account-name <acc> \
--query '[].{name:name, access:properties.publicAccess}'
```
- `"Blob"`: anonimowy odczyt dozwolony **tylko gdy nazwa blobu jest znana** (brak możliwości listowania).
- `"Container"`: anonimowe **listowanie + odczyt** każdego bloba.
- `null`: prywatne; wymagane uwierzytelnienie.
- **Udowodnij dostęp** bez poświadczeń:
- Jeśli `publicAccess` jest `Container`, anonimowe listowanie działa: `curl "https://<acc>.blob.core.windows.net/<container>?restype=container&comp=list"`.
- Dla obu `Blob` i `Container`, anonimowe pobieranie bloba działa, gdy nazwa jest znana:
```bash
az storage blob download -c <container> -n <blob> --account-name <acc> --file /dev/stdout
# or via raw HTTP
curl "https://<acc>.blob.core.windows.net/<container>/<blob>"
```
### Połącz się z magazynem

Jeśli znajdziesz jakikolwiek **magazyn**, z którym możesz się połączyć, możesz użyć narzędzia [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) do tego.

## Dostęp do magazynu <a href="#about-blob-storage" id="about-blob-storage"></a>

### RBAC

Można użyć principali Entra ID z **rolami RBAC** do uzyskania dostępu do kont storage i jest to zalecany sposób.

### Klucze dostępu

Konta storage mają klucze dostępu, które można wykorzystać do uzyskania dostępu. To zapewnia **pełny dostęp do konta storage.**

<figure><img src="../../../images/image (5).png" alt=""><figcaption></figcaption></figure>

### **Shared Keys & Lite Shared Keys**

Możliwe jest [**generate Shared Keys**](https://learn.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key) podpisanych kluczami dostępu, aby autoryzować dostęp do niektórych zasobów za pomocą podpisanego URL.

> [!NOTE]
> Zwróć uwagę, że część `CanonicalizedResource` reprezentuje zasób usług magazynowania (URI). Jeśli jakakolwiek część w URL jest zakodowana, powinna być również zakodowana wewnątrz `CanonicalizedResource`.

> [!NOTE]
> To jest **używane domyślnie przez `az` cli** do uwierzytelniania żądań. Aby wymusić użycie poświadczeń principala Entra ID, podaj parametr `--auth-mode login`.

- Możliwe jest wygenerowanie **shared key dla usług blob, queue i file** podpisując następujące informacje:
```bash
StringToSign = VERB + "\n" +
Content-Encoding + "\n" +
Content-Language + "\n" +
Content-Length + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
If-Modified-Since + "\n" +
If-Match + "\n" +
If-None-Match + "\n" +
If-Unmodified-Since + "\n" +
Range + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
- Można wygenerować **shared key for table services** podpisując następujące informacje:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedResource;
```
- Możliwe jest wygenerowanie **lite shared key for blob, queue and file services** podpisując następujące informacje:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
- Możliwe jest wygenerowanie **lite shared key for table services** podpisując następujące informacje:
```bash
StringToSign = Date + "\n"
CanonicalizedResource
```
Aby użyć klucza, można to zrobić w nagłówku Authorization, stosując następującą składnię:
```bash
Authorization="[SharedKey|SharedKeyLite] <AccountName>:<Signature>"
#e.g.
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=

PUT http://myaccount/mycontainer?restype=container&timeout=30 HTTP/1.1
x-ms-version: 2014-02-14
x-ms-date: Fri, 26 Jun 2015 23:39:12 GMT
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=
Content-Length: 0
```
### **Shared Access Signature** (SAS)

Shared Access Signatures (SAS) to bezpieczne, ograniczone czasowo URL-e, które **przyznają konkretne uprawnienia do zasobów** w koncie Azure Storage bez ujawniania kluczy dostępowych konta. Podczas gdy klucze dostępu dają pełny dostęp administracyjny do wszystkich zasobów, SAS umożliwia granulowaną kontrolę przez określenie uprawnień (np. read czy write) oraz czasu wygaśnięcia.

#### SAS Types

- **User delegation SAS**: Tworzony jest z użyciem **Entra ID principal**, który podpisze SAS i przekaże uprawnienia od użytkownika do SAS. Można go używać tylko z **blob and data lake storage** ([docs](https://learn.microsoft.com/en-us/rest/api/storageservices/create-user-delegation-sas)). Możliwe jest **unieważnienie** wszystkich wygenerowanych user delegated SAS.
- Nawet jeśli można wygenerować delegation SAS z „większymi” uprawnieniami niż te, które ma użytkownik, to jeśli principal ich nie posiada, to nie zadziała (no privesc).
- **Service SAS**: Podpisywany jest przy użyciu jednego z **access keys** konta storage. Może być użyty do przyznania dostępu do konkretnych zasobów w pojedynczej usłudze storage. Jeśli klucz zostanie odnowiony, SAS przestanie działać.
- **Account SAS**: Również podpisywany za pomocą jednego z **access keys** konta storage. Przyznaje dostęp do zasobów w ramach usług konta storage (Blob, Queue, Table, File) i może obejmować operacje na poziomie usług.

A SAS URL podpisany przez **access key** wygląda tak:

- `https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

A SAS URL podpisany jako **user delegation** wygląda tak:

- `https://<container_name>.blob.core.windows.net/testing-container?sp=r&st=2024-11-22T15:07:40Z&se=2024-11-22T23:07:40Z&skoid=d77c71a1-96e7-483d-bd51-bd753aa66e62&sktid=fdd066e1-ee37-49bc-b08f-d0e152119b04&skt=2024-11-22T15:07:40Z&ske=2024-11-22T23:07:40Z&sks=b&skv=2022-11-02&spr=https&sv=2022-11-02&sr=c&sig=7s5dJyeE6klUNRulUj9TNL0tMj2K7mtxyRc97xbYDqs%3D`

Zwróć uwagę na niektóre **parametry http**:

- Parametr **`se`** wskazuje **datę wygaśnięcia** SAS
- Parametr **`sp`** wskazuje **uprawnienia** SAS
- **`sig`** to **podpis** weryfikujący SAS

#### SAS permissions

Przy generowaniu SAS trzeba określić uprawnienia, które ma przyznawać. W zależności od obiektu, dla którego SAS jest generowany, mogą być uwzględnione różne uprawnienia. Na przykład:

- (a)dd, (c)reate, (d)elete, (e)xecute, (f)ilter_by_tags, (i)set_immutability_policy, (l)ist, (m)ove, (r)ead, (t)ag, (w)rite, (x)delete_previous_version, (y)permanent_delete

## SFTP Support for Azure Blob Storage

Azure Blob Storage teraz wspiera SSH File Transfer Protocol (SFTP), umożliwiając bezpieczny transfer plików i zarządzanie bez konieczności używania niestandardowych rozwiązań czy produktów third-party.

### Key Features

- Protocol Support: SFTP działa z kontami Blob Storage skonfigurowanymi z hierarchical namespace (HNS). Organizuje to bloby w katalogi i podkatalogi, ułatwiając nawigację.
- Security: SFTP używa lokalnych tożsamości użytkowników do uwierzytelniania i nie integruje się z RBAC ani ABAC. Każdy lokalny użytkownik może uwierzytelniać się przez:
- Azure-generated passwords
- Public-private SSH key pairs
- Granular Permissions: Uprawnienia takie jak Read, Write, Delete i List można przypisać lokalnym użytkownikom dla maksymalnie 100 kontenerów.
- Networking Considerations: Połączenia SFTP odbywają się przez port 22. Azure wspiera konfiguracje sieciowe takie jak firewalle, private endpoints czy virtual networks w celu zabezpieczenia ruchu SFTP.

### Setup Requirements

- Hierarchical Namespace: HNS musi być włączony podczas tworzenia storage account.
- Supported Encryption: Wymagane są algorytmy kryptograficzne zatwierdzone przez Microsoft Security Development Lifecycle (SDL) (np. rsa-sha2-256, ecdsa-sha2-nistp256).
- SFTP Configuration:
- Włącz SFTP na storage account.
- Utwórz lokalne tożsamości użytkowników z odpowiednimi uprawnieniami.
- Skonfiguruj home directories dla użytkowników, aby określić ich lokalizację startową w ramach kontenera.

### Permissions

| Permission             | Symbol | Description                          |
| ---------------------- | ------ | ------------------------------------ |
| **Read**               | `r`    | Odczyt zawartości pliku.             |
| **Write**              | `w`    | Wysyłanie plików i tworzenie katalogów. |
| **List**               | `l`    | Wyświetlanie zawartości katalogów.   |
| **Delete**             | `d`    | Usuwanie plików lub katalogów.       |
| **Create**             | `c`    | Tworzenie plików lub katalogów.      |
| **Modify Ownership**   | `o`    | Zmiana właściciela użytkownika lub grupy. |
| **Modify Permissions** | `p`    | Zmiana ACL na plikach lub katalogach. |

## Enumeration

{{#tabs }}
{{#tab name="az cli" }}

<details>
<summary>enumeracja az cli</summary>
```bash
# Get storage accounts
az storage account list #Get the account name from here

# BLOB STORAGE
## List containers
az storage container list --account-name <name>
## Check if public access is allowed
az storage container show-permission \
--account-name <acc-name> \
-n <container-name>
## Make a container public
az storage container set-permission \
--public-access container \
--account-name <acc-name> \
-n <container-name>
## List blobs in a container
az storage blob list \
--container-name <container name> \
--account-name <account name>
## Download blob
az storage blob download \
--account-name <account name> \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Create container policy
az storage container policy create \
--account-name mystorageaccount \
--container-name mycontainer \
--name fullaccesspolicy \
--permissions racwdl \
--start 2023-11-22T00:00Z \
--expiry 2024-11-22T00:00Z

# QUEUE
az storage queue list --account-name <name>
az storage message peek --account-name <name> --queue-name <queue-name>

# ACCESS KEYS
az storage account keys list --account-name <name>
## Check key policies (expiration time?)
az storage account show -n <name> --query "{KeyPolicy:keyPolicy}"
## Once having the key, it's possible to use it with the argument --account-key
## Enum blobs with account key
az storage blob list \
--container-name <container name> \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw=="
## Download a file using an account key
az storage blob download \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Upload a file using an account key
az storage blob upload \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--file </path/to/local/file>

# SAS
## List access policies
az storage <container|queue|share|table> policy list \
--account-name <acc name> \
--container-name <container name>

## Generate SAS with all permissions using an access key
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
-n <container-name>

## Generate SAS with all permissions using via user delegation
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
--as-user --auth-mode login \
-n <container-name>

## Generate account SAS
az storage account generate-sas \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name>  \
--services qt \
--resource-types sco \
--permissions acdfilrtuwxy

## Use the returned SAS key with the param --sas-token
## e.g.
az storage blob show \
--account-name <account name> \
--container-name <container name> \
--sas-token 'se=2024-12-31T23%3A59%3A00Z&sp=racwdxyltfmei&sv=2022-11-02&sr=c&sig=ym%2Bu%2BQp5qqrPotIK5/rrm7EMMxZRwF/hMWLfK1VWy6E%3D' \
--name 'asd.txt'

#Local-Users
## List users
az storage account local-user list \
--account-name <storage-account-name> \
--resource-group <resource-group-name>
## Get user
az storage account local-user show \
--account-name <storage-account-name> \
--resource-group <resource-group-name> \
--name <local-user-name>

## List keys
az storage account local-user list \
--account-name <storage-account-name> \
--resource-group <resource-group-name>
```
</details>

{{#endtab }}

{{#tab name="Az PowerShell" }}

<details>
<summary>Enumeracja Az PowerShell</summary>
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt

# Create a Container Policy
New-AzStorageContainerStoredAccessPolicy `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context `
-Container <container-name> `
-Policy <policy-name> `
-Permission racwdl `
-StartTime (Get-Date "2023-11-22T00:00Z") `
-ExpiryTime (Get-Date "2024-11-22T00:00Z")
#Get Container policy
Get-AzStorageContainerStoredAccessPolicy `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context `
-Container "storageaccount1994container"

# Queue Management
Get-AzStorageQueue -Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context
(Get-AzStorageQueue -Name <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).Context).QueueClient.PeekMessage().Value

#Blob Container
Get-AzStorageBlob -Container <container-name> -Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context
Get-AzStorageBlobContent `
-Container <container-name> `
-Blob <blob-name> `
-Destination <local-path> `
-Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context

Set-AzStorageBlobContent `
-Container <container-name> `
-File <local-file-path> `
-Blob <blob-name> `
-Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context

# Shared Access Signatures (SAS)
Get-AzStorageContainerAcl `
-Container <container-name> `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context

New-AzStorageBlobSASToken `
-Context $ctx `
-Container <container-name> `
-Blob <blob-name> `
-Permission racwdl `
-ExpiryTime (Get-Date "2024-12-31T23:59:00Z")
```
</details>

{{#endtab }}
{{#endtabs }}

### Udostępnianie plików

{{#ref}}
az-file-shares.md
{{#endref}}

## Podwyższanie uprawnień

{{#ref}}
../az-privilege-escalation/az-storage-privesc.md
{{#endref}}

## Działania po eksploatacji

{{#ref}}
../az-post-exploitation/az-blob-storage-post-exploitation.md
{{#endref}}

## Utrzymywanie dostępu

{{#ref}}
../az-persistence/az-storage-persistence.md
{{#endref}}

## Źródła

- [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
- [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)
- [https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support](https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support)
- [Holiday Hack Challenge 2025: Blob Storage (Storage Secrets)](https://0xdf.gitlab.io/holidayhack2025/act1/blob-storage)
- [https://learn.microsoft.com/en-us/cli/azure/storage/account](https://learn.microsoft.com/en-us/cli/azure/storage/account)
- [https://learn.microsoft.com/en-us/cli/azure/storage/container](https://learn.microsoft.com/en-us/cli/azure/storage/container)
- [https://learn.microsoft.com/en-us/cli/azure/storage/blob](https://learn.microsoft.com/en-us/cli/azure/storage/blob)

{{#include ../../../banners/hacktricks-training.md}}
