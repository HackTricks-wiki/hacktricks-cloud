# Az - Storage Accounts & Blobs

{{#include ../../../banners/hacktricks-training.md}}

## Βασικές Πληροφορίες

Azure Storage Accounts είναι θεμελιώδεις υπηρεσίες στο Microsoft Azure που παρέχουν επεκτάσιμο, ασφαλές και υψηλά διαθέσιμο cloud **storage για διάφορους τύπους δεδομένων**, συμπεριλαμβανομένων των blobs (binary large objects), files, queues και tables. Λειτουργούν ως containers που ομαδοποιούν αυτές τις διαφορετικές υπηρεσίες αποθήκευσης κάτω από ένα ενιαίο namespace για εύκολη διαχείριση.

**Κύριες επιλογές ρύθμισης**:

- Κάθε storage account πρέπει να έχει ένα **μοναδικό όνομα σε όλο το Azure**.
- Κάθε storage account αναπτύσσεται σε μια **περιοχή (region)** ή σε μια επεκταμένη ζώνη Azure.
- Είναι δυνατό να επιλεγεί η **premium** έκδοση του storage account για καλύτερη απόδοση.
- Είναι δυνατό να επιλεγεί ανάμεσα σε **4 τύπους redundancy για προστασία** απέναντι σε αποτυχίες rack, drive και datacenter.

**Επιλογές ρύθμισης ασφάλειας**:

- **Require secure transfer for REST API operations**: Απαιτεί TLS σε οποιαδήποτε επικοινωνία με το storage.
- **Allows enabling anonymous access on individual containers**: Αν δεν επιτρέπεται, δεν θα είναι δυνατό να ενεργοποιηθεί anonymous access στο μέλλον.
- **Enable storage account key access**: Αν δεν ενεργοποιηθεί, η πρόσβαση με Shared Keys θα απαγορευτεί.
- **Minimum TLS version**
- **Permitted scope for copy operations**: Επιτρέπει από οποιοδήποτε storage account, από οποιοδήποτε storage account του ίδιου Entra tenant ή από storage account με private endpoints στο ίδιο virtual network.

**Blob Storage options**:

- **Allow cross-tenant replication**
- **Access tier**: Hot (συχνά προσπελάσιμα δεδομένα), Cool και Cold (σπάνια προσπελάσιμα δεδομένα)

**Δικτυακές επιλογές**:

- **Network access**:
- Επιτρέπεται από όλα τα networks
- Επιτρέπεται από επιλεγμένα virtual networks και IP διευθύνσεις
- Απενεργοποίηση δημόσιας πρόσβασης και χρήση private access
- **Private endpoints**: Επιτρέπει μια ιδιωτική σύνδεση στο storage account από ένα virtual network

**Επιλογές προστασίας δεδομένων**:

- **Point-in-time restore for containers**: Επιτρέπει την επαναφορά containers σε προηγούμενη κατάσταση.
- Απαιτεί να είναι ενεργοποιημένα versioning, change feed και blob soft delete.
- **Enable soft delete for blobs**: Ενεργοποιεί περίοδο retention σε ημέρες για διαγραμμένα blobs (ακόμη και overwritten).
- **Enable soft delete for containers**: Ενεργοποιεί περίοδο retention σε ημέρες για διαγραμμένους containers.
- **Enable soft delete for file shares**: Ενεργοποιεί περίοδο retention σε ημέρες για διαγραμμένα file shares.
- **Enable versioning for blobs**: Διατηρεί προηγούμενες εκδόσεις των blobs.
- **Enable blob change feed**: Κρατά logs από δημιουργία, τροποποίηση και διαγραφή αλλαγών στα blobs.
- **Enable version-level immutability support**: Επιτρέπει να οριστεί πολιτική time-based retention σε επίπεδο account που θα εφαρμόζεται σε όλες τις blob versions.
- Version-level immutability support και point-in-time restore for containers δεν μπορούν να ενεργοποιηθούν ταυτόχρονα.

**Επιλογές κρυπτογράφησης**:

- **Encryption type**: Είναι δυνατό να χρησιμοποιηθούν Microsoft-managed keys (MMK) ή Customer-managed keys (CMK).
- **Enable infrastructure encryption**: Επιτρέπει διπλή κρυπτογράφηση των δεδομένων "για περισσότερη ασφάλεια".

### Storage endpoints

<table data-header-hidden><thead><tr><th width="197">Storage Service</th><th>Endpoint</th></tr></thead><tbody><tr><td><strong>Blob storage</strong></td><td><code>https://&lt;storage-account&gt;.blob.core.windows.net</code><br><br><code>https://&lt;stg-acc&gt;.blob.core.windows.net/&lt;container-name&gt;?restype=container&comp=list</code></td></tr><tr><td><strong>Data Lake Storage</strong></td><td><code>https://&lt;storage-account&gt;.dfs.core.windows.net</code></td></tr><tr><td><strong>Azure Files</strong></td><td><code>https://&lt;storage-account&gt;.file.core.windows.net</code></td></tr><tr><td><strong>Queue storage</strong></td><td><code>https://&lt;storage-account&gt;.queue.core.windows.net</code></td></tr><tr><td><strong>Table storage</strong></td><td><code>https://&lt;storage-account&gt;.table.core.windows.net</code></td></tr></tbody></table>

### Δημόσια Έκθεση

Αν το "Allow Blob public access" είναι **enabled** (disabled από προεπιλογή), κατά τη δημιουργία ενός container είναι δυνατό να:

- Δώσετε **public access to read blobs** (πρέπει να γνωρίζετε το όνομα).
- **List container blobs** και να τα **read**.
- Το κάνετε πλήρως **private**

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfoetUnYBPWQpRrWNnnlbqWpl8Rdoaeg5uBrCVlvcNDlnKwQHjZe8nUb2SfPspBgbu-lCZLmUei-hFi_Jl2eKbaxUtBGTjdUSDmkrcwr90VZkmuMjk9tyh92p75btfyzGiUTa0-=s2048?key=m8TV59TrCFPlkiNnmhYx3aZt" alt=""><figcaption></figcaption></figure>

### Έκθεση Στατικής ιστοσελίδας (`$web`) & leaked secrets

- **Static websites** σερβίρονται από τον ειδικό `$web` container μέσω ενός region-specific endpoint όπως `https://<account>.z13.web.core.windows.net/`.
- Ο `$web` container μπορεί να αναφέρει `publicAccess: null` μέσω του blob API, αλλά τα αρχεία εξακολουθούν να είναι προσβάσιμα μέσω του static site endpoint, οπότε η απόθεση config/IaC artifacts εκεί μπορεί να leak secrets.
- Γρήγορη διαδικασία ελέγχου:
```bash
# Identify storage accounts with static website hosting enabled
az storage blob service-properties show --account-name <acc-name> --auth-mode login
# Enumerate containers (including $web) and their public flags
az storage container list --account-name <acc-name> --auth-mode login
# List files served by the static site even when publicAccess is null
az storage blob list --container-name '$web' --account-name <acc-name> --auth-mode login
# Pull suspicious files directly (e.g., IaC tfvars containing secrets/SAS)
az storage blob download -c '$web' --name iac/terraform.tfvars --file /dev/stdout --account-name <acc-name> --auth-mode login
```
### Έλεγχος έκθεσης ανώνυμου blob

- **Εντοπίστε storage accounts** που μπορούν να εκθέσουν δεδομένα: `az storage account list | jq -r '.[] | select(.properties.allowBlobPublicAccess==true) | .name'`. Αν `allowBlobPublicAccess` είναι `false` δεν μπορείτε να κάνετε containers δημόσια.
- **Επιθεωρήστε επικίνδυνους λογαριασμούς** για να επιβεβαιώσετε τη σημαία και άλλες ευάλωτες ρυθμίσεις: `az storage account show --name <acc> --query '{allow:properties.allowBlobPublicAccess, minTls:properties.minimumTlsVersion}'`.
- **Καταγράψτε την έκθεση σε επίπεδο container** όπου η σημαία είναι ενεργοποιημένη:
```bash
az storage container list --account-name <acc> \
--query '[].{name:name, access:properties.publicAccess}'
```
- `"Blob"`: οι ανώνυμες αναγνώσεις επιτρέπονται **μόνο όταν το όνομα του Blob είναι γνωστό** (χωρίς δυνατότητα λίστας).
- `"Container"`: ανώνυμη **λίστα + ανάγνωση** κάθε blob.
- `null`: ιδιωτικό; απαιτείται αυθεντικοποίηση.
- **Αποδείξτε πρόσβαση** χωρίς διαπιστευτήρια:
- Αν το `publicAccess` είναι `Container`, η ανώνυμη λίστα λειτουργεί: `curl "https://<acc>.blob.core.windows.net/<container>?restype=container&comp=list"`.
- Για τόσο το `Blob` όσο και το `Container`, η ανώνυμη λήψη blob λειτουργεί όταν το όνομα είναι γνωστό:
```bash
az storage blob download -c <container> -n <blob> --account-name <acc> --file /dev/stdout
# or via raw HTTP
curl "https://<acc>.blob.core.windows.net/<container>/<blob>"
```
### Σύνδεση στο Storage

Αν βρείτε κάποιο **storage** στο οποίο μπορείτε να συνδεθείτε, μπορείτε να χρησιμοποιήσετε το εργαλείο [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) για να το κάνετε.

## Πρόσβαση σε Storage <a href="#about-blob-storage" id="about-blob-storage"></a>

### RBAC

Είναι δυνατή η χρήση Entra ID principals με **RBAC roles** για πρόσβαση σε storage accounts και αυτός είναι ο συνιστώμενος τρόπος.

### Κλειδιά Πρόσβασης

Οι storage accounts έχουν access keys που μπορούν να χρησιμοποιηθούν για πρόσβαση σε αυτά. Αυτό παρέχει **πλήρη πρόσβαση στον λογαριασμό storage.**

<figure><img src="../../../images/image (5).png" alt=""><figcaption></figcaption></figure>

### **Shared Keys & Lite Shared Keys**

Μπορείτε να [**generate Shared Keys**](https://learn.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key) υπογεγραμμένα με τα access keys για να εξουσιοδοτήσετε πρόσβαση σε ορισμένους πόρους μέσω ενός signed URL.

> [!NOTE]
> Λάβετε υπόψη ότι το μέρος `CanonicalizedResource` αναπαριστά τον πόρο των υπηρεσιών storage (URI). Και αν οποιοδήποτε μέρος στο URL είναι κωδικοποιημένο, πρέπει επίσης να κωδικοποιηθεί μέσα στο `CanonicalizedResource`.

> [!NOTE]
> Αυτό **χρησιμοποιείται από προεπιλογή από το `az` cli** για την αυθεντικοποίηση των αιτημάτων. Για να το κάνετε να χρησιμοποιήσει τα διαπιστευτήρια του Entra ID principal, υποδείξτε την παράμετρο `--auth-mode login`.

- Είναι δυνατό να δημιουργηθεί ένα **shared key for blob, queue and file services** υπογράφοντας τις ακόλουθες πληροφορίες:
```bash
StringToSign = VERB + "\n" +
Content-Encoding + "\n" +
Content-Language + "\n" +
Content-Length + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
If-Modified-Since + "\n" +
If-Match + "\n" +
If-None-Match + "\n" +
If-Unmodified-Since + "\n" +
Range + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
- Είναι δυνατό να δημιουργηθεί ένα **shared key for table services** υπογράφοντας τις ακόλουθες πληροφορίες:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedResource;
```
- Είναι δυνατόν να δημιουργηθεί ένα **lite shared key for blob, queue and file services** υπογράφοντας τις ακόλουθες πληροφορίες:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
- Είναι δυνατό να δημιουργηθεί ένα **lite shared key for table services** υπογράφοντας τις ακόλουθες πληροφορίες:
```bash
StringToSign = Date + "\n"
CanonicalizedResource
```
Στη συνέχεια, για να χρησιμοποιηθεί το κλειδί, μπορεί να τεθεί στην κεφαλίδα Authorization ακολουθώντας την εξής σύνταξη:
```bash
Authorization="[SharedKey|SharedKeyLite] <AccountName>:<Signature>"
#e.g.
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=

PUT http://myaccount/mycontainer?restype=container&timeout=30 HTTP/1.1
x-ms-version: 2014-02-14
x-ms-date: Fri, 26 Jun 2015 23:39:12 GMT
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=
Content-Length: 0
```
### **Shared Access Signature** (SAS)

Οι Shared Access Signatures (SAS) είναι ασφαλείς, χρονικά περιορισμένοι σύνδεσμοι URL που **παραχωρούν συγκεκριμένα δικαιώματα πρόσβασης σε πόρους** σε έναν Azure Storage account χωρίς να αποκαλύπτουν τα κλειδιά πρόσβασης του λογαριασμού. Ενώ τα access keys παρέχουν πλήρη διαχειριστική πρόσβαση σε όλους τους πόρους, τα SAS επιτρέπουν λεπτομερή έλεγχο καθορίζοντας δικαιώματα (όπως read ή write) και ορίζοντας χρόνο λήξης.

#### SAS Types

- **User delegation SAS**: Δημιουργείται από ένα **Entra ID principal** που θα υπογράψει το SAS και θα εξουσιοδοτήσει τα δικαιώματα από τον χρήστη στο SAS. Μπορεί να χρησιμοποιηθεί μόνο με **blob and data lake storage** ([docs](https://learn.microsoft.com/en-us/rest/api/storageservices/create-user-delegation-sas)). Είναι δυνατόν να **ανακληθούν** όλα τα παραχθέντα user delegated SAS.
- Είναι πιθανό να δημιουργηθεί ένα delegation SAS με "περισσότερα" δικαιώματα από αυτά που έχει ο χρήστης. Ωστόσο, αν το principal δεν διαθέτει αυτά τα δικαιώματα, δεν θα λειτουργήσει (no privesc).
- **Service SAS**: Υπογράφεται χρησιμοποιώντας ένα από τα access keys του storage account. Μπορεί να χρησιμοποιηθεί για να παραχωρήσει πρόσβαση σε συγκεκριμένους πόρους σε μία μόνο storage service. Αν το κλειδί ανανεωθεί, το SAS θα σταματήσει να λειτουργεί.
- **Account SAS**: Υπογράφεται επίσης με ένα από τα access keys του storage account. Παραχωρεί πρόσβαση σε πόρους σε υπηρεσίες του storage account (Blob, Queue, Table, File) και μπορεί να περιλαμβάνει λειτουργίες σε επίπεδο υπηρεσίας.

A SAS URL signed by an **access key** looks like this:

- `https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

A SAS URL signed as a **user delegation** looks like this:

- `https://<container_name>.blob.core.windows.net/testing-container?sp=r&st=2024-11-22T15:07:40Z&se=2024-11-22T23:07:40Z&skoid=d77c71a1-96e7-483d-bd51-bd753aa66e62&sktid=fdd066e1-ee37-49bc-b08f-d0e152119b04&skt=2024-11-22T15:07:40Z&ske=2024-11-22T23:07:40Z&sks=b&skv=2022-11-02&spr=https&sv=2022-11-02&sr=c&sig=7s5dJyeE6klUNRulUj9TNL0tMj2K7mtxyRc97xbYDqs%3D`

Note some **http params**:

- The **`se`** param indicates the **expiration date** of the SAS
- The **`sp`** param indicates the **permissions** of the SAS
- The **`sig`** is the **signature** validating the SAS

#### SAS permissions

Κατά τη δημιουργία ενός SAS χρειάζεται να δηλωθούν τα δικαιώματα που θα παραχωρεί. Ανάλογα με το αντικείμενο πάνω στο οποίο δημιουργείται το SAS, μπορεί να συμπεριληφθούν διαφορετικά δικαιώματα. Για παράδειγμα:

- (a)dd, (c)reate, (d)elete, (e)xecute, (f)ilter_by_tags, (i)set_immutability_policy, (l)ist, (m)ove, (r)ead, (t)ag, (w)rite, (x)delete_previous_version, (y)permanent_delete

## SFTP Support for Azure Blob Storage

Το Azure Blob Storage υποστηρίζει πλέον το SSH File Transfer Protocol (SFTP), επιτρέποντας ασφαλή μεταφορά και διαχείριση αρχείων απευθείας στο Blob Storage χωρίς την ανάγκη προσαρμοσμένων λύσεων ή προϊόντων τρίτων.

### Key Features

- Protocol Support: Το SFTP λειτουργεί με λογαριασμούς Blob Storage που έχουν ρυθμιστεί με hierarchical namespace (HNS). Αυτό οργανώνει τα blobs σε φακέλους και υποφακέλους για ευκολότερη πλοήγηση.
- Security: Το SFTP χρησιμοποιεί τοπικές ταυτότητες χρηστών για authentication και δεν ενσωματώνεται με RBAC ή ABAC. Κάθε τοπικός χρήστης μπορεί να κάνει authentication μέσω:
  - Azure-generated passwords
  - Public-private SSH key pairs
- Granular Permissions: Δικαιώματα όπως Read, Write, Delete και List μπορούν να ανατεθούν σε τοπικούς χρήστες για έως και 100 containers.
- Networking Considerations: Οι SFTP συνδέσεις γίνονται μέσω της θύρας 22. Το Azure υποστηρίζει ρυθμίσεις δικτύου όπως firewalls, private endpoints ή virtual networks για την προστασία της SFTP κίνησης.

### Setup Requirements

- Hierarchical Namespace: Το HNS πρέπει να είναι ενεργοποιημένο κατά τη δημιουργία του storage account.
- Supported Encryption: Απαιτεί κρυπτογραφικούς αλγορίθμους εγκεκριμένους από το Microsoft Security Development Lifecycle (SDL) (π.χ., rsa-sha2-256, ecdsa-sha2-nistp256).
- SFTP Configuration:
  - Ενεργοποιήστε το SFTP στον storage account.
  - Δημιουργήστε τοπικές ταυτότητες χρηστών με κατάλληλα δικαιώματα.
  - Διαμορφώστε home directories για τους χρήστες ώστε να ορίσετε την αρχική τους θέση μέσα στο container.

### Permissions

| Δικαίωμα               | Σύμβολο | Περιγραφή                              |
| ---------------------- | ------ | ------------------------------------ |
| **Read**               | `r`    | Ανάγνωση περιεχομένου αρχείου.         |
| **Write**              | `w`    | Ανέβασμα αρχείων και δημιουργία φακέλων. |
| **List**               | `l`    | Απαρίθμηση περιεχομένου φακέλων.       |
| **Delete**             | `d`    | Διαγραφή αρχείων ή φακέλων.            |
| **Create**             | `c`    | Δημιουργία αρχείων ή φακέλων.          |
| **Modify Ownership**   | `o`    | Αλλαγή του ιδιοκτήτη χρήστη ή ομάδας.  |
| **Modify Permissions** | `p`    | Αλλαγή ACLs σε αρχεία ή φακέλους.      |

## Enumeration

{{#tabs }}
{{#tab name="az cli" }}

<details>
<summary>az cli enumeration</summary>
```bash
# Get storage accounts
az storage account list #Get the account name from here

# BLOB STORAGE
## List containers
az storage container list --account-name <name>
## Check if public access is allowed
az storage container show-permission \
--account-name <acc-name> \
-n <container-name>
## Make a container public
az storage container set-permission \
--public-access container \
--account-name <acc-name> \
-n <container-name>
## List blobs in a container
az storage blob list \
--container-name <container name> \
--account-name <account name>
## Download blob
az storage blob download \
--account-name <account name> \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Create container policy
az storage container policy create \
--account-name mystorageaccount \
--container-name mycontainer \
--name fullaccesspolicy \
--permissions racwdl \
--start 2023-11-22T00:00Z \
--expiry 2024-11-22T00:00Z

# QUEUE
az storage queue list --account-name <name>
az storage message peek --account-name <name> --queue-name <queue-name>

# ACCESS KEYS
az storage account keys list --account-name <name>
## Check key policies (expiration time?)
az storage account show -n <name> --query "{KeyPolicy:keyPolicy}"
## Once having the key, it's possible to use it with the argument --account-key
## Enum blobs with account key
az storage blob list \
--container-name <container name> \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw=="
## Download a file using an account key
az storage blob download \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Upload a file using an account key
az storage blob upload \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--file </path/to/local/file>

# SAS
## List access policies
az storage <container|queue|share|table> policy list \
--account-name <acc name> \
--container-name <container name>

## Generate SAS with all permissions using an access key
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
-n <container-name>

## Generate SAS with all permissions using via user delegation
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
--as-user --auth-mode login \
-n <container-name>

## Generate account SAS
az storage account generate-sas \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name>  \
--services qt \
--resource-types sco \
--permissions acdfilrtuwxy

## Use the returned SAS key with the param --sas-token
## e.g.
az storage blob show \
--account-name <account name> \
--container-name <container name> \
--sas-token 'se=2024-12-31T23%3A59%3A00Z&sp=racwdxyltfmei&sv=2022-11-02&sr=c&sig=ym%2Bu%2BQp5qqrPotIK5/rrm7EMMxZRwF/hMWLfK1VWy6E%3D' \
--name 'asd.txt'

#Local-Users
## List users
az storage account local-user list \
--account-name <storage-account-name> \
--resource-group <resource-group-name>
## Get user
az storage account local-user show \
--account-name <storage-account-name> \
--resource-group <resource-group-name> \
--name <local-user-name>

## List keys
az storage account local-user list \
--account-name <storage-account-name> \
--resource-group <resource-group-name>
```
</details>

{{#endtab }}

{{#tab name="Az PowerShell" }}

<details>
<summary>Az PowerShell enumeration</summary>
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt

# Create a Container Policy
New-AzStorageContainerStoredAccessPolicy `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context `
-Container <container-name> `
-Policy <policy-name> `
-Permission racwdl `
-StartTime (Get-Date "2023-11-22T00:00Z") `
-ExpiryTime (Get-Date "2024-11-22T00:00Z")
#Get Container policy
Get-AzStorageContainerStoredAccessPolicy `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context `
-Container "storageaccount1994container"

# Queue Management
Get-AzStorageQueue -Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context
(Get-AzStorageQueue -Name <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).Context).QueueClient.PeekMessage().Value

#Blob Container
Get-AzStorageBlob -Container <container-name> -Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context
Get-AzStorageBlobContent `
-Container <container-name> `
-Blob <blob-name> `
-Destination <local-path> `
-Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context

Set-AzStorageBlobContent `
-Container <container-name> `
-File <local-file-path> `
-Blob <blob-name> `
-Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context

# Shared Access Signatures (SAS)
Get-AzStorageContainerAcl `
-Container <container-name> `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context

New-AzStorageBlobSASToken `
-Context $ctx `
-Container <container-name> `
-Blob <blob-name> `
-Permission racwdl `
-ExpiryTime (Get-Date "2024-12-31T23:59:00Z")
```
</details>

{{#endtab }}
{{#endtabs }}

### Κοινόχρηστοι Φάκελοι

{{#ref}}
az-file-shares.md
{{#endref}}

## Κλιμάκωση Δικαιωμάτων

{{#ref}}
../az-privilege-escalation/az-storage-privesc.md
{{#endref}}

## Μετά-Εκμετάλλευση

{{#ref}}
../az-post-exploitation/az-blob-storage-post-exploitation.md
{{#endref}}

## Διατήρηση Πρόσβασης

{{#ref}}
../az-persistence/az-storage-persistence.md
{{#endref}}

## Αναφορές

- [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
- [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)
- [https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support](https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support)
- [Holiday Hack Challenge 2025 – Spare Key (Azure static website SAS leak)](https://0xdf.gitlab.io/holidayhack2025/act1/spare-key)
- [Holiday Hack Challenge 2025: Blob Storage (Storage Secrets)](https://0xdf.gitlab.io/holidayhack2025/act1/blob-storage)
- [https://learn.microsoft.com/en-us/cli/azure/storage/account](https://learn.microsoft.com/en-us/cli/azure/storage/account)
- [https://learn.microsoft.com/en-us/cli/azure/storage/container](https://learn.microsoft.com/en-us/cli/azure/storage/container)
- [https://learn.microsoft.com/en-us/cli/azure/storage/blob](https://learn.microsoft.com/en-us/cli/azure/storage/blob)

{{#include ../../../banners/hacktricks-training.md}}
