# Az - Depolama Hesapları & Blobs

{{#include ../../../banners/hacktricks-training.md}}

## Temel Bilgiler

Azure Storage Accounts, blob'lar (binary large objects), dosyalar, kuyruklar ve tablolar dahil çeşitli veri türleri için ölçeklenebilir, güvenli ve yüksek kullanılabilirlikte bulut **depolama sağlayan** Microsoft Azure servisleridir. Bu farklı depolama servislerini tek bir ad alanı altında gruplayan kapsayıcılar olarak görev yaparlar ve yönetimi kolaylaştırır.

**Ana yapılandırma seçenekleri**:

- Her storage account'un **Azure genelinde benzersiz bir isme** sahip olması gerekir.
- Her storage account bir **bölgede** veya bir Azure genişletilmiş zonunda dağıtılır.
- Daha iyi performans için storage account'un **premium** sürümünü seçmek mümkündür.
- Raf, disk ve veri merkezi **arıza**larına karşı korumak için **4 tür yedeklilik** arasından seçim yapılabilir.

**Güvenlik yapılandırma seçenekleri**:

- **REST API işlemleri için güvenli aktarımı zorunlu kılma**: Depolama ile yapılan herhangi bir iletişimde TLS gerektirir.
- **Bireysel container'larda anonim erişimi etkinleştirmeye izin verme**: Eğer kapalıysa, gelecekte anonim erişim etkinleştirilemez.
- **Depolama hesabı anahtar erişimini etkinleştirme**: Eğer kapalıysa, Shared Keys ile erişim yasaklanır.
- **Minimum TLS sürümü**
- **Kopyalama işlemleri için izin verilen kapsam**: Herhangi bir storage account'tan, aynı Entra tenant'ından herhangi bir storage account'tan veya aynı virtual network içinde private endpoint'li storage account'tan izin ver.

**Blob Depolama seçenekleri**:

- **Tenantlar arası replikasyona izin ver**
- **Erişim katmanı**: Hot (sık erişilen veri), Cool ve Cold (nadiren erişilen veri)

**Ağ seçenekleri**:

- **Ağ erişimi**:
- Tüm ağlardan izin ver
- Seçili virtual network'lerden ve IP adreslerinden izin ver
- Genel erişimi devre dışı bırak ve özel erişim kullan
- **Private endpoints**: Sanal ağdan depolama hesabına özel bir bağlantıya izin verir

**Veri koruma seçenekleri**:

- **Konteynerler için point-in-time restore**: Konteynerleri önceki bir duruma geri yüklemeyi sağlar
- Bunun için versioning, change feed ve blob soft delete'in etkinleştirilmesi gerekir.
- **Blob'lar için soft delete'i etkinleştir**: Silinen blob'lar (üzerine yazılanlar dahil) için gün bazında bir saklama süresi sağlar
- **Konteynerler için soft delete'i etkinleştir**: Silinen konteynerler için gün bazında bir saklama süresi sağlar
- **File share'ler için soft delete'i etkinleştir**: Silinen file share'ler için gün bazında bir saklama süresi sağlar
- **Blob'lar için versioning'i etkinleştir**: Blob'larınızın önceki sürümlerini korur
- **Blob change feed'i etkinleştir**: Blob'larda yapılan oluşturma, değişiklik ve silme işlemlerinin loglarını tutar
- **Sürüm düzeyinde değişmezlik (version-level immutability) desteğini etkinleştir**: Tüm blob sürümlerine uygulanacak hesap düzeyinde zaman-temelli bir saklama politikası ayarlamanıza izin verir.
- Sürüm düzeyinde değişmezlik desteği ile konteynerler için point-in-time restore aynı anda etkinleştirilemez.

**Şifreleme yapılandırma seçenekleri**:

- **Şifreleme türü**: Microsoft-managed keys (MMK) veya Customer-managed keys (CMK) kullanılabilir
- **Altyapı şifrelemesini etkinleştir**: Verileri "daha fazla güvenlik" için çift şifrelemeye izin verir

### Depolama uç noktaları

<table data-header-hidden><thead><tr><th width="197">Depolama Servisi</th><th>Uçnokta</th></tr></thead><tbody><tr><td><strong>Blob depolama</strong></td><td><code>https://<storage-account>.blob.core.windows.net</code><br><br><code>https://<stg-acc>.blob.core.windows.net/<container-name>?restype=container&comp=list</code></td></tr><tr><td><strong>Data Lake Storage</strong></td><td><code>https://<storage-account>.dfs.core.windows.net</code></td></tr><tr><td><strong>Azure Files</strong></td><td><code>https://<storage-account>.file.core.windows.net</code></td></tr><tr><td><strong>Queue storage</strong></td><td><code>https://<storage-account>.queue.core.windows.net</code></td></tr><tr><td><strong>Table storage</strong></td><td><code>https://<storage-account>.table.core.windows.net</code></td></tr></tbody></table>

### Genel Erişim

Eğer "Allow Blob public access" **etkinse** (varsayılan olarak devre dışı), bir container oluştururken şunları yapabilirsiniz:

- Blob'ları **okumak için genel erişim** verebilirsiniz (adı bilinmelidir).
- **Container içerisindeki blob'ları listeleyebilir** ve **okuyabilirsiniz**.
- Tamamen **özel** yapabilirsiniz

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfoetUnYBPWQpRrWNnnlbqWpl8Rdoaeg5uBrCVlvcNDlnKwQHjZe8nUb2SfPspBgbu-lCZLmUei-hFi_Jl2eKbaxUtBGTjdUSDmkrcwr90VZkmuMjk9tyh92p75btfyzGiUTa0-=s2048?key=m8TV59TrCFPlkiNnmhYx3aZt" alt=""><figcaption></figcaption></figure>

#### Anonim blob maruziyetini denetleme

- **Veri açığa çıkarabilecek storage account'ları bulun**: `az storage account list | jq -r '.[] | select(.properties.allowBlobPublicAccess==true) | .name'`. Eğer `allowBlobPublicAccess` `false` ise container'ları public yapamazsınız.
- **Riskli hesapları inceleyin** bayrağı ve diğer zayıf ayarları doğrulamak için: `az storage account show --name <acc> --query '{allow:properties.allowBlobPublicAccess, minTls:properties.minimumTlsVersion}'`.
- **Bayrağın etkin olduğu container düzeyindeki açıklığı listeleyin:**
```bash
az storage container list --account-name <acc> \
--query '[].{name:name, access:properties.publicAccess}'
```
- `"Blob"`: anonim okuma **yalnızca blob adı bilindiğinde** izinlidir (listeleme yok).
- `"Container"`: anonim **listeleme + okuma** ile tüm bloblara erişim.
- `null`: özel; kimlik doğrulama gereklidir.
- **Kimlik bilgisi olmadan erişimi kanıtlayın**:
- Eğer `publicAccess` `Container` ise, anonim listeleme çalışır: `curl "https://<acc>.blob.core.windows.net/<container>?restype=container&comp=list"`.
- Hem `Blob` hem de `Container` için, blob adı bilindiğinde anonim blob indirme çalışır:
```bash
az storage blob download -c <container> -n <blob> --account-name <acc> --file /dev/stdout
# or via raw HTTP
curl "https://<acc>.blob.core.windows.net/<container>/<blob>"
```
### Storage'a Bağlan

Bağlanabileceğiniz herhangi bir **storage** bulursanız, bunu yapmak için [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) aracını kullanabilirsiniz.

## Storage'a Erişim <a href="#about-blob-storage" id="about-blob-storage"></a>

### RBAC

Entra ID principals'larını **RBAC roles** kullanarak storage hesaplarına erişmek için kullanmak mümkündür ve bu önerilen yöntemdir.

### Access Keys

Storage hesaplarının erişim için kullanılabilecek access keys'leri vardır. Bu, storage hesabına **tam erişim** sağlar.

<figure><img src="../../../images/image (5).png" alt=""><figcaption></figcaption></figure>

### **Shared Keys & Lite Shared Keys**

Erişim anahtarlarıyla imzalanmış [**Shared Keys**](https://learn.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key) oluşturarak signed URL aracılığıyla belirli kaynaklara erişimi yetkilendirmek mümkündür.

> [!NOTE]
> Note that the `CanonicalizedResource` part represents the storage services resource (URI). And if any part in the URL is encoded, it should also be encoded inside the `CanonicalizedResource`.

> [!NOTE]
> Bu, istekleri kimlik doğrulamak için varsayılan olarak `az` cli tarafından kullanılır. Entra ID principal credentials kullanmasını sağlamak için parametre `--auth-mode login` belirtin.

- Aşağıdaki bilgileri imzalayarak blob, queue ve file servisleri için bir **shared key** oluşturmak mümkündür:
```bash
StringToSign = VERB + "\n" +
Content-Encoding + "\n" +
Content-Language + "\n" +
Content-Length + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
If-Modified-Since + "\n" +
If-Match + "\n" +
If-None-Match + "\n" +
If-Unmodified-Since + "\n" +
Range + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
- Aşağıdaki bilgileri imzalayarak **tablo hizmetleri için paylaşılan anahtar** oluşturmak mümkündür:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedResource;
```
- Aşağıdaki bilgileri imzalayarak **blob, queue ve file servisleri için lite paylaşılan anahtar** oluşturmak mümkündür:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
- Aşağıdaki bilgileri imzalayarak **lite shared key for table services** oluşturmak mümkündür:
```bash
StringToSign = Date + "\n"
CanonicalizedResource
```
Anahtarı kullanmak için Authorization header'ında şu sözdizimi kullanılır:
```bash
Authorization="[SharedKey|SharedKeyLite] <AccountName>:<Signature>"
#e.g.
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=

PUT http://myaccount/mycontainer?restype=container&timeout=30 HTTP/1.1
x-ms-version: 2014-02-14
x-ms-date: Fri, 26 Jun 2015 23:39:12 GMT
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=
Content-Length: 0
```
### **Paylaşılan Erişim İmzası (SAS)**

Shared Access Signatures (SAS), hesap erişim anahtarlarını açığa çıkarmadan bir Azure Storage hesabındaki kaynaklara erişim için belirli izinler veren, süre sınırlı ve güvenli URL'lerdir. Erişim anahtarları tüm kaynaklara tam yönetimsel erişim sağlarken, SAS izinleri (ör. read veya write) ve bir sona erme zamanı belirleyerek ayrıntılı kontrol sağlar.

#### SAS Türleri

- **User delegation SAS**: Bu, SAS'ı imzalayacak ve kullanıcıdan SAS'a izinleri devredecek bir **Entra ID principal** tarafından oluşturulur. Sadece **blob ve data lake storage** ile kullanılabilir ([docs](https://learn.microsoft.com/en-us/rest/api/storageservices/create-user-delegation-sas)). Oluşturulmuş tüm user delegated SAS'ların **revoke** edilmesi mümkündür.
- Bir delegation SAS'ı kullanıcının sahip olduklarından "daha fazla" izinle oluşturmak mümkün olsa bile, principal bu izinlere sahip değilse çalışmaz (no privesc).
- **Service SAS**: Bu, storage account **access keys**'lerden biri kullanılarak imzalanır. Tek bir storage service içindeki belirli kaynaklara erişim vermek için kullanılabilir. Eğer key yenilenirse, SAS çalışmayı durdurur.
- **Account SAS**: Bu da storage account **access keys**'lerden biri ile imzalanır. Bir storage account servisleri (Blob, Queue, Table, File) genelinde kaynaklara erişim verir ve servis seviyesinde operasyonları içerebilir.

Bir access key ile imzalanmış SAS URL örneği:

- `https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Bir user delegation olarak imzalanmış SAS URL örneği:

- `https://<container_name>.blob.core.windows.net/testing-container?sp=r&st=2024-11-22T15:07:40Z&se=2024-11-22T23:07:40Z&skoid=d77c71a1-96e7-483d-bd51-bd753aa66e62&sktid=fdd066e1-ee37-49bc-b08f-d0e152119b04&skt=2024-11-22T15:07:40Z&ske=2024-11-22T23:07:40Z&sks=b&skv=2022-11-02&spr=https&sv=2022-11-02&sr=c&sig=7s5dJyeE6klUNRulUj9TNL0tMj2K7mtxyRc97xbYDqs%3D`

Bazı http parametrelerine dikkat:

- **`se`** parametresi SAS'ın **sona erme tarihini** gösterir
- **`sp`** parametresi SAS'ın **izinlerini** gösterir
- **`sig`** SAS'ı doğrulayan **imzadır**

#### SAS izinleri

SAS oluşturulurken hangi izinleri vereceği belirtilmelidir. SAS'ın oluşturulduğu nesneye bağlı olarak farklı izinler dahil edilebilir. Örneğin:

- (a)dd, (c)reate, (d)elete, (e)xecute, (f)ilter_by_tags, (i)set_immutability_policy, (l)ist, (m)ove, (r)ead, (t)ag, (w)rite, (x)delete_previous_version, (y)permanent_delete

## Azure Blob Storage için SFTP Desteği

Azure Blob Storage artık SSH File Transfer Protocol (SFTP) desteği sunar; bu sayede özel çözümler veya üçüncü taraf ürünlere ihtiyaç duymadan doğrudan Blob Storage'a güvenli dosya transferi ve yönetim yapılabilir.

### Önemli Özellikler

- Protocol Support: SFTP, hierarchical namespace (HNS) ile yapılandırılmış Blob Storage hesaplarıyla çalışır. Bu, blob'ları klasör ve alt klasörlere düzenleyerek gezinmeyi kolaylaştırır.
- Security: SFTP kimlik doğrulama için local user identities kullanır ve RBAC veya ABAC ile entegre olmaz. Her local user şu yöntemlerle doğrulanabilir:
  - Azure-generated passwords
  - Public-private SSH key pairs
- Granular Permissions: Read, Write, Delete ve List gibi izinler en fazla 100 container için local user'lara atanabilir.
- Networking Considerations: SFTP bağlantıları port 22 üzerinden yapılır. Azure, SFTP trafiğini güvence altına almak için firewalls, private endpoints veya virtual networks gibi ağ yapılandırmalarını destekler.

### Kurulum Gereksinimleri

- Hierarchical Namespace: Storage account oluşturulurken HNS etkinleştirilmelidir.
- Supported Encryption: Microsoft Security Development Lifecycle (SDL) tarafından onaylanmış kriptografik algoritmalar gereklidir (ör. rsa-sha2-256, ecdsa-sha2-nistp256).
- SFTP Configuration:
  - Enable SFTP on the storage account.
  - Create local user identities with appropriate permissions.
  - Configure home directories for users to define their starting location within the container.

### İzinler

| İzin                   | Sembol | Açıklama                             |
| ---------------------- | ------ | ------------------------------------ |
| **Read**               | `r`    | Dosya içeriğini okuma.               |
| **Write**              | `w`    | Dosya yükleme ve dizin oluşturma.    |
| **List**               | `l`    | Dizin içeriklerini listeleme.        |
| **Delete**             | `d`    | Dosya veya dizinleri silme.          |
| **Create**             | `c`    | Dosya veya dizin oluşturma.          |
| **Modify Ownership**   | `o`    | Sahip kullanıcı veya grubu değiştirme. |
| **Modify Permissions** | `p`    | Dosya veya dizinlerde ACL'leri değiştirme. |

## Keşif

{{#tabs }}
{{#tab name="az cli" }}

<details>
<summary>az cli enumeration</summary>
```bash
# Get storage accounts
az storage account list #Get the account name from here

# BLOB STORAGE
## List containers
az storage container list --account-name <name>
## Check if public access is allowed
az storage container show-permission \
--account-name <acc-name> \
-n <container-name>
## Make a container public
az storage container set-permission \
--public-access container \
--account-name <acc-name> \
-n <container-name>
## List blobs in a container
az storage blob list \
--container-name <container name> \
--account-name <account name>
## Download blob
az storage blob download \
--account-name <account name> \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Create container policy
az storage container policy create \
--account-name mystorageaccount \
--container-name mycontainer \
--name fullaccesspolicy \
--permissions racwdl \
--start 2023-11-22T00:00Z \
--expiry 2024-11-22T00:00Z

# QUEUE
az storage queue list --account-name <name>
az storage message peek --account-name <name> --queue-name <queue-name>

# ACCESS KEYS
az storage account keys list --account-name <name>
## Check key policies (expiration time?)
az storage account show -n <name> --query "{KeyPolicy:keyPolicy}"
## Once having the key, it's possible to use it with the argument --account-key
## Enum blobs with account key
az storage blob list \
--container-name <container name> \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw=="
## Download a file using an account key
az storage blob download \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Upload a file using an account key
az storage blob upload \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--file </path/to/local/file>

# SAS
## List access policies
az storage <container|queue|share|table> policy list \
--account-name <acc name> \
--container-name <container name>

## Generate SAS with all permissions using an access key
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
-n <container-name>

## Generate SAS with all permissions using via user delegation
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
--as-user --auth-mode login \
-n <container-name>

## Generate account SAS
az storage account generate-sas \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name>  \
--services qt \
--resource-types sco \
--permissions acdfilrtuwxy

## Use the returned SAS key with the param --sas-token
## e.g.
az storage blob show \
--account-name <account name> \
--container-name <container name> \
--sas-token 'se=2024-12-31T23%3A59%3A00Z&sp=racwdxyltfmei&sv=2022-11-02&sr=c&sig=ym%2Bu%2BQp5qqrPotIK5/rrm7EMMxZRwF/hMWLfK1VWy6E%3D' \
--name 'asd.txt'

#Local-Users
## List users
az storage account local-user list \
--account-name <storage-account-name> \
--resource-group <resource-group-name>
## Get user
az storage account local-user show \
--account-name <storage-account-name> \
--resource-group <resource-group-name> \
--name <local-user-name>

## List keys
az storage account local-user list \
--account-name <storage-account-name> \
--resource-group <resource-group-name>
```
</details>

{{#endtab }}

{{#tab name="Az PowerShell" }}

<details>
<summary>Az PowerShell enumeration</summary>
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt

# Create a Container Policy
New-AzStorageContainerStoredAccessPolicy `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context `
-Container <container-name> `
-Policy <policy-name> `
-Permission racwdl `
-StartTime (Get-Date "2023-11-22T00:00Z") `
-ExpiryTime (Get-Date "2024-11-22T00:00Z")
#Get Container policy
Get-AzStorageContainerStoredAccessPolicy `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context `
-Container "storageaccount1994container"

# Queue Management
Get-AzStorageQueue -Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context
(Get-AzStorageQueue -Name <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).Context).QueueClient.PeekMessage().Value

#Blob Container
Get-AzStorageBlob -Container <container-name> -Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context
Get-AzStorageBlobContent `
-Container <container-name> `
-Blob <blob-name> `
-Destination <local-path> `
-Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context

Set-AzStorageBlobContent `
-Container <container-name> `
-File <local-file-path> `
-Blob <blob-name> `
-Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context

# Shared Access Signatures (SAS)
Get-AzStorageContainerAcl `
-Container <container-name> `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context

New-AzStorageBlobSASToken `
-Context $ctx `
-Container <container-name> `
-Blob <blob-name> `
-Permission racwdl `
-ExpiryTime (Get-Date "2024-12-31T23:59:00Z")
```
</details>

{{#endtab }}
{{#endtabs }}

### Dosya Paylaşımları

{{#ref}}
az-file-shares.md
{{#endref}}

## Yetki Yükseltme

{{#ref}}
../az-privilege-escalation/az-storage-privesc.md
{{#endref}}

## Sömürme Sonrası

{{#ref}}
../az-post-exploitation/az-blob-storage-post-exploitation.md
{{#endref}}

## Kalıcı Erişim

{{#ref}}
../az-persistence/az-storage-persistence.md
{{#endref}}

## Referanslar

- [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
- [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)
- [https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support](https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support)
- [Holiday Hack Challenge 2025: Blob Storage (Storage Secrets)](https://0xdf.gitlab.io/holidayhack2025/act1/blob-storage)
- [https://learn.microsoft.com/en-us/cli/azure/storage/account](https://learn.microsoft.com/en-us/cli/azure/storage/account)
- [https://learn.microsoft.com/en-us/cli/azure/storage/container](https://learn.microsoft.com/en-us/cli/azure/storage/container)
- [https://learn.microsoft.com/en-us/cli/azure/storage/blob](https://learn.microsoft.com/en-us/cli/azure/storage/blob)

{{#include ../../../banners/hacktricks-training.md}}
