# Az - Λογαριασμοί Αποθήκευσης & Blobs

{{#include ../../../banners/hacktricks-training.md}}

## Βασικές Πληροφορίες

Οι Λογαριασμοί Αποθήκευσης Azure είναι θεμελιώδεις υπηρεσίες στο Microsoft Azure που παρέχουν κλιμακωτή, ασφαλή και εξαιρετικά διαθέσιμη cloud **αποθήκευση για διάφορους τύπους δεδομένων**, συμπεριλαμβανομένων των blobs (binary large objects), αρχείων, ουρών και πινάκων. Λειτουργούν ως δοχεία που ομαδοποιούν αυτές τις διαφορετικές υπηρεσίες αποθήκευσης κάτω από ένα ενιαίο namespace για εύκολη διαχείριση.

**Κύριες επιλογές διαμόρφωσης**:

- Κάθε λογαριασμός αποθήκευσης πρέπει να έχει ένα **μοναδικό όνομα σε όλους τους Azure**.
- Κάθε λογαριασμός αποθήκευσης αναπτύσσεται σε μια **περιοχή** ή σε μια επεκταμένη ζώνη Azure.
- Είναι δυνατή η επιλογή της **premium** έκδοσης του λογαριασμού αποθήκευσης για καλύτερη απόδοση.
- Είναι δυνατή η επιλογή μεταξύ **4 τύπων πλεονασμού για προστασία** από αποτυχίες ραφιών, δίσκων και κέντρων δεδομένων.

**Επιλογές διαμόρφωσης ασφαλείας**:

- **Απαιτεί ασφαλή μεταφορά για τις λειτουργίες REST API**: Απαιτεί TLS σε οποιαδήποτε επικοινωνία με την αποθήκευση.
- **Επιτρέπει την ενεργοποίηση ανώνυμης πρόσβασης σε μεμονωμένα δοχεία**: Αν όχι, δεν θα είναι δυνατή η ενεργοποίηση ανώνυμης πρόσβασης στο μέλλον.
- **Ενεργοποίηση πρόσβασης με κλειδιά λογαριασμού αποθήκευσης**: Αν όχι, η πρόσβαση με Shared Keys θα απαγορευτεί.
- **Ελάχιστη έκδοση TLS**.
- **Επιτρεπόμενη έκταση για λειτουργίες αντιγραφής**: Επιτρέπεται από οποιονδήποτε λογαριασμό αποθήκευσης, από οποιονδήποτε λογαριασμό αποθήκευσης από τον ίδιο Entra tenant ή από λογαριασμό αποθήκευσης με ιδιωτικά endpoints στο ίδιο εικονικό δίκτυο.

**Επιλογές Blob Storage**:

- **Επιτρέπεται η διασυνοριακή αναπαραγωγή**.
- **Επίπεδο πρόσβασης**: Hot (συχνά προσβάσιμα δεδομένα), Cool και Cold (σπάνια προσβάσιμα δεδομένα).

**Επιλογές δικτύωσης**:

- **Πρόσβαση δικτύου**:
- Επιτρέπεται από όλα τα δίκτυα.
- Επιτρέπεται από επιλεγμένα εικονικά δίκτυα και διευθύνσεις IP.
- Απενεργοποίηση δημόσιας πρόσβασης και χρήση ιδιωτικής πρόσβασης.
- **Ιδιωτικά endpoints**: Επιτρέπει μια ιδιωτική σύνδεση στον λογαριασμό αποθήκευσης από ένα εικονικό δίκτυο.

**Επιλογές προστασίας δεδομένων**:

- **Ανάκτηση σε συγκεκριμένο χρόνο για δοχεία**: Επιτρέπει την αποκατάσταση δοχείων σε προηγούμενη κατάσταση.
- Απαιτεί ενεργοποίηση της εκδοχής, της ροής αλλαγών και της ήπιας διαγραφής blob.
- **Ενεργοποίηση ήπιας διαγραφής για blobs**: Ενεργοποιεί μια περίοδο διατήρησης σε ημέρες για διαγραμμένα blobs (ακόμη και αν έχουν αντικατασταθεί).
- **Ενεργοποίηση ήπιας διαγραφής για δοχεία**: Ενεργοποιεί μια περίοδο διατήρησης σε ημέρες για διαγραμμένα δοχεία.
- **Ενεργοποίηση ήπιας διαγραφής για κοινές χρήσεις αρχείων**: Ενεργοποιεί μια περίοδο διατήρησης σε ημέρες για διαγραμμένες κοινές χρήσεις αρχείων.
- **Ενεργοποίηση εκδοχής για blobs**: Διατηρεί προηγούμενες εκδόσεις των blobs σας.
- **Ενεργοποίηση ροής αλλαγών blob**: Διατηρεί αρχεία καταγραφής δημιουργίας, τροποποίησης και διαγραφής αλλαγών στα blobs.
- **Ενεργοποίηση υποστήριξης αμεταβλητότητας επιπέδου εκδοχής**: Σας επιτρέπει να ορίσετε πολιτική διατήρησης βάσει χρόνου σε επίπεδο λογαριασμού που θα ισχύει για όλες τις εκδόσεις blob.
- Η υποστήριξη αμεταβλητότητας επιπέδου εκδοχής και η ανάκτηση σε συγκεκριμένο χρόνο για δοχεία δεν μπορούν να ενεργοποιηθούν ταυτόχρονα.

**Επιλογές διαμόρφωσης κρυπτογράφησης**:

- **Τύπος κρυπτογράφησης**: Είναι δυνατή η χρήση κλειδιών που διαχειρίζεται η Microsoft (MMK) ή κλειδιών που διαχειρίζεται ο πελάτης (CMK).
- **Ενεργοποίηση κρυπτογράφησης υποδομής**: Επιτρέπει την διπλή κρυπτογράφηση των δεδομένων "για περισσότερη ασφάλεια".

### Τερματικά Αποθήκευσης

<table data-header-hidden><thead><tr><th width="197">Υπηρεσία Αποθήκευσης</th><th>Τερματικό</th></tr></thead><tbody><tr><td><strong>Blob storage</strong></td><td><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></td></tr><tr><td><strong>Data Lake Storage</strong></td><td><code>https://&#x3C;storage-account>.dfs.core.windows.net</code></td></tr><tr><td><strong>Azure Files</strong></td><td><code>https://&#x3C;storage-account>.file.core.windows.net</code></td></tr><tr><td><strong>Queue storage</strong></td><td><code>https://&#x3C;storage-account>.queue.core.windows.net</code></td></tr><tr><td><strong>Table storage</strong></td><td><code>https://&#x3C;storage-account>.table.core.windows.net</code></td></tr></tbody></table>

### Δημόσια Έκθεση

Αν η "Επιτρέπεται η δημόσια πρόσβαση Blob" είναι **ενεργοποιημένη** (απενεργοποιημένη από προεπιλογή), κατά τη δημιουργία ενός δοχείου είναι δυνατή η:

- Παροχή **δημόσιας πρόσβασης για ανάγνωση blobs** (πρέπει να γνωρίζετε το όνομα).
- **Λίστα των blobs του δοχείου** και **ανάγνωση** τους.
- Να γίνει πλήρως **ιδιωτικό**.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfoetUnYBPWQpRrWNnnlbqWpl8Rdoaeg5uBrCVlvcNDlnKwQHjZe8nUb2SfPspBgbu-lCZLmUei-hFi_Jl2eKbaxUtBGTjdUSDmkrcwr90VZkmuMjk9tyh92p75btfyzGiUTa0-=s2048?key=m8TV59TrCFPlkiNnmhYx3aZt" alt=""><figcaption></figcaption></figure>

### Σύνδεση με την Αποθήκευση

Αν βρείτε οποιαδήποτε **αποθήκευση** στην οποία μπορείτε να συνδεθείτε, μπορείτε να χρησιμοποιήσετε το εργαλείο [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) για να το κάνετε.

## Πρόσβαση στην Αποθήκευση <a href="#about-blob-storage" id="about-blob-storage"></a>

### RBAC

Είναι δυνατή η χρήση των αρχών Entra ID με **ρόλους RBAC** για πρόσβαση στους λογαριασμούς αποθήκευσης και είναι η συνιστώμενη μέθοδος.

### Κλειδιά Πρόσβασης

Οι λογαριασμοί αποθήκευσης έχουν κλειδιά πρόσβασης που μπορούν να χρησιμοποιηθούν για την πρόσβαση σε αυτούς. Αυτό παρέχει **πλήρη πρόσβαση στον λογαριασμό αποθήκευσης.**

<figure><img src="../../../images/image (5).png" alt=""><figcaption></figcaption></figure>

### **Κοινά Κλειδιά & Ελαφριά Κοινά Κλειδιά**

Είναι δυνατή η [**δημιουργία Κοινών Κλειδιών**](https://learn.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key) υπογεγραμμένων με τα κλειδιά πρόσβασης για την εξουσιοδότηση πρόσβασης σε συγκεκριμένους πόρους μέσω μιας υπογεγραμμένης διεύθυνσης URL.

> [!NOTE]
> Σημειώστε ότι το μέρος `CanonicalizedResource` αντιπροσωπεύει τον πόρο υπηρεσιών αποθήκευσης (URI). Και αν οποιοδήποτε μέρος στη διεύθυνση URL είναι κωδικοποιημένο, θα πρέπει επίσης να είναι κωδικοποιημένο μέσα στο `CanonicalizedResource`.

> [!NOTE]
> Αυτό **χρησιμοποιείται από προεπιλογή από το `az` cli** για την πιστοποίηση αιτημάτων. Για να το κάνετε να χρησιμοποιεί τα διαπιστευτήρια της αρχής Entra ID, υποδείξτε την παράμετρο `--auth-mode login`.

- Είναι δυνατή η δημιουργία ενός **κοινού κλειδιού για τις υπηρεσίες blob, queue και file** υπογράφοντας τις παρακάτω πληροφορίες:
```bash
StringToSign = VERB + "\n" +
Content-Encoding + "\n" +
Content-Language + "\n" +
Content-Length + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
If-Modified-Since + "\n" +
If-Match + "\n" +
If-None-Match + "\n" +
If-Unmodified-Since + "\n" +
Range + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
- Είναι δυνατόν να δημιουργηθεί ένα **κοινό κλειδί για τις υπηρεσίες πίνακα** υπογράφοντας τις παρακάτω πληροφορίες:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedResource;
```
- Είναι δυνατόν να δημιουργηθεί ένα **lite shared key για τις υπηρεσίες blob, queue και file** υπογράφοντας τις παρακάτω πληροφορίες:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
- Είναι δυνατόν να δημιουργηθεί ένα **lite shared key για τις υπηρεσίες πίνακα** υπογράφοντας τις παρακάτω πληροφορίες:
```bash
StringToSign = Date + "\n"
CanonicalizedResource
```
Στη συνέχεια, για να χρησιμοποιήσετε το κλειδί, μπορεί να γίνει στην κεφαλίδα Authorization ακολουθώντας τη σύνταξη:
```bash
Authorization="[SharedKey|SharedKeyLite] <AccountName>:<Signature>"
#e.g.
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=

PUT http://myaccount/mycontainer?restype=container&timeout=30 HTTP/1.1
x-ms-version: 2014-02-14
x-ms-date: Fri, 26 Jun 2015 23:39:12 GMT
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=
Content-Length: 0
```
### **Shared Access Signature** (SAS)

Οι Υπογραφές Κοινής Πρόσβασης (SAS) είναι ασφαλή, περιορισμένα χρονικά URLs που **παρέχουν συγκεκριμένα δικαιώματα πρόσβασης σε πόρους** σε έναν λογαριασμό Azure Storage χωρίς να εκθέτουν τα κλειδιά πρόσβασης του λογαριασμού. Ενώ τα κλειδιά πρόσβασης παρέχουν πλήρη διαχειριστική πρόσβαση σε όλους τους πόρους, το SAS επιτρέπει λεπτομερή έλεγχο καθορίζοντας δικαιώματα (όπως ανάγνωση ή εγγραφή) και ορίζοντας χρόνο λήξης.

#### Τύποι SAS

- **User delegation SAS**: Δημιουργείται από έναν **Entra ID principal** που θα υπογράψει το SAS και θα εκχωρήσει τα δικαιώματα από τον χρήστη στο SAS. Μπορεί να χρησιμοποιηθεί μόνο με **blob και data lake storage** ([docs](https://learn.microsoft.com/en-us/rest/api/storageservices/create-user-delegation-sas)). Είναι δυνατή η **ανάκληση** όλων των παραγόμενων SAS που έχουν εκχωρηθεί από χρήστες.
- Ακόμα και αν είναι δυνατό να παραχθεί ένα delegation SAS με "περισσότερα" δικαιώματα από αυτά που έχει ο χρήστης. Ωστόσο, αν ο principal δεν τα έχει, δεν θα λειτουργήσει (χωρίς privesc).
- **Service SAS**: Υπογράφεται χρησιμοποιώντας ένα από τα **access keys** του λογαριασμού αποθήκευσης. Μπορεί να χρησιμοποιηθεί για να παραχωρήσει πρόσβαση σε συγκεκριμένους πόρους σε μια μόνο υπηρεσία αποθήκευσης. Αν το κλειδί ανανεωθεί, το SAS θα σταματήσει να λειτουργεί.
- **Account SAS**: Υπογράφεται επίσης με ένα από τα **access keys** του λογαριασμού αποθήκευσης. Παρέχει πρόσβαση σε πόρους σε όλες τις υπηρεσίες ενός λογαριασμού αποθήκευσης (Blob, Queue, Table, File) και μπορεί να περιλαμβάνει λειτουργίες σε επίπεδο υπηρεσίας.

Ένα SAS URL υπογεγραμμένο με ένα **access key** φαίνεται έτσι:

- `https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Ένα SAS URL υπογεγραμμένο ως **user delegation** φαίνεται έτσι:

- `https://<container_name>.blob.core.windows.net/testing-container?sp=r&st=2024-11-22T15:07:40Z&se=2024-11-22T23:07:40Z&skoid=d77c71a1-96e7-483d-bd51-bd753aa66e62&sktid=fdd066e1-ee37-49bc-b08f-d0e152119b04&skt=2024-11-22T15:07:40Z&ske=2024-11-22T23:07:40Z&sks=b&skv=2022-11-02&spr=https&sv=2022-11-02&sr=c&sig=7s5dJyeE6klUNRulUj9TNL0tMj2K7mtxyRc97xbYDqs%3D`

Σημειώστε μερικές **http params**:

- Η **`se`** παράμετρος υποδεικνύει την **ημερομηνία λήξης** του SAS
- Η **`sp`** παράμετρος υποδεικνύει τα **δικαιώματα** του SAS
- Η **`sig`** είναι η **υπογραφή** που επικυρώνει το SAS

#### Δικαιώματα SAS

Κατά την παραγωγή ενός SAS, είναι απαραίτητο να υποδειχθούν τα δικαιώματα που θα πρέπει να παρέχει. Ανάλογα με το αντικείμενο πάνω στο οποίο παράγεται το SAS, μπορεί να περιλαμβάνονται διαφορετικά δικαιώματα. Για παράδειγμα:

- (a)dd, (c)reate, (d)elete, (e)xecute, (f)ilter_by_tags, (i)set_immutability_policy, (l)ist, (m)ove, (r)ead, (t)ag, (w)rite, (x)delete_previous_version, (y)permanent_delete

## SFTP Support for Azure Blob Storage

Το Azure Blob Storage υποστηρίζει τώρα το Πρωτόκολλο Μεταφοράς Αρχείων SSH (SFTP), επιτρέποντας ασφαλή μεταφορά και διαχείριση αρχείων απευθείας στο Blob Storage χωρίς να απαιτούνται προσαρμοσμένες λύσεις ή προϊόντα τρίτων.

### Κύρια Χαρακτηριστικά

- Υποστήριξη Πρωτοκόλλου: Το SFTP λειτουργεί με λογαριασμούς Blob Storage που είναι διαμορφωμένοι με ιεραρχικό χώρο ονομάτων (HNS). Αυτό οργανώνει τα blobs σε καταλόγους και υποκαταλόγους για ευκολότερη πλοήγηση.
- Ασφάλεια: Το SFTP χρησιμοποιεί τοπικές ταυτότητες χρηστών για την αυθεντικοποίηση και δεν ενσωματώνεται με RBAC ή ABAC. Κάθε τοπικός χρήστης μπορεί να αυθεντικοποιηθεί μέσω:
- Κωδικών πρόσβασης που δημιουργούνται από το Azure
- Δημόσιων-ιδιωτικών ζευγών κλειδιών SSH
- Λεπτομερή Δικαιώματα: Δικαιώματα όπως Ανάγνωση, Εγγραφή, Διαγραφή και Λίστα μπορούν να εκχωρηθούν σε τοπικούς χρήστες για έως 100 κοντέινερ.
- Δικτυακές Σκέψεις: Οι συνδέσεις SFTP γίνονται μέσω της θύρας 22. Το Azure υποστηρίζει δικτυακές διαμορφώσεις όπως τείχη προστασίας, ιδιωτικά endpoints ή εικονικά δίκτυα για την ασφάλιση της κυκλοφορίας SFTP.

### Απαιτήσεις Ρύθμισης

- Ιεραρχικός Χώρος Ονομάτων: Το HNS πρέπει να είναι ενεργοποιημένο κατά τη δημιουργία του λογαριασμού αποθήκευσης.
- Υποστηριζόμενη Κρυπτογράφηση: Απαιτείται η έγκριση αλγορίθμων κρυπτογράφησης από το Microsoft Security Development Lifecycle (SDL) (π.χ. rsa-sha2-256, ecdsa-sha2-nistp256).
- Ρύθμιση SFTP:
- Ενεργοποιήστε το SFTP στον λογαριασμό αποθήκευσης.
- Δημιουργήστε τοπικές ταυτότητες χρηστών με κατάλληλα δικαιώματα.
- Ρυθμίστε τους καταλόγους αρχικής τοποθεσίας για τους χρήστες για να καθορίσετε την αρχική τους τοποθεσία εντός του κοντέινερ.

### Δικαιώματα

| Δικαίωμα              | Σύμβολο | Περιγραφή                          |
| ---------------------- | ------ | ------------------------------------ |
| **Ανάγνωση**          | `r`    | Ανάγνωση περιεχομένου αρχείου.      |
| **Εγγραφή**           | `w`    | Μεταφόρτωση αρχείων και δημιουργία καταλόγων. |
| **Λίστα**             | `l`    | Λίστα περιεχομένων καταλόγων.      |
| **Διαγραφή**          | `d`    | Διαγραφή αρχείων ή καταλόγων.      |
| **Δημιουργία**        | `c`    | Δημιουργία αρχείων ή καταλόγων.    |
| **Τροποποίηση Ιδιοκτησίας** | `o`    | Αλλαγή του κατόχου χρήστη ή ομάδας. |
| **Τροποποίηση Δικαιωμάτων** | `p`    | Αλλαγή ACLs σε αρχεία ή καταλόγους. |

## Enumeration

{{#tabs }}
{{#tab name="az cli" }}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# BLOB STORAGE
## List containers
az storage container list --account-name <name>
## Check if public access is allowed
az storage container show-permission \
--account-name <acc-name> \
-n <container-name>
## Make a container public
az storage container set-permission \
--public-access container \
--account-name <acc-name> \
-n <container-name>
## List blobs in a container
az storage blob list \
--container-name <container name> \
--account-name <account name>
## Download blob
az storage blob download \
--account-name <account name> \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Create container policy
az storage container policy create \
--account-name mystorageaccount \
--container-name mycontainer \
--name fullaccesspolicy \
--permissions racwdl \
--start 2023-11-22T00:00Z \
--expiry 2024-11-22T00:00Z

# QUEUE
az storage queue list --account-name <name>
az storage message peek --account-name <name> --queue-name <queue-name>

# ACCESS KEYS
az storage account keys list --account-name <name>
## Check key policies (expiration time?)
az storage account show -n <name> --query "{KeyPolicy:keyPolicy}"
## Once having the key, it's possible to use it with the argument --account-key
## Enum blobs with account key
az storage blob list \
--container-name <container name> \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw=="
## Download a file using an account key
az storage blob download \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Upload a file using an account key
az storage blob upload \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--file </path/to/local/file>

# SAS
## List access policies
az storage <container|queue|share|table> policy list \
--account-name <acc name> \
--container-name <container name>

## Generate SAS with all permissions using an access key
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
-n <container-name>

## Generate SAS with all permissions using via user delegation
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
--as-user --auth-mode login \
-n <container-name>

## Generate account SAS
az storage account generate-sas \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name>  \
--services qt \
--resource-types sco \
--permissions acdfilrtuwxy

## Use the returned SAS key with the param --sas-token
## e.g.
az storage blob show \
--account-name <account name> \
--container-name <container name> \
--sas-token 'se=2024-12-31T23%3A59%3A00Z&sp=racwdxyltfmei&sv=2022-11-02&sr=c&sig=ym%2Bu%2BQp5qqrPotIK5/rrm7EMMxZRwF/hMWLfK1VWy6E%3D' \
--name 'asd.txt'

#Local-Users
## List users
az storage account local-user list \
--account-name <storage-account-name> \
--resource-group <resource-group-name>
## Get user
az storage account local-user show \
--account-name <storage-account-name> \
--resource-group <resource-group-name> \
--name <local-user-name>

## List keys
az storage account local-user list \
--account-name <storage-account-name> \
--resource-group <resource-group-name>
```
{{#endtab }}

{{#tab name="Az PowerShell" }}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt

# Create a Container Policy
New-AzStorageContainerStoredAccessPolicy `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context `
-Container <container-name> `
-Policy <policy-name> `
-Permission racwdl `
-StartTime (Get-Date "2023-11-22T00:00Z") `
-ExpiryTime (Get-Date "2024-11-22T00:00Z")
#Get Container policy
Get-AzStorageContainerStoredAccessPolicy `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context `
-Container "storageaccount1994container"

# Queue Management
Get-AzStorageQueue -Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context
(Get-AzStorageQueue -Name <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).Context).QueueClient.PeekMessage().Value

#Blob Container
Get-AzStorageBlob -Container <container-name> -Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context
Get-AzStorageBlobContent `
-Container <container-name> `
-Blob <blob-name> `
-Destination <local-path> `
-Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context

Set-AzStorageBlobContent `
-Container <container-name> `
-File <local-file-path> `
-Blob <blob-name> `
-Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context

# Shared Access Signatures (SAS)
Get-AzStorageContainerAcl `
-Container <container-name> `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context

New-AzStorageBlobSASToken `
-Context $ctx `
-Container <container-name> `
-Blob <blob-name> `
-Permission racwdl `
-ExpiryTime (Get-Date "2024-12-31T23:59:00Z")
```
{{#endtab }}
{{#endtabs }}

### Κοινές Χρήσεις Αρχείων

{{#ref}}
az-file-shares.md
{{#endref}}

## Κλιμάκωση Δικαιωμάτων

{{#ref}}
../az-privilege-escalation/az-storage-privesc.md
{{#endref}}

## Μετά την Εκμετάλλευση

{{#ref}}
../az-post-exploitation/az-blob-storage-post-exploitation.md
{{#endref}}

## Επιμονή

{{#ref}}
../az-persistence/az-storage-persistence.md
{{#endref}}

## Αναφορές

- [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
- [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)
- [https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support](https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support)

{{#include ../../../banners/hacktricks-training.md}}
