# Az - Storage Accounts & Blobs

{{#include ../../../banners/hacktricks-training.md}}

## Basiese Inligting

Azure Storage Accounts is fundamentele dienste in Microsoft Azure wat skaalbare, veilige en hoogs beskikbare cloud **bergery vir verskeie datatipes** verskaf, insluitend blobs (binary large objects), files, queues, en tables. Hulle dien as kontainers wat hierdie verskillende stoor-dienste saamgroepeer onder 'n enkele namespace vir maklike bestuur.

**Belangrikste konfigurasie-opsies**:

- Elke storage account moet 'n **unieke naam oor alle Azure** hê.
- Elke storage account word ontplooi in 'n **streek** of in 'n Azure extended zone.
- Dit is moontlik om die **premium** weergawe van die storage account te kies vir beter prestasie.
- Dit is moontlik om te kies tussen **4 tipes redundansie om te beskerm** teen rak-, skyf- en datacenter-**uitval**.

**Sekuriteitskonfigurasie-opsies**:

- **Require secure transfer for REST API operations**: Vereis TLS in enige kommunikasie met die storage.
- **Allows enabling anonymous access on individual containers**: As dit nie toegelaat word nie, sal dit in die toekoms nie moontlik wees om anonymous access te aktiveer nie.
- **Enable storage account key access**: As dit nie geaktiveer is nie, sal toegang met Shared Keys verbied wees.
- **Minimum TLS version**
- **Permitted scope for copy operations**: Allow from any storage account, from any storage account from the same Entra tenant or from storage account with private endpoints in the same virtual network.

**Blob Storage opsies**:

- **Allow cross-tenant replication**
- **Access tier**: Hot (gereeld benaderde data), Cool en Cold (selde benaderde data)

**Netwerk-opsies**:

- **Network access**:
- Allow from all networks
- Allow from selected virtual networks and IP addresses
- Disable public access and use private access
- **Private endpoints**: Dit laat 'n private verbinding na die storage account toe vanaf 'n virtual network

**Data-beskermingsopsies**:

- **Point-in-time restore for containers**: Laat toe om kontainers na 'n vroeër toestand te herstel.
- Dit vereis versioning, change feed, en blob soft delete om geaktiveer te wees.
- **Enable soft delete for blobs**: Aktiveer 'n retensieperiode in dae vir verwyderde blobs (selfs oorskryfde).
- **Enable soft delete for containers**: Aktiveer 'n retensieperiode in dae vir verwyderde containers.
- **Enable soft delete for file shares**: Aktiveer 'n retensieperiode in dae vir verwyderde file shares.
- **Enable versioning for blobs**: Handhaaf vorige weergawes van jou blobs.
- **Enable blob change feed**: Hou logs van create-, modification- en delete-wijzigings aan blobs.
- **Enable version-level immutability support**: Laat toe om 'n tydgebaseerde retensiebeleid op rekeningvlak in te stel wat op alle blob-weergawes toegepas sal word.
- Version-level immutability support en point-in-time restore for containers kan nie terselfdertyd geaktiveer word nie.

**Enkripsie-konfigurasie-opsies**:

- **Encryption type**: Dit is moontlik om Microsoft-managed keys (MMK) of Customer-managed keys (CMK) te gebruik.
- **Enable infrastructure encryption**: Laat toe om die data dubbel te enkripteer "vir meer sekuriteit".

### Storage endpoints

<table data-header-hidden><thead><tr><th width="197">Bergingdiens</th><th>Eindpunt</th></tr></thead><tbody><tr><td><strong>Blob storage</strong></td><td><code>https://&lt;storage-account&gt;.blob.core.windows.net</code><br><br><code>https://&lt;stg-acc&gt;.blob.core.windows.net/&lt;container-name&gt;?restype=container&comp=list</code></td></tr><tr><td><strong>Data Lake Storage</strong></td><td><code>https://&lt;storage-account&gt;.dfs.core.windows.net</code></td></tr><tr><td><strong>Azure Files</strong></td><td><code>https://&lt;storage-account&gt;.file.core.windows.net</code></td></tr><tr><td><strong>Queue storage</strong></td><td><code>https://&lt;storage-account&gt;.queue.core.windows.net</code></td></tr><tr><td><strong>Table storage</strong></td><td><code>https://&lt;storage-account&gt;.table.core.windows.net</code></td></tr></tbody></table>

### Openbare blootstelling

As "Allow Blob public access" **enabled** is (disabled by default), is dit wanneer 'n container geskep word moontlik om:

- Gee **public access to read blobs** (jy moet die naam ken).
- **List container blobs** en dit **read**.
- Maak dit volledig **private**.

<figure><img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfoetUnYBPWQpRrWNnnlbqWpl8Rdoaeg5uBrCVlvcNDlnKwQHjZe8nUb2SfPspBgbu-lCZLmUei-hFi_Jl2eKbaxUtBGTjdUSDmkrcwr90VZkmuMjk9tyh92p75btfyzGiUTa0-=s2048?key=m8TV59TrCFPlkiNnmhYx3aZt" alt=""><figcaption></figcaption></figure>

#### Ouditering van anonieme blob-blootstelling

- **Lokaliseer storage accounts** wat data kan blootstel: `az storage account list | jq -r '.[] | select(.properties.allowBlobPublicAccess==true) | .name'`. As `allowBlobPublicAccess` `false` is, kan jy nie kontainers publiek maak nie.
- **Inspekteer risikobelate rekeninge** om die vlag en ander swak instellings te bevestig: `az storage account show --name <acc> --query '{allow:properties.allowBlobPublicAccess, minTls:properties.minimumTlsVersion}'`.
- **Enumereer container-vlak blootstelling** waar die vlag geaktiveer is:
```bash
az storage container list --account-name <acc> \
--query '[].{name:name, access:properties.publicAccess}'
```
- `"Blob"`: anonieme lees toegelaat **slegs wanneer die blob-naam bekend is** (geen lysing nie).
- `"Container"`: anonieme **lys + lees** van elke blob.
- `null`: privaat; verifikasie benodig.
- **Bewys toegang** sonder geloofsbriewe:
- As `publicAccess` op `Container` gestel is, werk anonieme lysing: `curl "https://<acc>.blob.core.windows.net/<container>?restype=container&comp=list"`.
- Vir beide `Blob` en `Container` werk anonieme blob-aflaai wanneer die naam bekend is:
```bash
az storage blob download -c <container> -n <blob> --account-name <acc> --file /dev/stdout
# or via raw HTTP
curl "https://<acc>.blob.core.windows.net/<container>/<blob>"
```
### Verbind met Storage

As jy enige **storage** vind waarmee jy kan verbind, kan jy die hulpmiddel [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) daarvoor gebruik.

## Toegang tot Storage <a href="#about-blob-storage" id="about-blob-storage"></a>

### RBAC

Dit is moontlik om Entra ID-principals met **RBAC roles** te gebruik om toegang tot storage accounts te kry en dit is die aanbevole manier.

### Access Keys

Die storage accounts het toegangssleutels wat gebruik kan word om toegang daartoe te kry. Dit verskaf **volledige toegang tot die storage account.**

<figure><img src="../../../images/image (5).png" alt=""><figcaption></figcaption></figure>

### **Shared Keys & Lite Shared Keys**

Dit is moontlik om [**generate Shared Keys**](https://learn.microsoft.com/en-us/rest/api/storageservices/authorize-with-shared-key) te skep, gesigneer met die toegangssleutels, om toegang tot sekere bronne via 'n signed URL te magtig.

> [!NOTE]
> Let daarop dat die `CanonicalizedResource`-gedeelte die storage services hulpbron (URI) voorstel. En as enige deel in die URL geënkodeer is, moet dit ook binne die `CanonicalizedResource` geënkodeer wees.

> [!NOTE]
> Hierdie word **standaard deur die `az` cli gebruik** om versoeke te verifieer. Om dit die Entra ID principal credentials te laat gebruik, gee die parameter `--auth-mode login` aan.

- Dit is moontlik om 'n **shared key vir blob, queue and file services** te genereer deur die volgende inligting te teken:
```bash
StringToSign = VERB + "\n" +
Content-Encoding + "\n" +
Content-Language + "\n" +
Content-Length + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
If-Modified-Since + "\n" +
If-Match + "\n" +
If-None-Match + "\n" +
If-Unmodified-Since + "\n" +
Range + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
- Dit is moontlik om 'n **shared key for table services** te genereer deur die volgende inligting te onderteken:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedResource;
```
- Dit is moontlik om 'n **lite shared key for blob, queue and file services** te genereer deur die volgende inligting te onderteken:
```bash
StringToSign = VERB + "\n" +
Content-MD5 + "\n" +
Content-Type + "\n" +
Date + "\n" +
CanonicalizedHeaders +
CanonicalizedResource;
```
- Dit is moontlik om 'n **lite shared key for table services** te genereer deur die volgende inligting te onderteken:
```bash
StringToSign = Date + "\n"
CanonicalizedResource
```
Om die sleutel te gebruik, kan dit in die Authorization-header gedoen word volgens die volgende sintaksis:
```bash
Authorization="[SharedKey|SharedKeyLite] <AccountName>:<Signature>"
#e.g.
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=

PUT http://myaccount/mycontainer?restype=container&timeout=30 HTTP/1.1
x-ms-version: 2014-02-14
x-ms-date: Fri, 26 Jun 2015 23:39:12 GMT
Authorization: SharedKey myaccount:ctzMq410TV3wS7upTBcunJTDLEJwMAZuFPfr0mrrA08=
Content-Length: 0
```
### **Shared Access Signature** (SAS)

Shared Access Signatures (SAS) is veilige, tydelik-beperkte URL's wat **spesifieke toestemmings gee om toegang tot hulpbronne** in 'n Azure Storage-rekening sonder om die rekening se toegangssleutels bloot te stel. Terwyl toegangssleutels volle administratiewe toegang tot alle hulpbronne gee, laat SAS fynkorrelbeheer toe deur permissies (soos read of write) te spesifiseer en 'n vervaldatum te definieer.

#### SAS Types

- **User delegation SAS**: Dit word geskep vanaf 'n **Entra ID principal** wat die SAS sal onderteken en die permissies van die gebruiker na die SAS sal delegeer. Dit kan slegs gebruik word met **blob and data lake storage** ([docs](https://learn.microsoft.com/en-us/rest/api/storageservices/create-user-delegation-sas)). Dit is moontlik om alle gegenereerde user delegated SAS te **revoke**.
- Dit is selfs moontlik om 'n delegation SAS te genereer met "meer" permissies as dié wat die gebruiker het. Indien die principal egter nie daardie permissies het nie, sal dit nie werk nie (geen privesc).
- **Service SAS**: Dit word onderteken met een van die storage account **access keys**. Dit kan gebruik word om toegang tot spesifieke hulpbronne in 'n enkele storage service te verleen. As die sleutel vernuwe word, sal die SAS ophou werk.
- **Account SAS**: Dit word ook onderteken met een van die storage account **access keys**. Dit verleen toegang tot hulpbronne oor 'n storage account se dienste (Blob, Queue, Table, File) en kan service-level operasies insluit.

A SAS URL signed by an **access key** looks like this:

- `https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

A SAS URL signed as a **user delegation** looks like this:

- `https://<container_name>.blob.core.windows.net/testing-container?sp=r&st=2024-11-22T15:07:40Z&se=2024-11-22T23:07:40Z&skoid=d77c71a1-96e7-483d-bd51-bd753aa66e62&sktid=fdd066e1-ee37-49bc-b08f-d0e152119b04&skt=2024-11-22T15:07:40Z&ske=2024-11-22T23:07:40Z&sks=b&skv=2022-11-02&spr=https&sv=2022-11-02&sr=c&sig=7s5dJyeE6klUNRulUj9TNL0tMj2K7mtxyRc97xbYDqs%3D`

Let op sommige **http params**:

- Die **`se`**-param dui die **vervaldatum** van die SAS aan
- Die **`sp`**-param dui die **permissions** van die SAS aan
- Die **`sig`** is die **signature** wat die SAS valideer

#### SAS permissions

Wanneer 'n SAS gegenereer word, moet die permissies wat dit moet verleen aangedui word. Afhangend van die objek waarop die SAS gegenereer word, kan verskillende permissies ingesluit wees. Byvoorbeeld:

- (a)dd, (c)reate, (d)elete, (e)xecute, (f)ilter_by_tags, (i)set_immutability_policy, (l)ist, (m)ove, (r)ead, (t)ag, (w)rite, (x)delete_previous_version, (y)permanent_delete

## SFTP Support for Azure Blob Storage

Azure Blob Storage ondersteun nou die SSH File Transfer Protocol (SFTP), wat veilige lêeroordrag en bestuur direkte na Blob Storage moontlik maak sonder dat maatgemaakte oplossings of derdeparty-produkte nodig is.

### Key Features

- Protocol Support: SFTP werk met Blob Storage-rekeninge wat met hierarchical namespace (HNS) gekonfigureer is. Dit organiseer blobs in gidse en subgidse vir makliker navigasie.
- Security: SFTP gebruik plaaslike gebruikersidentiteite vir verifikasie en integreer nie met RBAC of ABAC nie. Elke plaaslike gebruiker kan verifieer via:
- Azure-generated passwords
- Public-private SSH key pairs
- Granular Permissions: Permissions such as Read, Write, Delete, and List kan aan plaaslike gebruikers toegekend word vir tot 100 containers.
- Networking Considerations: SFTP-verbindinge gebruik poort 22. Azure ondersteun netwerkkonfigurasies soos firewalls, private endpoints of virtual networks om SFTP-verkeer te beveilig.

### Setup Requirements

- Hierarchical Namespace: HNS moet geaktiveer wees wanneer die storage account geskep word.
- Supported Encryption: Vereis kriptografiese algoritmes goedgekeur deur die Microsoft Security Development Lifecycle (SDL) (bv. rsa-sha2-256, ecdsa-sha2-nistp256).
- SFTP Configuration:
- Enable SFTP on the storage account.
- Create local user identities with appropriate permissions.
- Configure home directories for users to define their starting location within the container.

### Permissions

| Permission             | Symbol | Description                          |
| ---------------------- | ------ | ------------------------------------ |
| **Read**               | `r`    | Lees die inhoud van 'n lêer.         |
| **Write**              | `w`    | Oplaai lêers en skep gidse.          |
| **List**               | `l`    | Lys inhoud van gidse.                |
| **Delete**             | `d`    | Verwyder lêers of gidse.             |
| **Create**             | `c`    | Skep lêers of gidse.                 |
| **Modify Ownership**   | `o`    | Verander die eienaar gebruiker of groep. |
| **Modify Permissions** | `p`    | Verander ACL's op lêers of gidse.    |

## Enumerasie

{{#tabs }}
{{#tab name="az cli" }}

<details>
<summary>az cli enumerasie</summary>
```bash
# Get storage accounts
az storage account list #Get the account name from here

# BLOB STORAGE
## List containers
az storage container list --account-name <name>
## Check if public access is allowed
az storage container show-permission \
--account-name <acc-name> \
-n <container-name>
## Make a container public
az storage container set-permission \
--public-access container \
--account-name <acc-name> \
-n <container-name>
## List blobs in a container
az storage blob list \
--container-name <container name> \
--account-name <account name>
## Download blob
az storage blob download \
--account-name <account name> \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Create container policy
az storage container policy create \
--account-name mystorageaccount \
--container-name mycontainer \
--name fullaccesspolicy \
--permissions racwdl \
--start 2023-11-22T00:00Z \
--expiry 2024-11-22T00:00Z

# QUEUE
az storage queue list --account-name <name>
az storage message peek --account-name <name> --queue-name <queue-name>

# ACCESS KEYS
az storage account keys list --account-name <name>
## Check key policies (expiration time?)
az storage account show -n <name> --query "{KeyPolicy:keyPolicy}"
## Once having the key, it's possible to use it with the argument --account-key
## Enum blobs with account key
az storage blob list \
--container-name <container name> \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw=="
## Download a file using an account key
az storage blob download \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--name <blob name> \
--file </path/to/local/file>
## Upload a file using an account key
az storage blob upload \
--account-name <account name> \
--account-key "ZrF40pkVKvWPUr[...]v7LZw==" \
--container-name <container name> \
--file </path/to/local/file>

# SAS
## List access policies
az storage <container|queue|share|table> policy list \
--account-name <acc name> \
--container-name <container name>

## Generate SAS with all permissions using an access key
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
-n <container-name>

## Generate SAS with all permissions using via user delegation
az storage <container|queue|share|table|blob> generate-sas \
--permissions acdefilmrtwxy \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name> \
--as-user --auth-mode login \
-n <container-name>

## Generate account SAS
az storage account generate-sas \
--expiry 2024-12-31T23:59:00Z \
--account-name <acc-name>  \
--services qt \
--resource-types sco \
--permissions acdfilrtuwxy

## Use the returned SAS key with the param --sas-token
## e.g.
az storage blob show \
--account-name <account name> \
--container-name <container name> \
--sas-token 'se=2024-12-31T23%3A59%3A00Z&sp=racwdxyltfmei&sv=2022-11-02&sr=c&sig=ym%2Bu%2BQp5qqrPotIK5/rrm7EMMxZRwF/hMWLfK1VWy6E%3D' \
--name 'asd.txt'

#Local-Users
## List users
az storage account local-user list \
--account-name <storage-account-name> \
--resource-group <resource-group-name>
## Get user
az storage account local-user show \
--account-name <storage-account-name> \
--resource-group <resource-group-name> \
--name <local-user-name>

## List keys
az storage account local-user list \
--account-name <storage-account-name> \
--resource-group <resource-group-name>
```
</details>

{{#endtab }}

{{#tab name="Az PowerShell" }}

<details>
<summary>Az PowerShell enumerasie</summary>
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt

# Create a Container Policy
New-AzStorageContainerStoredAccessPolicy `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context `
-Container <container-name> `
-Policy <policy-name> `
-Permission racwdl `
-StartTime (Get-Date "2023-11-22T00:00Z") `
-ExpiryTime (Get-Date "2024-11-22T00:00Z")
#Get Container policy
Get-AzStorageContainerStoredAccessPolicy `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context `
-Container "storageaccount1994container"

# Queue Management
Get-AzStorageQueue -Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context
(Get-AzStorageQueue -Name <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).Context).QueueClient.PeekMessage().Value

#Blob Container
Get-AzStorageBlob -Container <container-name> -Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context
Get-AzStorageBlobContent `
-Container <container-name> `
-Blob <blob-name> `
-Destination <local-path> `
-Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context

Set-AzStorageBlobContent `
-Container <container-name> `
-File <local-file-path> `
-Blob <blob-name> `
-Context $(Get-AzStorageAccount -name "teststorageaccount1998az" -ResourceGroupName "testStorageGroup").Context

# Shared Access Signatures (SAS)
Get-AzStorageContainerAcl `
-Container <container-name> `
-Context (Get-AzStorageAccount -Name <NAME> -ResourceGroupName <NAME>).Context

New-AzStorageBlobSASToken `
-Context $ctx `
-Container <container-name> `
-Blob <blob-name> `
-Permission racwdl `
-ExpiryTime (Get-Date "2024-12-31T23:59:00Z")
```
</details>

{{#endtab }}
{{#endtabs }}

### Lêerdelings

{{#ref}}
az-file-shares.md
{{#endref}}

## Privilege Escalation

{{#ref}}
../az-privilege-escalation/az-storage-privesc.md
{{#endref}}

## Post Exploitation

{{#ref}}
../az-post-exploitation/az-blob-storage-post-exploitation.md
{{#endref}}

## Persistence

{{#ref}}
../az-persistence/az-storage-persistence.md
{{#endref}}

## Verwysings

- [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
- [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)
- [https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support](https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support)
- [Holiday Hack Challenge 2025: Blob Storage (Storage Secrets)](https://0xdf.gitlab.io/holidayhack2025/act1/blob-storage)
- [https://learn.microsoft.com/en-us/cli/azure/storage/account](https://learn.microsoft.com/en-us/cli/azure/storage/account)
- [https://learn.microsoft.com/en-us/cli/azure/storage/container](https://learn.microsoft.com/en-us/cli/azure/storage/container)
- [https://learn.microsoft.com/en-us/cli/azure/storage/blob](https://learn.microsoft.com/en-us/cli/azure/storage/blob)

{{#include ../../../banners/hacktricks-training.md}}
