# Az - Logic Apps

{{#include ../../../banners/hacktricks-training.md}}

## Basic Information

Azure Logic Apps is a cloud-based service provided by Microsoft Azure that enables developers to **create and run workflows that integrate various services**, data sources, and applications. These workflows are designed to **automate business processes**, orchestrate tasks, and perform data integrations across different platforms.

Logic Apps provides a visual designer to create workflows with a **wide range of pre-built connectors**, which makes it easy to connect to and interact with various services, such as Office 365, Dynamics CRM, Salesforce, and many others. You can also create custom connectors for your specific needs.

When creating a Logic App, you must either create or link an external storage account that stores the workflow state, run history, and artifacts. This storage can be configured with diagnostic settings for monitoring and can be secured with network access restrictions or integrated into a virtual network to control inbound and outbound traffic.

### Examples

- **Automating Data Pipelines**: Logic Apps can automate **data transfer and transformation processes** in combination with Azure Data Factory. This is useful for creating scalable and reliable data pipelines that move and transform data between various data stores, like Azure SQL Database and Azure Blob Storage, aiding in analytics and business intelligence operations.
- **Integrating with Azure Functions**: Logic Apps can work alongside Azure Functions to develop **sophisticated, event-driven applications that scale as needed** and integrate seamlessly with other Azure services. An example use case is using a Logic App to trigger an Azure Function in response to certain events, such as changes in an Azure Storage account, allowing for dynamic data processing.

### Visualize a LogicAPP

It's possible to view a LogicApp with graphics:

<figure><img src="../../../images/image (197).png" alt=""><figcaption></figcaption></figure>

or to check the code in the "**Logic app code view**" section.

### SSRF Protection

Even if you find the **Logic App vulnerable to SSRF**, you won't be able to access the credentials from the metadata as Logic Apps doesn't allow that.

For example, something like this won't return the token:

```bash
# The URL belongs to a Logic App vulenrable to SSRF
curl -XPOST 'https://prod-44.westus.logic.azure.com:443/workflows/2d8de4be6e974123adf0b98159966644/triggers/manual/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=_8_oqqsCXc0u2c7hNjtSZmT0uM4Xi3hktw6Uze0O34s' -d '{"url": "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"}' -H "Content-type: application/json" -v
```

### Hosting options

There are several hosting options:

* **Consumption**
    - **Multi-tenant**: provides shared compute resources, operates in the public cloud, and follows a pay-per-operation pricing model. This is ideal for lightweight and cost-effective workloads. This deploys a "Single Worlfow".
* **Standard**
    - **Workflow Service Plan**: dedicated compute resources with VNET integration for networking and charges per workflow service plan instance. It is suitable for more demanding workloads requiring greater control.
    - **App Service Environment V3** dedicated compute resources with full isolation and scalability. It also integrates with VNET for networking and uses a pricing model based on App Service instances within the environment. 
    - **Hybrid** designed for local processing and multi-cloud support. It allows customer-managed compute resources with local network access and utilizes Kubernetes Event-Driven Autoscaling (KEDA). It relies on a Container App Connected Environment.

### Key Features
- **Storage**: Logic Apps require an external Azure Storage account to store workflow state, run history… and must be in the same resource group as the Logic App.
- **Networking & Security**: Logic Apps can be configured with public or private access. By default, the app is open to the internet but can be integrated with an Azure Virtual Network for isolated connectivity. 
- **Application Insights**: Application Performance Management (APM) through Azure Monitor Application Insights can be enabled to track performance, detect anomalies, and provide analytics.
- **Access Control**: Logic apps support System Managed Identities & User Managed Identities.

### "Single" Workflows

A **workflow** is a structured sequence of automated steps or tasks that execute a specific process or objective. It defines how different actions, conditions, and decisions interact to achieve a desired outcome, streamlining operations and reducing manual effort. Workflows can integrate multiple systems, trigger events, and rules, ensuring consistency and efficiency in processes.

Azure Logic apps gives the functionality of **creating a single workflow without the need of a Logic App** itself. 

Each workflow has different **triggers**. These triggers are the steps that the workflow follows. Each trigger have their parameters that can vary depending on the type of the trigger:
 - Connection name
 - **Authentication Type** than can be, Access Key, Microsoft Entra ID, Integrated Service principal authentication and Logic Apps Managed Identity.

Triggers also have various settings:
 - Schema Validation: Ensures incoming data follows a predefined structure.
 - Concurrency Control: Limits the number of parallel runs 
 - Trigger Conditions: conditions that must be met before the trigger fires.
 - Networking: Configures chunk size for data transfer and allows suppressing workflow headers in responses.
 - **Security**: Enables **Secure Inputs/Outputs to hide** sensitive data in logs and the outputs.

**Settings & API Conections:**

A workflow has different settings such:
 - Allowed inbound IP addresses: This setting lets you restrict who can trigger or start your Logic App. The options are Any IP, Only other Logic Apps and Specific IP ranges.
 - Integration account: Here, you can link your Logic App to an Integration Account.
 - High throughput: This setting enables your Logic App to handle more requests quickly. 
 - Run history retention: for how long the history of your Logic App's executions is kept.
 
You can see the different API connections the workflow has. Inside each of these connections they have different properties and the possibility of edit the API connection where the Authentication type can be changed.

**History & Versions:**
It has the option to access **history** of the different executions, it shows, Settings, Output, Parameters and the Code.

Also has the option of accessing different **versions** of the workflow, where you can check the code and change the present workflow with an older version of it.

**Authorization:**
Azure Logic Apps support **authorization policies** with Entra ID to secure request-based triggers by requiring a valid access token. This token must include specific claims:
 - Issuer (iss) to verify the identity provider
 - Audience (aud) to ensure the token is intended for the Logic App 
 - Subject (sub) to identify the caller
 - JWT ID (JSON Web Token identifier)
 - Custom Claim

When a request is received, Logic Apps validates the token against these claims and allows execution only if they match the configured policy. This can be used to allow another tenant to trigger the workflow or deny trigger from other sources, for example just allowing the trigger if comes from https://login.microsoftonline.com/.

**Access Keys:**
When you save a request-based trigger for the first time, Logic Apps automatically creates a unique endpoint with a SAS signature (created from the Access Key) that grants permission to call the workflow. This SAS signature is embedded in the trigger’s URL. This key can be regenerated and it will give new SAS signature, but the keys can not be listed.

The URL to invoke it with the Access Key:

https://<region>.logic.azure.com:443/workflows/<workflow-id>/triggers/<trigger-name>/paths/invoke?api-version=<api-version>&sp=%2Ftriggers%2F<trigger-name>%2Frun&sv=<version>&sig=<signature>

### Enumeration

{{#tabs }}
{{#tab name="az cli" }}
```bash
# List
az logic workflow list --resource-group <ResourceGroupName> 
# Get info
az logic workflow show --name <LogicAppName> --resource-group <ResourceGroupName> 

# Get details of a specific Logic App workflow, including its connections and parameters
az rest \
  --method GET \
  --uri "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Logic/workflows/{workflowName}?api-version=2016-10-01&$expand=connections.json,parameters.json" \
  --headers "Content-Type=application/json"

# Get details about triggers for a specific Logic App
az rest --method GET \
  --uri "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Logic/workflows/{logicAppName}/triggers?api-version=2016-06-01"

# Get the callback URL for a specific trigger in a Logic App
az rest --method POST \
  --uri "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Logic/workflows/{logicAppName}/triggers/{triggerName}/listCallbackUrl?api-version=2016-06-01"

# Get the history of a specific trigger in a Logic App
az rest --method GET \
  --uri "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Logic/workflows/{logicAppName}/triggers/{triggerName}/histories?api-version=2016-06-01"

# List all runs of a specific Logic App workflow
az rest \
  --method GET \
  --uri "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Logic/workflows/{workflowName}/runs?api-version=2016-06-01" \
  --headers "Content-Type=application/json"

# Get all actions within a specific run of a Logic App workflow
az rest \
  --method GET \
  --uri "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Logic/workflows/{workflowName}/runs/{runName}/actions?api-version=2016-06-01" \
  --headers "Content-Type=application/json"

# List all versions of a specific Logic App workflow
az rest \
  --method GET \
  --uri "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Logic/workflows/{workflowName}/versions?api-version=2016-06-01" \
  --headers "Content-Type=application/json"

# Get details of a specific version of a Logic App workflow
az rest \
  --method GET \
  --uri "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Logic/workflows/{workflowName}/versions/{versionName}?api-version=2016-06-01" \
  --headers "Content-Type=application/json"

# List all Logic Apps in the specified resource group
az logicapp list --resource-group <ResourceGroupName>

# Show detailed information about a specific Logic App
az logicapp show --name <LogicAppName> --resource-group <ResourceGroupName>

# List all application settings for a specific Logic App
az logicapp config appsettings list --name <LogicAppName> --resource-group <ResourceGroupName>

# Get a Parameters from an Azure App Service using Azure REST API
az rest --method GET --url "https://management.azure.com/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.Web/sites/{app-service-name}/hostruntime/admin/vfs/parameters.json?api-version=2018-11-01&relativepath=1"

# Get webhook-triggered workflows from an Azure Logic App using Azure REST API
az rest --method GET --url "https://management.azure.com/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.Web/sites/{logic-app-name}/hostruntime/runtime/webhooks/workflow/api/management/workflows?api-version=2018-11-01"

# Get workflows from an Azure Logic App using Azure REST API
az rest --method GET --url "https://management.azure.com/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.Web/sites/{logic-app-name}/workflows?api-version=2018-11-01"

# Get details of a specific workflow including its connections and parameters in Azure Logic Apps using Azure REST API
az rest --method GET --uri "https://management.azure.com/subscriptions/{subscription-id}/resourceGroups/{resource-group-name}/providers/Microsoft.Web/sites/{logic-app-name}/workflows/{workflow-name}?api-version=2018-11-01&\$expand=connections.json,parameters.json"


```
{{#endtab }}

{{#tab name="Az Powershell" }}

```bash
Get-Command -Module Az.LogicApp

# List
Get-AzLogicApp -ResourceGroupName <ResourceGroupName>
# Get info
Get-AzLogicApp -ResourceGroupName <ResourceGroupName> -Name <LogicAppName>

# Get details of a specific Logic App workflow run action
Get-AzLogicAppRunAction -ResourceGroupName "<ResourceGroupName>" -Name "<LogicAppName>" -RunName "<RunName>"

# Get the run history for a specific Logic App
Get-AzLogicAppRunHistory -ResourceGroupName "<ResourceGroupName>" -Name "<LogicAppName>"

# Get details about triggers for a specific Logic App
Get-AzLogicAppTrigger -ResourceGroupName "<ResourceGroupName>" -Name "<LogicAppName>"

# Get the callback URL for a specific trigger in a Logic App
Get-AzLogicAppTriggerCallbackUrl -ResourceGroupName "<ResourceGroupName>" -LName "<LogicAppName>" -TriggerName "<TriggerName>"

# Get the history of a specific trigger in a Logic App
Get-AzLogicAppTriggerHistory -ResourceGroupName "<ResourceGroupName>" -Name "<LogicAppName>" -TriggerName "<TriggerName>"

```
{{#endtab }}
{{#endtabs }}



### Integration Accounts
**Integration Accounts**, are a feature of Azure Logic Apps. Integration Accounts are used to facilitate enterprise-level integrations by enabling advanced B2B capabilities, such as EDI, AS2, and XML schema management. Integration Accounts are a container in Azure that store the following artifacts used for Logic Apps:

* Schemas: Manage XML schemas for validating and processing messages in your integration account.
* Maps: Configure XSLT-based transformations to convert data formats within your integration workflows.
* Assemblies: Manage integration account assemblies to streamline logic and data processing.
* Certificates: Handle certificates for encrypting and signing messages, ensuring secure communication.
* Partners: Manage trading partner information for B2B transactions, enabling seamless integrations.
* Agreements: Configure rules and settings for exchanging data with trading partners (e.g., EDI, AS2).
* Batch Configurations: Manage batch processing configurations to group and process messages efficiently.
* RosettaNet PIP: Configure RosettaNet Partner Interface Processes (PIPs) for standardizing B2B communication.

#### Enumeration

{{#tabs }}
{{#tab name="az cli" }}
```bash
# Integration account
az logic integration-account list --resource-group <resource-group-name>
az logic integration-account show --resource-group <resource-group-name> --name <integration-account-name>
az logic integration-account list-callback-url --resource-group <resource-group-name> --integration-account-name <integration-account-name>

# Batch-configuration
az logic integration-account batch-configuration list \
  --resource-group <resource-group-name> \
  --integration-account-name <integration-account-name>

az logic integration-account batch-configuration show \
  --resource-group <resource-group-name> \
  --integration-account-name <integration-account-name> \
  --batch-configuration-name <batch-configuration-name>

# Map
az logic integration-account map list \
  --resource-group <resource-group-name> \
  --integration-account <integration-account-name>

az logic integration-account map show \
  --resource-group <resource-group-name> \
  --integration-account <integration-account-name> \
  --map-name <map-name>

# Partner
az logic integration-account partner list \
  --resource-group <resource-group-name> \
  --integration-account <integration-account-name>

az logic integration-account partner show \
  --resource-group <resource-group-name> \
  --integration-account <integration-account-name> \
  --name <partner-name>

# Session
az logic integration-account session list \
  --resource-group <resource-group-name> \
  --integration-account <integration-account-name>

az logic integration-account session show \
  --resource-group <resource-group-name> \
  --integration-account <integration-account-name> \
  --name <session-name>

# Assembly
# Session
az logic integration-account assembly list \
  --resource-group <resource-group-name> \
  --integration-account <integration-account-name>

az logic integration-account assembly show \
  --resource-group <resource-group-name> \
  --integration-account <integration-account-name> \
  --assembly-artifact-name <assembly-name>


```
{{#endtab }}

{{#tab name="Az Powershell" }}
```powershell
Get-Command -Module Az.LogicApp

# Retrieve details of an integration account
Get-AzIntegrationAccount -ResourceGroupName <resource-group-name> -Name <integration-account-name>

# Retrieve the callback URL of an integration account
Get-AzIntegrationAccountCallbackUrl -ResourceGroupName <resource-group-name> -IntegrationAccountName <integration-account-name>

# Retrieve details of a specific agreement in an integration account
Get-AzIntegrationAccountAgreement -ResourceGroupName <resource-group-name> -IntegrationAccountName <integration-account-name> -Name <agreement-name>

# Retrieve details of a specific assembly in an integration account
Get-AzIntegrationAccountAssembly -ResourceGroupName <resource-group-name> -IntegrationAccountName <integration-account-name> -Name <assembly-name>

# Retrieve details of a specific batch configuration in an integration account
Get-AzIntegrationAccountBatchConfiguration -ResourceGroupName <resource-group-name> -IntegrationAccountName <integration-account-name> -Name <batch-configuration-name>

# Retrieve details of a specific certificate in an integration account
Get-AzIntegrationAccountCertificate -ResourceGroupName <resource-group-name> -IntegrationAccountName <integration-account-name> -Name <certificate-name>

# Retrieve details of a specific map in an integration account
Get-AzIntegrationAccountMap -ResourceGroupName <resource-group-name> -IntegrationAccountName <integration-account-name> -Name <map-name>

# Retrieve details of a specific partner in an integration account
Get-AzIntegrationAccountPartner -ResourceGroupName <resource-group-name> -IntegrationAccountName <integration-account-name> -Name <partner-name>

# Retrieve details of a specific schema in an integration account
Get-AzIntegrationAccountSchema -ResourceGroupName <resource-group-name> -IntegrationAccountName <integration-account-name> -Name <schema-name>
```
{{#endtab }}
{{#endtabs }}


## Privilege Escalation

Same as logic apps privesc:

{{#ref}}
../az-privilege-escalation/az-logic-apps-privesc.md
{{#endref}}

## Post Exploitation

{{#ref}}
../az-post-exploitation/az-logic-apps-post-exploitation.md
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}



