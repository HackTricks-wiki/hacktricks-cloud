# Az - SQL

{{#include ../../../banners/hacktricks-training.md}}

## Azure SQL

Azure SQL ni familia ya bidhaa zinazodhibitiwa, salama, na za akili zinazotumia **injini ya database ya SQL Server katika wingu la Azure**. Hii inamaanisha huna haja ya kuwa na wasiwasi kuhusu usimamizi wa kimwili wa seva zako, na unaweza kuzingatia kusimamia data yako.

Azure SQL ina matoleo makuu matatu:

1. **Azure SQL Database**: Hii ni **huduma ya database inayodhibitiwa kikamilifu**, ambayo inakuwezesha kuhifadhi databases binafsi katika wingu la Azure. Inatoa akili iliyojengwa ndani ambayo inajifunza mifumo yako ya kipekee ya database na inatoa mapendekezo yaliyobinafsishwa na uboreshaji wa moja kwa moja.
2. **Azure SQL Managed Instance**: Hii ni kwa ajili ya matumizi makubwa, yaani, matumizi ya SQL Server kwa kiwango kizima. Inatoa karibu 100% ulinganifu na SQL Server ya hivi punde kwenye tovuti (Enterprise Edition) Database Engine, ambayo inatoa utekelezaji wa mtandao wa asili (VNet) unaoshughulikia wasiwasi wa kawaida wa usalama, na mfano wa biashara unaofaa kwa wateja wa SQL Server kwenye tovuti.
3. **Azure SQL Server kwenye Azure VMs**: Hii ni Miundombinu kama Huduma (IaaS) na ni bora kwa uhamishaji ambapo unataka **udhibiti juu ya mfumo wa uendeshaji na SQL Server instance**, kama ilivyokuwa seva inayofanya kazi kwenye tovuti.

### Azure SQL Database

**Azure SQL Database** ni **jukwaa la database linalodhibitiwa kikamilifu kama huduma (PaaS)** ambalo linatoa suluhisho za database za uhusiano zinazoweza kupanuka na salama. Imejengwa kwenye teknolojia za hivi punde za SQL Server na inondoa haja ya usimamizi wa miundombinu, na kuifanya kuwa chaguo maarufu kwa programu zinazotegemea wingu.

#### Key Features

- **Daima Iko Sawa**: Inafanya kazi kwenye toleo la hivi punde la SQL Server na inapata vipengele na patches mpya kiotomatiki.
- **Uwezo wa PaaS**: Uwezo wa upatikanaji wa juu, nakala za akiba, na masasisho.
- **Flexibility ya Data**: Inasaidia data za uhusiano na zisizo za uhusiano (mfano, grafu, JSON, nafasi, na XML).

#### Models za Ununuzi / Viwango vya Huduma

- **vCore-based**: Chagua kompyuta, kumbukumbu, na uhifadhi kwa uhuru. Kwa matumizi ya Jumla, Biashara Muhimu (ikiwa na uhimilivu wa juu na utendaji kwa programu za OLTP), na inapanuka hadi 128 TB ya uhifadhi.
- **DTU-based**: Inakusanya kompyuta, kumbukumbu, na I/O katika viwango vilivyowekwa. Rasilimali zilizolingana kwa kazi za kawaida.
- Kawaida: Rasilimali zilizolingana kwa kazi za kawaida.
- Premium: Utendaji wa juu kwa kazi zinazohitaji nguvu.

#### Models za Utekelezaji

Azure SQL Database inasaidia chaguzi za utekelezaji zinazoweza kubadilika ili kukidhi mahitaji mbalimbali:

- **Database Moja**:
- Database iliyotengwa kikamilifu yenye rasilimali zake maalum.
- Nzuri kwa microservices au programu zinazohitaji chanzo kimoja cha data.
- **Elastic Pool**:
- Inaruhusu databases nyingi kushiriki rasilimali ndani ya pool.
- Inagharimu kidogo kwa programu zenye mifumo ya matumizi inayobadilika kati ya databases nyingi.

#### Utendaji unaoweza kupanuka na pools

- **Databases Moja**: Kila database imejitegemea na ina rasilimali zake maalum za kompyuta, kumbukumbu, na uhifadhi. Rasilimali zinaweza kupanuliwa kwa njia ya kidinamikia (kuongezeka au kupungua) bila wakati wa kupumzika (1–128 vCores, 32 GB–4 TB uhifadhi, na hadi 128 TB).
- **Elastic Pools**: Shiriki rasilimali kati ya databases nyingi katika pool ili kuongeza ufanisi na kuokoa gharama. Rasilimali zinaweza pia kupanuliwa kwa njia ya kidinamikia kwa pool nzima.
- **Uwezo wa Viwango vya Huduma**: Anza kidogo na database moja katika kiwango cha Jumla. Pandisha hadhi hadi Biashara Muhimu au viwango vya Hyperscale kadri mahitaji yanavyokua.
- **Chaguzi za Kupunguza**: Kupunguza kwa Kidinamikia au Mbadala za Autoscaling.

#### Ufuatiliaji na Uboreshaji wa Ndani

- **Query Store**: Inafuatilia matatizo ya utendaji, inatambua watumiaji wakuu wa rasilimali, na inatoa mapendekezo yanayoweza kutekelezwa.
- **Uboreshaji wa Kiotomatiki**: Inaboresha utendaji kwa njia ya proaktiki kwa vipengele kama vile uundaji wa kiotomatiki wa index na marekebisho ya mpango wa swali.
- **Ushirikiano wa Telemetry**: Inasaidia ufuatiliaji kupitia Azure Monitor, Event Hubs, au Azure Storage kwa maarifa yaliyobinafsishwa.

#### Uokoaji wa Dhara na Upatikanaji

- **Nakala za Kiotomatiki**: SQL Database inafanya nakala za kamili, tofauti, na za kumbukumbu za muamala za databases kiotomatiki.
- **Kurejesha kwa Wakati**: Rejesha databases kwa hali yoyote ya zamani ndani ya kipindi cha uhifadhi wa nakala.
- **Geo-Redundancy**
- **Makundi ya Failover**: Inarahisisha uokoaji wa dharura kwa kuunganisha databases kwa ajili ya failover kiotomatiki kati ya maeneo.

### Azure SQL Managed Instance

**Azure SQL Managed Instance** ni injini ya database kama Huduma (PaaS) inayotoa karibu 100% ulinganifu na SQL Server na inashughulikia kazi nyingi za usimamizi (mfano, kuboresha, kupachika, nakala za akiba, ufuatiliaji) kiotomatiki. Inatoa suluhisho la wingu kwa kuhamasisha databases za SQL Server za kwenye tovuti kwa mabadiliko madogo.

#### Viwango vya Huduma

- **Jumla**: Chaguo linalogharimu kidogo kwa programu zenye mahitaji ya kawaida ya I/O na latency.
- **Biashara Muhimu**: Chaguo la utendaji wa juu lenye latency ya chini ya I/O kwa kazi muhimu.

#### Vipengele vya Usalama vya Juu

* **Ulinzi wa Hatari**: Ulinzi wa Hatari wa Juu unatoa tahadhari kwa shughuli za kushuku na mashambulizi ya SQL injection. Ukaguzi wa kufuatilia na kurekodi matukio ya database kwa ajili ya kufuata sheria.
* **Udhibiti wa Ufikiaji**: Uthibitishaji wa Microsoft Entra kwa usimamizi wa kitambulisho wa kati. Usalama wa Kiwango cha Mstari na Ufunikaji wa Data wa Kidinamikia kwa udhibiti wa ufikiaji wa kina.
* **Nakala za Akiba**: Nakala za akiba za kiotomatiki na za mikono zikiwa na uwezo wa kurejesha kwa wakati.

### Azure SQL Virtual Machines

**Azure SQL Virtual Machines** ni bora kwa uhamishaji ambapo unataka **udhibiti juu ya mfumo wa uendeshaji na SQL Server instance**, kama ilivyokuwa seva inayofanya kazi kwenye tovuti. Inaweza kuwa na ukubwa tofauti wa mashine, na uteuzi mpana wa matoleo na toleo la SQL Server.

#### Key Features

**Nakala za Kiotomatiki**: Panga nakala za akiba kwa databases za SQL.
**Kupachika Kiotomatiki**: Inafanya kiotomatiki usakinishaji wa masasisho ya Windows na SQL Server wakati wa dirisha la matengenezo.
**Ushirikiano wa Azure Key Vault**: Inapanga kiotomatiki Key Vault kwa SQL Server VMs.
**Ushirikiano wa Defender kwa Wingu**: Tazama mapendekezo ya Defender kwa SQL katika lango.
**Flexibility ya Toleo/Toleo**: Badilisha metadata ya toleo au toleo la SQL Server bila kupeleka upya VM.

#### Vipengele vya Usalama

**Microsoft Defender kwa SQL**: Maarifa na tahadhari za usalama.
**Ushirikiano wa Azure Key Vault**: Hifadhi salama ya akidi na funguo za usimbuaji.
**Microsoft Entra (Azure AD)**: Uthibitishaji na udhibiti wa ufikiaji.

## Enumeration

{{#tabs}}
{{#tab name="az cli"}}
```bash
# List Servers
az sql server list # --output table
## List Server Usages
az sql server list-usages --name <server_name> --resource-group <resource_group>
## List Server Firewalls
az sql server firewall-rule list --resource-group <resource_group> --server <server_name>
## List of Azure Active Directory administrators in a server.
az sql server ad-admin list --resource-group <resource_group> --server <server_name>
## Gets an advanced threat protection
az sql server advanced-threat-protection-setting show --resource-group <resource_group> --name <server_name>
## Get server's auditing policy.
az sql server audit-policy show --resource-group <resource_group> --name <server_name>
## Gets a server's secure connection policy.
az sql server conn-policy show --resource-group <resource_group> --server <server_name>
## Gets a list of server DNS aliases for a server.
az sql server dns-alias list --resource-group <resource_group> --server <server_name>
## List of server keys.
az sql server key list --resource-group <resource_group> --server <server_name>
## Gets a server encryption protector.
az sql server tde-key show --resource-group <resource_group> --server <server_name>

# List Databases in a SQL server
az sql db list --server <server_name> --resource-group <resource_group> #--output table
## Get details of a specific database
az sql db show --name <database_name> --server <server_name> --resource-group <resource_group>
## List database usages
az sql db list-usages --name <database_name> --server <server_name> --resource-group <resource_group>
## List of operations performed on the database.
az sql db op list --database <database_name> --server <server_name> --resource-group <resource_group>
## List sql database classification
az sql db classification list --name <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention backups for a SQL database
az sql db ltr-backup list --database <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention policy
az sql db ltr-policy --name <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention policy
az sql db str-policy --name <database_name> --server <server_name> --resource-group <resource_group>
## List the replicas of a database and their replication status
az sql db replica list-links --name <database_name> --server <server_name> --resource-group <resource_group>
## List deleted SQL databases
az sql db list-deleted --server <server_name> --resource-group <resource_group>
## List database usages
az sql db list-usages --name <database_name> --server <server_name> --resource-group <resource_group>
## List restorable dropped databases in a SQL server
az sql db list-deleted --server <server_name> --resource-group <resource_group>
## List advanced threat protection setting show
az sql db advanced-threat-protection-setting --name <database_name> --server <server_name> --resource-group <resource_group>

# List all elastic pools in a SQL server
az sql elastic-pool list --server <server_name> --resource-group <resource_group> #--output table
## List all databases in a specific elastic pool
az sql elastic-pool show --name <elastic_pool_name>  --server <server_name> --resource-group <resource_group>
## List of databases in an elastic pool.
az sql elastic-pool list-dbs --name <elastic_pool_name>  --server <server_name> --resource-group <resource_group>

# List all managed Instances
az sql mi list
az sql mi show --resource-group <res-grp> --name <name>
az sql midb list
az sql midb show --resource-group <res-grp> --name <name>

# Lis all sql VM
az sql vm list
az sql vm show --resource-group <res-grp> --name <name>
```
{{#endtab}}

{{#tab name="Az PowerShell"}}
```powershell
# List Servers
Get-AzSqlServer -ResourceGroupName "<resource-group-name>"

# List All Databases in a SQL Server
Get-AzSqlDatabase -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# Get Details of a Specific Database
Get-AzSqlDatabase -Name "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List Operations Performed on the Database
Get-AzSqlDatabaseActivity -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List SQL Database Classification
Get-AzSqlDatabaseSensitivityClassification -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List Long-Term Retention Backups for a SQL Database
Get-AzSqlDatabaseLongTermRetentionBackup -ResourceGroupName "<resource_group>" -Location "<location>"
# List Replicas of a Database and Their Replication Status
Get-AzSqlDatabaseReplicationLink -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# List Deleted SQL Databases
Get-AzSqlDeletedDatabaseBackup -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List All Elastic Pools in a SQL Server
Get-AzSqlElasticPool -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# List All Databases in a Specific Elastic Pool
Get-AzSqlElasticPoolDatabase -ElasticPoolName "<elastic_pool_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List all managed Instances
Get-AzSqlInstance
Get-AzSqlInstance -ResourceGroupName <ResourceGroupName> -Name <ManagedInstanceName>

# List All Databases in a SQL Managed Instance
Get-AzSqlInstanceDatabase -ResourceGroupName <ResourceGroupName> -InstanceName <ManagedInstanceName>

# Lis all sql VM
Get-AzSqlVM
```
{{#endtab}}
{{#endtabs}}

### Unganisha na kuendesha maswali ya SQL

Unaweza kupata mfuatano wa muunganisho (ukijumuisha akidi) kutoka kwa mfano [kuorodhesha Az WebApp](az-app-services.md):
```powershell
function invoke-sql{
param($query)
$Connection_string = "Server=tcp:supercorp.database.windows.net,1433;Initial Catalog=flag;Persist Security Info=False;User ID=db_read;Password=gAegH!324fAG!#1fht;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
$Connection = New-Object System.Data.SqlClient.SqlConnection $Connection_string
$Connection.Open()
$Command = New-Object System.Data.SqlClient.SqlCommand
$Command.Connection = $Connection
$Command.CommandText = $query
$Reader = $Command.ExecuteReader()
while ($Reader.Read()) {
$Reader.GetValue(0)
}
$Connection.Close()
}

invoke-sql 'Select Distinct TABLE_NAME From information_schema.TABLES;'
```
You can also use sqlcmd to access the database. It is important to know if the server allows public connections `az sql server show --name <server-name> --resource-group <resource-group>`, and also if it the firewall rule let's our IP to access:
```powershell
sqlcmd -S <sql-server>.database.windows.net -U <server-user> -P <server-passworkd> -d <database>
```
## Marejeo

- [https://learn.microsoft.com/en-us/azure/azure-sql/azure-sql-iaas-vs-paas-what-is-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/azure-sql-iaas-vs-paas-what-is-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/database/single-database-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/database/single-database-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/virtual-machines/windows/sql-server-on-azure-vm-iaas-what-is-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/virtual-machines/windows/sql-server-on-azure-vm-iaas-what-is-overview?view=azuresql)

## Kuinua Mamlaka

{{#ref}}
../az-privilege-escalation/az-sql-privesc.md
{{#endref}}

## Baada ya Kutekeleza

{{#ref}}
../az-post-exploitation/az-sql-post-exploitation.md
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
