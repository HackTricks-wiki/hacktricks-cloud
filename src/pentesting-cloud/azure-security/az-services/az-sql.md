# Az - SQL

{{#include ../../../banners/hacktricks-training.md}}

## Azure SQL

Το Azure SQL είναι μια οικογένεια διαχειριζόμενων, ασφαλών και έξυπνων προϊόντων που χρησιμοποιούν την **μηχανή βάσης δεδομένων SQL Server στο Azure cloud**. Αυτό σημαίνει ότι δεν χρειάζεται να ανησυχείτε για τη φυσική διαχείριση των διακομιστών σας και μπορείτε να εστιάσετε στη διαχείριση των δεδομένων σας.

Το Azure SQL αποτελείται από τρεις κύριες προσφορές:

1. **Azure SQL Database**: Αυτή είναι μια **πλήρως διαχειριζόμενη υπηρεσία βάσης δεδομένων**, που σας επιτρέπει να φιλοξενείτε μεμονωμένες βάσεις δεδομένων στο Azure cloud. Προσφέρει ενσωματωμένη νοημοσύνη που μαθαίνει τα μοναδικά πρότυπα της βάσης δεδομένων σας και παρέχει προσαρμοσμένες συστάσεις και αυτόματη ρύθμιση.
2. **Azure SQL Managed Instance**: Αυτό είναι για μεγαλύτερης κλίμακας, πλήρεις αναπτύξεις SQL Server. Παρέχει σχεδόν 100% συμβατότητα με την τελευταία έκδοση του SQL Server on-premises (Enterprise Edition) Database Engine, που προσφέρει μια εγγενή υλοποίηση εικονικού δικτύου (VNet) που αντιμετωπίζει κοινές ανησυχίες ασφαλείας, και ένα επιχειρηματικό μοντέλο ευνοϊκό για τους πελάτες SQL Server on-premises.
3. **Azure SQL Server on Azure VMs**: Αυτό είναι Infrastructure as a Service (IaaS) και είναι καλύτερο για μετεγκαταστάσεις όπου θέλετε **έλεγχο του λειτουργικού συστήματος και της παρουσίας SQL Server**, όπως αν ήταν ένας διακομιστής που λειτουργούσε on-premises.

### Azure SQL Database

**Azure SQL Database** είναι μια **πλήρως διαχειριζόμενη πλατφόρμα βάσης δεδομένων ως υπηρεσία (PaaS)** που παρέχει κλιμακούμενες και ασφαλείς λύσεις σχεσιακής βάσης δεδομένων. Είναι βασισμένη στις τελευταίες τεχνολογίες SQL Server και εξαλείφει την ανάγκη για διαχείριση υποδομών, καθιστώντας την δημοφιλή επιλογή για εφαρμογές που βασίζονται στο cloud.

#### Κύρια Χαρακτηριστικά

- **Πάντα Ενημερωμένο**: Λειτουργεί στην τελευταία σταθερή έκδοση του SQL Server και λαμβάνει αυτόματα νέες δυνατότητες και ενημερώσεις.
- **Δυνατότητες PaaS**: Ενσωματωμένη υψηλή διαθεσιμότητα, αντίγραφα ασφαλείας και ενημερώσεις.
- **Ευελιξία Δεδομένων**: Υποστηρίζει σχεσιακά και μη σχεσιακά δεδομένα (π.χ., γραφήματα, JSON, χωρικά και XML).

#### Μοντέλα Αγοράς / Επίπεδα Υπηρεσιών

- **vCore-based**: Επιλέξτε υπολογιστική ισχύ, μνήμη και αποθήκευση ανεξάρτητα. Για Γενική Χρήση, Επιχειρηματική Κρίσιμη (με υψηλή ανθεκτικότητα και απόδοση για εφαρμογές OLTP), και κλιμακώνεται έως 128 TB αποθήκευσης.
- **DTU-based**: Συνδυάζει υπολογιστική ισχύ, μνήμη και I/O σε σταθερά επίπεδα. Ισορροπημένοι πόροι για κοινές εργασίες.
- Standard: Ισορροπημένοι πόροι για κοινές εργασίες.
- Premium: Υψηλή απόδοση για απαιτητικά φορτία εργασίας.

#### Μοντέλα Ανάπτυξης

Το Azure SQL Database υποστηρίζει ευέλικτες επιλογές ανάπτυξης για να καλύψει διάφορες ανάγκες:

- **Μοναδική Βάση Δεδομένων**:
- Μια πλήρως απομονωμένη βάση δεδομένων με τους δικούς της αφιερωμένους πόρους.
- Ιδανική για μικροϋπηρεσίες ή εφαρμογές που απαιτούν μια μοναδική πηγή δεδομένων.
- **Ελαστική Πισίνα**:
- Επιτρέπει σε πολλές βάσεις δεδομένων να μοιράζονται πόρους εντός μιας πισίνας.
- Οικονομικά αποδοτική για εφαρμογές με μεταβαλλόμενα πρότυπα χρήσης σε πολλές βάσεις δεδομένων.

#### Κλιμακούμενη απόδοση και πισίνες

- **Μοναδικές Βάσεις Δεδομένων**: Κάθε βάση δεδομένων είναι απομονωμένη και έχει τους δικούς της αφιερωμένους πόρους υπολογιστικής ισχύος, μνήμης και αποθήκευσης. Οι πόροι μπορούν να κλιμακωθούν δυναμικά (πάνω ή κάτω) χωρίς διακοπή (1–128 vCores, 32 GB–4 TB αποθήκευση, και έως 128 TB).
- **Ελαστικές Πισίνες**: Μοιράζονται πόροι σε πολλές βάσεις δεδομένων σε μια πισίνα για μέγιστη αποδοτικότητα και εξοικονόμηση κόστους. Οι πόροι μπορούν επίσης να κλιμακωθούν δυναμικά για ολόκληρη την πισίνα.
- **Ευελιξία Επιπέδου Υπηρεσίας**: Ξεκινήστε μικρά με μια μοναδική βάση δεδομένων στο επίπεδο Γενικής Χρήσης. Αναβαθμίστε σε Επιχειρηματική Κρίσιμη ή Υπερ-κλίμακα επίπεδα καθώς οι ανάγκες αυξάνονται.
- **Επιλογές Κλιμάκωσης**: Δυναμική Κλιμάκωση ή Εναλλακτικές Αυτόματης Κλιμάκωσης.

#### Ενσωματωμένη Παρακολούθηση & Βελτιστοποίηση

- **Query Store**: Παρακολουθεί προβλήματα απόδοσης, εντοπίζει τους κορυφαίους καταναλωτές πόρων και προσφέρει εφαρμόσιμες συστάσεις.
- **Αυτόματη Ρύθμιση**: Προληπτικά βελτιστοποιεί την απόδοση με δυνατότητες όπως αυτόματη ευρετηρίαση και διορθώσεις σχεδίων ερωτημάτων.
- **Ενοποίηση Τηλεμετρίας**: Υποστηρίζει παρακολούθηση μέσω Azure Monitor, Event Hubs ή Azure Storage για προσαρμοσμένες πληροφορίες.

#### Ανάκτηση από Καταστροφή & Διαθεσιμότητα

- **Αυτόματα αντίγραφα ασφαλείας**: Η SQL Database εκτελεί αυτόματα πλήρη, διαφορικά και αντίγραφα ασφαλείας αρχείων καταγραφής συναλλαγών.
- **Ανάκτηση Σημείου στο Χρόνο**: Ανάκτηση βάσεων δεδομένων σε οποιαδήποτε προηγούμενη κατάσταση εντός της περιόδου διατήρησης αντιγράφων ασφαλείας.
- **Γεω-Επικαλυπτικότητα**
- **Ομάδες Αποτυχίας**: Απλοποιεί την ανάκτηση από καταστροφή ομαδοποιώντας βάσεις δεδομένων για αυτόματη αποτυχία σε διάφορες περιοχές.

### Azure SQL Managed Instance

**Azure SQL Managed Instance** είναι μια μηχανή βάσης δεδομένων Platform as a Service (PaaS) που προσφέρει σχεδόν 100% συμβατότητα με το SQL Server και χειρίζεται τις περισσότερες διαχειριστικές εργασίες (π.χ., αναβάθμιση, ενημερώσεις, αντίγραφα ασφαλείας, παρακολούθηση) αυτόματα. Παρέχει μια λύση cloud για τη μετεγκατάσταση βάσεων δεδομένων SQL Server on-premises με ελάχιστες αλλαγές.

#### Επίπεδα Υπηρεσιών

- **Γενική Χρήση**: Οικονομική επιλογή για εφαρμογές με τυπικές απαιτήσεις I/O και καθυστέρησης.
- **Επιχειρηματική Κρίσιμη**: Υψηλής απόδοσης επιλογή με χαμηλή καθυστέρηση I/O για κρίσιμα φορτία εργασίας.

#### Προηγμένα Χαρακτηριστικά Ασφαλείας

* **Προστασία από Απειλές**: Προηγμένες ειδοποιήσεις για ύποπτες δραστηριότητες και επιθέσεις SQL injection. Έλεγχος για την παρακολούθηση και καταγραφή γεγονότων βάσης δεδομένων για συμμόρφωση.
* **Έλεγχος Πρόσβασης**: Αυθεντικοποίηση Microsoft Entra για κεντρική διαχείριση ταυτότητας. Ασφάλεια σε επίπεδο γραμμής και Δυναμική Μάσκα Δεδομένων για λεπτομερή έλεγχο πρόσβασης.
* **Αντίγραφα Ασφαλείας**: Αυτοματοποιημένα και χειροκίνητα αντίγραφα ασφαλείας με δυνατότητα ανάκτησης σημείου στο χρόνο.

### Azure SQL Virtual Machines

**Azure SQL Virtual Machines** είναι καλύτερο για μετεγκαταστάσεις όπου θέλετε **έλεγχο του λειτουργικού συστήματος και της παρουσίας SQL Server**, όπως αν ήταν ένας διακομιστής που λειτουργούσε on-premises. Μπορεί να έχει διαφορετικά μεγέθη μηχανών και μια ευρεία επιλογή εκδόσεων και εκδόσεων SQL Server.

#### Κύρια Χαρακτηριστικά

**Αυτοματοποιημένο Αντίγραφο Ασφαλείας**: Προγραμματίστε αντίγραφα ασφαλείας για βάσεις δεδομένων SQL.
**Αυτόματη Ενημέρωση**: Αυτοματοποιεί την εγκατάσταση ενημερώσεων Windows και SQL Server κατά τη διάρκεια ενός παραθύρου συντήρησης.
**Ενοποίηση Azure Key Vault**: Αυτόματα ρυθμίζει το Key Vault για SQL Server VMs.
**Ενοποίηση Defender for Cloud**: Δείτε τις συστάσεις Defender for SQL στην πύλη.
**Ευελιξία Έκδοσης/Έκδοσης**: Αλλάξτε τα μεταδεδομένα έκδοσης ή έκδοσης SQL Server χωρίς να αναπτύξετε ξανά το VM.

#### Χαρακτηριστικά Ασφαλείας

**Microsoft Defender for SQL**: Ενημερώσεις και ειδοποιήσεις ασφαλείας.
**Ενοποίηση Azure Key Vault**: Ασφαλής αποθήκευση διαπιστευτηρίων και κλειδιών κρυπτογράφησης.
**Microsoft Entra (Azure AD)**: Αυθεντικοποίηση και έλεγχος πρόσβασης.

## Enumeration

{{#tabs}}
{{#tab name="az cli"}}
```bash
# List Servers
az sql server list # --output table
## List Server Usages
az sql server list-usages --name <server_name> --resource-group <resource_group>
## List Server Firewalls
az sql server firewall-rule list --resource-group <resource_group> --server <server_name>
## List of Azure Active Directory administrators in a server.
az sql server ad-admin list --resource-group <resource_group> --server <server_name>
## Gets an advanced threat protection
az sql server advanced-threat-protection-setting show --resource-group <resource_group> --name <server_name>
## Get server's auditing policy.
az sql server audit-policy show --resource-group <resource_group> --name <server_name>
## Gets a server's secure connection policy.
az sql server conn-policy show --resource-group <resource_group> --server <server_name>
## Gets a list of server DNS aliases for a server.
az sql server dns-alias list --resource-group <resource_group> --server <server_name>
## List of server keys.
az sql server key list --resource-group <resource_group> --server <server_name>
## Gets a server encryption protector.
az sql server tde-key show --resource-group <resource_group> --server <server_name>

# List Databases in a SQL server
az sql db list --server <server_name> --resource-group <resource_group> #--output table
## Get details of a specific database
az sql db show --name <database_name> --server <server_name> --resource-group <resource_group>
## List database usages
az sql db list-usages --name <database_name> --server <server_name> --resource-group <resource_group>
## List of operations performed on the database.
az sql db op list --database <database_name> --server <server_name> --resource-group <resource_group>
## List sql database classification
az sql db classification list --name <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention backups for a SQL database
az sql db ltr-backup list --database <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention policy
az sql db ltr-policy --name <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention policy
az sql db str-policy --name <database_name> --server <server_name> --resource-group <resource_group>
## List the replicas of a database and their replication status
az sql db replica list-links --name <database_name> --server <server_name> --resource-group <resource_group>
## List deleted SQL databases
az sql db list-deleted --server <server_name> --resource-group <resource_group>
## List database usages
az sql db list-usages --name <database_name> --server <server_name> --resource-group <resource_group>
## List restorable dropped databases in a SQL server
az sql db list-deleted --server <server_name> --resource-group <resource_group>
## List advanced threat protection setting show
az sql db advanced-threat-protection-setting --name <database_name> --server <server_name> --resource-group <resource_group>

# List all elastic pools in a SQL server
az sql elastic-pool list --server <server_name> --resource-group <resource_group> #--output table
## List all databases in a specific elastic pool
az sql elastic-pool show --name <elastic_pool_name>  --server <server_name> --resource-group <resource_group>
## List of databases in an elastic pool.
az sql elastic-pool list-dbs --name <elastic_pool_name>  --server <server_name> --resource-group <resource_group>

# List all managed Instances
az sql mi list
az sql mi show --resource-group <res-grp> --name <name>
az sql midb list
az sql midb show --resource-group <res-grp> --name <name>

# Lis all sql VM
az sql vm list
az sql vm show --resource-group <res-grp> --name <name>
```
{{#endtab}}

{{#tab name="Az PowerShell"}}
```bash
# List Servers
Get-AzSqlServer -ResourceGroupName "<resource-group-name>"

# List All Databases in a SQL Server
Get-AzSqlDatabase -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# Get Details of a Specific Database
Get-AzSqlDatabase -Name "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List Operations Performed on the Database
Get-AzSqlDatabaseActivity -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List SQL Database Classification
Get-AzSqlDatabaseSensitivityClassification -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List Long-Term Retention Backups for a SQL Database
Get-AzSqlDatabaseLongTermRetentionBackup -ResourceGroupName "<resource_group>" -Location "<location>"
# List Replicas of a Database and Their Replication Status
Get-AzSqlDatabaseReplicationLink -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# List Deleted SQL Databases
Get-AzSqlDeletedDatabaseBackup -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List All Elastic Pools in a SQL Server
Get-AzSqlElasticPool -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# List All Databases in a Specific Elastic Pool
Get-AzSqlElasticPoolDatabase -ElasticPoolName "<elastic_pool_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List all managed Instances
Get-AzSqlInstance
Get-AzSqlInstance -ResourceGroupName <ResourceGroupName> -Name <ManagedInstanceName>

# List All Databases in a SQL Managed Instance
Get-AzSqlInstanceDatabase -ResourceGroupName <ResourceGroupName> -InstanceName <ManagedInstanceName>

# Lis all sql VM
Get-AzSqlVM
```
{{#endtab}}
{{#endtabs}}

### Σύνδεση και εκτέλεση ερωτημάτων SQL

Μπορείτε να βρείτε μια συμβολοσειρά σύνδεσης (που περιέχει διαπιστευτήρια) από το παράδειγμα [enumerating an Az WebApp](az-app-services.md):
```bash
function invoke-sql{
param($query)
$Connection_string = "Server=tcp:supercorp.database.windows.net,1433;Initial Catalog=flag;Persist Security Info=False;User ID=db_read;Password=gAegH!324fAG!#1fht;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
$Connection = New-Object System.Data.SqlClient.SqlConnection $Connection_string
$Connection.Open()
$Command = New-Object System.Data.SqlClient.SqlCommand
$Command.Connection = $Connection
$Command.CommandText = $query
$Reader = $Command.ExecuteReader()
while ($Reader.Read()) {
$Reader.GetValue(0)
}
$Connection.Close()
}

invoke-sql 'Select Distinct TABLE_NAME From information_schema.TABLES;'
```
Μπορείτε επίσης να χρησιμοποιήσετε το sqlcmd για να αποκτήσετε πρόσβαση στη βάση δεδομένων. Είναι σημαντικό να γνωρίζετε αν ο διακομιστής επιτρέπει δημόσιες συνδέσεις `az sql server show --name <server-name> --resource-group <resource-group>`, και επίσης αν ο κανόνας του τείχους προστασίας επιτρέπει στη διεύθυνση IP μας να αποκτήσει πρόσβαση:
```bash
sqlcmd -S <sql-server>.database.windows.net -U <server-user> -P <server-passworkd> -d <database>
```
## Αναφορές

- [https://learn.microsoft.com/en-us/azure/azure-sql/azure-sql-iaas-vs-paas-what-is-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/azure-sql-iaas-vs-paas-what-is-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/database/single-database-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/database/single-database-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/virtual-machines/windows/sql-server-on-azure-vm-iaas-what-is-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/virtual-machines/windows/sql-server-on-azure-vm-iaas-what-is-overview?view=azuresql)

## Ανύψωση Δικαιωμάτων

{{#ref}}
../az-privilege-escalation/az-sql-privesc.md
{{#endref}}

## Μετά την Εκμετάλλευση

{{#ref}}
../az-post-exploitation/az-sql-post-exploitation.md
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
