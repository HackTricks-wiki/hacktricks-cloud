# Az - SQL

{{#include ../../../banners/hacktricks-training.md}}

## Azure SQL

Azure SQL ni familia ya bidhaa zinazodhibitiwa, salama, na za akili zinazotumia **SQL Server database engine katika wingu la Azure**. Hii inamaanisha huna haja ya kuwa na wasiwasi kuhusu usimamizi wa kimwili wa seva zako, na unaweza kuzingatia kusimamia data yako.

Azure SQL ina matoleo makuu manne:

1. **Azure SQL Server**: Azure SQL Server ni huduma ya hifadhidata ya uhusiano inayodhibitiwa ambayo inarahisisha uwekaji na usimamizi wa hifadhidata za SQL Server, ikiwa na usalama wa ndani na vipengele vya utendaji.
2. **Azure SQL Database**: Hii ni **huduma ya hifadhidata inayodhibitiwa kikamilifu**, ambayo inakuwezesha kuhifadhi hifadhidata binafsi katika wingu la Azure. Inatoa akili ya ndani inayojifunza mifumo yako ya kipekee ya hifadhidata na kutoa mapendekezo maalum na uboreshaji wa kiotomatiki.
3. **Azure SQL Managed Instance**: Hii ni kwa ajili ya uwekaji wa kiwango kikubwa, wa jumla wa SQL Server. Inatoa karibu 100% ulinganifu na SQL Server ya hivi punde kwenye tovuti (Enterprise Edition) Database Engine, ambayo inatoa utekelezaji wa mtandao wa ndani (VNet) unaoshughulikia wasiwasi wa kawaida wa usalama, na mfano wa biashara unaofaa kwa wateja wa SQL Server kwenye tovuti.
4. **Azure SQL Server kwenye Azure VMs**: Hii ni Miundombinu kama Huduma (IaaS) na ni bora kwa uhamishaji ambapo unataka **udhibiti juu ya mfumo wa uendeshaji na mfano wa SQL Server**, kama ilivyokuwa seva inayofanya kazi kwenye tovuti.

### Azure SQL Server

Azure SQL Server ni mfumo wa usimamizi wa hifadhidata ya uhusiano (RDBMS) unaotumia Transact-SQL kwa shughuli za data na umejengwa kushughulikia mifumo ya kiwango cha biashara. Inatoa vipengele vya nguvu kwa utendaji, usalama, upanuzi, na ujumuishaji na programu mbalimbali za Microsoft. Hifadhidata za Azure SQL zinategemea seva hii, kwani hizi zimejengwa kwenye seva hizi na ni kiingilio kwa mtumiaji kufikia hifadhidata.

#### Network

**Network Connectivity**: Chagua ikiwa kuwezesha ufikiaji kupitia kiunganishi cha umma au kiunganishi cha kibinafsi. Ikiwa unachagua Hakuna ufikiaji, hakuna viunganishi vinavyoundwa hadi ipangwe kwa mikono:
- Hakuna ufikiaji: Hakuna viunganishi vinavyoundwa, ikizuia muunganisho wa kuingia hadi ipangwe kwa mikono.
- Kiunganishi cha umma: Inaruhusu muunganisho wa moja kwa moja kupitia intaneti ya umma, chini ya sheria za firewall na mipangilio mingine ya usalama.
- Kiunganishi cha kibinafsi: Kinakata ufikiaji kwa mtandao wa kibinafsi.

**Connection Policy**: Mwelekeo wa jinsi wateja wanavyowasiliana na seva ya hifadhidata ya SQL:
- Default: Inatumia sera ya Redirect kwa muunganisho wote wa wateja kutoka ndani ya Azure (isipokuwa wale wanaotumia Kiunganishi za Kibinafsi) na sera ya Proxy kwa muunganisho kutoka nje ya Azure.
- Proxy: Inarudisha muunganisho wote wa wateja kupitia lango la Hifadhidata ya Azure SQL.
- Redirect: Wateja wanajiunga moja kwa moja na node inayohifadhi hifadhidata.

#### Authentication Methods
Azure SQL inasaidia mbinu mbalimbali za uthibitishaji ili kulinda ufikiaji wa hifadhidata:

- **Microsoft Entra-only authentication**: Inatumia Microsoft Entra (zamani Azure AD) kwa usimamizi wa kitambulisho wa kati na kuingia mara moja.
- **Both SQL and Microsoft Entra authentication**: Inakuwezesha kutumia uthibitishaji wa jadi wa SQL pamoja na Microsoft Entra.
- **SQL authentication**: Inategemea tu majina ya watumiaji na nywila za SQL Server.

#### Security features

Seva za SQL zina **Managed Identities**. Identiti zinazodhibitiwa zinamruhusu seva yako kuthibitisha kwa usalama na huduma nyingine za Azure bila kuhifadhi hati za siri. Inaruhusu kufikia huduma nyingine ambazo zitakuwa Identiti iliyotolewa na Mfumo na kufikiwa na huduma nyingine kwa Identiti nyingine ambayo ni Identiti iliyotolewa na Mtumiaji. Baadhi ya huduma ambazo SQL inaweza kufikia ni Akaunti ya Hifadhi ya Azure (V2), Hifadhi ya Data ya Azure Gen2, SQL Server, Oracle, Teradata, MongoDB au Cosmos DB API kwa MongoDB, ODBC ya Kawaida, Operesheni za Bulk na hifadhi ya vitu inayofanana na S3.

Vipengele vingine vya usalama ambavyo seva ya SQL ina ni:

- **Firewall Rules**: Sheria za firewall zinadhibiti ufikiaji wa seva yako kwa kuzuia au kuruhusu trafiki. Hii ni kipengele cha hifadhidata yenyewe pia.
- **Transparent Data Encryption (TDE)**: TDE inashughulikia hifadhidata zako, nakala za akiba, na kumbukumbu wakati wa kupumzika ili kulinda data yako hata kama hifadhi imeharibiwa. Inaweza kufanywa kwa funguo zinazodhibitiwa na huduma au funguo zinazodhibitiwa na mteja.
- **Microsoft Defender for SQL**: Microsoft Defender for SQL inaweza kuwezeshwa kutoa tathmini za udhaifu na ulinzi wa hatari za juu kwa seva.

#### Deployment Models

Azure SQL Database inasaidia chaguzi za uwekaji zinazoweza kubadilishwa ili kukidhi mahitaji mbalimbali:

- **Single Database**:
- Hifadhidata iliyotengwa kikamilifu yenye rasilimali zake maalum.
- Nzuri kwa huduma ndogo au programu zinazohitaji chanzo kimoja cha data.
- **Elastic Pool**:
- Inaruhusu hifadhidata nyingi kushiriki rasilimali ndani ya mchanganyiko.
- Inagharimu kidogo kwa programu zenye mifumo ya matumizi inayobadilika kati ya hifadhidata nyingi.

### Azure SQL Database

**Azure SQL Database** ni **jukwaa la hifadhidata linalodhibitiwa kikamilifu kama huduma (PaaS)** linalotoa suluhisho za hifadhidata za uhusiano zinazoweza kupanuka na salama. Imejengwa kwenye teknolojia za hivi punde za SQL Server na kuondoa haja ya usimamizi wa miundombinu, na kuifanya kuwa chaguo maarufu kwa programu zinazotegemea wingu.

#### Key Features

- **Always Up-to-Date**: Inafanya kazi kwenye toleo la hivi punde la SQL Server na inapokea vipengele na maboresho mapya kiotomatiki.
- **PaaS Capabilities**: Inatoa upatikanaji wa juu, nakala za akiba, na masasisho.
- **Data Flexibility**: Inasaidia data za uhusiano na zisizo za uhusiano (mfano, grafu, JSON, nafasi, na XML).

#### Network

**Network Connectivity**: Chagua ikiwa kuwezesha ufikiaji kupitia kiunganishi cha umma au kiunganishi cha kibinafsi. Ikiwa unachagua Hakuna ufikiaji, hakuna viunganishi vinavyoundwa hadi ipangwe kwa mikono:
- Hakuna ufikiaji: Hakuna viunganishi vinavyoundwa, ikizuia muunganisho wa kuingia hadi ipangwe kwa mikono.
- Kiunganishi cha umma: Inaruhusu muunganisho wa moja kwa moja kupitia intaneti ya umma, chini ya sheria za firewall na mipangilio mingine ya usalama.
- Kiunganishi cha kibinafsi: Kinakata ufikiaji kwa mtandao wa kibinafsi.

**Connection Policy**: Mwelekeo wa jinsi wateja wanavyowasiliana na seva ya hifadhidata ya SQL:
- Default: Inatumia sera ya Redirect kwa muunganisho wote wa wateja kutoka ndani ya Azure (isipokuwa wale wanaotumia Kiunganishi za Kibinafsi) na sera ya Proxy kwa muunganisho kutoka nje ya Azure.
- Proxy: Inarudisha muunganisho wote wa wateja kupitia lango la Hifadhidata ya Azure SQL.
- Redirect: Wateja wanajiunga moja kwa moja na node inayohifadhi hifadhidata.

#### Security Features

- **Microsoft Defender for SQL**: inaweza kuwezeshwa kutoa tathmini za udhaifu na ulinzi wa hatari za juu.
- **Ledger**: inathibitisha kwa njia ya kisasa uadilifu wa data, kuhakikisha kwamba udanganyifu wowote unagundulika.
- **Server Identity**: inatumia identiti zinazotolewa na mfumo na identiti zinazotolewa na mtumiaji kuwezesha ufikiaji wa kati
- **Transparent Data Encryption Key Management**: inashughulikia hifadhidata, nakala za akiba, na kumbukumbu wakati wa kupumzika bila kuhitaji mabadiliko yoyote kwenye programu. Uthibitishaji unaweza kuwezeshwa kwenye kila hifadhidata, na ikiwa imepangiliwa kwenye kiwango cha hifadhidata, mipangilio hii inakataa mipangilio ya kiwango cha seva.
- **Always Encrypted**: ni seti ya vipengele vya ulinzi wa data vya juu vinavyotenganisha umiliki wa data kutoka kwa usimamizi wa data. Hii inahakikisha kwamba wasimamizi au waendeshaji wenye mamlaka ya juu hawawezi kufikia data nyeti.

#### Purchasing Models / Service Tiers

- **vCore-based**: Chagua kompyuta, kumbukumbu, na hifadhi kwa uhuru. Kwa Madhumuni ya Kawaida, Kazi ya Biashara (ikiwa na uhimilivu wa juu na utendaji kwa programu za OLTP), na inapanuka hadi 128 TB ya hifadhi.
- **DTU-based**: Inakusanya kompyuta, kumbukumbu, na I/O katika ngazi za kudumu. Rasilimali zilizolingana kwa kazi za kawaida.
- Kawaida: Rasilimali zilizolingana kwa kazi za kawaida.
- Premium: Utendaji wa juu kwa kazi zinazohitaji.

#### Scalable performance and pools

- **Single Databases**: Kila hifadhidata imejengwa kwa kujitenga na ina rasilimali zake maalum za kompyuta, kumbukumbu, na hifadhi. Rasilimali zinaweza kupanuliwa kwa njia ya kidinamikia (kuongezeka au kupungua) bila wakati wa kupumzika (1–128 vCores, 32 GB–4 TB hifadhi, na hadi 128 TB).
- **Elastic Pools**: Shiriki rasilimali kati ya hifadhidata nyingi katika mchanganyiko ili kuongeza ufanisi na kuokoa gharama. Rasilimali zinaweza pia kupanuliwa kwa njia ya kidinamikia kwa mchanganyiko mzima.
- **Service Tier Flexibility**: Anza kidogo na hifadhidata moja katika kiwango cha Madhumuni ya Kawaida. Pandisha hadi Kazi ya Biashara au kiwango cha Hyperscale kadri mahitaji yanavyokua.
- **Scaling Options**: Mipango ya Kupanda kwa Kidinamikia au Mbadala za Autoscaling.

#### Built-In Monitoring & Optimization

- **Query Store**: Inafuatilia matatizo ya utendaji, inatambua watumiaji wakuu wa rasilimali, na inatoa mapendekezo yanayoweza kutekelezwa.
- **Automatic Tuning**: Inaboresha utendaji kwa njia ya proaktiki kwa vipengele kama vile uundaji wa kiotomatiki na marekebisho ya mpango wa maswali.
- **Telemetry Integration**: Inasaidia ufuatiliaji kupitia Azure Monitor, Event Hubs, au Azure Storage kwa maarifa yaliyobinafsishwa.

#### Disaster Recovery & Availability

- **Automatic backups**: Hifadhidata ya SQL inafanya kiotomatiki nakala za akiba kamili, tofauti, na kumbukumbu za muamala za hifadhidata.
- **Point-in-Time Restore**: Rejesha hifadhidata kwa hali yoyote ya zamani ndani ya kipindi cha uhifadhi wa nakala za akiba.
- **Geo-Redundancy**
- **Failover Groups**: Inarahisisha urejeleaji wa dharura kwa kuunganisha hifadhidata kwa ajili ya kuhamasisha kiotomatiki kati ya maeneo.

### Azure SQL Managed Instance

**Azure SQL Managed Instance** ni injini ya hifadhidata kama Huduma (PaaS) inayotoa karibu 100% ulinganifu na SQL Server na inashughulikia kazi nyingi za usimamizi (mfano, kuboresha, kuboresha, nakala za akiba, ufuatiliaji) kiotomatiki. Inatoa suluhisho la wingu kwa kuhamasisha hifadhidata za SQL Server za kwenye tovuti kwa mabadiliko madogo.

#### Service Tiers

- **General Purpose**: Chaguo la gharama nafuu kwa programu zenye mahitaji ya kawaida ya I/O na ucheleweshaji.
- **Business Critical**: Chaguo la utendaji wa juu lenye ucheleweshaji wa chini wa I/O kwa kazi muhimu.

#### Advanced Security Features

* **Threat Protection**: Ulinzi wa Hatari wa Juu unatoa tahadhari kwa shughuli za kushuku na mashambulizi ya SQL injection. Ukaguzi wa kufuatilia na kurekodi matukio ya hifadhidata kwa ajili ya kufuata sheria.
* **Access Control**: Uthibitishaji wa Microsoft Entra kwa usimamizi wa kitambulisho wa kati. Usalama wa Kiwango cha Mstari na Kuficha Data kwa Njia ya Kijadi kwa udhibiti wa ufikiaji wa kina.
* **Backups**: Nakala za akiba za kiotomatiki na za mikono zikiwa na uwezo wa kurejesha kwa wakati.

### Azure SQL Virtual Machines

**Azure SQL Virtual Machines** ni bora kwa uhamishaji ambapo unataka **udhibiti juu ya mfumo wa uendeshaji na mfano wa SQL Server**, kama ilivyokuwa seva inayofanya kazi kwenye tovuti. Inaweza kuwa na ukubwa tofauti wa mashine, na uteuzi mpana wa matoleo na toleo la SQL Server.

#### Key Features

**Automated Backup**: Panga nakala za akiba za hifadhidata za SQL.
**Automatic Patching**: Inafanya kiotomatiki usakinishaji wa masasisho ya Windows na SQL Server wakati wa dirisha la matengenezo.
**Azure Key Vault Integration**: Inapangilia kiotomatiki Key Vault kwa SQL Server VMs.
**Defender for Cloud Integration**: Tazama mapendekezo ya Defender for SQL katika lango.
**Version/Edition Flexibility**: Badilisha toleo la SQL Server au metadata ya toleo bila kuhamasisha VM.

#### Security Features

**Microsoft Defender for SQL**: Maarifa na tahadhari za usalama.
**Azure Key Vault Integration**: Hifadhi salama ya hati za siri na funguo za usimbuaji.
**Microsoft Entra (Azure AD)**: Uthibitishaji na udhibiti wa ufikiaji.

## Enumeration

{{#tabs}}
{{#tab name="az cli"}}
```bash
# List Servers
az sql server list # managed identities are enumerated here too
## List Server Usages
az sql server list-usages --name <server_name> --resource-group <resource_group>
## List Server Firewalls
az sql server firewall-rule list --resource-group <resource_group> --server <server_name>
## List of Azure Active Directory administrators in a server.
az sql server ad-admin list --resource-group <resource_group> --server <server_name>
## Gets an advanced threat protection
az sql server advanced-threat-protection-setting show --resource-group <resource_group> --name <server_name>
## Get server's auditing policy.
az sql server audit-policy show --resource-group <resource_group> --name <server_name>
## Gets a server's secure connection policy.
az sql server conn-policy show --resource-group <resource_group> --server <server_name>
## Gets a list of server DNS aliases for a server.
az sql server dns-alias list --resource-group <resource_group> --server <server_name>
## List of server keys.
az sql server key list --resource-group <resource_group> --server <server_name>
## Gets a server encryption protector.
az sql server tde-key show --resource-group <resource_group> --server <server_name>

# List Databases in a SQL server
az sql db list --server <server_name> --resource-group <resource_group> #--output table
## Get details of a specific database
az sql db show --name <database_name> --server <server_name> --resource-group <resource_group>
## List database usages
az sql db list-usages --name <database_name> --server <server_name> --resource-group <resource_group>
## List of operations performed on the database.
az sql db op list --database <database_name> --server <server_name> --resource-group <resource_group>
## List sql database classification
az sql db classification list --name <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention backups for a SQL database
az sql db ltr-backup list --database <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention policy
az sql db ltr-policy --name <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention policy
az sql db str-policy --name <database_name> --server <server_name> --resource-group <resource_group>
## List the replicas of a database and their replication status
az sql db replica list-links --name <database_name> --server <server_name> --resource-group <resource_group>
## List deleted SQL databases
az sql db list-deleted --server <server_name> --resource-group <resource_group>
## List database usages
az sql db list-usages --name <database_name> --server <server_name> --resource-group <resource_group>
## List restorable dropped databases in a SQL server
az sql db list-deleted --server <server_name> --resource-group <resource_group>
## List advanced threat protection setting show
az sql db advanced-threat-protection-setting --name <database_name> --server <server_name> --resource-group <resource_group>

# List all elastic pools in a SQL server
az sql elastic-pool list --server <server_name> --resource-group <resource_group> #--output table
## List all databases in a specific elastic pool
az sql elastic-pool show --name <elastic_pool_name>  --server <server_name> --resource-group <resource_group>
## List of databases in an elastic pool.
az sql elastic-pool list-dbs --name <elastic_pool_name>  --server <server_name> --resource-group <resource_group>

# List all managed Instances
az sql mi list
az sql mi show --resource-group <res-grp> --name <name>
az sql midb list
az sql midb show --resource-group <res-grp> --name <name>

# Lis all sql VM
az sql vm list
az sql vm show --resource-group <res-grp> --name <name>
```
{{#endtab}}

{{#tab name="Az PowerShell"}}
```bash
# List Servers
Get-AzSqlServer -ResourceGroupName "<resource-group-name>"

# List All Databases in a SQL Server
Get-AzSqlDatabase -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# Get Details of a Specific Database
Get-AzSqlDatabase -Name "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List Operations Performed on the Database
Get-AzSqlDatabaseActivity -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List SQL Database Classification
Get-AzSqlDatabaseSensitivityClassification -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List Long-Term Retention Backups for a SQL Database
Get-AzSqlDatabaseLongTermRetentionBackup -ResourceGroupName "<resource_group>" -Location "<location>"
# List Replicas of a Database and Their Replication Status
Get-AzSqlDatabaseReplicationLink -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# List Deleted SQL Databases
Get-AzSqlDeletedDatabaseBackup -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List All Elastic Pools in a SQL Server
Get-AzSqlElasticPool -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# List All Databases in a Specific Elastic Pool
Get-AzSqlElasticPoolDatabase -ElasticPoolName "<elastic_pool_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List all managed Instances
Get-AzSqlInstance
Get-AzSqlInstance -ResourceGroupName <ResourceGroupName> -Name <ManagedInstanceName>

# List All Databases in a SQL Managed Instance
Get-AzSqlInstanceDatabase -ResourceGroupName <ResourceGroupName> -InstanceName <ManagedInstanceName>

# Lis all sql VM
Get-AzSqlVM
```
{{#endtab}}
{{#endtabs}}

### Unganisha na kuendesha maswali ya SQL

Unaweza kupata mfuatano wa muunganisho (ukijumuisha akidi) kutoka kwa mfano [kuhesabu Az WebApp](az-app-services.md):
```bash
function invoke-sql{
param($query)
$Connection_string = "Server=tcp:supercorp.database.windows.net,1433;Initial Catalog=flag;Persist Security Info=False;User ID=db_read;Password=gAegH!324fAG!#1fht;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
$Connection = New-Object System.Data.SqlClient.SqlConnection $Connection_string
$Connection.Open()
$Command = New-Object System.Data.SqlClient.SqlCommand
$Command.Connection = $Connection
$Command.CommandText = $query
$Reader = $Command.ExecuteReader()
while ($Reader.Read()) {
$Reader.GetValue(0)
}
$Connection.Close()
}

invoke-sql 'Select Distinct TABLE_NAME From information_schema.TABLES;'
```
Unaweza pia kutumia sqlcmd kufikia hifadhidata. Ni muhimu kujua kama seva inaruhusu muunganisho wa umma `az sql server show --name <server-name> --resource-group <resource-group>`, na pia kama sheria ya firewall inaruhusu IP yetu kufikia:
```bash
sqlcmd -S <sql-server>.database.windows.net -U <server-user> -P <server-passworkd> -d <database>
```
## References

- [https://learn.microsoft.com/en-us/azure/azure-sql/azure-sql-iaas-vs-paas-what-is-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/azure-sql-iaas-vs-paas-what-is-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/database/single-database-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/database/single-database-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/virtual-machines/windows/sql-server-on-azure-vm-iaas-what-is-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/virtual-machines/windows/sql-server-on-azure-vm-iaas-what-is-overview?view=azuresql)

## Privilege Escalation

{{#ref}}
../az-privilege-escalation/az-sql-privesc.md
{{#endref}}

## Post Exploitation

{{#ref}}
../az-post-exploitation/az-sql-post-exploitation.md
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
