# Az - SQL

{{#include ../../../banners/hacktricks-training.md}}

## Azure SQL

Azure SQL 是一系列托管、安全和智能的产品，使用 **Azure 云中的 SQL Server 数据库引擎**。这意味着您不必担心服务器的物理管理，您可以专注于管理您的数据。

Azure SQL 由四个主要产品组成：

1. **Azure SQL Server**：Azure SQL Server 是一种托管关系数据库服务，简化了 SQL Server 数据库的部署和管理，具有内置的安全性和性能特性。
2. **Azure SQL Database**：这是一个 **完全托管的数据库服务**，允许您在 Azure 云中托管单个数据库。它提供内置智能，学习您独特的数据库模式，并提供定制的建议和自动调优。
3. **Azure SQL Managed Instance**：这是针对更大规模、整个 SQL Server 实例范围的部署。它提供与最新的 SQL Server 本地（企业版）数据库引擎近 100% 的兼容性，提供本地虚拟网络（VNet）实现，解决常见的安全问题，并为本地 SQL Server 客户提供有利的商业模式。
4. **Azure SQL Server on Azure VMs**：这是基础设施即服务（IaaS），最适合您希望 **控制操作系统和 SQL Server 实例** 的迁移，就像它是一个在本地运行的服务器。

### Azure SQL Server

Azure SQL Server 是一种关系数据库管理系统（RDBMS），使用 Transact-SQL 进行数据操作，旨在处理企业级系统。它提供强大的性能、安全性、可扩展性和与各种 Microsoft 应用程序集成的功能。Azure SQL 数据库依赖于此服务器，因为这些数据库是建立在此服务器上的，它是用户访问数据库的入口点。

#### 网络

**网络连接**：选择是否通过公共端点或私有端点启用访问。如果您选择无访问，则不会创建任何端点，直到手动配置：
- 无访问：未配置任何端点，阻止传入连接，直到手动设置。
- 公共端点：允许通过公共互联网直接连接，受防火墙规则和其他安全配置的限制。
- 私有端点：限制连接到私有网络。

**连接策略**：定义客户端如何与 SQL 数据库服务器通信：
- 默认：对来自 Azure 内部的所有客户端连接（除了使用私有端点的连接）使用重定向策略，对来自 Azure 外部的连接使用代理策略。
- 代理：通过 Azure SQL 数据库网关路由所有客户端连接。
- 重定向：客户端直接连接到托管数据库的节点。

#### 认证方法
Azure SQL 支持多种认证方法以保护数据库访问：

- **仅 Microsoft Entra 认证**：使用 Microsoft Entra（以前称为 Azure AD）进行集中身份管理和单点登录。
- **SQL 和 Microsoft Entra 认证**：允许您将传统 SQL 认证与 Microsoft Entra 一起使用。
- **SQL 认证**：仅依赖于 SQL Server 用户名和密码。

#### 安全特性

SQL 服务器具有 **托管身份**。托管身份允许您的服务器安全地与其他 Azure 服务进行身份验证，而无需存储凭据。它允许访问其他服务，这将是系统分配的托管身份，并可以通过其他身份访问的用户分配的托管身份。SQL 可以访问的一些服务包括 Azure 存储帐户（V2）、Azure Data Lake Storage Gen2、SQL Server、Oracle、Teradata、MongoDB 或 Cosmos DB API for MongoDB、通用 ODBC、大规模操作和 S3 兼容的对象存储。

SQL 服务器的其他安全特性包括：

- **防火墙规则**：防火墙规则通过限制或允许流量来控制对服务器的访问。这也是数据库本身的一个特性。
- **透明数据加密 (TDE)**：TDE 在静态状态下加密您的数据库、备份和日志，以保护您的数据，即使存储被破坏。可以使用服务管理密钥或客户管理密钥进行。
- **Microsoft Defender for SQL**：可以启用 Microsoft Defender for SQL，提供漏洞评估和高级威胁保护。

#### 部署模型

Azure SQL 数据库支持灵活的部署选项，以满足各种需求：

- **单一数据库**：
- 一个完全隔离的数据库，具有自己的专用资源。
- 非常适合微服务或需要单一数据源的应用程序。
- **弹性池**：
- 允许多个数据库在池内共享资源。
- 对于在多个数据库中使用模式波动的应用程序，具有成本效益。

### Azure SQL Database

**Azure SQL Database** 是一个 **完全托管的数据库平台即服务 (PaaS)**，提供可扩展和安全的关系数据库解决方案。它基于最新的 SQL Server 技术，消除了基础设施管理的需要，使其成为基于云的应用程序的热门选择。

#### 关键特性

- **始终保持最新**：运行在最新的稳定版本的 SQL Server 上，并自动接收新功能和补丁。
- **PaaS 功能**：内置高可用性、备份和更新。
- **数据灵活性**：支持关系和非关系数据（例如，图形、JSON、空间和 XML）。

#### 网络

**网络连接**：选择是否通过公共端点或私有端点启用访问。如果您选择无访问，则不会创建任何端点，直到手动配置：
- 无访问：未配置任何端点，阻止传入连接，直到手动设置。
- 公共端点：允许通过公共互联网直接连接，受防火墙规则和其他安全配置的限制。
- 私有端点：限制连接到私有网络。

**连接策略**：定义客户端如何与 SQL 数据库服务器通信：
- 默认：对来自 Azure 内部的所有客户端连接（除了使用私有端点的连接）使用重定向策略，对来自 Azure 外部的连接使用代理策略。
- 代理：通过 Azure SQL 数据库网关路由所有客户端连接。
- 重定向：客户端直接连接到托管数据库的节点。

#### 安全特性

- **Microsoft Defender for SQL**：可以启用，提供漏洞评估和高级威胁保护。
- **分类账**：通过加密验证数据的完整性，确保任何篡改都能被检测到。
- **服务器身份**：使用系统分配和用户分配的托管身份以启用集中访问。
- **透明数据加密密钥管理**：在不需要对应用程序进行任何更改的情况下加密数据库、备份和日志。可以在每个数据库上启用加密，如果在数据库级别配置，这些设置将覆盖服务器级别的配置。
- **始终加密**：是一套先进的数据保护功能，将数据所有权与数据管理分离。这确保具有高权限的管理员或操作员无法访问敏感数据。

#### 购买模型 / 服务层级

- **基于 vCore**：独立选择计算、内存和存储。适用于通用用途、业务关键（具有高弹性和 OLTP 应用程序的性能）并可扩展到 128 TB 存储。
- **基于 DTU**：将计算、内存和 I/O 打包成固定层级。为常见任务提供平衡资源。
- 标准：为常见任务提供平衡资源。
- 高级：为要求苛刻的工作负载提供高性能。

#### 可扩展性能和池

- **单一数据库**：每个数据库都是隔离的，具有自己的专用计算、内存和存储资源。资源可以动态扩展（向上或向下），而无需停机（1–128 vCores，32 GB–4 TB 存储，最多 128 TB）。
- **弹性池**：在池中跨多个数据库共享资源，以最大化效率并节省成本。资源也可以为整个池动态扩展。
- **服务层级灵活性**：从通用用途层中的单一数据库开始。随着需求的增长，升级到业务关键或超大规模层。
- **扩展选项**：动态扩展或自动扩展替代方案。

#### 内置监控与优化

- **查询存储**：跟踪性能问题，识别资源消耗最多的用户，并提供可操作的建议。
- **自动调优**：通过自动索引和查询计划修正等功能主动优化性能。
- **遥测集成**：通过 Azure Monitor、事件中心或 Azure 存储支持监控，以获取定制的见解。

#### 灾难恢复与可用性

- **自动备份**：SQL 数据库自动执行数据库的完整、差异和事务日志备份。
- **时间点恢复**：在备份保留期内将数据库恢复到任何过去的状态。
- **地理冗余**
- **故障转移组**：通过将数据库分组以实现跨区域的自动故障转移，简化灾难恢复。

### Azure SQL Managed Instance

**Azure SQL Managed Instance** 是一种平台即服务 (PaaS) 数据库引擎，提供与 SQL Server 近 100% 的兼容性，并自动处理大多数管理任务（例如，升级、修补、备份、监控）。它为迁移本地 SQL Server 数据库提供了最小更改的云解决方案。

#### 服务层级

- **通用用途**：适用于具有标准 I/O 和延迟要求的应用程序的成本效益选项。
- **业务关键**：为关键工作负载提供低 I/O 延迟的高性能选项。

#### 高级安全特性

* **威胁保护**：高级威胁保护警报可检测可疑活动和 SQL 注入攻击。审计以跟踪和记录数据库事件以确保合规性。
* **访问控制**：Microsoft Entra 认证用于集中身份管理。行级安全性和动态数据掩码用于细粒度访问控制。
* **备份**：具有时间点恢复能力的自动和手动备份。

### Azure SQL Virtual Machines

**Azure SQL Virtual Machines** 最适合您希望 **控制操作系统和 SQL Server 实例** 的迁移，就像它是一个在本地运行的服务器。它可以具有不同的机器大小，以及广泛的 SQL Server 版本和版本选择。

#### 关键特性

**自动备份**：为 SQL 数据库安排备份。
**自动修补**：在维护窗口期间自动安装 Windows 和 SQL Server 更新。
**Azure Key Vault 集成**：自动为 SQL Server 虚拟机配置 Key Vault。
**云防御者集成**：在门户中查看 SQL 的防御者建议。
**版本/版本灵活性**：在不重新部署虚拟机的情况下更改 SQL Server 版本或版本元数据。

#### 安全特性

**Microsoft Defender for SQL**：安全见解和警报。
**Azure Key Vault 集成**：安全存储凭据和加密密钥。
**Microsoft Entra (Azure AD)**：身份验证和访问控制。

## 枚举

{{#tabs}}
{{#tab name="az cli"}}
```bash
# List Servers
az sql server list # managed identities are enumerated here too
## List Server Usages
az sql server list-usages --name <server_name> --resource-group <resource_group>
## List Server Firewalls
az sql server firewall-rule list --resource-group <resource_group> --server <server_name>
## List of Azure Active Directory administrators in a server.
az sql server ad-admin list --resource-group <resource_group> --server <server_name>
## Gets an advanced threat protection
az sql server advanced-threat-protection-setting show --resource-group <resource_group> --name <server_name>
## Get server's auditing policy.
az sql server audit-policy show --resource-group <resource_group> --name <server_name>
## Gets a server's secure connection policy.
az sql server conn-policy show --resource-group <resource_group> --server <server_name>
## Gets a list of server DNS aliases for a server.
az sql server dns-alias list --resource-group <resource_group> --server <server_name>
## List of server keys.
az sql server key list --resource-group <resource_group> --server <server_name>
## Gets a server encryption protector.
az sql server tde-key show --resource-group <resource_group> --server <server_name>

# List Databases in a SQL server
az sql db list --server <server_name> --resource-group <resource_group> #--output table
## Get details of a specific database
az sql db show --name <database_name> --server <server_name> --resource-group <resource_group>
## List database usages
az sql db list-usages --name <database_name> --server <server_name> --resource-group <resource_group>
## List of operations performed on the database.
az sql db op list --database <database_name> --server <server_name> --resource-group <resource_group>
## List sql database classification
az sql db classification list --name <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention backups for a SQL database
az sql db ltr-backup list --database <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention policy
az sql db ltr-policy --name <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention policy
az sql db str-policy --name <database_name> --server <server_name> --resource-group <resource_group>
## List the replicas of a database and their replication status
az sql db replica list-links --name <database_name> --server <server_name> --resource-group <resource_group>
## List deleted SQL databases
az sql db list-deleted --server <server_name> --resource-group <resource_group>
## List database usages
az sql db list-usages --name <database_name> --server <server_name> --resource-group <resource_group>
## List restorable dropped databases in a SQL server
az sql db list-deleted --server <server_name> --resource-group <resource_group>
## List advanced threat protection setting show
az sql db advanced-threat-protection-setting --name <database_name> --server <server_name> --resource-group <resource_group>

# List all elastic pools in a SQL server
az sql elastic-pool list --server <server_name> --resource-group <resource_group> #--output table
## List all databases in a specific elastic pool
az sql elastic-pool show --name <elastic_pool_name>  --server <server_name> --resource-group <resource_group>
## List of databases in an elastic pool.
az sql elastic-pool list-dbs --name <elastic_pool_name>  --server <server_name> --resource-group <resource_group>

# List all managed Instances
az sql mi list
az sql mi show --resource-group <res-grp> --name <name>
az sql midb list
az sql midb show --resource-group <res-grp> --name <name>

# Lis all sql VM
az sql vm list
az sql vm show --resource-group <res-grp> --name <name>
```
{{#endtab}}

{{#tab name="Az PowerShell"}}
```bash
# List Servers
Get-AzSqlServer -ResourceGroupName "<resource-group-name>"

# List All Databases in a SQL Server
Get-AzSqlDatabase -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# Get Details of a Specific Database
Get-AzSqlDatabase -Name "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List Operations Performed on the Database
Get-AzSqlDatabaseActivity -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List SQL Database Classification
Get-AzSqlDatabaseSensitivityClassification -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List Long-Term Retention Backups for a SQL Database
Get-AzSqlDatabaseLongTermRetentionBackup -ResourceGroupName "<resource_group>" -Location "<location>"
# List Replicas of a Database and Their Replication Status
Get-AzSqlDatabaseReplicationLink -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# List Deleted SQL Databases
Get-AzSqlDeletedDatabaseBackup -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List All Elastic Pools in a SQL Server
Get-AzSqlElasticPool -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# List All Databases in a Specific Elastic Pool
Get-AzSqlElasticPoolDatabase -ElasticPoolName "<elastic_pool_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List all managed Instances
Get-AzSqlInstance
Get-AzSqlInstance -ResourceGroupName <ResourceGroupName> -Name <ManagedInstanceName>

# List All Databases in a SQL Managed Instance
Get-AzSqlInstanceDatabase -ResourceGroupName <ResourceGroupName> -InstanceName <ManagedInstanceName>

# Lis all sql VM
Get-AzSqlVM
```
{{#endtab}}
{{#endtabs}}

### 连接并运行 SQL 查询

您可以从示例 [枚举 Az WebApp](az-app-services.md) 中找到连接字符串（包含凭据）：
```bash
function invoke-sql{
param($query)
$Connection_string = "Server=tcp:supercorp.database.windows.net,1433;Initial Catalog=flag;Persist Security Info=False;User ID=db_read;Password=gAegH!324fAG!#1fht;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
$Connection = New-Object System.Data.SqlClient.SqlConnection $Connection_string
$Connection.Open()
$Command = New-Object System.Data.SqlClient.SqlCommand
$Command.Connection = $Connection
$Command.CommandText = $query
$Reader = $Command.ExecuteReader()
while ($Reader.Read()) {
$Reader.GetValue(0)
}
$Connection.Close()
}

invoke-sql 'Select Distinct TABLE_NAME From information_schema.TABLES;'
```
您还可以使用 sqlcmd 访问数据库。重要的是要知道服务器是否允许公共连接 `az sql server show --name <server-name> --resource-group <resource-group>`，以及防火墙规则是否允许我们的 IP 访问：
```bash
sqlcmd -S <sql-server>.database.windows.net -U <server-user> -P <server-passworkd> -d <database>
```
## 参考

- [https://learn.microsoft.com/en-us/azure/azure-sql/azure-sql-iaas-vs-paas-what-is-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/azure-sql-iaas-vs-paas-what-is-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/database/single-database-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/database/single-database-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/virtual-machines/windows/sql-server-on-azure-vm-iaas-what-is-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/virtual-machines/windows/sql-server-on-azure-vm-iaas-what-is-overview?view=azuresql)

## 权限提升

{{#ref}}
../az-privilege-escalation/az-sql-privesc.md
{{#endref}}

## 后期利用

{{#ref}}
../az-post-exploitation/az-sql-post-exploitation.md
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
