# Az - SQL

{{#include ../../../banners/hacktricks-training.md}}

## Azure SQL

Azure SQL to rodzina zarządzanych, bezpiecznych i inteligentnych produktów, które wykorzystują **silnik bazy danych SQL Server w chmurze Azure**. Oznacza to, że nie musisz martwić się o fizyczne zarządzanie swoimi serwerami, a możesz skupić się na zarządzaniu swoimi danymi.

Azure SQL składa się z czterech głównych ofert:

1. **Azure SQL Server**: Azure SQL Server to zarządzana usługa bazy danych relacyjnych, która upraszcza wdrażanie i zarządzanie bazami danych SQL Server, z wbudowanymi funkcjami bezpieczeństwa i wydajności.
2. **Azure SQL Database**: To **w pełni zarządzana usługa bazy danych**, która pozwala na hostowanie pojedynczych baz danych w chmurze Azure. Oferuje wbudowaną inteligencję, która uczy się Twoich unikalnych wzorców bazy danych i dostarcza spersonalizowane rekomendacje oraz automatyczne dostosowywanie.
3. **Azure SQL Managed Instance**: To rozwiązanie dla większych wdrożeń w skali całej instancji SQL Server. Oferuje niemal 100% zgodności z najnowszym silnikiem bazy danych SQL Server w wersji lokalnej (Enterprise Edition), który zapewnia natywną implementację wirtualnej sieci (VNet), odpowiadającą na powszechne obawy dotyczące bezpieczeństwa, oraz model biznesowy korzystny dla klientów SQL Server w wersji lokalnej.
4. **Azure SQL Server na maszynach wirtualnych Azure**: To infrastruktura jako usługa (IaaS) i jest najlepsza dla migracji, gdzie chcesz **kontrolować system operacyjny i instancję SQL Server**, jakby to był serwer działający lokalnie.

### Azure SQL Server

Azure SQL Server to system zarządzania bazą danych relacyjnych (RDBMS), który wykorzystuje Transact-SQL do operacji na danych i jest zaprojektowany do obsługi systemów na poziomie przedsiębiorstwa. Oferuje solidne funkcje dotyczące wydajności, bezpieczeństwa, skalowalności i integracji z różnymi aplikacjami Microsoft. Bazy danych Azure SQL opierają się na tym serwerze, ponieważ są zbudowane na tych serwerach i jest to punkt wejścia dla użytkowników do uzyskania dostępu do baz danych.

#### Sieć

**Łączność sieciowa**: Wybierz, czy chcesz włączyć dostęp przez publiczny punkt końcowy, czy prywatny punkt końcowy. Jeśli wybierzesz Brak dostępu, żadne punkty końcowe nie są tworzone, dopóki nie zostaną skonfigurowane ręcznie:
- Brak dostępu: Żadne punkty końcowe nie są skonfigurowane, blokując przychodzące połączenia, aż do ręcznego ustawienia.
- Publiczny punkt końcowy: Umożliwia bezpośrednie połączenia przez publiczny internet, podlegające zasadom zapory i innym konfiguracjom bezpieczeństwa.
- Prywatny punkt końcowy: Ogranicza łączność do prywatnej sieci.

**Polityka połączeń**: Zdefiniuj, jak klienci komunikują się z serwerem bazy danych SQL:
- Domyślnie: Używa polityki przekierowania dla wszystkich połączeń klientów z wewnątrz Azure (z wyjątkiem tych korzystających z prywatnych punktów końcowych) oraz polityki proxy dla połączeń z zewnątrz Azure.
- Proxy: Kieruje wszystkie połączenia klientów przez bramę bazy danych Azure SQL.
- Przekierowanie: Klienci łączą się bezpośrednio z węzłem hostującym bazę danych.

#### Metody uwierzytelniania
Azure SQL obsługuje różne metody uwierzytelniania w celu zabezpieczenia dostępu do bazy danych:

- **Uwierzytelnianie tylko Microsoft Entra**: Używa Microsoft Entra (wcześniej Azure AD) do centralnego zarządzania tożsamością i jednolitych logowań.
- **Uwierzytelnianie zarówno SQL, jak i Microsoft Entra**: Pozwala na korzystanie z tradycyjnego uwierzytelniania SQL obok Microsoft Entra.
- **Uwierzytelnianie SQL**: Opiera się wyłącznie na nazwach użytkowników i hasłach SQL Server.

#### Funkcje bezpieczeństwa

Serwery SQL mają **Zarządzane Tożsamości**. Zarządzane tożsamości pozwalają Twojemu serwerowi na bezpieczne uwierzytelnianie z innymi usługami Azure bez przechowywania poświadczeń. Umożliwia to dostęp do innych usług, które będą miały tożsamość zarządzaną przypisaną do systemu oraz będą dostępne przez inne usługi z innymi tożsamościami, które są tożsamościami przypisanymi przez użytkownika. Niektóre z usług, do których SQL może uzyskać dostęp, to Azure Storage Account(V2), Azure Data Lake Storage Gen2, SQL Server, Oracle, Teradata, MongoDB lub Cosmos DB API dla MongoDB, Generic ODBC, Bulk Operations i S3-compatibile object storage.

Inne funkcje bezpieczeństwa, które ma serwer SQL, to:

- **Reguły zapory**: Reguły zapory kontrolują dostęp do Twojego serwera, ograniczając lub zezwalając na ruch. To jest również funkcja samych baz danych.
- **Transparentne Szyfrowanie Danych (TDE)**: TDE szyfruje Twoje bazy danych, kopie zapasowe i dzienniki w spoczynku, aby chronić Twoje dane, nawet jeśli pamięć masowa zostanie skompromitowana. Może być realizowane za pomocą klucza zarządzanego przez usługę lub klucza zarządzanego przez klienta.
- **Microsoft Defender dla SQL**: Microsoft Defender dla SQL może być włączony, oferując oceny podatności i zaawansowaną ochronę przed zagrożeniami dla serwera.

#### Modele wdrożenia

Azure SQL Database obsługuje elastyczne opcje wdrożenia, aby dostosować się do różnych potrzeb:

- **Pojedyncza baza danych**:
- W pełni izolowana baza danych z własnymi dedykowanymi zasobami.
- Doskonała dla mikroserwisów lub aplikacji wymagających jednego źródła danych.
- **Elastic Pool**:
- Umożliwia wielu bazom danych dzielenie zasobów w ramach puli.
- Ekonomiczne dla aplikacji z fluktuującymi wzorcami użytkowania w wielu bazach danych.

### Azure SQL Database

**Azure SQL Database** to **w pełni zarządzana platforma bazy danych jako usługa (PaaS)**, która zapewnia skalowalne i bezpieczne rozwiązania baz danych relacyjnych. Jest zbudowana na najnowszych technologiach SQL Server i eliminuje potrzebę zarządzania infrastrukturą, co czyni ją popularnym wyborem dla aplikacji w chmurze.

#### Kluczowe funkcje

- **Zawsze aktualne**: Działa na najnowszej stabilnej wersji SQL Server i automatycznie otrzymuje nowe funkcje i poprawki.
- **Możliwości PaaS**: Wbudowana wysoka dostępność, kopie zapasowe i aktualizacje.
- **Elastyczność danych**: Obsługuje dane relacyjne i nierelacyjne (np. grafy, JSON, przestrzenne i XML).

#### Sieć

**Łączność sieciowa**: Wybierz, czy chcesz włączyć dostęp przez publiczny punkt końcowy, czy prywatny punkt końcowy. Jeśli wybierzesz Brak dostępu, żadne punkty końcowe nie są tworzone, dopóki nie zostaną skonfigurowane ręcznie:
- Brak dostępu: Żadne punkty końcowe nie są skonfigurowane, blokując przychodzące połączenia, aż do ręcznego ustawienia.
- Publiczny punkt końcowy: Umożliwia bezpośrednie połączenia przez publiczny internet, podlegające zasadom zapory i innym konfiguracjom bezpieczeństwa.
- Prywatny punkt końcowy: Ogranicza łączność do prywatnej sieci.

**Polityka połączeń**: Zdefiniuj, jak klienci komunikują się z serwerem bazy danych SQL:
- Domyślnie: Używa polityki przekierowania dla wszystkich połączeń klientów z wewnątrz Azure (z wyjątkiem tych korzystających z prywatnych punktów końcowych) oraz polityki proxy dla połączeń z zewnątrz Azure.
- Proxy: Kieruje wszystkie połączenia klientów przez bramę bazy danych Azure SQL.
- Przekierowanie: Klienci łączą się bezpośrednio z węzłem hostującym bazę danych.

#### Funkcje bezpieczeństwa

- **Microsoft Defender dla SQL**: może być włączony, oferując oceny podatności i zaawansowaną ochronę przed zagrożeniami.
- **Księga**: kryptograficznie weryfikuje integralność danych, zapewniając, że wszelkie manipulacje są wykrywane.
- **Tożsamość serwera**: wykorzystuje zarządzane tożsamości przypisane przez system i użytkownika, aby umożliwić centralny dostęp.
- **Zarządzanie kluczem szyfrowania Transparentnego Szyfrowania Danych**: szyfruje bazy danych, kopie zapasowe i dzienniki w spoczynku bez konieczności wprowadzania jakichkolwiek zmian w aplikacji. Szyfrowanie można włączyć na każdej bazie danych, a jeśli jest skonfigurowane na poziomie bazy danych, te ustawienia mają pierwszeństwo przed konfiguracją na poziomie serwera.
- **Zawsze Szyfrowane**: to zestaw zaawansowanych funkcji ochrony danych, które oddzielają własność danych od zarządzania danymi. Zapewnia to, że administratorzy lub operatorzy z wysokimi uprawnieniami nie mogą uzyskać dostępu do wrażliwych danych.

#### Modele zakupu / Poziomy usług

- **Oparte na vCore**: Wybierz obliczenia, pamięć i pamięć masową niezależnie. Dla ogólnego użytku, krytycznego biznesu (z wysoką odpornością i wydajnością dla aplikacji OLTP) i skaluje się do 128 TB pamięci masowej.
- **Oparte na DTU**: Łączy obliczenia, pamięć i I/O w stałych poziomach. Zrównoważone zasoby dla typowych zadań.
- Standard: Zrównoważone zasoby dla typowych zadań.
- Premium: Wysoka wydajność dla wymagających obciążeń.

#### Skalowalna wydajność i pule

- **Pojedyncze bazy danych**: Każda baza danych jest izolowana i ma swoje własne dedykowane zasoby obliczeniowe, pamięci i pamięci masowej. Zasoby można skalować dynamicznie (w górę lub w dół) bez przestojów (1–128 vCores, 32 GB–4 TB pamięci masowej i do 128 TB).
- **Elastic Pools**: Dzielą zasoby między wieloma bazami danych w puli, aby zmaksymalizować efektywność i zaoszczędzić koszty. Zasoby można również skalować dynamicznie dla całej puli.
- **Elastyczność poziomów usług**: Rozpocznij od małej bazy danych w poziomie ogólnego użytku. Ulepsz do poziomów krytycznych dla biznesu lub hiperskalowania w miarę wzrostu potrzeb.
- **Opcje skalowania**: Dynamiczne skalowanie lub alternatywy automatycznego skalowania.

#### Wbudowane monitorowanie i optymalizacja

- **Query Store**: Śledzi problemy z wydajnością, identyfikuje największych konsumentów zasobów i oferuje wykonalne rekomendacje.
- **Automatyczne dostosowywanie**: Proaktywnie optymalizuje wydajność za pomocą funkcji takich jak automatyczne indeksowanie i korekcje planu zapytań.
- **Integracja telemetrii**: Obsługuje monitorowanie przez Azure Monitor, Event Hubs lub Azure Storage w celu uzyskania dostosowanych informacji.

#### Odzyskiwanie po awarii i dostępność

- **Automatyczne kopie zapasowe**: SQL Database automatycznie wykonuje pełne, różnicowe i dzienniki transakcji kopii zapasowych baz danych.
- **Przywracanie do punktu w czasie**: Przywracaj bazy danych do dowolnego wcześniejszego stanu w okresie retencji kopii zapasowych.
- **Geo-redundancja**
- **Grupy failover**: Uproszczenie odzyskiwania po awarii poprzez grupowanie baz danych do automatycznego failoveru w różnych regionach.

### Azure SQL Managed Instance

**Azure SQL Managed Instance** to silnik bazy danych jako usługa (PaaS), który oferuje niemal 100% zgodności z SQL Server i automatycznie obsługuje większość zadań zarządzania (np. aktualizacje, łatanie, kopie zapasowe, monitorowanie). Zapewnia rozwiązanie w chmurze do migracji lokalnych baz danych SQL Server z minimalnymi zmianami.

#### Poziomy usług

- **Ogólny cel**: Opcja kosztowa dla aplikacji o standardowych wymaganiach dotyczących I/O i opóźnień.
- **Krytyczny biznes**: Opcja o wysokiej wydajności z niskim opóźnieniem I/O dla krytycznych obciążeń.

#### Zaawansowane funkcje bezpieczeństwa

* **Ochrona przed zagrożeniami**: Zaawansowana ochrona przed zagrożeniami informuje o podejrzanych działaniach i atakach SQL injection. Audytowanie w celu śledzenia i rejestrowania zdarzeń bazy danych dla zgodności.
* **Kontrola dostępu**: Uwierzytelnianie Microsoft Entra do centralnego zarządzania tożsamością. Bezpieczeństwo na poziomie wiersza i dynamiczne maskowanie danych dla szczegółowej kontroli dostępu.
* **Kopie zapasowe**: Automatyczne i ręczne kopie zapasowe z możliwością przywracania do punktu w czasie.

### Azure SQL Virtual Machines

**Azure SQL Virtual Machines** jest najlepsze dla migracji, gdzie chcesz **kontrolować system operacyjny i instancję SQL Server**, jakby to był serwer działający lokalnie. Może mieć różne rozmiary maszyn oraz szeroki wybór wersji i edycji SQL Server.

#### Kluczowe funkcje

**Automatyczne kopie zapasowe**: Harmonogram kopii zapasowych dla baz danych SQL.
**Automatyczne łatanie**: Automatyzuje instalację aktualizacji systemu Windows i SQL Server w czasie okna konserwacji.
**Integracja z Azure Key Vault**: Automatycznie konfiguruje Key Vault dla maszyn wirtualnych SQL Server.
**Integracja z Defender for Cloud**: Wyświetl rekomendacje Defender dla SQL w portalu.
**Elastyczność wersji/edycji**: Zmień metadane wersji lub edycji SQL Server bez ponownego wdrażania maszyny wirtualnej.

#### Funkcje bezpieczeństwa

**Microsoft Defender dla SQL**: Wgląd w bezpieczeństwo i alerty.
**Integracja z Azure Key Vault**: Bezpieczne przechowywanie poświadczeń i kluczy szyfrujących.
**Microsoft Entra (Azure AD)**: Uwierzytelnianie i kontrola dostępu.

## Enumeracja

{{#tabs}}
{{#tab name="az cli"}}
```bash
# List Servers
az sql server list # managed identities are enumerated here too
## List Server Usages
az sql server list-usages --name <server_name> --resource-group <resource_group>
## List Server Firewalls
az sql server firewall-rule list --resource-group <resource_group> --server <server_name>
## List of Azure Active Directory administrators in a server.
az sql server ad-admin list --resource-group <resource_group> --server <server_name>
## Gets an advanced threat protection
az sql server advanced-threat-protection-setting show --resource-group <resource_group> --name <server_name>
## Get server's auditing policy.
az sql server audit-policy show --resource-group <resource_group> --name <server_name>
## Gets a server's secure connection policy.
az sql server conn-policy show --resource-group <resource_group> --server <server_name>
## Gets a list of server DNS aliases for a server.
az sql server dns-alias list --resource-group <resource_group> --server <server_name>
## List of server keys.
az sql server key list --resource-group <resource_group> --server <server_name>
## Gets a server encryption protector.
az sql server tde-key show --resource-group <resource_group> --server <server_name>

# List Databases in a SQL server
az sql db list --server <server_name> --resource-group <resource_group> #--output table
## Get details of a specific database
az sql db show --name <database_name> --server <server_name> --resource-group <resource_group>
## List database usages
az sql db list-usages --name <database_name> --server <server_name> --resource-group <resource_group>
## List of operations performed on the database.
az sql db op list --database <database_name> --server <server_name> --resource-group <resource_group>
## List sql database classification
az sql db classification list --name <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention backups for a SQL database
az sql db ltr-backup list --database <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention policy
az sql db ltr-policy --name <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention policy
az sql db str-policy --name <database_name> --server <server_name> --resource-group <resource_group>
## List the replicas of a database and their replication status
az sql db replica list-links --name <database_name> --server <server_name> --resource-group <resource_group>
## List deleted SQL databases
az sql db list-deleted --server <server_name> --resource-group <resource_group>
## List database usages
az sql db list-usages --name <database_name> --server <server_name> --resource-group <resource_group>
## List restorable dropped databases in a SQL server
az sql db list-deleted --server <server_name> --resource-group <resource_group>
## List advanced threat protection setting show
az sql db advanced-threat-protection-setting --name <database_name> --server <server_name> --resource-group <resource_group>

# List all elastic pools in a SQL server
az sql elastic-pool list --server <server_name> --resource-group <resource_group> #--output table
## List all databases in a specific elastic pool
az sql elastic-pool show --name <elastic_pool_name>  --server <server_name> --resource-group <resource_group>
## List of databases in an elastic pool.
az sql elastic-pool list-dbs --name <elastic_pool_name>  --server <server_name> --resource-group <resource_group>

# List all managed Instances
az sql mi list
az sql mi show --resource-group <res-grp> --name <name>
az sql midb list
az sql midb show --resource-group <res-grp> --name <name>

# Lis all sql VM
az sql vm list
az sql vm show --resource-group <res-grp> --name <name>
```
{{#endtab}}

{{#tab name="Az PowerShell"}}
```bash
# List Servers
Get-AzSqlServer -ResourceGroupName "<resource-group-name>"

# List All Databases in a SQL Server
Get-AzSqlDatabase -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# Get Details of a Specific Database
Get-AzSqlDatabase -Name "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List Operations Performed on the Database
Get-AzSqlDatabaseActivity -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List SQL Database Classification
Get-AzSqlDatabaseSensitivityClassification -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List Long-Term Retention Backups for a SQL Database
Get-AzSqlDatabaseLongTermRetentionBackup -ResourceGroupName "<resource_group>" -Location "<location>"
# List Replicas of a Database and Their Replication Status
Get-AzSqlDatabaseReplicationLink -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# List Deleted SQL Databases
Get-AzSqlDeletedDatabaseBackup -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List All Elastic Pools in a SQL Server
Get-AzSqlElasticPool -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# List All Databases in a Specific Elastic Pool
Get-AzSqlElasticPoolDatabase -ElasticPoolName "<elastic_pool_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List all managed Instances
Get-AzSqlInstance
Get-AzSqlInstance -ResourceGroupName <ResourceGroupName> -Name <ManagedInstanceName>

# List All Databases in a SQL Managed Instance
Get-AzSqlInstanceDatabase -ResourceGroupName <ResourceGroupName> -InstanceName <ManagedInstanceName>

# Lis all sql VM
Get-AzSqlVM
```
{{#endtab}}
{{#endtabs}}

### Połącz i uruchom zapytania SQL

Możesz znaleźć ciąg połączenia (zawierający dane uwierzytelniające) w przykładzie [enumerating an Az WebApp](az-app-services.md):
```bash
function invoke-sql{
param($query)
$Connection_string = "Server=tcp:supercorp.database.windows.net,1433;Initial Catalog=flag;Persist Security Info=False;User ID=db_read;Password=gAegH!324fAG!#1fht;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
$Connection = New-Object System.Data.SqlClient.SqlConnection $Connection_string
$Connection.Open()
$Command = New-Object System.Data.SqlClient.SqlCommand
$Command.Connection = $Connection
$Command.CommandText = $query
$Reader = $Command.ExecuteReader()
while ($Reader.Read()) {
$Reader.GetValue(0)
}
$Connection.Close()
}

invoke-sql 'Select Distinct TABLE_NAME From information_schema.TABLES;'
```
Możesz również użyć sqlcmd, aby uzyskać dostęp do bazy danych. Ważne jest, aby wiedzieć, czy serwer pozwala na publiczne połączenia `az sql server show --name <server-name> --resource-group <resource-group>`, a także czy reguła zapory pozwala naszemu adresowi IP na dostęp:
```bash
sqlcmd -S <sql-server>.database.windows.net -U <server-user> -P <server-passworkd> -d <database>
```
## Odniesienia

- [https://learn.microsoft.com/en-us/azure/azure-sql/azure-sql-iaas-vs-paas-what-is-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/azure-sql-iaas-vs-paas-what-is-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/database/single-database-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/database/single-database-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/virtual-machines/windows/sql-server-on-azure-vm-iaas-what-is-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/virtual-machines/windows/sql-server-on-azure-vm-iaas-what-is-overview?view=azuresql)

## Eskalacja Uprawnień

{{#ref}}
../az-privilege-escalation/az-sql-privesc.md
{{#endref}}

## Po Eksploatacji

{{#ref}}
../az-post-exploitation/az-sql-post-exploitation.md
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
