# Az - SQL

{{#include ../../../banners/hacktricks-training.md}}

## Azure SQL

Azure SQL 是一系列托管、安全和智能的产品，使用 **Azure 云中的 SQL Server 数据库引擎**。这意味着您不必担心服务器的物理管理，可以专注于管理您的数据。

Azure SQL 由三个主要产品组成：

1. **Azure SQL 数据库**：这是一个 **完全托管的数据库服务**，允许您在 Azure 云中托管单个数据库。它提供内置智能，学习您独特的数据库模式，并提供定制的建议和自动调优。
2. **Azure SQL 托管实例**：这是针对更大规模的整个 SQL Server 实例范围的部署。它与最新的 SQL Server 本地（企业版）数据库引擎几乎 100% 兼容，提供本地虚拟网络（VNet）实现，解决常见的安全问题，并为本地 SQL Server 客户提供有利的商业模式。
3. **Azure SQL 服务器在 Azure 虚拟机上**：这是基础设施即服务（IaaS），最适合您希望 **控制操作系统和 SQL Server 实例** 的迁移，就像在本地运行的服务器一样。

### Azure SQL 数据库

**Azure SQL 数据库** 是一个 **完全托管的数据库平台即服务（PaaS）**，提供可扩展和安全的关系数据库解决方案。它基于最新的 SQL Server 技术，消除了基础设施管理的需要，使其成为基于云的应用程序的热门选择。

#### 关键特性

- **始终保持最新**：运行在最新的稳定版本的 SQL Server 上，并自动接收新功能和补丁。
- **PaaS 能力**：内置高可用性、备份和更新。
- **数据灵活性**：支持关系和非关系数据（例如，图形、JSON、空间和 XML）。

#### 购买模型 / 服务层级

- **基于 vCore**：独立选择计算、内存和存储。适用于通用用途、业务关键（具有高弹性和 OLTP 应用的性能），可扩展至 128 TB 存储。
- **基于 DTU**：将计算、内存和 I/O 打包成固定层级。为常见任务提供平衡资源。
- 标准：为常见任务提供平衡资源。
- 高级：为高负载提供高性能。

#### 部署模型

Azure SQL 数据库支持灵活的部署选项，以满足各种需求：

- **单一数据库**：
  - 完全隔离的数据库，拥有自己的专用资源。
  - 非常适合微服务或需要单一数据源的应用程序。
- **弹性池**：
  - 允许多个数据库在池中共享资源。
  - 对于多个数据库之间使用模式波动的应用程序，具有成本效益。

#### 可扩展性能和池

- **单一数据库**：每个数据库都是隔离的，拥有自己的专用计算、内存和存储资源。资源可以动态扩展（向上或向下），无需停机（1–128 vCores，32 GB–4 TB 存储，最多 128 TB）。
- **弹性池**：在池中跨多个数据库共享资源，以最大化效率并节省成本。资源也可以为整个池动态扩展。
- **服务层级灵活性**：从通用用途层中的单一数据库开始。随着需求的增长，升级到业务关键或超大规模层。
- **扩展选项**：动态扩展或自动扩展替代方案。

#### 内置监控与优化

- **查询存储**：跟踪性能问题，识别主要资源消耗者，并提供可操作的建议。
- **自动调优**：通过自动索引和查询计划修正等功能主动优化性能。
- **遥测集成**：通过 Azure Monitor、事件中心或 Azure 存储支持监控，以获取定制的见解。

#### 灾难恢复与可用性

- **自动备份**：SQL 数据库自动执行数据库的完整、差异和事务日志备份。
- **时间点恢复**：在备份保留期内将数据库恢复到任何过去状态。
- **地理冗余**
- **故障转移组**：通过将数据库分组以实现跨区域的自动故障转移，简化灾难恢复。

### Azure SQL 托管实例

**Azure SQL 托管实例** 是一个平台即服务（PaaS）数据库引擎，提供与 SQL Server 几乎 100% 的兼容性，并自动处理大多数管理任务（例如，升级、打补丁、备份、监控）。它为迁移本地 SQL Server 数据库提供了云解决方案，几乎不需要更改。

#### 服务层级

- **通用用途**：适用于具有标准 I/O 和延迟要求的应用程序的经济实惠选项。
- **业务关键**：为关键工作负载提供低 I/O 延迟的高性能选项。

#### 高级安全特性

* **威胁保护**：高级威胁保护警报可检测可疑活动和 SQL 注入攻击。审计以跟踪和记录数据库事件以确保合规性。
* **访问控制**：Microsoft Entra 身份验证用于集中身份管理。行级安全性和动态数据掩码用于细粒度访问控制。
* **备份**：具有时间点恢复能力的自动和手动备份。

### Azure SQL 虚拟机

**Azure SQL 虚拟机** 最适合您希望 **控制操作系统和 SQL Server 实例** 的迁移，就像在本地运行的服务器一样。它可以有不同的机器大小，以及广泛的 SQL Server 版本和版本选择。

#### 关键特性

**自动备份**：为 SQL 数据库安排备份。
**自动打补丁**：在维护窗口期间自动安装 Windows 和 SQL Server 更新。
**Azure 密钥保管库集成**：自动为 SQL Server 虚拟机配置密钥保管库。
**云防御者集成**：在门户中查看 SQL 的防御者建议。
**版本/版本灵活性**：在不重新部署虚拟机的情况下更改 SQL Server 版本或版本元数据。

#### 安全特性

**Microsoft Defender for SQL**：安全见解和警报。
**Azure 密钥保管库集成**：安全存储凭据和加密密钥。
**Microsoft Entra（Azure AD）**：身份验证和访问控制。

## 枚举

{{#tabs}}
{{#tab name="az cli"}}
```bash
# List Servers
az sql server list # --output table
## List Server Usages
az sql server list-usages --name <server_name> --resource-group <resource_group>
## List Server Firewalls
az sql server firewall-rule list --resource-group <resource_group> --server <server_name>
## List of Azure Active Directory administrators in a server.
az sql server ad-admin list --resource-group <resource_group> --server <server_name>
## Gets an advanced threat protection
az sql server advanced-threat-protection-setting show --resource-group <resource_group> --name <server_name>
## Get server's auditing policy.
az sql server audit-policy show --resource-group <resource_group> --name <server_name>
## Gets a server's secure connection policy.
az sql server conn-policy show --resource-group <resource_group> --server <server_name>
## Gets a list of server DNS aliases for a server.
az sql server dns-alias list --resource-group <resource_group> --server <server_name>
## List of server keys.
az sql server key list --resource-group <resource_group> --server <server_name>
## Gets a server encryption protector.
az sql server tde-key show --resource-group <resource_group> --server <server_name>

# List Databases in a SQL server
az sql db list --server <server_name> --resource-group <resource_group> #--output table
## Get details of a specific database
az sql db show --name <database_name> --server <server_name> --resource-group <resource_group>
## List database usages
az sql db list-usages --name <database_name> --server <server_name> --resource-group <resource_group>
## List of operations performed on the database.
az sql db op list --database <database_name> --server <server_name> --resource-group <resource_group>
## List sql database classification
az sql db classification list --name <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention backups for a SQL database
az sql db ltr-backup list --database <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention policy
az sql db ltr-policy --name <database_name> --server <server_name> --resource-group <resource_group>
## List long-term retention policy
az sql db str-policy --name <database_name> --server <server_name> --resource-group <resource_group>
## List the replicas of a database and their replication status
az sql db replica list-links --name <database_name> --server <server_name> --resource-group <resource_group>
## List deleted SQL databases
az sql db list-deleted --server <server_name> --resource-group <resource_group>
## List database usages
az sql db list-usages --name <database_name> --server <server_name> --resource-group <resource_group>
## List restorable dropped databases in a SQL server
az sql db list-deleted --server <server_name> --resource-group <resource_group>
## List advanced threat protection setting show
az sql db advanced-threat-protection-setting --name <database_name> --server <server_name> --resource-group <resource_group>

# List all elastic pools in a SQL server
az sql elastic-pool list --server <server_name> --resource-group <resource_group> #--output table
## List all databases in a specific elastic pool
az sql elastic-pool show --name <elastic_pool_name>  --server <server_name> --resource-group <resource_group>
## List of databases in an elastic pool.
az sql elastic-pool list-dbs --name <elastic_pool_name>  --server <server_name> --resource-group <resource_group>

# List all managed Instances
az sql mi list
az sql mi show --resource-group <res-grp> --name <name>
az sql midb list
az sql midb show --resource-group <res-grp> --name <name>

# Lis all sql VM
az sql vm list
az sql vm show --resource-group <res-grp> --name <name>
```
{{#endtab}}

{{#tab name="Az PowerShell"}}
```powershell
# List Servers
Get-AzSqlServer -ResourceGroupName "<resource-group-name>"

# List All Databases in a SQL Server
Get-AzSqlDatabase -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# Get Details of a Specific Database
Get-AzSqlDatabase -Name "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List Operations Performed on the Database
Get-AzSqlDatabaseActivity -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List SQL Database Classification
Get-AzSqlDatabaseSensitivityClassification -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List Long-Term Retention Backups for a SQL Database
Get-AzSqlDatabaseLongTermRetentionBackup -ResourceGroupName "<resource_group>" -Location "<location>"
# List Replicas of a Database and Their Replication Status
Get-AzSqlDatabaseReplicationLink -DatabaseName "<database_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# List Deleted SQL Databases
Get-AzSqlDeletedDatabaseBackup -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List All Elastic Pools in a SQL Server
Get-AzSqlElasticPool -ServerName "<server_name>" -ResourceGroupName "<resource_group>"
# List All Databases in a Specific Elastic Pool
Get-AzSqlElasticPoolDatabase -ElasticPoolName "<elastic_pool_name>" -ServerName "<server_name>" -ResourceGroupName "<resource_group>"

# List all managed Instances
Get-AzSqlInstance
Get-AzSqlInstance -ResourceGroupName <ResourceGroupName> -Name <ManagedInstanceName>

# List All Databases in a SQL Managed Instance
Get-AzSqlInstanceDatabase -ResourceGroupName <ResourceGroupName> -InstanceName <ManagedInstanceName>

# Lis all sql VM
Get-AzSqlVM
```
{{#endtab}}
{{#endtabs}}

### 连接并运行 SQL 查询

您可以从示例 [枚举 Az WebApp](az-app-services.md) 中找到连接字符串（包含凭据）：
```powershell
function invoke-sql{
param($query)
$Connection_string = "Server=tcp:supercorp.database.windows.net,1433;Initial Catalog=flag;Persist Security Info=False;User ID=db_read;Password=gAegH!324fAG!#1fht;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
$Connection = New-Object System.Data.SqlClient.SqlConnection $Connection_string
$Connection.Open()
$Command = New-Object System.Data.SqlClient.SqlCommand
$Command.Connection = $Connection
$Command.CommandText = $query
$Reader = $Command.ExecuteReader()
while ($Reader.Read()) {
$Reader.GetValue(0)
}
$Connection.Close()
}

invoke-sql 'Select Distinct TABLE_NAME From information_schema.TABLES;'
```
您还可以使用 sqlcmd 访问数据库。了解服务器是否允许公共连接很重要 `az sql server show --name <server-name> --resource-group <resource-group>`，以及防火墙规则是否允许我们的 IP 访问：
```powershell
sqlcmd -S <sql-server>.database.windows.net -U <server-user> -P <server-passworkd> -d <database>
```
## 参考文献

- [https://learn.microsoft.com/en-us/azure/azure-sql/azure-sql-iaas-vs-paas-what-is-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/azure-sql-iaas-vs-paas-what-is-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/database/single-database-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/database/single-database-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview?view=azuresql)
- [https://learn.microsoft.com/en-us/azure/azure-sql/virtual-machines/windows/sql-server-on-azure-vm-iaas-what-is-overview?view=azuresql](https://learn.microsoft.com/en-us/azure/azure-sql/virtual-machines/windows/sql-server-on-azure-vm-iaas-what-is-overview?view=azuresql)

## 权限提升

{{#ref}}
../az-privilege-escalation/az-sql-privesc.md
{{#endref}}

## 后期利用

{{#ref}}
../az-post-exploitation/az-sql-post-exploitation.md
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
