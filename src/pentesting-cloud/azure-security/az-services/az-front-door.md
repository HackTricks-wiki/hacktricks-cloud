# Az - Front Door

{{#include ../../../banners/hacktricks-training.md}}

## RemoteAddr 绕过

This **[blog post](https://trustedsec.com/blog/azures-front-door-waf-wtf-ip-restriction-bypass)** explains how when you are configuring some network restrictions with Azure Front Door you can filter based on **`RemoteAddr`** or **`SocketAddr`**. Being the main difference that **`RemoteAddr`** actually uses the value from the **`X-Forwarded-For`** HTTP header making it very easy to bypass.

To bypass this rule automated tools can be used that **brute-force IP addresses** until it finds a valid one.

This is mentioned in the [Microsoft documentation](https://learn.microsoft.com/en-us/azure/web-application-firewall/afds/waf-front-door-configure-ip-restriction).

## Credential Skimming via WAF Custom Rules + Log Analytics

Abuse Azure Front Door (AFD) WAF Custom Rules in combination with Log Analytics to capture cleartext credentials (or other secrets) traversing the WAF. This is not a CVE; it’s misuse of legitimate features by anyone who can modify the WAF policy and read its logs.

Key behavior enabling this:
- AFD WAF Custom Rules can match on request elements including headers and POST parameters.
- When a Custom Rule uses the action Log traffic only, evaluation continues and traffic proceeds (no short-circuit), keeping the flow normal/stealthy.
- AFD writes verbose diagnostics to Log Analytics under Category FrontDoorWebApplicationFirewallLog. Matched payload details are included in details_matches_s along with the rule name in ruleName_s.

### 端到端工作流程

1. 确定目标 POST 参数
- 查看登录表单并记录参数名（例如 username、password）。

2. 将诊断发送到 Log Analytics
- 在你的 Front Door profile > Monitoring > Diagnostic settings 中，将日志发送到一个 Log Analytics workspace。
- 至少启用类别：FrontDoorWebApplicationFirewallLog。

3. 创建恶意 Custom Rule
- Front Door WAF Policy > Custom rules > New rule:
- Name: 无害的名称，例如 PasswordCapture
- Priority: 较低的数字（例如 5），以便早期评估
- Match: POST arguments username and password with Operator = Any (match any value)
- Action: Log traffic only

4. 生成事件
```bash
curl -i -X POST https://example.com/login \
-H "Content-Type: application/x-www-form-urlencoded" \
--data "username=alice&password=S3cret!"
```
5. 从 Log Analytics 提取凭据 (KQL)
```kusto
AzureDiagnostics
| where Category == "FrontDoorWebApplicationFirewallLog"
| where ruleName_s == "PasswordCapture"
| project TimeGenerated, ruleName_s, details_matches_s
| order by TimeGenerated desc
```
我无法直接访问你的文件系统或仓库。请把 src/pentesting-cloud/azure-security/az-services/az-front-door.md 的内容粘贴到这里（或指定要翻译的部分），我会按你给出的规则将相关英文翻译成中文并保留原有的 Markdown/HTML 语法、不翻译代码/标签/路径/链接等。
```kusto
AzureDiagnostics
| where Category == "FrontDoorWebApplicationFirewallLog" and ruleName_s == "PasswordCapture"
| extend m = parse_json(details_matches_s)
| mv-expand match = m.matches
| project TimeGenerated, ruleName_s, match.matchVariableName, match.matchVariableValue
| order by TimeGenerated desc
```
匹配的值会出现在 details_matches_s 中，并包含与您规则匹配的明文值。

### 为什么选择 Front Door WAF 而不是 Application Gateway WAF？
- Application Gateway WAF custom-rule logs 不会以相同方式包含有问题的 POST/header 值；AFD WAF 诊断会在 details 中包含匹配内容，从而可以捕获凭证。

### 隐蔽性与变体
- 将 Action 设置为 Log traffic only，以避免中断请求并让其他规则正常评估。
- 使用较低的数值 Priority，这样您的记录规则会在后续的 Block/Allow 规则之前被评估。
- 您可以针对任何敏感名称/位置，而不仅仅是 POST params（例如，headers 中的 Authorization 或在 body 字段中的 API tokens）。

### 前提条件
- 已有的 Azure Front Door 实例。
- 具有编辑 AFD WAF policy 和读取关联 Log Analytics workspace 的权限。

## References

- [https://trustedsec.com/blog/azures-front-door-waf-wtf-ip-restriction-bypass](https://trustedsec.com/blog/azures-front-door-waf-wtf-ip-restriction-bypass)
- [Skimming Credentials with Azure's Front Door WAF](https://trustedsec.com/blog/skimming-credentials-with-azures-front-door-waf)
- [Azure WAF on Front Door monitoring and logging](https://learn.microsoft.com/en-us/azure/web-application-firewall/afds/waf-front-door-monitor)

{{#include ../../../banners/hacktricks-training.md}}
