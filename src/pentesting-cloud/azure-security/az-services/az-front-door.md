# Az - Front Door

{{#include ../../../banners/hacktricks-training.md}}

## RemoteAddr Bypass

This **[blog post](https://trustedsec.com/blog/azures-front-door-waf-wtf-ip-restriction-bypass)** εξηγεί πώς όταν διαμορφώνετε κάποιους περιορισμούς δικτύου με Azure Front Door μπορείτε να φιλτράρετε βάσει **`RemoteAddr`** ή **`SocketAddr`**. Η κύρια διαφορά είναι ότι **`RemoteAddr`** χρησιμοποιεί την τιμή από την κεφαλίδα HTTP **`X-Forwarded-For`**, καθιστώντας το πολύ εύκολο να παρακαμφθεί.

Για να παρακάμψετε αυτόν τον κανόνα μπορούν να χρησιμοποιηθούν αυτοματοποιημένα εργαλεία που κάνουν **brute-force IP addresses** μέχρι να βρουν μία έγκυρη.

Αυτό αναφέρεται στη [Microsoft documentation](https://learn.microsoft.com/en-us/azure/web-application-firewall/afds/waf-front-door-configure-ip-restriction).

## Credential Skimming via WAF Custom Rules + Log Analytics

Abuse Azure Front Door (AFD) WAF Custom Rules σε συνδυασμό με το Log Analytics για να καταγράψετε cleartext credentials (ή άλλα μυστικά) που διέρχονται από το WAF. Αυτό δεν είναι CVE· είναι κατάχρηση νόμιμων λειτουργιών από οποιονδήποτε μπορεί να τροποποιήσει την πολιτική WAF και να διαβάσει τα logs.

Key behavior enabling this:
- Οι AFD WAF Custom Rules μπορούν να ταιριάξουν σε στοιχεία του αιτήματος, συμπεριλαμβανομένων των headers και των POST parameters.
- Όταν ένας Custom Rule χρησιμοποιεί τη δράση Log traffic only, η αξιολόγηση συνεχίζεται και η κίνηση προχωράει (χωρίς short-circuit), διατηρώντας τη ροή φυσιολογική/stealthy.
- Το AFD γράφει λεπτομερείς διαγνωστικές εγγραφές στο Log Analytics υπό την κατηγορία FrontDoorWebApplicationFirewallLog. Οι λεπτομέρειες του ταιριασμένου payload περιλαμβάνονται σε details_matches_s μαζί με το όνομα του κανόνα σε ruleName_s.

### Ολοκληρωμένη ροή εργασίας

1. Identify target POST parameters
- Εξετάστε τη φόρμα σύνδεσης και σημειώστε τα ονόματα παραμέτρων (π.χ., username, password).

2. Enable diagnostics to Log Analytics
- Στο Front Door profile > Monitoring > Diagnostic settings, στείλτε τα logs σε ένα Log Analytics workspace.
- Τουλάχιστον, ενεργοποιήστε την κατηγορία: FrontDoorWebApplicationFirewallLog.

3. Create a malicious Custom Rule
- Front Door WAF Policy > Custom rules > New rule:
- Name: ανεπιτήδευτο όνομα, π.χ., PasswordCapture
- Priority: χαμηλός αριθμός (π.χ., 5) ώστε να αξιολογείται νωρίς
- Match: POST arguments username and password with Operator = Any (match any value)
- Action: Log traffic only

4. Generate events
```bash
curl -i -X POST https://example.com/login \
-H "Content-Type: application/x-www-form-urlencoded" \
--data "username=alice&password=S3cret!"
```
5. Εξαγωγή credentials από Log Analytics (KQL)
```kusto
AzureDiagnostics
| where Category == "FrontDoorWebApplicationFirewallLog"
| where ruleName_s == "PasswordCapture"
| project TimeGenerated, ruleName_s, details_matches_s
| order by TimeGenerated desc
```
You didn't include the content of src/pentesting-cloud/azure-security/az-services/az-front-door.md. Paste the markdown (or upload the file) and I'll translate the English text to Greek following your rules.
```kusto
AzureDiagnostics
| where Category == "FrontDoorWebApplicationFirewallLog" and ruleName_s == "PasswordCapture"
| extend m = parse_json(details_matches_s)
| mv-expand match = m.matches
| project TimeGenerated, ruleName_s, match.matchVariableName, match.matchVariableValue
| order by TimeGenerated desc
```
Οι τιμές που ταιριάχτηκαν εμφανίζονται στο details_matches_s και περιλαμβάνουν τις cleartext τιμές που αντιστοιχούν στον κανόνα σας.

### Γιατί Front Door WAF και όχι Application Gateway WAF?
- Οι logs των custom-rule του Application Gateway WAF δεν περιλαμβάνουν τις προβληματικές POST/header τιμές με τον ίδιο τρόπο· τα AFD WAF diagnostics περιλαμβάνουν το matched content στα details, επιτρέποντας την καταγραφή διαπιστευτηρίων.

### Απόκρυψη και παραλλαγές
- Ορίστε το Action σε "Log traffic only" για να αποφύγετε τη διακοπή αιτημάτων και να διατηρήσετε την κανονική αξιολόγηση των υπόλοιπων κανόνων.
- Χρησιμοποιήστε μικρή αριθμητική τιμή στο Priority ώστε ο logging κανόνας σας να αξιολογείται πριν από τυχόν μεταγενέστερους Block/Allow κανόνες.
- Μπορείτε να στοχεύσετε οποιαδήποτε ευαίσθητα ονόματα/τοποθεσίες, όχι μόνο POST params (π.χ., headers όπως Authorization ή API tokens σε body fields).

### Προαπαιτούμενα
- Υπάρχουσα Azure Front Door instance.
- Δικαιώματα για επεξεργασία της AFD WAF policy και ανάγνωση του συνδεδεμένου Log Analytics workspace.

## Αναφορές

- [https://trustedsec.com/blog/azures-front-door-waf-wtf-ip-restriction-bypass](https://trustedsec.com/blog/azures-front-door-waf-wtf-ip-restriction-bypass)
- [Skimming Credentials with Azure's Front Door WAF](https://trustedsec.com/blog/skimming-credentials-with-azures-front-door-waf)
- [Azure WAF on Front Door monitoring and logging](https://learn.microsoft.com/en-us/azure/web-application-firewall/afds/waf-front-door-monitor)

{{#include ../../../banners/hacktricks-training.md}}
