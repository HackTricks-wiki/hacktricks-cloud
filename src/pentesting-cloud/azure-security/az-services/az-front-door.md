# Az - Front Door

{{#include ../../../banners/hacktricks-training.md}}

## RemoteAddr Bypass

Bu **[blog post](https://trustedsec.com/blog/azures-front-door-waf-wtf-ip-restriction-bypass)**, Azure Front Door ile bazı ağ kısıtlamaları yapılandırırken **`RemoteAddr`** veya **`SocketAddr`** bazında filtre uygulayabileceğinizi açıklar. Temel fark, **`RemoteAddr`**'ın gerçekte **`X-Forwarded-For`** HTTP başlığındaki değeri kullanmasıdır; bu da atlatmayı çok kolaylaştırır.

Bu kuralı atlatmak için geçerli bir adres bulana kadar **brute-force IP addresses** yapan otomatik araçlar kullanılabilir.

Bu, [Microsoft documentation](https://learn.microsoft.com/en-us/azure/web-application-firewall/afds/waf-front-door-configure-ip-restriction) içinde belirtilmiştir.

## Credential Skimming via WAF Custom Rules + Log Analytics

Azure Front Door (AFD) WAF Custom Rules ile Log Analytics’i birleştirip WAF üzerinden geçen açık metin kimlik bilgilerini (veya diğer sırları) yakalamak için özellikler kötüye kullanılabilir. Bu bir CVE değil; WAF politikasını değiştirebilen ve loglarını okuyabilen herhangi bir kişinin meşru özellikleri kötüye kullanmasıdır.

Key behavior enabling this:
- AFD WAF Custom Rules istek öğeleri üzerinde, header'lar ve POST parametreleri dahil olmak üzere, eşleme yapabilir.
- Bir Custom Rule eylem olarak "Log traffic only" kullandığında değerlendirme devam eder ve trafik ilerler (kısa devre olmaz), akış normal/gizli kalır.
- AFD, Log Analytics’e Category FrontDoorWebApplicationFirewallLog altında ayrıntılı diagnostikler yazar. Eşleşen payload detayları details_matches_s içinde ve kural adı ruleName_s ile birlikte bulunur.

### End-to-end workflow

1. Identify target POST parameters
- Giriş formunu inceleyin ve parametre adlarını not edin (ör. username, password).

2. Enable diagnostics to Log Analytics
- In your Front Door profile > Monitoring > Diagnostic settings, send logs to a Log Analytics workspace.
- En azından şu kategoriyi etkinleştirin: FrontDoorWebApplicationFirewallLog.

3. Create a malicious Custom Rule
- Front Door WAF Policy > Custom rules > New rule:
- Name: innocuous name, e.g., PasswordCapture
- Priority: düşük bir sayı (ör. 5) verin ki erken değerlendirilir
- Match: POST arguments username and password with Operator = Any (match any value)
- Action: Log traffic only

4. Olaylar oluşturun
```bash
curl -i -X POST https://example.com/login \
-H "Content-Type: application/x-www-form-urlencoded" \
--data "username=alice&password=S3cret!"
```
5. Log Analytics (KQL) içinden credentials çıkarma
```kusto
AzureDiagnostics
| where Category == "FrontDoorWebApplicationFirewallLog"
| where ruleName_s == "PasswordCapture"
| project TimeGenerated, ruleName_s, details_matches_s
| order by TimeGenerated desc
```
Lütfen çevirmek istediğiniz "src/pentesting-cloud/azure-security/az-services/az-front-door.md" dosya içeriğini gönderin.
```kusto
AzureDiagnostics
| where Category == "FrontDoorWebApplicationFirewallLog" and ruleName_s == "PasswordCapture"
| extend m = parse_json(details_matches_s)
| mv-expand match = m.matches
| project TimeGenerated, ruleName_s, match.matchVariableName, match.matchVariableValue
| order by TimeGenerated desc
```
Eşleşen değerler details_matches_s içinde görünür ve kuralınızla eşleşen cleartext değerlerini içerir.

### Neden Front Door WAF, Application Gateway WAF değil?
- Application Gateway WAF'in custom-rule log'ları aynı şekilde sorunlu POST/header değerlerini içermez; AFD WAF diagnostics eşleşen içeriği details içinde dahil ederek kimlik bilgisi yakalamayı mümkün kılar.

### Gizlenme ve varyantlar
- İstekleri bozmayı önlemek ve diğer kuralların normal şekilde değerlendirilmesini sağlamak için Action'ı yalnızca Log traffic olarak ayarlayın.
- Logging kuralınızın sonraki herhangi bir Block/Allow kuralından önce değerlendirilmesi için Priority'yi düşük bir sayısal değer yapın.
- Sadece POST params değil; Authorization gibi header'lar veya body alanlarındaki API tokens gibi herhangi bir hassas isim/konumu hedefleyebilirsiniz.

### Prerequisites
- Mevcut bir Azure Front Door instance.
- AFD WAF policy'ını düzenleme ve ilişkili Log Analytics workspace'i okuma izinleri.

## References

- [https://trustedsec.com/blog/azures-front-door-waf-wtf-ip-restriction-bypass](https://trustedsec.com/blog/azures-front-door-waf-wtf-ip-restriction-bypass)
- [Skimming Credentials with Azure's Front Door WAF](https://trustedsec.com/blog/skimming-credentials-with-azures-front-door-waf)
- [Azure WAF on Front Door monitoring and logging](https://learn.microsoft.com/en-us/azure/web-application-firewall/afds/waf-front-door-monitor)

{{#include ../../../banners/hacktricks-training.md}}
