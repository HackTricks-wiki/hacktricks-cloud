# Az - Front Door

{{#include ../../../banners/hacktricks-training.md}}

## RemoteAddr Bypass

This **[blog post](https://trustedsec.com/blog/azures-front-door-waf-wtf-ip-restriction-bypass)** explica cómo, cuando configuras ciertas restricciones de red con Azure Front Door, puedes filtrar basándote en **`RemoteAddr`** o **`SocketAddr`**. La diferencia principal es que **`RemoteAddr`** usa en realidad el valor de la cabecera HTTP **`X-Forwarded-For`**, lo que hace muy fácil el bypass.

Para realizar un bypass de esta regla se pueden usar herramientas automatizadas que **brute-force IP addresses** hasta encontrar una válida.

Esto se menciona en la [Microsoft documentation](https://learn.microsoft.com/en-us/azure/web-application-firewall/afds/waf-front-door-configure-ip-restriction).

## Credential Skimming via WAF Custom Rules + Log Analytics

Abusar de Azure Front Door (AFD) WAF Custom Rules en combinación con Log Analytics para capturar credenciales en texto claro (u otros secretos) que atraviesen el WAF. Esto no es una CVE; es el uso indebido de funcionalidades legítimas por cualquiera que pueda modificar la WAF policy y leer sus logs.

Key behavior enabling this:
- AFD WAF Custom Rules pueden hacer match en elementos de la request, incluyendo headers y parámetros POST.
- Cuando una Custom Rule usa la acción Log traffic only, la evaluación continúa y el tráfico procede (no hay short-circuit), manteniendo el flujo normal/stealthy.
- AFD escribe diagnósticos detallados en Log Analytics bajo la Category FrontDoorWebApplicationFirewallLog. Los detalles de la carga coincidente se incluyen en details_matches_s junto con el nombre de la regla en ruleName_s.

### Flujo de trabajo de extremo a extremo

1. Identificar parámetros POST objetivo
- Inspecciona el formulario de login y anota los nombres de los parámetros (p. ej., username, password).

2. Habilitar diagnósticos en Log Analytics
- En tu Front Door profile > Monitoring > Diagnostic settings, envía los logs a un Log Analytics workspace.
- Como mínimo, habilita la categoría: FrontDoorWebApplicationFirewallLog.

3. Crear una Custom Rule maliciosa
- Front Door WAF Policy > Custom rules > New rule:
- Name: nombre inocuo, p. ej., PasswordCapture
- Priority: número bajo (p. ej., 5) para que se evalúe temprano
- Match: argumentos POST username y password con Operator = Any (match any value)
- Action: Log traffic only

4. Generar eventos
```bash
curl -i -X POST https://example.com/login \
-H "Content-Type: application/x-www-form-urlencoded" \
--data "username=alice&password=S3cret!"
```
5. Extraer credenciales de Log Analytics (KQL)
```kusto
AzureDiagnostics
| where Category == "FrontDoorWebApplicationFirewallLog"
| where ruleName_s == "PasswordCapture"
| project TimeGenerated, ruleName_s, details_matches_s
| order by TimeGenerated desc
```
No veo el contenido del archivo. Por favor pega aquí el contenido completo de src/pentesting-cloud/azure-security/az-services/az-front-door.md que quieres traducir y lo traduciré al español manteniendo exactamente el mismo markdown/html, tags y rutas según tus instrucciones.
```kusto
AzureDiagnostics
| where Category == "FrontDoorWebApplicationFirewallLog" and ruleName_s == "PasswordCapture"
| extend m = parse_json(details_matches_s)
| mv-expand match = m.matches
| project TimeGenerated, ruleName_s, match.matchVariableName, match.matchVariableValue
| order by TimeGenerated desc
```
Los valores que coinciden aparecen en details_matches_s e incluyen los valores en cleartext que coincidieron con tu regla.

### ¿Por qué Front Door WAF y no Application Gateway WAF?
- Los registros de custom-rule de Application Gateway WAF no incluyen los valores POST/header ofensivos de la misma manera; los diagnósticos de AFD WAF incluyen el contenido matched en details, permitiendo la captura de credenciales.

### Sigilo y variantes
- Configura Action a "Log traffic only" para evitar romper solicitudes y para que otras reglas sigan evaluándose normalmente.
- Usa una Priority numérica baja para que tu regla de logging se evalúe antes que cualquier regla Block/Allow posterior.
- Puedes apuntar a cualquier nombre/ubicación sensible, no solo POST params (p. ej., headers como Authorization o API tokens en campos del body).

### Requisitos previos
- Una instancia existente de Azure Front Door.
- Permisos para editar la política de AFD WAF y leer el Log Analytics workspace asociado.

## References

- [https://trustedsec.com/blog/azures-front-door-waf-wtf-ip-restriction-bypass](https://trustedsec.com/blog/azures-front-door-waf-wtf-ip-restriction-bypass)
- [Skimming Credentials with Azure's Front Door WAF](https://trustedsec.com/blog/skimming-credentials-with-azures-front-door-waf)
- [Azure WAF on Front Door monitoring and logging](https://learn.microsoft.com/en-us/azure/web-application-firewall/afds/waf-front-door-monitor)

{{#include ../../../banners/hacktricks-training.md}}
