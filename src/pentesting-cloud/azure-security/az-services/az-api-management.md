# Az - API Management

{{#include ../../../banners/hacktricks-training.md}}

## Informations de base

Azure API Management (APIM) est un service entièrement géré qui offre une **plate-forme unifiée pour publier, sécuriser, transformer, gérer et surveiller les APIs**. Il permet aux organisations de **centraliser leur stratégie API** et d'assurer une gouvernance, des performances et une sécurité cohérentes sur l'ensemble de leurs services. En agissant comme une couche d'abstraction entre les services backend et les consommateurs d'API, APIM simplifie l'intégration et améliore la maintenabilité tout en fournissant des capacités opérationnelles et de sécurité essentielles.

## Concepts clés

**The API Gateway** sert de point d'entrée unique pour tout le trafic API, gérant des fonctions telles que le routage des requêtes vers les services backend, l'application de limites de débit, la mise en cache des réponses et la gestion de l'authentification et de l'autorisation. Cette gateway est entièrement hébergée et gérée par Azure, garantissant une haute disponibilité et une grande évolutivité.

**The Developer Portal** fournit un environnement en libre-service où les consommateurs d'API peuvent découvrir les APIs disponibles, lire la documentation et tester les endpoints. Il facilite l'onboarding en offrant des outils interactifs et l'accès aux informations d'abonnement.

**The Management Portal (Management Plane)** est utilisé par les administrateurs pour configurer et maintenir le service APIM. Depuis cet espace, les utilisateurs peuvent définir des APIs et des opérations, configurer le contrôle d'accès, appliquer des policies, gérer les utilisateurs et organiser les APIs en produits. Ce portail centralise l'administration et assure une gouvernance API cohérente.

## Authentification et autorisation

Azure API Management prend en charge plusieurs **mécanismes d'authentification** pour sécuriser l'accès aux APIs. Ceux-ci incluent les **subscription keys**, les **tokens OAuth 2.0** et les **certificats client**. APIM s'intègre également nativement avec **Microsoft Entra ID**, permettant une **gestion des identités de niveau entreprise** et un **accès sécurisé** aux APIs et aux services backend.

## Politiques

Les policies dans APIM permettent aux administrateurs de personnaliser le **traitement des requêtes et des réponses** à différents niveaux de granularité, y compris au niveau du **service**, de l'**API**, de l'**opération** ou du **produit**. Grâce aux policies, il est possible d'appliquer la **validation de token JWT**, de **transformer des payloads XML ou JSON**, d'**appliquer des limites de débit**, de **restreindre les appels par adresse IP**, ou d'**authentifier contre des services backend en utilisant des managed identities**. Les policies sont **très flexibles** et constituent l'une des **forces principales** de la plateforme API Management, permettant un **contrôle fin du comportement d'exécution** sans modifier le code backend.

## Named Values

Le service fournit un mécanisme appelé **Named Values**, qui permet de stocker des **informations de configuration** telles que des **secrets**, des **API keys**, ou d'autres valeurs requises par les policies.

Ces valeurs peuvent être stockées directement dans APIM ou référencées de manière sécurisée depuis **Azure Key Vault**. Named Values favorisent une **gestion sécurisée et centralisée** des données de configuration et simplifient la rédaction des policies en permettant des **références réutilisables** plutôt que des valeurs en dur.

### Réseau et intégration de sécurité

Azure API Management s'intègre parfaitement avec les environnements de **Virtual Network**, permettant une **connectivité privée et sécurisée** aux systèmes backend.

Lorsqu'il est déployé dans un **Virtual Network (VNet)**, APIM peut accéder aux **services internes** sans les exposer publiquement. Le service permet également la configuration de **certificats personnalisés** pour supporter l'**authentification mutual TLS** avec les services backend, améliorant la sécurité dans les scénarios où une **validation d'identité forte** est requise.

Ces **fonctionnalités réseau** rendent APIM adapté aux architectures **cloud-native** comme aux architectures **hybrides**.

### Énumération

Pour énumérer le service API Management :
```bash
# Lists all Named Values configured in the Azure API Management instance
az apim nv list --resource-group <resource-group> --service-name <service-name>

# Retrieves all policies applied at the API level in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"

# Retrieves the effective policy for a specific API in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01&format=rawxml"

# Gets the configuration details of the APIM service instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"

# Lists all backend services registered in the APIM instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"

# Retrieves details of a specific backend service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"

# Gets general information about the APIM service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>?api-version=2024-05-01"

# Calls an exposed API endpoint through the APIM gateway
curl https://<apim>.azure-api.net/<api-path>

```
{{#include ../../../banners/hacktricks-training.md}}
