# Az - API Management

{{#include ../../../banners/hacktricks-training.md}}

## Podstawowe informacje

Azure API Management (APIM) to w pełni zarządzana usługa, która oferuje **zunifikowaną platformę do publikowania, zabezpieczania, transformowania, zarządzania i monitorowania API**. Umożliwia organizacjom **scentralizowanie strategii API** i zapewnienie spójnego zarządzania, wydajności i bezpieczeństwa dla wszystkich usług. Działając jako warstwa abstrakcji między usługami zaplecza a konsumentami API, APIM upraszcza integrację i zwiększa utrzymywalność, jednocześnie zapewniając kluczowe możliwości operacyjne i bezpieczeństwa.

## Główne koncepcje

**The API Gateway** służy jako pojedynczy punkt wejścia dla całego ruchu API, obsługując funkcje takie jak kierowanie żądań do usług zaplecza, egzekwowanie limitów, buforowanie odpowiedzi oraz zarządzanie uwierzytelnianiem i autoryzacją. Ta bramka jest w pełni hostowana i zarządzana przez Azure, co zapewnia wysoką dostępność i skalowalność.

**Portal dla deweloperów (Developer Portal)** zapewnia środowisko samoobsługowe, w którym konsumenci API mogą odkrywać dostępne API, czytać dokumentację i testować endpointy. Ułatwia onboarding dzięki narzędziom interaktywnym i dostępowi do informacji o subskrypcjach.

**Portal zarządzania (Management Plane)** jest używany przez administratorów do konfigurowania i utrzymania usługi APIM. Stąd użytkownicy mogą definiować API i operacje, konfigurować kontrolę dostępu, stosować polityki, zarządzać użytkownikami i organizować API w produkty. Ten portal centralizuje administrację i zapewnia spójne zarządzanie API.

## Uwierzytelnianie i autoryzacja

Azure API Management obsługuje kilka mechanizmów uwierzytelniania w celu zabezpieczenia dostępu do API. Należą do nich klucze subskrypcji, tokeny OAuth 2.0 oraz certyfikaty klienta. APIM integruje się natywnie z Microsoft Entra ID, umożliwiając zarządzanie tożsamością na poziomie korporacyjnym oraz bezpieczny dostęp zarówno do API, jak i usług zaplecza.

## Polityki

Polityki w APIM pozwalają administratorom dostosować przetwarzanie żądań i odpowiedzi na różnych poziomach szczegółowości, w tym na poziomie serwisu, API, operacji lub produktu. Dzięki politykom można egzekwować walidację tokenów JWT, transformować ładunki XML lub JSON, stosować ograniczenia liczby żądań (rate limiting), ograniczać wywołania według adresu IP oraz uwierzytelniać się wobec usług zaplecza przy użyciu managed identities. Polityki są bardzo elastyczne i stanowią jedną z kluczowych zalet platformy API Management, umożliwiając drobiazgową kontrolę zachowania w czasie wykonania bez modyfikowania kodu zaplecza.

## Named Values

Usługa udostępnia mechanizm zwany **Named Values**, który pozwala przechowywać **informacje konfiguracyjne** takie jak **sekrety**, **klucze API** lub inne wartości wymagane przez polityki.

Wartości te można przechowywać bezpośrednio w APIM lub bezpiecznie odwoływać się do nich z **Azure Key Vault**. Named Values wspierają **bezpieczne i scentralizowane zarządzanie** danymi konfiguracyjnymi i upraszczają tworzenie polityk poprzez umożliwienie **wielokrotnego użycia odniesień** zamiast wartości na stałe w kodzie.

## Integracja sieciowa i bezpieczeństwo

Azure API Management integruje się bezproblemowo ze środowiskami **Virtual Network (VNet)**, umożliwiając prywatne i bezpieczne łączenie z systemami zaplecza.

Po wdrożeniu wewnątrz **Virtual Network (VNet)**, APIM może uzyskiwać dostęp do usług wewnętrznych bez ich publicznego udostępniania. Usługa pozwala także na konfigurację **własnych certyfikatów** w celu obsługi **mutual TLS** z usługami zaplecza, poprawiając bezpieczeństwo w scenariuszach wymagających **silnej walidacji tożsamości**.

Te funkcje sieciowe czynią APIM odpowiednim zarówno dla architektur **cloud-native**, jak i **hybrydowych**.

### Enumeracja

Aby przeprowadzić enumerację usługi API Management:
```bash
# Lists all Named Values configured in the Azure API Management instance
az apim nv list --resource-group <resource-group> --service-name <service-name>

# Retrieves all policies applied at the API level in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"

# Retrieves the effective policy for a specific API in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01&format=rawxml"

# Gets the configuration details of the APIM service instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"

# Lists all backend services registered in the APIM instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"

# Retrieves details of a specific backend service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"

# Gets general information about the APIM service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>?api-version=2024-05-01"

# Calls an exposed API endpoint through the APIM gateway
curl https://<apim>.azure-api.net/<api-path>

```
{{#include ../../../banners/hacktricks-training.md}}
