# Az - API Management

{{#include ../../../banners/hacktricks-training.md}}

## Basic Information

Azure API Management (APIM) je potpuno upravljana usluga koja nudi **jedinstvenu platformu za objavljivanje, zaštitu, transformaciju, upravljanje i nadgledanje API-ja**. Omogućava organizacijama da **centralizuju svoju API** strategiju i obezbede dosledno upravljanje, performanse i bezbednost kroz sve svoje servise. Delovanjem kao sloj apstrakcije između backend servisa i potrošača API-ja, APIM pojednostavljuje integraciju i poboljšava održavanje dok pruža ključne operativne i bezbednosne mogućnosti.

## Core Concepts

**The API Gateway** služi kao jedinstvena ulazna tačka za sav API saobraćaj, obavljajući funkcije kao što su rutiranje zahteva ka backend servisima, primena ograničenja brzine, keširanje odgovora i upravljanje autentifikacijom i autorizacijom. Ovaj gateway je potpuno hostovan i upravljan od strane Azure-a, obezbeđujući visoku dostupnost i skalabilnost.

**The Developer Portal** pruža samo-uslužno okruženje u kome potrošači API-ja mogu pronaći dostupne API-je, čitati dokumentaciju i testirati endpoint-e. Pomaže u ubrzavanju onboardinga nudeći interaktivne alate i pristup informacijama o pretplatama.

**The Management Portal (Management Plane)** koriste administratori za konfiguraciju i održavanje APIM servisa. Odatle korisnici mogu definisati API-je i operacije, konfigurisati kontrolu pristupa, primenjivati politike, upravljati korisnicima i organizovati API-je u proizvode. Ovaj portal centralizuje administraciju i obezbeđuje dosledno upravljanje API-jem.

## Authentication and Authorization

Azure API Management podržava nekoliko **mehanizama autentifikacije** za zaštitu pristupa API-ju. To uključuje **subscription keys**, **OAuth 2.0 tokens** i **client certificates**. APIM se takođe nativno integriše sa **Microsoft Entra ID**, omogućavajući upravljanje identitetima na nivou preduzeća i siguran pristup kako API-jima tako i backend servisima.

## Policies

Policies u APIM omogućavaju administratorima da prilagode **obradu zahteva i odgovora** na različitim nivoima granularnosti, uključujući nivo **service**, **API**, **operation** ili **product**. Kroz politike moguće je primeniti **JWT token validation**, **transform XML or JSON payloads**, **apply rate limiting**, **restrict calls by IP address**, ili **authenticate against backend services using managed identities**. Politike su **izuzetno fleksibilne** i predstavljaju jednu od **ključnih snaga** platforme API Management, omogućavajući **preciznu kontrolu ponašanja u runtime-u** bez izmene backend koda.

## Named Values

Servis pruža mehanizam nazvan **Named Values**, koji omogućava čuvanje **konfiguracionih informacija** kao što su **secrets**, **API keys**, ili druge vrednosti potrebne politikama.

Ove vrednosti mogu biti sačuvane direktno u APIM-u ili bezbedno referencirane iz **Azure Key Vault**. Named Values promovišu **sigurno i centralizovano upravljanje** konfiguracionim podacima i pojednostavljuju pisanje politika omogućavajući **reusable references** umesto hardkodovanih vrednosti.

## Networking and Security Integration

Azure API Management se besprekorno integriše sa **virtual network environments**, omogućavajući **privatnu i sigurnu povezanost** sa backend sistemima.

Kada je deploy-ovan unutar **Virtual Network (VNet)**, APIM može pristupiti **internal services** bez izlaganja istih javno. Servis takođe omogućava konfiguraciju **custom certificates** za podršku **mutual TLS authentication** sa backend servisima, poboljšavajući bezbednost u scenarijima gde je potrebna **snažna validacija identiteta**.

Ove **networking features** čine APIM pogodnim za oba slučaja — **cloud-native** i **hybrid architectures**.

### Enumeracija

Da biste enumerisali API Management servis:
```bash
# Lists all Named Values configured in the Azure API Management instance
az apim nv list --resource-group <resource-group> --service-name <service-name>

# Retrieves all policies applied at the API level in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"

# Retrieves the effective policy for a specific API in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01&format=rawxml"

# Gets the configuration details of the APIM service instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"

# Lists all backend services registered in the APIM instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"

# Retrieves details of a specific backend service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"

# Gets general information about the APIM service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>?api-version=2024-05-01"

# Calls an exposed API endpoint through the APIM gateway
curl https://<apim>.azure-api.net/<api-path>

```
{{#include ../../../banners/hacktricks-training.md}}
