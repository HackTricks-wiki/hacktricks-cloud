# Az - API Management

{{#include ../../../banners/hacktricks-training.md}}

## Βασικές Πληροφορίες

Azure API Management (APIM) είναι μια πλήρως διαχειριζόμενη υπηρεσία που προσφέρει μια **ενιαία πλατφόρμα για δημοσίευση, ασφάλιση, μετασχηματισμό, διαχείριση και παρακολούθηση APIs**. Επιτρέπει στις οργανώσεις να **εξομαλύνουν τη στρατηγική των API τους** και να διασφαλίζουν συνεπή διακυβέρνηση, απόδοση και ασφάλεια σε όλες τις υπηρεσίες τους. Λειτουργώντας ως ένα επίπεδο αφαίρεσης μεταξύ των backend υπηρεσιών και των καταναλωτών API, το APIM απλοποιεί την ενσωμάτωση και βελτιώνει τη συντηρησιμότητα ενώ παρέχει βασικές λειτουργίες επιχειρησιακής και ασφάλειας.

## Κύριες Έννοιες

Η **Πύλη API** λειτουργεί ως το μοναδικό σημείο εισόδου για όλη την κίνηση API, διαχειριζόμενη λειτουργίες όπως δρομολόγηση αιτήσεων προς backend υπηρεσίες, επιβολή ορίων ρυθμού, προσωρινή αποθήκευση απαντήσεων και διαχείριση authentication και authorization. Αυτή η πύλη φιλοξενείται και διαχειρίζεται πλήρως από το Azure, εξασφαλίζοντας υψηλή διαθεσιμότητα και κλιμάκωση.

Η **Πύλη Προγραμματιστών** παρέχει ένα περιβάλλον self-service όπου οι καταναλωτές API μπορούν να ανακαλύψουν διαθέσιμα APIs, να διαβάσουν την τεκμηρίωση και να δοκιμάσουν endpoints. Βοηθά στην απλοποίηση της ένταξης παρέχοντας διαδραστικά εργαλεία και πρόσβαση σε πληροφορίες συνδρομής.

Το **Πίνακας Διαχείρισης (Management Plane)** χρησιμοποιείται από διαχειριστές για να διαμορφώσουν και να συντηρήσουν την υπηρεσία APIM. Από εδώ, οι χρήστες μπορούν να ορίσουν APIs και operations, να διαμορφώσουν access control, να εφαρμόσουν πολιτικές, να διαχειριστούν χρήστες και να οργανώσουν τα APIs σε προϊόντα. Αυτός ο πίνακας κεντρικοποιεί τη διοίκηση και διασφαλίζει συνεπή διακυβέρνηση των API.

## Authentication and Authorization

Το Azure API Management υποστηρίζει αρκετούς μηχανισμούς **authentication** για την ασφάλεια της πρόσβασης στα API. Αυτοί περιλαμβάνουν **subscription keys**, **OAuth 2.0 tokens**, και **client certificates**. Το APIM επίσης ενσωματώνεται εγγενώς με την **Microsoft Entra ID**, επιτρέποντας **enterprise-level identity management** και **secure access** τόσο στα APIs όσο και στις backend υπηρεσίες.

## Πολιτικές

Οι πολιτικές στο APIM επιτρέπουν στους διαχειριστές να προσαρμόσουν την **επεξεργασία αιτήσεων και απαντήσεων** σε διάφορα επίπεδα λεπτομέρειας, συμπεριλαμβανομένου του **service**, **API**, **operation**, ή **product** επιπέδου. Μέσω πολιτικών, είναι δυνατόν να εφαρμοστεί **JWT token validation**, **μετασχηματισμός XML ή JSON payloads**, **επιβολή rate limiting**, **περιορισμός κλήσεων ανά διεύθυνση IP**, ή **authentication έναντι backend υπηρεσιών χρησιμοποιώντας managed identities**. Οι πολιτικές είναι **πολύ ευέλικτες** και αποτελούν ένα από τα **βασικά πλεονεκτήματα** της πλατφόρμας API Management, επιτρέποντας **λεπτομερή έλεγχο της συμπεριφοράς κατά το runtime** χωρίς τροποποίηση του κώδικα του backend.

## Ονομασμένες Τιμές

Η υπηρεσία παρέχει έναν μηχανισμό που ονομάζεται **Named Values**, ο οποίος επιτρέπει την αποθήκευση **πληροφοριών διαμόρφωσης** όπως **μυστικά**, **API keys**, ή άλλες τιμές που απαιτούνται από τις πολιτικές.

Αυτές οι τιμές μπορούν να αποθηκευτούν απευθείας μέσα στο APIM ή να αναφερθούν με ασφάλεια από το **Azure Key Vault**. Οι Ονομασμένες Τιμές προάγουν την **ασφαλή και κεντρική διαχείριση** των δεδομένων διαμόρφωσης και απλοποιούν τη συγγραφή πολιτικών επιτρέποντας **επαναχρησιμοποιήσιμες αναφορές** αντί για hardcoded τιμές.

## Δικτύωση και Ενσωμάτωση Ασφάλειας

Το Azure API Management ενσωματώνεται απρόσκοπτα με **virtual network environments**, επιτρέποντας **ιδιωτική και ασφαλή συνδεσιμότητα** με backend συστήματα.

Όταν αναπτύσσεται μέσα σε ένα **Virtual Network (VNet)**, το APIM μπορεί να έχει πρόσβαση σε **εσωτερικές υπηρεσίες** χωρίς να τις εκθέτει δημόσια. Η υπηρεσία επίσης επιτρέπει τη διαμόρφωση **custom certificates** για την υποστήριξη **mutual TLS authentication** με backend υπηρεσίες, βελτιώνοντας την ασφάλεια σε σενάρια όπου απαιτείται **ισχυρή επαλήθευση ταυτότητας**.

Αυτές οι **δυνατότητες δικτύωσης** καθιστούν το APIM κατάλληλο τόσο για **cloud-native** όσο και για **hybrid αρχιτεκτονικές**.

### Εντοπισμός

Για να εντοπίσετε την υπηρεσία API management:
```bash
# Lists all Named Values configured in the Azure API Management instance
az apim nv list --resource-group <resource-group> --service-name <service-name>

# Retrieves all policies applied at the API level in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"

# Retrieves the effective policy for a specific API in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01&format=rawxml"

# Gets the configuration details of the APIM service instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"

# Lists all backend services registered in the APIM instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"

# Retrieves details of a specific backend service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"

# Gets general information about the APIM service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>?api-version=2024-05-01"

# Calls an exposed API endpoint through the APIM gateway
curl https://<apim>.azure-api.net/<api-path>

```
{{#include ../../../banners/hacktricks-training.md}}
