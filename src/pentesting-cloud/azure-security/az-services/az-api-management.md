# Az - API Management

{{#include ../../../banners/hacktricks-training.md}}

## Basic Information

Azure API Management (APIM) ni huduma inayosimamiwa kikamilifu inayotoa **jukwaa lililounganishwa kwa kuchapisha, kulinda, kubadilisha, kusimamia, na kufuatilia APIs**. Inawawezesha mashirika **kuweka mkakati wao wa API katikati** na kuhakikisha utawala, utendaji, na usalama vinavyolingana kwa huduma zao zote. Kwa kutumika kama tabaka la utofauti kati ya huduma za backend na watumiaji wa API, APIM inarahisisha ujumuishaji na kuboresha utunzaji wa msimbo huku ikitoa uwezo muhimu wa uendeshaji na usalama.

## Core Concepts

**The API Gateway** inatumika kama mlango mmoja wa kuingia kwa trafiki yote ya API, ikiendesha kazi kama kusambaza maombi kwa huduma za backend, kutekeleza mipaka ya rate limits, kuhifadhi majibu (caching), na kusimamia authentication na authorization. Gateway hii inahostiwa na kusimamiwa kikamilifu na Azure, ikiweka uhakika wa upatikana mkubwa na scalability.

**The Developer Portal** hutoa mazingira ya kujihudumia ambapo watumiaji wa API wanaweza kugundua APIs zilizopo, kusoma nyaraka, na kujaribu endpoints. Inasaidia kurahisisha onboarding kwa kutoa zana za mwingiliano na upatikanaji wa taarifa za subscription.

**The Management Portal (Management Plane)** inatumiwa na wasimamizi kusanidi na kuendeleza huduma ya APIM. Kutoka hapa, watumiaji wanaweza kufafanua APIs na operations, kusanidi access control, kutumia policies, kusimamia watumiaji, na kupanga APIs katika products. Portal hii inajumuisha utawala na kuhakikisha udhibiti wa API uliofanana.

## Authentication and Authorization

Azure API Management inaunga mkono mbinu kadhaa za **authentication** ili kulinda upatikanaji wa API. Hizi ni pamoja na **subscription keys**, **OAuth 2.0 tokens**, na **client certificates**. APIM pia inaunganishwa asili na **Microsoft Entra ID**, ikiwaruhusu usimamizi wa utambulisho wa ngazi ya kampuni na upatikanaji salama kwa APIs na huduma za backend.

## Policies

Sera (Policies) katika APIM zinamruhusu msimamizi kubinafsisha **utekelezaji wa maombi na majibu** kwa ngazi mbalimbali, ikijumuisha ngazi ya **service**, **API**, **operation**, au **product**. Kupitia policies, inawezekana kutekeleza **JWT token validation**, **kubadilisha payloads za XML au JSON**, **kutoa rate limiting**, **kuzuia miito kwa anwani za IP**, au **kuthibitisha dhidi ya backend services kutumia managed identities**. Policies ni **zilisambazwa kwa njia iliyofaa** na ni mojawapo ya **nguvu kuu** za jukwaa la API Management, zikiwezesha **udhibiti wa kina wa tabia za runtime** bila kuharibu backend code.

## Named Values

Huduma inatoa utaratibu uitwao **Named Values**, ambao unaruhusu kuhifadhi **taarifa za kusanidi** kama **secrets**, **API keys**, au thamani nyingine zinazohitajika na policies.

Thamani hizi zinaweza kuhifadhiwa moja kwa moja ndani ya APIM au kurejelewa kwa usalama kutoka kwa **Azure Key Vault**. Named Values zinakuza **usimamizi salama na uliolengwa wa data za kusanidi** na kurahisisha uandishi wa policies kwa kuruhusu **marejeleo yanayoweza kutumika tena** badala ya thamani zilizo hardcoded.

## Networking and Security Integration

Azure API Management inaunganishwa kwa ufanisi na **virtual network environments**, ikiwezesha **muunganisho wa kibinafsi na salama** kwa mifumo ya backend.

Itakapowekwa ndani ya **Virtual Network (VNet)**, APIM inaweza kufikia **huduma za ndani** bila kuziweka hadharani. Huduma pia inaruhusu usanidi wa **custom certificates** ili kuunga mkono **mutual TLS authentication** na backend services, kuboresha usalama katika matukio yanayohitaji **uthibitishaji thabiti wa utambulisho**.

Sifa hizi za **mtandao** zinafanya APIM iwefaa kwa miundo ya **cloud-native** na **hybrid architectures**.

### Enumerate

Ili kuchunguza huduma ya API management:
```bash
# Lists all Named Values configured in the Azure API Management instance
az apim nv list --resource-group <resource-group> --service-name <service-name>

# Retrieves all policies applied at the API level in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"

# Retrieves the effective policy for a specific API in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01&format=rawxml"

# Gets the configuration details of the APIM service instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"

# Lists all backend services registered in the APIM instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"

# Retrieves details of a specific backend service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"

# Gets general information about the APIM service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>?api-version=2024-05-01"

# Calls an exposed API endpoint through the APIM gateway
curl https://<apim>.azure-api.net/<api-path>

```
{{#include ../../../banners/hacktricks-training.md}}
