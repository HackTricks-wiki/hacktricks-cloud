# Az - API Management

{{#include ../../../banners/hacktricks-training.md}}

## Grundlegende Informationen

Azure API Management (APIM) ist ein vollständig verwalteter Dienst, der eine **einheitliche Plattform zum Veröffentlichen, Absichern, Transformieren, Verwalten und Überwachen von APIs** bietet. Er ermöglicht Organisationen, ihre **API-Strategie zu zentralisieren** und eine konsistente Governance, Performance und Sicherheit über alle Dienste hinweg sicherzustellen. Indem APIM als Abstraktionsschicht zwischen Backend-Services und API-Konsumenten fungiert, vereinfacht es die Integration und verbessert die Wartbarkeit, während es wesentliche Betriebs- und Sicherheitsfunktionen bereitstellt.

## Kernkonzepte

**The API Gateway** dient als einziger Einstiegspunkt für gesamten API-Traffic und übernimmt Aufgaben wie das Weiterleiten von Requests an Backend-Services, Durchsetzen von Rate Limits, Caching von Antworten sowie die Verwaltung von Authentifizierung und Autorisierung. Dieses Gateway wird vollständig von Azure gehostet und verwaltet, was hohe Verfügbarkeit und Skalierbarkeit sicherstellt.

**The Developer Portal** bietet eine Self-Service-Umgebung, in der API-Konsumenten verfügbare APIs entdecken, Dokumentation lesen und Endpunkte testen können. Es erleichtert das Onboarding durch interaktive Werkzeuge und den Zugriff auf Abonnementinformationen.

**The Management Portal (Management Plane)** wird von Administratoren verwendet, um den APIM-Dienst zu konfigurieren und zu warten. Von hier aus können Benutzer APIs und Operationen definieren, Zugriffskontrollen konfigurieren, Policies anwenden, Benutzer verwalten und APIs in Produkte organisieren. Dieses Portal zentralisiert die Administration und sorgt für konsistente API-Governance.

## Authentifizierung und Autorisierung

Azure API Management unterstützt mehrere **authentication mechanisms**, um den API-Zugriff zu sichern. Dazu gehören **subscription keys**, **OAuth 2.0 tokens** und **client certificates**. APIM integriert sich außerdem nativ mit **Microsoft Entra ID**, wodurch **enterprise-level identity management** und **secure access** sowohl zu APIs als auch zu Backend-Services ermöglicht werden.

## Richtlinien

Policies in APIM erlauben Administratoren, die **Request- und Response-Verarbeitung** auf verschiedenen Ebenen anzupassen, einschließlich Service-, API-, Operation- oder Product-Ebene. Über Policies lassen sich unter anderem **JWT token validation** durchsetzen, **XML- oder JSON-Payloads transformieren**, **Rate Limiting** anwenden, Anfragen nach IP-Adresse einschränken oder die Authentifizierung gegenüber Backend-Services mittels managed identities durchführen. Policies sind **sehr flexibel** und bilden eine der **Kernstärken** der API Management-Plattform, da sie **feinkörnige Kontrolle über das Laufzeitverhalten** ermöglichen, ohne Backend-Code ändern zu müssen.

## Named Values

Der Dienst bietet einen Mechanismus namens **Named Values**, mit dem **Konfigurationsinformationen** wie **Secrets**, **API Keys** oder andere von Policies benötigte Werte gespeichert werden können.

Diese Werte können direkt in APIM gespeichert oder sicher aus **Azure Key Vault** referenziert werden. Named Values fördern eine **sichere und zentrale Verwaltung** von Konfigurationsdaten und vereinfachen das Erstellen von Policies, indem sie **wiederverwendbare Referenzen** anstelle von hartkodierten Werten ermöglichen.

## Netzwerk- und Sicherheitsintegration

Azure API Management integriert sich nahtlos in **virtual network environments** und ermöglicht so **private und sichere Konnektivität** zu Backend-Systemen.

Wenn innerhalb eines **Virtual Network (VNet)** bereitgestellt, kann APIM auf **interne Services** zugreifen, ohne diese öffentlich offenzulegen. Der Dienst erlaubt außerdem die Konfiguration von **custom certificates**, um **mutual TLS authentication** mit Backend-Services zu unterstützen, was die Sicherheit in Szenarien verbessert, in denen eine **starke Identitätsvalidierung** erforderlich ist.

Diese **Netzwerkfunktionen** machen APIM sowohl für **cloud-native** als auch für **hybride Architekturen** geeignet.

### Auflisten

Um den API Management-Dienst zu enumerieren:
```bash
# Lists all Named Values configured in the Azure API Management instance
az apim nv list --resource-group <resource-group> --service-name <service-name>

# Retrieves all policies applied at the API level in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"

# Retrieves the effective policy for a specific API in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01&format=rawxml"

# Gets the configuration details of the APIM service instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"

# Lists all backend services registered in the APIM instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"

# Retrieves details of a specific backend service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"

# Gets general information about the APIM service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>?api-version=2024-05-01"

# Calls an exposed API endpoint through the APIM gateway
curl https://<apim>.azure-api.net/<api-path>

```
{{#include ../../../banners/hacktricks-training.md}}
