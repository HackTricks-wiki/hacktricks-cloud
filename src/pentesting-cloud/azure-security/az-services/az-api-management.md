# Az - API Management

{{#include ../../../banners/hacktricks-training.md}}

## 基本信息

Azure API Management (APIM) 是一个完全托管的服务，提供一个**用于发布、保护、转换、管理和监控 APIs 的统一平台**。它使组织能够**集中其 API** 战略，并确保在所有服务中实现一致的治理、性能和安全。通过在后端服务与 API 消费者之间作为抽象层，APIM 简化了集成并提高了可维护性，同时提供关键的运营与安全能力。

## 核心概念

**API 网关** 作为所有 API 流量的单一入口点，处理将请求路由到后端服务、实施速率限制、缓存响应以及管理认证和授权等功能。此网关由 Azure 完全托管，确保高可用性和可扩展性。

**开发者门户 (Developer Portal)** 提供一个自助环境，API 消费者可以在此发现可用的 APIs、阅读文档并测试端点。它通过提供交互式工具和访问订阅信息来简化入门流程。

**管理门户 (Management Portal / Management Plane)** 由管理员用于配置和维护 APIM 服务。管理员可以在此定义 API 与操作、配置访问控制、应用策略、管理用户并将 APIs 组织为产品。该门户集中管理并确保一致的 API 治理。

## 认证与授权

Azure API Management 支持多种**认证机制**来保护 API 访问。这些包括 **subscription keys**、**OAuth 2.0 tokens** 和 **client certificates**。APIM 还与 **Microsoft Entra ID** 原生集成，实现**企业级身份管理**和对 API 及后端服务的**安全访问**。

## 策略

APIM 中的策略允许管理员在不同粒度级别上自定义**请求与响应处理**，包括**service**、**API**、**operation** 或 **product** 级别。通过策略，可以实施 **JWT token validation**、**转换 XML 或 JSON 有效负载**、**应用速率限制**、**按 IP 地址限制调用**，或**使用 managed identities 对后端服务进行身份验证**。策略具有**高度灵活性**，是 API Management 平台的**核心优势**之一，使得在不修改后端代码的情况下实现对运行时行为的**细粒度控制**。

## 命名值

该服务提供一种称为 **Named Values** 的机制，允许存储**配置信息**，例如**secrets**、**API keys** 或策略所需的其他值。

这些值可以直接存储在 APIM 内，或从 **Azure Key Vault** 安全引用。Named Values 促进了配置信息的**安全且集中化管理**，并通过允许**可重用引用**而不是硬编码值来简化策略编写。

## 网络与安全集成

Azure API Management 可与**虚拟网络环境**无缝集成，支持与后端系统的**私有且安全的连接**。

当部署在 **Virtual Network (VNet)** 内时，APIM 可以访问**内部服务**而无需公开暴露它们。该服务还允许配置**自定义证书**以支持与后端服务的**双向 TLS (mutual TLS) 认证**，在需要**强身份验证**的场景中提升安全性。

这些**网络特性**使得 APIM 适用于**云原生**和**混合架构**。

### 枚举

要枚举 API 管理服务：
```bash
# Lists all Named Values configured in the Azure API Management instance
az apim nv list --resource-group <resource-group> --service-name <service-name>

# Retrieves all policies applied at the API level in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"

# Retrieves the effective policy for a specific API in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01&format=rawxml"

# Gets the configuration details of the APIM service instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"

# Lists all backend services registered in the APIM instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"

# Retrieves details of a specific backend service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"

# Gets general information about the APIM service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>?api-version=2024-05-01"

# Calls an exposed API endpoint through the APIM gateway
curl https://<apim>.azure-api.net/<api-path>

```
{{#include ../../../banners/hacktricks-training.md}}
