# Az - API Management

{{#include ../../../banners/hacktricks-training.md}}

## Basiese Inligting

Azure API Management (APIM) is 'n volledig bestuurde diens wat 'n **geïntegreerde platform vir publisering, beveiliging, transformasie, bestuur en monitering van APIs** bied. Dit stel organisasies in staat om hul **API-strategie te sentraliseer** en konsekwente governance, prestasie en sekuriteit oor al hul dienste te verseker. Deur as 'n abstraksielaag tussen backend services en API-konsumante te funksioneer, vereenvoudig APIM integrasie en verbeter dit instandhouding, terwyl dit noodsaaklike operasionele en sekuriteitsvermoëns verskaf.

## Kernkonsepte

**The API Gateway** dien as die enkele toegangspunt vir alle API-verkeer en hanteer funksies soos die routering van versoeke na backend services, die afdwinging van rate-limiete, die kasbewaring van antwoorde, en die bestuur van verifikasie en magtiging. Hierdie gateway word volledig deur Azure aangebied en bestuur, wat hoë beskikbaarheid en skaalbaarheid verseker.

**The Developer Portal** bied 'n selfdiensomgewing waar API-konsumante beskikbare APIs kan ontdek, dokumentasie kan lees en eindpunte kan toets. Dit help om onboarding te stroomlyn deur interaktiewe gereedskap en toegang tot subscription information te bied.

**The Management Portal (Management Plane)** word deur administrators gebruik om die APIM-diens te konfigureer en te onderhou. Van hier af kan gebruikers APIs en operasies definieer, toegangbeheer konfigureer, policies toepas, gebruikers bestuur en APIs in products organiseer. Hierdie portaal sentraliseer administrasie en verseker konsekwente API-governance.

## Verifikasie en Magtiging

Azure API Management ondersteun verskeie **verifikasie-meganismes** om API-toegang te beveilig. Hierdie sluit in **subscription keys**, **OAuth 2.0 tokens**, en **client certificates**. APIM integreer ook native met **Microsoft Entra ID**, wat ondernemingsvlak identiteitbestuur en veilige toegang tot beide APIs en backend services moontlik maak.

## Policies

Policies in APIM laat administrators toe om die verwerking van versoeke en antwoorde op verskeie granulariteite aan te pas, insluitend die vlak van die **service**, **API**, **operation**, of **product**. Deur policies kan mens **JWT token validation** afdwing, XML- of JSON-payloads transformeer, rate limiting toepas, oproepe per IP-adres beperk, of verifieer teen backend services met behulp van **managed identities**. Policies is uiters buigbaar en vorm een van die kernsterktes van die API Management-platform, wat fynkorrelige beheer oor runtime-gedrag moontlik maak sonder om backend-kode te wysig.

## Named Values

Die diens bied 'n meganisme genaamd **Named Values**, wat toelaat om **konfigurasie-inligting** soos **secrets**, **API keys**, of ander waardes wat deur policies benodig word, te stoor.

Hierdie waardes kan direk binne APIM gestoor word of veilig vanaf **Azure Key Vault** verwys word. Named Values bevorder die **veilige en gesentraliseerde bestuur** van konfigurasiedata en vereenvoudig die skryf van policies deur **herbruikbare verwysings** toe te laat in plaas van hardgekodeerde waardes.

## Netwerk- en Sekuriteitsintegrasie

Azure API Management integreer naatloos met **virtual network environments**, wat private en veilige konnektiwiteit na backend-stelsels moontlik maak.

Wanneer dit binne 'n **Virtual Network (VNet)** ontplooi word, kan APIM toegang kry tot **internal services** sonder om hulle publiek bloot te stel. Die diens laat ook die konfigurasie van **custom certificates** toe om **mutual TLS authentication** met backend services te ondersteun, wat sekuriteit verbeter in scenario's waar **sterk identiteitsverifikasie** vereis word.

Hierdie **networking features** maak APIM geskik vir beide **cloud-native** en **hybrid architectures**.

### Enumereer

Om die API Management-diens te enumereer:
```bash
# Lists all Named Values configured in the Azure API Management instance
az apim nv list --resource-group <resource-group> --service-name <service-name>

# Retrieves all policies applied at the API level in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"

# Retrieves the effective policy for a specific API in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01&format=rawxml"

# Gets the configuration details of the APIM service instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"

# Lists all backend services registered in the APIM instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"

# Retrieves details of a specific backend service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"

# Gets general information about the APIM service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>?api-version=2024-05-01"

# Calls an exposed API endpoint through the APIM gateway
curl https://<apim>.azure-api.net/<api-path>

```
{{#include ../../../banners/hacktricks-training.md}}
