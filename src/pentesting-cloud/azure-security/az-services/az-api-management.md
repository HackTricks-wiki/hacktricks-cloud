# Az - API Management

{{#include ../../../banners/hacktricks-training.md}}

## Informações Básicas

Azure API Management (APIM) é um serviço totalmente gerenciado que oferece uma **plataforma unificada para publicar, proteger, transformar, gerenciar e monitorar APIs**. Ele permite que organizações **centralizem sua estratégia de API** e garantam governança, desempenho e segurança consistentes em todos os seus serviços. Ao agir como uma camada de abstração entre serviços backend e consumidores de API, APIM simplifica a integração e melhora a manutenibilidade enquanto fornece capacidades operacionais e de segurança essenciais.

## Conceitos Principais

**O API Gateway** atua como o ponto único de entrada para todo o tráfego de API, realizando funções como roteamento de requisições para serviços backend, aplicação de limites de taxa, cache de respostas e gerenciamento de autenticação e autorização. Esse gateway é totalmente hospedado e gerenciado pela Azure, garantindo alta disponibilidade e escalabilidade.

**O Developer Portal** fornece um ambiente self-service onde consumidores de API podem descobrir APIs disponíveis, ler documentação e testar endpoints. Ele ajuda a agilizar o onboarding oferecendo ferramentas interativas e acesso a informações de assinaturas.

**O Management Portal (Management Plane)** é usado por administradores para configurar e manter o serviço APIM. A partir dele, usuários podem definir APIs e operações, configurar controle de acesso, aplicar policies, gerenciar usuários e organizar APIs em produtos. Esse portal centraliza a administração e garante governança consistente das APIs.

## Autenticação e Autorização

Azure API Management suporta vários **mecanismos de autenticação** para proteger o acesso às APIs. Isso inclui **subscription keys**, **tokens OAuth 2.0** e **certificados de cliente**. APIM também integra nativamente com **Microsoft Entra ID**, possibilitando **gerenciamento de identidade em nível corporativo** e **acesso seguro** tanto às APIs quanto aos serviços backend.

## Policies

Policies no APIM permitem que administradores personalizem o **processamento de requisições e respostas** em várias granularidades, incluindo o nível de **service**, **API**, **operation** ou **product**. Através de policies, é possível aplicar **validação de token JWT**, **transformar payloads XML ou JSON**, **aplicar rate limiting**, **restringir chamadas por endereço IP** ou **autenticar contra serviços backend usando managed identities**. Policies são **altamente flexíveis** e constituem uma das **principais forças** da plataforma API Management, permitindo **controle fino sobre o comportamento em tempo de execução** sem modificar o código backend.

## Named Values

O serviço fornece um mecanismo chamado **Named Values**, que permite armazenar **informações de configuração** como **segredos**, **API keys** ou outros valores necessários pelas policies.

Esses valores podem ser armazenados diretamente no APIM ou referenciados de forma segura a partir do **Azure Key Vault**. Named Values promovem **gerenciamento seguro e centralizado** de dados de configuração e simplificam a criação de policies ao permitir **referências reutilizáveis** em vez de valores hardcoded.

## Redes e Integração de Segurança

Azure API Management integra-se perfeitamente com **ambientes de rede virtual**, possibilitando **conectividade privada e segura** com sistemas backend.

Quando implantado dentro de uma **Virtual Network (VNet)**, o APIM pode acessar **serviços internos** sem expô‑los publicamente. O serviço também permite a configuração de **certificados customizados** para suportar **mutual TLS authentication** com serviços backend, melhorando a segurança em cenários onde é necessária **validação forte de identidade**.

Essas **funcionalidades de rede** tornam o APIM adequado tanto para arquiteturas **cloud-native** quanto **híbridas**.

### Enumerar

Para enumerar o serviço API Management:
```bash
# Lists all Named Values configured in the Azure API Management instance
az apim nv list --resource-group <resource-group> --service-name <service-name>

# Retrieves all policies applied at the API level in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"

# Retrieves the effective policy for a specific API in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01&format=rawxml"

# Gets the configuration details of the APIM service instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"

# Lists all backend services registered in the APIM instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"

# Retrieves details of a specific backend service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"

# Gets general information about the APIM service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>?api-version=2024-05-01"

# Calls an exposed API endpoint through the APIM gateway
curl https://<apim>.azure-api.net/<api-path>

```
{{#include ../../../banners/hacktricks-training.md}}
