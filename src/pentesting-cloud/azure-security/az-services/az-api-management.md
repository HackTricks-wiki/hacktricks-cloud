# Az - API Management

{{#include ../../../banners/hacktricks-training.md}}

## Basic Information

Azure API Management (APIM) es un servicio totalmente gestionado que ofrece una **plataforma unificada para publicar, asegurar, transformar, gestionar y monitorizar APIs**. Permite a las organizaciones **centralizar su estrategia de API** y asegurar una gobernanza, rendimiento y seguridad consistentes en todos sus servicios. Al actuar como una capa de abstracción entre los servicios backend y los consumidores de APIs, APIM simplifica la integración y mejora la mantenibilidad mientras proporciona capacidades operativas y de seguridad esenciales.

## Core Concepts

**The API Gateway** sirve como el único punto de entrada para todo el tráfico de API, manejando funciones como enrutar solicitudes a los servicios backend, aplicar límites de tasa, cachear respuestas y gestionar autenticación y autorización. Este gateway está completamente alojado y gestionado por Azure, asegurando alta disponibilidad y escalabilidad.

**The Developer Portal** ofrece un entorno de autoservicio donde los consumidores de APIs pueden descubrir las APIs disponibles, leer la documentación y probar endpoints. Ayuda a agilizar la incorporación ofreciendo herramientas interactivas y acceso a la información de suscripciones.

**The Management Portal (Management Plane)** es utilizado por los administradores para configurar y mantener el servicio APIM. Desde aquí, los usuarios pueden definir APIs y operaciones, configurar control de acceso, aplicar policies, gestionar usuarios y organizar APIs en productos. Este portal centraliza la administración y asegura una gobernanza consistente de las APIs.


## Authentication and Authorization

Azure API Management soporta varios **mecanismos de autenticación** para asegurar el acceso a las APIs. Estos incluyen **subscription keys**, **OAuth 2.0 tokens**, y **client certificates**. APIM también se integra de forma nativa con **Microsoft Entra ID**, habilitando **gestión de identidad a nivel empresarial** y **acceso seguro** tanto a las APIs como a los servicios backend.

## Policies

Las policies en APIM permiten a los administradores personalizar el **procesamiento de solicitudes y respuestas** en varios niveles de granularidad, incluyendo el nivel de **service**, **API**, **operation** o **product**. A través de policies, es posible imponer **validación de tokens JWT**, **transformar cargas XML o JSON**, **aplicar rate limiting**, **restringir llamadas por dirección IP**, o **autenticar contra servicios backend usando managed identities**. Las policies son **altamente flexibles** y constituyen una de las **principales fortalezas** de la plataforma API Management, permitiendo **control fino sobre el comportamiento en tiempo de ejecución** sin modificar el código backend.

## Named Values

El servicio proporciona un mecanismo llamado **Named Values**, que permite almacenar **información de configuración** como **secretos**, **API keys**, u otros valores requeridos por las policies.

Estos valores pueden almacenarse directamente dentro de APIM o referenciarse de forma segura desde **Azure Key Vault**. Named Values promueven la **gestión centralizada y segura** de datos de configuración y simplifican la redacción de policies permitiendo **referencias reutilizables** en lugar de valores hardcodeados.

## Networking and Security Integration

Azure API Management se integra sin problemas con **entornos de red virtual**, habilitando **conectividad privada y segura** con sistemas backend.

Cuando se despliega dentro de una **Virtual Network (VNet)**, APIM puede acceder a **servicios internos** sin exponerlos públicamente. El servicio también permite la configuración de **certificados personalizados** para soportar **autenticación mutua TLS** con servicios backend, mejorando la seguridad en escenarios donde se requiere una **validación de identidad fuerte**.

Estas **características de red** hacen que APIM sea adecuado tanto para arquitecturas **cloud-native** como **híbridas**.


### Enumerate

To enumerate the API management service:
```bash
# Lists all Named Values configured in the Azure API Management instance
az apim nv list --resource-group <resource-group> --service-name <service-name>

# Retrieves all policies applied at the API level in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/?api-version=2024-05-01&format=rawxml"

# Retrieves the effective policy for a specific API in raw XML format
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/apis/<api-id>/policies/policy?api-version=2024-05-01&format=rawxml"

# Gets the configuration details of the APIM service instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<apim>?api-version=2024-05-01"

# Lists all backend services registered in the APIM instance
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends?api-version=2024-05-01"

# Retrieves details of a specific backend service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>/backends/<backend-id>?api-version=2024-05-01"

# Gets general information about the APIM service
az rest --method GET \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.ApiManagement/service/<service-name>?api-version=2024-05-01"

# Calls an exposed API endpoint through the APIM gateway
curl https://<apim>.azure-api.net/<api-path>

```
{{#include ../../../banners/hacktricks-training.md}}
