# Az - CosmosDB

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Azure CosmosDB

**Azure Cosmos DB**, tek haneli milisaniye yanÄ±t sÃ¼releri, otomatik Ã¶lÃ§eklenebilirlik ve kurumsal dÃ¼zeyde gÃ¼venlik ile SLA destekli kullanÄ±labilirlik sunan tamamen **yÃ¶netilen NoSQL, iliÅŸkisel ve vektÃ¶r veritabanÄ±**dÄ±r. Ã‡ok bÃ¶lgeli veri daÄŸÄ±tÄ±mÄ±, popÃ¼ler diller iÃ§in aÃ§Ä±k kaynaklÄ± API'ler, SDK'lar ve entegre vektÃ¶r desteÄŸi ile sorunsuz Azure AI entegrasyonu gibi AI veritabanÄ± Ã¶zellikleri sayesinde daha hÄ±zlÄ± uygulama geliÅŸtirmeyi mÃ¼mkÃ¼n kÄ±lar.

Azure Cosmos DB, belgeler, iliÅŸkisel, anahtar-deÄŸer, grafik ve sÃ¼tun ailesi veri modellerini kullanarak gerÃ§ek dÃ¼nya verilerini modellemek iÃ§in birden fazla veritabanÄ± API'si saÄŸlar; bu API'ler NoSQL, MongoDB, PostgreSQL, Cassandra, Gremlin ve Table'dÄ±r.

CosmosDB'nin Ã¶nemli bir yÃ¶nÃ¼ Azure Cosmos HesabÄ±'dÄ±r. **Azure Cosmos HesabÄ±**, veritabanlarÄ±na giriÅŸ noktasÄ± olarak iÅŸlev gÃ¶rÃ¼r. Hesap, kÃ¼resel daÄŸÄ±tÄ±m, tutarlÄ±lÄ±k seviyeleri ve kullanÄ±lacak belirli API gibi ana ayarlarÄ± belirler; Ã¶rneÄŸin NoSQL. Hesap aracÄ±lÄ±ÄŸÄ±yla, verilerin birden fazla bÃ¶lgede dÃ¼ÅŸÃ¼k gecikme sÃ¼resi ile eriÅŸilebilir olmasÄ±nÄ± saÄŸlamak iÃ§in kÃ¼resel Ã§oÄŸaltmayÄ± yapÄ±landÄ±rabilirsiniz. AyrÄ±ca, performans ile veri doÄŸruluÄŸu arasÄ±nda denge saÄŸlayan bir tutarlÄ±lÄ±k seviyesi seÃ§ebilirsiniz; bu seÃ§enekler GÃ¼Ã§lÃ¼'den Nihai tutarlÄ±lÄ±ÄŸa kadar deÄŸiÅŸir.

### NoSQL (sql)
Azure Cosmos DB NoSQL API'si, veri formatÄ± olarak JSON kullanan belge tabanlÄ± bir API'dir. JSON nesnelerini sorgulamak iÃ§in SQL benzeri bir sorgu sÃ¶zdizimi saÄŸlar, bu da yapÄ±landÄ±rÄ±lmÄ±ÅŸ ve yarÄ± yapÄ±landÄ±rÄ±lmÄ±ÅŸ verilerle Ã§alÄ±ÅŸmak iÃ§in uygun hale getirir. Servisin uÃ§ noktasÄ± ÅŸudur:

{% code overflow="wrap" %}
```bash
https://<Account-Name>.documents.azure.com:443/
```
{% endcode %}

#### VeritabanlarÄ±
Bir hesap iÃ§inde, konteynerlerin mantÄ±ksal gruplarÄ± olarak hizmet eden bir veya daha fazla veritabanÄ± oluÅŸturabilirsiniz. Bir veritabanÄ±, kaynak yÃ¶netimi ve kullanÄ±cÄ± izinleri iÃ§in bir sÄ±nÄ±r gÃ¶revi gÃ¶rÃ¼r. VeritabanlarÄ±, konteynerleri arasÄ±nda tahsis edilmiÅŸ verimliliÄŸi paylaÅŸabilir veya bireysel konteynerlere Ã¶zel verimlilik tahsis edebilir.

#### Konteynerler
Veri depolamanÄ±n temel birimi konteynerdir, JSON belgelerini tutar ve verimli sorgulama iÃ§in otomatik olarak indekslenir. Konteynerler elastik olarak Ã¶lÃ§eklenebilir ve kullanÄ±cÄ± tanÄ±mlÄ± bir bÃ¶lÃ¼m anahtarÄ± tarafÄ±ndan belirlenen bÃ¶lÃ¼mlere daÄŸÄ±tÄ±lÄ±r. BÃ¶lÃ¼m anahtarÄ±, optimal performans ve eÅŸit veri daÄŸÄ±lÄ±mÄ±nÄ± saÄŸlamak iÃ§in kritik Ã¶neme sahiptir. Ã–rneÄŸin, bir konteyner mÃ¼ÅŸteri verilerini depolayabilir ve "customerId" bÃ¶lÃ¼m anahtarÄ± olarak kullanÄ±labilir.

#### SayÄ±m

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# CosmoDB Account
## List Azure Cosmos DB database accounts.
az cosmosdb list --resource-group <ResourceGroupName>
az cosmosdb show --resource-group <ResourceGroupName> --name <AccountName>

## Lists the virtual network accounts associated with a Cosmos DB account
az cosmosdb network-rule list --resource-group <ResourceGroupName> --name <AccountName>
## List the access keys or connection strings for a Azure Cosmos DB
az cosmosdb keys list --name <AccountName> --resource-group <ResourceGroupName>
## List all the database accounts that can be restored.
az cosmosdb restorable-database-account list --account-name <AccountName>
## Show the identities for a Azure Cosmos DB database account.
az cosmosdb identity show --resource-group <ResourceGroupName> --name <AccountName>


# CosmoDB (NoSQL)
## List the SQL databases under an Azure Cosmos DB account.
az cosmosdb sql database list --resource-group <ResourceGroupName> --account-name <AccountName>
## List the SQL containers under an Azure Cosmos DB SQL database.
az cosmosdb sql container list --account-name <AccountName> --database-name <DatabaseName> --resource-group <ResourceGroupName>

## List all SQL role assignments under an Azure Cosmos DB
az cosmosdb sql role assignment list --resource-group <ResourceGroupName> --account-name <AccountName>
## List all SQL role definitions under an Azure Cosmos DB
az cosmosdb sql role definition list --resource-group <ResourceGroupName> --account-name <AccountName>

## List the SQL stored procedures under an Azure Cosmos DB
az cosmosdb sql stored-procedure list --account-name <AccountName> --container-name <ContainerName> --database-name <DatabaseName> --resource-group <ResourceGroupName>
## List the SQL triggers under an Azure Cosmos DB SQL container.
az cosmosdb sql trigger list --account-name <AccountName> --container-name <ContainerName> --database-name <DatabaseName> --resource-group <ResourceGroupName>
## List the SQL user defined functions under an Azure Cosmos DB SQL container
az cosmosdb sql user-defined-function list --account-name <AccountName> --container-name <ContainerName> --database-name <DatabaseName> --resource-group <ResourceGroupName>

```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```bash
Get-Command -Module Az.CosmosD

# List all Cosmos DB accounts in a specified resource group.
Get-AzCosmosDBAccount -ResourceGroupName "<ResourceGroupName>"

# Get the access keys for a specific Cosmos DB account.
Get-AzCosmosDBAccountKey -ResourceGroupName "<ResourceGroupName>" -Name "<AccountName>"

# Retrieve the client encryption keys for a specific Cosmos DB account.
Get-AzCosmosDbClientEncryptionKey -ResourceGroupName "<ResourceGroupName>" -AccountName "<AccountName>" -DatabaseName "<DatabaseName>"

# List all SQL containers in a specific Cosmos DB SQL database.
Get-AzCosmosDBSqlContainer -ResourceGroupName "<ResourceGroupName>" -AccountName "<AccountName>" -DatabaseName "<DatabaseName>"

# Get backup information for a specific Cosmos DB SQL container.
Get-AzCosmosDBSqlContainerBackupInformation -ResourceGroupName "<ResourceGroupName>" -AccountName "<AccountName>" -DatabaseName "<DatabaseName>" -Name "<ContainerName>" -Location "<location>"

# Get the throughput (RU/s) settings for a specific Cosmos DB SQL container.
Get-AzCosmosDBSqlContainerThroughput -ResourceGroupName "<ResourceGroupName>" -AccountName "<AccountName>" -DatabaseName "<DatabaseName>" -Name "<ContainerName>"

# List all SQL databases under a specific Cosmos DB account.
Get-AzCosmosDBSqlDatabase -ResourceGroupName "<ResourceGroupName>" -AccountName "<AccountName>"

# Get the throughput (RU/s) settings for a specific Cosmos DB SQL database.
Get-AzCosmosDBSqlDatabaseThroughput -ResourceGroupName "<ResourceGroupName>" -AccountName "<AccountName>" -Name "<DatabaseName>"

# List all SQL role assignments for a specific Cosmos DB account.
Get-AzCosmosDBSqlRoleAssignment -ResourceGroupName "<ResourceGroupName>" -AccountName "<AccountName>"

# List all SQL role definitions for a specific Cosmos DB account.
Get-AzCosmosDBSqlRoleDefinition -ResourceGroupName "<ResourceGroupName>" -AccountName "<AccountName>"

# List all stored procedures in a specific Cosmos DB SQL container.
Get-AzCosmosDBSqlStoredProcedure -ResourceGroupName "<ResourceGroupName>" -AccountName "<AccountName>" -DatabaseName "<DatabaseName>" -ContainerName "<ContainerName>"

# List all triggers in a specific Cosmos DB SQL container.
Get-AzCosmosDBSqlTrigger -ResourceGroupName "<ResourceGroupName>" -AccountName "<AccountName>" -DatabaseName "<DatabaseName>" -ContainerName "<ContainerName>"

# List all user-defined functions (UDFs) in a specific Cosmos DB SQL container.
Get-AzCosmosDBSqlUserDefinedFunction -ResourceGroupName "<ResourceGroupName>" -AccountName "<AccountName>" -DatabaseName "<DatabaseName>" -ContainerName "<ContainerName>"
```
{% endcode %}
{% endtab %}
{% endtabs %}

#### BaÄŸlantÄ±

azure-cosmosDB'ye baÄŸlanmak iÃ§in (pip install azure-cosmos) kÃ¼tÃ¼phanesi gereklidir. AyrÄ±ca, baÄŸlantÄ±yÄ± saÄŸlamak iÃ§in uÃ§ nokta ve anahtar kritik bileÅŸenlerdir.
{% code overflow="wrap" %}
```python
from azure.cosmos import CosmosClient, PartitionKey

# Connection details
endpoint = "<your-account-endpoint>"
key = "<your-account-key>"

# Initialize Cosmos Client
client = CosmosClient(endpoint, key)

# Access existing database and container
database_name = '<SampleDB>'
container_name = '<SampleContainer>'
database = client.get_database_client(database_name)
container = database.get_container_client(container_name)

# Insert multiple documents
items_to_insert = [
{"id": "1", "name": "Sample Item", "description": "This is a sample document."},
{"id": "2", "name": "Another Sample Item", "description": "This is another sample document."},
{"id": "3", "name": "Sample Item", "description": "This is a duplicate name sample document."},
]

for item in items_to_insert:
container.upsert_item(item)

# Query all documents
query = "SELECT * FROM c"
all_items = list(container.query_items(
query=query,
enable_cross_partition_query=True
))

# Print all queried items
print("All items in the container:")
for item in all_items:
print(item)
```
{% endcode %}

BaÄŸlantÄ± kurmanÄ±n bir diÄŸer yolu **DefaultAzureCredential()** kullanmaktÄ±r. Sadece gerekli izinlere sahip hesapla giriÅŸ yapmanÄ±z (az login) ve bunu Ã§alÄ±ÅŸtÄ±rmanÄ±z gerekir. Bu durumda, gerekli izinleri veren bir rol atamasÄ± yapÄ±lmalÄ±dÄ±r (daha fazla bilgi iÃ§in bakÄ±nÄ±z).

{% code overflow="wrap" %}
```python
from azure.identity import DefaultAzureCredential
from azure.cosmos import CosmosClient

# Use Azure AD for authentication
credential = DefaultAzureCredential()
endpoint = "<your-account-endpoint>"
client = CosmosClient(endpoint, credential)

# Access database and container
database_name = "<mydatabase>"
container_name = "<mycontainer>"
database = client.get_database_client(database_name)
container = database.get_container_client(container_name)

# Insert a document
item = {
"id": "1",
"name": "Sample Item",
"description": "This is a test item."
}
container.create_item(item)
print("Document inserted.")
```
{% endcode %}

### MongoDB
MongoDB NoSQL API, veri formatÄ± olarak JSON benzeri BSON (Binary JSON) kullanan belge tabanlÄ± bir API'dir. YapÄ±landÄ±rÄ±lmÄ±ÅŸ, yarÄ± yapÄ±landÄ±rÄ±lmÄ±ÅŸ ve yapÄ±landÄ±rÄ±lmamÄ±ÅŸ verilerle Ã§alÄ±ÅŸmak iÃ§in uygun hale getiren, toplama yeteneklerine sahip bir sorgu dili saÄŸlar. Servisin uÃ§ noktasÄ± genellikle bu formatÄ± takip eder:

{% code overflow="wrap" %}
```bash
mongodb://<hostname>:<port>/<database>
```
{% endcode %}

#### VeritabanlarÄ±
MongoDB'de, bir Ã¶rnek iÃ§inde bir veya daha fazla veritabanÄ± oluÅŸturabilirsiniz. Her veritabanÄ±, koleksiyonlarÄ±n mantÄ±ksal bir gruplamasÄ±nÄ± saÄŸlar ve kaynak organizasyonu ve yÃ¶netimi iÃ§in bir sÄ±nÄ±r oluÅŸturur. VeritabanlarÄ±, verileri mantÄ±ksal olarak ayÄ±rmaya ve yÃ¶netmeye yardÄ±mcÄ± olur, Ã¶rneÄŸin farklÄ± uygulamalar veya projeler iÃ§in.

#### Koleksiyonlar
MongoDB'deki veri depolamanÄ±n temel birimi koleksiyondur, bu koleksiyon belgeleri tutar ve verimli sorgulama ve esnek ÅŸema tasarÄ±mÄ± iÃ§in tasarlanmÄ±ÅŸtÄ±r. Koleksiyonlar elastik olarak Ã¶lÃ§eklenebilir ve daÄŸÄ±tÄ±k bir yapÄ± iÃ§inde birden fazla dÃ¼ÄŸÃ¼mde yÃ¼ksek verimlilikte iÅŸlemleri destekleyebilir.

#### SayÄ±m

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# CosmoDB Account
## List Azure Cosmos DB database accounts.
az cosmosdb list --resource-group <ResourceGroupName>
az cosmosdb show --resource-group <ResourceGroupName> --name <AccountName>

## Lists the virtual network accounts associated with a Cosmos DB account
az cosmosdb network-rule list --resource-group <ResourceGroupName> --name <AccountName>
## List the access keys or connection strings for a Azure Cosmos DB
az cosmosdb keys list --name <AccountName> --resource-group <ResourceGroupName>
## List all the database accounts that can be restored.
az cosmosdb restorable-database-account list --account-name <AccountName>
## Show the identities for a Azure Cosmos DB database account.
az cosmosdb identity show --resource-group <ResourceGroupName> --name <AccountName>

## MongoDB
# List all MongoDB databases in a specified Azure Cosmos DB account
az cosmosdb mongodb database list --account-name <AccountName> --resource-group <ResourceGroupName>
# List all collections in a specific MongoDB database within an Azure Cosmos DB account
az cosmosdb mongodb collection list --account-name <AccountName> --database-name <DatabaseName> --resource-group <ResourceGroupName>

# List all role definitions for MongoDB within an Azure Cosmos DB account
az cosmosdb mongodb role definition list --account-name <AccountName> --resource-group <ResourceGroupName>
# List all user definitions for MongoDB within an Azure Cosmos DB account
az cosmosdb mongodb user definition list --account-name <AccountName> --resource-group <ResourceGroupName>

```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```bash
Get-Command -Module Az.CosmosDB

# List all Cosmos DB accounts in a specified resource group.
Get-AzCosmosDBAccount -ResourceGroupName "<ResourceGroupName>"

# Get the access keys for a specific Cosmos DB account.
Get-AzCosmosDBAccountKey -ResourceGroupName "<ResourceGroupName>" -Name "<AccountName>"

# Retrieve the client encryption keys for a specific Cosmos DB account.
Get-AzCosmosDbClientEncryptionKey -ResourceGroupName "<ResourceGroupName>" -AccountName "<AccountName>" -DatabaseName "<DatabaseName>"

# List all MongoDB collections in a specific database.
Get-AzCosmosDBMongoDBCollection -AccountName <account-name> -ResourceGroupName <resource-group-name> -DatabaseName <database-name>

# Retrieve backup information for a specific MongoDB collection in a database.
Get-AzCosmosDBMongoDBCollectionBackupInformation -AccountName <account-name> -ResourceGroupName <resource-group-name> -DatabaseName <database-name> -Name <collection-name> -Location <Location>

# Get the throughput (RU/s) of a specific MongoDB collection in a database.
Get-AzCosmosDBMongoDBCollectionThroughput -AccountName <account-name> -ResourceGroupName <resource-group-name> -DatabaseName <database-name> -Name <collection-name>

# List all MongoDB databases in a specified Cosmos DB account.
Get-AzCosmosDBMongoDBDatabase -AccountName <account-name> -ResourceGroupName <resource-group-name>

# Get the throughput (RU/s) of a specific MongoDB database.
Get-AzCosmosDBMongoDBDatabaseThroughput -AccountName <account-name> -ResourceGroupName <resource-group-name> -DatabaseName <database-name>

# Retrieve the role definitions for MongoDB users in a specified Cosmos DB account.
Get-AzCosmosDBMongoDBRoleDefinition -AccountName <account-name> -ResourceGroupName <resource-group-name>

```
{% endcode %}
{% endtab %}
{% endtabs %}

#### BaÄŸlantÄ±

Burada ÅŸifreyi anahtarlarla veya privesc bÃ¶lÃ¼mÃ¼nde aÃ§Ä±klanan yÃ¶ntemle bulabilirsiniz.
{% code overflow="wrap" %}
```python
from pymongo import MongoClient

# Updated connection string with retryWrites=false
connection_string = "mongodb://<account-name>.mongo.cosmos.azure.com:10255/?ssl=true&replicaSet=globaldb&retryWrites=false"

# Create the client
client = MongoClient(connection_string, username="<username>", password="<password>")

# Access the database
db = client['<database>']

# Access a collection
collection = db['<collection>']

# Insert a single document
document = {
"name": "John Doe",
"email": "johndoe@example.com",
"age": 30,
"address": {
"street": "123 Main St",
"city": "Somewhere",
"state": "CA",
"zip": "90210"
}
}

# Insert document
result = collection.insert_one(document)
print(f"Inserted document with ID: {result.inserted_id}")
```
{% endcode %}

## Referanslar

* [https://learn.microsoft.com/en-us/azure/cosmos-db/choose-api](https://learn.microsoft.com/en-us/azure/cosmos-db/choose-api)
* [https://learn.microsoft.com/en-us/azure/cosmos-db/](https://learn.microsoft.com/en-us/azure/cosmos-db/)
* [https://learn.microsoft.com/en-us/azure/cosmos-db/introduction](https://learn.microsoft.com/en-us/azure/cosmos-db/introduction)
* [https://learn.microsoft.com/en-us/azure/cosmos-db/nosql/security/how-to-grant-data-plane-role-based-access?tabs=built-in-definition%2Ccsharp&pivots=azure-interface-cli](https://learn.microsoft.com/en-us/azure/cosmos-db/nosql/security/how-to-grant-data-plane-role-based-access?tabs=built-in-definition%2Ccsharp&pivots=azure-interface-cli)

## Yetki YÃ¼kseltme

{% content-ref url="../az-privilege-escalation/az-cosmosDB-privesc.md" %}
[az-cosmosDB-privesc.md](../az-privilege-escalation/az-cosmosDB-privesc.md)
{% endcontent-ref %}

## SonrasÄ± Ä°stismar

{% content-ref url="../az-post-exploitation/az-cosmosDB-post-exploitation.md" %}
[az-cosmosDB-post-exploitation.md](../az-post-exploitation/az-sql-post-exploitation.md)
{% endcontent-ref %}

## YapÄ±lacaklar

* Buradaki DB'nin geri kalanÄ±, tablolar, cassandra, gremlin...
* "Microsoft.DocumentDB/databaseAccounts/mongodbUserDefinitions/write" && "Microsoft.DocumentDB/databaseAccounts/mongodbUserDefinitions/read" ve rol tanÄ±mlarÄ±na bakÄ±n Ã§Ã¼nkÃ¼ burada bir yetki yÃ¼kseltme olabilir
* Geri yÃ¼klemelere bakÄ±n



{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±na**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek paylaÅŸÄ±n.**

</details>
{% endhint %}
