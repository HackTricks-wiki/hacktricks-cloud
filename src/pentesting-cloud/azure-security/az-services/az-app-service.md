# Az - App Services

{{#include ../../../banners/hacktricks-training.md}}

## App Service Temel Bilgiler

Azure App Services, geliştiricilerin **web uygulamaları, mobil uygulama arka uçları ve API'leri sorunsuz bir şekilde oluşturmasını, dağıtmasını ve ölçeklendirmesini** sağlar. Birden fazla programlama dilini destekler ve geliştirilmiş işlevsellik ve yönetim için çeşitli Azure araçları ve hizmetleri ile entegre olur.

Her uygulama bir sandbox içinde çalışır, ancak izolasyon App Service planlarına bağlıdır.

- Ücretsiz ve Paylaşılan katmanlardaki uygulamalar paylaşılan VM'lerde çalışır.
- Standart ve Premium katmanlardaki uygulamalar özel VM'lerde çalışır.

> [!WARNING]
> Bu izolasyonların **hiçbiri** diğer yaygın **web güvenlik açıklarını** (örneğin dosya yükleme veya enjeksiyonlar) **önlemez**. Ve bir **yönetim kimliği** kullanılıyorsa, bu kimlik **yetkileri artırma** yeteneğine sahip olabilir.

Uygulamaların bazı ilginç yapılandırmaları vardır:

- **Her Zaman Açık**: Uygulamanın her zaman çalışmasını sağlar. Eğer etkinleştirilmezse, uygulama 20 dakikalık bir etkinlik yokluğundan sonra duracak ve bir istek alındığında tekrar başlayacaktır.
- Uygulama durursa, sürekli çalışması gereken bir webjob'unuz varsa bu önemlidir.
- **SSH**: Etkinleştirildiğinde, yeterli izinlere sahip bir kullanıcı uygulamaya SSH ile bağlanabilir.
- **Hata Ayıklama**: Etkinleştirildiğinde, yeterli izinlere sahip bir kullanıcı uygulamayı hata ayıklayabilir. Ancak, bu her 48 saatte bir otomatik olarak devre dışı bırakılır.
- **Web Uygulaması + Veritabanı**: Web konsolu, bir veritabanı ile bir Uygulama oluşturmayı sağlar. Bu durumda kullanılacak veritabanını (SQLAzure, PostgreSQL, MySQL, MongoDB) seçmek mümkündür ve ayrıca bir Azure Cache for Redis oluşturmanıza da olanak tanır.
- Veritabanı ve Redis için kimlik bilgilerini içeren URL, **appsettings** içinde saklanacaktır.
- **Konteyner**: Konteynerin URL'sini ve ona erişim için kimlik bilgilerini belirterek App Service'e bir konteyner dağıtmak mümkündür.

## Temel Kimlik Doğrulama

Bir web uygulaması (ve genellikle bir Azure işlevi) oluştururken, Temel Kimlik Doğrulama'nın etkinleştirilip etkinleştirilmeyeceğini belirtmek mümkündür. Bu, esasen uygulama için **SCM ve FTP'yi etkinleştirir**, böylece bu teknolojileri kullanarak uygulamayı dağıtmak mümkün olacaktır.\
Ayrıca, onlara bağlanmak için Azure, **kullanıcı adı, şifre ve URL'yi** almak için bir **API sağlar**.

SCM'ye bir web tarayıcısı kullanarak `https://<SMC-URL>/BasicAuth` adresinden bağlanabilir ve oradaki tüm dosyaları ve dağıtımları kontrol edebilirsiniz.

### Kudu

Kudu, **Azure App Service ve Function Apps için bir dağıtım motoru ve yönetim platformu** olup, web uygulamaları için Git tabanlı dağıtımlar, uzaktan hata ayıklama ve dosya yönetimi yetenekleri sunar. Web uygulamasının SCM URL'si aracılığıyla erişilebilir.

Kudu'nun App Services ve Function Apps tarafından kullanılan sürümlerinin farklı olduğunu, Function apps sürümünün çok daha sınırlı olduğunu unutmayın.

Kudu'da bulabileceğiniz bazı ilginç uç noktalar:
- `/DebugConsole`: Kudu'nun çalıştığı ortamda komutları çalıştırmanıza olanak tanıyan bir konsol.
- Bu ortamın **token almak için** metadata hizmetine erişimi **yoktur**.
- `/webssh/host`: Uygulamanın çalıştığı konteynere bağlanmanıza olanak tanıyan web tabanlı bir SSH istemcisi.
- Bu ortam, atanan yönetilen kimliklerden token almak için **metadata hizmetine erişime sahiptir**.
- `/Env`: Sistem, uygulama ayarları, çevre değişkenleri, bağlantı dizeleri ve HTTP başlıkları hakkında bilgi alır.
- `/wwwroot/`: Web uygulamasının kök dizini. Buradan tüm dosyaları indirebilirsiniz.

## Kaynaklar

App Services, varsayılan olarak kodu bir zip dosyası olarak yüklemeye izin verir, ancak ayrıca bir üçüncü taraf hizmetine bağlanarak kodu oradan almayı da sağlar.

- Şu anda desteklenen üçüncü taraf kaynaklar **Github** ve **Bitbucket**'tır.
- Kimlik doğrulama tokenlerini almak için `az rest --url "https://management.azure.com/providers/Microsoft.Web/sourcecontrols?api-version=2024-04-01"` komutunu çalıştırabilirsiniz.
- Azure varsayılan olarak, kod güncellendiğinde her seferinde kodu App Service'e dağıtmak için bir **Github Action** ayarlayacaktır.
- Ayrıca, oradan kod almak için bir **uzaktan git deposu** (kullanıcı adı ve şifre ile) belirtmek de mümkündür.
- Uzaktan depo kimlik bilgilerini almak için `az webapp deployment source show --name <app-name> --resource-group <res-group>` veya `az rest --method POST --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/sites/<app-name>/config/metadata/list?api-version=2022-03-01" --resource "https://management.azure.com"` komutunu çalıştırabilirsiniz.
- Ayrıca bir **Azure Repository** kullanmak da mümkündür.
- Bir **yerel git deposu** yapılandırmak da mümkündür.
- Git deposunun URL'sini `az webapp deployment source show --name <app-name> --resource-group <res-group>` ile alabilirsiniz ve bu, uygulamanın SCM URL'si olacaktır.
- Klonlamak için, `az webapp deployment list-publishing-profiles --resource-group <res-group> -n <name>` komutuyla alabileceğiniz SCM kimlik bilgilerine ihtiyacınız olacaktır.

## Webjobs

Azure WebJobs, **Azure App Service ortamında çalışan arka plan görevleridir**. Geliştiricilerin, web uygulamalarıyla birlikte betikler veya programlar çalıştırmasına olanak tanır ve dosya işleme, veri işleme veya planlı görevler gibi zaman alıcı veya asenkron işlemleri daha kolay yönetmelerini sağlar. 
İki tür web job vardır:
- **Sürekli**: Sonsuz bir döngüde çalışır ve oluşturulur oluşturulmaz tetiklenir.
```bash
# List webapps
az webapp list
## Less information
az webapp list --query "[].{hostName: defaultHostName, state: state, name: name, resourcegroup: resourceGroup}" -o table
## Get SCM URL of each webapp
az webapp list | grep '"name"' | grep "\.scm\." | awk '{print $2}' | sed 's/"//g'

# Get info about 1 app
az webapp show --name <name> --resource-group <res-group>

# Get instances of a webapp
az webapp list-instances --name <name> --resource-group <res-group>
## If you have enough perm you can go to the "consoleUrl" and access a shell inside the instance form the web

# Get access restrictions of an app
az webapp config access-restriction show --name <name> --resource-group <res-group>

# Remove access restrictions
az webapp config access-restriction remove --resource-group <res-group> -n <name> --rule-name <rule-name>

# Get connection strings of a webapp
az webapp config connection-string list --name <name> --resource-group <res-group>

# Get appsettings of an app
az webapp config appsettings list --name <name> --resource-group <res-group>

# Get SCM and FTP credentials
az webapp deployment list-publishing-profiles --name <name> --resource-group <res-group>

# Get configured Auth information
az webapp auth show --name <app-name> --resource-group <res-group>

# Get backups of a webapp
az webapp config backup list --webapp-name <name> --resource-group <res-group>

# Get backups scheduled for a webapp
az webapp config backup show --webapp-name <name> --resource-group <res-group>

# Get snapshots
az webapp config snapshot list --resource-group <res-group> -n <name>

# Restore snapshot
az webapp config snapshot restore -g <res-group> -n <name> --time 2018-12-11T23:34:16.8388367

# Get slots
az webapp deployment slot list --name <AppName> --resource-group <ResourceGroupName> --output table
az webapp show --slot <SlotName> --name <AppName> --resource-group <ResourceGroupName>

# Get traffic-routing
az webapp traffic-routing show --name <AppName> --resource-group <ResourceGroupName>

# Get used container by the app
az webapp config container show --name <name> --resource-group <res-group>

# Get storage account configurations of a webapp
az webapp config storage-account list --name <name> --resource-group <res-group>

# Get configured container (if any) in the webapp, it could contain credentials
az webapp config container show --name <name> --resource-group <res-group>

# Get Webjobs
az webapp webjob continuous list --resource-group <res-group> --name <app-name>
az webapp webjob triggered list --resource-group <res-group> --name <app-name>

# Read webjobs logs with Azure permissions
az rest --method GET --url "<SCM-URL>/vfs/data/jobs/<continuous | triggered>/rev5/job_log.txt"  --resource "https://management.azure.com/"
az rest --method GET --url "https://lol-b5fyaeceh4e9dce0.scm.canadacentral-01.azurewebsites.net/vfs/data/jobs/continuous/rev5/job_log.txt"  --resource "https://management.azure.com/"

# Read webjobs logs with SCM credentials
curl "https://windowsapptesting-ckbrg3f0hyc8fkgp.scm.canadacentral-01.azurewebsites.net/vfs/data/jobs/continuous/lala/job_log.txt" \
--user '<username>:<password>' -v

# Get connections of a webapp
az webapp conection list --name <name> --resource-group <res-group>

# Get hybrid-connections of a webapp
az webapp hybrid-connections list --name <name> --resource-group <res-group>
```
{{#endtab }}

{{#tab name="Az Powershell" }}
```powershell
# Get App Services and Function Apps
Get-AzWebApp
# Get only App Services
Get-AzWebApp | ?{$_.Kind -notmatch "functionapp"}
```
{{#endtab }}

{{#tab name="az get all" }}
```bash
#!/bin/bash

# Get all App Service and Function Apps

# Define Azure subscription ID
azure_subscription="your_subscription_id"

# Log in to Azure
az login

# Select Azure subscription
az account set --subscription $azure_subscription

# Get all App Services in the specified subscription
list_app_services=$(az appservice list --query "[].{appServiceName: name, group: resourceGroup}" -o tsv)

# Iterate over each App Service
echo "$list_app_services" | while IFS=$'\t' read -r appServiceName group; do
# Get the type of the App Service
service_type=$(az appservice show --name $appServiceName --resource-group $group --query "kind" -o tsv)

# Check if it is a Function App and print its name
if [ "$service_type" == "functionapp" ]; then
echo "Function App Name: $appServiceName"
fi
done
```
{{#endtab }}
{{#endtabs }}

#### Kimlik bilgilerini elde et ve web uygulaması koduna erişim sağla
```bash
# Get connection strings that could contain credentials (with DBs for example)
az webapp config connection-string list --name <name> --resource-group <res-group>
## Check how to use the DBs connection strings in the SQL page

# Get credentials to access the code and DB credentials if configured.
az webapp deployment list-publishing-profiles --resource-group <res-group> -n <name>


# Get git URL to access the code
az webapp deployment source config-local-git --resource-group <res-group> -n <name>

# Access/Modify the code via git
git clone 'https://<username>:<password>@name.scm.azurewebsites.net/repo-name.git'
## In my case the username was: $nameofthewebapp and the password some random chars
## If you change the code and do a push, the app is automatically redeployed
```
{{#ref}}
../az-privilege-escalation/az-app-services-privesc.md
{{#endref}}

## Web Uygulamaları Oluşturma Örnekleri

### Yerel Python

Bu eğitim, [https://learn.microsoft.com/en-us/azure/app-service/quickstart-python](https://learn.microsoft.com/en-us/azure/app-service/quickstart-python?tabs=flask%2Cwindows%2Cazure-cli%2Cazure-cli-deploy%2Cdeploy-instructions-azportal%2Cterminal-bash%2Cdeploy-instructions-zip-azcli) adresindeki eğitimden alınmıştır.
```bash
# Clone repository
git clone https://github.com/Azure-Samples/msdocs-python-flask-webapp-quickstart
cd msdocs-python-flask-webapp-quickstart

# Create webapp from this code
az webapp up --runtime PYTHON:3.9 --sku B1 --logs
```
SCM portalına giriş yaparak veya FTP üzerinden bağlanarak `/wwwroot` dizininde web uygulamasının kodunu içeren `output.tar.gz` adlı sıkıştırılmış dosyayı görebilirsiniz.

> [!TIP]
> Sadece FTP üzerinden bağlanmak ve `output.tar.gz` dosyasını değiştirmek, web uygulaması tarafından yürütülen kodu değiştirmek için yeterli değildir.

**Bir saldırgan bu dosyayı indirebilir, değiştirebilir ve web uygulamasında rastgele kod yürütmek için tekrar yükleyebilir.**

### Github'dan Python

Bu eğitim, önceki eğitim üzerine inşa edilmiştir ancak bir Github deposu kullanmaktadır.

1. Github hesabınızda msdocs-python-flask-webapp-quickstart deposunu fork edin.
2. Azure'da yeni bir Python Web Uygulaması oluşturun.
3. `Deployment Center`'da kaynağı değiştirin, Github ile giriş yapın, fork edilmiş depoyu seçin ve `Save` butonuna tıklayın.

Önceki durumda olduğu gibi, SCM portalına giriş yaparak veya FTP üzerinden bağlanarak `/wwwroot` dizininde web uygulamasının kodunu içeren `output.tar.gz` adlı sıkıştırılmış dosyayı görebilirsiniz.

> [!TIP]
> Sadece FTP üzerinden bağlanmak ve `output.tar.gz` dosyasını değiştirmek ve bir dağıtımı yeniden tetiklemek, web uygulaması tarafından yürütülen kodu değiştirmek için yeterli değildir.


## References

- [https://learn.microsoft.com/en-in/azure/app-service/overview](https://learn.microsoft.com/en-in/azure/app-service/overview)

{{#include ../../../banners/hacktricks-training.md}}
