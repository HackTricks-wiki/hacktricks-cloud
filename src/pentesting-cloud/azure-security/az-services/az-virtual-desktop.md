# Az - Virtual Desktop

{{#include ../../../banners/hacktricks-training.md}}

## Azure Virtual Desktop

Virtual Desktopは**デスクトップおよびアプリの仮想化サービス**です。これにより、ユーザーにフルWindowsデスクトップ（Windows 11、Windows 10、またはWindows Serverを含む）をリモートで提供できます。個別のデスクトップまたは個別のアプリケーションを通じて提供されます。個人使用のためのシングルセッションセットアップと、マルチセッション環境をサポートしています。ユーザーは、ネイティブアプリまたはウェブブラウザを使用して、ほぼすべてのデバイスから接続できます。

### Host Pools

Azure Virtual Desktopのホストプールは、セッションホストとして構成されたAzure仮想マシンのコレクションであり、ユーザーに仮想デスクトップとアプリを提供します。主に2種類があります：
- **パーソナルホストプール**：各仮想マシンが単一のユーザーに専用され、その環境を持ちます。
- **プールホストプール**：複数のユーザーが利用可能なセッションホスト上でリソースを共有します。構成可能なセッション制限があり、セッションホストの構成により、Azure Virtual Desktopは構成に基づいてセッションホストの作成を自動化できます。

すべてのホストプールには、**登録トークン**があり、ホストプール内の仮想マシンを登録するために使用されます。

### Application groups & Workspace
アプリケーショングループは、ホストプール内のセッションホストで利用可能なフルデスクトップまたは特定のアプリケーションセットへの**ユーザーアクセスを制御**します。2種類あります：
- **デスクトップアプリケーショングループ**：ユーザーに完全なWindowsデスクトップへのアクセスを提供します（パーソナルおよびプールホストプールの両方で利用可能）。
- **RemoteAppグループ**：ユーザーが個別に公開されたアプリケーションにアクセスできるようにします（プールホストプールでのみ利用可能）。
ホストプールには1つのデスクトップアプリケーショングループがありますが、複数のRemoteAppグループを持つことができます。ユーザーは異なるホストプールにわたって複数のアプリケーショングループに割り当てることができます。同じホストプール内でデスクトップおよびRemoteAppグループの両方に割り当てられた場合、ユーザーは管理者によって設定された優先グループタイプのリソースのみを表示します。

**ワークスペース**は、ユーザーが割り当てられたデスクトップおよびアプリケーショングループにアクセスできる**アプリケーショングループのコレクション**です。各アプリケーショングループはワークスペースにリンクされている必要があり、一度に1つのワークスペースにのみ属することができます。

### Key Features
- **柔軟なVM作成**：Azure仮想マシンを直接作成するか、後でAzureローカル仮想マシンを追加します。
- **セキュリティ機能**：高度なVMセキュリティのためにTrusted Launch（セキュアブート、vTPM、整合性監視）を有効にします（仮想ネットワークが必要です）。Azure Firewallを統合し、Network Security Groupsを介してトラフィックを制御できます。
- **ドメイン参加**：カスタマイズ可能な構成でActive Directoryドメイン参加をサポートします。
- **診断と監視**：診断設定を有効にして、ログとメトリクスをLog Analytics、ストレージアカウント、またはイベントハブにストリーミングして監視します。
- **カスタムイメージテンプレート**：セッションホストを追加する際に使用するために作成および管理します。一般的なカスタマイズや独自のカスタムスクリプトを簡単に追加できます。
- **ワークスペース登録**：新しいまたは既存のワークスペースにデフォルトのデスクトップアプリケーショングループを簡単に登録し、ユーザーアクセス管理を簡素化します。

### Enumeration
```bash
az extension add --name desktopvirtualization

# List HostPool of a Resource group
az desktopvirtualization hostpool list --resource-group <Resource_Group>

# List Application Groups
az desktopvirtualization applicationgroup list --resource-group <Resource_Group>
# List Application Groups By Subscription
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.DesktopVirtualization/applicationGroups?api-version=2024-04-03"
# List Applications in a Application Group
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/applicationGroups/{applicationGroupName}/applications?api-version=2024-04-03"
# List Assigned Users to the Application Group
az rest \
--method GET \
--url "https://management.azure.com/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP_NAME>/providers/Microsoft.DesktopVirtualization/applicationGroups/<APP_GROUP_NAME>/providers/Microsoft.Authorization/roleAssignments?api-version=2022-04-01" \
| jq '.value[] | select((.properties.scope | ascii_downcase) == "/subscriptions/<subscription_id_in_lowercase>/resourcegroups/<resource_group_name_in_lowercase>/providers/microsoft.desktopvirtualization/applicationgroups/<app_group_name_in_lowercase>")'


# List Workspace in a resource group
az desktopvirtualization workspace list --resource-group <Resource_Group>
# List Workspace in a subscription
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.DesktopVirtualization/workspaces?api-version=2024-04-03"

# List App Attach Package By Resource Group
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/appAttachPackages?api-version=2024-04-03"
# List App Attach Package By Subscription
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.DesktopVirtualization/appAttachPackages?api-version=2024-04-03"

# List Desktops
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/applicationGroups/{applicationGroupName}/desktops?api-version=2024-04-03"

# List MSIX Packages
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourcegroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/msixPackages?api-version=2024-04-03"

# List private endpoint connections associated with hostpool.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/privateEndpointConnections?api-version=2024-04-03"
# List private endpoint connections associated By Workspace.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/workspaces/{workspaceName}/privateEndpointConnections?api-version=2024-04-03"

# List the private link resources available for a hostpool.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/privateLinkResources?api-version=2024-04-03"
# List the private link resources available for this workspace.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/workspaces/{workspaceName}/privateLinkResources?api-version=2024-04-03"

# List sessionHosts/virtual machines.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/sessionHosts?api-version=2024-04-03"

# List start menu items in the given application group.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/applicationGroups/{applicationGroupName}/startMenuItems?api-version=2024-04-03"

# List userSessions.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/sessionHosts/{sessionHostName}/userSessions?api-version=2024-04-03"
# List userSessions By Host Pool
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/userSessions?api-version=2024-04-03"

```
### 接続

ウェブ経由で仮想デスクトップに接続するには、https://client.wvd.microsoft.com/arm/webclient/ （最も一般的）または https://client.wvd.microsoft.com/webclient/index.html （クラシック）を通じてアクセスできます。  
他の方法については、ここに記載されています [https://learn.microsoft.com/en-us/azure/virtual-desktop/users/connect-remote-desktop-client?tabs=windows](https://learn.microsoft.com/en-us/azure/virtual-desktop/users/connect-remote-desktop-client?tabs=windows)

## Privesc

{{#ref}}
../az-privilege-escalation/az-virtual-desktop-privesc.md
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
