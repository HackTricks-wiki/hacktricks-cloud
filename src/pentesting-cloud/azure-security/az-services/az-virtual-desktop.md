# Az - Virtual Desktop

{{#include ../../../banners/hacktricks-training.md}}

## Azure Virtual Desktop

Virtual Desktop to **usługa wirtualizacji pulpitu i aplikacji**. Umożliwia zdalne dostarczanie pełnych pulpitów Windows, w tym Windows 11, Windows 10 lub Windows Server do użytkowników, zarówno jako indywidualne pulpity, jak i poprzez indywidualne aplikacje. Obsługuje konfiguracje jednosesyjnych dla użytku osobistego oraz środowiska wielosesyjne. Użytkownicy mogą łączyć się z praktycznie dowolnego urządzenia, korzystając z aplikacji natywnych lub przeglądarki internetowej.

### Host Pools

Host pools w Azure Virtual Desktop to zbiory maszyn wirtualnych Azure skonfigurowanych jako hosty sesji, dostarczające wirtualne pulpity i aplikacje użytkownikom. Istnieją dwa główne typy:
- **Personal host pools**, gdzie każda maszyna wirtualna jest dedykowana dla jednego użytkownika, z jego środowiskiem
- **Pooled host pools**, gdzie wielu użytkowników dzieli zasoby na dowolnym dostępnym hoście sesji. Ma konfigurowalny limit sesji, a konfiguracja hosta sesji pozwala Azure Virtual Desktop automatyzować tworzenie hostów sesji na podstawie konfiguracji.

Każdy host pool ma **token rejestracyjny**, który jest używany do rejestrowania maszyn wirtualnych w ramach host pool.

### Application groups & Workspace
Grupy aplikacji **kontrolują dostęp użytkowników** do pełnego pulpitu lub określonych zestawów aplikacji dostępnych na hostach sesji w ramach host pool. Istnieją dwa typy:
- **Desktop application groups**, które dają użytkownikom dostęp do pełnego pulpitu Windows (dostępne zarówno w personal, jak i pooled host pools)
- **RemoteApp groups**, które pozwalają użytkownikom na dostęp do indywidualnych opublikowanych aplikacji (dostępne tylko w pooled host pools).
Host pool może mieć jedną grupę aplikacji Desktop, ale wiele grup RemoteApp. Użytkownicy mogą być przypisani do wielu grup aplikacji w różnych host pools. Jeśli użytkownik jest przypisany zarówno do grup desktop, jak i RemoteApp w tym samym host pool, widzi tylko zasoby z preferowanego typu grupy ustawionego przez administratorów.

**Workspace** to **zbiór grup aplikacji**, umożliwiający użytkownikom dostęp do pulpitów i grup aplikacji przypisanych do nich. Każda grupa aplikacji musi być powiązana z workspace, a może należeć tylko do jednego workspace w danym czasie.

### Key Features
- **Flexible VM Creation**: Twórz maszyny wirtualne Azure bezpośrednio lub dodawaj lokalne maszyny wirtualne Azure później.
- **Security Features**: Włącz Trusted Launch (bezpieczne uruchamianie, vTPM, monitorowanie integralności) dla zaawansowanego bezpieczeństwa VM (wymagana jest wirtualna sieć). Może integrować Azure Firewall i kontrolować ruch za pomocą grup zabezpieczeń sieci.
- **Domain Join**: Wsparcie dla dołączeń do domeny Active Directory z konfigurowalnymi ustawieniami.
- **Diagnostics & Monitoring**: Włącz ustawienia diagnostyczne, aby przesyłać logi i metryki do Log Analytics, kontenerów magazynowych lub hubów zdarzeń w celu monitorowania.
- **Custom image templates**: Twórz i zarządzaj nimi do użycia przy dodawaniu hostów sesji. Łatwo dodawaj wspólne dostosowania lub własne skrypty.
- **Workspace Registration**: Łatwo rejestruj domyślne grupy aplikacji desktopowych do nowych lub istniejących workspace dla uproszczonego zarządzania dostępem użytkowników.

### Enumeration
```bash
az extension add --name desktopvirtualization

# List HostPool of a Resource group
az desktopvirtualization hostpool list --resource-group <Resource_Group>

# List Application Groups
az desktopvirtualization applicationgroup list --resource-group <Resource_Group>
# List Application Groups By Subscription
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.DesktopVirtualization/applicationGroups?api-version=2024-04-03"
# List Applications in a Application Group
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/applicationGroups/{applicationGroupName}/applications?api-version=2024-04-03"
# List Assigned Users to the Application Group
az rest \
--method GET \
--url "https://management.azure.com/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP_NAME>/providers/Microsoft.DesktopVirtualization/applicationGroups/<APP_GROUP_NAME>/providers/Microsoft.Authorization/roleAssignments?api-version=2022-04-01" \
| jq '.value[] | select((.properties.scope | ascii_downcase) == "/subscriptions/<subscription_id_in_lowercase>/resourcegroups/<resource_group_name_in_lowercase>/providers/microsoft.desktopvirtualization/applicationgroups/<app_group_name_in_lowercase>")'


# List Workspace in a resource group
az desktopvirtualization workspace list --resource-group <Resource_Group>
# List Workspace in a subscription
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.DesktopVirtualization/workspaces?api-version=2024-04-03"

# List App Attach Package By Resource Group
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/appAttachPackages?api-version=2024-04-03"
# List App Attach Package By Subscription
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.DesktopVirtualization/appAttachPackages?api-version=2024-04-03"

# List Desktops
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/applicationGroups/{applicationGroupName}/desktops?api-version=2024-04-03"

# List MSIX Packages
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourcegroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/msixPackages?api-version=2024-04-03"

# List private endpoint connections associated with hostpool.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/privateEndpointConnections?api-version=2024-04-03"
# List private endpoint connections associated By Workspace.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/workspaces/{workspaceName}/privateEndpointConnections?api-version=2024-04-03"

# List the private link resources available for a hostpool.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/privateLinkResources?api-version=2024-04-03"
# List the private link resources available for this workspace.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/workspaces/{workspaceName}/privateLinkResources?api-version=2024-04-03"

# List sessionHosts/virtual machines.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/sessionHosts?api-version=2024-04-03"

# List start menu items in the given application group.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/applicationGroups/{applicationGroupName}/startMenuItems?api-version=2024-04-03"

# List userSessions.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/sessionHosts/{sessionHostName}/userSessions?api-version=2024-04-03"
# List userSessions By Host Pool
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/userSessions?api-version=2024-04-03"

```
### Połączenie

Aby połączyć się z wirtualnym pulpitem przez sieć, możesz uzyskać dostęp przez https://client.wvd.microsoft.com/arm/webclient/ (najczęściej używane), lub https://client.wvd.microsoft.com/webclient/index.html (klasyczne)  
Istnieją inne metody, które są opisane tutaj [https://learn.microsoft.com/en-us/azure/virtual-desktop/users/connect-remote-desktop-client?tabs=windows](https://learn.microsoft.com/en-us/azure/virtual-desktop/users/connect-remote-desktop-client?tabs=windows)

## Privesc

{{#ref}}  
../az-privilege-escalation/az-virtual-desktop-privesc.md  
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
