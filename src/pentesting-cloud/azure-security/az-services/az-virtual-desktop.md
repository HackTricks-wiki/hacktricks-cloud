# Az - Virtual Desktop

{{#include ../../../banners/hacktricks-training.md}}

## Azure Virtual Desktop

Virtual Desktop è un **servizio di virtualizzazione desktop e app**. Consente di fornire desktop Windows completi, inclusi Windows 11, Windows 10 o Windows Server agli utenti da remoto, sia come desktop individuali che tramite singole applicazioni. Supporta configurazioni a sessione singola per uso personale e ambienti a sessione multipla. Gli utenti possono connettersi da praticamente qualsiasi dispositivo utilizzando app native o un browser web.

### Host Pools

Gli host pool in Azure Virtual Desktop sono collezioni di macchine virtuali Azure configurate come host di sessione, fornendo desktop virtuali e app agli utenti. Ci sono due tipi principali:
- **Personal host pools**, dove ogni macchina virtuale è dedicata a un singolo utente, con i propri ambienti
- **Pooled host pools**, dove più utenti condividono risorse su qualsiasi host di sessione disponibile. Ha un limite di sessione configurabile e una configurazione dell'host di sessione consente ad Azure Virtual Desktop di automatizzare la creazione di host di sessione basata su una configurazione

Ogni host pool ha un **token di registrazione** utilizzato per registrare macchine virtuali all'interno di un host pool.

### Application groups & Workspace
I gruppi di applicazioni **controllano l'accesso degli utenti** a un desktop completo o a set specifici di applicazioni disponibili sugli host di sessione all'interno di un host pool. Ci sono due tipi:
- **Desktop application groups**, che danno agli utenti accesso a un desktop Windows completo (disponibile sia con personal che con pooled host pools)
- **RemoteApp groups**, che consentono agli utenti di accedere a singole applicazioni pubblicate (disponibili solo con pooled host pools).
Un host pool può avere un gruppo di applicazioni Desktop ma più gruppi RemoteApp. Gli utenti possono essere assegnati a più gruppi di applicazioni attraverso diversi host pool. Se un utente è assegnato sia a gruppi desktop che a gruppi RemoteApp all'interno dello stesso host pool, vedrà solo le risorse dal tipo di gruppo preferito impostato dagli amministratori.

Un **workspace** è una **collezione di gruppi di applicazioni**, che consente agli utenti di accedere ai desktop e ai gruppi di applicazioni a loro assegnati. Ogni gruppo di applicazioni deve essere collegato a un workspace e può appartenere a un solo workspace alla volta.

### Key Features
- **Creazione flessibile di VM**: Crea macchine virtuali Azure direttamente o aggiungi macchine virtuali locali Azure in un secondo momento.
- **Funzionalità di sicurezza**: Abilita Trusted Launch (secure boot, vTPM, monitoraggio dell'integrità) per una sicurezza avanzata delle VM (è necessaria una rete virtuale). Può integrare Azure Firewall e controllare il traffico tramite Network Security Groups.
- **Domain Join**: Supporto per l'unione a domini Active Directory con configurazioni personalizzabili.
- **Diagnostica e monitoraggio**: Abilita le impostazioni diagnostiche per trasmettere log e metriche a Log Analytics, account di archiviazione o event hubs per il monitoraggio.
- **Modelli di immagine personalizzati**: Crea e gestisci modelli da utilizzare quando aggiungi host di sessione. Aggiungi facilmente personalizzazioni comuni o i tuoi script personalizzati.
- **Registrazione dello workspace**: Registra facilmente gruppi di applicazioni desktop predefiniti a nuovi o esistenti workspace per semplificare la gestione dell'accesso degli utenti.

### Enumeration
```bash
az extension add --name desktopvirtualization

# List HostPool of a Resource group
az desktopvirtualization hostpool list --resource-group <Resource_Group>

# List Application Groups
az desktopvirtualization applicationgroup list --resource-group <Resource_Group>
# List Application Groups By Subscription
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.DesktopVirtualization/applicationGroups?api-version=2024-04-03"
# List Applications in a Application Group
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/applicationGroups/{applicationGroupName}/applications?api-version=2024-04-03"
# List Assigned Users to the Application Group
az rest \
--method GET \
--url "https://management.azure.com/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP_NAME>/providers/Microsoft.DesktopVirtualization/applicationGroups/<APP_GROUP_NAME>/providers/Microsoft.Authorization/roleAssignments?api-version=2022-04-01" \
| jq '.value[] | select((.properties.scope | ascii_downcase) == "/subscriptions/<subscription_id_in_lowercase>/resourcegroups/<resource_group_name_in_lowercase>/providers/microsoft.desktopvirtualization/applicationgroups/<app_group_name_in_lowercase>")'


# List Workspace in a resource group
az desktopvirtualization workspace list --resource-group <Resource_Group>
# List Workspace in a subscription
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.DesktopVirtualization/workspaces?api-version=2024-04-03"

# List App Attach Package By Resource Group
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/appAttachPackages?api-version=2024-04-03"
# List App Attach Package By Subscription
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.DesktopVirtualization/appAttachPackages?api-version=2024-04-03"

# List Desktops
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/applicationGroups/{applicationGroupName}/desktops?api-version=2024-04-03"

# List MSIX Packages
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourcegroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/msixPackages?api-version=2024-04-03"

# List private endpoint connections associated with hostpool.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/privateEndpointConnections?api-version=2024-04-03"
# List private endpoint connections associated By Workspace.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/workspaces/{workspaceName}/privateEndpointConnections?api-version=2024-04-03"

# List the private link resources available for a hostpool.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/privateLinkResources?api-version=2024-04-03"
# List the private link resources available for this workspace.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/workspaces/{workspaceName}/privateLinkResources?api-version=2024-04-03"

# List sessionHosts/virtual machines.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/sessionHosts?api-version=2024-04-03"

# List start menu items in the given application group.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/applicationGroups/{applicationGroupName}/startMenuItems?api-version=2024-04-03"

# List userSessions.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/sessionHosts/{sessionHostName}/userSessions?api-version=2024-04-03"
# List userSessions By Host Pool
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/userSessions?api-version=2024-04-03"

```
### Connessione

Per connettersi al desktop virtuale tramite web, è possibile accedere tramite https://client.wvd.microsoft.com/arm/webclient/ (il più comune), o https://client.wvd.microsoft.com/webclient/index.html (classico) Ci sono altri metodi che sono descritti qui [https://learn.microsoft.com/en-us/azure/virtual-desktop/users/connect-remote-desktop-client?tabs=windows](https://learn.microsoft.com/en-us/azure/virtual-desktop/users/connect-remote-desktop-client?tabs=windows)

## Privesc

{{#ref}}
../az-privilege-escalation/az-virtual-desktop-privesc.md
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
