# Az - Virtual Desktop

{{#include ../../../banners/hacktricks-training.md}}

## Azure Virtual Desktop

Virtual Desktop는 **데스크탑 및 앱 가상화 서비스**입니다. 이는 Windows 11, Windows 10 또는 Windows Server를 포함한 전체 Windows 데스크탑을 사용자에게 원격으로 제공할 수 있게 해주며, 개별 데스크탑 또는 개별 애플리케이션을 통해 제공됩니다. 개인 사용을 위한 단일 세션 설정과 다중 세션 환경을 지원합니다. 사용자는 기본 앱이나 웹 브라우저를 사용하여 사실상 모든 장치에서 연결할 수 있습니다.

### Host Pools

Azure Virtual Desktop의 호스트 풀은 세션 호스트로 구성된 Azure 가상 머신의 모음으로, 사용자에게 가상 데스크탑과 앱을 제공합니다. 두 가지 주요 유형이 있습니다:
- **개인 호스트 풀**: 각 가상 머신이 단일 사용자에게 전용되며, 각자의 환경을 가집니다.
- **풀 호스트 풀**: 여러 사용자가 사용 가능한 세션 호스트에서 자원을 공유합니다. 구성 가능한 세션 한도가 있으며, 세션 호스트 구성은 Azure Virtual Desktop이 구성에 따라 세션 호스트 생성을 자동화할 수 있게 해줍니다.

모든 호스트 풀에는 **등록 토큰**이 있으며, 이는 호스트 풀 내에서 가상 머신을 등록하는 데 사용됩니다.

### Application groups & Workspace
애플리케이션 그룹은 **사용자 접근을 제어**하여 호스트 풀 내의 세션 호스트에서 전체 데스크탑 또는 특정 애플리케이션 세트에 접근할 수 있게 합니다. 두 가지 유형이 있습니다:
- **데스크탑 애플리케이션 그룹**: 사용자가 전체 Windows 데스크탑에 접근할 수 있게 해줍니다(개인 및 풀 호스트 풀 모두에서 사용 가능).
- **RemoteApp 그룹**: 사용자가 개별 게시 애플리케이션에 접근할 수 있게 해줍니다(풀 호스트 풀에서만 사용 가능).
호스트 풀은 하나의 데스크탑 애플리케이션 그룹을 가질 수 있지만 여러 RemoteApp 그룹을 가질 수 있습니다. 사용자는 서로 다른 호스트 풀에서 여러 애플리케이션 그룹에 할당될 수 있습니다. 사용자가 동일한 호스트 풀 내에서 데스크탑 및 RemoteApp 그룹 모두에 할당된 경우, 관리자가 설정한 선호 그룹 유형의 자원만 볼 수 있습니다.

**워크스페이스**는 **애플리케이션 그룹의 모음**으로, 사용자가 할당된 데스크탑 및 애플리케이션 그룹에 접근할 수 있게 해줍니다. 각 애플리케이션 그룹은 워크스페이스에 연결되어야 하며, 한 번에 하나의 워크스페이스에만 속할 수 있습니다.

### Key Features
- **유연한 VM 생성**: Azure 가상 머신을 직접 생성하거나 나중에 Azure Local 가상 머신을 추가할 수 있습니다.
- **보안 기능**: 고급 VM 보안을 위한 Trusted Launch(보안 부팅, vTPM, 무결성 모니터링)를 활성화합니다(가상 네트워크가 필요함). Azure Firewall과 통합하고 네트워크 보안 그룹을 통해 트래픽을 제어할 수 있습니다.
- **도메인 조인**: 사용자 정의 가능한 구성으로 Active Directory 도메인 조인을 지원합니다.
- **진단 및 모니터링**: 진단 설정을 활성화하여 로그 및 메트릭을 Log Analytics, 스토리지 계정 또는 이벤트 허브로 스트리밍하여 모니터링합니다.
- **사용자 정의 이미지 템플릿**: 세션 호스트를 추가할 때 사용할 수 있도록 생성하고 관리합니다. 일반적인 사용자 정의 또는 자체 사용자 정의 스크립트를 쉽게 추가할 수 있습니다.
- **워크스페이스 등록**: 새 또는 기존 워크스페이스에 기본 데스크탑 애플리케이션 그룹을 쉽게 등록하여 사용자 접근 관리를 간소화합니다.

### Enumeration
```bash
az extension add --name desktopvirtualization

# List HostPool of a Resource group
az desktopvirtualization hostpool list --resource-group <Resource_Group>

# List Application Groups
az desktopvirtualization applicationgroup list --resource-group <Resource_Group>
# List Application Groups By Subscription
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.DesktopVirtualization/applicationGroups?api-version=2024-04-03"
# List Applications in a Application Group
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/applicationGroups/{applicationGroupName}/applications?api-version=2024-04-03"
# List Assigned Users to the Application Group
az rest \
--method GET \
--url "https://management.azure.com/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP_NAME>/providers/Microsoft.DesktopVirtualization/applicationGroups/<APP_GROUP_NAME>/providers/Microsoft.Authorization/roleAssignments?api-version=2022-04-01" \
| jq '.value[] | select((.properties.scope | ascii_downcase) == "/subscriptions/<subscription_id_in_lowercase>/resourcegroups/<resource_group_name_in_lowercase>/providers/microsoft.desktopvirtualization/applicationgroups/<app_group_name_in_lowercase>")'


# List Workspace in a resource group
az desktopvirtualization workspace list --resource-group <Resource_Group>
# List Workspace in a subscription
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.DesktopVirtualization/workspaces?api-version=2024-04-03"

# List App Attach Package By Resource Group
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/appAttachPackages?api-version=2024-04-03"
# List App Attach Package By Subscription
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.DesktopVirtualization/appAttachPackages?api-version=2024-04-03"

# List Desktops
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/applicationGroups/{applicationGroupName}/desktops?api-version=2024-04-03"

# List MSIX Packages
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourcegroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/msixPackages?api-version=2024-04-03"

# List private endpoint connections associated with hostpool.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/privateEndpointConnections?api-version=2024-04-03"
# List private endpoint connections associated By Workspace.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/workspaces/{workspaceName}/privateEndpointConnections?api-version=2024-04-03"

# List the private link resources available for a hostpool.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/privateLinkResources?api-version=2024-04-03"
# List the private link resources available for this workspace.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/workspaces/{workspaceName}/privateLinkResources?api-version=2024-04-03"

# List sessionHosts/virtual machines.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/sessionHosts?api-version=2024-04-03"

# List start menu items in the given application group.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/applicationGroups/{applicationGroupName}/startMenuItems?api-version=2024-04-03"

# List userSessions.
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/sessionHosts/{sessionHostName}/userSessions?api-version=2024-04-03"
# List userSessions By Host Pool
az rest --method GET --url "https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.DesktopVirtualization/hostPools/{hostPoolName}/userSessions?api-version=2024-04-03"

```
### 연결

웹을 통해 가상 데스크톱에 연결하려면 https://client.wvd.microsoft.com/arm/webclient/ (가장 일반적) 또는 https://client.wvd.microsoft.com/webclient/index.html (클래식)을 통해 접근할 수 있습니다. 다른 방법은 여기에서 설명되어 있습니다 [https://learn.microsoft.com/en-us/azure/virtual-desktop/users/connect-remote-desktop-client?tabs=windows](https://learn.microsoft.com/en-us/azure/virtual-desktop/users/connect-remote-desktop-client?tabs=windows)

## 권한 상승

{{#ref}}
../az-privilege-escalation/az-virtual-desktop-privesc.md
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
