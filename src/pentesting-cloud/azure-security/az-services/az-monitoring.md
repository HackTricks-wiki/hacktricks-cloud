# Az - Monitoring

{{#include ../../../banners/hacktricks-training.md}}

## Entra ID - Logs

Υπάρχουν 3 τύποι καταγραφών διαθέσιμες στο Entra ID:

- **Sign-in Logs**: Οι καταγραφές σύνδεσης καταγράφουν κάθε προσπάθεια αυθεντικοποίησης, είτε επιτυχής είτε αποτυχημένη. Προσφέρουν λεπτομέρειες όπως διευθύνσεις IP, τοποθεσίες, πληροφορίες συσκευών και εφαρμοσμένες πολιτικές πρόσβασης, οι οποίες είναι απαραίτητες για την παρακολούθηση της δραστηριότητας των χρηστών και την ανίχνευση ύποπτης συμπεριφοράς σύνδεσης ή πιθανών απειλών ασφαλείας.
- **Audit Logs**: Οι καταγραφές ελέγχου παρέχουν ένα αρχείο όλων των αλλαγών που έγιναν στο περιβάλλον του Entra ID σας. Καταγράφουν ενημερώσεις σε χρήστες, ομάδες, ρόλους ή πολιτικές, για παράδειγμα. Αυτές οι καταγραφές είναι ζωτικής σημασίας για τη συμμόρφωση και τις έρευνες ασφαλείας, καθώς σας επιτρέπουν να ελέγξετε ποιος έκανε ποια αλλαγή και πότε.
- **Provisioning Logs**: Οι καταγραφές προμήθειας παρέχουν πληροφορίες σχετικά με τους χρήστες που έχουν προμηθευτεί στο ενοίκιο σας μέσω μιας τρίτης υπηρεσίας (όπως τοπικοί κατάλογοι ή εφαρμογές SaaS). Αυτές οι καταγραφές σας βοηθούν να κατανοήσετε πώς συγχρονίζεται η πληροφορία ταυτότητας.

> [!WARNING]
> Σημειώστε ότι αυτές οι καταγραφές αποθηκεύονται μόνο για **7 ημέρες** στην δωρεάν έκδοση, **30 ημέρες** στην έκδοση P1/P2 και 60 επιπλέον ημέρες σε σήματα ασφαλείας για επικίνδυνη δραστηριότητα σύνδεσης. Ωστόσο, ούτε καν ένας παγκόσμιος διαχειριστής δεν θα μπορεί να **τροποποιήσει ή να διαγράψει νωρίτερα**.

## Entra ID - Log Systems

- **Diagnostic Settings**: Μια ρύθμιση διαγνωστικών καθορίζει μια λίστα κατηγοριών καταγραφών πλατφόρμας και/ή μετρήσεων που θέλετε να συλλέξετε από μια πηγή, και έναν ή περισσότερους προορισμούς στους οποίους θα τις μεταδώσετε. Θα ισχύσουν κανονικές χρεώσεις χρήσης για τον προορισμό. Μάθετε περισσότερα για τις διάφορες κατηγορίες καταγραφών και το περιεχόμενο αυτών των καταγραφών.
- **Destinations**:
- **Analytics Workspace**: Έρευνα μέσω του Azure Log Analytics και δημιουργία ειδοποιήσεων.
- **Storage account**: Στατική ανάλυση και αντίγραφα ασφαλείας.
- **Event hub**: Ροή δεδομένων σε εξωτερικά συστήματα όπως τρίτα SIEM.
- **Monitor partner solutions**: Ειδικές ενσωματώσεις μεταξύ του Azure Monitor και άλλων μη Microsoft πλατφορμών παρακολούθησης.
- **Workbooks**: Τα workbooks συνδυάζουν κείμενο, ερωτήματα καταγραφών, μετρήσεις και παραμέτρους σε πλούσιες διαδραστικές αναφορές.
- **Usage & Insights**: Χρήσιμο για να δείτε τις πιο κοινές δραστηριότητες στο Entra ID.

## Azure Monitor

Αυτές είναι οι κύριες δυνατότητες του Azure Monitor:

- **Activity Logs**: Οι καταγραφές δραστηριότητας Azure καταγράφουν γεγονότα σε επίπεδο συνδρομής και διαχειριστικές ενέργειες, δίνοντάς σας μια επισκόπηση των αλλαγών και των ενεργειών που πραγματοποιήθηκαν στους πόρους σας.
- **Activily logs** δεν μπορούν να τροποποιηθούν ή να διαγραφούν.
- **Change Analysis**: Η ανάλυση αλλαγών ανιχνεύει αυτόματα και οπτικοποιεί τις αλλαγές διαμόρφωσης και κατάστασης στους πόρους Azure σας για να βοηθήσει στη διάγνωση προβλημάτων και την παρακολούθηση τροποποιήσεων με την πάροδο του χρόνου.
- **Alerts**: Οι ειδοποιήσεις από το Azure Monitor είναι αυτοματοποιημένες ειδοποιήσεις που ενεργοποιούνται όταν πληρούνται καθορισμένες συνθήκες ή όρια στο περιβάλλον Azure σας.
- **Workbooks**: Τα workbooks είναι διαδραστικοί, προσαρμόσιμοι πίνακες ελέγχου εντός του Azure Monitor που σας επιτρέπουν να συνδυάζετε και να οπτικοποιείτε δεδομένα από διάφορες πηγές για ολοκληρωμένη ανάλυση.
- **Investigator**: Ο Investigator σας βοηθά να εμβαθύνετε στα δεδομένα καταγραφών και τις ειδοποιήσεις για να διεξάγετε σε βάθος ανάλυση και να προσδιορίσετε την αιτία των περιστατικών.
- **Insights**: Τα Insights παρέχουν αναλύσεις, μετρικές απόδοσης και εφαρμόσιμες συστάσεις (όπως αυτές στο Application Insights ή VM Insights) για να σας βοηθήσουν να παρακολουθείτε και να βελτιστοποιείτε την υγεία και την αποδοτικότητα των εφαρμογών και της υποδομής σας.

### Log Analytics Workspaces

Τα workspaces Log Analytics είναι κεντρικές αποθήκες στο Azure Monitor όπου μπορείτε να **συλλέγετε, να αναλύετε και να οπτικοποιείτε δεδομένα καταγραφών και απόδοσης** από τους πόρους Azure και τα τοπικά περιβάλλοντά σας. Ακολουθούν τα κύρια σημεία:

- **Centralized Data Storage**: Λειτουργούν ως η κεντρική τοποθεσία για την αποθήκευση διαγνωστικών καταγραφών, μετρικών απόδοσης και προσαρμοσμένων καταγραφών που παράγονται από τις εφαρμογές και τις υπηρεσίες σας.
- **Powerful Query Capabilities**: Μπορείτε να εκτελείτε ερωτήματα χρησιμοποιώντας τη γλώσσα ερωτημάτων Kusto (KQL) για να αναλύσετε τα δεδομένα, να δημιουργήσετε insights και να επιλύσετε προβλήματα.
- **Integration with Monitoring Tools**: Τα workspaces Log Analytics ενσωματώνονται με διάφορες υπηρεσίες Azure (όπως Azure Monitor, Azure Sentinel και Application Insights) επιτρέποντάς σας να δημιουργείτε πίνακες ελέγχου, να ρυθμίζετε ειδοποιήσεις και να αποκτάτε μια ολοκληρωμένη εικόνα του περιβάλλοντός σας.

Συνοψίζοντας, ένα workspace Log Analytics είναι απαραίτητο για προηγμένη παρακολούθηση, επίλυση προβλημάτων και ανάλυση ασφαλείας στο Azure.

Μπορείτε να ρυθμίσετε μια πηγή να στέλνει δεδομένα σε ένα analytics workspace από τις **ρυθμίσεις διαγνωστικών** της πηγής.

## Enumeration

### Entra ID
```bash
# Get last 10 sign-ins
az rest --method get --uri 'https://graph.microsoft.com/v1.0/auditLogs/signIns?$top=10'

# Get last 10 audit logs
az rest --method get --uri 'https://graph.microsoft.com/v1.0/auditLogs/directoryAudits?$top=10'

# Get last 10 provisioning logs
az rest --method get --uri ‘https://graph.microsoft.com/v1.0/auditLogs/provisioning?$top=10’

# Get EntraID Diagnostic Settings
az rest --method get --uri "https://management.azure.com/providers/microsoft.aadiam/diagnosticSettings?api-version=2017-04-01-preview"

# Get Entra ID Workbooks
az rest \
--method POST \
--url "https://management.azure.com/providers/microsoft.resourcegraph/resources?api-version=2021-03-01" \
--headers '{"commandName": "AppInsightsExtension.GetWorkbooksListArg"}' \
--body '{
"subscriptions": ["9291ff6e-6afb-430e-82a4-6f04b2d05c7f"],
"query": "where type =~ \"microsoft.insights/workbooks\" \n| extend sourceId = tostring(properties.sourceId) \n| where sourceId =~ \"Azure Active Directory\" \n| extend DisplayName = tostring(properties.displayName) \n| extend WorkbookType = tostring(properties.category), LastUpdate = todatetime(properties.timeModified) \n| where WorkbookType == \"workbook\"\n| project DisplayName, name, resourceGroup, kind, location, id, type, subscriptionId, tags, WorkbookType, LastUpdate, identity, properties",
"options": {"resultFormat": "table"},
"name": "e4774363-5160-4c09-9d71-2da6c8e3b00a"
}' | jq '.data.rows'
```
### Azure Monitor
```bash
# Get last 10 activity logs
az monitor activity-log list --max-events 10

# Get Resource Diagnostic Settings
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.DocumentDb/databaseAccounts/<db-name>/providers/microsoft.insights/diagnosticSettings?api-version=2021-05-01-preview"

# Get Entra ID Workbooks
az rest \
--method POST \
--url "https://management.azure.com/providers/microsoft.resourcegraph/resources?api-version=2021-03-01" \
--headers '{"commandName": "AppInsightsExtension.GetWorkbooksListArg"}' \
--body '{
"content": {},
"commandName": "AppInsightsExtension.GetWorkbooksListArg"
}'

# List Log Analytic groups
az monitor log-analytics workspace list --output table

# List alerts
az monitor metrics alert list --output table
az monitor activity-log alert list --output table
```
{{#include ../../../banners/hacktricks-training.md}}
