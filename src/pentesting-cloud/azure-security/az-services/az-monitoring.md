# Az - Monitoring

{{#include ../../../banners/hacktricks-training.md}}

## Entra ID - Logs

Daar is 3 tipes logs beskikbaar in Entra ID:

- **Sign-in Logs**: Sign-in logs dokumenteer elke autentikasiepoging, of dit suksesvol of misluk is. Hulle bied besonderhede soos IP adresse, liggings, toestel inligting en toegepaste voorwaardelike toegang beleid, wat noodsaaklik is vir die monitering van gebruikersaktiwiteit en die opsporing van verdagte aanmeldgedrag of potensiële sekuriteitsbedreigings.
- **Audit Logs**: Audit logs bied 'n rekord van alle veranderinge wat binne jou Entra ID omgewing gemaak is. Hulle vang opdaterings van gebruikers, groepe, rolle, of beleid byvoorbeeld. Hierdie logs is noodsaaklik vir nakoming en sekuriteitsondersoeke, aangesien hulle jou toelaat om te hersien wie wat verander het en wanneer.
- **Provisioning Logs**: Provisioning logs bied inligting oor gebruikers wat in jou tenant deur 'n derdeparty diens (soos plaaslike gidse of SaaS toepassings) voorsien is. Hierdie logs help jou om te verstaan hoe identiteitsinligting gesinkroniseer word.

> [!WARNING]
> Let daarop dat hierdie logs slegs vir **7 dae** in die gratis weergawe gestoor word, **30 dae** in die P1/P2 weergawe en 60 bykomende dae in sekuriteitsseine vir riskante aanmeldaktiwiteit. egter, nie eers 'n globale admin sou in staat wees om hulle **vroeg te wysig of te verwyder** nie.

## Entra ID - Log Systems

- **Diagnostic Settings**: 'n Diagnostiese instelling spesifiseer 'n lys van kategorieë van platformlogs en/of metrieke wat jy wil insamel van 'n hulpbron, en een of meer bestemmings waarnatoe jy dit wil stroom. Normale gebruikskoste vir die bestemming sal van toepassing wees. Leer meer oor die verskillende logkategorieë en die inhoud van daardie logs.
- **Destinations**:
- **Analytics Workspace**: Ondersoek deur Azure Log Analytics en skep waarskuwings.
- **Storage account**: Statiese analise en rugsteun.
- **Event hub**: Stroom data na eksterne stelsels soos derdeparty SIEMs.
- **Monitor partner solutions**: Spesiale integrasies tussen Azure Monitor en ander nie-Microsoft monitering platforms.
- **Workbooks**: Workbooks kombineer teks, log navrae, metrieke, en parameters in ryk interaktiewe verslae.
- **Usage & Insights**: Nuttig om die mees algemene aktiwiteite in Entra ID te sien.

## Azure Monitor

Hierdie is die hoofkenmerke van Azure Monitor:

- **Activity Logs**: Azure Activity Logs vang subskripsie‑vlak gebeurtenisse en bestuursoperasies, wat jou 'n oorsig gee van veranderinge en aksies wat op jou hulpbronne geneem is.
- **Activily logs** kan nie gewysig of verwyder word nie.
- **Change Analysis**: Change Analysis detecteer en visualiseer outomaties konfigurasie en toestand veranderinge oor jou Azure hulpbronne om te help om probleme te diagnoseer en wysigings oor tyd te volg.
- **Alerts**: Alerts van Azure Monitor is geoutomatiseerde kennisgewings wat geaktiveer word wanneer spesifieke toestande of drempels in jou Azure omgewing bereik word.
- **Workbooks**: Workbooks is interaktiewe, aanpasbare dashboards binne Azure Monitor wat jou in staat stel om data van verskeie bronne te kombineer en te visualiseer vir omvattende analise.
- **Investigator**: Investigator help jou om in logdata en waarskuwings te delf om diepgaande analise te doen en die oorsaak van voorvalle te identifiseer.
- **Insights**: Insights bied analise, prestasiemetrieke, en uitvoerbare aanbevelings (soos dié in Application Insights of VM Insights) om jou te help om die gesondheid en doeltreffendheid van jou toepassings en infrastruktuur te monitor en te optimaliseer.

### Log Analytics Workspaces

Log Analytics werkruimtes is sentrale repositories in Azure Monitor waar jy **logs en prestasiedata kan insamel, analiseer, en visualiseer** van jou Azure hulpbronne en plaaslike omgewings. Hier is die sleutelpunke:

- **Centralized Data Storage**: Hulle dien as die sentrale plek om diagnostiese logs, prestasiemetrieke, en pasgemaakte logs wat deur jou toepassings en dienste gegenereer word, te stoor.
- **Powerful Query Capabilities**: Jy kan navrae uitvoer met behulp van Kusto Query Language (KQL) om die data te analiseer, insigte te genereer, en probleme op te los.
- **Integration with Monitoring Tools**: Log Analytics werkruimtes integreer met verskeie Azure dienste (soos Azure Monitor, Azure Sentinel, en Application Insights) wat jou toelaat om dashboards te skep, waarskuwings op te stel, en 'n omvattende oorsig van jou omgewing te verkry.

In samevatting, 'n Log Analytics werkruimte is noodsaaklik vir gevorderde monitering, probleemoplossing, en sekuriteitsanalise in Azure.

Jy kan 'n hulpbron konfigureer om data na 'n analitiese werkruimte te stuur vanaf die **diagnostiese instellings** van die hulpbron.

## Enumeration

### Entra ID
```bash
# Get last 10 sign-ins
az rest --method get --uri 'https://graph.microsoft.com/v1.0/auditLogs/signIns?$top=10'

# Get last 10 audit logs
az rest --method get --uri 'https://graph.microsoft.com/v1.0/auditLogs/directoryAudits?$top=10'

# Get last 10 provisioning logs
az rest --method get --uri ‘https://graph.microsoft.com/v1.0/auditLogs/provisioning?$top=10’

# Get EntraID Diagnostic Settings
az rest --method get --uri "https://management.azure.com/providers/microsoft.aadiam/diagnosticSettings?api-version=2017-04-01-preview"

# Get Entra ID Workbooks
az rest \
--method POST \
--url "https://management.azure.com/providers/microsoft.resourcegraph/resources?api-version=2021-03-01" \
--headers '{"commandName": "AppInsightsExtension.GetWorkbooksListArg"}' \
--body '{
"subscriptions": ["9291ff6e-6afb-430e-82a4-6f04b2d05c7f"],
"query": "where type =~ \"microsoft.insights/workbooks\" \n| extend sourceId = tostring(properties.sourceId) \n| where sourceId =~ \"Azure Active Directory\" \n| extend DisplayName = tostring(properties.displayName) \n| extend WorkbookType = tostring(properties.category), LastUpdate = todatetime(properties.timeModified) \n| where WorkbookType == \"workbook\"\n| project DisplayName, name, resourceGroup, kind, location, id, type, subscriptionId, tags, WorkbookType, LastUpdate, identity, properties",
"options": {"resultFormat": "table"},
"name": "e4774363-5160-4c09-9d71-2da6c8e3b00a"
}' | jq '.data.rows'
```
### Azure Monitor
```bash
# Get last 10 activity logs
az monitor activity-log list --max-events 10

# Get Resource Diagnostic Settings
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.DocumentDb/databaseAccounts/<db-name>/providers/microsoft.insights/diagnosticSettings?api-version=2021-05-01-preview"

# Get Entra ID Workbooks
az rest \
--method POST \
--url "https://management.azure.com/providers/microsoft.resourcegraph/resources?api-version=2021-03-01" \
--headers '{"commandName": "AppInsightsExtension.GetWorkbooksListArg"}' \
--body '{
"content": {},
"commandName": "AppInsightsExtension.GetWorkbooksListArg"
}'

# List Log Analytic groups
az monitor log-analytics workspace list --output table

# List alerts
az monitor metrics alert list --output table
az monitor activity-log alert list --output table
```
{{#include ../../../banners/hacktricks-training.md}}
