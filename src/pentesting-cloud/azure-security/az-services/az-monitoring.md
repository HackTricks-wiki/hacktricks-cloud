# Az - Monitoring

{{#include ../../../banners/hacktricks-training.md}}

## Entra ID - Loglar

Entra ID'de mevcut 3 tür log bulunmaktadır:

- **Oturum Açma Logları**: Oturum açma logları, başarılı veya başarısız her kimlik doğrulama girişimini belgelemektedir. IP adresleri, konumlar, cihaz bilgileri ve uygulanan koşullu erişim politikaları gibi detaylar sunar; bu bilgiler, kullanıcı etkinliğini izlemek ve şüpheli oturum açma davranışlarını veya potansiyel güvenlik tehditlerini tespit etmek için gereklidir.
- **Denetim Logları**: Denetim logları, Entra ID ortamınızdaki tüm değişikliklerin kaydını sağlar. Örneğin, kullanıcılar, gruplar, roller veya politikalar üzerindeki güncellemeleri yakalar. Bu loglar, kimlerin neyi ve ne zaman değiştirdiğini gözden geçirmenizi sağladığı için uyum ve güvenlik araştırmaları için hayati öneme sahiptir.
- **Provisioning Logları**: Provisioning logları, kiracınızdaki kullanıcıların üçüncü taraf bir hizmet (örneğin, yerel dizinler veya SaaS uygulamaları) aracılığıyla sağlandığına dair bilgi sunar. Bu loglar, kimlik bilgilerinin nasıl senkronize edildiğini anlamanıza yardımcı olur.

> [!WARNING]
> Bu logların yalnızca **7 gün** boyunca ücretsiz versiyonda, **30 gün** P1/P2 versiyonunda ve riskli oturum açma etkinliği için güvenlik sinyallerinde 60 ek gün boyunca saklandığını unutmayın. Ancak, hiçbir global admin bile bunları **daha önce değiştiremez veya silemez**.

## Entra ID - Log Sistemleri

- **Tanılama Ayarları**: Tanılama ayarı, bir kaynaktan toplamak istediğiniz platform logları ve/veya metriklerin bir kategoriler listesini ve bunları akıtmak istediğiniz bir veya daha fazla hedefi belirtir. Hedef için normal kullanım ücretleri uygulanacaktır. Farklı log kategorileri ve bu logların içerikleri hakkında daha fazla bilgi edinin.
- **Hedefler**:
- **Analitik Çalışma Alanı**: Azure Log Analytics aracılığıyla araştırma yapın ve uyarılar oluşturun.
- **Depolama hesabı**: Statik analiz ve yedekleme.
- **Olay merkezi**: Verileri üçüncü taraf SIEM'ler gibi harici sistemlere akıtın.
- **Ortak çözümler**: Azure Monitor ile diğer Microsoft dışı izleme platformları arasında özel entegrasyonlar.
- **Çalışma Kitapları**: Çalışma kitapları, metin, log sorguları, metrikler ve parametreleri zengin etkileşimli raporlar halinde birleştirir.
- **Kullanım ve İçgörüler**: Entra ID'deki en yaygın etkinlikleri görmek için faydalıdır.

## Azure Monitor

Azure Monitor'un ana özellikleri şunlardır:

- **Etkinlik Logları**: Azure Etkinlik Logları, abonelik düzeyindeki olayları ve yönetim işlemlerini yakalar, kaynaklarınız üzerindeki değişiklikler ve alınan eylemler hakkında genel bir bakış sunar.
- **Etkinlik logları** değiştirilemez veya silinemez.
- **Değişiklik Analizi**: Değişiklik Analizi, Azure kaynaklarınızda yapılandırma ve durum değişikliklerini otomatik olarak tespit eder ve görselleştirir, sorunları teşhis etmenize ve zamanla değişiklikleri takip etmenize yardımcı olur.
- **Uyarılar**: Azure Monitor'dan gelen uyarılar, Azure ortamınızdaki belirli koşullar veya eşikler karşılandığında tetiklenen otomatik bildirimlerdir.
- **Çalışma Kitapları**: Çalışma kitapları, Azure Monitor içinde etkileşimli, özelleştirilebilir panolar olup, çeşitli kaynaklardan verileri birleştirip görselleştirmenizi sağlar.
- **Araştırmacı**: Araştırmacı, log verileri ve uyarılar üzerinde derinlemesine analiz yapmanıza ve olayların nedenini belirlemenize yardımcı olur.
- **İçgörüler**: İçgörüler, uygulamalarınızın ve altyapınızın sağlığını ve verimliliğini izlemek ve optimize etmek için analitik, performans metrikleri ve eyleme geçirilebilir öneriler (Application Insights veya VM Insights'taki gibi) sunar.

### Log Analitik Çalışma Alanları

Log Analitik çalışma alanları, Azure Monitor'da Azure kaynaklarınızdan ve yerel ortamlarınızdan **log ve performans verilerini toplamak, analiz etmek ve görselleştirmek** için merkezi depolama alanlarıdır. İşte ana noktalar:

- **Merkezi Veri Depolama**: Tanılama logları, performans metrikleri ve uygulamalarınız ve hizmetleriniz tarafından üretilen özel logları depolamak için merkezi bir yer olarak hizmet eder.
- **Güçlü Sorgulama Yetenekleri**: Verileri analiz etmek, içgörüler oluşturmak ve sorunları gidermek için Kusto Sorgu Dili (KQL) kullanarak sorgular çalıştırabilirsiniz.
- **İzleme Araçları ile Entegrasyon**: Log Analitik çalışma alanları, Azure Monitor, Azure Sentinel ve Application Insights gibi çeşitli Azure hizmetleri ile entegre olarak panolar oluşturmanıza, uyarılar ayarlamanıza ve ortamınızın kapsamlı bir görünümünü elde etmenize olanak tanır.

Özetle, bir Log Analitik çalışma alanı, Azure'da gelişmiş izleme, sorun giderme ve güvenlik analizi için gereklidir.

Bir kaynağı, **tanılama ayarları** aracılığıyla bir analitik çalışma alanına veri gönderecek şekilde yapılandırabilirsiniz.

## Enumeration

### Entra ID
```bash
# Get last 10 sign-ins
az rest --method get --uri 'https://graph.microsoft.com/v1.0/auditLogs/signIns?$top=10'

# Get last 10 audit logs
az rest --method get --uri 'https://graph.microsoft.com/v1.0/auditLogs/directoryAudits?$top=10'

# Get last 10 provisioning logs
az rest --method get --uri ‘https://graph.microsoft.com/v1.0/auditLogs/provisioning?$top=10’

# Get EntraID Diagnostic Settings
az rest --method get --uri "https://management.azure.com/providers/microsoft.aadiam/diagnosticSettings?api-version=2017-04-01-preview"

# Get Entra ID Workbooks
az rest \
--method POST \
--url "https://management.azure.com/providers/microsoft.resourcegraph/resources?api-version=2021-03-01" \
--headers '{"commandName": "AppInsightsExtension.GetWorkbooksListArg"}' \
--body '{
"subscriptions": ["9291ff6e-6afb-430e-82a4-6f04b2d05c7f"],
"query": "where type =~ \"microsoft.insights/workbooks\" \n| extend sourceId = tostring(properties.sourceId) \n| where sourceId =~ \"Azure Active Directory\" \n| extend DisplayName = tostring(properties.displayName) \n| extend WorkbookType = tostring(properties.category), LastUpdate = todatetime(properties.timeModified) \n| where WorkbookType == \"workbook\"\n| project DisplayName, name, resourceGroup, kind, location, id, type, subscriptionId, tags, WorkbookType, LastUpdate, identity, properties",
"options": {"resultFormat": "table"},
"name": "e4774363-5160-4c09-9d71-2da6c8e3b00a"
}' | jq '.data.rows'
```
### Azure Monitor
```bash
# Get last 10 activity logs
az monitor activity-log list --max-events 10

# Get Resource Diagnostic Settings
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.DocumentDb/databaseAccounts/<db-name>/providers/microsoft.insights/diagnosticSettings?api-version=2021-05-01-preview"

# Get Entra ID Workbooks
az rest \
--method POST \
--url "https://management.azure.com/providers/microsoft.resourcegraph/resources?api-version=2021-03-01" \
--headers '{"commandName": "AppInsightsExtension.GetWorkbooksListArg"}' \
--body '{
"content": {},
"commandName": "AppInsightsExtension.GetWorkbooksListArg"
}'

# List Log Analytic groups
az monitor log-analytics workspace list --output table

# List alerts
az monitor metrics alert list --output table
az monitor activity-log alert list --output table
```
{{#include ../../../banners/hacktricks-training.md}}
