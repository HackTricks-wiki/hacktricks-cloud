# Az - Monitoring

{{#include ../../../banners/hacktricks-training.md}}

## Entra ID - Logi

W Entra ID dostępne są 3 typy logów:

- **Logi logowania**: Logi logowania dokumentują każdą próbę uwierzytelnienia, niezależnie od tego, czy była udana, czy nie. Oferują szczegóły takie jak adresy IP, lokalizacje, informacje o urządzeniach oraz zastosowane polityki dostępu warunkowego, które są niezbędne do monitorowania aktywności użytkowników i wykrywania podejrzanego zachowania logowania lub potencjalnych zagrożeń bezpieczeństwa.
- **Logi audytu**: Logi audytu dostarczają zapis wszystkich zmian dokonanych w Twoim środowisku Entra ID. Rejestrują aktualizacje użytkowników, grup, ról lub polityk, na przykład. Te logi są kluczowe dla zgodności i dochodzeń w zakresie bezpieczeństwa, ponieważ pozwalają przeglądać, kto dokonał jakiej zmiany i kiedy.
- **Logi provisioningowe**: Logi provisioningowe dostarczają informacji o użytkownikach przydzielonych w Twoim dzierżawie za pośrednictwem usługi zewnętrznej (takiej jak lokalne katalogi lub aplikacje SaaS). Te logi pomagają zrozumieć, jak synchronizowane są informacje o tożsamości.

> [!WARNING]
> Zauważ, że te logi są przechowywane tylko przez **7 dni** w wersji darmowej, **30 dni** w wersji P1/P2 oraz dodatkowe 60 dni w sygnałach bezpieczeństwa dla ryzykownej aktywności logowania. Jednak nawet globalny administrator nie mógłby **zmodyfikować ani usunąć ich wcześniej**.

## Entra ID - Systemy logów

- **Ustawienia diagnostyczne**: Ustawienie diagnostyczne określa listę kategorii logów platformy i/lub metryk, które chcesz zbierać z zasobu, oraz jedno lub więcej miejsc docelowych, do których chcesz je przesyłać. Normalne opłaty za użycie dla miejsca docelowego będą miały miejsce. Dowiedz się więcej o różnych kategoriach logów i zawartości tych logów.
- **Miejsca docelowe**:
- **Workspace analityczny**: Badanie za pomocą Azure Log Analytics i tworzenie alertów.
- **Konto magazynowe**: Analiza statyczna i kopia zapasowa.
- **Event hub**: Przesyłanie danych do systemów zewnętrznych, takich jak zewnętrzne SIEM-y.
- **Rozwiązania partnerskie monitorujące**: Specjalne integracje między Azure Monitor a innymi platformami monitorującymi, które nie są od Microsoftu.
- **Workbooki**: Workbooki łączą tekst, zapytania logów, metryki i parametry w bogate interaktywne raporty.
- **Użycie i spostrzeżenia**: Przydatne do zobaczenia najczęstszych aktywności w Entra ID.

## Azure Monitor

Oto główne funkcje Azure Monitor:

- **Logi aktywności**: Logi aktywności Azure rejestrują zdarzenia na poziomie subskrypcji i operacje zarządzania, dając przegląd zmian i działań podejmowanych na Twoich zasobach.
- **Logi aktywności** nie mogą być modyfikowane ani usuwane.
- **Analiza zmian**: Analiza zmian automatycznie wykrywa i wizualizuje zmiany konfiguracji i stanu w Twoich zasobach Azure, aby pomóc w diagnozowaniu problemów i śledzeniu modyfikacji w czasie.
- **Alerty**: Alerty z Azure Monitor to zautomatyzowane powiadomienia uruchamiane, gdy spełnione są określone warunki lub progi w Twoim środowisku Azure.
- **Workbooki**: Workbooki to interaktywne, konfigurowalne pulpity nawigacyjne w Azure Monitor, które umożliwiają łączenie i wizualizację danych z różnych źródeł w celu kompleksowej analizy.
- **Badacz**: Badacz pomaga w analizie danych logów i alertów, aby przeprowadzić dogłębną analizę i zidentyfikować przyczyny incydentów.
- **Spostrzeżenia**: Spostrzeżenia dostarczają analizy, metryki wydajności i zalecenia do działania (takie jak te w Application Insights lub VM Insights), aby pomóc w monitorowaniu i optymalizacji zdrowia oraz wydajności Twoich aplikacji i infrastruktury.

### Workspace analityki logów

Workspace analityki logów to centralne repozytoria w Azure Monitor, w których możesz **zbierać, analizować i wizualizować dane logów i wydajności** z Twoich zasobów Azure i lokalnych środowisk. Oto kluczowe punkty:

- **Centralne przechowywanie danych**: Służą jako centralne miejsce do przechowywania logów diagnostycznych, metryk wydajności i niestandardowych logów generowanych przez Twoje aplikacje i usługi.
- **Potężne możliwości zapytań**: Możesz uruchamiać zapytania za pomocą Kusto Query Language (KQL), aby analizować dane, generować spostrzeżenia i rozwiązywać problemy.
- **Integracja z narzędziami monitorującymi**: Workspace analityki logów integrują się z różnymi usługami Azure (takimi jak Azure Monitor, Azure Sentinel i Application Insights), co pozwala na tworzenie pulpitów nawigacyjnych, ustawianie alertów i uzyskiwanie kompleksowego widoku swojego środowiska.

Podsumowując, workspace analityki logów jest niezbędny do zaawansowanego monitorowania, rozwiązywania problemów i analizy bezpieczeństwa w Azure.

Możesz skonfigurować zasób, aby wysyłał dane do workspace analityki z **ustawień diagnostycznych** zasobu.

## Enumeracja

### Entra ID
```bash
# Get last 10 sign-ins
az rest --method get --uri 'https://graph.microsoft.com/v1.0/auditLogs/signIns?$top=10'

# Get last 10 audit logs
az rest --method get --uri 'https://graph.microsoft.com/v1.0/auditLogs/directoryAudits?$top=10'

# Get last 10 provisioning logs
az rest --method get --uri ‘https://graph.microsoft.com/v1.0/auditLogs/provisioning?$top=10’

# Get EntraID Diagnostic Settings
az rest --method get --uri "https://management.azure.com/providers/microsoft.aadiam/diagnosticSettings?api-version=2017-04-01-preview"

# Get Entra ID Workbooks
az rest \
--method POST \
--url "https://management.azure.com/providers/microsoft.resourcegraph/resources?api-version=2021-03-01" \
--headers '{"commandName": "AppInsightsExtension.GetWorkbooksListArg"}' \
--body '{
"subscriptions": ["9291ff6e-6afb-430e-82a4-6f04b2d05c7f"],
"query": "where type =~ \"microsoft.insights/workbooks\" \n| extend sourceId = tostring(properties.sourceId) \n| where sourceId =~ \"Azure Active Directory\" \n| extend DisplayName = tostring(properties.displayName) \n| extend WorkbookType = tostring(properties.category), LastUpdate = todatetime(properties.timeModified) \n| where WorkbookType == \"workbook\"\n| project DisplayName, name, resourceGroup, kind, location, id, type, subscriptionId, tags, WorkbookType, LastUpdate, identity, properties",
"options": {"resultFormat": "table"},
"name": "e4774363-5160-4c09-9d71-2da6c8e3b00a"
}' | jq '.data.rows'
```
### Azure Monitor
```bash
# Get last 10 activity logs
az monitor activity-log list --max-events 10

# Get Resource Diagnostic Settings
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.DocumentDb/databaseAccounts/<db-name>/providers/microsoft.insights/diagnosticSettings?api-version=2021-05-01-preview"

# Get Entra ID Workbooks
az rest \
--method POST \
--url "https://management.azure.com/providers/microsoft.resourcegraph/resources?api-version=2021-03-01" \
--headers '{"commandName": "AppInsightsExtension.GetWorkbooksListArg"}' \
--body '{
"content": {},
"commandName": "AppInsightsExtension.GetWorkbooksListArg"
}'

# List Log Analytic groups
az monitor log-analytics workspace list --output table

# List alerts
az monitor metrics alert list --output table
az monitor activity-log alert list --output table
```
{{#include ../../../banners/hacktricks-training.md}}
