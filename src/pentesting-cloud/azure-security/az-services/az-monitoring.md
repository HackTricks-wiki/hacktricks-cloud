# Az - 监控

{{#include ../../../banners/hacktricks-training.md}}

## Entra ID - 日志

在 Entra ID 中有 3 种类型的日志：

- **登录日志**：登录日志记录每次身份验证尝试，无论成功与否。它们提供诸如 IP 地址、位置、设备信息和应用的条件访问策略等详细信息，这些对于监控用户活动和检测可疑登录行为或潜在安全威胁至关重要。
- **审计日志**：审计日志提供您 Entra ID 环境中所有更改的记录。它们捕获对用户、组、角色或策略等的更新。这些日志对于合规性和安全调查至关重要，因为它们让您查看是谁在何时进行了什么更改。
- **配置日志**：配置日志提供有关通过第三方服务（例如本地目录或 SaaS 应用程序）在您的租户中配置的用户的信息。这些日志帮助您了解身份信息是如何同步的。

> [!WARNING]
> 请注意，这些日志在免费版本中仅存储 **7 天**，在 P1/P2 版本中存储 **30 天**，并在风险登录活动的安全信号中额外存储 60 天。然而，即使是全球管理员也无法 **提前修改或删除它们**。

## Entra ID - 日志系统

- **诊断设置**：诊断设置指定您希望从资源收集的平台日志和/或指标的类别列表，以及您希望将其流式传输到的一个或多个目标。目标的正常使用费用将会产生。了解有关不同日志类别及其内容的更多信息。
- **目标**：
- **分析工作区**：通过 Azure Log Analytics 进行调查并创建警报。
- **存储帐户**：静态分析和备份。
- **事件中心**：将数据流式传输到外部系统，如第三方 SIEM。
- **监控合作伙伴解决方案**：Azure Monitor 与其他非 Microsoft 监控平台之间的特殊集成。
- **工作簿**：工作簿将文本、日志查询、指标和参数结合成丰富的交互式报告。
- **使用情况与洞察**：有助于查看 Entra ID 中最常见的活动。

## Azure Monitor

Azure Monitor 的主要功能包括：

- **活动日志**：Azure 活动日志捕获订阅级事件和管理操作，提供对资源上所做更改和操作的概述。
- **活动日志** 不能被修改或删除。
- **变更分析**：变更分析自动检测并可视化 Azure 资源的配置和状态变化，以帮助诊断问题并跟踪随时间的修改。
- **警报**：Azure Monitor 的警报是在 Azure 环境中满足特定条件或阈值时触发的自动通知。
- **工作簿**：工作簿是 Azure Monitor 中的交互式、自定义仪表板，使您能够结合和可视化来自各种来源的数据，以进行全面分析。
- **调查员**：调查员帮助您深入分析日志数据和警报，以进行深入分析并识别事件的原因。
- **洞察**：洞察提供分析、性能指标和可操作的建议（如应用程序洞察或虚拟机洞察中的建议），帮助您监控和优化应用程序和基础设施的健康和效率。

### 日志分析工作区

日志分析工作区是 Azure Monitor 中的中央存储库，您可以在其中 **收集、分析和可视化来自 Azure 资源和本地环境的日志和性能数据**。以下是关键点：

- **集中数据存储**：它们作为存储诊断日志、性能指标和由您的应用程序和服务生成的自定义日志的中央位置。
- **强大的查询能力**：您可以使用 Kusto 查询语言（KQL）运行查询以分析数据、生成洞察并排除问题。
- **与监控工具的集成**：日志分析工作区与各种 Azure 服务（如 Azure Monitor、Azure Sentinel 和应用程序洞察）集成，允许您创建仪表板、设置警报并获得对环境的全面视图。

总之，日志分析工作区对于 Azure 中的高级监控、故障排除和安全分析至关重要。

您可以从资源的 **诊断设置** 配置资源以将数据发送到分析工作区。

## 枚举

### Entra ID
```bash
# Get last 10 sign-ins
az rest --method get --uri 'https://graph.microsoft.com/v1.0/auditLogs/signIns?$top=10'

# Get last 10 audit logs
az rest --method get --uri 'https://graph.microsoft.com/v1.0/auditLogs/directoryAudits?$top=10'

# Get last 10 provisioning logs
az rest --method get --uri ‘https://graph.microsoft.com/v1.0/auditLogs/provisioning?$top=10’

# Get EntraID Diagnostic Settings
az rest --method get --uri "https://management.azure.com/providers/microsoft.aadiam/diagnosticSettings?api-version=2017-04-01-preview"

# Get Entra ID Workbooks
az rest \
--method POST \
--url "https://management.azure.com/providers/microsoft.resourcegraph/resources?api-version=2021-03-01" \
--headers '{"commandName": "AppInsightsExtension.GetWorkbooksListArg"}' \
--body '{
"subscriptions": ["9291ff6e-6afb-430e-82a4-6f04b2d05c7f"],
"query": "where type =~ \"microsoft.insights/workbooks\" \n| extend sourceId = tostring(properties.sourceId) \n| where sourceId =~ \"Azure Active Directory\" \n| extend DisplayName = tostring(properties.displayName) \n| extend WorkbookType = tostring(properties.category), LastUpdate = todatetime(properties.timeModified) \n| where WorkbookType == \"workbook\"\n| project DisplayName, name, resourceGroup, kind, location, id, type, subscriptionId, tags, WorkbookType, LastUpdate, identity, properties",
"options": {"resultFormat": "table"},
"name": "e4774363-5160-4c09-9d71-2da6c8e3b00a"
}' | jq '.data.rows'
```
### Azure Monitor
```bash
# Get last 10 activity logs
az monitor activity-log list --max-events 10

# Get Resource Diagnostic Settings
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.DocumentDb/databaseAccounts/<db-name>/providers/microsoft.insights/diagnosticSettings?api-version=2021-05-01-preview"

# Get Entra ID Workbooks
az rest \
--method POST \
--url "https://management.azure.com/providers/microsoft.resourcegraph/resources?api-version=2021-03-01" \
--headers '{"commandName": "AppInsightsExtension.GetWorkbooksListArg"}' \
--body '{
"content": {},
"commandName": "AppInsightsExtension.GetWorkbooksListArg"
}'

# List Log Analytic groups
az monitor log-analytics workspace list --output table

# List alerts
az monitor metrics alert list --output table
az monitor activity-log alert list --output table
```
{{#include ../../../banners/hacktricks-training.md}}
