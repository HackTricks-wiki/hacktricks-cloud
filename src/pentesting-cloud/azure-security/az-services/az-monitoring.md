# Az - Monitoring

{{#include ../../../banners/hacktricks-training.md}}

## Entra ID - Logs

Hay 3 tipos de logs disponibles en Entra ID:

- **Sign-in Logs**: Los logs de inicio de sesión documentan cada intento de autenticación, ya sea exitoso o fallido. Ofrecen detalles como direcciones IP, ubicaciones, información del dispositivo y políticas de acceso condicional aplicadas, que son esenciales para monitorear la actividad del usuario y detectar comportamientos de inicio de sesión sospechosos o posibles amenazas de seguridad.
- **Audit Logs**: Los logs de auditoría proporcionan un registro de todos los cambios realizados dentro de su entorno de Entra ID. Capturan actualizaciones a usuarios, grupos, roles o políticas, por ejemplo. Estos logs son vitales para el cumplimiento y las investigaciones de seguridad, ya que le permiten revisar quién hizo qué cambio y cuándo.
- **Provisioning Logs**: Los logs de aprovisionamiento proporcionan información sobre los usuarios aprovisionados en su inquilino a través de un servicio de terceros (como directorios locales o aplicaciones SaaS). Estos logs le ayudan a entender cómo se sincroniza la información de identidad.

> [!WARNING]
> Tenga en cuenta que estos logs solo se almacenan durante **7 días** en la versión gratuita, **30 días** en la versión P1/P2 y 60 días adicionales en señales de seguridad para actividades de inicio de sesión arriesgadas. Sin embargo, ni siquiera un administrador global podría **modificarlos o eliminarlos antes**.

## Entra ID - Log Systems

- **Diagnostic Settings**: Una configuración de diagnóstico especifica una lista de categorías de logs de plataforma y/o métricas que desea recopilar de un recurso, y uno o más destinos a los que los transmitirá. Se aplicarán cargos normales de uso para el destino. Aprenda más sobre las diferentes categorías de logs y el contenido de esos logs.
- **Destinations**:
- **Analytics Workspace**: Investigación a través de Azure Log Analytics y creación de alertas.
- **Storage account**: Análisis estático y respaldo.
- **Event hub**: Transmitir datos a sistemas externos como SIEMs de terceros.
- **Monitor partner solutions**: Integraciones especiales entre Azure Monitor y otras plataformas de monitoreo que no son de Microsoft.
- **Workbooks**: Los workbooks combinan texto, consultas de logs, métricas y parámetros en informes interactivos ricos.
- **Usage & Insights**: Útil para ver las actividades más comunes en Entra ID.

## Azure Monitor

Estas son las principales características de Azure Monitor:

- **Activity Logs**: Los logs de actividad de Azure capturan eventos a nivel de suscripción y operaciones de gestión, dándole una visión general de los cambios y acciones realizadas en sus recursos.
- **Activily logs** no pueden ser modificados o eliminados.
- **Change Analysis**: El análisis de cambios detecta y visualiza automáticamente cambios de configuración y estado en sus recursos de Azure para ayudar a diagnosticar problemas y rastrear modificaciones a lo largo del tiempo.
- **Alerts**: Las alertas de Azure Monitor son notificaciones automatizadas que se activan cuando se cumplen condiciones o umbrales especificados en su entorno de Azure.
- **Workbooks**: Los workbooks son paneles interactivos y personalizables dentro de Azure Monitor que le permiten combinar y visualizar datos de diversas fuentes para un análisis integral.
- **Investigator**: Investigator le ayuda a profundizar en los datos de logs y alertas para realizar un análisis profundo e identificar la causa de los incidentes.
- **Insights**: Insights proporcionan análisis, métricas de rendimiento y recomendaciones accionables (como las de Application Insights o VM Insights) para ayudarle a monitorear y optimizar la salud y eficiencia de sus aplicaciones e infraestructura.

### Log Analytics Workspaces

Los espacios de trabajo de Log Analytics son repositorios centrales en Azure Monitor donde puede **recopilar, analizar y visualizar datos de logs y rendimiento** de sus recursos de Azure y entornos locales. Aquí están los puntos clave:

- **Centralized Data Storage**: Sirven como la ubicación central para almacenar logs de diagnóstico, métricas de rendimiento y logs personalizados generados por sus aplicaciones y servicios.
- **Powerful Query Capabilities**: Puede ejecutar consultas utilizando Kusto Query Language (KQL) para analizar los datos, generar insights y solucionar problemas.
- **Integration with Monitoring Tools**: Los espacios de trabajo de Log Analytics se integran con varios servicios de Azure (como Azure Monitor, Azure Sentinel y Application Insights) permitiéndole crear paneles, configurar alertas y obtener una vista integral de su entorno.

En resumen, un espacio de trabajo de Log Analytics es esencial para el monitoreo avanzado, la solución de problemas y el análisis de seguridad en Azure.

Puede configurar un recurso para enviar datos a un espacio de trabajo de análisis desde los **diagnostic settings** del recurso.

## Enumeration

### Entra ID
```bash
# Get last 10 sign-ins
az rest --method get --uri 'https://graph.microsoft.com/v1.0/auditLogs/signIns?$top=10'

# Get last 10 audit logs
az rest --method get --uri 'https://graph.microsoft.com/v1.0/auditLogs/directoryAudits?$top=10'

# Get last 10 provisioning logs
az rest --method get --uri ‘https://graph.microsoft.com/v1.0/auditLogs/provisioning?$top=10’

# Get EntraID Diagnostic Settings
az rest --method get --uri "https://management.azure.com/providers/microsoft.aadiam/diagnosticSettings?api-version=2017-04-01-preview"

# Get Entra ID Workbooks
az rest \
--method POST \
--url "https://management.azure.com/providers/microsoft.resourcegraph/resources?api-version=2021-03-01" \
--headers '{"commandName": "AppInsightsExtension.GetWorkbooksListArg"}' \
--body '{
"subscriptions": ["9291ff6e-6afb-430e-82a4-6f04b2d05c7f"],
"query": "where type =~ \"microsoft.insights/workbooks\" \n| extend sourceId = tostring(properties.sourceId) \n| where sourceId =~ \"Azure Active Directory\" \n| extend DisplayName = tostring(properties.displayName) \n| extend WorkbookType = tostring(properties.category), LastUpdate = todatetime(properties.timeModified) \n| where WorkbookType == \"workbook\"\n| project DisplayName, name, resourceGroup, kind, location, id, type, subscriptionId, tags, WorkbookType, LastUpdate, identity, properties",
"options": {"resultFormat": "table"},
"name": "e4774363-5160-4c09-9d71-2da6c8e3b00a"
}' | jq '.data.rows'
```
### Azure Monitor
```bash
# Get last 10 activity logs
az monitor activity-log list --max-events 10

# Get Resource Diagnostic Settings
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.DocumentDb/databaseAccounts/<db-name>/providers/microsoft.insights/diagnosticSettings?api-version=2021-05-01-preview"

# Get Entra ID Workbooks
az rest \
--method POST \
--url "https://management.azure.com/providers/microsoft.resourcegraph/resources?api-version=2021-03-01" \
--headers '{"commandName": "AppInsightsExtension.GetWorkbooksListArg"}' \
--body '{
"content": {},
"commandName": "AppInsightsExtension.GetWorkbooksListArg"
}'

# List Log Analytic groups
az monitor log-analytics workspace list --output table

# List alerts
az monitor metrics alert list --output table
az monitor activity-log alert list --output table
```
{{#include ../../../banners/hacktricks-training.md}}
