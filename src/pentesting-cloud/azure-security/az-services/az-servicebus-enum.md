# Az - Service Bus Enum

{{#include ../../../banners/hacktricks-training.md}}

## Service Bus

Azure Service Bus 是一个基于云的 **消息服务**，旨在实现 **应用程序不同部分或独立应用程序之间的可靠通信**。它充当安全的中介，确保消息安全送达，即使发送者和接收者并不同时操作。通过解耦系统，它允许应用程序独立工作，同时仍然交换数据或指令。它特别适用于需要在多个工作者之间进行负载均衡、可靠消息传递或复杂协调的场景，例如按顺序处理任务或安全管理访问。

### Key Concepts

1. **Queues:** 其目的是存储消息，直到接收者准备好。
- 消息是有序的、带时间戳的，并且持久存储。
- 以拉取模式（按需检索）交付。
- 支持点对点通信。
2. **Topics:** 发布-订阅消息，用于广播。
- 多个独立订阅接收消息的副本。
- 订阅可以有规则/过滤器来控制交付或添加元数据。
- 支持多对多通信。
3. **Namespaces:** 所有消息组件、队列和主题的容器，就像您自己的一部分强大 Azure 集群，提供专用容量，并可选择跨越三个可用区。

### Advance Features

一些高级功能包括：

- **Message Sessions**: 确保 FIFO 处理并支持请求-响应模式。
- **Auto-Forwarding**: 在同一命名空间内在队列或主题之间转移消息。
- **Dead-Lettering**: 捕获无法送达的消息以供审查。
- **Scheduled Delivery**: 延迟消息处理以进行未来任务。
- **Message Deferral**: 推迟消息检索直到准备好。
- **Transactions**: 将操作分组为原子执行。
- **Filters & Actions**: 应用规则以过滤或注释消息。
- **Auto-Delete on Idle**: 在不活动后删除队列（最小：5分钟）。
- **Duplicate Detection**: 在重发期间删除重复消息。
- **Batch Deletion**: 批量删除过期或不必要的消息。

### Authorization-Rule / SAS Policy

SAS 策略定义了 Azure Service Bus 实体命名空间（最重要的一个）、队列和主题的访问权限。每个策略具有以下组件：

- **Permissions**: 复选框以指定访问级别：
- Manage: 授予对实体的完全控制，包括配置和权限管理。
- Send: 允许向实体发送消息。
- Listen: 允许从实体接收消息。
- **Primary and Secondary Keys**: 这些是用于生成安全令牌以进行访问身份验证的加密密钥。
- **Primary and Secondary Connection Strings**: 预配置的连接字符串，包括端点和密钥，便于在应用程序中使用。
- **SAS Policy ARM ID**: Azure 资源管理器（ARM）路径，用于程序识别该策略。

### NameSpace

sku, authrorization rule,

### Enumeration
```bash
# Queue Enumeration
az servicebus queue list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyQueue>

# Topic Enumeration
az servicebus topic list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus topic show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyTopic>

# Susbscription Enumeration
az servicebus topic subscription list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus topic subscription show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic> --name <MySubscription>

# Namespace Enumeration
az servicebus namespace list
az servicebus namespace network-rule-set list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace show --resource-group <MyResourceGroup> --name <MyNamespace>
az servicebus namespace network-rule-set show --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace private-endpoint-connection list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace exists --name ProposedNamespace

# Authorization Rule Enumeration
az servicebus namespace authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --queue-name <MyQueue>
az servicebus topic authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus namespace authorization-rule keys list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyAuthRule>
```
### 权限提升

{{#ref}}
../az-privilege-escalation/az-servicebus-privesc.md
{{#endref}}

### 后期利用

{{#ref}}
../az-post-exploitation/az-servicebus-post-exploitation.md
{{#endref}}

## 参考文献

- https://learn.microsoft.com/en-us/powershell/module/az.servicebus/?view=azps-13.0.0
- https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview
- https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-cli

{{#include ../../../banners/hacktricks-training.md}}
