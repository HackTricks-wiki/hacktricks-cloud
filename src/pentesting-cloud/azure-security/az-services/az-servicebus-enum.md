# Az - Service Bus Enum

{{#include ../../../banners/hacktricks-training.md}}

## Service Bus

Azure Service Bus ni **huduma ya ujumbe** inayotolewa kwenye wingu iliyoundwa kuwezesha **mawasiliano ya kuaminika kati ya sehemu tofauti za programu au programu tofauti**. Inafanya kazi kama katikati salama, kuhakikisha ujumbe unawasilishwa kwa usalama, hata kama mtumaji na mpokeaji hawafanyi kazi kwa wakati mmoja. Kwa kutenganisha mifumo, inaruhusu programu kufanya kazi kwa uhuru huku bado zikibadilishana data au maagizo. Ni muhimu hasa kwa hali zinazohitaji usawa wa mzigo kati ya wafanyakazi wengi, utoaji wa ujumbe wa kuaminika, au uratibu mgumu, kama vile kusindika kazi kwa mpangilio au kusimamia ufikiaji kwa usalama.

### Key Concepts

1. **Namespaces:** Namespace katika mifumo ya ujumbe ni chombo cha kimantiki kinachopanga na kusimamia vipengele vya ujumbe, foleni na mada. Inatoa mazingira yaliyotengwa ambapo programu zinaweza kutuma, kupokea, na kusindika ujumbe. Foleni na mada zinashiriki miundombinu na usanidi sawa ndani ya namespace ya Service Bus, lakini zinafanya kazi kwa uhuru bila kuingiliana.
2. **Queues:** kusudi lake ni kuhifadhi ujumbe hadi mpokeaji awe tayari.
- Ujumbe umeagizwa, umewekwa alama ya muda, na kuhifadhiwa kwa kudumu.
- Utoaji unafanyika kwa njia ya kuvuta (urejeshaji kwa mahitaji).
- Inasaidia mawasiliano ya pointi-kwa-point.
3. **Topics:** Ujumbe wa kuchapisha-na-kujiandikisha kwa matangazo.
- Usajili wengi huru hupokea nakala za ujumbe.
- Usajili unaweza kuwa na sheria/filter za kudhibiti utoaji au kuongeza metadata.
- Inasaidia mawasiliano ya wengi-kwa-wengi.

Mstari wa mwisho wa huduma ya bus/kiungo ni:
```bash
https://<namespace>.servicebus.windows.net:443/
```
### Vipengele vya Juu

Vipengele vya juu ni:

- **Message Sessions**: Inahakikisha usindikaji wa FIFO na inasaidia mifumo ya ombi-jibu.
- **Auto-Forwarding**: Inahamisha ujumbe kati ya foleni au mada katika eneo moja.
- **Dead-Lettering**: Inakamata ujumbe ambao hauwezi kufikishwa kwa ajili ya mapitio.
- **Scheduled Delivery**: Inachelewesha usindikaji wa ujumbe kwa kazi za baadaye.
- **Message Deferral**: Inachelewesha upatikanaji wa ujumbe hadi iwe tayari.
- **Transactions**: Inakusanya operesheni katika utekelezaji wa atomic.
- **Filters & Actions**: Inatumia sheria kuchuja au kuongeza maelezo kwenye ujumbe.
- **Auto-Delete on Idle**: Inafuta foleni baada ya kutokuwa na shughuli (min: dakika 5).
- **Duplicate Detection**: Inatoa ujumbe wa nakala wakati wa kutuma tena.
- **Batch Deletion**: Inafuta kwa wingi ujumbe ambao umepita muda au si wa lazima.

### Authorization-Rule / SAS Policy

Sera za SAS zinaelezea ruhusa za ufikiaji kwa vitu vya Azure Service Bus (Jambo Muhimu Zaidi), foleni na mada. Kila sera ina vipengele vifuatavyo:

- **Permissions**: Sanduku za kuangalia kubaini viwango vya ufikiaji:
- Manage: Inatoa udhibiti kamili juu ya kitu, ikiwa ni pamoja na usanidi na usimamizi wa ruhusa.
- Send: Inaruhusu kutuma ujumbe kwa kitu.
- Listen: Inaruhusu kupokea ujumbe kutoka kwa kitu.
- **Primary and Secondary Keys**: Hizi ni funguo za kificho zinazotumika kutengeneza tokeni salama za kuthibitisha ufikiaji.
- **Primary and Secondary Connection Strings**: Nyuzi za muunganisho zilizopangwa awali ambazo zinajumuisha mwisho na funguo kwa matumizi rahisi katika programu.
- **SAS Policy ARM ID**: Njia ya Meneja Rasilimali ya Azure (ARM) kwa sera kwa ajili ya utambuzi wa kimaandishi.

Ni muhimu kutambua kwamba eneo lina sera moja ya SAS ambayo inaathiri kila kitu ndani yake, wakati foleni na mada zinaweza kuwa na sera zao za SAS za kibinafsi kwa udhibiti wa kina zaidi.

### "--disable-local-auth"

Parameta --disable-local-auth inatumika kudhibiti ikiwa uthibitishaji wa ndani (yaani, kutumia funguo za Shared Access Signature (SAS)) umewezeshwa kwa eneo lako la Service Bus. Hapa kuna unachohitaji kujua:

- Wakati imewekwa kuwa kweli: Uthibitishaji wa ndani kwa kutumia funguo za SAS umezimwa na uthibitishaji wa Azure Active Directory (Azure AD) unaruhusiwa.
- Wakati imewekwa kuwa uongo: Uthibitishaji wa SAS (wa ndani) na uthibitishaji wa Azure AD vinapatikana na unaweza kutumia nyuzi za muunganisho na funguo za SAS kufikia rasilimali zako za Service Bus.

### Enumeration

{{#tabs }}
{{#tab name="az cli" }}
```bash
# Namespace Enumeration
az servicebus namespace list
az servicebus namespace network-rule-set list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace show --resource-group <MyResourceGroup> --name <MyNamespace>
az servicebus namespace network-rule-set show --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace private-endpoint-connection list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace exists --name ProposedNamespace

# Authorization Rule Enumeration
az servicebus namespace authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --queue-name <MyQueue>
az servicebus topic authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus namespace authorization-rule keys list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyAuthRule>

# Get keys
az servicebus namespace authorization-rule keys list --resource-group <res-group> --namespace-name <namespace-name> [--authorization-rule-name RootManageSharedAccessKey]
az servicebus topic authorization-rule keys list --resource-group <res-group> --namespace-name <namespace-name> --topic-name <topic-name> --name <auth-rule-name>
az servicebus queue authorization-rule keys list --resource-group <res-group> --namespace-name <namespace-name> --queue-name <topic-name> --name <auth-rule-name>

# Queue Enumeration
az servicebus queue list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyQueue>

# Topic Enumeration
az servicebus topic list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus topic show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyTopic>

# Susbscription Enumeration
az servicebus topic subscription list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus topic subscription show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic> --name <MySubscription>
```
{{#endtab }}

{{#tab name="Az Powershell" }}
```powershell
Get-Command -Module Az.ServiceBus

# Retrieves details of a Service Bus namespace, including V2-specific features like additional metrics or configurations.
Get-AzServiceBusNamespaceV2 -ResourceGroupName <ResourceGroupName> -Name <NamespaceName>

# Retrieves the authorization rules for a Service Bus namespace, queue, or topic.
Get-AzServiceBusAuthorizationRule -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves the Geo-Disaster Recovery configuration for a Service Bus namespace, if it is enabled.
Get-AzServiceBusGeoDRConfiguration -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves the shared access keys for a specified authorization rule in a Service Bus namespace.
Get-AzServiceBusKey -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName> -Name <RuleName>

# Retrieves the migration state and details for a Service Bus namespace, if a migration is in progress.
Get-AzServiceBusMigration -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves properties and details about a Service Bus namespace.
Get-AzServiceBusNamespace -ResourceGroupName <ResourceGroupName> -Name <NamespaceName>

# Retrieves the network rule set for a Service Bus namespace, such as IP restrictions or virtual network access rules.
Get-AzServiceBusNetworkRuleSet -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves private endpoint connections for a Service Bus namespace.
Get-AzServiceBusPrivateEndpointConnection -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves private link resources associated with a Service Bus namespace.
Get-AzServiceBusPrivateLink -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves details of a specified queue in a Service Bus namespace.
Get-AzServiceBusQueue -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName> -Name <QueueName>

# Retrieves rules (filters and actions) for a subscription under a Service Bus topic.
Get-AzServiceBusRule -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName> -TopicName <TopicName> -SubscriptionName <SubscriptionName>

# Retrieves details of subscriptions for a specified Service Bus topic.
Get-AzServiceBusSubscription -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName> -TopicName <TopicName>

# Retrieves details of a specified topic in a Service Bus namespace.
Get-AzServiceBusTopic -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>
```
{{#endtab }}
{{#endtabs }}


### Kuinua Haki

{{#ref}}
../az-privilege-escalation/az-servicebus-privesc.md
{{#endref}}

### Baada ya Utekelezaji

{{#ref}}
../az-post-exploitation/az-servicebus-post-exploitation.md
{{#endref}}

## Marejeo

- [https://learn.microsoft.com/en-us/powershell/module/az.servicebus/?view=azps-13.0.0](https://learn.microsoft.com/en-us/powershell/module/az.servicebus/?view=azps-13.0.0)
- [https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview](https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview)
- [https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-cli](https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-cli)

{{#include ../../../banners/hacktricks-training.md}}
