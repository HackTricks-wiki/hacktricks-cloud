# Az - Service Bus Enum

{{#include ../../../banners/hacktricks-training.md}}

## Service Bus

Azure Service Bus ist ein cloudbasierter **Messaging-Dienst**, der entwickelt wurde, um eine zuverlässige **Kommunikation zwischen verschiedenen Teilen einer Anwendung oder separaten Anwendungen** zu ermöglichen. Er fungiert als sicherer Mittelsmann und stellt sicher, dass Nachrichten sicher zugestellt werden, selbst wenn Sender und Empfänger nicht gleichzeitig arbeiten. Durch die Entkopplung von Systemen ermöglicht es Anwendungen, unabhängig zu arbeiten und dennoch Daten oder Anweisungen auszutauschen. Es ist besonders nützlich für Szenarien, die Lastenausgleich über mehrere Arbeiter, zuverlässige Nachrichtenübermittlung oder komplexe Koordination erfordern, wie z.B. die Verarbeitung von Aufgaben in der richtigen Reihenfolge oder die sichere Verwaltung von Zugriffsrechten.

### Key Concepts

1. **Queues:** Ihr Zweck ist es, Nachrichten zu speichern, bis der Empfänger bereit ist.
- Nachrichten sind geordnet, zeitgestempelt und dauerhaft gespeichert.
- Werden im Pull-Modus (on-demand retrieval) geliefert.
- Unterstützt Punkt-zu-Punkt-Kommunikation.
2. **Topics:** Publish-Subscribe-Messaging für Broadcasts.
- Mehrere unabhängige Abonnements erhalten Kopien von Nachrichten.
- Abonnements können Regeln/Filter haben, um die Zustellung zu steuern oder Metadaten hinzuzufügen.
- Unterstützt Viele-zu-Viele-Kommunikation.
3. **Namespaces:** Ein Container für alle Messaging-Komponenten, Warteschlangen und Themen, ist wie Ihr eigener Teil eines leistungsstarken Azure-Clusters, der dedizierte Kapazität bietet und optional über drei Verfügbarkeitszonen hinweg reicht.

### Advance Features

Einige erweiterte Funktionen sind:

- **Message Sessions**: Stellt FIFO-Verarbeitung sicher und unterstützt Anfrage-Antwort-Muster.
- **Auto-Forwarding**: Überträgt Nachrichten zwischen Warteschlangen oder Themen im selben Namespace.
- **Dead-Lettering**: Erfasst nicht zustellbare Nachrichten zur Überprüfung.
- **Scheduled Delivery**: Verzögert die Nachrichtenverarbeitung für zukünftige Aufgaben.
- **Message Deferral**: Verschiebt die Nachrichtenabholung, bis sie bereit ist.
- **Transactions**: Gruppiert Operationen in atomare Ausführung.
- **Filters & Actions**: Wendet Regeln an, um Nachrichten zu filtern oder zu annotieren.
- **Auto-Delete on Idle**: Löscht Warteschlangen nach Inaktivität (min: 5 Minuten).
- **Duplicate Detection**: Entfernt doppelte Nachrichten während der erneuten Übertragung.
- **Batch Deletion**: Löscht im Bulk abgelaufene oder unnötige Nachrichten.

### Authorization-Rule / SAS Policy

SAS-Richtlinien definieren die Zugriffsberechtigungen für Azure Service Bus-Entitäten, Namespace (die wichtigste), Warteschlangen und Themen. Jede Richtlinie hat die folgenden Komponenten:

- **Permissions**: Kontrollkästchen zur Angabe von Zugriffslevels:
- Manage: Gewährt vollständige Kontrolle über die Entität, einschließlich Konfiguration und Berechtigungsmanagement.
- Send: Erlaubt das Senden von Nachrichten an die Entität.
- Listen: Erlaubt das Empfangen von Nachrichten von der Entität.
- **Primary and Secondary Keys**: Dies sind kryptografische Schlüssel, die zur Generierung sicherer Tokens für die Authentifizierung des Zugriffs verwendet werden.
- **Primary and Secondary Connection Strings**: Vorgefertigte Verbindungszeichenfolgen, die den Endpunkt und den Schlüssel für die einfache Verwendung in Anwendungen enthalten.
- **SAS Policy ARM ID**: Der Azure Resource Manager (ARM)-Pfad zur Richtlinie für die programmgesteuerte Identifizierung.

### NameSpace

sku, authrorization rule,

### Enumeration
```bash
# Queue Enumeration
az servicebus queue list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyQueue>

# Topic Enumeration
az servicebus topic list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus topic show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyTopic>

# Susbscription Enumeration
az servicebus topic subscription list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus topic subscription show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic> --name <MySubscription>

# Namespace Enumeration
az servicebus namespace list
az servicebus namespace network-rule-set list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace show --resource-group <MyResourceGroup> --name <MyNamespace>
az servicebus namespace network-rule-set show --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace private-endpoint-connection list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace exists --name ProposedNamespace

# Authorization Rule Enumeration
az servicebus namespace authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --queue-name <MyQueue>
az servicebus topic authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus namespace authorization-rule keys list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyAuthRule>
```
### Privilegieneskalation

{{#ref}}
../az-privilege-escalation/az-servicebus-privesc.md
{{#endref}}

### Nach der Ausnutzung

{{#ref}}
../az-post-exploitation/az-servicebus-post-exploitation.md
{{#endref}}

## Referenzen

- https://learn.microsoft.com/en-us/powershell/module/az.servicebus/?view=azps-13.0.0
- https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview
- https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-cli

{{#include ../../../banners/hacktricks-training.md}}
