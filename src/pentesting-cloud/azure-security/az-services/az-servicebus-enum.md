# Az - Service Bus Enum

{{#include ../../../banners/hacktricks-training.md}}

## Service Bus

Azure Service Bus ist ein cloudbasierter **Messaging-Dienst**, der entwickelt wurde, um eine zuverlässige **Kommunikation zwischen verschiedenen Teilen einer Anwendung oder separaten Anwendungen** zu ermöglichen. Er fungiert als sicherer Mittelsmann und stellt sicher, dass Nachrichten sicher zugestellt werden, selbst wenn Sender und Empfänger nicht gleichzeitig arbeiten. Durch die Entkopplung von Systemen ermöglicht er es Anwendungen, unabhängig zu arbeiten, während sie weiterhin Daten oder Anweisungen austauschen. Er ist besonders nützlich für Szenarien, die Lastverteilung über mehrere Arbeiter, zuverlässige Nachrichtenübermittlung oder komplexe Koordination erfordern, wie z.B. die Verarbeitung von Aufgaben in der richtigen Reihenfolge oder die sichere Verwaltung von Zugriffsrechten.

### Schlüsselkonzepte

1. **Warteschlangen:** Ihr Zweck ist es, Nachrichten zu speichern, bis der Empfänger bereit ist.
- Nachrichten sind geordnet, zeitgestempelt und dauerhaft gespeichert.
- Lieferung im Pull-Modus (abrufbasierte Bereitstellung).
- Unterstützt Punkt-zu-Punkt-Kommunikation.
2. **Themen:** Publish-Subscribe-Messaging für die Übertragung.
- Mehrere unabhängige Abonnements erhalten Kopien von Nachrichten.
- Abonnements können Regeln/Filter haben, um die Lieferung zu steuern oder Metadaten hinzuzufügen.
- Unterstützt Viele-zu-Viele-Kommunikation.
3. **Namespaces:** Ein Container für alle Messaging-Komponenten, Warteschlangen und Themen, ist wie Ihr eigener Teil eines leistungsstarken Azure-Clusters, der dedizierte Kapazität bietet und optional über drei Verfügbarkeitszonen hinweg reicht.

### Erweiterte Funktionen

Einige erweiterte Funktionen sind:

- **Nachrichtensitzungen**: Stellt FIFO-Verarbeitung sicher und unterstützt Anfrage-Antwort-Muster.
- **Automatische Weiterleitung**: Überträgt Nachrichten zwischen Warteschlangen oder Themen im selben Namespace.
- **Dead-Lettering**: Erfasst nicht zustellbare Nachrichten zur Überprüfung.
- **Geplante Lieferung**: Verzögert die Nachrichtenverarbeitung für zukünftige Aufgaben.
- **Nachrichtenaussetzung**: Verschiebt den Abruf von Nachrichten, bis sie bereit sind.
- **Transaktionen**: Gruppiert Operationen in atomare Ausführung.
- **Filter & Aktionen**: Wendet Regeln an, um Nachrichten zu filtern oder zu annotieren.
- **Automatische Löschung bei Inaktivität**: Löscht Warteschlangen nach Inaktivität (min: 5 Minuten).
- **Duplikaterkennung**: Entfernt doppelte Nachrichten während der erneuten Übertragung.
- **Batch-Löschung**: Löscht abgelaufene oder unnötige Nachrichten in großen Mengen.

### Autorisierungsregel / SAS-Richtlinie

SAS-Richtlinien definieren die Zugriffsberechtigungen für Azure Service Bus-Entitäten, Namespace (die wichtigste), Warteschlangen und Themen. Jede Richtlinie hat die folgenden Komponenten:

- **Berechtigungen**: Kontrollkästchen zur Angabe von Zugriffslevels:
- Verwalten: Gewährt vollständige Kontrolle über die Entität, einschließlich Konfiguration und Berechtigungsmanagement.
- Senden: Erlaubt das Senden von Nachrichten an die Entität.
- Anhören: Erlaubt das Empfangen von Nachrichten von der Entität.
- **Primäre und sekundäre Schlüssel**: Dies sind kryptografische Schlüssel, die zur Generierung sicherer Tokens für die Authentifizierung des Zugriffs verwendet werden.
- **Primäre und sekundäre Verbindungszeichenfolgen**: Vorgefertigte Verbindungszeichenfolgen, die den Endpunkt und den Schlüssel für die einfache Verwendung in Anwendungen enthalten.
- **SAS-Richtlinien-ARM-ID**: Der Azure Resource Manager (ARM)-Pfad zur Richtlinie für die programmgesteuerte Identifizierung.

### Namespace

sku, autorisierungsregel,

### Enumeration
```bash
# Queue Enumeration
az servicebus queue list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyQueue>

# Topic Enumeration
az servicebus topic list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus topic show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyTopic>

# Susbscription Enumeration
az servicebus topic subscription list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus topic subscription show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic> --name <MySubscription>

# Namespace Enumeration
az servicebus namespace list
az servicebus namespace network-rule-set list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace show --resource-group <MyResourceGroup> --name <MyNamespace>
az servicebus namespace network-rule-set show --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace private-endpoint-connection list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace exists --name ProposedNamespace

# Authorization Rule Enumeration
az servicebus namespace authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --queue-name <MyQueue>
az servicebus topic authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus namespace authorization-rule keys list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyAuthRule>
```
### Privilegienerweiterung

{{#ref}}
../az-privilege-escalation/az-servicebus-privesc.md
{{#endref}}

### Nach der Ausnutzung

{{#ref}}
../az-post-exploitation/az-servicebus-post-exploitation.md
{{#endref}}

## Referenzen

- https://learn.microsoft.com/en-us/powershell/module/az.servicebus/?view=azps-13.0.0
- https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview
- https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-cli

{{#include ../../../banners/hacktricks-training.md}}
