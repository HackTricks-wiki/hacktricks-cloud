# Az - Service Bus Enum

{{#include ../../../banners/hacktricks-training.md}}

## Service Bus

Azure Service Bus es un **servicio de mensajería** basado en la nube diseñado para habilitar una **comunicación confiable entre diferentes partes de una aplicación o aplicaciones separadas**. Actúa como un intermediario seguro, asegurando que los mensajes se entreguen de manera segura, incluso si el remitente y el receptor no están operando simultáneamente. Al desacoplar sistemas, permite que las aplicaciones funcionen de manera independiente mientras aún intercambian datos o instrucciones. Es particularmente útil para escenarios que requieren balanceo de carga entre múltiples trabajadores, entrega confiable de mensajes o coordinación compleja, como procesar tareas en orden o gestionar el acceso de manera segura.

### Key Concepts

1. **Namespaces:** Un namespace en sistemas de mensajería es un contenedor lógico que organiza y gestiona componentes de mensajería, colas y temas. Proporciona un entorno aislado donde las aplicaciones pueden enviar, recibir y procesar mensajes. Las colas y los temas comparten la misma infraestructura y configuración dentro de un namespace de Service Bus, pero operan de manera independiente sin interactuar entre sí.
2. **Queues:** su propósito es almacenar mensajes hasta que el receptor esté listo.
- Los mensajes están ordenados, tienen marca de tiempo y se almacenan de manera duradera.
- Se entregan en modo de extracción (recuperación bajo demanda).
- Soporta comunicación punto a punto.
3. **Topics:** Mensajería de publicación-suscripción para difusión.
- Múltiples suscripciones independientes reciben copias de los mensajes.
- Las suscripciones pueden tener reglas/filtros para controlar la entrega o agregar metadatos.
- Soporta comunicación de muchos a muchos.

La cadena de conexión/punto final del service bus es:
```bash
https://<namespace>.servicebus.windows.net:443/
```
### Características Avanzadas

Algunas características avanzadas son:

- **Message Sessions**: Asegura el procesamiento FIFO y soporta patrones de solicitud-respuesta.
- **Auto-Forwarding**: Transfiere mensajes entre colas o temas en el mismo espacio de nombres.
- **Dead-Lettering**: Captura mensajes no entregables para revisión.
- **Scheduled Delivery**: Retrasa el procesamiento de mensajes para tareas futuras.
- **Message Deferral**: Pospone la recuperación de mensajes hasta que esté listo.
- **Transactions**: Agrupa operaciones en ejecución atómica.
- **Filters & Actions**: Aplica reglas para filtrar o anotar mensajes.
- **Auto-Delete on Idle**: Elimina colas después de inactividad (mín: 5 minutos).
- **Duplicate Detection**: Elimina mensajes duplicados durante reenvíos.
- **Batch Deletion**: Elimina en bloque mensajes expirados o innecesarios.

### Regla de Autorización / Política SAS

Las Políticas SAS definen los permisos de acceso para las entidades del espacio de nombres de Azure Service Bus (la más importante), colas y temas. Cada política tiene los siguientes componentes:

- **Permissions**: Casillas de verificación para especificar niveles de acceso:
- Manage: Concede control total sobre la entidad, incluyendo la configuración y gestión de permisos.
- Send: Permite enviar mensajes a la entidad.
- Listen: Permite recibir mensajes de la entidad.
- **Primary and Secondary Keys**: Estas son claves criptográficas utilizadas para generar tokens seguros para autenticar el acceso.
- **Primary and Secondary Connection Strings**: Cadenas de conexión preconfiguradas que incluyen el punto final y la clave para un uso fácil en aplicaciones.
- **SAS Policy ARM ID**: La ruta del Administrador de Recursos de Azure (ARM) a la política para identificación programática.

Es importante notar que un espacio de nombres tiene una única política SAS que afecta a cada entidad dentro de él, mientras que las colas y temas pueden tener sus propias políticas SAS individuales para un control más granular.

### "--disable-local-auth"

El parámetro --disable-local-auth se utiliza para controlar si la autenticación local (es decir, usando claves de Firma de Acceso Compartido (SAS)) está habilitada para su espacio de nombres de Service Bus. Aquí está lo que necesita saber:

- Cuando se establece en verdadero: La autenticación local usando claves SAS está deshabilitada y se permite la autenticación de Azure Active Directory (Azure AD).
- Cuando se establece en falso: Tanto la autenticación SAS (local) como la autenticación de Azure AD están disponibles y puede usar cadenas de conexión con claves SAS para acceder a sus recursos de Service Bus.

### Enumeración

{{#tabs }}
{{#tab name="az cli" }}
```bash
# Namespace Enumeration
az servicebus namespace list
az servicebus namespace network-rule-set list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace show --resource-group <MyResourceGroup> --name <MyNamespace>
az servicebus namespace network-rule-set show --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace private-endpoint-connection list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace exists --name ProposedNamespace

# Authorization Rule Enumeration
az servicebus namespace authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --queue-name <MyQueue>
az servicebus topic authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus namespace authorization-rule keys list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyAuthRule>

# Get keys
az servicebus namespace authorization-rule keys list --resource-group <res-group> --namespace-name <namespace-name> [--authorization-rule-name RootManageSharedAccessKey]
az servicebus topic authorization-rule keys list --resource-group <res-group> --namespace-name <namespace-name> --topic-name <topic-name> --name <auth-rule-name>
az servicebus queue authorization-rule keys list --resource-group <res-group> --namespace-name <namespace-name> --queue-name <topic-name> --name <auth-rule-name>

# Queue Enumeration
az servicebus queue list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyQueue>

# Topic Enumeration
az servicebus topic list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus topic show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyTopic>

# Susbscription Enumeration
az servicebus topic subscription list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus topic subscription show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic> --name <MySubscription>
```
{{#endtab }}

{{#tab name="Az Powershell" }}
```powershell
Get-Command -Module Az.ServiceBus

# Retrieves details of a Service Bus namespace, including V2-specific features like additional metrics or configurations.
Get-AzServiceBusNamespaceV2 -ResourceGroupName <ResourceGroupName> -Name <NamespaceName>

# Retrieves the authorization rules for a Service Bus namespace, queue, or topic.
Get-AzServiceBusAuthorizationRule -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves the Geo-Disaster Recovery configuration for a Service Bus namespace, if it is enabled.
Get-AzServiceBusGeoDRConfiguration -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves the shared access keys for a specified authorization rule in a Service Bus namespace.
Get-AzServiceBusKey -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName> -Name <RuleName>

# Retrieves the migration state and details for a Service Bus namespace, if a migration is in progress.
Get-AzServiceBusMigration -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves properties and details about a Service Bus namespace.
Get-AzServiceBusNamespace -ResourceGroupName <ResourceGroupName> -Name <NamespaceName>

# Retrieves the network rule set for a Service Bus namespace, such as IP restrictions or virtual network access rules.
Get-AzServiceBusNetworkRuleSet -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves private endpoint connections for a Service Bus namespace.
Get-AzServiceBusPrivateEndpointConnection -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves private link resources associated with a Service Bus namespace.
Get-AzServiceBusPrivateLink -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves details of a specified queue in a Service Bus namespace.
Get-AzServiceBusQueue -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName> -Name <QueueName>

# Retrieves rules (filters and actions) for a subscription under a Service Bus topic.
Get-AzServiceBusRule -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName> -TopicName <TopicName> -SubscriptionName <SubscriptionName>

# Retrieves details of subscriptions for a specified Service Bus topic.
Get-AzServiceBusSubscription -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName> -TopicName <TopicName>

# Retrieves details of a specified topic in a Service Bus namespace.
Get-AzServiceBusTopic -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>
```
{{#endtab }}
{{#endtabs }}


### Escalación de Privilegios

{{#ref}}
../az-privilege-escalation/az-servicebus-privesc.md
{{#endref}}

### Post Explotación

{{#ref}}
../az-post-exploitation/az-servicebus-post-exploitation.md
{{#endref}}

## Referencias

- [https://learn.microsoft.com/en-us/powershell/module/az.servicebus/?view=azps-13.0.0](https://learn.microsoft.com/en-us/powershell/module/az.servicebus/?view=azps-13.0.0)
- [https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview](https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview)
- [https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-cli](https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-cli)

{{#include ../../../banners/hacktricks-training.md}}
