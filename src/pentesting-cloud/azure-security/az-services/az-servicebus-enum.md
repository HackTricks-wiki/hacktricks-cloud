# Az - Service Bus Enum

{{#include ../../../banners/hacktricks-training.md}}

## Service Bus

Το Azure Service Bus είναι μια υπηρεσία **μηνυμάτων** που βασίζεται στο cloud, σχεδιασμένη για να επιτρέπει αξιόπιστη **επικοινωνία μεταξύ διαφορετικών τμημάτων μιας εφαρμογής ή ξεχωριστών εφαρμογών**. Λειτουργεί ως ασφαλής μεσάζων, διασφαλίζοντας ότι τα μηνύματα παραδίδονται με ασφάλεια, ακόμη και αν ο αποστολέας και ο παραλήπτης δεν λειτουργούν ταυτόχρονα. Αποσυνδέοντας τα συστήματα, επιτρέπει στις εφαρμογές να λειτουργούν ανεξάρτητα ενώ εξακολουθούν να ανταλλάσσουν δεδομένα ή οδηγίες. Είναι ιδιαίτερα χρήσιμο για σενάρια που απαιτούν κατανομή φορτίου σε πολλούς εργαζόμενους, αξιόπιστη παράδοση μηνυμάτων ή πολύπλοκο συντονισμό, όπως η επεξεργασία εργασιών με σειρά ή η ασφαλής διαχείριση πρόσβασης.

### Key Concepts

1. **Queues:** ο σκοπός του είναι να αποθηκεύει μηνύματα μέχρι να είναι έτοιμος ο παραλήπτης.
- Τα μηνύματα είναι διατεταγμένα, χρονοσημασμένα και αποθηκεύονται με ανθεκτικότητα.
- Παραδίδονται σε λειτουργία pull (ανάκτηση κατόπιν αιτήματος).
- Υποστηρίζει επικοινωνία σημείου προς σημείο.
2. **Topics:** Μηχανισμός δημοσίευσης-εγγραφής για μετάδοση.
- Πολλές ανεξάρτητες συνδρομές λαμβάνουν αντίγραφα μηνυμάτων.
- Οι συνδρομές μπορούν να έχουν κανόνες/φίλτρα για τον έλεγχο της παράδοσης ή την προσθήκη μεταδεδομένων.
- Υποστηρίζει επικοινωνία πολλών προς πολλούς.
3. **Namespaces:** Ένας κάδος για όλα τα συστατικά μηνυμάτων, ουρές και θέματα, είναι σαν το δικό σας κομμάτι ενός ισχυρού Azure cluster, παρέχοντας αφιερωμένη χωρητικότητα και προαιρετικά εκτείνοντας σε τρεις ζώνες διαθεσιμότητας.

### Advance Features

Ορισμένες προηγμένες δυνατότητες είναι:

- **Message Sessions**: Διασφαλίζει την επεξεργασία FIFO και υποστηρίζει πρότυπα αιτήματος-απάντησης.
- **Auto-Forwarding**: Μεταφέρει μηνύματα μεταξύ ουρών ή θεμάτων στην ίδια ζώνη ονομάτων.
- **Dead-Lettering**: Καταγράφει τα μη παραδιδόμενα μηνύματα για ανασκόπηση.
- **Scheduled Delivery**: Καθυστερεί την επεξεργασία μηνυμάτων για μελλοντικές εργασίες.
- **Message Deferral**: Αναβάλλει την ανάκτηση μηνυμάτων μέχρι να είναι έτοιμα.
- **Transactions**: Ομαδοποιεί τις λειτουργίες σε ατομική εκτέλεση.
- **Filters & Actions**: Εφαρμόζει κανόνες για να φιλτράρει ή να σχολιάσει μηνύματα.
- **Auto-Delete on Idle**: Διαγράφει τις ουρές μετά από αδράνεια (ελάχιστο: 5 λεπτά).
- **Duplicate Detection**: Αφαιρεί τα διπλά μηνύματα κατά την επαναποστολή.
- **Batch Deletion**: Μαζική διαγραφή ληγμένων ή περιττών μηνυμάτων.

### Authorization-Rule / SAS Policy

Οι πολιτικές SAS καθορίζουν τα δικαιώματα πρόσβασης για τις οντότητες του Azure Service Bus namespace (Το πιο σημαντικό), τις ουρές και τα θέματα. Κάθε πολιτική έχει τα εξής στοιχεία:

- **Permissions**: Επιλογές για να καθορίσετε τα επίπεδα πρόσβασης:
- Manage: Παρέχει πλήρη έλεγχο της οντότητας, συμπεριλαμβανομένης της διαχείρισης ρυθμίσεων και δικαιωμάτων.
- Send: Επιτρέπει την αποστολή μηνυμάτων στην οντότητα.
- Listen: Επιτρέπει την λήψη μηνυμάτων από την οντότητα.
- **Primary and Secondary Keys**: Αυτά είναι κρυπτογραφικά κλειδιά που χρησιμοποιούνται για τη δημιουργία ασφαλών tokens για την αυθεντικοποίηση πρόσβασης.
- **Primary and Secondary Connection Strings**: Προρυθμισμένες συμβολοσειρές σύνδεσης που περιλαμβάνουν το endpoint και το κλειδί για εύκολη χρήση σε εφαρμογές.
- **SAS Policy ARM ID**: Η διαδρομή Azure Resource Manager (ARM) προς την πολιτική για προγραμματιστική αναγνώριση.

### NameSpace

sku, authrorization rule,

### Enumeration

{{#tabs }}
{{#tab name="az cli" }}
```bash
# Namespace Enumeration
az servicebus namespace list
az servicebus namespace network-rule-set list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace show --resource-group <MyResourceGroup> --name <MyNamespace>
az servicebus namespace network-rule-set show --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace private-endpoint-connection list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace exists --name ProposedNamespace

# Authorization Rule Enumeration
az servicebus namespace authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --queue-name <MyQueue>
az servicebus topic authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus namespace authorization-rule keys list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyAuthRule>

# Get keys
az servicebus namespace authorization-rule keys list --resource-group <res-group> --namespace-name <namespace-name> [--authorization-rule-name RootManageSharedAccessKey]
az servicebus topic authorization-rule keys list --resource-group <res-group> --namespace-name <namespace-name> --topic-name <topic-name> --name <auth-rule-name>
az servicebus queue authorization-rule keys list --resource-group <res-group> --namespace-name <namespace-name> --queue-name <topic-name> --name <auth-rule-name>

# Queue Enumeration
az servicebus queue list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyQueue>

# Topic Enumeration
az servicebus topic list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus topic show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyTopic>

# Susbscription Enumeration
az servicebus topic subscription list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus topic subscription show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic> --name <MySubscription>
```
{{#endtab }}

{{#tab name="Az Powershell" }}
```powershell
Get-Command -Module Az.ServiceBus

# Retrieves details of a Service Bus namespace, including V2-specific features like additional metrics or configurations.
Get-AzServiceBusNamespaceV2 -ResourceGroupName <ResourceGroupName> -Name <NamespaceName>

# Retrieves the authorization rules for a Service Bus namespace, queue, or topic.
Get-AzServiceBusAuthorizationRule -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves the Geo-Disaster Recovery configuration for a Service Bus namespace, if it is enabled.
Get-AzServiceBusGeoDRConfiguration -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves the shared access keys for a specified authorization rule in a Service Bus namespace.
Get-AzServiceBusKey -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName> -Name <RuleName>

# Retrieves the migration state and details for a Service Bus namespace, if a migration is in progress.
Get-AzServiceBusMigration -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves properties and details about a Service Bus namespace.
Get-AzServiceBusNamespace -ResourceGroupName <ResourceGroupName> -Name <NamespaceName>

# Retrieves the network rule set for a Service Bus namespace, such as IP restrictions or virtual network access rules.
Get-AzServiceBusNetworkRuleSet -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves private endpoint connections for a Service Bus namespace.
Get-AzServiceBusPrivateEndpointConnection -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves private link resources associated with a Service Bus namespace.
Get-AzServiceBusPrivateLink -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>

# Retrieves details of a specified queue in a Service Bus namespace.
Get-AzServiceBusQueue -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName> -Name <QueueName>

# Retrieves rules (filters and actions) for a subscription under a Service Bus topic.
Get-AzServiceBusRule -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName> -TopicName <TopicName> -SubscriptionName <SubscriptionName>

# Retrieves details of subscriptions for a specified Service Bus topic.
Get-AzServiceBusSubscription -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName> -TopicName <TopicName>

# Retrieves details of a specified topic in a Service Bus namespace.
Get-AzServiceBusTopic -ResourceGroupName <ResourceGroupName> -NamespaceName <NamespaceName>
```
{{#endtab }}
{{#endtabs }}


### Ανύψωση Δικαιωμάτων

{{#ref}}
../az-privilege-escalation/az-servicebus-privesc.md
{{#endref}}

### Μετά την Εκμετάλλευση

{{#ref}}
../az-post-exploitation/az-servicebus-post-exploitation.md
{{#endref}}

## Αναφορές

- [https://learn.microsoft.com/en-us/powershell/module/az.servicebus/?view=azps-13.0.0](https://learn.microsoft.com/en-us/powershell/module/az.servicebus/?view=azps-13.0.0)
- [https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview](https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview)
- [https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-cli](https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-cli)

{{#include ../../../banners/hacktricks-training.md}}
