# Az - Application Proxy

{{#include ../../../banners/hacktricks-training.md}}

## 基本信息

[来自文档:](https://learn.microsoft.com/en-us/entra/identity/app-proxy/application-proxy)

Azure Active Directory 的 Application Proxy 提供 **对本地 web 应用程序的安全远程访问**。在 **单点登录到 Azure AD** 后，用户可以通过 **外部 URL** 或内部应用程序门户访问 **云** 和 **本地应用程序**。

其工作原理如下：

<figure><img src="../../../images/image (186).png" alt=""><figcaption></figcaption></figure>

1. 用户通过端点访问应用程序后，用户会被引导到 **Azure AD 登录页面**。
2. 在 **成功登录** 后，Azure AD 将 **令牌** 发送到用户的客户端设备。
3. 客户端将令牌发送到 **Application Proxy 服务**，该服务从令牌中检索用户主体名称 (UPN) 和安全主体名称 (SPN)。**Application Proxy 然后将请求发送到 Application Proxy 连接器**。
4. 如果您已配置单点登录，连接器将代表用户执行任何 **额外的身份验证**。
5. 连接器将请求发送到 **本地应用程序**。
6. **响应** 通过连接器和 Application Proxy 服务 **发送给用户**。

## 枚举
```powershell
# Enumerate applications with application proxy configured
Get-AzureADApplication | %{try{Get-AzureADApplicationProxyApplication -ObjectId $_.ObjectID;$_.DisplayName;$_.ObjectID}catch{}}

# Get applications service principal
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -eq "Name"}

# Use the following ps1 script from https://learn.microsoft.com/en-us/azure/active-directory/app-proxy/scripts/powershell-display-users-group-of-app
# to find users and groups assigned to the application. Pass the ObjectID of the Service Principal to it
Get-ApplicationProxyAssignedUsersAndGroups -ObjectId <object-id>
```
## 参考

- [https://learn.microsoft.com/en-us/azure/active-directory/app-proxy/application-proxy](https://learn.microsoft.com/en-us/azure/active-directory/app-proxy/application-proxy)

{{#include ../../../banners/hacktricks-training.md}}
