# Az - Lateral Movement (Cloud - On-Prem)

## Az - Lateral Movement (Cloud - On-Prem)

{{#include ../../../banners/hacktricks-training.md}}

### Mashine za On-Prem zilizounganishwa na wingu

Kuna njia tofauti ambazo mashine zinaweza kuunganishwa na wingu:

#### Azure AD iliyojiunga

<figure><img src="../../../images/image (259).png" alt=""><figcaption></figcaption></figure>

#### Iliyojiunga na Mahali

<figure><img src="../../../images/image (222).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Iliyojiunga kwa Mchanganyiko

<figure><img src="../../../images/image (178).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Iliyojiunga na Mahali kwenye AADJ au Mchanganyiko

<figure><img src="../../../images/image (252).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

### Tokens na mipaka <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

Katika Azure AD, kuna aina tofauti za tokens zenye mipaka maalum:

- **Access tokens**: Zinatumika kupata APIs na rasilimali kama Microsoft Graph. Zimefungwa kwa mteja na rasilimali maalum.
- **Refresh tokens**: Zinatolewa kwa programu ili kupata access tokens mpya. Zinapaswa kutumiwa tu na programu ambazo zilitolewa au kundi la programu.
- **Primary Refresh Tokens (PRT)**: Zinatumika kwa Usajili wa Moja kwa Moja kwenye vifaa vilivyojiunga na Azure AD, vilivyosajiliwa, au vilivyojiunga kwa mchanganyiko. Zinatumika katika michakato ya kuingia kwenye kivinjari na kwa kuingia kwenye programu za simu na desktop kwenye kifaa.
- **Windows Hello for Business keys (WHFB)**: Zinatumika kwa uthibitisho bila nenosiri. Zinatumika kupata Primary Refresh Tokens.

Aina ya token inayovutia zaidi ni Primary Refresh Token (PRT).

{{#ref}}
az-primary-refresh-token-prt.md
{{#endref}}

### Mbinu za Pivoting

Kutoka kwenye **mashine iliyoathiriwa hadi wingu**:

- [**Pass the Cookie**](az-pass-the-cookie.md): Nyakua cookies za Azure kutoka kwenye kivinjari na uzitumie kuingia
- [**Dump processes access tokens**](az-processes-memory-access-token.md): Dump kumbukumbu za michakato ya ndani iliyo sambamba na wingu (kama excel, Teams...) na pata access tokens kwa maandiko wazi.
- [**Phishing Primary Refresh Token**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** Phish PRT ili kuikandamiza
- [**Pass the PRT**](pass-the-prt.md): Nyakua PRT ya kifaa ili kupata Azure kwa kujifanya kuwa hicho kifaa.
- [**Pass the Certificate**](az-pass-the-certificate.md)**:** Tengeneza cheti kulingana na PRT ili kuingia kutoka mashine moja hadi nyingine

Kutoka kwenye kuathiri **AD** hadi kuathiri **Wingu** na kutoka kwenye kuathiri **Wingu hadi** kuathiri **AD**:

- [**Azure AD Connect**](azure-ad-connect-hybrid-identity/)
- **Njia nyingine ya pivot kutoka wingu hadi On-Prem ni** [**kuabudu Intune**](../az-services/intune.md)

#### [Roadtx](https://github.com/dirkjanm/ROADtools)

Zana hii inaruhusu kufanya vitendo kadhaa kama kujiandikisha mashine katika Azure AD ili kupata PRT, na kutumia PRTs (halali au zilizonyakuliwa) kupata rasilimali kwa njia tofauti. Hizi si mashambulizi ya moja kwa moja, lakini inarahisisha matumizi ya PRTs kupata rasilimali kwa njia tofauti. Pata maelezo zaidi katika [https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)

## Marejeo

- [https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

{{#include ../../../banners/hacktricks-training.md}}
