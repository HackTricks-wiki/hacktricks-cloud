# Az - Mouvement Latéral (Cloud - Sur Site)

## Az - Mouvement Latéral (Cloud - Sur Site)

{{#include ../../../banners/hacktricks-training.md}}

### Machines sur site connectées au cloud

Il existe différentes manières pour qu'une machine soit connectée au cloud :

#### Azure AD joint

<figure><img src="../../../images/image (259).png" alt=""><figcaption></figcaption></figure>

#### Joint au lieu de travail

<figure><img src="../../../images/image (222).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Joint hybride

<figure><img src="../../../images/image (178).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Joint au lieu de travail sur AADJ ou hybride

<figure><img src="../../../images/image (252).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

### Jetons et limitations <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

Dans Azure AD, il existe différents types de jetons avec des limitations spécifiques :

- **Jetons d'accès** : Utilisés pour accéder aux API et aux ressources comme Microsoft Graph. Ils sont liés à un client et une ressource spécifiques.
- **Jetons de rafraîchissement** : Délivrés aux applications pour obtenir de nouveaux jetons d'accès. Ils ne peuvent être utilisés que par l'application à laquelle ils ont été délivrés ou un groupe d'applications.
- **Jetons de rafraîchissement principaux (PRT)** : Utilisés pour l'authentification unique sur les appareils joints à Azure AD, enregistrés ou joints de manière hybride. Ils peuvent être utilisés dans les flux de connexion par navigateur et pour se connecter à des applications mobiles et de bureau sur l'appareil.
- **Clés Windows Hello for Business (WHFB)** : Utilisées pour l'authentification sans mot de passe. Elles sont utilisées pour obtenir des jetons de rafraîchissement principaux.

Le type de jeton le plus intéressant est le jeton de rafraîchissement principal (PRT).

{{#ref}}
az-primary-refresh-token-prt.md
{{#endref}}

### Techniques de Pivotement

Depuis la **machine compromise vers le cloud** :

- [**Pass the Cookie**](az-pass-the-cookie.md) : Voler les cookies Azure du navigateur et les utiliser pour se connecter
- [**Dump processes access tokens**](az-processes-memory-access-token.md) : Dump la mémoire des processus locaux synchronisés avec le cloud (comme excel, Teams...) et trouver des jetons d'accès en texte clair.
- [**Phishing Primary Refresh Token**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** Phisher le PRT pour en abuser
- [**Pass the PRT**](pass-the-prt.md) : Voler le PRT de l'appareil pour accéder à Azure en l'usurpant.
- [**Pass the Certificate**](az-pass-the-certificate.md)**:** Générer un certificat basé sur le PRT pour se connecter d'une machine à une autre

Depuis la compromission de **AD** vers la compromission du **Cloud** et depuis la compromission du **Cloud** vers la compromission de **AD** :

- [**Azure AD Connect**](azure-ad-connect-hybrid-identity/)
- **Une autre façon de pivoter du cloud vers sur site est** [**d'abuser d'Intune**](../az-services/intune.md)

#### [Roadtx](https://github.com/dirkjanm/ROADtools)

Cet outil permet d'effectuer plusieurs actions comme enregistrer une machine dans Azure AD pour obtenir un PRT, et utiliser des PRT (légitimes ou volés) pour accéder à des ressources de plusieurs manières différentes. Ce ne sont pas des attaques directes, mais cela facilite l'utilisation des PRT pour accéder à des ressources de différentes manières. Trouvez plus d'infos sur [https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)

## Références

- [https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

{{#include ../../../banners/hacktricks-training.md}}
