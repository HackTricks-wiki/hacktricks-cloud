# Az - Lateral Movement (Cloud - On-Prem)

## Az - Lateral Movement (Cloud - On-Prem)

{{#include ../../../banners/hacktricks-training.md}}

### クラウドに接続されたオンプレミスのマシン

マシンがクラウドに接続される方法はいくつかあります：

#### Azure AD に参加

<figure><img src="../../../images/image (259).png" alt=""><figcaption></figcaption></figure>

#### Workplace に参加

<figure><img src="../../../images/image (222).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### ハイブリッド参加

<figure><img src="../../../images/image (178).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### AADJ またはハイブリッドでの Workplace 参加

<figure><img src="../../../images/image (252).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

### トークンと制限 <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

Azure AD には、特定の制限を持つさまざまなタイプのトークンがあります：

- **アクセストークン**：Microsoft Graph のような API やリソースにアクセスするために使用されます。特定のクライアントとリソースに結びついています。
- **リフレッシュトークン**：新しいアクセストークンを取得するためにアプリケーションに発行されます。発行されたアプリケーションまたはアプリケーションのグループによってのみ使用できます。
- **プライマリリフレッシュトークン (PRT)**：Azure AD に参加した、登録された、またはハイブリッド参加したデバイスでのシングルサインオンに使用されます。ブラウザのサインインフローや、デバイス上のモバイルおよびデスクトップアプリケーションへのサインインに使用できます。
- **Windows Hello for Business キー (WHFB)**：パスワードなしの認証に使用されます。プライマリリフレッシュトークンを取得するために使用されます。

最も興味深いタイプのトークンはプライマリリフレッシュトークン (PRT) です。

{{#ref}}
az-primary-refresh-token-prt.md
{{#endref}}

### ピボッティング技術

**侵害されたマシンからクラウドへ**：

- [**Pass the Cookie**](az-pass-the-cookie.md)：ブラウザから Azure クッキーを盗み、それを使用してログイン
- [**Dump processes access tokens**](az-processes-memory-access-token.md)：クラウドと同期されたローカルプロセスのメモリをダンプし（Excel、Teams など）、クリアテキストのアクセストークンを見つける。
- [**Phishing Primary Refresh Token**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** PRT をフィッシングして悪用する
- [**Pass the PRT**](pass-the-prt.md)：デバイスの PRT を盗んで Azure にアクセスする
- [**Pass the Certificate**](az-pass-the-certificate.md)**:** PRT に基づいて証明書を生成し、1 台のマシンから別のマシンにログインする

**AD からクラウドへの侵害、クラウドから AD への侵害**：

- [**Azure AD Connect**](azure-ad-connect-hybrid-identity/)
- **クラウドからオンプレミスにピボットする別の方法は** [**Intune の悪用**](../az-services/intune.md)です。

#### [Roadtx](https://github.com/dirkjanm/ROADtools)

このツールは、Azure AD にマシンを登録して PRT を取得し、PRT（正当または盗まれた）を使用してさまざまな方法でリソースにアクセスするなど、いくつかのアクションを実行することを可能にします。これらは直接的な攻撃ではありませんが、PRT を使用してさまざまな方法でリソースにアクセスするのを容易にします。詳細は [https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/) を参照してください。

## 参考文献

- [https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

{{#include ../../../banners/hacktricks-training.md}}
