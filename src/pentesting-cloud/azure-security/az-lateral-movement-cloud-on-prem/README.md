# Az - Lateral Movement (Cloud - On-Prem)

## Az - Lateral Movement (Cloud - On-Prem)

{{#include ../../../banners/hacktricks-training.md}}

### On-Prem μηχανές συνδεδεμένες στο cloud

Υπάρχουν διάφοροι τρόποι με τους οποίους μια μηχανή μπορεί να είναι συνδεδεμένη στο cloud:

#### Azure AD joined

<figure><img src="../../../images/image (259).png" alt=""><figcaption></figcaption></figure>

#### Workplace joined

<figure><img src="../../../images/image (222).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Hybrid joined

<figure><img src="../../../images/image (178).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Workplace joined σε AADJ ή Hybrid

<figure><img src="../../../images/image (252).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

### Tokens και περιορισμοί <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

Στο Azure AD, υπάρχουν διάφοροι τύποι tokens με συγκεκριμένους περιορισμούς:

- **Access tokens**: Χρησιμοποιούνται για την πρόσβαση σε APIs και πόρους όπως το Microsoft Graph. Είναι συνδεδεμένα με έναν συγκεκριμένο πελάτη και πόρο.
- **Refresh tokens**: Εκδίδονται σε εφαρμογές για να αποκτούν νέα access tokens. Μπορούν να χρησιμοποιηθούν μόνο από την εφαρμογή στην οποία εκδόθηκαν ή από μια ομάδα εφαρμογών.
- **Primary Refresh Tokens (PRT)**: Χρησιμοποιούνται για Single Sign-On σε Azure AD joined, registered ή hybrid joined συσκευές. Μπορούν να χρησιμοποιηθούν σε ροές σύνδεσης μέσω προγράμματος περιήγησης και για σύνδεση σε εφαρμογές κινητών και επιτραπέζιων υπολογιστών στη συσκευή.
- **Windows Hello for Business keys (WHFB)**: Χρησιμοποιούνται για αυθεντικοποίηση χωρίς κωδικό. Χρησιμοποιούνται για την απόκτηση Primary Refresh Tokens.

Ο πιο ενδιαφέρον τύπος token είναι το Primary Refresh Token (PRT).

{{#ref}}
az-primary-refresh-token-prt.md
{{#endref}}

### Τεχνικές Pivoting

Από τη **συμβιβασμένη μηχανή στο cloud**:

- [**Pass the Cookie**](az-pass-the-cookie.md): Κλέψε Azure cookies από τον περιηγητή και χρησιμοποίησέ τα για σύνδεση
- [**Dump processes access tokens**](az-processes-memory-access-token.md): Dump τη μνήμη τοπικών διαδικασιών συγχρονισμένων με το cloud (όπως excel, Teams...) και βρες access tokens σε καθαρό κείμενο.
- [**Phishing Primary Refresh Token**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** Phish το PRT για να το καταχραστείς
- [**Pass the PRT**](pass-the-prt.md): Κλέψε το PRT της συσκευής για να αποκτήσεις πρόσβαση στο Azure προσποιούμενος ότι είναι αυτή.
- [**Pass the Certificate**](az-pass-the-certificate.md)**:** Δημιούργησε ένα πιστοποιητικό βασισμένο στο PRT για να συνδεθείς από μια μηχανή σε άλλη

Από τον συμβιβασμό του **AD** στον συμβιβασμό του **Cloud** και από τον συμβιβασμό του **Cloud** στον συμβιβασμό του **AD**:

- [**Azure AD Connect**](azure-ad-connect-hybrid-identity/)
- **Ένας άλλος τρόπος για να κάνεις pivot από το cloud στο On-Prem είναι** [**καταχρώντας το Intune**](../az-services/intune.md)

#### [Roadtx](https://github.com/dirkjanm/ROADtools)

Αυτό το εργαλείο επιτρέπει την εκτέλεση διαφόρων ενεργειών όπως η καταχώρηση μιας μηχανής στο Azure AD για να αποκτήσει ένα PRT και η χρήση PRTs (νόμιμων ή κλεμμένων) για την πρόσβαση σε πόρους με διάφορους τρόπους. Αυτές δεν είναι άμεσες επιθέσεις, αλλά διευκολύνει τη χρήση των PRTs για την πρόσβαση σε πόρους με διαφορετικούς τρόπους. Βρες περισσότερες πληροφορίες στο [https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)

## Αναφορές

- [https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

{{#include ../../../banners/hacktricks-training.md}}
