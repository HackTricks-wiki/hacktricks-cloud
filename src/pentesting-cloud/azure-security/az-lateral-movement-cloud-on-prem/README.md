# Az - Lateral Movement (Cloud - On-Prem)

## Az - Lateral Movement (Cloud - On-Prem)

{{#include ../../../banners/hacktricks-training.md}}

### On-Prem mašine povezane sa cloud-om

Postoje različiti načini na koje mašina može biti povezana sa cloud-om:

#### Azure AD pridružena

<figure><img src="../../../images/image (259).png" alt=""><figcaption></figcaption></figure>

#### Pridružena radnom mestu

<figure><img src="../../../images/image (222).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Hibridno pridružena

<figure><img src="../../../images/image (178).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### Pridružena radnom mestu na AADJ ili Hibridno

<figure><img src="../../../images/image (252).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

### Tokeni i ograničenja <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

U Azure AD, postoje različite vrste tokena sa specifičnim ograničenjima:

- **Access tokens**: Koriste se za pristup API-ima i resursima kao što je Microsoft Graph. Povezani su sa specifičnim klijentom i resursom.
- **Refresh tokens**: Izdaju se aplikacijama za dobijanje novih access tokena. Mogu ih koristiti samo aplikacije kojima su dodeljeni ili grupa aplikacija.
- **Primary Refresh Tokens (PRT)**: Koriste se za Single Sign-On na Azure AD pridruženim, registrovanim ili hibridno pridruženim uređajima. Mogu se koristiti u tokovima prijavljivanja u pretraživaču i za prijavljivanje u mobilne i desktop aplikacije na uređaju.
- **Windows Hello for Business keys (WHFB)**: Koriste se za autentifikaciju bez lozinke. Koriste se za dobijanje Primary Refresh Tokens.

Najzanimljivija vrsta tokena je Primary Refresh Token (PRT).

{{#ref}}
az-primary-refresh-token-prt.md
{{#endref}}

### Tehnike pivotiranja

Od **kompromitovane mašine do cloud-a**:

- [**Pass the Cookie**](az-pass-the-cookie.md): Ukrasti Azure kolačiće iz pretraživača i koristiti ih za prijavu
- [**Dump processes access tokens**](az-processes-memory-access-token.md): Isprazniti memoriju lokalnih procesa sinhronizovanih sa cloud-om (kao što su excel, Teams...) i pronaći access tokene u čistom tekstu.
- [**Phishing Primary Refresh Token**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** Phishovati PRT da bi se zloupotrebio
- [**Pass the PRT**](pass-the-prt.md): Ukrasti PRT uređaja da bi se pristupilo Azure-u pretvarajući se da je to uređaj.
- [**Pass the Certificate**](az-pass-the-certificate.md)**:** Generisati sertifikat na osnovu PRT-a za prijavu sa jedne mašine na drugu

Od kompromitovanja **AD** do kompromitovanja **Cloud-a** i od kompromitovanja **Cloud-a do** kompromitovanja **AD**:

- [**Azure AD Connect**](azure-ad-connect-hybrid-identity/)
- **Drugi način za pivotiranje od cloud-a do On-Prem je** [**zloupotreba Intune**](../az-services/intune.md)

#### [Roadtx](https://github.com/dirkjanm/ROADtools)

Ovaj alat omogućava izvođenje nekoliko akcija kao što je registracija mašine u Azure AD za dobijanje PRT-a, i korišćenje PRT-ova (legitimnih ili ukradenih) za pristup resursima na nekoliko različitih načina. Ovo nisu direktni napadi, ali olakšava korišćenje PRT-ova za pristup resursima na različite načine. Pronađite više informacija na [https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)

## Reference

- [https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

{{#include ../../../banners/hacktricks-training.md}}
