# Az - Pass the Certificate

{{#include ../../../banners/hacktricks-training.md}}

## Pass the Certificate (Azure)

Στις μηχανές που είναι συνδεδεμένες στο Azure, είναι δυνατόν να αυθεντικοποιηθείς από μια μηχανή σε άλλη χρησιμοποιώντας πιστοποιητικά που **πρέπει να εκδίδονται από το Azure AD CA** για τον απαιτούμενο χρήστη (ως υποκείμενο) όταν και οι δύο μηχανές υποστηρίζουν τον μηχανισμό αυθεντικοποίησης **NegoEx**.

Με απλά λόγια:

- Η μηχανή (πελάτης) που ξεκινά τη σύνδεση **χρειάζεται ένα πιστοποιητικό από το Azure AD για έναν χρήστη**.
- Ο πελάτης δημιουργεί μια κεφαλίδα JSON Web Token (JWT) που περιέχει PRT και άλλες λεπτομέρειες, την υπογράφει χρησιμοποιώντας το Derived key (χρησιμοποιώντας το session key και το security context) και **την στέλνει στο Azure AD**.
- Το Azure AD επαληθεύει την υπογραφή JWT χρησιμοποιώντας το session key του πελάτη και το security context, ελέγχει την εγκυρότητα του PRT και **απαντά** με το **πιστοποιητικό**.

Σε αυτό το σενάριο και αφού έχεις συλλέξει όλες τις πληροφορίες που χρειάζεσαι για μια [**Pass the PRT**](pass-the-prt.md) επίθεση:

- Όνομα χρήστη
- Tenant ID
- PRT
- Security context
- Derived Key

Είναι δυνατόν να **ζητήσεις P2P πιστοποιητικό** για τον χρήστη με το εργαλείο [**PrtToCert**](https://github.com/morRubin/PrtToCert)**:**
```bash
RequestCert.py [-h] --tenantId TENANTID --prt PRT --userName USERNAME --hexCtx HEXCTX --hexDerivedKey HEXDERIVEDKEY [--passPhrase PASSPHRASE]
```
Τα πιστοποιητικά θα διαρκέσουν όσο και το PRT. Για να χρησιμοποιήσετε το πιστοποιητικό, μπορείτε να χρησιμοποιήσετε το εργαλείο python [**AzureADJoinedMachinePTC**](https://github.com/morRubin/AzureADJoinedMachinePTC) που θα **αυθεντικοποιήσει** τη απομακρυσμένη μηχανή, θα εκτελέσει **PSEXEC** και θα **ανοίξει ένα CMD** στη μηχανή του θύματος. Αυτό θα μας επιτρέψει να χρησιμοποιήσουμε ξανά το Mimikatz για να αποκτήσουμε το PRT ενός άλλου χρήστη.
```bash
Main.py [-h] --usercert USERCERT --certpass CERTPASS --remoteip REMOTEIP
```
## Αναφορές

- Για περισσότερες λεπτομέρειες σχετικά με το πώς λειτουργεί το Pass the Certificate, ελέγξτε την αρχική ανάρτηση [https://medium.com/@mor2464/azure-ad-pass-the-certificate-d0c5de624597](https://medium.com/@mor2464/azure-ad-pass-the-certificate-d0c5de624597)

{{#include ../../../banners/hacktricks-training.md}}
