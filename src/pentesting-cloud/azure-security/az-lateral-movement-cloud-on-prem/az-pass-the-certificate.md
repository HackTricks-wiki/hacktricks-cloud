# Az - Pass the Certificate

{{#include ../../../banners/hacktricks-training.md}}

## Pass the Certificate (Azure)

In Azure-verbundenen Maschinen ist es möglich, sich von einer Maschine zur anderen mit Zertifikaten zu authentifizieren, die **von Entra ID CA** für den erforderlichen Benutzer (als Subjekt) ausgestellt werden müssen, wenn beide Maschinen den **NegoEx**-Authentifizierungsmechanismus unterstützen.

In super vereinfachten Begriffen:

- Die Maschine (Client), die die Verbindung initiiert, **benötigt ein Zertifikat von Entra ID für einen Benutzer**.
- Der Client erstellt einen JSON Web Token (JWT) Header, der PRT und andere Details enthält, signiert ihn mit dem abgeleiteten Schlüssel (unter Verwendung des Sitzungsschlüssels und des Sicherheitskontexts) und **sendet ihn an Entra ID**.
- Entra ID überprüft die JWT-Signatur mit dem Sitzungsschlüssel des Clients und dem Sicherheitskontext, prüft die Gültigkeit des PRT und **antwortet** mit dem **Zertifikat**.

In diesem Szenario und nachdem alle benötigten Informationen für einen [**Pass the PRT**](az-primary-refresh-token-prt.md) Angriff gesammelt wurden:

- Benutzername
- Mandanten-ID
- PRT
- Sicherheitskontext
- Abgeleiteter Schlüssel

Es ist möglich, ein **P2P-Zertifikat** für den Benutzer mit dem Tool [**PrtToCert**](https://github.com/morRubin/PrtToCert)**:**
```bash
RequestCert.py [-h] --tenantId TENANTID --prt PRT --userName USERNAME --hexCtx HEXCTX --hexDerivedKey HEXDERIVEDKEY [--passPhrase PASSPHRASE]
```
Die Zertifikate haben die gleiche Gültigkeit wie das PRT. Um das Zertifikat zu verwenden, können Sie das Python-Tool [**AzureADJoinedMachinePTC**](https://github.com/morRubin/AzureADJoinedMachinePTC) verwenden, das sich **authentifiziert** und **PSEXEC** ausführt, um eine CMD auf der Zielmaschine zu öffnen. Dies ermöglicht es uns, Mimikatz erneut zu verwenden, um das PRT eines anderen Benutzers zu erhalten.
```bash
Main.py [-h] --usercert USERCERT --certpass CERTPASS --remoteip REMOTEIP
```
## Referenzen

- Für weitere Details darüber, wie Pass the Certificate funktioniert, siehe den Originalbeitrag [https://medium.com/@mor2464/azure-ad-pass-the-certificate-d0c5de624597](https://medium.com/@mor2464/azure-ad-pass-the-certificate-d0c5de624597)

{{#include ../../../banners/hacktricks-training.md}}
