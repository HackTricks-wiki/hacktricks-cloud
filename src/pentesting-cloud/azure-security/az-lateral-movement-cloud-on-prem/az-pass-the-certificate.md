# Az - Pass the Certificate

{{#include ../../../banners/hacktricks-training.md}}

## Pass the Certificate (Azure)

Em máquinas unidas ao Azure, é possível autenticar de uma máquina para outra usando certificados que **devem ser emitidos pela Azure AD CA** para o usuário necessário (como o sujeito) quando ambas as máquinas suportam o mecanismo de autenticação **NegoEx**.

Em termos super simplificados:

- A máquina (cliente) que inicia a conexão **precisa de um certificado da Azure AD para um usuário**.
- O cliente cria um cabeçalho de Token Web JSON (JWT) contendo PRT e outros detalhes, assina usando a Chave Derivada (usando a chave de sessão e o contexto de segurança) e **o envia para a Azure AD**.
- A Azure AD verifica a assinatura do JWT usando a chave de sessão do cliente e o contexto de segurança, verifica a validade do PRT e **responde** com o **certificado**.

Neste cenário e após obter todas as informações necessárias para um ataque [**Pass the PRT**](pass-the-prt.md):

- Nome de usuário
- ID do locatário
- PRT
- Contexto de segurança
- Chave Derivada

É possível **solicitar um certificado P2P** para o usuário com a ferramenta [**PrtToCert**](https://github.com/morRubin/PrtToCert)**:**
```bash
RequestCert.py [-h] --tenantId TENANTID --prt PRT --userName USERNAME --hexCtx HEXCTX --hexDerivedKey HEXDERIVEDKEY [--passPhrase PASSPHRASE]
```
Os certificados durarão o mesmo que o PRT. Para usar o certificado, você pode usar a ferramenta python [**AzureADJoinedMachinePTC**](https://github.com/morRubin/AzureADJoinedMachinePTC) que irá **autenticar** na máquina remota, executar **PSEXEC** e **abrir um CMD** na máquina da vítima. Isso nos permitirá usar o Mimikatz novamente para obter o PRT de outro usuário.
```bash
Main.py [-h] --usercert USERCERT --certpass CERTPASS --remoteip REMOTEIP
```
## Referências

- Para mais detalhes sobre como o Pass the Certificate funciona, consulte o post original [https://medium.com/@mor2464/azure-ad-pass-the-certificate-d0c5de624597](https://medium.com/@mor2464/azure-ad-pass-the-certificate-d0c5de624597)

{{#include ../../../banners/hacktricks-training.md}}
