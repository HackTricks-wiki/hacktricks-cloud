# Az - Pass the Cookie

{{#include ../../../banners/hacktricks-training.md}}

## なぜクッキーなのか？

ブラウザの**クッキー**は、**認証とMFAをバイパスする**ための優れたメカニズムです。ユーザーがすでにアプリケーションに認証されているため、セッション**クッキー**を使用して、そのユーザーとして**データにアクセス**することができ、再認証する必要がありません。

**ブラウザのクッキーの場所**は次のリンクで確認できます：

{{#ref}}
https://book.hacktricks.wiki/en/generic-methodologies-and-resources/basic-forensic-methodology/specific-software-file-type-tricks/browser-artifacts.html#google-chrome
{{#endref}}

## 攻撃

難しい部分は、これらの**クッキーがユーザーのために暗号化されている**ことです。これはMicrosoft Data Protection API（**DPAPI**）を介して暗号化されています。これは、クッキーが属するユーザーに結びついた暗号化された[キー](https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords.html)を使用して暗号化されています。このことについての詳細は次のリンクで確認できます：

{{#ref}}
https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords.html
{{#endref}}

Mimikatzを手に入れれば、次のコマンドを使用して**ユーザーのクッキーを抽出**することができます。
```bash
mimikatz.exe privilege::debug log "dpapi::chrome /in:%localappdata%\google\chrome\USERDA~1\default\cookies /unprotect" exit
```
Azureでは、**`ESTSAUTH`**、**`ESTSAUTHPERSISTENT`**、および**`ESTSAUTHLIGHT`**を含む認証クッキーが重要です。これらは、ユーザーが最近Azureでアクティブであったために存在します。

login.microsoftonline.comに移動し、クッキー**`ESTSAUTHPERSISTENT`**（「サインインを維持」オプションによって生成された）または**`ESTSAUTH`**を追加します。そうすれば、認証されます。

## References

- [https://stealthbits.com/blog/bypassing-mfa-with-pass-the-cookie/](https://stealthbits.com/blog/bypassing-mfa-with-pass-the-cookie/)

{{#include ../../../banners/hacktricks-training.md}}
