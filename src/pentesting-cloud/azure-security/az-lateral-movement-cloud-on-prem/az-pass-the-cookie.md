# Az - Pass the Cookie

{{#include ../../../banners/hacktricks-training.md}}

## Γιατί Cookies;

Οι **cookies** του προγράμματος περιήγησης είναι ένας εξαιρετικός μηχανισμός για να **παρακάμψετε την αυθεντικοποίηση και το MFA**. Επειδή ο χρήστης έχει ήδη αυθεντικοποιηθεί στην εφαρμογή, το **cookie** της συνεδρίας μπορεί απλά να χρησιμοποιηθεί για να **πρόσβαση σε δεδομένα** ως αυτός ο χρήστης, χωρίς να χρειάζεται να ξανα-αυθεντικοποιηθεί.

Μπορείτε να δείτε πού βρίσκονται οι **cookies του προγράμματος περιήγησης** στο:

{{#ref}}
https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/specific-software-file-type-tricks/browser-artifacts?q=browse#google-chrome
{{#endref}}

## Επίθεση

Το δύσκολο μέρος είναι ότι αυτές οι **cookies είναι κρυπτογραφημένες** για τον **χρήστη** μέσω του Microsoft Data Protection API (**DPAPI**). Αυτό κρυπτογραφείται χρησιμοποιώντας κρυπτογραφικά [κλειδιά που συνδέονται με τον χρήστη](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords) των οποίων ανήκουν οι cookies. Μπορείτε να βρείτε περισσότερες πληροφορίες σχετικά με αυτό στο:

{{#ref}}
https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords
{{#endref}}

Με το Mimikatz στο χέρι, μπορώ να **εξάγω τα cookies ενός χρήστη** αν και είναι κρυπτογραφημένα με αυτή την εντολή:
```bash
mimikatz.exe privilege::debug log "dpapi::chrome /in:%localappdata%\google\chrome\USERDA~1\default\cookies /unprotect" exit
```
Για το Azure, μας ενδιαφέρουν τα cookies αυθεντικοποίησης που περιλαμβάνουν **`ESTSAUTH`**, **`ESTSAUTHPERSISTENT`** και **`ESTSAUTHLIGHT`**. Αυτά υπάρχουν επειδή ο χρήστης έχει δραστηριοποιηθεί πρόσφατα στο Azure.

Απλώς πλοηγηθείτε στο login.microsoftonline.com και προσθέστε το cookie **`ESTSAUTHPERSISTENT`** (που δημιουργήθηκε από την επιλογή “Stay Signed In”) ή **`ESTSAUTH`**. Και θα είστε αυθεντικοποιημένοι.

## Αναφορές

- [https://stealthbits.com/blog/bypassing-mfa-with-pass-the-cookie/](https://stealthbits.com/blog/bypassing-mfa-with-pass-the-cookie/)

{{#include ../../../banners/hacktricks-training.md}}
