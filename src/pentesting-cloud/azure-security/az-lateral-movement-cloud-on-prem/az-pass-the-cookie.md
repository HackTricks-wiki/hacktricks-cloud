# Az - Pass the Cookie

{{#include ../../../banners/hacktricks-training.md}}

## 为什么选择 Cookies？

浏览器 **cookies** 是一个很好的机制，可以 **绕过身份验证和 MFA**。因为用户已经在应用程序中进行了身份验证，所以会话 **cookie** 可以直接用于 **访问数据**，而无需重新进行身份验证。

您可以查看 **浏览器 cookies 的位置** 在：

{{#ref}}
https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/specific-software-file-type-tricks/browser-artifacts?q=browse#google-chrome
{{#endref}}

## 攻击

具有挑战性的是，这些 **cookies 是通过 Microsoft 数据保护 API (**DPAPI**) 加密的**。这是使用与用户相关的加密 [密钥进行加密](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords)，这些 cookies 属于该用户。您可以在以下链接找到更多信息：

{{#ref}}
https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords
{{#endref}}

手握 Mimikatz，我能够 **提取用户的 cookies**，即使它们是加密的，使用以下命令：
```bash
mimikatz.exe privilege::debug log "dpapi::chrome /in:%localappdata%\google\chrome\USERDA~1\default\cookies /unprotect" exit
```
对于 Azure，我们关心的身份验证 cookie 包括 **`ESTSAUTH`**、**`ESTSAUTHPERSISTENT`** 和 **`ESTSAUTHLIGHT`**。这些 cookie 的存在是因为用户最近在 Azure 上活跃。

只需导航到 login.microsoftonline.com 并添加 cookie **`ESTSAUTHPERSISTENT`**（由“保持登录”选项生成）或 **`ESTSAUTH`**。这样您将被认证。

## References

- [https://stealthbits.com/blog/bypassing-mfa-with-pass-the-cookie/](https://stealthbits.com/blog/bypassing-mfa-with-pass-the-cookie/)

{{#include ../../../banners/hacktricks-training.md}}
