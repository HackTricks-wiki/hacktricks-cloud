# Az - PTA - パススルー認証

{{#include ../../../../banners/hacktricks-training.md}}

## 基本情報

[ドキュメントから:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) パススルー認証は、ユーザーが**同じパスワードを使用してオンプレミスおよびクラウドベースのアプリケーションにサインインできる**ようにします。この機能は、ユーザーにとってより良い体験を提供し、覚えるべきパスワードが1つ減るため、ITヘルプデスクのコストを削減します。ユーザーがAzure ADを使用してサインインすると、この機能は**オンプレミスのActive Directoryに対して直接ユーザーのパスワードを検証**します。

PTAでは**アイデンティティ**は**同期**されますが、**パスワード**はPHSのようには**同期**されません。

認証はオンプレミスのADで検証され、クラウドとの通信は**オンプレミスサーバー**で実行される**認証エージェント**によって行われます（オンプレミスのDC上である必要はありません）。

### 認証フロー

<figure><img src="../../../../images/image (92).png" alt=""><figcaption></figcaption></figure>

1. **ログイン**するために、ユーザーは**Azure AD**にリダイレクトされ、**ユーザー名**と**パスワード**を送信します。
2. **資格情報**は**暗号化**され、Azure ADの**キュー**に設定されます。
3. **オンプレミス認証エージェント**がキューから**資格情報**を収集し、**復号化**します。このエージェントは**「パススルー認証エージェント」**または**PTAエージェント**と呼ばれます。
4. **エージェント**は**オンプレミスAD**に対して資格情報を**検証**し、**応答**をAzure ADに**返します**。応答が肯定的であれば、**ユーザーのログインを完了**します。

> [!WARNING]
> 攻撃者が**PTA**を**侵害**すると、キュー内のすべての**資格情報**を（**平文**で）**見る**ことができます。\
> また、AzureADに対して**任意の資格情報を検証**することもできます（スケルトンキーに似た攻撃）。

### オンプレミス -> クラウド

**PTA** **エージェント**が実行されている**Azure AD Connectサーバー**に**管理者**アクセスがある場合、**AADInternals**モジュールを使用して、**入力されたすべてのパスワードを検証**する**バックドア**を**挿入**できます（すべてのパスワードが認証に対して有効になります）：
```powershell
Install-AADIntPTASpy
```
> [!NOTE]
> **インストールが失敗した場合**、これはおそらく[Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe)が不足しているためです。

また、前のバックドアがインストールされたマシンで次のcmdletを使用することで、**PTAエージェントに送信された平文のパスワードを見ることも可能です**:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
このバックドアは以下を行います：

- 隠しフォルダー `C:\PTASpy` を作成します
- `PTASpy.dll` を `C:\PTASpy` にコピーします
- `PTASpy.dll` を `AzureADConnectAuthenticationAgentService` プロセスに注入します

> [!NOTE]
> AzureADConnectAuthenticationAgent サービスが再起動されると、PTASpy は「アンロード」され、再インストールする必要があります。

### クラウド -> オンプレミス

> [!CAUTION]
> クラウドで **GA権限** を取得した後、**攻撃者が制御するマシン** に設定することで **新しいPTAエージェントを登録** することが可能です。エージェントが **設定** されると、**以前の** 手順を **繰り返して** **任意のパスワードを使用して認証** し、さらに **パスワードを平文で取得** することができます。

### シームレスSSO

PTAを使用してシームレスSSOを利用することが可能ですが、他の悪用に対して脆弱です。詳細は以下を確認してください：

{{#ref}}
seamless-sso.md
{{#endref}}

## 参考文献

- [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
- [https://aadinternals.com/post/on-prem_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem_admin/#pass-through-authentication)

{{#include ../../../../banners/hacktricks-training.md}}
