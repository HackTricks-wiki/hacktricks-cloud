# Az - PTA - Pass-through Authentication

{{#include ../../../../banners/hacktricks-training.md}}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication inaruhusu watumiaji wako **kuingia kwenye programu za ndani na za wingu wakitumia nywila sawa**. Kipengele hiki kinawapa watumiaji wako uzoefu bora - nywila moja kidogo ya kukumbuka, na hupunguza gharama za msaada wa IT kwa sababu watumiaji wako wana uwezekano mdogo wa kusahau jinsi ya kuingia. Wakati watumiaji wanaingia wakitumia Azure AD, kipengele hiki **kinathibitisha nywila za watumiaji moja kwa moja dhidi ya Active Directory yako ya ndani**.

Katika PTA **vitambulisho** vinakuwa **vimeunganishwa** lakini **nywila** **hazijashirikiwa** kama katika PHS.

Uthibitishaji unathibitishwa katika AD ya ndani na mawasiliano na wingu yanafanywa na **wakala wa uthibitishaji** anayekimbia katika **seva ya ndani** (haipaswi kuwa kwenye DC ya ndani).

### Authentication flow

<figure><img src="../../../../images/image (92).png" alt=""><figcaption></figcaption></figure>

1. Ili **kuingia** mtumiaji anapelekwa kwa **Azure AD**, ambapo anatumia **jina la mtumiaji** na **nywila**
2. **Taarifa za kuingia** zinakuwa **zimefichwa** na kuwekwa kwenye **foleni** katika Azure AD
3. **Wakala wa uthibitishaji wa ndani** anakusanya **taarifa za kuingia** kutoka kwenye foleni na **kuzifichua**. Wakala huyu anaitwa **"Wakala wa uthibitishaji wa kupita"** au **wakala wa PTA.**
4. **Wakala** **anathibitisha** taarifa dhidi ya **AD ya ndani** na anatumia **jibu** **kurudi** kwa Azure AD ambayo, ikiwa jibu ni chanya, **inakamilisha kuingia** kwa mtumiaji.

> [!WARNING]
> Ikiwa mshambuliaji **anavunja** **PTA** anaweza **kuona** taarifa zote **za kuingia** kutoka kwenye foleni (katika **maandishi wazi**).\
> Anaweza pia **kuhakiki taarifa zozote** kwa AzureAD (shambulio linalofanana na ufunguo wa Skeleton).

### On-Prem -> cloud

Ikiwa una **ufikiaji wa admin** kwa **seva ya Azure AD Connect** yenye **wakala wa PTA** akifanya kazi, unaweza kutumia moduli ya **AADInternals** **kuingiza nyuma** ambayo it **ihakiki NYWILA ZOTE** zilizowekwa (hivyo nywila zote zitakuwa halali kwa uthibitishaji):
```powershell
Install-AADIntPTASpy
```
> [!NOTE]
> Ikiwa **ufungaji unashindwa**, hii inaweza kuwa kutokana na kukosekana kwa [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe).

Pia inawezekana **kuona nywila za wazi zinazotumwa kwa wakala wa PTA** kwa kutumia cmdlet ifuatayo kwenye mashine ambapo nyuma ya mlango wa awali ilipowekwa:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
This backdoor will:

- Create a hidden folder `C:\PTASpy`
- Copy a `PTASpy.dll` to `C:\PTASpy`
- Injects `PTASpy.dll` to `AzureADConnectAuthenticationAgentService` process

> [!NOTE]
> When the AzureADConnectAuthenticationAgent service is restarted, PTASpy is “unloaded” and must be re-installed.

### Cloud -> On-Prem

> [!CAUTION]
> After getting **GA privileges** on the cloud, it's possible to **register a new PTA agent** by setting it on an **attacker controlled machine**. Once the agent is **setup**, we can **repeat** the **previous** steps to **authenticate using any password** and also, **get the passwords in clear-text.**

### Seamless SSO

It's possible to use Seamless SSO with PTA, which is vulnerable to other abuses. Check it in:

{{#ref}}
seamless-sso.md
{{#endref}}

## References

- [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
- [https://aadinternals.com/post/on-prem_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem_admin/#pass-through-authentication)

{{#include ../../../../banners/hacktricks-training.md}}
