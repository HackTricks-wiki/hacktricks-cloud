# Az - PTA - Pass-through Authentication

{{#include ../../../../banners/hacktricks-training.md}}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Η Πιστοποίηση Pass-through του Azure Active Directory (Azure AD) επιτρέπει στους χρήστες σας να **συνδέονται σε εφαρμογές τόσο τοπικές όσο και βασισμένες στο cloud χρησιμοποιώντας τους ίδιους κωδικούς πρόσβασης**. Αυτή η δυνατότητα παρέχει στους χρήστες σας μια καλύτερη εμπειρία - ένας λιγότερος κωδικός πρόσβασης για να θυμούνται, και μειώνει τα κόστη του IT helpdesk επειδή οι χρήστες σας είναι λιγότερο πιθανό να ξεχάσουν πώς να συνδεθούν. Όταν οι χρήστες συνδέονται χρησιμοποιώντας το Azure AD, αυτή η δυνατότητα **επικυρώνει τους κωδικούς πρόσβασης των χρηστών απευθείας με το τοπικό Active Directory**.

Στην PTA οι **ταυτότητες** είναι **συγχρονισμένες** αλλά οι **κωδικοί πρόσβασης** **δεν είναι** όπως στην PHS.

Η πιστοποίηση επικυρώνεται στο τοπικό AD και η επικοινωνία με το cloud γίνεται μέσω ενός **πράκτορα πιστοποίησης** που εκτελείται σε έναν **τοπικό διακομιστή** (δεν χρειάζεται να είναι στον τοπικό DC).

### Authentication flow

<figure><img src="../../../../images/image (92).png" alt=""><figcaption></figcaption></figure>

1. Για να **συνδεθεί** ο χρήστης ανακατευθύνεται στο **Azure AD**, όπου στέλνει το **όνομα χρήστη** και τον **κωδικό πρόσβασης**
2. Οι **διαπιστευτήρια** είναι **κρυπτογραφημένα** και τοποθετούνται σε μια **ουρά** στο Azure AD
3. Ο **τοπικός πράκτορας πιστοποίησης** συλλέγει τα **διαπιστευτήρια** από την ουρά και τα **αποκρυπτογραφεί**. Αυτός ο πράκτορας ονομάζεται **"Πράκτορας πιστοποίησης pass-through"** ή **πράκτορας PTA.**
4. Ο **πράκτορας** **επικυρώνει** τα διαπιστευτήρια με το **τοπικό AD** και στέλνει την **απάντηση** **πίσω** στο Azure AD, το οποίο, αν η απάντηση είναι θετική, **ολοκληρώνει τη σύνδεση** του χρήστη.

> [!WARNING]
> Εάν ένας επιτιθέμενος **παραβιάσει** την **PTA** μπορεί να **δει** όλα τα **διαπιστευτήρια** από την ουρά (σε **καθαρό κείμενο**).\
> Μπορεί επίσης να **επικυρώσει οποιαδήποτε διαπιστευτήρια** στο AzureAD (παρόμοια επίθεση με το Skeleton key).

### On-Prem -> cloud

Εάν έχετε **διαχειριστική** πρόσβαση στον **διακομιστή Azure AD Connect** με τον **πράκτορα PTA** να εκτελείται, μπορείτε να χρησιμοποιήσετε το **AADInternals** module για να **εισάγετε μια πίσω πόρτα** που θα **επικυρώνει ΟΛΟΥΣ τους κωδικούς πρόσβασης** που εισάγονται (έτσι όλοι οι κωδικοί πρόσβασης θα είναι έγκυροι για πιστοποίηση):
```powershell
Install-AADIntPTASpy
```
> [!NOTE]
> Αν η **εγκατάσταση αποτύχει**, αυτό πιθανώς οφείλεται σε ελλείποντα [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe).

Είναι επίσης δυνατό να **δείτε τους κωδικούς πρόσβασης σε καθαρό κείμενο που αποστέλλονται στον πράκτορα PTA** χρησιμοποιώντας το παρακάτω cmdlet στη μηχανή όπου είχε εγκατασταθεί η προηγούμενη πίσω πόρτα:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Αυτή η πίσω πόρτα θα:

- Δημιουργήσει έναν κρυφό φάκελο `C:\PTASpy`
- Αντιγράψει ένα `PTASpy.dll` στο `C:\PTASpy`
- Εισάγει το `PTASpy.dll` στη διαδικασία `AzureADConnectAuthenticationAgentService`

> [!NOTE]
> Όταν η υπηρεσία AzureADConnectAuthenticationAgent επανεκκινείται, το PTASpy "απελευθερώνεται" και πρέπει να επανεγκατασταθεί.

### Cloud -> On-Prem

> [!CAUTION]
> Αφού αποκτήσουμε **GA privileges** στο cloud, είναι δυνατό να **καταχωρήσουμε έναν νέο PTA agent** ρυθμίζοντάς τον σε μια **μηχανή ελεγχόμενη από τον επιτιθέμενο**. Μόλις ο agent είναι **ρυθμισμένος**, μπορούμε να **επαναλάβουμε** τα **προηγούμενα** βήματα για **να αυθεντικοποιηθούμε χρησιμοποιώντας οποιονδήποτε κωδικό πρόσβασης** και επίσης, **να αποκτήσουμε τους κωδικούς πρόσβασης σε καθαρό κείμενο.**

### Seamless SSO

Είναι δυνατό να χρησιμοποιήσουμε το Seamless SSO με το PTA, το οποίο είναι ευάλωτο σε άλλες καταχρήσεις. Ελέγξτε το εδώ:

{{#ref}}
seamless-sso.md
{{#endref}}

## Αναφορές

- [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
- [https://aadinternals.com/post/on-prem_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem_admin/#pass-through-authentication)

{{#include ../../../../banners/hacktricks-training.md}}
