# Az - PTA - Pass-through Authentication

{{#include ../../../../banners/hacktricks-training.md}}

## Основна інформація

[З документації:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication дозволяє вашим користувачам **увійти в якості на локальні та хмарні додатки, використовуючи ті ж паролі**. Ця функція забезпечує кращий досвід для ваших користувачів - один пароль менше для запам'ятовування, і зменшує витрати на IT-підтримку, оскільки ваші користувачі менш імовірно забудуть, як увійти. Коли користувачі входять за допомогою Azure AD, ця функція **перевіряє паролі користувачів безпосередньо проти вашого локального Active Directory**.

У PTA **ідентичності** **синхронізуються**, але **паролі** **ні** як у PHS.

Аутентифікація перевіряється в локальному AD, а зв'язок з хмарою здійснюється через **агента аутентифікації**, що працює на **локальному сервері** (не обов'язково на локальному DC).

### Потік аутентифікації

<figure><img src="../../../../images/image (92).png" alt=""><figcaption></figcaption></figure>

1. Щоб **увійти**, користувач перенаправляється до **Azure AD**, де він надсилає **ім'я користувача** та **пароль**
2. **Облікові дані** **шифруються** і ставляться в **чергу** в Azure AD
3. **Локальний агент аутентифікації** збирає **облікові дані** з черги та **дешифрує** їх. Цей агент називається **"Агент аутентифікації через проходження"** або **агент PTA.**
4. **Агент** **перевіряє** облікові дані проти **локального AD** і надсилає **відповідь** **назад** до Azure AD, яка, якщо відповідь позитивна, **завершує вхід** користувача.

> [!WARNING]
> Якщо зловмисник **компрометує** **PTA**, він може **бачити** всі **облікові дані** з черги (в **незахищеному вигляді**).\
> Він також може **перевірити будь-які облікові дані** до AzureAD (схожий напад на Skeleton key).

### Локальний -> хмара

Якщо у вас є **адміністративний** доступ до **сервера Azure AD Connect** з працюючим **агентом PTA**, ви можете використовувати модуль **AADInternals** для **вставки бекдору**, який **перевірить ВСІ паролі**, введені (так що всі паролі будуть дійсними для аутентифікації):
```powershell
Install-AADIntPTASpy
```
> [!NOTE]
> Якщо **встановлення не вдалося**, це, ймовірно, через відсутність [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe).

Також можливо **побачити паролі в чистому вигляді, надіслані агенту PTA**, використовуючи наступний cmdlet на машині, де був встановлений попередній бекдор:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Ця задня дверцята буде:

- Створити приховану папку `C:\PTASpy`
- Скопіювати `PTASpy.dll` до `C:\PTASpy`
- Впровадити `PTASpy.dll` у процес `AzureADConnectAuthenticationAgentService`

> [!NOTE]
> Коли служба AzureADConnectAuthenticationAgent перезапускається, PTASpy "вивантажується" і його потрібно повторно встановити.

### Хмара -> На місці

> [!CAUTION]
> Після отримання **GA привілеїв** у хмарі, можливо **зареєструвати новий агент PTA**, налаштувавши його на **машині, контрольованій зловмисником**. Після налаштування агента, ми можемо **повторити** **попередні** кроки для **автентифікації за допомогою будь-якого пароля** і також **отримати паролі у відкритому тексті.**

### Безшовний SSO

Можливо використовувати безшовний SSO з PTA, який вразливий до інших зловживань. Перевірте це в:

{{#ref}}
seamless-sso.md
{{#endref}}

## Посилання

- [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
- [https://aadinternals.com/post/on-prem_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem_admin/#pass-through-authentication)

{{#include ../../../../banners/hacktricks-training.md}}
