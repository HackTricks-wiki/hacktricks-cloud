# Az - PTA - Pass-through Authentication

{{#include ../../../../banners/hacktricks-training.md}}

## Basic Information

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication inaruhusu watumiaji wako **kuingia kwenye programu za ndani na za wingu wakitumia nywila sawa**. Kipengele hiki kinawapa watumiaji wako uzoefu bora - nywila moja kidogo ya kukumbuka, na hupunguza gharama za msaada wa IT kwa sababu watumiaji wako wana uwezekano mdogo wa kusahau jinsi ya kuingia. Wakati watumiaji wanaingia wakitumia Azure AD, kipengele hiki **kinathibitisha nywila za watumiaji moja kwa moja dhidi ya Active Directory yako ya ndani**.

Katika PTA **identities** zinahusishwa lakini **nywila** **hazihusishwi** kama katika PHS.

Uthibitishaji unathibitishwa katika AD ya ndani na mawasiliano na wingu yanafanywa na **wakala wa uthibitishaji** anayekimbia katika **seva ya ndani** (haipaswi kuwa kwenye DC ya ndani).

### Authentication flow

<figure><img src="../../../../images/image (92).png" alt=""><figcaption></figcaption></figure>

1. Ili **kuingia** mtumiaji anapelekwa kwenye **Azure AD**, ambapo anatumia **jina la mtumiaji** na **nywila**
2. **Taarifa za kuingia** zinahifadhiwa **kwa siri** na kuwekwa kwenye **foleni** katika Azure AD
3. **Wakala wa uthibitishaji wa ndani** anakusanya **taarifa za kuingia** kutoka kwenye foleni na **kuzifungua**. Wakala huyu anaitwa **"Pass-through authentication agent"** au **PTA agent.**
4. **Wakala** **anathibitisha** taarifa dhidi ya **AD ya ndani** na anatumia **jibu** **kurudi** kwa Azure AD ambayo, ikiwa jibu ni chanya, **inakamilisha kuingia** kwa mtumiaji.

> [!WARNING]
> Ikiwa mshambuliaji **anashambulia** **PTA** anaweza **kuona** taarifa zote **za kuingia** kutoka kwenye foleni (katika **maandishi wazi**).\
> Anaweza pia **kuhakiki taarifa zozote** kwa AzureAD (shambulio linalofanana na ufunguo wa Skeleton).

### On-Prem -> cloud

Ikiwa una **ufikiaji wa admin** kwa **seva ya Azure AD Connect** yenye **wakala wa PTA** akifanya kazi, unaweza kutumia moduli ya **AADInternals** ku **ingiza nyuma ya mlango** ambayo it **athibitisha NYWILA ZOTE** zilizowekwa (hivyo nywila zote zitakuwa halali kwa uthibitishaji):
```powershell
Install-AADIntPTASpy
```
> [!NOTE]
> Ikiwa **ufungaji unashindwa**, hii inaweza kuwa kutokana na kukosekana kwa [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe).

Pia inawezekana **kuona nywila za maandiko wazi zinazotumwa kwa wakala wa PTA** kwa kutumia cmdlet ifuatayo kwenye mashine ambapo nyuma ya mlango wa awali ilifungwa:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Hii backdoor itafanya:

- Kuunda folda ya siri `C:\PTASpy`
- Nakala ya `PTASpy.dll` kwenye `C:\PTASpy`
- Inajumuisha `PTASpy.dll` kwenye mchakato wa `AzureADConnectAuthenticationAgentService`

> [!NOTE]
> Wakati huduma ya AzureADConnectAuthenticationAgent inapoanzishwa upya, PTASpy "imeondolewa" na inapaswa kusanikishwa tena.

### Cloud -> On-Prem

> [!CAUTION]
> Baada ya kupata **GA privileges** kwenye wingu, inawezekana **kujiandikisha wakala mpya wa PTA** kwa kuweka kwenye **kifaa kinachodhibitiwa na mshambuliaji**. Mara wakala anapokuwa **amewekwa**, tunaweza **kurudia** hatua **za awali** ili **kujiandikisha kwa kutumia nenosiri lolote** na pia, **kupata nenosiri kwa maandiko wazi.**

### Seamless SSO

Inawezekana kutumia Seamless SSO na PTA, ambayo ina hatari ya matumizi mengine. Angalia katika:

{{#ref}}
seamless-sso.md
{{#endref}}

## Marejeleo

- [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
- [https://aadinternals.com/post/on-prem_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem_admin/#pass-through-authentication)

{{#include ../../../../banners/hacktricks-training.md}}
