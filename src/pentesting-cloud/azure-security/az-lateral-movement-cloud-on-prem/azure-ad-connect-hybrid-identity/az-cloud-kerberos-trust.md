# Az - Cloud Kerberos Trust

{{#include ../../../../banners/hacktricks-training.md}}

**この投稿は** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **の要約です。攻撃に関するさらなる情報はここで確認できます。この技術については** [**https://www.youtube.com/watch?v=AFay_58QubY**](https://www.youtube.com/watch?v=AFay_58QubY)**でもコメントされています。**

## 基本情報

### 信頼

Azure ADとの信頼が確立されると、**ADに読み取り専用ドメインコントローラー（RODC）が作成されます。** **RODCコンピュータアカウント**は**`AzureADKerberos$`**という名前です。また、**`krbtgt_AzureAD`**という名前の二次`krbtgt`アカウントも作成されます。このアカウントには、Azure ADが作成するチケットに使用される**Kerberosキー**が含まれています。

したがって、このアカウントが侵害されると、任意のユーザーを偽装することが可能になるかもしれません... ただし、このアカウントはドメイン管理者、エンタープライズ管理者、管理者などの一般的な特権ADグループのためのチケットを作成することができないため、これは真実ではありません。

> [!CAUTION]
> ただし、実際のシナリオでは、これらのグループに属さない特権ユーザーが存在します。したがって、**新しいkrbtgtアカウントが侵害された場合、それを使用して彼らを偽装することができる可能性があります。**

### Kerberos TGT

さらに、ユーザーがハイブリッドアイデンティティを使用してWindowsで認証すると、**Azure ADはPRTと共に部分的なKerberosチケットを発行します。** TGTは部分的です。なぜなら、**AzureADはオンプレミスADのユーザーに関する情報が限られているからです**（セキュリティ識別子（SID）や名前など）。\
Windowsはその後、`krbtgt`サービスのためのサービスチケットを要求することで、この部分的なTGTを完全なTGTに**交換することができます**。

### NTLM

Kerberos認証をサポートしないサービスがある可能性があるため、**二次`krbtgt`**キーを使用して署名された**部分的TGTを要求することが可能です**。これは、リクエストの**PADATA**部分に**`KERB-KEY-LIST-REQ`**フィールドを含めることで行われ、その後、**応答にNTハッシュを含む**主`krbtgt`キーで署名された完全なTGTを取得します。

## Cloud Kerberos Trustを悪用してドメイン管理者を取得する <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

AzureADが**部分的TGT**を生成するとき、それはユーザーに関する詳細を使用します。したがって、グローバル管理者が**AzureAD内のユーザーのセキュリティ識別子と名前のデータを変更できる場合**、そのユーザーのTGTを要求すると、**セキュリティ識別子は異なるものになります**。

Microsoft GraphやAzure AD Graphを通じてそれを行うことはできませんが、**API Active Directory Connect**が使用する、同期されたユーザーを作成および更新するためのAPIを使用することが可能です。これにより、グローバル管理者は**任意のハイブリッドユーザーのSAM名とSIDを変更することができ**、その後認証を行うと、変更されたSIDを含む部分的TGTを取得します。

AADInternalsを使用して、[Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a)コマンドレットを介して同期されたユーザーを更新することができることに注意してください。

### 攻撃の前提条件 <a href="#attack-prerequisites" id="attack-prerequisites"></a>

攻撃の成功とドメイン管理者権限の取得は、特定の前提条件を満たすことに依存します：

- 同期APIを介してアカウントを変更する能力が重要です。これは、グローバル管理者の役割を持つか、AD Connect同期アカウントを持つことで達成できます。あるいは、ハイブリッドアイデンティティ管理者の役割でも十分で、AD Connectを管理し、新しい同期アカウントを作成する能力を付与します。
- **ハイブリッドアカウント**の存在が不可欠です。このアカウントは、被害者アカウントの詳細で変更可能であり、認証のためにアクセス可能である必要があります。
- Active Directory内の**ターゲット被害者アカウント**を特定する必要があります。攻撃はすでに同期された任意のアカウントに対して実行できますが、Azure ADテナントはオンプレミスのセキュリティ識別子を複製していない必要があり、チケットを取得するために未同期のアカウントを変更する必要があります。
- さらに、このアカウントはドメイン管理者に相当する権限を持っている必要がありますが、AzureAD RODCによって無効なTGTが生成されないように、一般的なAD管理者グループのメンバーであってはなりません。
- 最も適切なターゲットは、**AD Connect Syncサービスによって使用されるActive Directoryアカウント**です。このアカウントはAzure ADと同期されておらず、そのSIDは有効なターゲットとなり、パスワードハッシュを同期する役割のためにドメイン管理者に相当する権限を本質的に持っています（パスワードハッシュ同期が有効であると仮定）。エクスプレスインストールのドメインでは、このアカウントは**MSOL\_**で始まります。他のインスタンスでは、ドメインオブジェクト上のディレクトリ複製権限を持つすべてのアカウントを列挙することでアカウントを特定できます。

### 完全な攻撃 <a href="#the-full-attack" id="the-full-attack"></a>

元の投稿で確認してください: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

{{#include ../../../../banners/hacktricks-training.md}}
