# Az AD Connect - Identidade Híbrida

{{#include ../../../../banners/hacktricks-training.md}}

## Informações Básicas

A integração entre **Active Directory (AD)** local e **Azure AD** é facilitada pelo **Azure AD Connect**, oferecendo vários métodos que suportam **Single Sign-on (SSO)**. Cada método, embora útil, apresenta potenciais vulnerabilidades de segurança que podem ser exploradas para comprometer ambientes em nuvem ou locais:

- **Pass-Through Authentication (PTA)**:
- Possível comprometimento do agente no AD local, permitindo a validação de senhas de usuários para conexões Azure (local para Nuvem).
- Viabilidade de registrar um novo agente para validar autenticações em um novo local (Nuvem para local).

{{#ref}}
pta-pass-through-authentication.md
{{#endref}}

- **Password Hash Sync (PHS)**:
- Extração potencial de senhas em texto claro de usuários privilegiados do AD, incluindo credenciais de um usuário AzureAD de alta privilégio, gerado automaticamente.

{{#ref}}
phs-password-hash-sync.md
{{#endref}}

- **Federation**:
- Roubo da chave privada usada para assinatura SAML, permitindo a impersonação de identidades locais e em nuvem.

{{#ref}}
federation.md
{{#endref}}

- **Seamless SSO:**
- Roubo da senha do usuário `AZUREADSSOACC`, usada para assinar tickets Kerberos silver, permitindo a impersonação de qualquer usuário em nuvem.

{{#ref}}
seamless-sso.md
{{#endref}}

- **Cloud Kerberos Trust**:
- Possibilidade de escalar de Global Admin para Domain Admin local manipulando nomes de usuários e SIDs do AzureAD e solicitando TGTs do AzureAD.

{{#ref}}
az-cloud-kerberos-trust.md
{{#endref}}

- **Default Applications**:
- Comprometer uma conta de Administrador de Aplicação ou a Conta de Sincronização local permite a modificação de configurações de diretório, associações de grupos, contas de usuários, sites do SharePoint e arquivos do OneDrive.

{{#ref}}
az-default-applications.md
{{#endref}}

Para cada método de integração, a sincronização de usuários é realizada, e uma conta `MSOL_<installationidentifier>` é criada no AD local. Notavelmente, tanto os métodos **PHS** quanto **PTA** facilitam o **Seamless SSO**, permitindo o login automático para computadores Azure AD associados ao domínio local.

Para verificar a instalação do **Azure AD Connect**, o seguinte comando PowerShell, utilizando o módulo **AzureADConnectHealthSync** (instalado por padrão com o Azure AD Connect), pode ser usado:
```powershell
Get-ADSyncConnector
```
{{#include ../../../../banners/hacktricks-training.md}}
