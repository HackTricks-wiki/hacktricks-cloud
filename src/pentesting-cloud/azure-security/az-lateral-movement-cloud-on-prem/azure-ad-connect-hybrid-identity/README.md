# Az AD Connect - Identidad Híbrida

{{#include ../../../../banners/hacktricks-training.md}}

## Información Básica

La integración entre **Active Directory (AD) local** y **Azure AD** es facilitada por **Azure AD Connect**, ofreciendo varios métodos que soportan **Single Sign-on (SSO)**. Cada método, aunque útil, presenta vulnerabilidades de seguridad potenciales que podrían ser explotadas para comprometer entornos en la nube o locales:

- **Pass-Through Authentication (PTA)**:
- Posible compromiso del agente en el AD local, permitiendo la validación de contraseñas de usuario para conexiones de Azure (local a la Nube).
- Viabilidad de registrar un nuevo agente para validar autenticaciones en una nueva ubicación (Nube a local).

{{#ref}}
pta-pass-through-authentication.md
{{#endref}}

- **Password Hash Sync (PHS)**:
- Extracción potencial de contraseñas en texto claro de usuarios privilegiados del AD, incluyendo credenciales de un usuario de AzureAD de alto privilegio, auto-generado.

{{#ref}}
phs-password-hash-sync.md
{{#endref}}

- **Federation**:
- Robo de la clave privada utilizada para la firma SAML, permitiendo la suplantación de identidades locales y en la nube.

{{#ref}}
federation.md
{{#endref}}

- **Seamless SSO:**
- Robo de la contraseña del usuario `AZUREADSSOACC`, utilizada para firmar tickets de Kerberos, permitiendo la suplantación de cualquier usuario en la nube.

{{#ref}}
seamless-sso.md
{{#endref}}

- **Cloud Kerberos Trust**:
- Posibilidad de escalar de Administrador Global a Administrador de Dominio local manipulando los nombres de usuario y SIDs de usuarios de AzureAD y solicitando TGTs de AzureAD.

{{#ref}}
az-cloud-kerberos-trust.md
{{#endref}}

- **Default Applications**:
- Comprometer una cuenta de Administrador de Aplicaciones o la Cuenta de Sincronización local permite modificar configuraciones de directorio, membresías de grupos, cuentas de usuario, sitios de SharePoint y archivos de OneDrive.

{{#ref}}
az-default-applications.md
{{#endref}}

Para cada método de integración, se lleva a cabo la sincronización de usuarios, y se crea una cuenta `MSOL_<installationidentifier>` en el AD local. Notablemente, tanto los métodos **PHS** como **PTA** facilitan **Seamless SSO**, permitiendo el inicio de sesión automático para computadoras de Azure AD unidas al dominio local.

Para verificar la instalación de **Azure AD Connect**, se puede utilizar el siguiente comando de PowerShell, utilizando el módulo **AzureADConnectHealthSync** (instalado por defecto con Azure AD Connect):
```bash
Get-ADSyncConnector
```
{{#include ../../../../banners/hacktricks-training.md}}
