# Az AD Connect - Hybrid Identity

{{#include ../../../../banners/hacktricks-training.md}}

## Osnovne informacije

Integracija između **On-premises Active Directory (AD)** i **Azure AD** se olakšava putem **Azure AD Connect**, nudeći različite metode koje podržavaju **Single Sign-on (SSO)**. Svaka metoda, iako korisna, predstavlja potencijalne sigurnosne ranjivosti koje bi mogle biti iskorišćene za kompromitovanje cloud ili on-premises okruženja:

- **Pass-Through Authentication (PTA)**:
- Moguća kompromitacija agenta na on-prem AD, omogućavajući validaciju korisničkih lozinki za Azure konekcije (on-prem do Cloud).
- Mogućnost registracije novog agenta za validaciju autentifikacija na novoj lokaciji (Cloud do on-prem).

{{#ref}}
pta-pass-through-authentication.md
{{#endref}}

- **Password Hash Sync (PHS)**:
- Potencijalno vađenje lozinki u čistom tekstu privilegovanih korisnika iz AD, uključujući kredencijale visoko privilegovanog, automatski generisanog AzureAD korisnika.

{{#ref}}
phs-password-hash-sync.md
{{#endref}}

- **Federation**:
- Krađa privatnog ključa korišćenog za SAML potpisivanje, omogućavajući impersonaciju on-prem i cloud identiteta.

{{#ref}}
federation.md
{{#endref}}

- **Seamless SSO:**
- Krađa lozinke korisnika `AZUREADSSOACC`, koja se koristi za potpisivanje Kerberos srebrnih karata, omogućavajući impersonaciju bilo kog cloud korisnika.

{{#ref}}
seamless-sso.md
{{#endref}}

- **Cloud Kerberos Trust**:
- Mogućnost eskalacije sa Global Admin na on-prem Domain Admin manipulacijom AzureAD korisničkih imena i SIDs i zahtevom za TGT-ovima iz AzureAD.

{{#ref}}
az-cloud-kerberos-trust.md
{{#endref}}

- **Default Applications**:
- Kompromitovanje naloga Administratora aplikacija ili on-premise Sync naloga omogućava modifikaciju postavki direktorijuma, članstava u grupama, korisničkih naloga, SharePoint sajtova i OneDrive datoteka.

{{#ref}}
az-default-applications.md
{{#endref}}

Za svaku metodu integracije, sinhronizacija korisnika se vrši, a `MSOL_<installationidentifier>` nalog se kreira u on-prem AD. Važno je napomenuti da obe metode **PHS** i **PTA** olakšavaju **Seamless SSO**, omogućavajući automatsko prijavljivanje za Azure AD računare pridružene on-prem domeni.

Da biste verifikovali instalaciju **Azure AD Connect**, može se koristiti sledeća PowerShell komanda, koristeći **AzureADConnectHealthSync** modul (instaliran po defaultu sa Azure AD Connect):
```bash
Get-ADSyncConnector
```
{{#include ../../../../banners/hacktricks-training.md}}
