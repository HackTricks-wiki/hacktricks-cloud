# Az AD Connect - Hybrid Identity

{{#include ../../../../banners/hacktricks-training.md}}

## Podstawowe informacje

Integracja między **On-premises Active Directory (AD)** a **Azure AD** jest ułatwiana przez **Azure AD Connect**, oferując różne metody wspierające **Single Sign-on (SSO)**. Każda metoda, choć użyteczna, przedstawia potencjalne luki w zabezpieczeniach, które mogą być wykorzystane do kompromitacji środowisk chmurowych lub lokalnych:

- **Pass-Through Authentication (PTA)**:
- Możliwa kompromitacja agenta w lokalnym AD, umożliwiająca walidację haseł użytkowników dla połączeń Azure (z lokalnego do chmury).
- Możliwość zarejestrowania nowego agenta do walidacji uwierzytelnień w nowej lokalizacji (z chmury do lokalnego).

{{#ref}}
pta-pass-through-authentication.md
{{#endref}}

- **Password Hash Sync (PHS)**:
- Potencjalne wydobycie haseł w postaci czystego tekstu użytkowników z uprawnieniami z AD, w tym poświadczeń wysoko uprzywilejowanego, automatycznie generowanego użytkownika AzureAD.

{{#ref}}
phs-password-hash-sync.md
{{#endref}}

- **Federation**:
- Kradzież klucza prywatnego używanego do podpisywania SAML, umożliwiająca podszywanie się pod tożsamości lokalne i chmurowe.

{{#ref}}
federation.md
{{#endref}}

- **Seamless SSO:**
- Kradzież hasła użytkownika `AZUREADSSOACC`, używanego do podpisywania biletów Kerberos silver, umożliwiająca podszywanie się pod dowolnego użytkownika chmurowego.

{{#ref}}
seamless-sso.md
{{#endref}}

- **Cloud Kerberos Trust**:
- Możliwość eskalacji z Global Admin do lokalnego Domain Admin poprzez manipulację nazwami użytkowników AzureAD i SID-ami oraz żądanie TGT z AzureAD.

{{#ref}}
az-cloud-kerberos-trust.md
{{#endref}}

- **Default Applications**:
- Kompromitacja konta Administratora Aplikacji lub lokalnego Konta Synchronizacji pozwala na modyfikację ustawień katalogu, członkostw w grupach, kont użytkowników, witryn SharePoint i plików OneDrive.

{{#ref}}
az-default-applications.md
{{#endref}}

Dla każdej metody integracji przeprowadzana jest synchronizacja użytkowników, a w lokalnym AD tworzony jest konto `MSOL_<installationidentifier>`. Należy zauważyć, że zarówno metody **PHS**, jak i **PTA** ułatwiają **Seamless SSO**, umożliwiając automatyczne logowanie dla komputerów Azure AD dołączonych do lokalnej domeny.

Aby zweryfikować instalację **Azure AD Connect**, można użyć następującego polecenia PowerShell, wykorzystującego moduł **AzureADConnectHealthSync** (zainstalowany domyślnie z Azure AD Connect):
```bash
Get-ADSyncConnector
```
{{#include ../../../../banners/hacktricks-training.md}}
