# Az AD Connect - Identità Ibrida

{{#include ../../../../banners/hacktricks-training.md}}

## Informazioni di Base

L'integrazione tra **Active Directory (AD) On-premises** e **Azure AD** è facilitata da **Azure AD Connect**, che offre vari metodi che supportano il **Single Sign-on (SSO)**. Ogni metodo, sebbene utile, presenta potenziali vulnerabilità di sicurezza che potrebbero essere sfruttate per compromettere gli ambienti cloud o on-premises:

- **Pass-Through Authentication (PTA)**:
- Possibile compromissione dell'agente sull'AD on-prem, consentendo la validazione delle password degli utenti per le connessioni Azure (da on-prem a Cloud).
- Fattibilità di registrare un nuovo agente per validare le autenticazioni in una nuova posizione (da Cloud a on-prem).

{{#ref}}
pta-pass-through-authentication.md
{{#endref}}

- **Password Hash Sync (PHS)**:
- Potenziale estrazione delle password in chiaro degli utenti privilegiati dall'AD, inclusi le credenziali di un utente AzureAD auto-generato ad alta privilegio.

{{#ref}}
phs-password-hash-sync.md
{{#endref}}

- **Federation**:
- Furto della chiave privata utilizzata per la firma SAML, che consente l'impersonificazione delle identità on-prem e cloud.

{{#ref}}
federation.md
{{#endref}}

- **Seamless SSO:**
- Furto della password dell'utente `AZUREADSSOACC`, utilizzata per firmare i biglietti Kerberos silver, consentendo l'impersonificazione di qualsiasi utente cloud.

{{#ref}}
seamless-sso.md
{{#endref}}

- **Cloud Kerberos Trust**:
- Possibilità di escalation da Global Admin a Domain Admin on-prem manipolando i nomi utente e gli SID degli utenti AzureAD e richiedendo TGT da AzureAD.

{{#ref}}
az-cloud-kerberos-trust.md
{{#endref}}

- **Default Applications**:
- Compromettere un account di Amministratore dell'Applicazione o l'Account di Sync on-prem consente la modifica delle impostazioni della directory, delle appartenenze ai gruppi, degli account utente, dei siti SharePoint e dei file OneDrive.

{{#ref}}
az-default-applications.md
{{#endref}}

Per ogni metodo di integrazione, viene condotta la sincronizzazione degli utenti e viene creato un account `MSOL_<installationidentifier>` nell'AD on-prem. È importante notare che sia i metodi **PHS** che **PTA** facilitano il **Seamless SSO**, consentendo l'accesso automatico per i computer Azure AD uniti al dominio on-prem.

Per verificare l'installazione di **Azure AD Connect**, può essere utilizzato il seguente comando PowerShell, che utilizza il modulo **AzureADConnectHealthSync** (installato per impostazione predefinita con Azure AD Connect):
```powershell
Get-ADSyncConnector
```
{{#include ../../../../banners/hacktricks-training.md}}
