# Az AD Connect - Гібридна ідентичність

{{#include ../../../../banners/hacktricks-training.md}}

## Основна інформація

Інтеграція між **On-premises Active Directory (AD)** та **Azure AD** здійснюється за допомогою **Azure AD Connect**, що пропонує різні методи, які підтримують **Single Sign-on (SSO)**. Кожен метод, хоча й корисний, має потенційні вразливості безпеки, які можуть бути використані для компрометації хмарних або локальних середовищ:

- **Pass-Through Authentication (PTA)**:
- Можливість компрометації агента на локальному AD, що дозволяє перевірку паролів користувачів для Azure з'єднань (з локального до Хмари).
- Можливість реєстрації нового агента для перевірки автентифікацій у новому місці (з Хмари до локального).

{{#ref}}
pta-pass-through-authentication.md
{{#endref}}

- **Password Hash Sync (PHS)**:
- Потенційне витягування паролів у відкритому тексті привілейованих користувачів з AD, включаючи облікові дані високопривілейованого, автоматично згенерованого користувача AzureAD.

{{#ref}}
phs-password-hash-sync.md
{{#endref}}

- **Federation**:
- Крадіжка приватного ключа, що використовується для підпису SAML, що дозволяє видавати себе за локальні та хмарні ідентичності.

{{#ref}}
federation.md
{{#endref}}

- **Seamless SSO:**
- Крадіжка пароля користувача `AZUREADSSOACC`, що використовується для підпису квитків Kerberos silver, що дозволяє видавати себе за будь-якого хмарного користувача.

{{#ref}}
seamless-sso.md
{{#endref}}

- **Cloud Kerberos Trust**:
- Можливість ескалації з Global Admin до локального Domain Admin шляхом маніпуляцій з іменами користувачів AzureAD та SIDs і запитом TGT з AzureAD.

{{#ref}}
az-cloud-kerberos-trust.md
{{#endref}}

- **Default Applications**:
- Компрометація облікового запису адміністратора програми або локального облікового запису синхронізації дозволяє змінювати налаштування каталогу, членство в групах, облікові записи користувачів, сайти SharePoint та файли OneDrive.

{{#ref}}
az-default-applications.md
{{#endref}}

Для кожного методу інтеграції проводиться синхронізація користувачів, і в локальному AD створюється обліковий запис `MSOL_<installationidentifier>`. Важливо, що методи **PHS** та **PTA** сприяють **Seamless SSO**, що дозволяє автоматичний вхід для комп'ютерів Azure AD, приєднаних до локального домену.

Щоб перевірити установку **Azure AD Connect**, можна використовувати наступну команду PowerShell, що використовує модуль **AzureADConnectHealthSync** (встановлений за замовчуванням з Azure AD Connect):
```powershell
Get-ADSyncConnector
```
{{#include ../../../../banners/hacktricks-training.md}}
