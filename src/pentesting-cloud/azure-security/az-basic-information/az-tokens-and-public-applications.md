# Az - Tokenlar ve Kamu Uygulamaları

{{#include ../../../banners/hacktricks-training.md}}

## Temel Bilgiler

Entra ID, Microsoft'un bulut tabanlı kimlik ve erişim yönetimi (IAM) platformudur ve Microsoft 365 ve Azure Resource Manager gibi hizmetler için temel kimlik doğrulama ve yetkilendirme sistemi olarak hizmet vermektedir. Azure AD, kaynaklara erişimi yönetmek için OAuth 2.0 yetkilendirme çerçevesini ve OpenID Connect (OIDC) kimlik doğrulama protokolünü uygular.

### OAuth

**OAuth 2.0'da Anahtar Katılımcılar:**

1. **Kaynak Sunucusu (RS):** Kaynak sahibine ait kaynakları korur.
2. **Kaynak Sahibi (RO):** Genellikle korunan kaynaklara sahip olan son kullanıcıdır.
3. **İstemci Uygulaması (CA):** Kaynak sahibinin adına kaynaklara erişim talep eden bir uygulamadır.
4. **Yetkilendirme Sunucusu (AS):** İstemci uygulamalarına erişim tokenları verir, bunları kimlik doğruladıktan ve yetkilendirdikten sonra.

**Kapsamlar ve Onay:**

- **Kapsamlar:** Erişim seviyelerini belirten, kaynak sunucusunda tanımlanan ayrıntılı izinlerdir.
- **Onay:** Bir kaynak sahibinin, belirli kapsamlarla kaynaklara erişim izni verdiği süreçtir.

**Microsoft 365 Entegrasyonu:**

- Microsoft 365, IAM için Azure AD'yi kullanır ve birden fazla "birinci taraf" OAuth uygulamasından oluşur.
- Bu uygulamalar derinlemesine entegre edilmiştir ve genellikle karşılıklı bağımlı hizmet ilişkilerine sahiptir.
- Kullanıcı deneyimini basitleştirmek ve işlevselliği sürdürmek için Microsoft, bu birinci taraf uygulamalarına "ima edilen onay" veya "ön onay" verir.
- **İma Edilen Onay:** Belirli uygulamalar, açık kullanıcı veya yönetici onayı olmaksızın **belirli kapsamlar için otomatik olarak erişim izni alır**.
- Bu ön onaylı kapsamlar genellikle hem kullanıcılar hem de yöneticiler için gizlidir, bu da onları standart yönetim arayüzlerinde daha az görünür hale getirir.

**İstemci Uygulama Türleri:**

1. **Gizli İstemciler:**
- Kendi kimlik bilgilerine (örneğin, şifreler veya sertifikalar) sahiptir.
- Yetkilendirme sunucusuna **güvenli bir şekilde kimlik doğrulaması yapabilirler**.
2. **Kamu İstemcileri:**
- Benzersiz kimlik bilgilerine sahip değildir.
- Yetkilendirme sunucusuna güvenli bir şekilde kimlik doğrulaması yapamazlar.
- **Güvenlik Etkisi:** Bir saldırgan, token talep ederken bir kamu istemci uygulamasını taklit edebilir, çünkü yetkilendirme sunucusunun uygulamanın meşruiyetini doğrulamak için bir mekanizması yoktur.

## Kimlik Doğrulama Tokenları

OIDC'de kullanılan **üç tür token** vardır:

- [**Erişim Tokenları**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** İstemci, bu tokenı kaynak sunucusuna **kaynaklara erişim** için sunar. Sadece belirli bir kullanıcı, istemci ve kaynak kombinasyonu için kullanılabilir ve **iptal edilemez**; süresi dolana kadar - bu varsayılan olarak 1 saattir.
- **ID Tokenları**: İstemci, bu **tokenı yetkilendirme sunucusundan** alır. Kullanıcı hakkında temel bilgileri içerir. **Belirli bir kullanıcı ve istemci kombinasyonuna bağlıdır**.
- **Yenileme Tokenları**: Erişim tokenı ile birlikte istemciye verilir. **Yeni erişim ve ID tokenları almak için** kullanılır. Belirli bir kullanıcı ve istemci kombinasyonuna bağlıdır ve iptal edilebilir. Varsayılan süre dolma süresi, **aktif olmayan yenileme tokenları için 90 gündür** ve **aktif tokenlar için süre dolma yoktur** (bir yenileme tokenından yeni yenileme tokenları almak mümkündür).
- Bir yenileme tokenı, bir **`aud`** ile, bazı **kapsamlarla** ve bir **kiracıyla** ilişkilendirilmelidir ve yalnızca o aud, kapsamlar (ve daha fazlası olmamak kaydıyla) ve kiracı için erişim tokenları üretebilmelidir. Ancak, bu **FOCI uygulama tokenları** için geçerli değildir.
- Bir yenileme tokenı şifrelenmiştir ve yalnızca Microsoft bunu çözebilir.
- Yeni bir yenileme tokenı almak, önceki yenileme tokenını iptal etmez.

> [!WARNING]
> **Koşullu erişim** bilgileri **JWT** içinde **saklanır**. Yani, **izin verilen bir IP adresinden token talep ederseniz**, o **IP** token içinde **saklanır** ve ardından o tokenı **izin verilmeyen bir IP'den kaynaklara erişmek için kullanabilirsiniz**.

### Erişim Tokenları "aud"

"aud" alanında belirtilen alan, giriş işlemini gerçekleştirmek için kullanılan **kaynak sunucusudur** (uygulama).

`az account get-access-token --resource-type [...]` komutu, aşağıdaki türleri destekler ve her biri sonuçta oluşan erişim tokenında belirli bir "aud" ekleyecektir:

> [!CAUTION]
> Aşağıdakilerin yalnızca `az account get-access-token` tarafından desteklenen API'ler olduğunu unutmayın, ancak daha fazlası vardır.

<details>

<summary>aud örnekleri</summary>

- **aad-graph (Azure Active Directory Graph API)**: Uygulamaların Azure Active Directory (Azure AD) içindeki dizin verilerini okumasına ve yazmasına olanak tanıyan eski Azure AD Graph API'ye (kaldırılmış) erişmek için kullanılır.
- `https://graph.windows.net/`

* **arm (Azure Resource Manager)**: Azure kaynaklarını Azure Resource Manager API'si aracılığıyla yönetmek için kullanılır. Bu, sanal makineler, depolama hesapları ve daha fazlası gibi kaynakları oluşturma, güncelleme ve silme gibi işlemleri içerir.
- `https://management.core.windows.net/ or https://management.azure.com/`

- **batch (Azure Batch Services)**: Bulutta büyük ölçekli paralel ve yüksek performanslı hesaplama uygulamalarını verimli bir şekilde etkinleştiren Azure Batch'e erişmek için kullanılır.
- `https://batch.core.windows.net/`

* **data-lake (Azure Data Lake Storage)**: Azure Data Lake Storage Gen1 ile etkileşimde bulunmak için kullanılır; bu, ölçeklenebilir bir veri depolama ve analiz hizmetidir.
- `https://datalake.azure.net/`

- **media (Azure Media Services)**: Video ve ses içeriği için bulut tabanlı medya işleme ve dağıtım hizmetleri sağlayan Azure Media Services'e erişmek için kullanılır.
- `https://rest.media.azure.net`

* **ms-graph (Microsoft Graph API)**: Microsoft 365 hizmetleri verilerine erişmek için kullanılan Microsoft Graph API'ye erişmek için kullanılır. Azure AD, Office 365, Kurumsal Mobilite ve Güvenlik hizmetleri gibi hizmetlerden veri ve içgörülere erişmenizi sağlar.
- `https://graph.microsoft.com`

- **oss-rdbms (Azure Open Source Relational Databases)**: MySQL, PostgreSQL ve MariaDB gibi açık kaynaklı ilişkisel veritabanı motorları için Azure Veritabanı hizmetlerine erişmek için kullanılır.
- `https://ossrdbms-aad.database.windows.net`

</details>

### Erişim Tokenları Kapsamları "scp"

Bir erişim tokenının kapsamı, erişim tokenı JWT'si içindeki scp anahtarında saklanır. Bu kapsamlar, erişim tokenının erişim sağladığı alanları tanımlar.

Eğer bir JWT belirli bir API ile iletişim kurmasına izin verilmişse ancak **istenen eylemi gerçekleştirmek için kapsamı yoksa**, o JWT ile **eylemi gerçekleştiremeyecektir**.

### Yenileme ve erişim tokenı alma örneği
```python
# Code example from https://github.com/secureworks/family-of-client-ids-research
import msal
import requests
import jwt
from pprint import pprint
from typing import Any, Dict, List


# LOGIN VIA CODE FLOW AUTHENTICATION
azure_cli_client = msal.PublicClientApplication(
"04b07795-8ddb-461a-bbee-02f9e1bf7b46" # ID for Azure CLI client
)
device_flow = azure_cli_client.initiate_device_flow(
scopes=["https://graph.microsoft.com/.default"]
)
print(device_flow["message"])

# Perform device code flow authentication

azure_cli_bearer_tokens_for_graph_api = azure_cli_client.acquire_token_by_device_flow(
device_flow
)
pprint(azure_cli_bearer_tokens_for_graph_api)


# DECODE JWT
def decode_jwt(base64_blob: str) -> Dict[str, Any]:
"""Decodes base64 encoded JWT blob"""
return jwt.decode(
base64_blob, options={"verify_signature": False, "verify_aud": False}
)
decoded_access_token = decode_jwt(
azure_cli_bearer_tokens_for_graph_api.get("access_token")
)
pprint(decoded_access_token)


# GET NEW ACCESS TOKEN AND REFRESH TOKEN
new_azure_cli_bearer_tokens_for_graph_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
azure_cli_bearer_tokens_for_graph_api.get("refresh_token"),
# Same scopes as original authorization
scopes=["https://graph.microsoft.com/.default"],
)
)
pprint(new_azure_cli_bearer_tokens_for_graph_api)
```
## FOCI Tokenları Yetki Yükseltme

Daha önce, yenileme tokenlarının oluşturulduğu **kapsamlar**, **uygulama** ve **kiracı** ile ilişkilendirilmesi gerektiği belirtilmişti. Bu sınırlardan herhangi biri ihlal edilirse, kullanıcının erişim sağladığı diğer kaynaklar ve kiracılar için erişim tokenları oluşturmak mümkün olacağından yetki yükseltmek mümkündür ve bu, başlangıçta amaçlandığından daha fazla kapsam ile yapılabilir.

Ayrıca, **bu, [Microsoft kimlik platformu](https://learn.microsoft.com/en-us/entra/identity-platform/) (Microsoft Entra hesapları, Microsoft kişisel hesapları ve Facebook ve Google gibi sosyal hesaplar) ile tüm yenileme tokenları için mümkündür** çünkü [**belgelerde**](https://learn.microsoft.com/en-us/entra/identity-platform/refresh-tokens) belirtildiği gibi: "Yenileme tokenları, kullanıcı ve istemci kombinasyonuna bağlıdır, ancak **bir kaynak veya kiracıya bağlı değildir**. Bir istemci, izin verildiği herhangi bir kaynak ve kiracı kombinasyonu üzerinden erişim tokenları almak için bir yenileme tokenı kullanabilir. Yenileme tokenları şifrelenmiştir ve yalnızca Microsoft kimlik platformu bunları okuyabilir."

Ayrıca, FOCI uygulamalarının kamuya açık uygulamalar olduğunu ve bu nedenle sunucuya kimlik doğrulamak için **hiçbir sır gerekmediğini** unutmayın.

Daha sonra, [**orijinal araştırmada**](https://github.com/secureworks/family-of-client-ids-research/tree/main) bildirilen bilinen FOCI istemcileri [**burada**](https://github.com/secureworks/family-of-client-ids-research/blob/main/known-foci-clients.csv) bulunabilir.

### Farklı Kapsam Al

Önceki örnek koduna devam ederek, bu kodda farklı bir kapsam için yeni bir token talep edilmektedir:
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
azure_cli_bearer_tokens_for_outlook_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
new_azure_cli_bearer_tokens_for_graph_api.get(
"refresh_token"
),
# But different scopes than original authorization
scopes=[
"https://outlook.office.com/.default"
],
)
)
pprint(azure_cli_bearer_tokens_for_outlook_api)
```
### Farklı istemci ve kapsamlar al
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
microsoft_office_client = msal.PublicClientApplication("d3590ed6-52b3-4102-aeff-aad2292ab01c")
microsoft_office_bearer_tokens_for_graph_api = (
# This is a different client application than we used in the previous examples
microsoft_office_client.acquire_token_by_refresh_token(
# But we can use the refresh token issued to our original client application
azure_cli_bearer_tokens_for_outlook_api.get("refresh_token"),
# And request different scopes too
scopes=["https://graph.microsoft.com/.default"],
)
)
# How is this possible?
pprint(microsoft_office_bearer_tokens_for_graph_api)
```
## Referanslar

- [https://github.com/secureworks/family-of-client-ids-research](https://github.com/secureworks/family-of-client-ids-research)

{{#include ../../../banners/hacktricks-training.md}}
