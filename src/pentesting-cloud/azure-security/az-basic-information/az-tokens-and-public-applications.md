# Az - Tokens & Public Applications

{{#include ../../../banners/hacktricks-training.md}}

## Temel Bilgiler

Entra ID, Microsoft'un bulut tabanlı kimlik ve erişim yönetimi (IAM) platformudur ve Microsoft 365 ve Azure Resource Manager gibi hizmetler için temel kimlik doğrulama ve yetkilendirme sistemi olarak hizmet vermektedir. Azure AD, kaynaklara erişimi yönetmek için OAuth 2.0 yetkilendirme çerçevesini ve OpenID Connect (OIDC) kimlik doğrulama protokolünü uygular.

### OAuth

**OAuth 2.0'da Anahtar Katılımcılar:**

1. **Kaynak Sunucusu (RS):** Kaynak sahibine ait kaynakları korur.
2. **Kaynak Sahibi (RO):** Genellikle korunan kaynaklara sahip olan son kullanıcıdır.
3. **İstemci Uygulaması (CA):** Kaynak sahibinin adına kaynaklara erişim talep eden bir uygulamadır.
4. **Yetkilendirme Sunucusu (AS):** İstemci uygulamalarına erişim token'ları verir, bunları kimlik doğruladıktan ve yetkilendirdikten sonra.

**Kapsamlar ve Onay:**

- **Kapsamlar:** Erişim seviyelerini belirten, kaynak sunucusunda tanımlanan ayrıntılı izinlerdir.
- **Onay:** Bir kaynak sahibinin, belirli kapsamlarla kaynaklara erişim izni verdiği süreçtir.

**Microsoft 365 Entegrasyonu:**

- Microsoft 365, IAM için Azure AD'yi kullanır ve birden fazla "birinci taraf" OAuth uygulamasından oluşur.
- Bu uygulamalar derinlemesine entegre edilmiştir ve genellikle karşılıklı bağımlı hizmet ilişkilerine sahiptir.
- Kullanıcı deneyimini basitleştirmek ve işlevselliği korumak için Microsoft, bu birinci taraf uygulamalarına "ima edilen onay" veya "ön onay" verir.
- **İma Edilen Onay:** Belirli uygulamalar, açık kullanıcı veya yönetici onayı olmaksızın belirli kapsamlarla **erişim izni alır**.
- Bu ön onaylı kapsamlar genellikle hem kullanıcılar hem de yöneticiler için gizlidir, bu da standart yönetim arayüzlerinde daha az görünür hale getirir.

**İstemci Uygulama Türleri:**

1. **Gizli İstemciler:**
- Kendi kimlik bilgilerine (örneğin, parolalar veya sertifikalar) sahiptir.
- Yetkilendirme sunucusuna **güvenli bir şekilde kimlik doğrulaması yapabilirler**.
2. **Açık İstemciler:**
- Benzersiz kimlik bilgilerine sahip değildir.
- Yetkilendirme sunucusuna güvenli bir şekilde kimlik doğrulaması yapamazlar.
- **Güvenlik Etkisi:** Bir saldırgan, token talep ederken bir açık istemci uygulamasını taklit edebilir, çünkü yetkilendirme sunucusunun uygulamanın meşruiyetini doğrulamak için bir mekanizması yoktur.

## Kimlik Doğrulama Token'ları

OIDC'de kullanılan **üç tür token** vardır:

- [**Erişim Token'ları**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** İstemci, bu token'ı kaynak sunucusuna **kaynaklara erişmek için** sunar. Sadece belirli bir kullanıcı, istemci ve kaynak kombinasyonu için kullanılabilir ve **sona erene kadar iptal edilemez** - bu varsayılan olarak 1 saattir.
- **ID Token'ları**: İstemci, bu **token'ı yetkilendirme sunucusundan** alır. Kullanıcı hakkında temel bilgileri içerir. **Belirli bir kullanıcı ve istemci kombinasyonuna bağlıdır**.
- **Refresh Token'ları**: İstemciye erişim token'ı ile birlikte verilir. **Yeni erişim ve ID token'ları almak için** kullanılır. Belirli bir kullanıcı ve istemci kombinasyonuna bağlıdır ve iptal edilebilir. Varsayılan sona erme süresi **90 gündür** inaktif refresh token'lar için ve **aktif token'lar için sona erme yoktur** (bir refresh token'dan yeni refresh token'lar almak mümkündür).
- Bir refresh token, bir **`aud`** ile, bazı **kapsamlarla** ve bir **tenant** ile ilişkilendirilmelidir ve yalnızca o aud, kapsamlar (ve daha fazlası değil) ve tenant için erişim token'ları oluşturabilmelidir. Ancak, bu **FOCI uygulama token'ları** için geçerli değildir.
- Bir refresh token şifrelenmiştir ve yalnızca Microsoft bunu çözebilir.
- Yeni bir refresh token almak, önceki refresh token'ı iptal etmez.

> [!WARNING]
> **Koşullu erişim** bilgileri **JWT** içinde **saklanır**. Yani, **izin verilen bir IP adresinden token talep ederseniz**, o **IP** token içinde **saklanır** ve ardından o token'ı **izin verilmeyen bir IP'den kaynaklara erişmek için** kullanabilirsiniz.

### Erişim Token'ları "aud"

"aud" alanında belirtilen alan, giriş yapmak için kullanılan **kaynak sunucusudur** (uygulama).

`az account get-access-token --resource-type [...]` komutu, aşağıdaki türleri destekler ve her biri sonuçta oluşan erişim token'ında belirli bir "aud" ekleyecektir:

> [!CAUTION]
> Aşağıdakilerin yalnızca `az account get-access-token` tarafından desteklenen API'ler olduğunu unutmayın, ancak daha fazlası vardır.

<details>

<summary>aud örnekleri</summary>

- **aad-graph (Azure Active Directory Graph API)**: Uygulamaların Azure Active Directory (Azure AD) içindeki dizin verilerini okumasına ve yazmasına olanak tanıyan eski Azure AD Graph API'ye (kaldırılmış) erişmek için kullanılır.
- `https://graph.windows.net/`

* **arm (Azure Resource Manager)**: Azure kaynaklarını Azure Resource Manager API'si aracılığıyla yönetmek için kullanılır. Bu, sanal makineler, depolama hesapları ve daha fazlası gibi kaynakları oluşturma, güncelleme ve silme gibi işlemleri içerir.
- `https://management.core.windows.net/ or https://management.azure.com/`

- **batch (Azure Batch Services)**: Bulutta büyük ölçekli paralel ve yüksek performanslı hesaplama uygulamalarını verimli bir şekilde etkinleştiren Azure Batch'e erişmek için kullanılır.
- `https://batch.core.windows.net/`

* **data-lake (Azure Data Lake Storage)**: Azure Data Lake Storage Gen1 ile etkileşimde bulunmak için kullanılır; bu, ölçeklenebilir bir veri depolama ve analiz hizmetidir.
- `https://datalake.azure.net/`

- **media (Azure Media Services)**: Video ve ses içeriği için bulut tabanlı medya işleme ve dağıtım hizmetleri sağlayan Azure Media Services'e erişmek için kullanılır.
- `https://rest.media.azure.net`

* **ms-graph (Microsoft Graph API)**: Microsoft 365 hizmetleri verilerine erişmek için kullanılan Microsoft Graph API'ye erişmek için kullanılır. Azure AD, Office 365, Kurumsal Mobilite ve Güvenlik hizmetleri gibi hizmetlerden veri ve içgörülere erişmenizi sağlar.
- `https://graph.microsoft.com`

- **oss-rdbms (Azure Open Source Relational Databases)**: MySQL, PostgreSQL ve MariaDB gibi açık kaynaklı ilişkisel veritabanı motorları için Azure Veritabanı hizmetlerine erişmek için kullanılır.
- `https://ossrdbms-aad.database.windows.net`

</details>

### Erişim Token'ları Kapsamları "scp"

Bir erişim token'ının kapsamı, erişim token'ı JWT'si içindeki scp anahtarında saklanır. Bu kapsamlar, erişim token'ının erişim sağladığı şeyleri tanımlar.

Eğer bir JWT belirli bir API ile iletişim kurmasına izin verilirse ancak **istenen eylemi gerçekleştirmek için kapsamı yoksa**, o JWT ile o eylemi **gerçekleştiremeyecektir**.

### Refresh ve erişim token'ı alma örneği
```python
# Code example from https://github.com/secureworks/family-of-client-ids-research
import msal
import requests
import jwt
from pprint import pprint
from typing import Any, Dict, List


# LOGIN VIA CODE FLOW AUTHENTICATION
azure_cli_client = msal.PublicClientApplication(
"04b07795-8ddb-461a-bbee-02f9e1bf7b46" # ID for Azure CLI client
)
device_flow = azure_cli_client.initiate_device_flow(
scopes=["https://graph.microsoft.com/.default"]
)
print(device_flow["message"])

# Perform device code flow authentication

azure_cli_bearer_tokens_for_graph_api = azure_cli_client.acquire_token_by_device_flow(
device_flow
)
pprint(azure_cli_bearer_tokens_for_graph_api)


# DECODE JWT
def decode_jwt(base64_blob: str) -> Dict[str, Any]:
"""Decodes base64 encoded JWT blob"""
return jwt.decode(
base64_blob, options={"verify_signature": False, "verify_aud": False}
)
decoded_access_token = decode_jwt(
azure_cli_bearer_tokens_for_graph_api.get("access_token")
)
pprint(decoded_access_token)


# GET NEW ACCESS TOKEN AND REFRESH TOKEN
new_azure_cli_bearer_tokens_for_graph_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
azure_cli_bearer_tokens_for_graph_api.get("refresh_token"),
# Same scopes as original authorization
scopes=["https://graph.microsoft.com/.default"],
)
)
pprint(new_azure_cli_bearer_tokens_for_graph_api)
```
### Diğer erişim jetonu alanları

- **appid**: Jetonu oluşturmak için kullanılan Uygulama Kimliği
- **appidacr**: Uygulama Kimlik Doğrulama Bağlamı Sınıf Referansı, istemcinin nasıl kimlik doğrulandığını gösterir; kamu istemcisi için değer 0'dır, eğer bir istemci sırrı kullanılıyorsa değer 1'dir.
- **acr**: Kimlik Doğrulama Bağlamı Sınıf Referansı talebi "0" olduğunda, son kullanıcı kimlik doğrulaması ISO/IEC 29115 gereksinimlerini karşılamamıştır.
- **amr**: Kimlik doğrulama yöntemi, jetonun nasıl kimlik doğrulandığını gösterir. "pwd" değeri, bir şifre kullanıldığını belirtir.
- **groups**: Prensipin üyesi olduğu grupları gösterir.
- **iss**: Jetonu üreten güvenlik jetonu hizmetini (STS) tanımlar. örn. https://sts.windows.net/fdd066e1-ee37-49bc-b08f-d0e152119b04/ (uuid, kiracı kimliğidir)
- **oid**: Prensipin nesne kimliği
- **tid**: Kiracı kimliği
- **iat, nbf, exp**: Verildiği zaman (ne zaman verildi), Önce değil (bu zamandan önce kullanılamaz, genellikle iat ile aynı değerdir), Süre sonu.

## FOCI Jetonları Yetki Yükseltme

Daha önce, yenileme jetonlarının oluşturulduğu **kapsamlar**, **uygulama** ve **kiracı** ile ilişkilendirilmesi gerektiği belirtilmişti. Bu sınırlardan herhangi biri ihlal edilirse, kullanıcının erişim sağladığı diğer kaynaklar ve kiracılar için erişim jetonları oluşturmak mümkün olacağından yetki yükseltmek mümkündür ve bu, başlangıçta amaçlandığından daha fazla kapsamla yapılabilir.

Ayrıca, **bu, [Microsoft kimlik platformu](https://learn.microsoft.com/en-us/entra/identity-platform/) (Microsoft Entra hesapları, Microsoft kişisel hesapları ve Facebook ve Google gibi sosyal hesaplar) ile tüm yenileme jetonları için mümkündür** çünkü [**belgelerde**](https://learn.microsoft.com/en-us/entra/identity-platform/refresh-tokens) belirtildiği gibi: "Yenileme jetonları, kullanıcı ve istemci kombinasyonuna bağlıdır, ancak **bir kaynak veya kiracıya bağlı değildir**. Bir istemci, izin verildiği her kaynak ve kiracı kombinasyonu için erişim jetonları almak üzere bir yenileme jetonu kullanabilir. Yenileme jetonları şifrelenmiştir ve yalnızca Microsoft kimlik platformu bunları okuyabilir."

Ayrıca, FOCI uygulamalarının kamuya açık uygulamalar olduğunu ve bu nedenle **sunucuya kimlik doğrulamak için bir sır gerekmediğini** unutmayın.

Daha sonra, [**orijinal araştırmada**](https://github.com/secureworks/family-of-client-ids-research/tree/main) bildirilen bilinen FOCI istemcileri [**burada**](https://github.com/secureworks/family-of-client-ids-research/blob/main/known-foci-clients.csv) bulunabilir.

### Farklı kapsam al

Önceki örnek koduna devam ederek, bu kodda farklı bir kapsam için yeni bir jeton talep edilmektedir:
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
azure_cli_bearer_tokens_for_outlook_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
new_azure_cli_bearer_tokens_for_graph_api.get(
"refresh_token"
),
# But different scopes than original authorization
scopes=[
"https://outlook.office.com/.default"
],
)
)
pprint(azure_cli_bearer_tokens_for_outlook_api)
```
### Farklı istemci ve kapsamlar alın
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
microsoft_office_client = msal.PublicClientApplication("d3590ed6-52b3-4102-aeff-aad2292ab01c")
microsoft_office_bearer_tokens_for_graph_api = (
# This is a different client application than we used in the previous examples
microsoft_office_client.acquire_token_by_refresh_token(
# But we can use the refresh token issued to our original client application
azure_cli_bearer_tokens_for_outlook_api.get("refresh_token"),
# And request different scopes too
scopes=["https://graph.microsoft.com/.default"],
)
)
# How is this possible?
pprint(microsoft_office_bearer_tokens_for_graph_api)
```
## Tokenları nerede bulabilirsiniz

Saldırganlar açısından, bir kurbanın PC'si ele geçirildiğinde erişim ve yenileme tokenlarının nerede bulunabileceğini bilmek oldukça ilginçtir:

- **`<HOME>/.Azure`** içinde
- **`azureProfile.json`** geçmişte oturum açmış kullanıcılar hakkında bilgi içerir
- **`clouds.config`** abonelikler hakkında bilgi içerir
- **`service_principal_entries.json`** uygulama kimlik bilgilerini (tenant id, client ve secret) içerir. Sadece Linux ve macOS'ta
- **`msal_token_cache.json`** erişim tokenlarını ve yenileme tokenlarını içerir. Sadece Linux ve macOS'ta
- **`service_principal_entries.bin`** ve **`msal_token_cache.bin`** Windows'ta kullanılır ve DPAPI ile şifrelenmiştir
- **`msal_http_cache.bin`** HTTP isteği önbelleğidir
- Yükleyin: `with open("msal_http_cache.bin", 'rb') as f: pickle.load(f)`
- **`AzureRmContext.json`** Az PowerShell kullanarak önceki oturum açma bilgilerini içerir (ancak kimlik bilgileri yoktur)
- **`C:\Users\<username>\AppData\Local\Microsoft\IdentityCache\*`** içinde, kullanıcıların DPAPI ile şifrelenmiş **erişim tokenları**, ID tokenları ve hesap bilgileri içeren birkaç `.bin` dosyası bulunmaktadır.
- **`C:\Users\<username>\AppData\Local\Microsoft\TokenBroken\Cache\`** içindeki `.tbres` dosyalarında daha fazla **erişim tokenı** bulmak mümkündür; bu dosyalar DPAPI ile şifrelenmiş base64 içerir.
- Linux ve macOS'ta, `pwsh -Command "Save-AzContext -Path /tmp/az-context.json"` komutunu çalıştırarak Az PowerShell'den **erişim tokenları, yenileme tokenları ve id tokenları** alabilirsiniz (kullanıldıysa).
- Windows'ta bu sadece id tokenları üretir.
- Linux ve macOS'ta Az PowerShell'in kullanılıp kullanılmadığını kontrol etmek için `$HOME/.local/share/.IdentityService/` dizininin var olup olmadığını kontrol edebilirsiniz (içindeki dosyalar boş ve işe yaramaz olsa da).
- Kullanıcı **tarayıcı ile Azure'a giriş yaptıysa**, bu [**gönderiye**](https://www.infosecnoodle.com/p/obtaining-microsoft-entra-refresh?r=357m16&utm_campaign=post&utm_medium=web) göre, **localhost'a yönlendirme** ile kimlik doğrulama akışını başlatmak, tarayıcının otomatik olarak giriş yetkisini vermesini sağlamak ve yenileme tokenını almak mümkündür. Yalnızca localhost'a yönlendirmeye izin veren birkaç FOCI uygulaması (az cli veya powershell modülü gibi) olduğunu unutmayın, bu nedenle bu uygulamaların izinli olması gerekir.

## Referanslar

- [https://github.com/secureworks/family-of-client-ids-research](https://github.com/secureworks/family-of-client-ids-research)
- [https://github.com/Huachao/azure-content/blob/master/articles/active-directory/active-directory-token-and-claims.md](https://github.com/Huachao/azure-content/blob/master/articles/active-directory/active-directory-token-and-claims.md)

{{#include ../../../banners/hacktricks-training.md}}
