# Az - Tokens & Public Applications

{{#include ../../../banners/hacktricks-training.md}}

## Temel Bilgiler

Entra ID, Microsoft'un bulut tabanlı kimlik ve erişim yönetimi (IAM) platformudur ve Microsoft 365 ve Azure Resource Manager gibi hizmetler için temel kimlik doğrulama ve yetkilendirme sistemi olarak hizmet verir. Azure AD, kaynaklara erişimi yönetmek için OAuth 2.0 authorization framework ve OpenID Connect (OIDC) authentication protocolünü uygular.

### OAuth

**OAuth 2.0'deki Temel Katılımcılar:**

1. **Resource Server (RS):** Kaynak sahibine ait kaynakları koruyan sunucu.
2. **Resource Owner (RO):** Genellikle korunan kaynaklara sahip olan son kullanıcı.
3. **Client Application (CA):** Resource owner adına kaynaklara erişim talep eden uygulama.
4. **Authorization Server (AS):** İstemci uygulamaları kimlik doğruladıktan ve yetkilendirdikten sonra onlara access tokenlar verir.

**Scopes ve Onay:**

- **Scopes:** Kaynak sunucuda tanımlanmış, erişim düzeylerini belirleyen ayrıntılı izinler.
- **Consent (Onay):** Resource owner'ın, istemci uygulamaya belirli scope'larla kaynaklara erişim izni vermesi süreci.

**Microsoft 365 Entegrasyonu:**

- Microsoft 365, IAM için Azure AD'yi kullanır ve birden fazla "first-party" OAuth uygulamasından oluşur.
- Bu uygulamalar derin entegrasyonludur ve genellikle birbirine bağımlı servis ilişkilerine sahiptir.
- Kullanıcı deneyimini basitleştirmek ve işlevselliği korumak için Microsoft, bu first-party uygulamalara "implied consent" veya "pre-consent" verir.
- **Implied Consent:** Belirli uygulamalara, açık bir kullanıcı veya yönetici onayı olmadan belirli scope'lara otomatik olarak **erişim verilmesi**.
- Bu ön-onaylı scope'lar genellikle hem kullanıcıların hem de yöneticilerin standart yönetim arayüzlerinde görülmesini zorlaştıracak şekilde gizlenir.

**Client Application Türleri:**

1. **Confidential Clients:**
- Kendi kimlik bilgilerine (ör. parola veya sertifika) sahiptir.
- Authorization server'a kendilerini **güvenli şekilde kimlik doğrulayabilirler**.
2. **Public Clients:**
- Benzersiz kimlik bilgileri yoktur.
- Authorization server'a güvenli şekilde kimlik doğrulayamazlar.
- **Güvenlik Etkisi:** Authorization server, uygulamanın meşruiyetini doğrulayamadığı için bir saldırgan public client uygulamasını taklit ederek token isteyebilir.

## Authentication Tokens

OIDC'de kullanılan **üç tür token** vardır:

- [**Access Tokens**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** İstemci, kaynaklara **erişim sağlamak** için bu token'ı resource server'a sunar. Sadece belirli bir kullanıcı, istemci ve kaynak kombinasyonu için kullanılabilir ve süresi dolana kadar **iptal edilemez** — varsayılan olarak bu süre 1 saattir.
- **ID Tokens**: İstemci, bu token'ı authorization server'dan alır. Kullanıcı hakkında temel bilgileri içerir. **Belirli bir kullanıcı ve istemci kombinasyonuna bağlıdır.**
- **Refresh Tokens**: İstemciye access token ile birlikte verilir. Yeni access ve ID token'lar **almak** için kullanılır. Belirli bir kullanıcı ve istemci kombinasyonuna bağlıdır ve iptal edilebilir. Varsayılan sona erme süresi, etkin olmayan refresh tokenlar için **90 gündür** ve **etkin tokenlar için sona erme yoktur** (bir refresh token'dan yeni refresh token almak mümkündür).
- Bir refresh token bir **`aud`**'a, bazı **scopes**'lara ve bir **tenant**a bağlı olmalı ve yalnızca o aud, scope'lar (ve daha fazlası değil) ve tenant için access token üretebilmelidir. Ancak bu, **FOCI applications tokens** için geçerli değildir.
- Bir refresh token şifrelenmiştir ve yalnızca Microsoft bunu deşifre edebilir.
- Yeni bir refresh token almak, önceki refresh token'ı iptal etmez.

> [!WARNING]
> Conditional access bilgisi **JWT** içinde **saklanır**. Bu yüzden, **token'ı izin verilen bir IP adresinden talep ederseniz**, o **IP** token içinde **saklanır** ve daha sonra bu token'ı izin verilmeyen bir IP'den kullanarak kaynaklara erişebilirsiniz.

### Access Tokens "aud"

"`aud`" alanında belirtilen değer, giriş yapmak için kullanılan **resource server** (uygulama) içindir.

`az account get-access-token --resource-type [...]` komutu aşağıdaki türleri destekler ve her biri elde edilen access token içinde spesifik bir "aud" ekleyecektir:

> [!CAUTION]
> Aşağıdakilerin yalnızca `az account get-access-token` tarafından desteklenen API'ler olduğunu, ancak daha fazlasının olduğunu unutmayın.

<details>

<summary>aud örnekleri</summary>

- **aad-graph (Azure Active Directory Graph API)**: Eski Azure AD Graph API'ye (deprecated) erişmek için kullanılır; uygulamaların Azure Active Directory (Azure AD) içinde dizin verilerini okumasına ve yazmasına izin verir.
- `https://graph.windows.net/`

* **arm (Azure Resource Manager)**: Azure Resource Manager API aracılığıyla Azure kaynaklarını yönetmek için kullanılır. Bu, sanal makineler, depolama hesapları ve benzeri kaynakları oluşturma, güncelleme ve silme gibi işlemleri içerir.
- `https://management.core.windows.net/ or https://management.azure.com/`

- **batch (Azure Batch Services)**: Büyük ölçekli paralel ve yüksek performanslı hesaplama uygulamalarını bulutta verimli bir şekilde çalıştırmayı sağlayan Azure Batch'e erişim için kullanılır.
- `https://batch.core.windows.net/`

* **data-lake (Azure Data Lake Storage)**: Azure Data Lake Storage Gen1 ile etkileşim için kullanılır; bu, ölçeklenebilir veri depolama ve analitik hizmetidir.
- `https://datalake.azure.net/`

- **media (Azure Media Services)**: Video ve ses içeriği için bulut tabanlı medya işleme ve dağıtım hizmetleri sağlayan Azure Media Services'a erişim için kullanılır.
- `https://rest.media.azure.net`

* **ms-graph (Microsoft Graph API)**: Microsoft 365 hizmet verileri için birleşik uç nokta olan Microsoft Graph API'ye erişmek için kullanılır. Azure AD, Office 365, Enterprise Mobility ve Security hizmetleri gibi servislerden veri ve içgörüler elde etmenizi sağlar.
- `https://graph.microsoft.com`

- **oss-rdbms (Azure Open Source Relational Databases)**: MySQL, PostgreSQL ve MariaDB gibi açık kaynak ilişkisel veritabanı motorları için Azure Database hizmetlerine erişmek için kullanılır.
- `https://ossrdbms-aad.database.windows.net`

</details>

### Access Tokens Scopes "scp"

Access token'ın scope'u, access token JWT içindeki scp anahtarında saklanır. Bu scope'lar, access token'ın neye erişimi olduğunu tanımlar.

Eğer bir JWT belirli bir API ile iletişim kurmaya izinliyse ama istenen işlemi yapacak scope'a **sahip değilse**, o JWT ile işlemi **gerçekleştiremez**.

### Get refresh & access token example
```python
# Code example from https://github.com/secureworks/family-of-client-ids-research
import msal
import requests
import jwt
from pprint import pprint
from typing import Any, Dict, List


# LOGIN VIA CODE FLOW AUTHENTICATION
azure_cli_client = msal.PublicClientApplication(
"00b41c95-dab0-4487-9791-b9d2c32c80f2" # ID for Office 365 Management
)
device_flow = azure_cli_client.initiate_device_flow(
scopes=["https://graph.microsoft.com/.default"]
)
print(device_flow["message"])

# Perform device code flow authentication

azure_cli_bearer_tokens_for_graph_api = azure_cli_client.acquire_token_by_device_flow(
device_flow
)
pprint(azure_cli_bearer_tokens_for_graph_api)


# DECODE JWT
def decode_jwt(base64_blob: str) -> Dict[str, Any]:
"""Decodes base64 encoded JWT blob"""
return jwt.decode(
base64_blob, options={"verify_signature": False, "verify_aud": False}
)
decoded_access_token = decode_jwt(
azure_cli_bearer_tokens_for_graph_api.get("access_token")
)
pprint(decoded_access_token)


# GET NEW ACCESS TOKEN AND REFRESH TOKEN
new_azure_cli_bearer_tokens_for_graph_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
azure_cli_bearer_tokens_for_graph_api.get("refresh_token"),
# Same scopes as original authorization
scopes=["https://graph.microsoft.com/.default"],
)
)
pprint(new_azure_cli_bearer_tokens_for_graph_api)
```
### Diğer access token alanları

- **appid**: Token'i oluşturmak için kullanılan Application ID
- **appidacr**: The Application Authentication Context Class Reference, istemcinin nasıl kimlik doğrulandığını gösterir; public client için değer 0, client secret kullanıldıysa değer 1'dir
- **acr**: Authentication Context Class Reference bildirimi, son-kullanıcı kimlik doğrulaması ISO/IEC 29115 gereksinimlerini karşılamadıysa "0" olur.
- **amr**: Authentication method, token'in nasıl doğrulandığını gösterir. “pwd” değeri bir parolanın kullanıldığını gösterir.
- **groups**: Öznenin üye olduğu grupları gösterir.
- **iss**: Token'i oluşturan security token service (STS) sağlayıcısını tanımlar. e.g. https://sts.windows.net/fdd066e1-ee37-49bc-b08f-d0e152119b04/ (the uuid is the tenant ID)
- **oid**: Öznenin object ID'si
- **tid**: Tenant ID
- **iat, nbf, exp**: Issued at (veriliş zamanı), Not before (bu zamandan önce kullanılamaz, genelde aynı değer iat), Expiration time (sona erme zamanı).


## FOCI Tokens Privilege Escalation

Daha önce, refresh tokens'in üretildiği **scopes**'a, üretildiği **application**'a ve **tenant**'a bağlı olması gerektiği belirtilmişti. Bu sınırların herhangi biri kırılırsa, kullanıcının erişimi olan diğer kaynaklar ve tenant'lar için ve orijinal amaçlanandan daha fazla scope ile access token'lar üretmek mümkün olacağından privilege escalation mümkün olur.

Dahası, **bu, Microsoft identity platform'daki tüm refresh token'larla mümkündür** (Microsoft Entra accounts, Microsoft personal accounts, and social accounts like Facebook and Google) çünkü [**docs**] şöyle diyor: "Refresh tokens are bound to a combination of user and client, but **aren't tied to a resource or tenant**. A client can use a refresh token to acquire access tokens **across any combination of resource and tenant** where it has permission to do so. Refresh tokens are encrypted and only the Microsoft identity platform can read them."

Ayrıca, FOCI uygulamalarının public applications olduğunu unutmayın; bu yüzden sunucuya kimlik doğrulamak için **hiçbir secret gerekmez**.

Then known FOCI clients reported in the [**original research**] can be [**found here**].

### Farklı scope almak

Önceki örnek koda devam ederek, bu kodda farklı bir scope için yeni bir token isteniyor:
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
azure_cli_bearer_tokens_for_outlook_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
new_azure_cli_bearer_tokens_for_graph_api.get(
"refresh_token"
),
# But different scopes than original authorization
scopes=[
"https://outlook.office.com/.default"
],
)
)
pprint(azure_cli_bearer_tokens_for_outlook_api)
```
### Farklı client ve scopes edinin
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
microsoft_office_client = msal.PublicClientApplication("d3590ed6-52b3-4102-aeff-aad2292ab01c")
microsoft_office_bearer_tokens_for_graph_api = (
# This is a different client application than we used in the previous examples
microsoft_office_client.acquire_token_by_refresh_token(
# But we can use the refresh token issued to our original client application
azure_cli_bearer_tokens_for_outlook_api.get("refresh_token"),
# And request different scopes too
scopes=["https://graph.microsoft.com/.default"],
)
)
# How is this possible?
pprint(microsoft_office_bearer_tokens_for_graph_api)
```
## Tokenler nerede bulunur

Bir saldırganın bakış açısından, örneğin bir kurbanın PC'si ele geçirildiğinde access ve refresh token'ların nerede bulunabileceğini bilmek çok ilginçtir:

- İçinde **`<HOME>/.Azure`**
- **`azureProfile.json`** geçmişte oturum açmış kullanıcılarla ilgili bilgiler içerir
- **`clouds.config contains`** aboneliklerle ilgili bilgiler içerir
- **`service_principal_entries.json`** uygulama kimlik bilgilerini içerir (tenant id, clients ve secret). Sadece Linux & macOS
- **`msal_token_cache.json`** access tokens ve refresh tokens içerir. Sadece Linux & macOS
- **`service_principal_entries.bin`** ve msal_token_cache.bin Windows'ta kullanılır ve DPAPI ile şifrelenir
- **`msal_http_cache.bin`** HTTP isteklerinin bir cache'idir
- Yüklemek için: `with open("msal_http_cache.bin", 'rb') as f: pickle.load(f)`
- **`AzureRmContext.json`** Az PowerShell kullanılarak yapılan önceki logins ile ilgili bilgiler içerir (ancak kimlik bilgisi içermez)
- İçinde **`C:\Users\<username>\AppData\Local\Microsoft\IdentityCache\*`** birkaç `.bin` dosyası bulunur; bunlar kullanıcının DPAPI'si ile şifrelenmiş **access tokens**, ID tokens ve hesap bilgilerini içerir.
- Daha fazla **access tokens** `C:\Users\<username>\AppData\Local\Microsoft\TokenBroken\Cache\` içindeki `.tbres` dosyalarında bulunabilir; bu dosyalar access token'ları DPAPI ile şifrelenmiş base64 formatında içerir.
- Linux ve macOS'ta Az PowerShell (kullanıldıysa) ile `pwsh -Command "Save-AzContext -Path /tmp/az-context.json"` komutunu çalıştırarak **access tokens, refresh tokens ve id tokens** elde edebilirsiniz
- Windows'ta bu sadece id token'ları üretir.
- Linux ve macOS'ta Az PowerShell'in kullanılıp kullanılmadığını `$HOME/.local/share/.IdentityService/` dizininin var olup olmadığına bakarak görebilirsiniz (ancak içindeki dosyalar genellikle boş ve işe yaramaz)
- If the user is **logged inside Azure with the browser**, according to this [**post**](https://www.infosecnoodle.com/p/obtaining-microsoft-entra-refresh?r=357m16&utm_campaign=post&utm_medium=web) it's possible to start the authentication flow with a **redirect to localhost**, make the browser automatically authorize the login, and receive the resh token. Note that there are only a few FOCI applications that allow redicet to localhost (like az cli or the powershell module), so these applications must be allowed.
- Blogda açıklanan bir diğer seçenek, herhangi bir uygulamayı kullanabilen [**BOF-entra-authcode-flow**](https://github.com/sudonoodle/BOF-entra-authcode-flow) aracını kullanmaktır; çünkü bu araç `https://login.microsoftonline.com/common/oauth2/nativeclient` redirect URI'sini kullanarak nihai auth sayfasının başlığından OAuth kodunu alıp ardından refresh token elde edecektir.

## Referanslar

- [https://github.com/secureworks/family-of-client-ids-research](https://github.com/secureworks/family-of-client-ids-research)
- [https://github.com/Huachao/azure-content/blob/master/articles/active-directory/active-directory-token-and-claims.md](https://github.com/Huachao/azure-content/blob/master/articles/active-directory/active-directory-token-and-claims.md)

{{#include ../../../banners/hacktricks-training.md}}
