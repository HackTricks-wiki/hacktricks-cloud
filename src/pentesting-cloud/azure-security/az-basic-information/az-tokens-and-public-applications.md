# Az - Tokens & Public Applications

{{#include ../../../banners/hacktricks-training.md}}

## 基本信息

Entra ID 是微软基于云的身份和访问管理 (IAM) 平台，作为 Microsoft 365 和 Azure Resource Manager 等服务的基础认证和授权系统。Azure AD 实现了 OAuth 2.0 授权框架和 OpenID Connect (OIDC) 认证协议，以管理对资源的访问。

### OAuth

**OAuth 2.0 的关键参与者：**

1. **资源服务器 (RS)：** 保护资源所有者拥有的资源。
2. **资源所有者 (RO)：** 通常是拥有受保护资源的最终用户。
3. **客户端应用程序 (CA)：** 代表资源所有者请求访问资源的应用程序。
4. **授权服务器 (AS)：** 在验证和授权客户端应用程序后向其发放访问令牌。

**范围和同意：**

- **范围：** 在资源服务器上定义的细粒度权限，指定访问级别。
- **同意：** 资源所有者授予客户端应用程序访问特定范围资源的权限的过程。

**Microsoft 365 集成：**

- Microsoft 365 利用 Azure AD 进行 IAM，并由多个“第一方”OAuth 应用程序组成。
- 这些应用程序深度集成，通常具有相互依赖的服务关系。
- 为了简化用户体验并保持功能，微软对这些第一方应用程序授予“隐含同意”或“预先同意”。
- **隐含同意：** 某些应用程序在没有明确用户或管理员批准的情况下**自动获得对特定范围的访问权限**。
- 这些预先同意的范围通常对用户和管理员都是隐藏的，使其在标准管理界面中不太可见。

**客户端应用程序类型：**

1. **机密客户端：**
- 拥有自己的凭据（例如，密码或证书）。
- 可以**安全地向授权服务器进行身份验证**。
2. **公共客户端：**
- 没有唯一凭据。
- 不能安全地向授权服务器进行身份验证。
- **安全隐患：** 攻击者可以在请求令牌时冒充公共客户端应用程序，因为授权服务器没有机制来验证应用程序的合法性。

## 认证令牌

在 OIDC 中使用**三种类型的令牌**：

- [**访问令牌**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** 客户端将此令牌呈现给资源服务器以**访问资源**。它只能用于特定的用户、客户端和资源组合，并且**在到期之前无法被撤销** - 默认情况下为 1 小时。
- **ID 令牌**：客户端从**授权服务器**接收此**令牌**。它包含有关用户的基本信息。它**绑定到特定的用户和客户端组合**。
- **刷新令牌**：与访问令牌一起提供给客户端。用于**获取新的访问和 ID 令牌**。它绑定到特定的用户和客户端组合，并且可以被撤销。默认过期时间为**90 天**（对于不活动的刷新令牌）和**活动令牌没有过期**（可以从刷新令牌获取新的刷新令牌）。
- 刷新令牌应与**`aud`**、某些**范围**和**租户**相关联，并且只能为该 aud、范围（且不更多）和租户生成访问令牌。然而，这在**FOCI 应用程序令牌**中并非如此。
- 刷新令牌是加密的，只有微软可以解密它。
- 获取新的刷新令牌不会撤销先前的刷新令牌。

> [!WARNING]
> **条件访问**的信息存储在**JWT**中。因此，如果您从**允许的 IP 地址**请求**令牌**，该**IP**将被**存储**在令牌中，然后您可以从**不允许的 IP 访问资源**使用该令牌。

### 访问令牌 "aud"

“aud”字段中指示的字段是用于执行登录的**资源服务器**（应用程序）。

命令 `az account get-access-token --resource-type [...]` 支持以下类型，每种类型将在结果访问令牌中添加特定的“aud”：

> [!CAUTION]
> 请注意，以下仅是 `az account get-access-token` 支持的 API，但还有更多。

<details>

<summary>aud 示例</summary>

- **aad-graph (Azure Active Directory Graph API)**：用于访问遗留的 Azure AD Graph API（已弃用），允许应用程序读取和写入 Azure Active Directory (Azure AD) 中的目录数据。
- `https://graph.windows.net/`

* **arm (Azure Resource Manager)**：用于通过 Azure Resource Manager API 管理 Azure 资源。这包括创建、更新和删除虚拟机、存储帐户等资源的操作。
- `https://management.core.windows.net/ or https://management.azure.com/`

- **batch (Azure Batch Services)**：用于访问 Azure Batch，这是一项服务，可在云中高效地启用大规模并行和高性能计算应用程序。
- `https://batch.core.windows.net/`

* **data-lake (Azure Data Lake Storage)**：用于与 Azure Data Lake Storage Gen1 交互，这是一项可扩展的数据存储和分析服务。
- `https://datalake.azure.net/`

- **media (Azure Media Services)**：用于访问 Azure Media Services，提供基于云的视频和音频内容处理和交付服务。
- `https://rest.media.azure.net`

* **ms-graph (Microsoft Graph API)**：用于访问 Microsoft Graph API，这是 Microsoft 365 服务数据的统一端点。它允许您访问 Azure AD、Office 365、企业移动性和安全服务等服务的数据和见解。
- `https://graph.microsoft.com`

- **oss-rdbms (Azure Open Source Relational Databases)**：用于访问 Azure 数据库服务，支持开源关系数据库引擎，如 MySQL、PostgreSQL 和 MariaDB。
- `https://ossrdbms-aad.database.windows.net`

</details>

### 访问令牌范围 "scp"

访问令牌的范围存储在访问令牌 JWT 内的 scp 键中。这些范围定义了访问令牌可以访问的内容。

如果 JWT 被允许联系特定 API，但**没有范围**来执行请求的操作，它**将无法使用该 JWT 执行该操作**。

### 获取刷新和访问令牌示例
```python
# Code example from https://github.com/secureworks/family-of-client-ids-research
import msal
import requests
import jwt
from pprint import pprint
from typing import Any, Dict, List


# LOGIN VIA CODE FLOW AUTHENTICATION
azure_cli_client = msal.PublicClientApplication(
"04b07795-8ddb-461a-bbee-02f9e1bf7b46" # ID for Azure CLI client
)
device_flow = azure_cli_client.initiate_device_flow(
scopes=["https://graph.microsoft.com/.default"]
)
print(device_flow["message"])

# Perform device code flow authentication

azure_cli_bearer_tokens_for_graph_api = azure_cli_client.acquire_token_by_device_flow(
device_flow
)
pprint(azure_cli_bearer_tokens_for_graph_api)


# DECODE JWT
def decode_jwt(base64_blob: str) -> Dict[str, Any]:
"""Decodes base64 encoded JWT blob"""
return jwt.decode(
base64_blob, options={"verify_signature": False, "verify_aud": False}
)
decoded_access_token = decode_jwt(
azure_cli_bearer_tokens_for_graph_api.get("access_token")
)
pprint(decoded_access_token)


# GET NEW ACCESS TOKEN AND REFRESH TOKEN
new_azure_cli_bearer_tokens_for_graph_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
azure_cli_bearer_tokens_for_graph_api.get("refresh_token"),
# Same scopes as original authorization
scopes=["https://graph.microsoft.com/.default"],
)
)
pprint(new_azure_cli_bearer_tokens_for_graph_api)
```
### 其他访问令牌字段

- **appid**: 用于生成令牌的应用程序 ID
- **appidacr**: 应用程序身份验证上下文类引用指示客户端的身份验证方式，对于公共客户端，值为 0，如果使用了客户端密钥，则值为 1
- **acr**: 身份验证上下文类引用声明在最终用户身份验证未满足 ISO/IEC 29115 的要求时为 "0"。
- **amr**: 身份验证方法指示令牌是如何被验证的。值为“pwd”表示使用了密码。
- **groups**: 指示主体是哪些组的成员。
- **iss**: 发行者标识生成令牌的安全令牌服务 (STS)。例如 https://sts.windows.net/fdd066e1-ee37-49bc-b08f-d0e152119b04/（uuid 是租户 ID）
- **oid**: 主体的对象 ID
- **tid**: 租户 ID
- **iat, nbf, exp**: 签发时间（何时签发）、不早于（在此时间之前不能使用，通常与 iat 相同）、过期时间。

## FOCI 令牌特权提升

之前提到过，刷新令牌应与生成时的 **scopes**、**应用程序**和 **租户** 绑定。如果打破了这些边界，可能会提升特权，因为将能够生成访问其他资源和租户的访问令牌，用户可以访问这些资源，并且具有比最初预期更多的范围。

此外，**所有刷新令牌都可以这样做** 在 [Microsoft identity platform](https://learn.microsoft.com/en-us/entra/identity-platform/)（Microsoft Entra 账户、Microsoft 个人账户以及 Facebook 和 Google 等社交账户）中，因为正如 [**文档**](https://learn.microsoft.com/en-us/entra/identity-platform/refresh-tokens) 所提到的：“刷新令牌绑定于用户和客户端的组合，但 **不绑定于资源或租户**。客户端可以使用刷新令牌获取 **在其有权限的任何资源和租户组合** 中的访问令牌。刷新令牌是加密的，只有 Microsoft identity platform 可以读取它们。”

此外，请注意 FOCI 应用程序是公共应用程序，因此 **不需要密钥** 来进行服务器身份验证。

然后在 [**原始研究**](https://github.com/secureworks/family-of-client-ids-research/tree/main) 中报告的已知 FOCI 客户端可以 [**在这里找到**](https://github.com/secureworks/family-of-client-ids-research/blob/main/known-foci-clients.csv)。

### 获取不同的范围

继续之前的示例代码，在此代码中请求了一个不同范围的新令牌：
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
azure_cli_bearer_tokens_for_outlook_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
new_azure_cli_bearer_tokens_for_graph_api.get(
"refresh_token"
),
# But different scopes than original authorization
scopes=[
"https://outlook.office.com/.default"
],
)
)
pprint(azure_cli_bearer_tokens_for_outlook_api)
```
### 获取不同的客户端和范围
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
microsoft_office_client = msal.PublicClientApplication("d3590ed6-52b3-4102-aeff-aad2292ab01c")
microsoft_office_bearer_tokens_for_graph_api = (
# This is a different client application than we used in the previous examples
microsoft_office_client.acquire_token_by_refresh_token(
# But we can use the refresh token issued to our original client application
azure_cli_bearer_tokens_for_outlook_api.get("refresh_token"),
# And request different scopes too
scopes=["https://graph.microsoft.com/.default"],
)
)
# How is this possible?
pprint(microsoft_office_bearer_tokens_for_graph_api)
```
## 找到令牌的地方

从攻击者的角度来看，了解在受害者的PC被攻破时，在哪里可以找到访问令牌和刷新令牌是非常有趣的：

- 在 **`<HOME>/.Azure`**
- **`azureProfile.json`** 包含过去登录用户的信息
- **`clouds.config` 包含** 订阅的信息
- **`service_principal_entries.json`** 包含应用程序凭据（租户ID、客户端和密钥）。仅在Linux和macOS上
- **`msal_token_cache.json`** 包含访问令牌和刷新令牌。仅在Linux和macOS上
- **`service_principal_entries.bin`** 和 **`msal_token_cache.bin`** 在Windows中使用，并使用DPAPI加密
- **`msal_http_cache.bin`** 是HTTP请求的缓存
- 加载它： `with open("msal_http_cache.bin", 'rb') as f: pickle.load(f)`
- **`AzureRmContext.json`** 包含使用Az PowerShell的先前登录信息（但没有凭据）
- 在 **`C:\Users\<username>\AppData\Local\Microsoft\IdentityCache\*`** 中有几个 `.bin` 文件，包含使用用户DPAPI加密的 **访问令牌**、ID令牌和帐户信息。
- 可以在 **`C:\Users\<username>\AppData\Local\Microsoft\TokenBroken\Cache\`** 中的 `.tbres` 文件中找到更多 **访问令牌**，这些文件包含使用DPAPI加密的访问令牌的base64。
- 在Linux和macOS中，可以通过运行 `pwsh -Command "Save-AzContext -Path /tmp/az-context.json"` 从Az PowerShell（如果使用）获取 **访问令牌、刷新令牌和ID令牌**。
- 在Windows中，这只会生成ID令牌。
- 可以通过检查 `$HOME/.local/share/.IdentityService/` 是否存在来查看是否在Linux和macOS中使用了Az PowerShell（尽管包含的文件是空的且无用）。
- 如果用户在浏览器中 **登录了Azure**，根据这篇 [**文章**](https://www.infosecnoodle.com/p/obtaining-microsoft-entra-refresh?r=357m16&utm_campaign=post&utm_medium=web)，可以通过 **重定向到localhost** 开始身份验证流程，使浏览器自动授权登录，并接收刷新令牌。请注意，只有少数几个FOCI应用程序允许重定向到localhost（如az cli或PowerShell模块），因此必须允许这些应用程序。

## 参考文献

- [https://github.com/secureworks/family-of-client-ids-research](https://github.com/secureworks/family-of-client-ids-research)
- [https://github.com/Huachao/azure-content/blob/master/articles/active-directory/active-directory-token-and-claims.md](https://github.com/Huachao/azure-content/blob/master/articles/active-directory/active-directory-token-and-claims.md)

{{#include ../../../banners/hacktricks-training.md}}
