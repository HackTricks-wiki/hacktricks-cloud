# GCP - Podstawowe informacje

{{#include ../../../banners/hacktricks-training.md}}

## **Hierarchia zasobów**

Google Cloud używa [hierarchii zasobów](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy), która jest koncepcyjnie podobna do tradycyjnego systemu plików. Zapewnia to logiczny przepływ pracy rodzic/dziecko z określonymi punktami przyczepienia dla polityk i uprawnień.

Na wysokim poziomie wygląda to tak:
```
Organization
--> Folders
--> Projects
--> Resources
```
Wirtualna maszyna (nazywana Instancją Obliczeniową) jest zasobem. Zasób znajduje się w projekcie, prawdopodobnie obok innych Instancji Obliczeniowych, koszyków pamięci itp.

<figure><img src="../../../images/image (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption><p><a href="https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg">https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg</a></p></figcaption></figure>

## **Migracja projektów**

Możliwe jest **migracja projektu bez organizacji** do organizacji z uprawnieniami `roles/resourcemanager.projectCreator` i `roles/resourcemanager.projectMover`. Jeśli projekt znajduje się w innej organizacji, należy skontaktować się z pomocą techniczną GCP, aby **najpierw przenieść go z organizacji**. Więcej informacji znajdziesz w [**tym**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Polityki organizacyjne**

Pozwalają na centralizację kontroli nad zasobami chmurowymi Twojej organizacji:

- Centralizuj kontrolę, aby **konfigurować ograniczenia** dotyczące sposobu, w jaki zasoby Twojej organizacji mogą być używane.
- Zdefiniuj i ustanów **ograniczenia** dla swoich zespołów deweloperskich, aby pozostały w granicach zgodności.
- Pomóż właścicielom projektów i ich zespołom szybko się poruszać, nie martwiąc się o naruszenie zgodności.

Te polityki mogą być tworzone, aby **wpływać na całą organizację, folder(y) lub projekt(y)**. Potomkowie docelowego węzła hierarchii zasobów **dziedziczą politykę organizacyjną**.

Aby **zdefiniować** politykę organizacyjną, **wybierasz** [**ograniczenie**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), które jest szczególnym rodzajem ograniczenia wobec usługi Google Cloud lub grupy usług Google Cloud. **Konfigurujesz to ograniczenie z pożądanymi ograniczeniami**.

<figure><img src="../../../images/image (217).png" alt=""><figcaption><p><a href="https://cloud.google.com/resource-manager/img/org-policy-concepts.svg">https://cloud.google.com/resource-manager/img/org-policy-concepts.svg</a></p></figcaption></figure>

#### Typowe przypadki użycia <a href="#common_use_cases" id="common_use_cases"></a>

- Ogranicz udostępnianie zasobów na podstawie domeny.
- Ogranicz użycie kont serwisowych Identity and Access Management.
- Ogranicz fizyczną lokalizację nowo tworzonych zasobów.
- Wyłącz tworzenie kont serwisowych.

<figure><img src="../../../images/image (172).png" alt=""><figcaption></figcaption></figure>

Istnieje wiele innych ograniczeń, które dają Ci szczegółową kontrolę nad zasobami Twojej organizacji. Aby **uzyskać więcej informacji, zobacz** [**listę wszystkich ograniczeń Polityki Organizacyjnej**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### **Domyślne polityki organizacyjne**

<details>

<summary>To są polityki, które Google doda domyślnie podczas konfigurowania Twojej organizacji GCP:</summary>

**Polityki zarządzania dostępem**

- **Ograniczone kontakty domenowe:** Zapobiega dodawaniu użytkowników do Kluczowych Kontaktów spoza określonych domen. Ogranicza to Kluczowe Kontakty do zezwolenia tylko na zarządzane tożsamości użytkowników w wybranych domenach na otrzymywanie powiadomień z platformy.
- **Ograniczone udostępnianie domenowe:** Zapobiega dodawaniu użytkowników do polityk IAM spoza określonych domen. Ogranicza to polityki IAM do zezwolenia tylko na zarządzane tożsamości użytkowników w wybranych domenach na dostęp do zasobów w tej organizacji.
- **Zapobieganie dostępowi publicznemu:** Zapobiega ujawnieniu koszyków Cloud Storage publicznie. Zapewnia to, że deweloper nie może skonfigurować koszyków Cloud Storage, aby miały nieautoryzowany dostęp do internetu.
- **Jednolity dostęp na poziomie koszyka:** Zapobiega listom kontrolnym dostępu na poziomie obiektów (ACL) w koszykach Cloud Storage. Ułatwia to zarządzanie dostępem, stosując polityki IAM konsekwentnie we wszystkich obiektach w koszykach Cloud Storage.
- **Wymagaj logowania do systemu operacyjnego:** Maszyny wirtualne utworzone w nowych projektach będą miały włączone logowanie do systemu operacyjnego. Umożliwia to zarządzanie dostępem SSH do instancji za pomocą IAM bez potrzeby tworzenia i zarządzania indywidualnymi kluczami SSH.

**Dodatkowe polityki bezpieczeństwa dla kont serwisowych**

- **Wyłącz automatyczne przyznawanie IAM:** Zapobiega automatycznemu przyznawaniu domyślnym kontom serwisowym App Engine i Compute Engine roli IAM Edytora przy tworzeniu projektu. Zapewnia to, że konta serwisowe nie otrzymują zbyt szerokich ról IAM przy tworzeniu.
- **Wyłącz tworzenie kluczy kont serwisowych:** Zapobiega tworzeniu publicznych kluczy kont serwisowych. Pomaga to zmniejszyć ryzyko ujawnienia trwałych poświadczeń.
- **Wyłącz przesyłanie kluczy kont serwisowych:** Zapobiega przesyłaniu publicznych kluczy kont serwisowych. Pomaga to zmniejszyć ryzyko wycieku lub ponownego użycia materiału klucza.

**Polityki konfiguracji sieci VPC**

- **Zdefiniuj dozwolone zewnętrzne adresy IP dla instancji VM:** Zapobiega tworzeniu instancji obliczeniowych z publicznym adresem IP, co może narażać je na ruch internetowy.

* **Wyłącz zagnieżdżoną wirtualizację VM:** Zapobiega tworzeniu zagnieżdżonych maszyn wirtualnych na maszynach wirtualnych Compute Engine. Zmniejsza to ryzyko bezpieczeństwa związane z posiadaniem niemonitorowanych zagnieżdżonych maszyn wirtualnych.

- **Wyłącz port szeregowy VM:** Zapobiega dostępowi do portu szeregowego maszyn wirtualnych Compute Engine. Zapobiega to wprowadzaniu danych do portu szeregowego serwera za pomocą API Compute Engine.

* **Ogranicz autoryzowane sieci na instancjach Cloud SQL:** Zapobiega dostępowi publicznych lub niewewnętrznych zakresów sieci do baz danych Cloud SQL.

- **Ogranicz przekazywanie protokołów w zależności od typu adresu IP:** Zapobiega przekazywaniu protokołów VM dla zewnętrznych adresów IP.

* **Ogranicz dostęp publiczny IP na instancjach Cloud SQL:** Zapobiega tworzeniu instancji Cloud SQL z publicznym adresem IP, co może narażać je na ruch internetowy.

- **Ogranicz usuwanie obciążeń projektów Shared VPC:** Zapobiega przypadkowemu usunięciu projektów hostów Shared VPC.

* **Ustawia wewnętrzne ustawienie DNS dla nowych projektów na Zonal DNS Only:** Zapobiega używaniu przestarzałego ustawienia DNS, które zmniejsza dostępność usługi.

- **Pomiń tworzenie domyślnej sieci:** Zapobiega automatycznemu tworzeniu domyślnej sieci VPC i powiązanych zasobów. Unika to zbyt szerokich domyślnych reguł zapory.

* **Wyłącz użycie zewnętrznego IPv6 VPC:** Zapobiega tworzeniu zewnętrznych podsieci IPv6, które mogą być narażone na nieautoryzowany dostęp do internetu.

</details>

## **Role IAM**

Są one podobne do polityk IAM w AWS, ponieważ **każda rola zawiera zestaw uprawnień.**

Jednak w przeciwieństwie do AWS, nie ma **centralnego repozytorium** ról. Zamiast tego, **zasoby przyznają X role dostępu Y podmiotom**, a jedynym sposobem, aby dowiedzieć się, kto ma dostęp do zasobu, jest użycie **metody `get-iam-policy` dla tego zasobu**.\
Może to być problem, ponieważ oznacza to, że jedynym sposobem, aby dowiedzieć się, **jakie uprawnienia ma podmiot, jest zapytanie każdego zasobu, komu przyznaje uprawnienia**, a użytkownik może nie mieć uprawnień do uzyskania uprawnień ze wszystkich zasobów.

Istnieją **trzy typy** ról w IAM:

- **Podstawowe/Prymitywne role**, które obejmują role **Właściciela**, **Edytora** i **Widoku**, które istniały przed wprowadzeniem IAM.
- **Role zdefiniowane**, które zapewniają szczegółowy dostęp do konkretnej usługi i są zarządzane przez Google Cloud. Istnieje wiele zdefiniowanych ról, możesz **zobaczyć wszystkie z nimi związane uprawnienia** [**tutaj**](https://cloud.google.com/iam/docs/understanding-roles#predefined_roles).
- **Role niestandardowe**, które zapewniają szczegółowy dostęp zgodnie z listą uprawnień określoną przez użytkownika.

W GCP istnieją tysiące uprawnień. Aby sprawdzić, czy rola ma uprawnienia, możesz [**wyszukać uprawnienie tutaj**](https://cloud.google.com/iam/docs/permissions-reference) i zobaczyć, które role je mają.

Możesz również [**wyszukać tutaj zdefiniowane role**](https://cloud.google.com/iam/docs/understanding-roles#product_specific_documentation) **oferowane przez każdy produkt.** Zauważ, że niektóre **role** nie mogą być przypisane do użytkowników, a **tylko do kont serwisowych z powodu niektórych uprawnień**, które zawierają.\
Ponadto zauważ, że **uprawnienia** będą miały **skutek** tylko wtedy, gdy będą **przypisane do odpowiedniej usługi.**

Lub sprawdź, czy **rola niestandardowa może używać** [**konkretnego uprawnienia tutaj**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**.**

{{#ref}}
../gcp-services/gcp-iam-and-org-policies-enum.md
{{#endref}}

## Użytkownicy <a href="#default-credentials" id="default-credentials"></a>

W **konsoli GCP** **nie ma zarządzania Użytkownikami ani Grupami**, to odbywa się w **Google Workspace**. Chociaż możesz zsynchronizować innego dostawcę tożsamości w Google Workspace.

Możesz uzyskać dostęp do **użytkowników i grup** Workspace w [**https://admin.google.com**](https://admin.google.com/).

**MFA** może być **wymuszone** dla użytkowników Workspace, jednak **atakujący** może użyć tokena do uzyskania dostępu do GCP **za pomocą CLI, co nie będzie chronione przez MFA** (będzie chronione przez MFA tylko wtedy, gdy użytkownik loguje się, aby go wygenerować: `gcloud auth login`).

## Grupy

Gdy organizacja jest tworzona, zaleca się **utworzenie kilku grup.** Jeśli zarządzasz którąkolwiek z nich, możesz skompromitować całą lub ważną część organizacji:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Grupa</strong></td><td><strong>Funkcja</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(wymagana grupa lub konta indywidualne do listy kontrolnej)</em></td><td>Administrowanie każdym zasobem, który należy do organizacji. Przypisz tę rolę oszczędnie; administratorzy organizacji mają dostęp do wszystkich zasobów Google Cloud. Alternatywnie, ponieważ ta funkcja jest wysoko uprzywilejowana, rozważ użycie kont indywidualnych zamiast tworzenia grupy.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(wymagana do listy kontrolnej)</em></td><td>Tworzenie sieci, podsieci, reguł zapory i urządzeń sieciowych, takich jak Cloud Router, Cloud VPN i równoważniki obciążenia w chmurze.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(wymagana do listy kontrolnej)</em></td><td>Ustawianie kont rozliczeniowych i monitorowanie ich użycia.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(wymagana do listy kontrolnej)</em></td><td>Projektowanie, kodowanie i testowanie aplikacji.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Ustanawianie i zarządzanie politykami bezpieczeństwa dla całej organizacji, w tym zarządzaniem dostępem i <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">politykami ograniczeń organizacyjnych</a>. Zobacz <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">przewodnik po podstawach bezpieczeństwa Google Cloud</a>, aby uzyskać więcej informacji na temat planowania infrastruktury bezpieczeństwa Google Cloud.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Tworzenie lub zarządzanie end-to-end pipeline'ami, które wspierają ciągłą integrację i dostarczanie, monitorowanie i provisionowanie systemów.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(już nie domyślnie)</em></td><td>Monitorowanie wydatków na projektach. Typowi członkowie są częścią zespołu finansowego.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(już nie domyślnie)</em></td><td>Przeglądanie informacji o zasobach w organizacji Google Cloud.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(już nie domyślnie)</em></td><td>Przeglądanie bezpieczeństwa w chmurze.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(już nie domyślnie)</em></td><td>Przeglądanie konfiguracji sieci.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(już nie domyślnie)</em></td><td>Przeglądanie dzienników audytowych.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(już nie domyślnie)</em></td><td>Administrowanie Centrum Dowodzenia Bezpieczeństwa.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(już nie domyślnie)</em></td><td>Zarządzanie sekretami w Menedżerze Sekretów.</td></tr></tbody></table>

## **Domyślna polityka haseł**

- Wymuszaj silne hasła
- Od 8 do 100 znaków
- Brak ponownego użycia
- Brak wygaśnięcia
- Jeśli osoby uzyskują dostęp do Workspace za pośrednictwem dostawcy zewnętrznego, te wymagania nie są stosowane.

<figure><img src="../../../images/image (20).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../images/image (22).png" alt=""><figcaption></figcaption></figure>

## **Konta serwisowe**

To są podmioty, które **zasoby** mogą **mieć** **przypisane** i uzyskać dostęp do interakcji z GCP. Na przykład możliwe jest uzyskanie dostępu do **tokena autoryzacji** konta serwisowego **przypisanego do VM** w metadanych.\
Możliwe jest napotkanie pewnych **konfliktów** podczas korzystania zarówno z **IAM, jak i zakresów dostępu**. Na przykład, Twoje konto serwisowe może mieć rolę IAM `compute.instanceAdmin`, ale instancja, którą naruszyłeś, została ograniczona przez ograniczenie zakresu `https://www.googleapis.com/auth/compute.readonly`. To uniemożliwiłoby Ci wprowadzenie jakichkolwiek zmian za pomocą tokena OAuth, który jest automatycznie przypisany do Twojej instancji.

Jest to podobne do **ról IAM w AWS**. Ale w przeciwieństwie do AWS, **jakiekolwiek** konto serwisowe może być **przypisane do jakiejkolwiek usługi** (nie musi być to dozwolone przez politykę).

Kilka kont serwisowych, które znajdziesz, jest w rzeczywistości **automatycznie generowanych przez GCP** po rozpoczęciu korzystania z usługi, takich jak:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Jednak możliwe jest również tworzenie i dołączanie do zasobów **niestandardowych kont serwisowych**, które będą wyglądać następująco:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Klucze i Tokeny**

Istnieją 2 główne sposoby uzyskania dostępu do GCP jako konto usługi:

- **Za pomocą tokenów OAuth**: Są to tokeny, które można uzyskać z miejsc takich jak punkty końcowe metadanych lub kradnąc żądania http i są ograniczone przez **zakresy dostępu**.
- **Klucze**: Są to pary kluczy publicznych i prywatnych, które pozwalają na podpisywanie żądań jako konto usługi, a nawet generowanie tokenów OAuth do wykonywania działań jako konto usługi. Te klucze są niebezpieczne, ponieważ są bardziej skomplikowane do ograniczenia i kontrolowania, dlatego GCP zaleca ich niegenerowanie.
- Należy zauważyć, że za każdym razem, gdy tworzone jest konto SA, **GCP generuje klucz dla konta usługi**, do którego użytkownik nie ma dostępu (i nie będzie on wymieniony w aplikacji internetowej). Zgodnie z [**tym wątkiem**](https://www.reddit.com/r/googlecloud/comments/f0ospy/service_account_keys_observations/) ten klucz jest **używany wewnętrznie przez GCP** do umożliwienia punktom końcowym metadanych dostępu do generowania dostępnych tokenów OAuth.

### **Zakresy dostępu**

Zakresy dostępu są **przypisane do generowanych tokenów OAuth** w celu uzyskania dostępu do punktów końcowych API GCP. **Ograniczają uprawnienia** tokena OAuth.\
Oznacza to, że jeśli token należy do właściciela zasobu, ale nie ma w zakresie tokena dostępu do tego zasobu, token **nie może być użyty do (nadużywania) tych uprawnień**.

Google faktycznie [zaleca](https://cloud.google.com/compute/docs/access/service-accounts#service_account_permissions), aby **zakresy dostępu nie były używane i aby całkowicie polegać na IAM**. Portal zarządzania w sieci faktycznie egzekwuje to, ale zakresy dostępu mogą być nadal stosowane do instancji przy użyciu niestandardowych kont usługowych programowo.

Możesz zobaczyć, jakie **zakresy** są **przypisane** przez **zapytanie:**
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
Poprzednie **zakresy** to te generowane przez **domyślnie** przy użyciu **`gcloud`** do uzyskiwania dostępu do danych. Dzieje się tak, ponieważ gdy używasz **`gcloud`**, najpierw tworzysz token OAuth, a następnie używasz go do kontaktu z punktami końcowymi.

Najważniejszym zakresem z tych potencjalnych jest **`cloud-platform`**, co zasadniczo oznacza, że możliwe jest **uzyskanie dostępu do dowolnej usługi w GCP**.

Możesz **znaleźć listę** [**wszystkich możliwych zakresów tutaj**](https://developers.google.com/identity/protocols/googlescopes)**.**

Jeśli masz **`gcloud`** dane uwierzytelniające przeglądarki, możliwe jest **uzyskanie tokena z innymi zakresami,** robiąc coś takiego:
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
## **Polityki IAM Terraform, Powiązania i Członkostwa**

Jak zdefiniowano w terraform w [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_project_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_project_iam), używając terraform z GCP, istnieją różne sposoby przyznawania dostępu dla podmiotu do zasobu:

- **Członkostwa**: Ustawiasz **podmioty jako członków ról** **bez ograniczeń** dotyczących roli lub podmiotów. Możesz dodać użytkownika jako członka roli, a następnie dodać grupę jako członka tej samej roli i również ustawić te podmioty (użytkownik i grupa) jako członków innych ról.
- **Powiązania**: Kilka **podmiotów może być powiązanych z rolą**. Te **podmioty mogą nadal być powiązane lub być członkami innych ról**. Jednak jeśli podmiot, który nie jest powiązany z rolą, zostanie ustawiony jako **członek powiązanej roli**, następnym razem, gdy **powiązanie zostanie zastosowane, członkostwo zniknie**.
- **Polityki**: Polityka jest **autorytatywna**, wskazuje role i podmioty, a następnie **te podmioty nie mogą mieć więcej ról, a te role nie mogą mieć więcej podmiotów**, chyba że ta polityka zostanie zmodyfikowana (nawet w innych politykach, powiązaniach lub członkostwach). Dlatego, gdy rola lub podmiot jest określony w polityce, wszystkie jego uprawnienia są **ograniczone przez tę politykę**. Oczywiście, można to obejść, jeśli podmiot ma możliwość modyfikacji polityki lub uprawnienia do eskalacji uprawnień (jak utworzenie nowego podmiotu i powiązanie go z nową rolą).

## Odniesienia

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
- [https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)

{{#include ../../../banners/hacktricks-training.md}}
