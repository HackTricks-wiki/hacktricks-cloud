# GCP - Informações Básicas

{{#include ../../../banners/hacktricks-training.md}}

## **Hierarquia de Recursos**

O Google Cloud utiliza uma [Hierarquia de Recursos](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) que é semelhante, conceitualmente, à de um sistema de arquivos tradicional. Isso fornece um fluxo de trabalho lógico de pai/filho com pontos de anexo específicos para políticas e permissões.

Em um nível alto, parece assim:
```
Organization
--> Folders
--> Projects
--> Resources
```
Uma máquina virtual (chamada de Instância de Computação) é um recurso. Um recurso reside em um projeto, provavelmente ao lado de outras Instâncias de Computação, buckets de armazenamento, etc.

<figure><img src="../../../images/image (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption><p><a href="https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg">https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg</a></p></figcaption></figure>

## **Migração de Projetos**

É possível **migrar um projeto sem nenhuma organização** para uma organização com as permissões `roles/resourcemanager.projectCreator` e `roles/resourcemanager.projectMover`. Se o projeto estiver dentro de outra organização, é necessário entrar em contato com o suporte do GCP para **movê-lo para fora da organização primeiro**. Para mais informações, consulte [**isso**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Políticas de Organização**

Permitem centralizar o controle sobre os recursos em nuvem da sua organização:

- Centralizar o controle para **configurar restrições** sobre como os recursos da sua organização podem ser usados.
- Definir e estabelecer **diretrizes** para que suas equipes de desenvolvimento permaneçam dentro dos limites de conformidade.
- Ajudar os proprietários de projetos e suas equipes a se moverem rapidamente sem se preocupar em quebrar a conformidade.

Essas políticas podem ser criadas para **afetar a organização completa, pasta(s) ou projeto(s)**. Os descendentes do nó da hierarquia de recursos alvo **herdam a política da organização**.

Para **definir** uma política de organização, **você escolhe uma** [**restrição**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), que é um tipo particular de restrição contra um serviço do Google Cloud ou um grupo de serviços do Google Cloud. Você **configura essa restrição com suas restrições desejadas**.

<figure><img src="../../../images/image (217).png" alt=""><figcaption><p><a href="https://cloud.google.com/resource-manager/img/org-policy-concepts.svg">https://cloud.google.com/resource-manager/img/org-policy-concepts.svg</a></p></figcaption></figure>

#### Casos de uso comuns <a href="#common_use_cases" id="common_use_cases"></a>

- Limitar o compartilhamento de recursos com base no domínio.
- Limitar o uso de contas de serviço de Gerenciamento de Identidade e Acesso.
- Restringir a localização física de recursos recém-criados.
- Desabilitar a criação de contas de serviço.

<figure><img src="../../../images/image (172).png" alt=""><figcaption></figcaption></figure>

Existem muitas outras restrições que oferecem controle detalhado sobre os recursos da sua organização. Para **mais informações, veja a** [**lista de todas as restrições do Serviço de Política de Organização**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### **Políticas de Organização Padrão**

<details>

<summary>Estas são as políticas que o Google adicionará por padrão ao configurar sua organização GCP:</summary>

**Políticas de Gerenciamento de Acesso**

- **Contatos restritos por domínio:** Impede a adição de usuários a Contatos Essenciais fora dos domínios especificados. Isso limita os Contatos Essenciais a permitir apenas identidades de usuários gerenciados em seus domínios selecionados para receber notificações da plataforma.
- **Compartilhamento restrito por domínio:** Impede a adição de usuários a políticas IAM fora dos domínios especificados. Isso limita as políticas IAM a permitir apenas identidades de usuários gerenciados em seus domínios selecionados para acessar recursos dentro desta organização.
- **Prevenção de acesso público:** Impede que buckets do Cloud Storage sejam expostos ao público. Isso garante que um desenvolvedor não possa configurar buckets do Cloud Storage para ter acesso à internet não autenticado.
- **Acesso uniforme a nível de bucket:** Impede listas de controle de acesso (ACLs) a nível de objeto em buckets do Cloud Storage. Isso simplifica seu gerenciamento de acesso aplicando políticas IAM de forma consistente em todos os objetos nos buckets do Cloud Storage.
- **Exigir login do SO:** VMs criadas em novos projetos terão o Login do SO habilitado. Isso permite que você gerencie o acesso SSH às suas instâncias usando IAM sem precisar criar e gerenciar chaves SSH individuais.

**Políticas de segurança adicionais para contas de serviço**

- **Desabilitar concessões automáticas de IAM:** Impede que as contas de serviço padrão do App Engine e do Compute Engine sejam automaticamente concedidas o papel de Editor IAM em um projeto na criação. Isso garante que as contas de serviço não recebam papéis IAM excessivamente permissivos ao serem criadas.
- **Desabilitar a criação de chaves de conta de serviço:** Impede a criação de chaves de conta de serviço públicas. Isso ajuda a reduzir o risco de exposição de credenciais persistentes.
- **Desabilitar o upload de chaves de conta de serviço:** Impede o upload de chaves de conta de serviço públicas. Isso ajuda a reduzir o risco de vazamento ou reutilização de material de chave.

**Políticas de configuração de rede VPC seguras**

- **Definir IPs externos permitidos para instâncias de VM:** Impede a criação de instâncias de Computação com um IP público, o que pode expô-las ao tráfego da internet.

* **Desabilitar virtualização aninhada de VM:** Impede a criação de VMs aninhadas em VMs do Compute Engine. Isso diminui o risco de segurança de ter VMs aninhadas não monitoradas.

- **Desabilitar porta serial de VM:** Impede o acesso à porta serial de VMs do Compute Engine. Isso impede a entrada na porta serial de um servidor usando a API do Compute Engine.

* **Restringir redes autorizadas em instâncias do Cloud SQL:** Impede que faixas de rede públicas ou não internas acessem seus bancos de dados do Cloud SQL.

- **Restringir o encaminhamento de protocolo com base no tipo de endereço IP:** Impede o encaminhamento de protocolo de VM para endereços IP externos.

* **Restringir acesso IP público em instâncias do Cloud SQL:** Impede a criação de instâncias do Cloud SQL com um IP público, o que pode expô-las ao tráfego da internet.

- **Restringir a remoção de ônus de projeto VPC compartilhado:** Impede a exclusão acidental de projetos host do VPC compartilhado.

* **Define a configuração de DNS interno para novos projetos como Apenas DNS Zonal:** Impede o uso de uma configuração de DNS legada que reduziu a disponibilidade do serviço.

- **Pular a criação de rede padrão:** Impede a criação automática da rede VPC padrão e recursos relacionados. Isso evita regras de firewall padrão excessivamente permissivas.

* **Desabilitar uso de IPv6 externo no VPC:** Impede a criação de sub-redes IPv6 externas, que podem ser expostas a acesso não autorizado à internet.

</details>

## **Papéis IAM**

Estes são como políticas IAM no AWS, pois **cada papel contém um conjunto de permissões.**

No entanto, ao contrário do AWS, não há **um repositório centralizado** de papéis. Em vez disso, **recursos dão X papéis de acesso a Y principais**, e a única maneira de descobrir quem tem acesso a um recurso é usar o **método `get-iam-policy` sobre esse recurso**.\
Isso pode ser um problema porque isso significa que a única maneira de descobrir **quais permissões um principal tem é perguntar a cada recurso a quem ele está concedendo permissões**, e um usuário pode não ter permissões para obter permissões de todos os recursos.

Existem **três tipos** de papéis no IAM:

- **Papéis Básicos/Primitivos**, que incluem os papéis de **Proprietário**, **Editor** e **Visualizador** que existiam antes da introdução do IAM.
- **Papéis Predefinidos**, que fornecem acesso granular para um serviço específico e são gerenciados pelo Google Cloud. Existem muitos papéis predefinidos, você pode **ver todos eles com os privilégios que possuem** [**aqui**](https://cloud.google.com/iam/docs/understanding-roles#predefined_roles).
- **Papéis Personalizados**, que fornecem acesso granular de acordo com uma lista de permissões especificada pelo usuário.

Existem milhares de permissões no GCP. Para verificar se um papel tem uma permissão, você pode [**pesquisar a permissão aqui**](https://cloud.google.com/iam/docs/permissions-reference) e ver quais papéis a possuem.

Você também pode [**pesquisar aqui papéis predefinidos**](https://cloud.google.com/iam/docs/understanding-roles#product_specific_documentation) **oferecidos por cada produto.** Observe que alguns **papéis** não podem ser anexados a usuários e **apenas a SAs devido a algumas permissões** que contêm.\
Além disso, observe que **as permissões** só **terão efeito** se estiverem **anexadas ao serviço relevante.**

Ou verifique se um **papel personalizado pode usar uma** [**permissão específica aqui**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**.**

{{#ref}}
../gcp-services/gcp-iam-and-org-policies-enum.md
{{#endref}}

## Usuários <a href="#default-credentials" id="default-credentials"></a>

No **console do GCP** não **existe gerenciamento de Usuários ou Grupos**, isso é feito no **Google Workspace**. Embora você possa sincronizar um provedor de identidade diferente no Google Workspace.

Você pode acessar os **usuários e grupos do Workspaces em** [**https://admin.google.com**](https://admin.google.com/).

**MFA** pode ser **forçada** para usuários do Workspaces, no entanto, um **atacante** pode usar um token para acessar o GCP **via cli que não estará protegido por MFA** (ele estará protegido por MFA apenas quando o usuário fizer login para gerá-lo: `gcloud auth login`).

## Grupos

Quando uma organização é criada, vários grupos são **fortemente sugeridos para serem criados.** Se você gerenciar algum deles, pode ter comprometido toda ou uma parte importante da organização:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Grupo</strong></td><td><strong>Função</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(grupo ou contas individuais necessárias para a lista de verificação)</em></td><td>Administrar qualquer recurso que pertença à organização. Atribua este papel com moderação; os administradores da organização têm acesso a todos os seus recursos do Google Cloud. Como alternativa, devido a essa função ser altamente privilegiada, considere usar contas individuais em vez de criar um grupo.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(necessário para a lista de verificação)</em></td><td>Criar redes, sub-redes, regras de firewall e dispositivos de rede, como Cloud Router, Cloud VPN e balanceadores de carga em nuvem.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(necessário para a lista de verificação)</em></td><td>Configurar contas de faturamento e monitorar seu uso.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(necessário para a lista de verificação)</em></td><td>Projetar, codificar e testar aplicativos.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Estabelecer e gerenciar políticas de segurança para toda a organização, incluindo gerenciamento de acesso e <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">políticas de restrição da organização</a>. Consulte o <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">guia de fundamentos de segurança do Google Cloud</a> para mais informações sobre como planejar sua infraestrutura de segurança do Google Cloud.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Criar ou gerenciar pipelines de ponta a ponta que suportam integração e entrega contínuas, monitoramento e provisionamento de sistemas.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(não mais por padrão)</em></td><td>Monitorar os gastos em projetos. Membros típicos fazem parte da equipe financeira.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(não mais por padrão)</em></td><td>Revisar informações de recursos em toda a organização do Google Cloud.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(não mais por padrão)</em></td><td>Revisar a segurança em nuvem.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(não mais por padrão)</em></td><td>Revisar configurações de rede.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(não mais por padrão)</em></td><td>Visualizar logs de auditoria.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(não mais por padrão)</em></td><td>Administrar o Security Command Center.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(não mais por padrão)</em></td><td>Gerenciar segredos no Secret Manager.</td></tr></tbody></table>

## **Política de Senha Padrão**

- Impor senhas fortes
- Entre 8 e 100 caracteres
- Sem reutilização
- Sem expiração
- Se as pessoas estiverem acessando o Workspace através de um provedor de terceiros, esses requisitos não são aplicados.

<figure><img src="../../../images/image (20).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../images/image (22).png" alt=""><figcaption></figcaption></figure>

## **Contas de serviço**

Estas são os principais que **recursos** podem **ter** **anexados** e acesso para interagir facilmente com o GCP. Por exemplo, é possível acessar o **token de autenticação** de uma Conta de Serviço **anexada a uma VM** nos metadados.\
É possível encontrar alguns **conflitos** ao usar tanto **IAM quanto escopos de acesso**. Por exemplo, sua conta de serviço pode ter o papel IAM de `compute.instanceAdmin`, mas a instância que você invadiu foi limitada pela restrição de escopo de `https://www.googleapis.com/auth/compute.readonly`. Isso impediria que você fizesse quaisquer alterações usando o token OAuth que é automaticamente atribuído à sua instância.

É semelhante aos **papéis IAM do AWS**. Mas, ao contrário do AWS, **qualquer** conta de serviço pode ser **anexada a qualquer serviço** (não precisa permitir isso por meio de uma política).

Várias das contas de serviço que você encontrará são, na verdade, **geradas automaticamente pelo GCP** quando você começa a usar um serviço, como:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
No entanto, também é possível criar e anexar a recursos **contas de serviço personalizadas**, que terão a seguinte aparência:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Chaves e Tokens**

Existem 2 maneiras principais de acessar o GCP como uma conta de serviço:

- **Via tokens OAuth**: Esses são tokens que você obterá de lugares como endpoints de metadados ou roubando requisições http e são limitados pelos **escopos de acesso**.
- **Chaves**: Esses são pares de chaves públicas e privadas que permitirão que você assine requisições como a conta de serviço e até mesmo gere tokens OAuth para realizar ações como a conta de serviço. Essas chaves são perigosas porque são mais complicadas de limitar e controlar, por isso o GCP recomenda não gerá-las.
- Note que toda vez que uma SA é criada, **o GCP gera uma chave para a conta de serviço** que o usuário não pode acessar (e não será listada na aplicação web). De acordo com [**este tópico**](https://www.reddit.com/r/googlecloud/comments/f0ospy/service_account_keys_observations/), essa chave é **usada internamente pelo GCP** para dar acesso aos endpoints de metadados para gerar os tokens OAuth acessíveis.

### **Escopos de Acesso**

Os escopos de acesso são **anexados aos tokens OAuth gerados** para acessar os endpoints da API do GCP. Eles **restrigem as permissões** do token OAuth.\
Isso significa que se um token pertence a um Proprietário de um recurso, mas não tem no escopo do token acesso a esse recurso, o token **não pode ser usado para (ab)usar esses privilégios**.

O Google na verdade [recomenda](https://cloud.google.com/compute/docs/access/service-accounts#service_account_permissions) que **os escopos de acesso não sejam usados e que se confie totalmente no IAM**. O portal de gerenciamento web realmente impõe isso, mas os escopos de acesso ainda podem ser aplicados a instâncias usando contas de serviço personalizadas programaticamente.

Você pode ver quais **escopos** estão **atribuídos** consultando:
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
Os **escopos** anteriores são os gerados por **padrão** usando **`gcloud`** para acessar dados. Isso ocorre porque, ao usar **`gcloud`**, você primeiro cria um token OAuth e, em seguida, o utiliza para contatar os endpoints.

O escopo mais importante entre eles potencialmente é **`cloud-platform`**, que basicamente significa que é possível **acessar qualquer serviço no GCP**.

Você pode **encontrar uma lista de** [**todos os escopos possíveis aqui**](https://developers.google.com/identity/protocols/googlescopes)**.**

Se você tiver credenciais de navegador **`gcloud`**, é possível **obter um token com outros escopos,** fazendo algo como:
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
## **Políticas, Vínculos e Membros IAM do Terraform**

Conforme definido pelo terraform em [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_project_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_project_iam), usando terraform com GCP, existem diferentes maneiras de conceder a um principal acesso a um recurso:

- **Membros**: Você define **principais como membros de funções** **sem restrições** sobre a função ou os principais. Você pode colocar um usuário como membro de uma função e, em seguida, colocar um grupo como membro da mesma função e também definir esses principais (usuário e grupo) como membros de outras funções.
- **Vínculos**: Vários **principais podem ser vinculados a uma função**. Esses **principais ainda podem ser vinculados ou ser membros de outras funções**. No entanto, se um principal que não está vinculado à função for definido como **membro de uma função vinculada**, na próxima vez que o **vínculo for aplicado, a associação desaparecerá**.
- **Políticas**: Uma política é **autoritativa**, indica funções e principais e, então, **esses principais não podem ter mais funções e essas funções não podem ter mais principais** a menos que essa política seja modificada (nem mesmo em outras políticas, vínculos ou membros). Portanto, quando uma função ou principal é especificado na política, todos os seus privilégios são **limitados por essa política**. Obviamente, isso pode ser contornado caso o principal tenha a opção de modificar a política ou permissões de escalonamento de privilégios (como criar um novo principal e vinculá-lo a uma nova função).

## Referências

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
- [https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)

{{#include ../../../banners/hacktricks-training.md}}
