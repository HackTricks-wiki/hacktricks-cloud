# GCP - 基本信息

{{#include ../../../banners/hacktricks-training.md}}

## **资源层次结构**

Google Cloud 使用一个 [资源层次结构](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)，在概念上类似于传统文件系统。这提供了一个逻辑的父/子工作流程，并为策略和权限提供了特定的附加点。

在高层次上，它看起来像这样：
```
Organization
--> Folders
--> Projects
--> Resources
```
一个虚拟机（称为计算实例）是一个资源。资源位于一个项目中，可能与其他计算实例、存储桶等并存。

<figure><img src="../../../images/image (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption><p><a href="https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg">https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg</a></p></figcaption></figure>

## **项目迁移**

可以将**没有任何组织的项目迁移到一个组织**，需要的权限是`roles/resourcemanager.projectCreator`和`roles/resourcemanager.projectMover`。如果项目在其他组织内，则需要联系GCP支持以**先将其移出该组织**。有关更多信息，请查看[**此处**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6)。

## **组织政策**

允许集中控制您组织的云资源：

- 集中控制以**配置限制**，以规定您组织的资源如何使用。
- 为您的开发团队定义和建立**保护措施**，以保持合规边界。
- 帮助项目所有者及其团队快速移动，而无需担心违反合规。

这些政策可以创建以**影响整个组织、文件夹或项目**。目标资源层次节点的后代**继承组织政策**。

为了**定义**组织政策，**您选择一个**[**约束**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints)，这是针对Google Cloud服务或一组Google Cloud服务的特定类型的限制。您**使用所需的限制配置该约束**。

<figure><img src="../../../images/image (217).png" alt=""><figcaption><p><a href="https://cloud.google.com/resource-manager/img/org-policy-concepts.svg">https://cloud.google.com/resource-manager/img/org-policy-concepts.svg</a></p></figcaption></figure>

#### 常见用例 <a href="#common_use_cases" id="common_use_cases"></a>

- 根据域限制资源共享。
- 限制身份和访问管理服务帐户的使用。
- 限制新创建资源的物理位置。
- 禁用服务帐户创建。

<figure><img src="../../../images/image (172).png" alt=""><figcaption></figcaption></figure>

还有许多其他约束可以让您对组织的资源进行细粒度控制。有关**更多信息，请参见**[**所有组织政策服务约束的列表**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**。**

### **默认组织政策**

<details>

<summary>这些是Google在设置您的GCP组织时默认添加的政策：</summary>

**访问管理政策**

- **域限制联系人：** 防止将用户添加到您指定域之外的基本联系人。这限制了基本联系人仅允许您选择的域中的受管用户身份接收平台通知。
- **域限制共享：** 防止将用户添加到您指定域之外的IAM政策。这限制了IAM政策仅允许您选择的域中的受管用户身份访问该组织内的资源。
- **公共访问防止：** 防止Cloud Storage存储桶暴露给公众。这确保开发人员无法配置Cloud Storage存储桶以具有未经身份验证的互联网访问。
- **统一存储桶级别访问：** 防止Cloud Storage存储桶中的对象级访问控制列表（ACL）。这通过在Cloud Storage存储桶中的所有对象上一致地应用IAM政策来简化您的访问管理。
- **要求操作系统登录：** 在新项目中创建的虚拟机将启用操作系统登录。这使您可以使用IAM管理对实例的SSH访问，而无需创建和管理单个SSH密钥。

**服务帐户的额外安全政策**

- **禁用自动IAM授予：** 防止默认的App Engine和Compute Engine服务帐户在创建项目时自动获得编辑器IAM角色。这确保服务帐户在创建时不会获得过于宽松的IAM角色。
- **禁用服务帐户密钥创建：** 防止创建公共服务帐户密钥。这有助于减少暴露持久凭据的风险。
- **禁用服务帐户密钥上传：** 防止上传公共服务帐户密钥。这有助于减少泄露或重用密钥材料的风险。

**安全VPC网络配置政策**

- **定义VM实例的允许外部IP：** 防止创建具有公共IP的计算实例，这可能会使其暴露于互联网流量。

* **禁用VM嵌套虚拟化：** 防止在Compute Engine虚拟机上创建嵌套虚拟机。这降低了拥有未监控嵌套虚拟机的安全风险。

- **禁用VM串行端口：** 防止对Compute Engine虚拟机的串行端口访问。这防止通过Compute Engine API向服务器的串行端口输入。

* **限制Cloud SQL实例上的授权网络：** 防止公共或非内部网络范围访问您的Cloud SQL数据库。

- **根据IP地址类型限制协议转发：** 防止对外部IP地址的VM协议转发。

* **限制Cloud SQL实例上的公共IP访问：** 防止创建具有公共IP的Cloud SQL实例，这可能会使其暴露于互联网流量。

- **限制共享VPC项目留置权移除：** 防止意外删除共享VPC主项目。

* **将新项目的内部DNS设置为仅区域DNS：** 防止使用服务可用性降低的遗留DNS设置。

- **跳过默认网络创建：** 防止自动创建默认VPC网络及相关资源。这避免了过于宽松的默认防火墙规则。

* **禁用VPC外部IPv6使用：** 防止创建外部IPv6子网，这可能会暴露于未经授权的互联网访问。

</details>

## **IAM角色**

这些类似于AWS中的IAM政策，因为**每个角色包含一组权限。**

然而，与AWS不同的是，**没有集中式的角色库**。相反，**资源将X访问角色授予Y主体**，找出谁可以访问资源的唯一方法是使用**`get-iam-policy`方法**。\
这可能是一个问题，因为这意味着找出**主体拥有哪些权限的唯一方法是询问每个资源它授予了哪些权限**，而用户可能没有权限从所有资源获取权限。

IAM中有**三种类型**的角色：

- **基本/原始角色**，包括在引入IAM之前存在的**所有者**、**编辑者**和**查看者**角色。
- **预定义角色**，为特定服务提供细粒度访问，并由Google Cloud管理。有很多预定义角色，您可以**在此处查看所有角色及其权限**[**这里**](https://cloud.google.com/iam/docs/understanding-roles#predefined_roles)。
- **自定义角色**，根据用户指定的权限列表提供细粒度访问。

GCP中有成千上万的权限。要检查角色是否具有某个权限，您可以[**在这里搜索权限**](https://cloud.google.com/iam/docs/permissions-reference)并查看哪些角色具有该权限。

您还可以[**在这里搜索预定义角色**](https://cloud.google.com/iam/docs/understanding-roles#product_specific_documentation) **由每个产品提供。** 请注意，某些**角色**不能附加到用户，只能附加到SA，因为它们包含某些权限。\
此外，请注意，**权限**只有在**附加到相关服务时**才会**生效**。

或者检查**自定义角色是否可以使用**[**特定权限**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**。**

{{#ref}}
../gcp-services/gcp-iam-and-org-policies-enum.md
{{#endref}}

## 用户 <a href="#default-credentials" id="default-credentials"></a>

在**GCP控制台**中**没有用户或组**管理，这在**Google Workspace**中进行。尽管您可以在Google Workspace中同步不同的身份提供者。

您可以在[**https://admin.google.com**](https://admin.google.com/)访问Workspaces的**用户和组**。

**MFA**可以**强制**应用于Workspaces用户，然而，**攻击者**可以使用令牌通过cli访问GCP，这**不会受到MFA保护**（只有在用户登录以生成它时才会受到MFA保护：`gcloud auth login`）。

## 组

创建组织时，**强烈建议创建几个组**。如果您管理其中任何一个，您可能已经危及了整个组织或其重要部分：

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>组</strong></td><td><strong>功能</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(需要组或个人帐户以供检查)</em></td><td>管理属于组织的任何资源。谨慎分配此角色；组织管理员可以访问您所有的Google Cloud资源。或者，由于此功能权限很高，考虑使用个人帐户而不是创建组。</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(需要检查)</em></td><td>创建网络、子网、防火墙规则和网络设备，如Cloud Router、Cloud VPN和云负载均衡器。</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(需要检查)</em></td><td>设置计费帐户并监控其使用情况。</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(需要检查)</em></td><td>设计、编码和测试应用程序。</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>为整个组织建立和管理安全政策，包括访问管理和<a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">组织约束政策</a>。有关规划Google Cloud安全基础设施的更多信息，请参见<a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">Google Cloud安全基础指南</a>。</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>创建或管理支持持续集成和交付、监控和系统配置的端到端管道。</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(不再默认)</em></td><td>监控项目支出。典型成员是财务团队的一部分。</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(不再默认)</em></td><td>查看Google Cloud组织中的资源信息。</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(不再默认)</em></td><td>审查云安全性。</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(不再默认)</em></td><td>审查网络配置。</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(不再默认)</em></td><td>查看审计日志。</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(不再默认)</em></td><td>管理安全指挥中心。</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(不再默认)</em></td><td>在秘密管理器中管理秘密。</td></tr></tbody></table>

## **默认密码政策**

- 强制使用强密码
- 8到100个字符
- 不得重复使用
- 不得过期
- 如果用户通过第三方提供商访问Workspace，则不适用这些要求。

<figure><img src="../../../images/image (20).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../images/image (22).png" alt=""><figcaption></figcaption></figure>

## **服务帐户**

这些是**资源**可以**附加**并访问以便与GCP轻松交互的主体。例如，可以在元数据中访问附加到虚拟机的服务帐户的**身份验证令牌**。\
在使用**IAM和访问范围**时可能会遇到一些**冲突**。例如，您的服务帐户可能具有`compute.instanceAdmin`的IAM角色，但您入侵的实例却受到`https://www.googleapis.com/auth/compute.readonly`的范围限制。这将阻止您使用自动分配给实例的OAuth令牌进行任何更改。

这类似于AWS中的**IAM角色**。但与AWS不同的是，**任何**服务帐户都可以**附加到任何服务**（不需要通过政策允许它）。

您将发现的几个服务帐户实际上是**在您开始使用服务时由GCP自动生成的**，例如：
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
然而，创建和附加到资源的 **自定义服务账户** 也是可能的，格式如下：
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **密钥与令牌**

有两种主要方式可以作为服务账户访问 GCP：

- **通过 OAuth 令牌**：这些令牌可以从元数据端点或窃取的 http 请求中获取，并且受 **访问范围** 的限制。
- **密钥**：这些是公钥和私钥对，允许您作为服务账户签署请求，甚至生成 OAuth 令牌以作为服务账户执行操作。这些密钥是危险的，因为它们更难以限制和控制，这就是 GCP 建议不要生成它们的原因。
- 请注意，每次创建服务账户时，**GCP 会为服务账户生成一个密钥**，用户无法访问（并且不会在 Web 应用程序中列出）。根据 [**这个帖子**](https://www.reddit.com/r/googlecloud/comments/f0ospy/service_account_keys_observations/)，这个密钥是 **GCP 内部使用的**，用于让元数据端点访问生成可访问的 OAuth 令牌。

### **访问范围**

访问范围是 **附加到生成的 OAuth 令牌** 上以访问 GCP API 端点。它们 **限制 OAuth 令牌的权限**。\
这意味着如果一个令牌属于资源的所有者，但在令牌范围内没有访问该资源的权限，则该令牌 **无法被用来（滥用）这些权限**。

谷歌实际上 [建议](https://cloud.google.com/compute/docs/access/service-accounts#service_account_permissions) **不使用访问范围，而完全依赖 IAM**。Web 管理门户实际上强制执行这一点，但访问范围仍然可以通过编程方式应用于使用自定义服务账户的实例。

您可以通过 **查询** 来查看 **分配的范围**：
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
之前的 **scopes** 是使用 **`gcloud`** 生成的 **default**。这是因为当你使用 **`gcloud`** 时，你首先创建一个 OAuth 令牌，然后用它来联系端点。

这些中最重要的 scope 可能是 **`cloud-platform`**，这基本上意味着可以 **访问 GCP 中的任何服务**。

你可以 **在这里找到** [**所有可能的 scopes 列表**](https://developers.google.com/identity/protocols/googlescopes)**。**

如果你有 **`gcloud`** 浏览器凭据，可以通过执行类似以下操作来 **获取其他 scopes 的令牌**：
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
## **Terraform IAM 策略、绑定和成员资格**

根据 terraform 在 [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_project_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_project_iam) 中的定义，使用 terraform 与 GCP 有不同的方法来授予主体对资源的访问权限：

- **成员资格**：您将 **主体作为角色的成员** **没有对角色或主体的限制**。您可以将用户作为角色的成员，然后将组作为同一角色的成员，并且还可以将这些主体（用户和组）设置为其他角色的成员。
- **绑定**：多个 **主体可以绑定到一个角色**。这些 **主体仍然可以绑定或成为其他角色的成员**。但是，如果一个未绑定到角色的主体被设置为 **绑定角色的成员**，下次 **绑定被应用时，成员资格将消失**。
- **策略**：策略是 **权威的**，它指示角色和主体，然后 **这些主体不能有更多的角色，这些角色不能有更多的主体**，除非该策略被修改（即使在其他策略、绑定或成员资格中也不行）。因此，当在策略中指定角色或主体时，所有权限都被 **该策略限制**。显然，如果主体被赋予修改策略或权限提升权限的选项（例如创建新主体并将其绑定到新角色），则可以绕过此限制。

## 参考

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
- [https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)

{{#include ../../../banners/hacktricks-training.md}}
