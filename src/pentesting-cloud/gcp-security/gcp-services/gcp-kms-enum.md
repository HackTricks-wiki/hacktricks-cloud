# GCP - KMS Enum

{{#include ../../../banners/hacktricks-training.md}}

## KMS

[**Cloud Key Management Service**](https://cloud.google.com/kms/docs/) **kriptografik anahtarlar** için güvenli bir depolama alanı olarak hizmet eder; bu anahtarlar **hassas verileri şifrelemek ve şifre çözmek** gibi işlemler için gereklidir. Bu anahtarlar, yapılandırılmış yönetim sağlamak için anahtar halkaları içinde organize edilir. Ayrıca, erişim kontrolü, bireysel anahtar düzeyinde veya tüm anahtar halkası için titizlikle yapılandırılabilir, böylece izinler güvenlik gereksinimleriyle tam olarak uyumlu hale getirilir.

KMS anahtar halkaları **varsayılan olarak küresel** olarak oluşturulur, bu da o anahtar halkasındaki anahtarların herhangi bir bölgeden erişilebilir olduğu anlamına gelir. Ancak, **belirli bölgelerde** özel anahtar halkaları oluşturmak mümkündür.

### Anahtar Koruma Seviyesi

- **Yazılım anahtarları**: Yazılım anahtarları **tamamen yazılımda KMS tarafından oluşturulur ve yönetilir**. Bu anahtarlar **herhangi bir donanım güvenlik modülü (HSM) tarafından korunmaz** ve **test ve geliştirme amaçları** için kullanılabilir. Yazılım anahtarları, düşük güvenlik sağladıkları ve saldırılara karşı hassas oldukları için **üretim** kullanımı için önerilmez.
- **Bulut tabanlı anahtarlar**: Bulut tabanlı anahtarlar, **KMS tarafından bulutta** yüksek derecede kullanılabilir ve güvenilir bir altyapı kullanılarak oluşturulur ve yönetilir. Bu anahtarlar **HSM'ler tarafından korunur**, ancak HSM'ler **belirli bir müşteri için ayrılmamıştır**. Bulut tabanlı anahtarlar, çoğu üretim kullanım durumu için uygundur.
- **Dış anahtarlar**: Dış anahtarlar, **KMS dışında oluşturulur ve yönetilir** ve kriptografik işlemler için KMS'ye aktarılır. Dış anahtarlar, **müşterinin tercihlerine bağlı olarak bir donanım güvenlik modülünde (HSM) veya bir yazılım kütüphanesinde saklanabilir**.

### Anahtar Amaçları

- **Simetrik şifreleme/şifre çözme**: **Her iki işlem için tek bir anahtar kullanarak verileri şifrelemek ve şifre çözmek** için kullanılır. Simetrik anahtarlar, büyük veri hacimlerini şifrelemek ve şifre çözmek için hızlı ve etkilidir.
- **Desteklenen**: [cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt), [cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
- **Asimetrik İmza**: Anahtar paylaşmadan iki taraf arasında güvenli iletişim için kullanılır. Asimetrik anahtarlar, **bir açık anahtar ve bir özel anahtar** içeren bir çift olarak gelir. Açık anahtar başkalarıyla paylaşılırken, özel anahtar gizli tutulur.
- **Desteklenen:** [cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
- **Asimetrik Şifre Çözme**: Bir mesajın veya verinin özgünlüğünü doğrulamak için kullanılır. Bir dijital imza, bir özel anahtar kullanılarak oluşturulur ve ilgili açık anahtar kullanılarak doğrulanabilir.
- **Desteklenen:** [cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
- **MAC İmzası**: **Gizli bir anahtar kullanarak bir mesaj kimlik doğrulama kodu (MAC) oluşturarak veri bütünlüğü ve özgünlüğünü sağlamak** için kullanılır. HMAC, ağ protokolleri ve yazılım uygulamalarında mesaj kimlik doğrulama için yaygın olarak kullanılır.
- **Desteklenen:** [cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign), [cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### Dönüşüm Süresi & İmha için Programlanmış Süre

**Varsayılan olarak**, her **90 günde bir** ama **kolayca** ve **tamamen özelleştirilebilir.**

"İmha için programlanmış" süre, **kullanıcının anahtarın silinmesini istemesinden itibaren geçen süre**dir ve anahtar **silinene kadar** devam eder. Anahtar oluşturulduktan sonra değiştirilemez (varsayılan 1 gün).

### Birincil Versiyon

Her KMS anahtarının birkaç versiyonu olabilir, bunlardan biri **varsayılan** olmalıdır; bu, **KMS anahtarı ile etkileşimde bulunurken bir versiyon belirtilmediğinde kullanılacak olanıdır**.

### Sayım

**Anahtarları listeleme izinlerine sahip olduğunuzda**, onlara erişmenin yolu budur:
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms encrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### Yetki Yükseltme

{{#ref}}
../gcp-privilege-escalation/gcp-kms-privesc.md
{{#endref}}

### Sonrası İstismar

{{#ref}}
../gcp-post-exploitation/gcp-kms-post-exploitation.md
{{#endref}}

## Referanslar

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

{{#include ../../../banners/hacktricks-training.md}}
