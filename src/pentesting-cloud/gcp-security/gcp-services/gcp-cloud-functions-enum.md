# GCP - Cloud Functions Enum

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Functions <a href="#reviewing-cloud-functions" id="reviewing-cloud-functions"></a>

[Google Cloud Functions](https://cloud.google.com/functions/) kodunuzu barındırmak için tasarlanmıştır, bu kod **olaylara yanıt olarak çalıştırılır**, bir ana işletim sisteminin yönetimini gerektirmeden. Ayrıca, bu fonksiyonlar kodun kullanabileceği ortam değişkenlerinin depolanmasını destekler.

### Storage

Cloud Functions **kod GCP Storage'da depolanır**. Bu nedenle, GCP'deki **bucket'lar üzerinde okuma erişimi olan herkes** **Cloud Functions kodunu okuyabilecektir**.\
Kod, aşağıdaki gibi bir bucket'ta depolanır:

- `gcf-sources-<number>-<region>/<function-name>-<uuid>/version-<n>/function-source.zip`
- `gcf-v2-sources-<number>-<region>/<function-name>function-source.zip`

Örneğin:\
`gcf-sources-645468741258-us-central1/function-1-003dcbdf-32e1-430f-a5ff-785a6e238c76/version-4/function-source.zip`

> [!WARNING]
> Cloud Function'ı depolayan **bucket üzerinde okuma yetkisi olan herhangi bir kullanıcı** **çalıştırılan kodu okuyabilir**.

### Artifact Registry

Eğer cloud function, çalıştırılan Docker konteynerinin proje içindeki bir Artifact Registry reposunda depolanacak şekilde yapılandırılmışsa, repo üzerinde okuma erişimi olan herkes resmi indirebilir ve kaynak kodunu kontrol edebilir. Daha fazla bilgi için kontrol edin:

{{#ref}}
gcp-artifact-registry-enum.md
{{#endref}}

### SA

Belirtilmediği takdirde, varsayılan olarak **App Engine Default Service Account** proje üzerinde **Editör izinleri** ile Cloud Function'a eklenir.

### Triggers, URL & Authentication

Bir Cloud Function oluşturulduğunda **tetikleyici** belirtilmelidir. Yaygın bir tetikleyici **HTTPS**'dir, bu **fonksiyonun** web tarayıcısı aracılığıyla tetiklenebileceği bir URL oluşturur.\
Diğer tetikleyiciler pub/sub, Storage, Filestore...

URL formatı **`https://<region>-<project-gcp-name>.cloudfunctions.net/<func_name>`**

HTTPS tetikleyicisi kullanıldığında, **çağrının IAM yetkilendirmesine sahip olması gerekip gerekmediği** veya **herkesin** sadece çağırıp çağıramayacağı da belirtilir:

<figure><img src="../../../images/image (19).png" alt=""><figcaption></figcaption></figure>

### Inside the Cloud Function

Kod, **`/workspace`** klasörüne **indirilir** ve Cloud Function'daki dosyaların sahip olduğu dosya adlarıyla aynı dosya adlarıyla çalıştırılır ve `www-data` kullanıcısıyla yürütülür.\
Disk **salt okunur olarak monte edilmemiştir.**

### Enumeration
```bash
# List functions
gcloud functions list
gcloud functions describe <func_name> # Check triggers to see how is this function invoked
gcloud functions get-iam-policy <func_name>

# Get logs of previous runs. By default, limits to 10 lines
gcloud functions logs read <func_name> --limit [NUMBER]

# Call a function
curl https://<region>-<project>.cloudfunctions.net/<func_name>
gcloud functions call <func_name> --data='{"message": "Hello World!"}'

# If you know the name of projects you could try to BF cloud functions names

# Get events that could be used to trigger a cloud function
gcloud functions event-types list

# Access function with authentication
curl -X POST https://<region>-<project>.cloudfunctions.net/<func_name> \
-H "Authorization: bearer $(gcloud auth print-identity-token)" \
-H "Content-Type: application/json" \
-d '{}'
```
### Yetki Yükseltme

Aşağıdaki sayfada, **bulut işlevi izinlerini kötüye kullanarak yetki yükseltmeyi** kontrol edebilirsiniz:

{{#ref}}
../gcp-privilege-escalation/gcp-cloudfunctions-privesc.md
{{#endref}}

### Kimlik Doğrulaması Olmadan Erişim

{{#ref}}
../gcp-unauthenticated-enum-and-access/gcp-cloud-functions-unauthenticated-enum.md
{{#endref}}

### Sonrası İstismar

{{#ref}}
../gcp-post-exploitation/gcp-cloud-functions-post-exploitation.md
{{#endref}}

### Süreklilik

{{#ref}}
../gcp-persistence/gcp-cloud-functions-persistence.md
{{#endref}}

## Referanslar

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

{{#include ../../../banners/hacktricks-training.md}}
