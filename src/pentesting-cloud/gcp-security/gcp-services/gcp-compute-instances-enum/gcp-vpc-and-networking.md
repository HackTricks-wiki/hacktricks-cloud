# GCP - VPC & Networking

{{#include ../../../../banners/hacktricks-training.md}}

## **GCP Compute Networking in a Nutshell**

**VPCs** περιέχουν **κανόνες τείχους προστασίας** για να επιτρέπουν την εισερχόμενη κίνηση στο VPC. Τα VPCs περιέχουν επίσης **υποδίκτυα** όπου οι **εικονικές μηχανές** θα είναι **συνδεδεμένες**.\
Σε σύγκριση με το AWS, το **τείχος προστασίας** θα ήταν το **πλησιέστερο** πράγμα σε **AWS** **Security Groups και NACLs**, αλλά σε αυτή την περίπτωση αυτοί ορίζονται στο VPC και όχι σε κάθε instance.

## **VPC, Subnetworks & Firewalls in GCP**

Οι Compute Instances είναι συνδεδεμένες σε **υποδίκτυα** που είναι μέρος των **VPCs** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). Στο GCP δεν υπάρχουν ομάδες ασφαλείας, υπάρχουν [**τείχη προστασίας VPC**](https://cloud.google.com/vpc/docs/firewalls) με κανόνες που ορίζονται σε αυτό το επίπεδο δικτύου αλλά εφαρμόζονται σε κάθε VM Instance.

### Subnetworks

Ένα **VPC** μπορεί να έχει **πολλά υποδίκτυα**. Κάθε **υποδίκτυο είναι σε 1 περιοχή**.

### Firewalls

Από προεπιλογή, κάθε δίκτυο έχει δύο [**υπονοούμενους κανόνες τείχους προστασίας**](https://cloud.google.com/vpc/docs/firewalls#default_firewall_rules): **επιτρέπουν την έξοδο** και **αρνούνται την είσοδο**.

Όταν δημιουργείται ένα έργο GCP, δημιουργείται επίσης ένα VPC που ονομάζεται **`default`**, με τους εξής κανόνες τείχους προστασίας:

- **default-allow-internal:** επιτρέπει όλη την κίνηση από άλλες instances στο δίκτυο `default`
- **default-allow-ssh:** επιτρέπει 22 από παντού
- **default-allow-rdp:** επιτρέπει 3389 από παντού
- **default-allow-icmp:** επιτρέπει ping από παντού

> [!WARNING]
> Όπως μπορείτε να δείτε, οι **κανόνες τείχους προστασίας** τείνουν να είναι **πιο επιεικείς** για **εσωτερικές διευθύνσεις IP**. Το προεπιλεγμένο VPC επιτρέπει όλη την κίνηση μεταξύ των Compute Instances.

Περισσότεροι **κανόνες τείχους προστασίας** μπορούν να δημιουργηθούν για το προεπιλεγμένο VPC ή για νέα VPCs. [**Κανόνες τείχους προστασίας**](https://cloud.google.com/vpc/docs/firewalls) μπορούν να εφαρμοστούν σε instances μέσω των εξής **μεθόδων**:

- [**Ετικέτες δικτύου**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
- [**Λογαριασμοί υπηρεσιών**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
- **Όλες οι instances εντός ενός VPC**

Δυστυχώς, δεν υπάρχει μια απλή εντολή `gcloud` για να εμφανίσει όλες τις Compute Instances με ανοιχτές θύρες στο διαδίκτυο. Πρέπει να συνδέσετε τα σημεία μεταξύ των κανόνων τείχους προστασίας, των ετικετών δικτύου, των λογαριασμών υπηρεσιών και των instances.

Αυτή η διαδικασία αυτοματοποιήθηκε χρησιμοποιώντας [αυτό το python script](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_firewall_enum) το οποίο θα εξάγει τα εξής:

- Αρχείο CSV που δείχνει instance, δημόσια IP, επιτρεπόμενο TCP, επιτρεπόμενο UDP
- Σάρωση nmap για να στοχεύσει όλες τις instances σε θύρες εισερχόμενης κίνησης που επιτρέπονται από το δημόσιο διαδίκτυο (0.0.0.0/0)
- masscan για να στοχεύσει το πλήρες εύρος TCP αυτών των instances που επιτρέπουν ΟΛΕΣ τις θύρες TCP από το δημόσιο διαδίκτυο (0.0.0.0/0)

### Hierarchical Firewall Policies <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Οι ιεραρχικές πολιτικές τείχους προστασίας_ σας επιτρέπουν να δημιουργήσετε και να **επιβάλετε μια συνεπή πολιτική τείχους προστασίας σε όλη την οργάνωσή σας**. Μπορείτε να αναθέσετε **ιεραρχικές πολιτικές τείχους προστασίας στην οργάνωση** ως σύνολο ή σε μεμονωμένα **φακέλους**. Αυτές οι πολιτικές περιέχουν κανόνες που μπορούν ρητά να αρνούνται ή να επιτρέπουν συνδέσεις.

Δημιουργείτε και εφαρμόζετε πολιτικές τείχους προστασίας ως ξεχωριστά βήματα. Μπορείτε να δημιουργήσετε και να εφαρμόσετε πολιτικές τείχους προστασίας στους **κόμβους οργάνωσης ή φακέλου της** [**ιεραρχίας πόρων**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Ένας κανόνας πολιτικής τείχους προστασίας μπορεί να **μπλοκάρει συνδέσεις, να επιτρέπει συνδέσεις ή να αναβάλλει την αξιολόγηση κανόνων τείχους προστασίας** σε κατώτερους φακέλους ή κανόνες τείχους προστασίας VPC που ορίζονται σε δίκτυα VPC.

Από προεπιλογή, όλοι οι κανόνες πολιτικής τείχους προστασίας εφαρμόζονται σε όλα τα VMs σε όλα τα έργα κάτω από την οργάνωση ή τον φάκελο όπου σχετίζεται η πολιτική. Ωστόσο, μπορείτε να **περιορίσετε ποια VMs λαμβάνουν έναν συγκεκριμένο κανόνα** καθορίζοντας [στόχους δικτύων ή στόχους λογαριασμών υπηρεσιών](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Μπορείτε να διαβάσετε εδώ πώς να [**δημιουργήσετε μια Ιεραρχική Πολιτική Τείχους Προστασίας**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Firewall Rules Evaluation

<figure><img src="../../../../images/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: Πολιτικές τείχους προστασίας που ανατίθενται στην Οργάνωση
2. Folder: Πολιτικές τείχους προστασίας που ανατίθενται στον Φάκελο
3. VPC: Κανόνες τείχους προστασίας που ανατίθενται στο VPC
4. Global: Ένας άλλος τύπος κανόνων τείχους προστασίας που μπορεί να ανατεθεί σε VPCs
5. Regional: Κανόνες τείχους προστασίας που σχετίζονται με το δίκτυο VPC της NIC του VM και την περιοχή του VM.

## VPC Network Peering

Επιτρέπει τη σύνδεση δύο δικτύων Virtual Private Cloud (VPC) έτσι ώστε οι **πόροι σε κάθε δίκτυο να μπορούν να επικοινωνούν** μεταξύ τους.\
Τα συνδεδεμένα δίκτυα VPC μπορούν να είναι στο ίδιο έργο, σε διαφορετικά έργα της ίδιας οργάνωσης ή **σε διαφορετικά έργα διαφορετικών οργανώσεων**.

Αυτές είναι οι απαραίτητες άδειες:

- `compute.networks.addPeering`
- `compute.networks.updatePeering`
- `compute.networks.removePeering`
- `compute.networks.listPeeringRoutes`

[**Περισσότερα στα έγγραφα**](https://cloud.google.com/vpc/docs/vpc-peering).

## References

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
- [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{{#include ../../../../banners/hacktricks-training.md}}
