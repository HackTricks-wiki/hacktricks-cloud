# GCP - VPC & Networking

{{#include ../../../../banners/hacktricks-training.md}}

## **GCP Compute Networking in a Nutshell**

**VPCs** містять **правила брандмауера** для дозволу вхідного трафіку до VPC. VPC також містять **підмережі**, до яких будуть **підключені** **віртуальні машини**.\
У порівнянні з AWS, **брандмауер** буде **найближчим** до **груп безпеки AWS** та **NACL**, але в цьому випадку вони **визначені в VPC**, а не в кожному екземплярі.

## **VPC, Підмережі та Брандмауери в GCP**

Обчислювальні екземпляри підключені до **підмереж**, які є частиною **VPC** ([Віртуальні приватні хмари](https://cloud.google.com/vpc/docs/vpc)). У GCP немає груп безпеки, є [**брандмауери VPC**](https://cloud.google.com/vpc/docs/firewalls) з правилами, визначеними на цьому мережевому рівні, але застосованими до кожного екземпляра ВМ.

### Підмережі

**VPC** може мати **кілька підмереж**. Кожна **підмережа знаходиться в 1 регіоні**.

### Брандмауери

За замовчуванням, кожна мережа має два [**імпліцитних правила брандмауера**](https://cloud.google.com/vpc/docs/firewalls#default_firewall_rules): **дозволити вихідний** та **заборонити вхідний**.

Коли створюється проект GCP, також створюється VPC під назвою **`default`** з наступними правилами брандмауера:

- **default-allow-internal:** дозволити весь трафік з інших екземплярів у мережі `default`
- **default-allow-ssh:** дозволити 22 з усіх місць
- **default-allow-rdp:** дозволити 3389 з усіх місць
- **default-allow-icmp:** дозволити ping з усіх місць

> [!WARNING]
> Як ви можете бачити, **правила брандмауера** зазвичай є **більш ліберальними** для **внутрішніх IP-адрес**. За замовчуванням VPC дозволяє весь трафік між обчислювальними екземплярами.

Більше **правил брандмауера** можна створити для VPC за замовчуванням або для нових VPC. [**Правила брандмауера**](https://cloud.google.com/vpc/docs/firewalls) можуть бути застосовані до екземплярів через наступні **методи**:

- [**Мережеві теги**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
- [**Службові облікові записи**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
- **Всі екземпляри в межах VPC**

На жаль, немає простого команди `gcloud`, щоб вивести всі обчислювальні екземпляри з відкритими портами в Інтернеті. Вам потрібно з'єднати точки між правилами брандмауера, мережевими тегами, службовими обліковими записами та екземплярами.

Цей процес був автоматизований за допомогою [цього python-скрипта](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_firewall_enum), який експортує наступне:

- CSV-файл, що показує екземпляр, публічний IP, дозволений TCP, дозволений UDP
- nmap-скан для націлювання на всі екземпляри на портах, дозволених з публічного Інтернету (0.0.0.0/0)
- masscan для націлювання на весь TCP-діапазон тих екземплярів, які дозволяють ВСІ TCP порти з публічного Інтернету (0.0.0.0/0)

### Ієрархічні політики брандмауера <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Ієрархічні політики брандмауера_ дозволяють вам створювати та **забезпечувати послідовну політику брандмауера в межах вашої організації**. Ви можете призначати **ієрархічні політики брандмауера організації** в цілому або окремим **папкам**. Ці політики містять правила, які можуть явно забороняти або дозволяти з'єднання.

Ви створюєте та застосовуєте політики брандмауера як окремі етапи. Ви можете створювати та застосовувати політики брандмауера на **організаційних або папкових вузлах** [**ієрархії ресурсів**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Правило політики брандмауера може **блокувати з'єднання, дозволяти з'єднання або відкладати оцінку правила брандмауера** на нижчі папки або правила брандмауера VPC, визначені в мережах VPC.

За замовчуванням, всі правила політики ієрархічного брандмауера застосовуються до всіх ВМ у всіх проектах під організацією або папкою, до якої пов'язана політика. Однак ви можете **обмежити, які ВМ отримують дане правило**, вказавши [цільові мережі або цільові службові облікові записи](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Ви можете прочитати тут, як [**створити ієрархічну політику брандмауера**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Оцінка правил брандмауера

<figure><img src="../../../../images/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: Політики брандмауера, призначені організації
2. Папка: Політики брандмауера, призначені папці
3. VPC: Правила брандмауера, призначені VPC
4. Глобальні: Інший тип правил брандмауера, які можуть бути призначені VPC
5. Регіональні: Правила брандмауера, пов'язані з мережею VPC NIC ВМ та регіоном ВМ.

## Пірінг мереж VPC

Дозволяє підключити дві мережі Віртуальної приватної хмари (VPC), щоб **ресурси в кожній мережі могли спілкуватися** один з одним.\
Пірінгові мережі VPC можуть бути в одному проекті, різних проектах однієї організації або **різних проектах різних організацій**.

Це необхідні дозволи:

- `compute.networks.addPeering`
- `compute.networks.updatePeering`
- `compute.networks.removePeering`
- `compute.networks.listPeeringRoutes`

[**Більше в документації**](https://cloud.google.com/vpc/docs/vpc-peering).

## Посилання

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
- [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{{#include ../../../../banners/hacktricks-training.md}}
