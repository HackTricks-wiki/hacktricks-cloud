# GCP - VPC & Networking

{{#include ../../../../banners/hacktricks-training.md}}

## **GCP Compute Networking in a Nutshell**

**VPC'ler**, **Firewall** kurallarını içerir ve VPC'ye gelen trafiğe izin verir. VPC'ler ayrıca **sanallaştırılmış makinelerin** **bağlanacağı** **alt ağları** içerir.\
AWS ile karşılaştırıldığında, **Firewall**, **AWS** **Güvenlik Grupları ve NACL'lere** en yakın şeydir, ancak bu durumda bunlar **VPC'de** tanımlanmıştır ve her bir örnekte değil.

## **GCP'de VPC, Alt Ağlar & Güvenlik Duvarları**

Hesaplama Örnekleri, **VPC'lerin** ([Sanal Özel Bulutlar](https://cloud.google.com/vpc/docs/vpc)) bir parçası olan **alt ağlara** bağlıdır. GCP'de güvenlik grupları yoktur, bu ağ seviyesinde tanımlanan ancak her VM Örneğine uygulanan [**VPC güvenlik duvarları**](https://cloud.google.com/vpc/docs/firewalls) vardır.

### Alt Ağlar

Bir **VPC**, **birden fazla alt ağa** sahip olabilir. Her **alt ağ 1 bölgede** bulunur.

### Güvenlik Duvarları

Varsayılan olarak, her ağın iki [**anlamlı güvenlik duvarı kuralı**](https://cloud.google.com/vpc/docs/firewalls#default_firewall_rules) vardır: **çıkışa izin ver** ve **girişe engel ol**.

Bir GCP projesi oluşturulduğunda, aşağıdaki güvenlik duvarı kuralları ile birlikte **`default`** adında bir VPC de oluşturulur:

- **default-allow-internal:** `default` ağındaki diğer örneklerden gelen tüm trafiğe izin ver
- **default-allow-ssh:** her yerden 22'ye izin ver
- **default-allow-rdp:** her yerden 3389'a izin ver
- **default-allow-icmp:** her yerden ping'e izin ver

> [!WARNING]
> Gördüğünüz gibi, **güvenlik duvarı kuralları** **iç IP adresleri** için **daha izin verici** olma eğilimindedir. Varsayılan VPC, Hesaplama Örnekleri arasında tüm trafiğe izin verir.

Varsayılan VPC veya yeni VPC'ler için daha fazla **Güvenlik Duvarı kuralı** oluşturulabilir. [**Güvenlik duvarı kuralları**](https://cloud.google.com/vpc/docs/firewalls), aşağıdaki **yöntemler** aracılığıyla örneklere uygulanabilir:

- [**Ağ etiketleri**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
- [**Hizmet hesapları**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
- **Bir VPC içindeki tüm örnekler**

Ne yazık ki, internette açık portlara sahip tüm Hesaplama Örneklerini döken basit bir `gcloud` komutu yoktur. Güvenlik duvarı kuralları, ağ etiketleri, hizmet hesapları ve örnekler arasında bağlantı kurmanız gerekir.

Bu süreç, aşağıdakileri dışa aktaracak olan [bu python betiği](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_firewall_enum) kullanılarak otomatikleştirildi:

- Örnek, genel IP, izin verilen TCP, izin verilen UDP gösteren CSV dosyası
- Genel internetten (0.0.0.0/0) gelen izin verilen portlarda tüm örnekleri hedef alan nmap taraması
- Genel internetten (0.0.0.0/0) Tüm TCP portlarına izin veren bu örneklerin tam TCP aralığını hedef alan masscan

### Hiyerarşik Güvenlik Duvarı Politikaları <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hiyerarşik güvenlik duvarı politikaları_, **kuruluşunuz genelinde tutarlı bir güvenlik duvarı politikası oluşturmanıza ve uygulamanıza** olanak tanır. **Hiyerarşik güvenlik duvarı politikalarını** kuruluşun tamamına veya bireysel **klasörlere** atayabilirsiniz. Bu politikalar, bağlantıları açıkça reddedebilen veya izin verebilen kurallar içerir.

Güvenlik duvarı politikalarını ayrı adımlar olarak oluşturur ve uygularsınız. [**Kaynak hiyerarşisi**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) üzerindeki **kuruluş veya klasör düğümlerinde** güvenlik duvarı politikaları oluşturabilir ve uygulayabilirsiniz. Bir güvenlik duvarı politikası kuralı, **bağlantıları engelleyebilir, bağlantılara izin verebilir veya güvenlik duvarı kuralı değerlendirmesini** daha düşük düzeydeki klasörlere veya VPC ağlarında tanımlanan VPC güvenlik duvarı kurallarına erteleyebilir.

Varsayılan olarak, tüm hiyerarşik güvenlik duvarı politikası kuralları, politikanın ilişkilendirildiği kuruluş veya klasör altındaki tüm projelerdeki tüm VM'lere uygulanır. Ancak, [hedef ağlar veya hedef hizmet hesapları](https://cloud.google.com/vpc/docs/firewall-policies#targets) belirterek hangi VM'lerin belirli bir kuralı alacağını **kısıtlayabilirsiniz**.

Burada [**Hiyerarşik Güvenlik Duvarı Politikası oluşturma**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud) hakkında bilgi alabilirsiniz.

### Güvenlik Duvarı Kuralları Değerlendirmesi

<figure><img src="../../../../images/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

1. Org: Kuruluşa atanan güvenlik duvarı politikaları
2. Klasör: Klasöre atanan güvenlik duvarı politikaları
3. VPC: VPC'ye atanan güvenlik duvarı kuralları
4. Küresel: VPC'lere atanabilen başka bir tür güvenlik duvarı kuralları
5. Bölgesel: VM'nin NIC'sinin ve VM'nin bölgesinin VPC ağı ile ilişkili güvenlik duvarı kuralları.

## VPC Ağ Peering

İki Sanal Özel Bulut (VPC) ağını bağlayarak **her ağdaki kaynakların birbirleriyle iletişim kurmasını** sağlar.\
Eşleştirilmiş VPC ağları aynı projede, aynı kuruluşun farklı projelerinde veya **farklı kuruluşların farklı projelerinde** olabilir.

Gerekli izinler şunlardır:

- `compute.networks.addPeering`
- `compute.networks.updatePeering`
- `compute.networks.removePeering`
- `compute.networks.listPeeringRoutes`

[**Belgelerde daha fazla bilgi**](https://cloud.google.com/vpc/docs/vpc-peering).

## Referanslar

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
- [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

{{#include ../../../../banners/hacktricks-training.md}}
