# GCP - Compute Enum

{{#include ../../../../banners/hacktricks-training.md}}

## GCP VPC & Networking

Jifunze jinsi hii inavyofanya kazi katika:

{{#ref}}
gcp-vpc-and-networking.md
{{#endref}}

### Enumeration
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
Unaweza kwa urahisi kupata compute instances zenye sheria za firewall wazi kwa kutumia [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp_firewall_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp_firewall_enum)

## Compute instances

Hii ndiyo njia unaweza **kukimbia mashine za virtual ndani ya GCP.** Angalia ukurasa huu kwa maelezo zaidi:

{{#ref}}
gcp-compute-instance.md
{{#endref}}

### Enumeration
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Kwa maelezo zaidi kuhusu jinsi ya **SSH** au **kubadilisha metadata** ya mfano ili **kuinua mamlaka,** angalia ukurasa huu:

{{#ref}}
../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md
{{#endref}}

### Kuinua Mamlaka

Katika ukurasa ufuatao, unaweza kuangalia jinsi ya **kutumia ruhusa za kompyuta ili kuinua mamlaka**:

{{#ref}}
../../gcp-privilege-escalation/gcp-compute-privesc/
{{#endref}}

### Enum Isiyo na Utambulisho

{{#ref}}
../../gcp-unauthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md
{{#endref}}

### Baada ya Kutekeleza

{{#ref}}
../../gcp-post-exploitation/gcp-compute-post-exploitation.md
{{#endref}}

### Kudumu

{{#ref}}
../../gcp-persistence/gcp-compute-persistence.md
{{#endref}}

## Kumbukumbu za Mkononi wa Serial

Kumbukumbu za Mkononi wa Serial za Injini ya Kompyuta ni kipengele kinachokuruhusu **kuangalia na kuchanganua kumbukumbu za kuanzisha na mfumo wa uendeshaji** wa mifano yako ya mashine ya virtual.

Kumbukumbu za Mkononi wa Serial zinatoa **mtazamo wa kiwango cha chini wa mchakato wa kuanzisha wa mfano,** ikiwa ni pamoja na ujumbe wa kernel, skripti za kuanzisha, na matukio mengine ya mfumo yanayotokea wakati wa kuanzisha. Hii inaweza kuwa muhimu kwa kutatua matatizo ya kuanzisha, kubaini makosa ya usanidi au makosa ya programu, au kutatua matatizo ya muunganisho wa mtandao.

Kumbukumbu hizi **zinaweza kufichua taarifa nyeti** kutoka kwa kumbukumbu za mfumo ambazo mtumiaji mwenye mamlaka ya chini huenda asione kawaida, lakini kwa ruhusa sahihi za IAM unaweza kuwa na uwezo wa kuzisoma.

Unaweza kutumia amri ifuatayo ya [gcloud](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) kuuliza kumbukumbu za mkoani (ruhusa inayohitajika ni `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Startup Scripts output

Inawezekana kuona **matokeo ya skripti za kuanzisha** kutoka kwa VM inayotekeleza:
```bash
sudo journalctl -u google-startup-scripts.service
```
## OS Configuration Manager

You can use the OS configuration management service to **deploy, query, and maintain consistent configurations** (desired state and software) for your VM instance (VM). On Compute Engine, you must use [guest policies](https://cloud.google.com/compute/docs/os-config-management#guest-policy) to maintain consistent software configurations on a VM.

The OS Configuration management feature allows you to define configuration policies that specify which software packages should be installed, which services should be enabled, and which files or configurations should be present on your VMs. You can use a declarative approach to managing the software configuration of your VMs, which enables you to automate and scale your configuration management process more easily.

This also allow to login in instances via IAM permissions, so it's very **useful for privesc and pivoting**.

> [!WARNING]
> In order to **enable os-config in a whole project or in an instance** you just need to set the **metadata** key **`enable-oslogin`** to **`true`** at the desired level.\
> Moreover, you can set the metadata **`enable-oslogin-2fa`** to **`true`** to enable the 2fa.
>
> When you enable it when crating an instance the metadata keys will be automatically set.

More about **2fa in OS-config**, **inatumika tu ikiwa mtumiaji ni mtumiaji**, ikiwa ni SA (kama SA ya compute) haitahitaji chochote cha ziada.

### Enumeration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Images

### Custom Images

**Picha za kompyuta za kawaida zinaweza kuwa na maelezo nyeti** au mipangilio mingine hatarishi ambayo unaweza kutumia.

Wakati picha inaundwa unaweza kuchagua **aina 3 za usimbuaji**: Kutumia **funguo zinazodhibitiwa na Google** (kawaida), **funguo kutoka KMS**, au **funguo mbichi** iliyotolewa na mteja.

#### Enumeration

Unaweza kuuliza orodha ya picha zisizo za kawaida katika mradi kwa amri ifuatayo:
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
Unaweza kisha [**kutoa**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **diski za virtual** kutoka kwa picha yoyote katika muundo mbalimbali. Amri ifuatayo itatoa picha `test-image` katika muundo wa qcow2, ikiruhusu upakue faili na kujenga VM kwa ndani kwa uchunguzi zaidi:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Kuinua Haki

Angalia sehemu ya kuinua haki za Compute Instances.

### Mifano ya Kijalala Maalum

Mifano ya [**kijalala**](https://cloud.google.com/compute/docs/instance-templates/) **inafafanua mali za kijalala** kusaidia kupeleka usanidi thabiti. Hizi zinaweza kuwa na aina sawa za data nyeti kama metadata maalum ya kijalala kinachofanya kazi. Unaweza kutumia amri zifuatazo kuchunguza:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
It could be interesting to know which disk is new images using, but these templates won't usually have sensitive information.

## Snapshots

The **snapshots are backups of disks**. Note that this is not the same as cloning a disk (another available feature).\
The **snapshot** will use the **same encryption as the disk** it's taken from.

### Enumeration
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Kuinua Mamlaka

Angalia sehemu ya kuinua mamlaka ya Compute Instances.

## Marejeleo

- [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{{#include ../../../../banners/hacktricks-training.md}}
