# GCP - Compute Enum

{{#include ../../../../banners/hacktricks-training.md}}

## GCP VPC & Networking

Bunun nasıl çalıştığını öğrenin:

{{#ref}}
gcp-vpc-and-networking.md
{{#endref}}

### Enumeration
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
Açık güvenlik duvarı kuralları olan compute instance'ları kolayca bulabilirsiniz: [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp_firewall_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp_firewall_enum)

## Compute instance'ları

Bu, **GCP içinde sanal makineleri çalıştırmanın yoludur.** Daha fazla bilgi için bu sayfayı kontrol edin:

{{#ref}}
gcp-compute-instance.md
{{#endref}}

### Enumeration
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Daha fazla bilgi için **SSH** veya bir örneğin **metadata'sını değiştirme** ile **yetki yükseltme** hakkında, bu sayfaya bakın:

{{#ref}}
../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md
{{#endref}}

### Yetki Yükseltme

Aşağıdaki sayfada, **yetki yükseltmek için hesaplama izinlerini nasıl kötüye kullanacağınızı** kontrol edebilirsiniz:

{{#ref}}
../../gcp-privilege-escalation/gcp-compute-privesc/
{{#endref}}

### Kimlik Doğrulaması Olmadan Enum

{{#ref}}
../../gcp-unauthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md
{{#endref}}

### Sömürü Sonrası

{{#ref}}
../../gcp-post-exploitation/gcp-compute-post-exploitation.md
{{#endref}}

### Süreklilik

{{#ref}}
../../gcp-persistence/gcp-compute-persistence.md
{{#endref}}

## Seri Konsol Günlükleri

Compute Engine Seri Konsol Günlükleri, sanal makine örneklerinizin **başlatma ve işletim sistemi günlüklerini görüntülemenizi ve teşhis etmenizi** sağlayan bir özelliktir.

Seri Konsol Günlükleri, örneğin başlatma sürecinin **düşük seviyeli bir görünümünü** sağlar; bu, çekirdek mesajları, başlatma betikleri ve başlatma sırasında meydana gelen diğer sistem olaylarını içerir. Bu, başlatma sorunlarını gidermek, yanlış yapılandırmaları veya yazılım hatalarını tanımlamak veya ağ bağlantısı sorunlarını çözmek için yararlı olabilir.

Bu günlükler, düşük yetkili bir kullanıcının genellikle göremeyeceği sistem günlüklerinden **hassas bilgileri açığa çıkarabilir**, ancak uygun IAM izinleri ile bunları okuyabilirsiniz.

Aşağıdaki [gcloud komutunu](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) kullanarak seri port günlüklerini sorgulayabilirsiniz (gerekli izin `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Startup Scripts output

VM'yi çalıştırarak **başlangıç betiklerinin çıktısını** görmek mümkündür:
```bash
sudo journalctl -u google-startup-scripts.service
```
## OS Configuration Manager

OS yapılandırma yönetim hizmetini kullanarak **VM örneğiniz için tutarlı yapılandırmalar** (istenen durum ve yazılım) **dağıtabilir, sorgulayabilir ve sürdürebilirsiniz**. Compute Engine'de, bir VM'de tutarlı yazılım yapılandırmalarını sürdürmek için [guest policies](https://cloud.google.com/compute/docs/os-config-management#guest-policy) kullanmalısınız.

OS Yapılandırma yönetim özelliği, hangi yazılım paketlerinin yüklenmesi gerektiğini, hangi hizmetlerin etkinleştirilmesi gerektiğini ve VM'lerinizde hangi dosyaların veya yapılandırmaların bulunması gerektiğini belirten yapılandırma politikaları tanımlamanıza olanak tanır. VM'lerinizin yazılım yapılandırmasını yönetmek için deklaratif bir yaklaşım kullanabilirsiniz, bu da yapılandırma yönetim sürecinizi daha kolay otomatikleştirmenizi ve ölçeklendirmenizi sağlar.

Bu ayrıca IAM izinleri aracılığıyla örneklere giriş yapmayı sağlar, bu nedenle **privesc ve pivoting için çok faydalıdır**.

> [!WARNING]
> **Tüm bir projede veya bir örnekte os-config'i etkinleştirmek için** sadece **metadata** anahtarını **`enable-oslogin`** **`true`** olarak ayarlamanız gerekir.\
> Ayrıca, 2fa'yı etkinleştirmek için metadata **`enable-oslogin-2fa`** anahtarını **`true`** olarak ayarlayabilirsiniz.
>
> Bir örnek oluştururken bunu etkinleştirdiğinizde, metadata anahtarları otomatik olarak ayarlanacaktır.

**OS-config'de 2fa hakkında daha fazla bilgi**, **sadece kullanıcı bir kullanıcıysa geçerlidir**, eğer bir SA (örneğin compute SA) ise ekstra bir şey gerektirmeyecektir.

### Enumeration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Görseller

### Özel Görseller

**Özel hesaplama görselleri hassas detaylar** veya istismar edebileceğiniz diğer savunmasız yapılandırmalar içerebilir.

Bir görsel oluşturulduğunda **3 tür şifreleme** seçebilirsiniz: **Google yönetimli anahtarı** (varsayılan), **KMS'den bir anahtar** veya müşterinin verdiği **ham anahtar**.

#### Sayım

Aşağıdaki komut ile bir projedeki standart dışı görsellerin listesini sorgulayabilirsiniz:
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
Ardından, herhangi bir görüntüden [**dışa aktarabilirsiniz**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **sanallaştırma disklerini** birden fazla formatta. Aşağıdaki komut, `test-image` görüntüsünü qcow2 formatında dışa aktarır ve dosyayı indirip yerel olarak daha fazla inceleme için bir VM oluşturmanıza olanak tanır:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Yetki Yükseltme

Compute Instances yetki yükseltme bölümünü kontrol edin.

### Özel Instance Şablonları

Bir [**instance şablonu**](https://cloud.google.com/compute/docs/instance-templates/) **instance özelliklerini tanımlar** ve tutarlı yapılandırmaların dağıtımına yardımcı olur. Bunlar, çalışan bir instance'ın özel meta verileriyle aynı türde hassas verileri içerebilir. Araştırmak için aşağıdaki komutları kullanabilirsiniz:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Yeni görüntülerin hangi diski kullandığını bilmek ilginç olabilir, ancak bu şablonlar genellikle hassas bilgi içermez.

## Snapshots

**Snapshots, disklerin yedekleridir**. Bunun, bir diski klonlamakla (başka bir mevcut özellik) aynı olmadığını unutmayın.\
**Snapshot**, alındığı **disk ile aynı şifrelemeyi** kullanacaktır.

### Enumeration
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Yetki Yükseltme

Compute Instances yetki yükseltme bölümünü kontrol edin.

## Referanslar

- [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{{#include ../../../../banners/hacktricks-training.md}}
