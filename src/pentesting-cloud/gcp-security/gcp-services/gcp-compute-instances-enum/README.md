# GCP - Compute Enum

{{#include ../../../../banners/hacktricks-training.md}}

## GCP VPC y Redes

Aprenda cómo funciona esto en:

{{#ref}}
gcp-vpc-and-networking.md
{{#endref}}

### Enumeración
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
Puedes encontrar fácilmente instancias de cómputo con reglas de firewall abiertas en [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp_firewall_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp_firewall_enum)

## Instancias de cómputo

Esta es la forma en que puedes **ejecutar máquinas virtuales dentro de GCP.** Consulta esta página para más información:

{{#ref}}
gcp-compute-instance.md
{{#endref}}

### Enumeración
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Para más información sobre cómo **SSH** o **modificar los metadatos** de una instancia para **escalar privilegios**, consulta esta página:

{{#ref}}
../../gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md
{{#endref}}

### Escalamiento de Privilegios

En la siguiente página, puedes consultar cómo **abusar de los permisos de cómputo para escalar privilegios**:

{{#ref}}
../../gcp-privilege-escalation/gcp-compute-privesc/
{{#endref}}

### Enumeración No Autenticada

{{#ref}}
../../gcp-unauthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md
{{#endref}}

### Post Explotación

{{#ref}}
../../gcp-post-exploitation/gcp-compute-post-exploitation.md
{{#endref}}

### Persistencia

{{#ref}}
../../gcp-persistence/gcp-compute-persistence.md
{{#endref}}

## Registros de Consola Serial

Los Registros de Consola Serial de Compute Engine son una característica que te permite **ver y diagnosticar los registros de arranque y del sistema operativo** de tus instancias de máquina virtual.

Los Registros de Consola Serial proporcionan una **vista de bajo nivel del proceso de arranque de la instancia**, incluidos los mensajes del kernel, scripts de inicio y otros eventos del sistema que ocurren durante el arranque. Esto puede ser útil para depurar problemas de arranque, identificar configuraciones incorrectas o errores de software, o solucionar problemas de conectividad de red.

Estos registros **pueden exponer información sensible** de los registros del sistema que un usuario de bajo privilegio normalmente no vería, pero con los permisos de IAM apropiados, podrías ser capaz de leerlos.

Puedes usar el siguiente [comando gcloud](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) para consultar los registros del puerto serial (el permiso requerido es `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Salida de Scripts de Inicio

Es posible ver la **salida de los scripts de inicio** desde la VM ejecutando:
```bash
sudo journalctl -u google-startup-scripts.service
```
## OS Configuration Manager

Puedes usar el servicio de gestión de configuración del sistema operativo para **desplegar, consultar y mantener configuraciones consistentes** (estado deseado y software) para tu instancia de VM (máquina virtual). En Compute Engine, debes usar [políticas de invitado](https://cloud.google.com/compute/docs/os-config-management#guest-policy) para mantener configuraciones de software consistentes en una VM.

La función de gestión de configuración del sistema operativo te permite definir políticas de configuración que especifican qué paquetes de software deben instalarse, qué servicios deben habilitarse y qué archivos o configuraciones deben estar presentes en tus VMs. Puedes usar un enfoque declarativo para gestionar la configuración de software de tus VMs, lo que te permite automatizar y escalar tu proceso de gestión de configuración más fácilmente.

Esto también permite iniciar sesión en instancias a través de permisos de IAM, por lo que es muy **útil para privesc y pivoting**.

> [!WARNING]
> Para **habilitar os-config en todo un proyecto o en una instancia** solo necesitas establecer la clave de **metadata** **`enable-oslogin`** en **`true`** al nivel deseado.\
> Además, puedes establecer la metadata **`enable-oslogin-2fa`** en **`true`** para habilitar el 2fa.
>
> Cuando lo habilitas al crear una instancia, las claves de metadata se establecerán automáticamente.

Más sobre **2fa en OS-config**, **solo se aplica si el usuario es un usuario**, si es un SA (como el SA de cómputo) no requerirá nada extra.

### Enumeration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Imágenes

### Imágenes Personalizadas

**Las imágenes de cómputo personalizadas pueden contener detalles sensibles** u otras configuraciones vulnerables que puedes explotar.

Cuando se crea una imagen, puedes elegir **3 tipos de cifrado**: Usando **clave gestionada por Google** (predeterminado), una **clave de KMS**, o una **clave en bruto** proporcionada por el cliente.

#### Enumeración

Puedes consultar la lista de imágenes no estándar en un proyecto con el siguiente comando:
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
Puedes entonces [**exportar**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **los discos virtuales** de cualquier imagen en múltiples formatos. El siguiente comando exportaría la imagen `test-image` en formato qcow2, permitiéndote descargar el archivo y construir una VM localmente para una investigación adicional:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Escalación de Privilegios

Consulta la sección de escalación de privilegios de las Instancias de Cómputo.

### Plantillas de Instancia Personalizadas

Una [**plantilla de instancia**](https://cloud.google.com/compute/docs/instance-templates/) **define las propiedades de la instancia** para ayudar a implementar configuraciones consistentes. Estas pueden contener los mismos tipos de datos sensibles que los metadatos personalizados de una instancia en ejecución. Puedes usar los siguientes comandos para investigar:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Podría ser interesante saber qué disco están utilizando las nuevas imágenes, pero estas plantillas generalmente no tendrán información sensible.

## Snapshots

Los **snapshots son copias de seguridad de discos**. Tenga en cuenta que esto no es lo mismo que clonar un disco (otra función disponible).\
El **snapshot** utilizará la **misma encriptación que el disco** del que se toma.

### Enumeration
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Escalación de Privilegios

Consulta la sección de escalación de privilegios de las Instancias de Cómputo.

## Referencias

- [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

{{#include ../../../../banners/hacktricks-training.md}}
