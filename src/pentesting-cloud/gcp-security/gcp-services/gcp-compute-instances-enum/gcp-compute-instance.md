# GCP - Compute Instances

{{#include ../../../../banners/hacktricks-training.md}}

## Basic Information

Google Cloud Compute Instances ni **mashine za virtual zinazoweza kubadilishwa kwenye miundombinu ya wingu ya Google**, zinazotoa nguvu za kompyuta zinazoweza kupanuliwa na zinazohitajika kwa matumizi mbalimbali. Zinatoa vipengele kama vile usambazaji wa kimataifa, uhifadhi wa kudumu, chaguo za OS zinazoweza kubadilishwa, na ushirikiano mzuri wa mtandao na usalama, na kuifanya kuwa chaguo bora kwa kuhost tovuti, kuchakata data, na kuendesha programu kwa ufanisi katika wingu.

### Confidential VM

Confidential VMs hutumia **vipengele vya usalama vinavyotegemea vifaa** vinavyotolewa na kizazi kipya cha AMD EPYC processors, ambacho kinajumuisha usimbuaji wa kumbukumbu na virtualisasi iliyosimbwa kwa usalama. Vipengele hivi vinamwezesha VM kulinda data inayochakatwa na kuhifadhiwa ndani yake hata kutoka kwa mfumo wa uendeshaji wa mwenyeji na hypervisor.

Ili kuendesha Confidential VM inaweza kuhitaji **kubadilisha** mambo kama vile **aina** ya **mashine**, **kiunganishi** cha mtandao, **picha ya diski ya kuanzisha**.

### Disk & Disk Encryption

Inawezekana **kuchagua diski** ya kutumia au **kuunda mpya**. Ikiwa unachagua mpya unaweza:

- Kuchagua **ukubwa** wa diski
- Kuchagua **OS**
- Kuonyesha ikiwa unataka **kufuta diski wakati mfano unafutwa**
- **Usimbuaji**: Kwa **kawaida** funguo **zinazosimamiwa na Google** zitatumika, lakini unaweza pia **kuchagua funguo kutoka KMS** au kuonyesha **funguo za kawaida za kutumia**.

### Deploy Container

Inawezekana kupeleka **container** ndani ya mashine ya virtual.\
Inawezekana kusanidi **picha** ya kutumia, kuweka **amri** ya kuendesha ndani, **hoja**, kuunganisha **kiasi**, na **mabadiliko ya mazingira** (habari nyeti?) na kusanidi chaguzi kadhaa kwa container hii kama kuendesha kama **mwenye mamlaka**, stdin na pseudo TTY.

### Service Account

Kwa kawaida, **akaunti ya huduma ya Compute Engine** itatumika. Barua pepe ya SA hii ni kama: `<proj-num>-compute@developer.gserviceaccount.com`\
Akaunti hii ya huduma ina **nafasi ya Mhariri juu ya mradi mzima (mamlaka ya juu).**

Na **mipaka ya ufikiaji ya kawaida** ni kama ifuatavyo:

- **https://www.googleapis.com/auth/devstorage.read\_only** -- Ufikiaji wa kusoma kwenye ndoo :)
- https://www.googleapis.com/auth/logging.write
- https://www.googleapis.com/auth/monitoring.write
- https://www.googleapis.com/auth/servicecontrol
- https://www.googleapis.com/auth/service.management.readonly
- https://www.googleapis.com/auth/trace.append

Hata hivyo, inawezekana **kutoa `cloud-platform` kwa kubonyeza** au kubainisha **za kawaida**.

<figure><img src="../../../../images/image (327).png" alt=""><figcaption></figcaption></figure>

### Firewall

Inawezekana kuruhusu trafiki ya HTTP na HTTPS.

<figure><img src="../../../../images/image (326).png" alt=""><figcaption></figcaption></figure>

### Networking

- **IP Forwarding**: Inawezekana **kuwezesha IP forwarding** kutoka kwa uundaji wa mfano.
- **Hostname**: Inawezekana kutoa mfano jina la kudumu.
- **Interface**: Inawezekana kuongeza kiunganishi cha mtandao.

### Extra Security

Chaguzi hizi zitafanya **kuongeza usalama** wa VM na zinapendekezwa:

- **Secure boot:** Secure boot husaidia kulinda mfano wako wa VM dhidi ya malware na rootkits za kiwango cha kuanzisha na kernel.
- **Enable vTPM:** Virtual Trusted Platform Module (vTPM) inathibitisha uadilifu wa kuanzisha na boot ya VM yako ya wageni, na inatoa uzalishaji wa funguo na ulinzi.
- **Integrity supervision:** Ufuatiliaji wa uadilifu unakuwezesha kufuatilia na kuthibitisha uadilifu wa boot wa wakati wa kuendesha wa mfano wako wa VM uliohifadhiwa kwa kutumia ripoti za Stackdriver. Inahitaji vTPM iwezeshe.

### VM Access

Njia ya kawaida ya kuwezesha ufikiaji kwa VM ni kwa **kuruhusu funguo fulani za umma za SSH** kufikia VM.\
Hata hivyo, inawezekana pia **kuwezesha ufikiaji kwa VM kupitia huduma ya `os-config` kwa kutumia IAM**. Zaidi ya hayo, inawezekana kuwezesha 2FA ili kufikia VM kwa kutumia huduma hii.\
Wakati **huduma hii** ime **wezesha**, ufikiaji kupitia **funguo za SSH umezuiliwa.**

<figure><img src="../../../../images/image (328).png" alt=""><figcaption></figcaption></figure>

### Metadata

Inawezekana kufafanua **automatisering** (userdata katika AWS) ambayo ni **amri za shell** ambazo zitatekelezwa kila wakati mashine inapoanzishwa au kuanzisha upya.

Pia inawezekana **kuongeza funguo za metadata za ziada** ambazo zitakuwa zinapatikana kutoka kwa kiunganishi cha metadata. Habari hii mara nyingi hutumiwa kwa mabadiliko ya mazingira na scripts za kuanzisha/kuzima. Hii inaweza kupatikana kwa kutumia **`describe` method** kutoka kwa amri katika sehemu ya uainishaji, lakini pia inaweza kupatikana kutoka ndani ya mfano kwa kufikia kiunganishi cha metadata.
```bash
# view project metadata
curl "http://metadata.google.internal/computeMetadata/v1/project/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"

# view instance metadata
curl "http://metadata.google.internal/computeMetadata/v1/instance/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"
```
Moreover, **auth token for the attached service account** and **general info** about the instance, network and project is also going to be available from the **metadata endpoint**. For more info check:

{{#ref}}
https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440
{{#endref}}

### Encryption

A Google-managed encryption key is used by default lakini a Customer-managed encryption key (CMEK) can be configured. You can also configure what to do when the used CMEF is revoked: Noting or shut down the VM.

<figure><img src="../../../../images/image (329).png" alt=""><figcaption></figcaption></figure>

{{#include ../../../../banners/hacktricks-training.md}}
