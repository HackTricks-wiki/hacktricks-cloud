# GCP - Vertex AI 枚举

{{#include ../../../banners/hacktricks-training.md}}

## Vertex AI

[Vertex AI](https://cloud.google.com/vertex-ai) 是 Google Cloud 的 **统一机器学习平台**，用于在大规模环境中构建、部署和管理 AI 模型。它将各种 AI 和 ML 服务整合到单一平台中，使数据科学家和 ML 工程师能够：

- **训练自定义模型**，使用 AutoML 或自定义训练
- **部署模型** 到可扩展的 endpoints 以进行预测
- **管理 ML 生命周期**，从实验到生产
- **访问预训练模型**，来自 Model Garden
- **监控和优化** 模型性能

### 关键组件

#### 模型

Vertex AI 的 **模型** 代表已训练的机器学习模型，可部署到 endpoints 提供预测。模型可以：

- **从自定义容器或模型工件上传**
- 通过 **AutoML** 训练创建
- **从 Model Garden 导入**（预训练模型）
- **版本化**，每个模型可有多个版本

每个模型都有元数据，包括其 framework、container image URI、artifact location 和 serving configuration。

#### Endpoints

**Endpoints** 是承载已部署模型并提供在线预测的资源。主要特性：

- 可以托管 **多个已部署模型**（并支持流量拆分）
- 提供用于实时预测的 **HTTPS endpoints**
- 支持基于流量的 **autoscaling**
- 可配置为 **private** 或 **public** 访问
- 通过流量拆分支持 **A/B testing**

#### Custom Jobs

**Custom jobs** 允许你使用自己的容器或 Python 包运行自定义训练代码。特性包括：

- 支持 **分布式训练**（使用多个 worker pool）
- 可配置的 **machine types** 和 **accelerators**（GPUs/TPUs）
- 可以附加 **service account** 以访问其他 GCP 资源
- 与 **Vertex AI Tensorboard** 集成用于可视化
- 支持 **VPC connectivity** 选项

#### Hyperparameter Tuning Jobs

这些作业通过运行多个具有不同参数组合的训练试验自动 **搜索最佳超参数**。

#### Model Garden

**Model Garden** 提供访问：

- Google 的预训练模型
- 开源模型（包括 Hugging Face）
- 第三方模型
- 一键部署能力

#### Tensorboards

**Tensorboards** 为 ML 实验提供可视化和监控，跟踪指标、模型图和训练进度。

### 服务账号与权限

默认情况下，Vertex AI 服务使用 **Compute Engine default service account**（`PROJECT_NUMBER-compute@developer.gserviceaccount.com`），该账号在项目上具有 **Editor** 权限。不过，你可以在以下情况下指定自定义 service accounts：

- 创建 custom jobs 时
- 上传模型时
- 将模型部署到 endpoints 时

该 service account 用于：
- 访问 Cloud Storage 中的训练数据
- 将日志写入 Cloud Logging
- 从 Secret Manager 访问 secrets
- 与其他 GCP 服务交互

### 数据存储

- **Model artifacts** 存储在 **Cloud Storage** bucket 中
- **Training data** 通常位于 Cloud Storage 或 BigQuery
- **Container images** 存储在 **Artifact Registry** 或 Container Registry
- **Logs** 发送到 **Cloud Logging**
- **Metrics** 发送到 **Cloud Monitoring**

### 加密

默认情况下，Vertex AI 使用 **Google-managed encryption keys**。你也可以配置：

- 来自 Cloud KMS 的 **Customer-managed encryption keys (CMEK)**
- 加密适用于模型工件、训练数据和 endpoints

### 网络

Vertex AI 资源可以配置为：

- **Public internet access**（默认）
- 使用 **VPC peering** 实现私有访问
- 使用 **Private Service Connect** 提供安全连接
- 支持 **Shared VPC**

### 枚举
```bash
# List models
gcloud ai models list --region=<region>
gcloud ai models describe <model-id> --region=<region>
gcloud ai models list-version <model-id> --region=<region>

# List endpoints
gcloud ai endpoints list --region=<region>
gcloud ai endpoints describe <endpoint-id> --region=<region>
gcloud ai endpoints list --list-model-garden-endpoints-only --region=<region>

# List custom jobs
gcloud ai custom-jobs list --region=<region>
gcloud ai custom-jobs describe <job-id> --region=<region>

# Stream logs from a running job
gcloud ai custom-jobs stream-logs <job-id> --region=<region>

# List hyperparameter tuning jobs
gcloud ai hp-tuning-jobs list --region=<region>
gcloud ai hp-tuning-jobs describe <job-id> --region=<region>

# List model monitoring jobs
gcloud ai model-monitoring-jobs list --region=<region>
gcloud ai model-monitoring-jobs describe <job-id> --region=<region>

# List Tensorboards
gcloud ai tensorboards list --region=<region>
gcloud ai tensorboards describe <tensorboard-id> --region=<region>

# List indexes (for vector search)
gcloud ai indexes list --region=<region>
gcloud ai indexes describe <index-id> --region=<region>

# List index endpoints
gcloud ai index-endpoints list --region=<region>
gcloud ai index-endpoints describe <index-endpoint-id> --region=<region>

# Get operations (long-running operations status)
gcloud ai operations describe <operation-id> --region=<region>

# Test endpoint predictions (if you have access)
gcloud ai endpoints predict <endpoint-id> \
--region=<region> \
--json-request=request.json

# Make direct predictions (newer API)
gcloud ai endpoints direct-predict <endpoint-id> \
--region=<region> \
--json-request=request.json
```
### 模型信息收集
```bash
# Get detailed model information including versions
gcloud ai models describe <model-id> --region=<region>

# Check specific model version
gcloud ai models describe <model-id>@<version> --region=<region>

# List all versions of a model
gcloud ai models list-version <model-id> --region=<region>

# Get model artifact location (usually a GCS bucket)
gcloud ai models describe <model-id> --region=<region> --format="value(artifactUri)"

# Get container image URI
gcloud ai models describe <model-id> --region=<region> --format="value(containerSpec.imageUri)"
```
### 端点详细信息
```bash
# Get endpoint details including deployed models
gcloud ai endpoints describe <endpoint-id> --region=<region>

# Get endpoint URL
gcloud ai endpoints describe <endpoint-id> --region=<region> --format="value(deployedModels[0].displayName)"

# Get service account used by endpoint
gcloud ai endpoints describe <endpoint-id> --region=<region> --format="value(deployedModels[0].serviceAccount)"

# Check traffic split between models
gcloud ai endpoints describe <endpoint-id> --region=<region> --format="value(trafficSplit)"
```
### 自定义作业信息
```bash
# Get job details including command, args, and service account
gcloud ai custom-jobs describe <job-id> --region=<region>

# Get service account used by job
gcloud ai custom-jobs describe <job-id> --region=<region> --format="value(jobSpec.workerPoolSpecs[0].serviceAccount)"

# Get container image used
gcloud ai custom-jobs describe <job-id> --region=<region> --format="value(jobSpec.workerPoolSpecs[0].containerSpec.imageUri)"

# Check environment variables (may contain secrets)
gcloud ai custom-jobs describe <job-id> --region=<region> --format="value(jobSpec.workerPoolSpecs[0].containerSpec.env)"

# Get network configuration
gcloud ai custom-jobs describe <job-id> --region=<region> --format="value(jobSpec.network)"
```
### 访问控制
```bash
# Note: IAM policies for individual Vertex AI resources are managed at the project level
# Check project-level permissions
gcloud projects get-iam-policy <project-id>

# Check service account permissions
gcloud iam service-accounts get-iam-policy <service-account-email>

# Check if endpoints allow unauthenticated access
# This is controlled by IAM bindings on the endpoint
gcloud projects get-iam-policy <project-id> \
--flatten="bindings[].members" \
--filter="bindings.role:aiplatform.user"
```
### 存储与工件
```bash
# Models and training jobs often store artifacts in GCS
# List buckets that might contain model artifacts
gsutil ls

# Common artifact locations:
# gs://<project>-aiplatform-<region>/
# gs://<project>-vertex-ai/
# gs://<custom-bucket>/vertex-ai/

# Download model artifacts if accessible
gsutil -m cp -r gs://<bucket>/path/to/artifacts ./artifacts/

# Check for notebooks in AI Platform Notebooks
gcloud notebooks instances list --location=<location>
gcloud notebooks instances describe <instance-name> --location=<location>
```
### Model Garden
```bash
# List Model Garden endpoints
gcloud ai endpoints list --list-model-garden-endpoints-only --region=<region>

# Model Garden models are often deployed with default configurations
# Check for publicly accessible endpoints
```
### Privilege Escalation

在下面的页面中，您可以查看如何 **abuse Vertex AI permissions to escalate privileges**：

{{#ref}}
../gcp-privilege-escalation/gcp-vertex-ai-privesc.md
{{#endref}}

## 参考资料

- [https://cloud.google.com/vertex-ai/docs](https://cloud.google.com/vertex-ai/docs)
- [https://cloud.google.com/vertex-ai/docs/reference/rest](https://cloud.google.com/vertex-ai/docs/reference/rest)

{{#include ../../../banners/hacktricks-training.md}}
