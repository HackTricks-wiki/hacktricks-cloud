# GCP - IAM, Principals & Org Policies Enum

{{#include ../../../banners/hacktricks-training.md}}

## Λογαριασμοί Υπηρεσιών

Για μια εισαγωγή σχετικά με το τι είναι ένας λογαριασμός υπηρεσίας, δείτε:

{{#ref}}
../gcp-basic-information/
{{#endref}}

### Καταμέτρηση

Ένας λογαριασμός υπηρεσίας ανήκει πάντα σε ένα έργο:
```bash
gcloud iam service-accounts list --project <project>
```
## Χρήστες & Ομάδες

Για μια εισαγωγή σχετικά με το πώς λειτουργούν οι Χρήστες & Ομάδες στο GCP, δείτε:

{{#ref}}
../gcp-basic-information/
{{#endref}}

### Αρίθμηση

Με τις άδειες **`serviceusage.services.enable`** και **`serviceusage.services.use`** είναι δυνατή η **ενεργοποίηση υπηρεσιών** σε ένα έργο και η χρήση τους.

> [!CAUTION]
> Σημειώστε ότι από προεπιλογή, οι χρήστες του Workspace έχουν τον ρόλο **Δημιουργός Έργου**, δίνοντάς τους πρόσβαση για **δημιουργία νέων έργων**. Όταν ένας χρήστης δημιουργεί ένα έργο, του αποδίδεται ο ρόλος **`owner`** σε αυτό. Έτσι, θα μπορούσε να **ενεργοποιήσει αυτές τις υπηρεσίες στο έργο για να μπορέσει να αρίθμηση το Workspace**.
>
> Ωστόσο, σημειώστε ότι είναι επίσης απαραίτητο να έχετε **αρκετές άδειες στο Workspace** για να μπορέσετε να καλέσετε αυτές τις APIs.

Αν μπορείτε να **ενεργοποιήσετε την υπηρεσία `admin`** και αν ο χρήστης σας έχει **αρκετά προνόμια στο workspace,** θα μπορούσατε να **αριθμήσετε όλες τις ομάδες & χρήστες** με τις παρακάτω γραμμές.\
Ακόμα και αν λέει **`identity groups`**, επιστρέφει επίσης **χρήστες χωρίς καμία ομάδα**:
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
> [!TIP]
> Στα προηγούμενα παραδείγματα, η παράμετρος `--labels` είναι υποχρεωτική, οπότε χρησιμοποιείται μια γενική τιμή (δεν απαιτείται αν χρησιμοποιήσετε την API απευθείας όπως [**το κάνει το PurplePanda εδώ**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc_groups_users.py).

Ακόμα και με την υπηρεσία διαχειριστή ενεργοποιημένη, είναι πιθανό να λάβετε ένα σφάλμα κατά την καταμέτρηση τους επειδή ο χρήστης του workspace που έχει παραβιαστεί δεν έχει αρκετές άδειες:

<figure><img src="../../../images/image (193).png" alt=""><figcaption></figcaption></figure>

## IAM

Δείτε [**αυτό για βασικές πληροφορίες σχετικά με το IAM**](../gcp-basic-information/#iam-roles).

### Προεπιλεγμένες Άδειες

Από τα [**έγγραφα**](https://cloud.google.com/resource-manager/docs/default-access-control): Όταν δημιουργείται ένας πόρος οργανισμού, όλοι οι χρήστες στο τομέα σας λαμβάνουν από προεπιλογή τους ρόλους **Δημιουργού Λογαριασμού Χρέωσης** και **Δημιουργού Έργου**. Αυτοί οι προεπιλεγμένοι ρόλοι επιτρέπουν στους χρήστες σας να αρχίσουν να χρησιμοποιούν το Google Cloud αμέσως, αλλά δεν προορίζονται για χρήση στη κανονική λειτουργία του πόρου οργανισμού σας.

Αυτοί οι **ρόλοι** παρέχουν τις **άδειες**:

- `billing.accounts.create` και `resourcemanager.organizations.get`
- `resourcemanager.organizations.get` και `resourcemanager.projects.create`

Επιπλέον, όταν ένας χρήστης δημιουργεί ένα έργο, του **χορηγείται αυτόματα ο ιδιοκτήτης αυτού του έργου** σύμφωνα με τα [έγγραφα](https://cloud.google.com/resource-manager/docs/access-control-proj). Επομένως, από προεπιλογή, ένας χρήστης θα μπορεί να δημιουργήσει ένα έργο και να εκτελέσει οποιαδήποτε υπηρεσία σε αυτό (miners; καταμέτρηση Workspace; ...)

> [!CAUTION]
> Η υψηλότερη άδεια σε μια GCP Οργάνωση είναι ο ρόλος **Διαχειριστή Οργάνωσης**.

### set-iam-policy vs add-iam-policy-binding

Στις περισσότερες υπηρεσίες θα μπορείτε να αλλάξετε τις άδειες σε έναν πόρο χρησιμοποιώντας τη μέθοδο **`add-iam-policy-binding`** ή **`set-iam-policy`**. Η κύρια διαφορά είναι ότι το **`add-iam-policy-binding` προσθέτει μια νέα σύνδεση ρόλου** στην υπάρχουσα πολιτική IAM ενώ το **`set-iam-policy`** θα **διαγράψει τις προηγουμένως** χορηγηθείσες άδειες και θα **ορίσει μόνο αυτές** που υποδεικνύονται στην εντολή.

### Enumeration
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
### cloudasset IAM Enumeration

Υπάρχουν διάφοροι τρόποι για να ελέγξετε όλες τις άδειες ενός χρήστη σε διάφορους πόρους (όπως οργανισμούς, φακέλους, έργα...) χρησιμοποιώντας αυτή την υπηρεσία.

- Η άδεια **`cloudasset.assets.searchAllIamPolicies`** μπορεί να ζητήσει **όλες τις iam πολιτικές** μέσα σε έναν πόρο.
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
- Η άδεια **`cloudasset.assets.analyzeIamPolicy`** μπορεί να ζητήσει **όλες τις πολιτικές iam** ενός φορέα μέσα σε έναν πόρο.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
- Η άδεια **`cloudasset.assets.searchAllResources`** επιτρέπει την καταγραφή όλων των πόρων ενός οργανισμού, φακέλου ή έργου. Περιλαμβάνονται οι πόροι που σχετίζονται με το IAM (όπως οι ρόλοι).
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
- Η άδεια **`cloudasset.assets.analyzeMove`** μπορεί να είναι χρήσιμη για να ανακτήσει επίσης πολιτικές που επηρεάζουν έναν πόρο όπως ένα έργο
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
- Υποθέτω ότι η άδεια **`cloudasset.assets.queryIamPolicy`** θα μπορούσε επίσης να δώσει πρόσβαση για να βρείτε άδειες των προσώπων
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
### testIamPermissions enumeration

> [!CAUTION]
> If you **cannot access IAM information** using the previous methods and you are in a Red Team. You could **use the tool**[ **https://github.com/carlospolop/bf_my_gcp_perms**](https://github.com/carlospolop/bf_my_gcp_perms) **to brute-force your current permissions.**
>
> However, note that the service **`cloudresourcemanager.googleapis.com`** needs to be enabled.

### Privesc

In the following page you can check how to **abuse IAM permissions to escalate privileges**:

{{#ref}}
../gcp-privilege-escalation/gcp-iam-privesc.md
{{#endref}}

### Unauthenticated Enum <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{{#ref}}
../gcp-unauthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md
{{#endref}}

### Post Exploitation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{{#ref}}
../gcp-post-exploitation/gcp-iam-post-exploitation.md
{{#endref}}

### Persistence

If you have high privileges you could:

- Create new SAs (or users if in Workspace)
- Give principals controlled by yourself more permissions
- Give more privileges to vulnerable SAs (SSRF in vm, vuln Cloud Function…)
- …

## Org Policies

For an intro about what Org Policies are check:

{{#ref}}
../gcp-basic-information/
{{#endref}}

Οι πολιτικές IAM υποδεικνύουν τις άδειες που έχουν οι κύριοι πάνω στους πόρους μέσω ρόλων, οι οποίοι έχουν ανατεθεί με λεπτομερείς άδειες. Οι πολιτικές οργάνωσης **περιορίζουν το πώς μπορούν να χρησιμοποιηθούν αυτές οι υπηρεσίες ή ποιες δυνατότητες είναι απενεργοποιημένες**. Αυτό βοηθά στην βελτίωση της ελάχιστης άδειας κάθε πόρου στο περιβάλλον GCP.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Privesc

Στην επόμενη σελίδα μπορείτε να ελέγξετε πώς να **καταχραστείτε τις άδειες πολιτικών οργανισμού για να κλιμακώσετε τα προνόμια**:

{{#ref}}
../gcp-privilege-escalation/gcp-orgpolicy-privesc.md
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
