# GCP - Cloud Run Enum

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Run <a href="#reviewing-cloud-run-configurations" id="reviewing-cloud-run-configurations"></a>

Cloud Run ist eine serverlose verwaltete Compute-Plattform, die es Ihnen ermöglicht, **Container** direkt auf der skalierbaren Infrastruktur von Google auszuführen.

Sie können Ihren Container ausführen oder, wenn Sie Go, Node.js, Python, Java, .NET Core oder Ruby verwenden, können Sie die [quellbasierte Bereitstellungs](https://cloud.google.com/run/docs/deploying-source-code) option nutzen, die **den Container für Sie erstellt.**

Google hat Cloud Run entwickelt, um **gut mit anderen Diensten auf Google Cloud zusammenzuarbeiten**, sodass Sie voll funktionsfähige Anwendungen erstellen können.

### Dienste und Jobs <a href="#services-and-jobs" id="services-and-jobs"></a>

Auf Cloud Run kann Ihr Code entweder kontinuierlich als _**Dienst**_ oder als _**Job**_ ausgeführt werden. Sowohl Dienste als auch Jobs laufen in derselben Umgebung und können dieselben Integrationen mit anderen Diensten auf Google Cloud nutzen.

- **Cloud Run-Dienste.** Wird verwendet, um Code auszuführen, der auf Webanfragen oder Ereignisse reagiert.
- **Cloud Run-Jobs.** Wird verwendet, um Code auszuführen, der Arbeit (einen Job) verrichtet und beendet, wenn die Arbeit erledigt ist.

## Cloud Run Dienst

Google [Cloud Run](https://cloud.google.com/run) ist ein weiteres serverloses Angebot, bei dem Sie auch nach Umgebungsvariablen suchen können. Cloud Run erstellt standardmäßig einen kleinen Webserver, der auf Port 8080 innerhalb des Containers läuft und darauf wartet, eine HTTP GET-Anfrage zu empfangen. Wenn die Anfrage eingeht, wird ein Job ausgeführt und das Jobprotokoll wird über eine HTTP-Antwort ausgegeben.

### Relevante Details

- Standardmäßig ist der **Zugriff** auf den Webserver **öffentlich**, kann jedoch auch auf **internen Verkehr** (VPC...) **beschränkt** werden.\
Darüber hinaus kann die **Authentifizierung** zum Kontakt mit dem Webserver **alle zulassen** oder **eine Authentifizierung über IAM erfordern**.
- Standardmäßig verwendet die **Verschlüsselung** einen **von Google verwalteten Schlüssel**, aber ein **CMEK** (Customer Managed Encryption Key) von **KMS** kann ebenfalls **ausgewählt** werden.
- Standardmäßig ist das verwendete **Dienstkonto** das **Standard-Dienstkonto von Compute Engine**, das **Editor**-Zugriff auf das Projekt hat und den **Bereich `cloud-platform`** hat.
- Es ist möglich, **Klartext-Umgebungsvariablen** für die Ausführung zu definieren und sogar **Cloud-Secrets zu mounten** oder **Cloud-Secrets zu Umgebungsvariablen hinzuzufügen**.
- Es ist auch möglich, **Verbindungen mit Cloud SQL** hinzuzufügen und **ein Dateisystem zu mounten**.
- Die **URLs** der bereitgestellten Dienste sind ähnlich wie **`https://<svc-name>-<random>.a.run.app`**
- Ein Run-Dienst kann **mehr als 1 Version oder Revision** haben und **den Verkehr** zwischen mehreren Revisionen **aufteilen**.

### Enumeration
```bash
# List services
gcloud run services list
gcloud run services list --platform=managed
gcloud run services list --platform=gke

# Get info of a service
gcloud run services describe --region <region> <svc-name>

# Get info of all the services together
gcloud run services list --format=yaml
gcloud run services list --platform=managed --format=json
gcloud run services list --platform=gke --format=json

# Get policy
gcloud run services get-iam-policy --region <region> <svc-name>

# Get revisions
gcloud run revisions list --region <region>
gcloud run revisions describe --region <region> <revision>

# Get domains
gcloud run domain-mappings list
gcloud run domain-mappings describe <name>

# Attempt to trigger a job unauthenticated
curl <url>

# Attempt to trigger a job with your current gcloud authorization
curl -H "Authorization: Bearer $(gcloud auth print-identity-token)" <url>
```
## Cloud Run Jobs

Cloud Run-Jobs sind besser geeignet für **Container, die bis zur Vollendung laufen und keine Anfragen bedienen**. Jobs haben nicht die Fähigkeit, Anfragen zu bedienen oder auf einem Port zu lauschen. Das bedeutet, dass Jobs im Gegensatz zu Cloud Run-Diensten keinen Webserver bündeln sollten. Stattdessen sollten Job-Container beenden, wenn sie fertig sind.

### Enumeration
```bash
gcloud beta run jobs list
gcloud beta run jobs describe --region <region> <job-name>
gcloud beta run jobs get-iam-policy --region <region> <job-name>
```
## Privilegieneskalation

Auf der folgenden Seite können Sie überprüfen, wie Sie **Cloud Run-Berechtigungen missbrauchen, um Privilegien zu eskalieren**:

{{#ref}}
../gcp-privilege-escalation/gcp-run-privesc.md
{{#endref}}

## Unauthentifizierter Zugriff

{{#ref}}
../gcp-unauthenticated-enum-and-access/gcp-cloud-run-unauthenticated-enum.md
{{#endref}}

## Nach der Ausnutzung

{{#ref}}
../gcp-post-exploitation/gcp-cloud-run-post-exploitation.md
{{#endref}}

## Persistenz

{{#ref}}
../gcp-persistence/gcp-cloud-run-persistence.md
{{#endref}}

## Referenzen

- [https://cloud.google.com/run/docs/overview/what-is-cloud-run](https://cloud.google.com/run/docs/overview/what-is-cloud-run)

{{#include ../../../banners/hacktricks-training.md}}
