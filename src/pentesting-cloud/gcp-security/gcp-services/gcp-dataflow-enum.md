# GCP - Dataflow Enum

{{#include ../../../banners/hacktricks-training.md}}

## 基本信息

**Google Cloud Dataflow** 是一个用于 **批处理和流式数据处理** 的完全托管服务。它使组织能够构建在大规模上转换和分析数据的管道，并与 Cloud Storage、BigQuery、Pub/Sub 和 Bigtable 集成。Dataflow pipelines 在你的项目中的 worker VMs 上运行；templates 和 User-Defined Functions (UDFs) 通常存储在 GCS 存储桶中。 [Learn more](https://cloud.google.com/dataflow).

## 组件

一个 Dataflow pipeline 通常包括：

**Template：** YAML 或 JSON 定义（以及用于 flex templates 的 Python/Java 代码），存储在 GCS 中，用于定义 pipeline 的结构和步骤。

**Launcher (Flex Templates)：** 启动 Flex Template 时可能会使用短期存在的 Compute Engine 实例，以在作业运行前验证模板并准备容器。

**Workers：** 执行实际数据处理任务的 Compute Engine VMs，会从模板中拉取 UDFs 和指令。

**Staging/Temp buckets：** 用于存储临时 pipeline 数据、作业制品、UDF 文件、flex template 元数据（`.json`）的 GCS 存储桶。

## 批处理与流式作业

Dataflow 支持两种执行模式：

**Batch jobs：** 处理固定、有界的数据集（例如日志文件、表导出）。作业运行一次直到完成然后终止。Workers 会在作业期间创建并在完成后关闭。Batch jobs 通常用于 ETL、历史分析或计划的数据迁移。

**Streaming jobs：** 处理无界、持续到达的数据（例如 Pub/Sub 消息、实时传感器数据）。作业会持续运行直到被显式停止。Workers 可能会根据 autoscaling 动态扩缩；新的 workers 在启动时会从 GCS 拉取 pipeline 组件（templates、UDFs）。

## 枚举

可以枚举 Dataflow 作业和相关资源以收集服务账号、模板路径、暂存桶和 UDF 存放位置。

### 作业枚举

要枚举 Dataflow 作业并检索其详细信息：
```bash
# List Dataflow jobs in the project
gcloud dataflow jobs list
# List Dataflow jobs (by region)
gcloud dataflow jobs list --region=<region>

# Describe job (includes service account, template GCS path, staging location, parameters)
gcloud dataflow jobs describe <job-id> --region=<region>
```
Job 描述会显示模板的 GCS 路径、staging location 和 worker service account——有助于识别存放 pipeline components 的 bucket。

### 模板和 Bucket 枚举

Job 描述中引用的 bucket 可能包含 flex templates、UDFs 或 YAML pipeline 定义：
```bash
# List objects in a bucket (look for .json flex templates, .py UDFs, .yaml pipeline defs)
gcloud storage ls gs://<bucket>/

# List objects recursively
gcloud storage ls gs://<bucket>/**
```
## Privilege Escalation

{{#ref}}
../gcp-privilege-escalation/gcp-dataflow-privesc.md
{{#endref}}

## Post Exploitation

{{#ref}}
../gcp-post-exploitation/gcp-dataflow-post-exploitation.md
{{#endref}}

## Persistence

{{#ref}}
../gcp-persistence/gcp-dataflow-persistence.md
{{#endref}}

## 参考资料

- [Dataflow overview](https://cloud.google.com/dataflow)
- [Pipeline workflow execution in Dataflow](https://cloud.google.com/dataflow/docs/guides/pipeline-workflows)
- [Troubleshoot templates](https://cloud.google.com/dataflow/docs/guides/troubleshoot-templates)

{{#include ../../../banners/hacktricks-training.md}}
