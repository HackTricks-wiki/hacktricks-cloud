# GCP - Alan Genel Yetkilendirmeyi Anlamak

{{#include ../../../banners/hacktricks-training.md}}

Bu gönderi, daha fazla ayrıntı için erişilebilen [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) bağlantısının tanıtımıdır.

## **Alan Genel Yetkilendirmeyi Anlamak**

Google Workspace'in Alan Genel yetkilendirmesi, bir kimlik nesnesinin, ya Google Workspace Marketplace'ten bir **harici uygulama** ya da bir iç **GCP Hizmet Hesabı** olarak, **kullanıcılar adına Workspace'teki verilere erişmesine** olanak tanır. Bu özellik, Google API'leri veya kullanıcı taklidi gerektiren hizmetlerle etkileşimde bulunan uygulamalar için kritik öneme sahiptir ve görevleri otomatikleştirerek verimliliği artırır ve insan hatasını en aza indirir. OAuth 2.0 kullanarak, uygulama geliştiricileri ve yöneticileri, bu hizmet hesaplarına bireysel kullanıcı onayı olmadan kullanıcı verilerine erişim verebilir.\
\
Google Workspace, iki ana türde küresel devredilmiş nesne kimlikleri oluşturulmasına izin verir:

- **GWS Uygulamaları:** Workspace Marketplace'ten uygulamalar, devredilmiş bir kimlik olarak ayarlanabilir. Her Workspace uygulaması, potansiyel kötüye kullanımı en aza indirmek için pazara sunulmadan önce Google tarafından gözden geçirilir. Bu, kötüye kullanım riskini tamamen ortadan kaldırmasa da, bu tür olayların gerçekleşmesini önemli ölçüde zorlaştırır.
- **GCP Hizmet Hesabı:** Daha fazla bilgi için [**GCP Hizmet Hesapları burada**](../gcp-basic-information/#service-accounts) öğrenin.

### **Alan Genel Yetkilendirme: Arkada Neler Oluyor**

Bir GCP Hizmet Hesabının, Google Workspace'teki diğer kimlikler adına Google API'lerine nasıl erişebileceği:

<figure><img src="../../../images/image (58).png" alt=""><figcaption></figcaption></figure>

1. **Kimlik bir JWT oluşturur:** Kimlik, bir JWT'yi imzalamak için hizmet hesabının özel anahtarını (JSON anahtar çift dosyasının bir parçası) kullanır. Bu JWT, hizmet hesabı, taklit edilecek hedef kullanıcı ve talep edilen REST API'ye erişim için OAuth kapsamlarını içeren iddialar içerir.
2. **Kimlik, erişim token'ı talep etmek için JWT'yi kullanır:** Uygulama/kullanıcı, Google'ın OAuth 2.0 hizmetinden bir erişim token'ı talep etmek için JWT'yi kullanır. Talep ayrıca taklit edilecek hedef kullanıcıyı (kullanıcının Workspace e-posta adresi) ve erişim talep edilen kapsamları içerir.
3. **Google'ın OAuth 2.0 hizmeti bir erişim token'ı döner:** Erişim token'ı, belirtilen kapsamlar için kullanıcı adına hareket etme yetkisini temsil eder. Bu token genellikle kısa ömürlüdür ve periyodik olarak yenilenmesi gerekir (uygulamanın ihtiyacına göre). JWT token'ında belirtilen OAuth kapsamlarının geçerliliği ve sonuçta elde edilen erişim token'ı üzerinde etkisi olduğunu anlamak önemlidir. Örneğin, birden fazla kapsamı olan erişim token'ları, birçok REST API uygulaması için geçerliliğe sahip olacaktır.
4. **Kimlik, Google API'lerini çağırmak için erişim token'ını kullanır**: Şimdi ilgili bir erişim token'ı ile hizmet, gerekli REST API'ye erişebilir. Uygulama, bu erişim token'ını Google API'lerine yönelik HTTP isteklerinin "Authorization" başlığında kullanır. Bu API'ler, token'ı taklit edilen kimliği doğrulamak ve gerekli yetkilendirmeye sahip olduğunu onaylamak için kullanır.
5. **Google API'leri talep edilen verileri döner**: Erişim token'ı geçerliyse ve hizmet hesabı uygun yetkilendirmeye sahipse, Google API'leri talep edilen verileri döner. Örneğin, aşağıdaki resimde, hedef bir Workspace kullanıcısıyla ilişkili tüm Gmail mesaj kimliklerini listelemek için _users.messages.list_ yöntemini kullandık.

{{#include ../../../banners/hacktricks-training.md}}
