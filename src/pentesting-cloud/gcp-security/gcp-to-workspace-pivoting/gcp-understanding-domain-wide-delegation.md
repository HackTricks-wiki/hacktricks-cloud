# GCP - 理解域范围委派

{{#include ../../../banners/hacktricks-training.md}}

本文是对[https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)的介绍，更多细节请访问该链接。

## **理解域范围委派**

Google Workspace的域范围委派允许身份对象，无论是来自Google Workspace Marketplace的**外部应用**还是内部的**GCP服务账户**，**代表用户访问Workspace中的数据**。此功能对于与Google API或需要用户 impersonation 的服务交互的应用至关重要，通过自动化任务提高效率并减少人为错误。使用OAuth 2.0，应用开发者和管理员可以在不需要单个用户同意的情况下，授予这些服务账户访问用户数据的权限。\
\
Google Workspace允许创建两种主要类型的全局委派对象身份：

- **GWS应用程序：**来自Workspace Marketplace的应用程序可以设置为委派身份。在进入市场之前，每个Workspace应用程序都经过Google的审核，以尽量减少潜在的滥用。虽然这并不能完全消除滥用的风险，但显著增加了此类事件发生的难度。
- **GCP服务账户：**了解更多关于[**GCP服务账户的信息**](../gcp-basic-information/#service-accounts)。

### **域范围委派：内部机制**

这就是GCP服务账户如何代表Google Workspace中的其他身份访问Google API的方式：

<figure><img src="../../../images/image (58).png" alt=""><figcaption></figcaption></figure>

1. **身份创建JWT：**身份使用服务账户的私钥（JSON密钥对文件的一部分）签署JWT。此JWT包含有关服务账户、要 impersonate 的目标用户以及请求的REST API的OAuth访问范围的声明。
2. **身份使用JWT请求访问令牌：**应用程序/用户使用JWT向Google的OAuth 2.0服务请求访问令牌。请求还包括要 impersonate 的目标用户（用户的Workspace电子邮件）和请求访问的范围。
3. **Google的OAuth 2.0服务返回访问令牌：**访问令牌代表服务账户在指定范围内代表用户的权限。此令牌通常是短期有效的，必须定期刷新（根据应用程序的需要）。理解JWT令牌中指定的OAuth范围对结果访问令牌的有效性和影响至关重要。例如，拥有多个范围的访问令牌将在多个REST API应用程序中保持有效。
4. **身份使用访问令牌调用Google API：**现在有了相关的访问令牌，服务可以访问所需的REST API。应用程序在其发往Google API的HTTP请求的“Authorization”头中使用此访问令牌。这些API利用令牌验证被 impersonated 的身份并确认其拥有必要的授权。
5. **Google API返回请求的数据：**如果访问令牌有效且服务账户具有适当的授权，Google API将返回请求的数据。例如，在下图中，我们利用了_users.messages.list_方法列出与目标Workspace用户关联的所有Gmail消息ID。

{{#include ../../../banners/hacktricks-training.md}}
