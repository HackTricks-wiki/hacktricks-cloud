# GCP <--> Workspace Pivoting

{{#include ../../../banners/hacktricks-training.md}}

## **GCP'den GWS'ye**

### **Alan Genel Yetkilendirme Temelleri**

Google Workspace'in Alan Genel Yetkilendirmesi, bir kimlik nesnesinin, ya bir **harici uygulama** Google Workspace Marketplace'ten ya da bir iç **GCP Hizmet Hesabı** olarak, **kullanıcılar adına Workspace'teki verilere erişmesine** olanak tanır.

> [!NOTE]
> Bu, temelde **GCP projeleri içindeki hizmet hesaplarının**, aynı organizasyondaki (veya hatta farklı bir organizasyondaki) **Workspace kullanıcılarını taklit edebilme** yeteneğine sahip olabileceği anlamına gelir.

Bu işlemin tam olarak nasıl çalıştığı hakkında daha fazla bilgi için kontrol edin:

{{#ref}}
gcp-understanding-domain-wide-delegation.md
{{#endref}}

### Mevcut yetkilendirmeyi ele geçirme

Eğer bir saldırgan **GCP üzerinde bazı erişimleri ele geçirmişse** ve şirketin **geçerli bir Workspace kullanıcı e-posta adresini** (tercihen **süper yönetici**) biliyorsa, **erişim sağladığı tüm projeleri listeleyebilir**, projelerin **tüm SA'lerini listeleyebilir**, hangi **hizmet hesaplarına erişimi olduğunu kontrol edebilir** ve **taklit edebileceği her SA ile bu adımları tekrarlayabilir**.\
Elde ettiği **tüm hizmet hesaplarının listesi** ve **Workspace** **e-posta adresleri** ile saldırgan, her hizmet hesabı ile **kullanıcıyı taklit etmeye** çalışabilir.

> [!CAUTION]
> Alan genel yetkilendirmeyi yapılandırırken herhangi bir Workspace kullanıcısına ihtiyaç olmadığını unutmayın, bu nedenle sadece **bir geçerli kullanıcı bilmek yeterlidir ve taklit için gereklidir**.\
> Ancak, **taklit edilen kullanıcının ayrıcalıkları kullanılacaktır**, bu nedenle eğer Süper Yönetici ise her şeye erişebileceksiniz. Eğer herhangi bir erişimi yoksa bu işe yaramaz.

#### [GCP Yetkilendirme Token'ı Oluştur](https://github.com/carlospolop/gcp_gen_delegation_token)

Bu basit betik, **yetkilendirilmiş kullanıcı olarak bir OAuth token'ı oluşturacaktır** ve bunu `gcloud` ile ya da onsuz diğer Google API'lerine erişmek için kullanabilirsiniz:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Bu, aşağıdaki adımları izleyerek saldırı gerçekleştirebilen bir araçtır:

1. **GCP Projelerini Sayma** Resource Manager API kullanarak.
2. Her proje kaynağı üzerinde yineleme yapın ve **ilk IAM kullanıcısının erişim sağladığı GCP Hizmet hesabı kaynaklarını sayın** _GetIAMPolicy_ kullanarak.
3. **Her hizmet hesabı rolü üzerinde yineleme yapın** ve hedef hizmet hesabı kaynağında _**serviceAccountKeys.create**_ iznine sahip yerleşik, temel ve özel rolleri bulun. Editor rolünün bu izne doğal olarak sahip olduğu belirtilmelidir.
4. IAM politikasında ilgili izne sahip bulunan her hizmet hesabı kaynağı için **yeni bir `KEY_ALG_RSA_2048`** özel anahtar oluşturun.
5. **Her yeni hizmet hesabı üzerinde yineleme yapın ve bunun için bir `JWT`** **nesnesi** oluşturun; bu nesne SA özel anahtar kimlik bilgileri ve bir OAuth kapsamından oluşur. Yeni bir _JWT_ nesnesi oluşturma süreci, **oauth_scopes.txt** listesindeki tüm mevcut OAuth kapsamı kombinasyonları üzerinde **yineleme yapacaktır**; böylece tüm delege etme olasılıklarını bulmak için. **oauth_scopes.txt** listesi, Workspace kimliklerini kötüye kullanmak için ilgili bulduğumuz tüm OAuth kapsamlarıyla güncellenmiştir.
6. `_make_authorization_grant_assertion` yöntemi, DWD altında JWT'ler oluşturmak için bir **hedef çalışma alanı kullanıcısı** olarak adlandırılan _subject_ beyan etmenin gerekliliğini ortaya koyar. Bu, belirli bir kullanıcı gerektiriyormuş gibi görünebilir, ancak **DWD, bir alan içindeki her kimliği etkiler** olduğunu anlamak önemlidir. Sonuç olarak, **herhangi bir alan kullanıcısı** için bir JWT oluşturmak, o alandaki tüm kimlikleri etkiler; bu, kombinasyon sayma kontrolümüzle tutarlıdır. Kısacası, ilerlemek için bir geçerli Workspace kullanıcısı yeterlidir.\
Bu kullanıcı, DeleFriend’in _config.yaml_ dosyasında tanımlanabilir. Hedef çalışma alanı kullanıcısı henüz bilinmiyorsa, araç, GCP projelerinde rolleri olan alan kullanıcılarını tarayarak geçerli çalışma alanı kullanıcılarının otomatik olarak tanımlanmasını kolaylaştırır. JWT'lerin alan spesifik olduğunu ve her kullanıcı için oluşturulmadığını (tekrar) belirtmek önemlidir; bu nedenle, otomatik süreç her alan için tek bir benzersiz kimliği hedef alır.
7. **Her JWT için yeni bir taşıyıcı erişim belirteci sayın ve belirteci tokeninfo API'si ile doğrulayın.**

#### [Gitlab'ın Python scripti](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp_misc/-/blob/master/gcp_delegation.py)

Gitlab, SA kimlik bilgileri ve taklit edilecek kullanıcı ile birlikte bir json belirterek kullanıcı dizinini listeleyip yeni bir yönetici hesabı oluşturabilen [bu Python scriptini](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_misc/blob/master/gcp_delegation.py) oluşturmuştur. İşte nasıl kullanacağınız:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Yeni bir delegasyon oluşturma (Süreklilik)

**Domain Wide Delegations'ı kontrol etmek mümkündür** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

**GCP projesinde hizmet hesapları oluşturma yeteneğine** ve **GWS için süper admin ayrıcalığına sahip bir saldırgan, SAs'ın bazı GWS kullanıcılarını taklit etmesine izin veren yeni bir delegasyon oluşturabilir:**

1. **Yeni Bir Hizmet Hesabı ve İlgili Anahtar Çifti Oluşturma:** GCP'de, yeni hizmet hesabı kaynakları ya konsol aracılığıyla etkileşimli olarak ya da doğrudan API çağrıları ve CLI araçları kullanarak programlı olarak üretilebilir. Bu, **`iam.serviceAccountAdmin`** rolünü veya **`iam.serviceAccounts.create`** **izinine** sahip herhangi bir özel rolü gerektirir. Hizmet hesabı oluşturulduktan sonra, **ilişkili bir anahtar çifti** oluşturmak için devam edeceğiz (**`iam.serviceAccountKeys.create`** izni).
2. **Yeni delegasyonun oluşturulması:** **Sadece Süper Admin rolünün Google Workspace'te küresel Domain-Wide delegasyonu kurma yeteneğine sahip olduğunu** anlamak önemlidir ve Domain-Wide delegasyonu **programlı olarak kurulamaz,** yalnızca Google Workspace **konsolu** aracılığıyla **manuel olarak** oluşturulabilir ve ayarlanabilir.
- Kuralın oluşturulması, **API kontrolleri → Google Workspace Admin konsolunda Domain-Wide delegasyonu yönet** sayfasında bulunabilir.
3. **OAuth kapsamı ayrıcalıklarının eklenmesi:** Yeni bir delegasyon yapılandırırken, Google yalnızca 2 parametre gerektirir: İstemci Kimliği, bu **GCP Hizmet Hesabı** kaynağının **OAuth Kimliği** ve delegasyonun hangi API çağrılarını gerektirdiğini tanımlayan **OAuth kapsamları**.
- **OAuth kapsamlarının tam listesi** [**burada**](https://developers.google.com/identity/protocols/oauth2/scopes) bulunabilir, ancak burada bir öneri: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Hedef kimlik adına hareket etme:** Bu noktada, GWS'de işlevsel bir delegasyon nesnesine sahibiz. Artık, **GCP Hizmet Hesabı özel anahtarını kullanarak API çağrıları gerçekleştirebiliriz** (OAuth kapsamı parametresinde tanımlanan kapsamda) ve **Google Workspace'te mevcut olan herhangi bir kimlik adına hareket edebiliriz**. Öğrendiğimiz gibi, hizmet hesabı ihtiyaçlarına göre ve sahip olduğu izinlere göre REST API uygulamaları için erişim belirteçleri üretecektir.
- Bu delegasyonu kullanmak için bazı **araçlar** için **önceki bölüme** bakın.

#### Çapraz Kurumsal delegasyon

OAuth SA Kimliği küreseldir ve **çapraz kurumsal delegasyon** için kullanılabilir. Çapraz küresel delegasyonu önlemek için herhangi bir kısıtlama uygulanmamıştır. Basitçe ifade etmek gerekirse, **farklı GCP organizasyonlarından hizmet hesapları, diğer Workspace organizasyonlarında domain-wide delegasyonu yapılandırmak için kullanılabilir**. Bu, **sadece Workspace için Süper Admin erişimine ihtiyaç duyulması** anlamına gelir ve aynı GCP hesabına erişim gerektirmez, çünkü saldırgan kendi kontrolündeki GCP hesabında Hizmet Hesapları ve özel anahtarlar oluşturabilir.

### Workspace'i listelemek için bir Proje Oluşturma

**Varsayılan olarak** Workspace **kullanıcıları** **yeni projeler oluşturma** iznine sahiptir ve yeni bir proje oluşturulduğunda **oluşturucu, üzerinde Sahip rolü** alır.

Bu nedenle, bir kullanıcı **bir proje oluşturabilir**, yeni projesinde Workspace'i listelemek için **API'leri etkinleştirebilir** ve bunu **listelemeye** çalışabilir.

> [!DİKKAT]
> Bir kullanıcının Workspace'i listeleyebilmesi için yeterli Workspace izinlerine de sahip olması gerekir (her kullanıcı dizini listeleyemez).
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
Daha fazla numaralandırma için kontrol edin:

{{#ref}}
../gcp-services/gcp-iam-and-org-policies-enum.md
{{#endref}}

### Gcloud kimlik bilgilerini kötüye kullanma

Giriş yapmak için `gcloud` akışı hakkında daha fazla bilgi bulabilirsiniz:

{{#ref}}
../gcp-persistence/gcp-non-svc-persistance.md
{{#endref}}

Orada açıklandığı gibi, gcloud **`https://www.googleapis.com/auth/drive`** kapsamını talep edebilir, bu da bir kullanıcının sürücüsüne erişmesine izin verir.\
Bir saldırgan olarak, eğer bir kullanıcının bilgisayarını **fiziksel olarak** ele geçirdiyseniz ve **kullanıcı hala** hesabıyla giriş yapıyorsa, sürücüye erişim sağlayan bir token oluşturarak giriş yapabilirsiniz:
```bash
gcloud auth login --enable-gdrive-access
```
Eğer bir saldırgan bir kullanıcının bilgisayarını ele geçirirse, `google-cloud-sdk/lib/googlecloudsdk/core/config.py` dosyasını da değiştirebilir ve **`CLOUDSDK_SCOPES`** içine **`'https://www.googleapis.com/auth/drive'`** kapsamını ekleyebilir:

<figure><img src="../../../images/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

> [!WARNING]
> Bu nedenle, kullanıcı bir sonraki giriş yaptığında, saldırganın drive'a erişmek için kötüye kullanabileceği **drive'a erişim izni olan bir token oluşturacaktır**. Açıkça, tarayıcı oluşturulan token'ın drive'a erişim izni olduğunu gösterecektir, ancak kullanıcı **`gcloud auth login`** komutunu kendisi çağıracağı için muhtemelen **hiçbir şeyden şüphelenmeyecektir.**
>
> Drive dosyalarını listelemek için: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**

## GWS'den GCP'ye

### Ayrıcalıklı GCP kullanıcılarına erişim

Eğer bir saldırgan GWS üzerinde tam erişime sahipse, GCP üzerinde ayrıcalıklı erişime sahip gruplara veya kullanıcılara erişebilecektir, bu nedenle GWS'den GCP'ye geçiş genellikle daha "basit"dir çünkü **GWS'deki kullanıcılar GCP üzerinde yüksek ayrıcalıklara sahiptir**.

### Google Grupları Ayrıcalık Yükseltme

Varsayılan olarak kullanıcılar **Organizasyonun Workspace gruplarına serbestçe katılabilir** ve bu gruplar **GCP izinlerine** sahip olabilir (gruplarınızı [https://groups.google.com/](https://groups.google.com/) adresinde kontrol edin).

**google groups privesc**'i kötüye kullanarak, GCP'ye bazı türde ayrıcalıklı erişim sağlayan bir gruba yükseltme yapabilirsiniz.

### Referanslar

- [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{{#include ../../../banners/hacktricks-training.md}}
