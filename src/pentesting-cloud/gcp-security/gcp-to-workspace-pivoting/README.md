# GCP <--> Workspace Pivoting

{{#include ../../../banners/hacktricks-training.md}}

## **Kutoka GCP hadi GWS**

### **Msingi wa Delegation ya Domain Wide**

Delegation ya Domain-Wide ya Google Workspace inaruhusu kituo cha utambulisho, iwe ni **programu ya nje** kutoka Google Workspace Marketplace au **GCP Service Account** ya ndani, **kupata data katika Workspace kwa niaba ya watumiaji**.

> [!NOTE]
> Hii inamaanisha kwamba **akaunti za huduma** ndani ya miradi ya GCP ya shirika zinaweza kuwa na uwezo wa **kujifanya watumiaji wa Workspace** wa shirika hilo hilo (au hata kutoka shirika tofauti).

Kwa maelezo zaidi kuhusu jinsi hii inavyofanya kazi angalia:

{{#ref}}
gcp-understanding-domain-wide-delegation.md
{{#endref}}

### Kuathiri delegation iliyopo

Ikiwa mshambuliaji **ameathiri baadhi ya ufikiaji juu ya GCP** na **anajua barua pepe halali ya mtumiaji wa Workspace** (kama inavyopendelewa **super admin**) wa kampuni, anaweza **kuorodhesha miradi yote** ambayo ana ufikiaji nayo, **kuorodhesha SAs zote** za miradi, kuangalia ni **akaunti za huduma zipi ana ufikiaji nazo**, na **kurudia** hatua hizi zote na kila SA anayeweza kujifanya.\
Kwa **orodha ya akaunti zote za huduma** alizo na **ufikiaji** nazo na orodha ya **barua pepe za Workspace**, mshambuliaji anaweza kujaribu **kujifanya mtumiaji kwa kila akaunti ya huduma**.

> [!CAUTION]
> Kumbuka kwamba wakati wa kusanidi delegation ya domain wide mtumiaji yeyote wa Workspace haitajiki, kwa hivyo jua tu **mtumiaji mmoja halali ni wa kutosha na unahitajika kwa ajili ya kujifanya**.\
> Hata hivyo, **mamlaka ya mtumiaji anayejifananisha yatatumika**, hivyo ikiwa ni Super Admin utaweza kupata kila kitu. Ikiwa haina ufikiaji wowote hii itakuwa haina maana.

#### [GCP Generate Delegation Token](https://github.com/carlospolop/gcp_gen_delegation_token)

Hii ni script rahisi itakay **zalisha token ya OAuth kama mtumiaji aliyepewa mamlaka** ambayo unaweza kutumia kupata APIs nyingine za Google kwa kutumia au bila `gcloud`:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Hii ni zana inayoweza kufanya shambulio ikifuatia hatua hizi:

1. **Enumerate GCP Projects** kwa kutumia Resource Manager API.
2. Pitia kila rasilimali ya mradi, na **enumerate GCP Service account resources** ambazo mtumiaji wa IAM wa awali ana ufikiaji kwa kutumia _GetIAMPolicy_.
3. Pitia **kila jukumu la akaunti ya huduma**, na pata majukumu ya ndani, ya msingi, na ya kawaida yenye ruhusa ya _**serviceAccountKeys.create**_ kwenye rasilimali ya akaunti ya huduma inayolengwa. Inapaswa kuzingatiwa kwamba jukumu la Mhariri kwa asili lina ruhusa hii.
4. Unda **funguo mpya ya `KEY_ALG_RSA_2048`** ya faragha kwa kila rasilimali ya akaunti ya huduma ambayo imepatikana na ruhusa inayofaa katika sera ya IAM.
5. Pitia **kila akaunti ya huduma mpya na unda `JWT`** **object** kwa ajili yake ambayo inajumuisha akidi za funguo za faragha za SA na eneo la OAuth. Mchakato wa kuunda _JWT_ mpya ut **pitia mchanganyiko wote wa maeneo ya OAuth** kutoka orodha ya **oauth_scopes.txt**, ili kupata uwezekano wote wa uwakilishi. Orodha ya **oauth_scopes.txt** inasasishwa na maeneo yote ya OAuth tuliyogundua kuwa muhimu kwa kutumia vitambulisho vya Workspace.
6. Mbinu ya `_make_authorization_grant_assertion` inaonyesha umuhimu wa kutangaza mtumiaji wa **target workspace**, anayeitwa _subject_, kwa ajili ya kuzalisha JWTs chini ya DWD. Ingawa hii inaweza kuonekana inahitaji mtumiaji maalum, ni muhimu kutambua kwamba **DWD inaathiri kila kitambulisho ndani ya eneo**. Kwa hivyo, kuunda JWT kwa **mtumiaji yeyote wa eneo** kunaathiri vitambulisho vyote katika eneo hilo, kulingana na ukaguzi wetu wa mchanganyiko. Kwa kifupi, mtumiaji mmoja halali wa Workspace ni wa kutosha kuendelea.\
Mtumiaji huyu anaweza kufafanuliwa katika faili ya _config.yaml_ ya DeleFriend. Ikiwa mtumiaji wa target workspace hajulikani tayari, zana hii inarahisisha utambuzi wa moja kwa moja wa watumiaji halali wa workspace kwa kuskan watumiaji wa eneo wenye majukumu kwenye miradi ya GCP. Ni muhimu kutambua (tena) kwamba JWTs ni maalum kwa eneo na hazizalishwi kwa kila mtumiaji; hivyo, mchakato wa moja kwa moja unalenga kitambulisho kimoja cha kipekee kwa kila eneo.
7. **Enumerate and create a new bearer access token** kwa kila JWT na kuthibitisha token dhidi ya tokeninfo API.

#### [Gitlab's Python script](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp_misc/-/blob/master/gcp_delegation.py)

Gitlab imeunda [hii Python script](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_misc/blob/master/gcp_delegation.py) ambayo inaweza kufanya mambo mawili - orodhesha directory ya mtumiaji na kuunda akaunti mpya ya kiutawala huku ikionyesha json yenye akidi za SA na mtumiaji wa kuiga. Hapa kuna jinsi unavyoweza kuitumia:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Unda uwakilishi mpya (Uendelevu)

Inawezekana **kuangalia Uwakilishi wa Kikoa Kote katika** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Mshambuliaji mwenye uwezo wa **kuunda akaunti za huduma katika mradi wa GCP** na **haki za super admin kwa GWS anaweza kuunda uwakilishi mpya unaowaruhusu SAs kuiga baadhi ya watumiaji wa GWS:**

1. **Kuzalisha Akaunti ya Huduma Mpya na Jifunguo Husika:** Kwenye GCP, rasilimali mpya za akaunti za huduma zinaweza kuzalishwa ama kwa njia ya mwingiliano kupitia console au kwa njia ya programu kwa kutumia wito wa moja kwa moja wa API na zana za CLI. Hii inahitaji **jukumu `iam.serviceAccountAdmin`** au jukumu lolote la kawaida lililo na **`iam.serviceAccounts.create`** **idhini**. Mara akaunti ya huduma itakapoundwa, tutaendelea kuzalisha **jifunguo husika** (**`iam.serviceAccountKeys.create`** ruhusa).
2. **Uundaji wa uwakilishi mpya**: Ni muhimu kuelewa kwamba **ni jukumu la Super Admin pekee linaloweza kuanzisha uwakilishi wa Kikoa Kote katika Google Workspace** na uwakilishi wa Kikoa Kote **hauwezi kuanzishwa kwa njia ya programu,** Inaweza kuundwa na kurekebishwa **kwa mikono** kupitia **console** ya Google Workspace.
- Uundaji wa sheria unaweza kupatikana chini ya ukurasa **API controls â†’ Manage Domain-Wide delegation in Google Workspace Admin console**.
3. **Kuambatisha haki za OAuth scopes**: Wakati wa kuunda uwakilishi mpya, Google inahitaji tu vigezo 2, Kitambulisho cha Mteja, ambacho ni **Kitambulisho cha OAuth cha Rasilimali ya Akaunti ya Huduma ya GCP**, na **OAuth scopes** zinazoeleza ni wito gani wa API uwakilishi unahitaji.
- **orodha kamili ya OAuth scopes** inaweza kupatikana [**hapa**](https://developers.google.com/identity/protocols/oauth2/scopes), lakini hapa kuna pendekezo: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Kufanya kwa niaba ya kitambulisho cha lengo:** Katika hatua hii, tuna kitu kilichowakilishwa kinachofanya kazi katika GWS. Sasa, **tukitumia funguo binafsi za Akaunti ya Huduma ya GCP, tunaweza kufanya wito wa API** (katika wigo ulioelezwa katika vigezo vya OAuth scope) ili kuhamasisha na **kufanya kwa niaba ya kitambulisho chochote kilichopo katika Google Workspace**. Kama tulivyojifunza, akaunti ya huduma itazalisha tokeni za ufikiaji kulingana na mahitaji yake na kulingana na ruhusa alizonazo kwa programu za REST API.
- Angalia **sehemu ya awali** kwa baadhi ya **zana** za kutumia uwakilishi huu.

#### Uwakilishi wa Kijamii

Kitambulisho cha OAuth SA ni cha kimataifa na kinaweza kutumika kwa **uwakilishi wa kijamii**. Hakuna vizuizi vilivyowekwa kuzuia uwakilishi wa kimataifa. Kwa maneno rahisi, **akaunti za huduma kutoka mashirika tofauti ya GCP zinaweza kutumika kuunda uwakilishi wa kikoa kote kwenye mashirika mengine ya Workspace**. Hii itasababisha **kuhitaji tu ufikiaji wa Super Admin kwa Workspace**, na sio ufikiaji wa akaunti hiyo hiyo ya GCP, kwani mpinzani anaweza kuunda Akaunti za Huduma na funguo binafsi kwenye akaunti yake ya GCP anayoitawala.

### Kuunda Mradi wa kuhesabu Workspace

Kwa **kawaida** watumiaji wa Workspace **wana haki ya** **kuunda miradi mipya**, na wakati mradi mpya unaundwa, **mwandishi anapata jukumu la Mmiliki** juu yake.

Hivyo, mtumiaji anaweza **kuunda mradi**, **kuwezesha** **APIs** za kuhesabu Workspace katika mradi wake mpya na kujaribu **kuhesabu** hiyo.

> [!CAUTION]
> Ili mtumiaji aweze kuhesabu Workspace, pia anahitaji ruhusa za kutosha za Workspace (sio kila mtumiaji ataweza kuhesabu directory).
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
Angalia **kuorodhesha zaidi katika**:

{{#ref}}
../gcp-services/gcp-iam-and-org-policies-enum.md
{{#endref}}

### Kutumia vibaya akreditivu za Gcloud

Unaweza kupata taarifa zaidi kuhusu mtiririko wa `gcloud` kuingia katika:

{{#ref}}
../gcp-persistence/gcp-non-svc-persistance.md
{{#endref}}

Kama ilivyoelezwa hapo, gcloud inaweza kuomba upeo **`https://www.googleapis.com/auth/drive`** ambao utamruhusu mtumiaji kufikia diski ya mtumiaji.\
Kama mshambuliaji, ikiwa umepata **kimwili** kompyuta ya mtumiaji na **mtumiaji bado ameingia** na akaunti yake unaweza kuingia kwa kuzalisha tokeni yenye ufikiaji wa diski kwa kutumia:
```bash
gcloud auth login --enable-gdrive-access
```
Ikiwa mshambuliaji anapora kompyuta ya mtumiaji anaweza pia kubadilisha faili `google-cloud-sdk/lib/googlecloudsdk/core/config.py` na kuongeza katika **`CLOUDSDK_SCOPES`** upeo **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../images/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

> [!WARNING]
> Hivyo, wakati mtumiaji atakapojisajili tena ataunda **token yenye ufikiaji wa drive** ambayo mshambuliaji anaweza kuitumia kuingia kwenye drive. Kwa wazi, kivinjari kitaonyesha kwamba token iliyoundwa itakuwa na ufikiaji wa drive, lakini kwa kuwa mtumiaji atajita mwenyewe **`gcloud auth login`**, labda **hatashuku chochote.**
>
> Ili kuorodhesha faili za drive: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**

## Kutoka GWS hadi GCP

### Ufikiaji wa watumiaji wenye mamlaka ya GCP

Ikiwa mshambuliaji ana ufikiaji kamili juu ya GWS ataweza kufikia vikundi vyenye ufikiaji wa mamlaka juu ya GCP au hata watumiaji, hivyo kuhamia kutoka GWS hadi GCP kwa kawaida ni "rahisi" zaidi kwa sababu **watumiaji katika GWS wana mamlaka makubwa juu ya GCP**.

### Kuinua Mamlaka ya Vikundi vya Google

Kwa kawaida watumiaji wanaweza **kujiunga kwa uhuru na vikundi vya Workspace vya Shirika** na vikundi hivyo **vinaweza kuwa na ruhusa za GCP** zilizotolewa (angalia vikundi vyako katika [https://groups.google.com/](https://groups.google.com/)).

Kwa kutumia **kuinua mamlaka ya vikundi vya google** unaweza kuwa na uwezo wa kuinua hadi kundi lenye aina fulani ya ufikiaji wa mamlaka kwa GCP.

### Marejeleo

- [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{{#include ../../../banners/hacktricks-training.md}}
