# GCP <--> Workspace Pivoting

{{#include ../../../banners/hacktricks-training.md}}

## **Από GCP σε GWS**

### **Βασικά της Εξουσιοδότησης σε Επίπεδο Τομέα**

Η Εξουσιοδότηση σε Επίπεδο Τομέα του Google Workspace επιτρέπει σε ένα αντικείμενο ταυτότητας, είτε μια **εξωτερική εφαρμογή** από το Google Workspace Marketplace είτε έναν εσωτερικό **Λογαριασμό Υπηρεσίας GCP**, να **πρόσβαση σε δεδομένα σε όλο το Workspace εκ μέρους των χρηστών**.

> [!NOTE]
> Αυτό σημαίνει βασικά ότι οι **λογαριασμοί υπηρεσίας** μέσα σε έργα GCP μιας οργάνωσης μπορεί να είναι σε θέση να **παριστάνουν τους χρήστες του Workspace** της ίδιας οργάνωσης (ή ακόμη και από μια διαφορετική).

Για περισσότερες πληροφορίες σχετικά με το πώς λειτουργεί αυτό ακριβώς, ελέγξτε:

{{#ref}}
gcp-understanding-domain-wide-delegation.md
{{#endref}}

### Συμβιβασμός Υφιστάμενης Εξουσιοδότησης

Εάν ένας επιτιθέμενος **συμβιβάσει κάποια πρόσβαση μέσω GCP** και **γνωρίζει μια έγκυρη διεύθυνση email χρήστη του Workspace** (κατά προτίμηση **super admin**) της εταιρείας, θα μπορούσε να **καταγράψει όλα τα έργα** στα οποία έχει πρόσβαση, **να καταγράψει όλους τους Λογαριασμούς Υπηρεσίας** των έργων, να ελέγξει σε ποιους **λογαριασμούς υπηρεσίας έχει πρόσβαση**, και **να επαναλάβει** όλα αυτά τα βήματα με κάθε Λογαριασμό Υπηρεσίας που μπορεί να παριστάνει.\
Με μια **λίστα όλων των λογαριασμών υπηρεσίας** στους οποίους έχει **πρόσβαση** και τη λίστα των **emails του Workspace**, ο επιτιθέμενος θα μπορούσε να προσπαθήσει να **παριστάνει τον χρήστη με κάθε λογαριασμό υπηρεσίας**.

> [!CAUTION]
> Σημειώστε ότι κατά τη ρύθμιση της εξουσιοδότησης σε επίπεδο τομέα δεν απαιτείται κανένας χρήστης του Workspace, επομένως αρκεί να γνωρίζετε **έναν έγκυρο για την παριστία**.\
> Ωστόσο, οι **προνομίες του παριστάμενου χρήστη θα χρησιμοποιηθούν**, οπότε αν είναι Super Admin θα μπορείτε να έχετε πρόσβαση σε όλα. Αν δεν έχει καμία πρόσβαση, αυτό θα είναι άχρηστο.

#### [GCP Generate Delegation Token](https://github.com/carlospolop/gcp_gen_delegation_token)

Αυτό το απλό σενάριο θα **δημιουργήσει ένα OAuth token ως ο εξουσιοδοτημένος χρήστης** που μπορείτε στη συνέχεια να χρησιμοποιήσετε για να αποκτήσετε πρόσβαση σε άλλες Google APIs με ή χωρίς `gcloud`:
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Αυτό είναι ένα εργαλείο που μπορεί να εκτελέσει την επίθεση ακολουθώντας αυτά τα βήματα:

1. **Αναγνωρίστε τα GCP Projects** χρησιμοποιώντας το Resource Manager API.
2. Επαναλάβετε για κάθε πόρο έργου και **αναγνωρίστε τους πόρους λογαριασμού υπηρεσίας GCP** στους οποίους έχει πρόσβαση ο αρχικός χρήστης IAM χρησιμοποιώντας το _GetIAMPolicy_.
3. Επαναλάβετε για **κάθε ρόλο λογαριασμού υπηρεσίας** και βρείτε ενσωματωμένους, βασικούς και προσαρμοσμένους ρόλους με άδεια _**serviceAccountKeys.create**_ στον πόρο λογαριασμού υπηρεσίας στόχου. Πρέπει να σημειωθεί ότι ο ρόλος του Editor κατέχει εγγενώς αυτή την άδεια.
4. Δημιουργήστε ένα **νέο `KEY_ALG_RSA_2048`** ιδιωτικό κλειδί για κάθε πόρο λογαριασμού υπηρεσίας που βρέθηκε με σχετική άδεια στην πολιτική IAM.
5. Επαναλάβετε για **κάθε νέο λογαριασμό υπηρεσίας και δημιουργήστε ένα `JWT`** **αντικείμενο** γι' αυτό που αποτελείται από τα διαπιστευτήρια του ιδιωτικού κλειδιού SA και μια έκταση OAuth. Η διαδικασία δημιουργίας ενός νέου _JWT_ αντικειμένου θα **επαναλάβει όλους τους υπάρχοντες συνδυασμούς εκτάσεων OAuth** από τη λίστα **oauth_scopes.txt**, προκειμένου να βρει όλες τις δυνατότητες αντιπροσώπευσης. Η λίστα **oauth_scopes.txt** ενημερώνεται με όλες τις εκτάσεις OAuth που έχουμε βρει ότι είναι σχετικές για την κατάχρηση ταυτοτήτων Workspace.
6. Η μέθοδος `_make_authorization_grant_assertion` αποκαλύπτει την ανάγκη να δηλωθεί ένας **στόχος χρήστη workspace**, αναφερόμενος ως _subject_, για τη δημιουργία JWTs υπό DWD. Ενώ αυτό μπορεί να φαίνεται ότι απαιτεί έναν συγκεκριμένο χρήστη, είναι σημαντικό να συνειδητοποιήσουμε ότι **η DWD επηρεάζει κάθε ταυτότητα εντός ενός τομέα**. Συνεπώς, η δημιουργία ενός JWT για **οποιονδήποτε χρήστη τομέα** επηρεάζει όλες τις ταυτότητες σε αυτόν τον τομέα, σύμφωνα με τον έλεγχο συνδυασμού μας. Απλά, ένας έγκυρος χρήστης Workspace είναι επαρκής για να προχωρήσουμε.\
Αυτός ο χρήστης μπορεί να οριστεί στο αρχείο _config.yaml_ του DeleFriend. Εάν δεν είναι ήδη γνωστός ένας χρήστης στόχος workspace, το εργαλείο διευκολύνει την αυτόματη αναγνώριση έγκυρων χρηστών workspace σκανάροντας τους χρήστες τομέα με ρόλους σε έργα GCP. Είναι σημαντικό να σημειωθεί (ξανά) ότι τα JWT είναι συγκεκριμένα για τομέα και δεν δημιουργούνται για κάθε χρήστη. Επομένως, η αυτόματη διαδικασία στοχεύει σε μία μοναδική ταυτότητα ανά τομέα.
7. **Αναγνωρίστε και δημιουργήστε ένα νέο bearer access token** για κάθε JWT και επικυρώστε το token μέσω του tokeninfo API.

#### [Gitlab's Python script](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp_misc/-/blob/master/gcp_delegation.py)

Η Gitlab έχει δημιουργήσει [αυτό το Python script](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_misc/blob/master/gcp_delegation.py) που μπορεί να κάνει δύο πράγματα - να καταγράψει τον κατάλογο χρηστών και να δημιουργήσει έναν νέο διοικητικό λογαριασμό ενώ υποδεικνύει ένα json με διαπιστευτήρια SA και τον χρήστη που θα μιμηθεί. Να πώς θα το χρησιμοποιούσατε:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Δημιουργία νέας εξουσιοδότησης (Persistence)

Είναι δυνατόν να **ελέγξετε τις Domain Wide Delegations στο** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Ένας επιτιθέμενος με την ικανότητα να **δημιουργεί λογαριασμούς υπηρεσίας σε ένα έργο GCP** και **δικαιώματα super admin στο GWS θα μπορούσε να δημιουργήσει μια νέα εξουσιοδότηση που επιτρέπει στους SAs να προσποιούνται ορισμένους χρήστες του GWS:**

1. **Δημιουργία Νέου Λογαριασμού Υπηρεσίας και Σχετικού Ζεύγους Κλειδιών:** Στο GCP, νέοι πόροι λογαριασμού υπηρεσίας μπορούν να παραχθούν είτε διαδραστικά μέσω της κονσόλας είτε προγραμματισμένα χρησιμοποιώντας άμεσες κλήσεις API και εργαλεία CLI. Αυτό απαιτεί το **ρόλο `iam.serviceAccountAdmin`** ή οποιονδήποτε προσαρμοσμένο ρόλο εξοπλισμένο με την **άδεια `iam.serviceAccounts.create`**. Μόλις δημιουργηθεί ο λογαριασμός υπηρεσίας, θα προχωρήσουμε στη δημιουργία ενός **σχετικού ζεύγους κλειδιών** (**άδεια `iam.serviceAccountKeys.create`**).
2. **Δημιουργία νέας εξουσιοδότησης**: Είναι σημαντικό να κατανοήσουμε ότι **μόνο ο ρόλος Super Admin έχει τη δυνατότητα να ρυθμίσει παγκόσμια Domain-Wide εξουσιοδότηση στο Google Workspace** και η Domain-Wide εξουσιοδότηση **δεν μπορεί να ρυθμιστεί προγραμματισμένα,** μπορεί να δημιουργηθεί και να ρυθμιστεί **χειροκίνητα** μέσω της κονσόλας Google Workspace.
- Η δημιουργία του κανόνα μπορεί να βρεθεί στη σελίδα **API controls → Manage Domain-Wide delegation in Google Workspace Admin console**.
3. **Επισύναψη δικαιωμάτων OAuth scopes**: Κατά τη ρύθμιση μιας νέας εξουσιοδότησης, η Google απαιτεί μόνο 2 παραμέτρους, το Client ID, το οποίο είναι το **OAuth ID του πόρου GCP Service Account**, και **OAuth scopes** που καθορίζουν ποιες κλήσεις API απαιτεί η εξουσιοδότηση.
- Η **πλήρης λίστα των OAuth scopes** μπορεί να βρεθεί [**εδώ**](https://developers.google.com/identity/protocols/oauth2/scopes), αλλά εδώ είναι μια σύσταση: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **Δράση εκ μέρους της στοχευμένης ταυτότητας:** Σε αυτό το σημείο, έχουμε ένα λειτουργικό εξουσιοδοτημένο αντικείμενο στο GWS. Τώρα, **χρησιμοποιώντας το ιδιωτικό κλειδί του GCP Service Account, μπορούμε να εκτελέσουμε κλήσεις API** (στο πεδίο που καθορίζεται στην παράμετρο OAuth scope) για να το ενεργοποιήσουμε και **να δράσουμε εκ μέρους οποιασδήποτε ταυτότητας που υπάρχει στο Google Workspace**. Όπως μάθαμε, ο λογαριασμός υπηρεσίας θα δημιουργήσει διαπιστευτήρια πρόσβασης ανάλογα με τις ανάγκες του και σύμφωνα με την άδεια που έχει για τις εφαρμογές REST API.
- Ελέγξτε την **προηγούμενη ενότητα** για ορισμένα **εργαλεία** για να χρησιμοποιήσετε αυτήν την εξουσιοδότηση.

#### Διασυνοριακή εξουσιοδότηση

Το OAuth SA ID είναι παγκόσμιο και μπορεί να χρησιμοποιηθεί για **διασυνοριακή εξουσιοδότηση**. Δεν έχει εφαρμοστεί καμία περιοριστική πολιτική για να αποτραπεί η διασυνοριακή εξουσιοδότηση. Με απλά λόγια, **οι λογαριασμοί υπηρεσίας από διαφορετικές οργανώσεις GCP μπορούν να χρησιμοποιηθούν για να ρυθμίσουν την εξουσιοδότηση σε επίπεδο τομέα σε άλλες οργανώσεις Workspace**. Αυτό θα είχε ως αποτέλεσμα **να απαιτείται μόνο πρόσβαση Super Admin στο Workspace**, και όχι πρόσβαση στον ίδιο λογαριασμό GCP, καθώς ο αντίπαλος μπορεί να δημιουργήσει Λογαριασμούς Υπηρεσίας και ιδιωτικά κλειδιά στον προσωπικά ελεγχόμενο λογαριασμό GCP του.

### Δημιουργία Έργου για την καταμέτρηση του Workspace

Κατά **προεπιλογή**, οι χρήστες του Workspace έχουν την άδεια να **δημιουργούν νέα έργα**, και όταν δημιουργείται ένα νέο έργο, ο **δημιουργός αποκτά το ρόλο του Ιδιοκτήτη**.

Επομένως, ένας χρήστης μπορεί να **δημιουργήσει ένα έργο**, **να ενεργοποιήσει** τις **API** για να καταμετρήσει το Workspace στο νέο του έργο και να προσπαθήσει να **καταμετρήσει** αυτό.

> [!CAUTION]
> Για να μπορέσει ένας χρήστης να καταμετρήσει το Workspace, χρειάζεται επίσης αρκετές άδειες Workspace (όχι κάθε χρήστης θα μπορεί να καταμετρήσει τον κατάλογο).
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
Ελέγξτε **περισσότερη αρίθμηση σε**:

{{#ref}}
../gcp-services/gcp-iam-and-org-policies-enum.md
{{#endref}}

### Κατάχρηση διαπιστευτηρίων Gcloud

Μπορείτε να βρείτε περισσότερες πληροφορίες σχετικά με τη ροή `gcloud` για σύνδεση σε:

{{#ref}}
../gcp-persistence/gcp-non-svc-persistence.md
{{#endref}}

Όπως εξηγείται εκεί, το gcloud μπορεί να ζητήσει την έκταση **`https://www.googleapis.com/auth/drive`** που θα επιτρέπει σε έναν χρήστη να έχει πρόσβαση στον δίσκο του χρήστη.\
Ως επιτιθέμενος, εάν έχετε παραβιάσει **φυσικά** τον υπολογιστή ενός χρήστη και ο **χρήστης είναι ακόμα συνδεδεμένος** με τον λογαριασμό του, θα μπορούσατε να συνδεθείτε δημιουργώντας ένα διακριτικό με πρόσβαση στον δίσκο χρησιμοποιώντας:
```bash
gcloud auth login --enable-gdrive-access
```
Αν ένας επιτιθέμενος παραβιάσει τον υπολογιστή ενός χρήστη, θα μπορούσε επίσης να τροποποιήσει το αρχείο `google-cloud-sdk/lib/googlecloudsdk/core/config.py` και να προσθέσει στο **`CLOUDSDK_SCOPES`** την έκταση **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../images/image (342).png" alt="" width="563"><figcaption></figcaption></figure>

> [!WARNING]
> Επομένως, την επόμενη φορά που ο χρήστης θα συνδεθεί, θα δημιουργήσει ένα **token με πρόσβαση στο drive** που ο επιτιθέμενος θα μπορούσε να εκμεταλλευτεί για να αποκτήσει πρόσβαση στο drive. Προφανώς, ο περιηγητής θα υποδείξει ότι το παραγόμενο token θα έχει πρόσβαση στο drive, αλλά καθώς ο χρήστης θα καλέσει ο ίδιος το **`gcloud auth login`**, πιθανότατα **δεν θα υποψιαστεί τίποτα.**
>
> Για να καταγράψετε τα αρχεία του drive: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**

## Από GWS σε GCP

### Πρόσβαση σε προνομιούχους χρήστες GCP

Αν ένας επιτιθέμενος έχει πλήρη πρόσβαση στο GWS, θα είναι σε θέση να αποκτήσει πρόσβαση σε ομάδες με προνομιακή πρόσβαση στο GCP ή ακόμη και σε χρήστες, επομένως η μετάβαση από το GWS στο GCP είναι συνήθως πιο "απλή" απλώς και μόνο επειδή **οι χρήστες στο GWS έχουν υψηλά προνόμια στο GCP**.

### Κλιμάκωση προνομίων Google Groups

Από προεπιλογή, οι χρήστες μπορούν να **ενταχθούν ελεύθερα σε ομάδες Workspace της Οργάνωσης** και αυτές οι ομάδες **μπορεί να έχουν εκχωρημένα δικαιώματα GCP** (ελέγξτε τις ομάδες σας στο [https://groups.google.com/](https://groups.google.com/)).

Εκμεταλλευόμενοι την **google groups privesc**, μπορεί να είστε σε θέση να κλιμακώσετε σε μια ομάδα με κάποιο είδος προνομιακής πρόσβασης στο GCP.

### Αναφορές

- [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

{{#include ../../../banners/hacktricks-training.md}}
