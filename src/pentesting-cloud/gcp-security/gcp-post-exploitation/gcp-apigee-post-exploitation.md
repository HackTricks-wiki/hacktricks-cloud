# GCP - Apigee Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Apigee metadata SSRF -> Dataflow cross-tenant pivot

Um único projeto tenant do Apigee pode ser abusado para alcançar o servidor de metadata do Message Processor, roubar sua conta de serviço e pivotar para um pipeline de analytics do Dataflow compartilhado que lê/grava buckets entre tenants.

### Expose the metadata server through Apigee

- Defina um target de proxy do Apigee para `http://169.254.169.254` e solicite tokens de `/computeMetadata/v1/instance/service-accounts/default/token` com `Metadata-Flavor: Google`.
- O metadata do GCP rejeita requisições que contenham `X-Forwarded-For`; o Apigee o adiciona por padrão. Remova-o com `AssignMessage` antes de encaminhar pelo proxy:
```xml
<AssignMessage name="strip-xff">
<Remove>
<Headers>
<Header name="X-Forwarded-For"/>
</Headers>
</Remove>
<IgnoreUnresolvedVariables>true</IgnoreUnresolvedVariables>
</AssignMessage>
```
### Enumerar a service account Apigee roubada

- The leaked SA (Google-managed under `gcp-sa-apigee`) pode ser enumerada com ferramentas como [gcpwn](https://github.com/NetSPI/gcpwn) para testar rapidamente permissões.
- Permissões poderosas observadas incluíam **Compute disk/snapshot admin**, **GCS read/write across tenant buckets**, e **Pub/Sub topic publish**. Descoberta básica:
```bash
gcloud compute disks list --project <tenant-project>
```
### Exfiltração de snapshot para serviços gerenciados opacos

Com direitos de disk/snapshot você pode inspecionar runtimes gerenciados offline mesmo que não consiga acessar o projeto do tenant:

1. Crie um snapshot de um disco alvo no projeto do tenant.
2. Copie/migre o snapshot para o seu projeto.
3. Recrie um disk a partir do snapshot e anexe-o à sua VM.
4. Monte e inspecione logs/configs para recuperar nomes de buckets internos, service accounts e opções do pipeline.

### Substituição de dependência do Dataflow via staging bucket gravável

- Analytics workers baixavam JARs de um GCS staging bucket na inicialização. Como o Apigee SA tinha permissão de escrita no bucket, faça o download e modifique o JAR (por exemplo, com Recaf) para chamar `http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token` e roubar o **Dataflow worker** token.
- Dataflow workers não tinham egress de internet; exfiltre escrevendo o token em um GCS bucket controlado pelo atacante usando as APIs GCP dentro do cluster.

### Forçar execução de JAR malicioso abusando do autoscaling

Workers existentes não recarregarão artefatos substituídos. Inunde a entrada do pipeline para acionar novos workers:
```bash
for i in {1..5000}; do
gcloud pubsub topics publish apigee-analytics-notifications \
--message "flood-$i" --project <tenant-project>
done
```
Instâncias recém-provisionadas buscam os JARs corrigidos e leak o Dataflow SA token.

### Falha de design de bucket cross-tenant

O código decompilado do Dataflow mostrou caminhos de cache como `revenue/edge/<api|mint>/tenant2TenantGroupCacheDir` em um shared metadata bucket, sem qualquer componente específico de tenant. Com o Dataflow token você pode read/write:

- `tenantToTenantGroup` caches expondo os nomes de project+environment de outros tenants.
- Pastas `customFields` e `datastores` contendo per-request analytics (incluindo end-user IPs e plaintext access tokens) de todos os tenants.
- Acesso de escrita implica potencial analytics tampering/poisoning.

## References

- [GatewayToHeaven: Finding a Cross-Tenant Vulnerability in GCP's Apigee](https://omeramiad.com/posts/gatewaytoheaven-gcp-cross-tenant-vulnerability/)
- [AssignMessage policy - header removal](https://cloud.google.com/apigee/docs/api-platform/reference/policies/assign-message-policy)

{{#include ../../../banners/hacktricks-training.md}}
