# GCP - Apigee Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Apigee metadata SSRF -> Dataflow cross-tenant pivot

Jedan Apigee tenant projekat može biti zloupotrebljen da se dođe do Message Processor metadata servera, ukrade njegov service account i pivot u shared Dataflow analytics pipeline koji čita/piše cross-tenant buckets.

### Expose the metadata server through Apigee

- Podesite Apigee proxy target na `http://169.254.169.254` i zahtevajte tokene sa `/computeMetadata/v1/instance/service-accounts/default/token` koristeći `Metadata-Flavor: Google`.
- GCP metadata odbacuje zahteve koji sadrže `X-Forwarded-For`; Apigee ga dodaje po defaultu. Uklonite ga pomoću `AssignMessage` pre prosleđivanja:
```xml
<AssignMessage name="strip-xff">
<Remove>
<Headers>
<Header name="X-Forwarded-For"/>
</Headers>
</Remove>
<IgnoreUnresolvedVariables>true</IgnoreUnresolvedVariables>
</AssignMessage>
```
### Enumerišite ukradeni Apigee service account

- The leaked SA (Google-managed under `gcp-sa-apigee`) može se enumerisati alatima kao što su [gcpwn](https://github.com/NetSPI/gcpwn) za brzo testiranje dozvola.
- Primećene moćne dozvole uključivale su **Compute disk/snapshot admin**, **GCS read/write across tenant buckets**, i **Pub/Sub topic publish**. Osnovno otkrivanje:
```bash
gcloud compute disks list --project <tenant-project>
```
### Snapshot exfiltration for opaque managed services

Sa pravima nad diskovima/snapshot-ima možete pregledati managed runtimes offline čak i ako ne možete da se prijavite u tenant project:

1. Kreirajte snapshot ciljanog diska u tenant project-u.
2. Kopirajte/migrirajte snapshot u vaš projekat.
3. Rekreirajte disk iz snapshot-a i priključite ga na vaš VM.
4. Montirajte i pregledajte logove/konfig fajlove da povratite interne nazive bucket-a, service accounts i pipeline opcije.

### Dataflow dependency replacement via writable staging bucket

- Analytics workers preuzimali su JAR-ove iz GCS staging bucket-a pri pokretanju. Pošto je Apigee SA imao write na bucket, preuzmite i patch-ujte JAR (npr. sa Recaf) da pozove `http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token` i ukrade **Dataflow worker** token.
- Dataflow workers nisu imali internet egress; exfiltrate možete izvesti upisujući token u GCS bucket koji kontroliše napadač koristeći in-cluster GCP APIs.

### Force malicious JAR execution by abusing autoscaling

Postojeći workers neće reload-ovati zamenjene artefakte. Poplavite pipeline input da trigger-ujete nove workere:
```bash
for i in {1..5000}; do
gcloud pubsub topics publish apigee-analytics-notifications \
--message "flood-$i" --project <tenant-project>
done
```
Nedavno provisionisane instance preuzimaju ispravljene JAR-ove i leak Dataflow SA token.

### Greška u dizajnu cross-tenant bucket-a

Decompilovani Dataflow kod je prikazao putanje keša kao `revenue/edge/<api|mint>/tenant2TenantGroupCacheDir` u zajedničkom metadata bucket-u, bez bilo kakve komponente specifične za tenant. Sa Dataflow tokenom možete čitati i pisati:

- `tenantToTenantGroup` keševi koji otkrivaju nazive projekata i okruženja drugih tenant-a.
- `customFields` i `datastores` folderi koji sadrže analitiku po zahtevu (uključujući IP krajnjih korisnika i plaintext access tokene) za sve tenant-e.
- Pristup za pisanje omogućava potencijalnu manipulaciju ili trovanje analitike.

## References

- [GatewayToHeaven: Finding a Cross-Tenant Vulnerability in GCP's Apigee](https://omeramiad.com/posts/gatewaytoheaven-gcp-cross-tenant-vulnerability/)
- [AssignMessage policy - header removal](https://cloud.google.com/apigee/docs/api-platform/reference/policies/assign-message-policy)

{{#include ../../../banners/hacktricks-training.md}}
