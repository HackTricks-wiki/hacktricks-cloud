# GCP - Apigee 后期利用

{{#include ../../../banners/hacktricks-training.md}}

## Apigee 元数据 SSRF -> Dataflow 跨租户 pivot

一个单独的 Apigee 租户项目可以被滥用以访问 Message Processor 的元数据服务器，窃取其 service account，并 pivot 到共享的 Dataflow 分析管道，该管道读取/写入 跨租户 buckets。

### 通过 Apigee 暴露 元数据 服务器

- 将 Apigee proxy target 设置为 `http://169.254.169.254`，并使用 `Metadata-Flavor: Google` 从 `/computeMetadata/v1/instance/service-accounts/default/token` 请求 tokens。
- GCP 元数据会拒绝包含 `X-Forwarded-For` 的请求；Apigee 默认会添加该头。在代理之前使用 `AssignMessage` 去除它：
```xml
<AssignMessage name="strip-xff">
<Remove>
<Headers>
<Header name="X-Forwarded-For"/>
</Headers>
</Remove>
<IgnoreUnresolvedVariables>true</IgnoreUnresolvedVariables>
</AssignMessage>
```
### 枚举被盗的 Apigee 服务账户

- The leaked SA (Google-managed under `gcp-sa-apigee`) 可以使用诸如 [gcpwn](https://github.com/NetSPI/gcpwn) 的工具进行枚举，以快速测试权限。
- 观察到的强权限包括 **Compute disk/snapshot admin**, **GCS read/write across tenant buckets**, 和 **Pub/Sub topic publish**。基本发现：
```bash
gcloud compute disks list --project <tenant-project>
```
### Snapshot exfiltration for opaque managed services

有了 disk/snapshot 权限，即使无法登录租户项目，也可以离线检查受管运行时：

1. 在租户项目中为目标 disk 创建 snapshot。
2. 将 snapshot 复制/迁移到你的项目。
3. 从 snapshot 重新创建 disk 并将其附加到你的 VM。
4. 挂载并检查日志/配置，以恢复内部 bucket 名称、service accounts 和 pipeline 选项。

### Dataflow dependency replacement via writable staging bucket

- Analytics workers 在启动时从 GCS staging bucket 拉取 JAR。因为 Apigee SA 拥有 bucket 写权限，下载并修补 JAR（例如使用 Recaf）以调用 `http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token` 并窃取 **Dataflow worker** token。
- Dataflow workers 缺乏互联网出口；通过使用 in-cluster GCP APIs 将 token 写入攻击者控制的 GCS bucket 来 exfiltrate。

### Force malicious JAR execution by abusing autoscaling

现有 workers 不会重新加载已替换的 artifacts。淹没 pipeline 输入以触发新的 workers：
```bash
for i in {1..5000}; do
gcloud pubsub topics publish apigee-analytics-notifications \
--message "flood-$i" --project <tenant-project>
done
```
新创建的实例会获取修补过的 JARs 并 leak the Dataflow SA token。

### 跨租户 bucket 设计缺陷

Decompiled Dataflow code 显示在一个共享的 metadata bucket 下存在诸如 `revenue/edge/<api|mint>/tenant2TenantGroupCacheDir` 的缓存路径，且没有任何租户特定的组件。凭借 Dataflow token 你可以 read/write:

- `tenantToTenantGroup` 缓存会暴露其他租户的项目和环境名称。
- `customFields` 和 `datastores` 文件夹保存每次请求的 analytics（包括终端用户 IP 和明文 access tokens），涉及所有租户。
- 写入权限意味着可能对分析数据进行篡改/中毒。

## References

- [GatewayToHeaven: Finding a Cross-Tenant Vulnerability in GCP's Apigee](https://omeramiad.com/posts/gatewaytoheaven-gcp-cross-tenant-vulnerability/)
- [AssignMessage policy - header removal](https://cloud.google.com/apigee/docs/api-platform/reference/policies/assign-message-policy)

{{#include ../../../banners/hacktricks-training.md}}
