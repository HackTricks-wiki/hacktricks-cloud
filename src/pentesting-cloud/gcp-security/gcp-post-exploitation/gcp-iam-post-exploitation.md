# GCP - IAM Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## IAM <a href="#service-account-impersonation" id="service-account-impersonation"></a>

You can find further information about IAM in:

{{#ref}}
../gcp-services/gcp-iam-and-org-policies-enum.md
{{#endref}}

### 向管理控制台授予访问权限 <a href="#granting-access-to-management-console" id="granting-access-to-management-console"></a>

对 [GCP management console](https://console.cloud.google.com) 的访问是**授予用户账户，而非服务账户**。要登录 Web 界面，你可以**授予你控制的 Google 账户访问权限**。这可以是一个通用的 "**@gmail.com**" 账户，它**不必是目标组织的成员**。

但是，要将基础角色中的 **Owner** **授予** 通用的 "@gmail.com" 账户，你需要**使用 web 控制台**。`gcloud` 如果你尝试授予高于 Editor 的权限会报错。

你可以使用以下命令将某用户授予你现有项目的 **基础角色 Editor**：
```bash
gcloud projects add-iam-policy-binding [PROJECT] --member user:[EMAIL] --role roles/editor
```
如果你在这里成功，尝试**访问 web 界面**并从那里进行探索。

这是**你可以使用 gcloud 工具分配的最高级别**。

### 删除 IAM 组件 `iam.*.delete`
`iam.*.delete` 权限（例如 `iam.roles.delete`、`iam.serviceAccountApiKeyBindings.delete`、`iam.serviceAccountKeys.delete` 等）允许某个身份删除关键的 IAM 组件，例如自定义角色、API key bindings、service account keys，以及 service accounts 本身。在攻击者手中，这可以用来移除合法的访问机制，从而造成拒绝服务。

要实施这样的攻击，例如可以使用以下命令删除角色：
```bash
gcloud iam roles delete <ROLE_ID> --project=<PROJECT_ID>
```
### `iam.serviceAccountKeys.disable` || `iam.serviceAccounts.disable`

`iam.serviceAccountKeys.disable` 和 `iam.serviceAccounts.disable` 权限允许禁用活动的服务账号密钥或服务账号；攻击者获得这些权限后，可能用来中断操作、造成拒绝服务，或通过阻止合法凭证的使用来妨碍事件响应。

要禁用服务账号，可以使用以下命令：
```bash
gcloud iam service-accounts disable <SA_EMAIL> --project=<PROJECT_ID>
```
要禁用服务账户的密钥，可以使用以下命令：
```bash
gcloud iam service-accounts keys disable <KEY_ID> --iam-account=<SA_EMAIL>
```
### `iam.*.undelete`
`iam.*.undelete` 权限允许恢复先前被删除的元素，例如 API 密钥绑定、自定义角色或服务账户。在攻击者手中，这可以用来撤销防御性操作（恢复被移除的访问权限）、重新建立已删除的入侵载体以维持持久性，或规避修复措施，从而增加事件遏制的难度。
```bash
gcloud iam service-accounts undelete "${SA_ID}" --project="${PROJECT}"
```
{{#include ../../../banners/hacktricks-training.md}}
