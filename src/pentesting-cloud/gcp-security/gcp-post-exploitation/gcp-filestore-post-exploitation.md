# GCP - Filestore Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Filestore

Pour plus d'informations sur Filestore, voir :

{{#ref}}
../gcp-services/gcp-filestore-enum.md
{{#endref}}

### Monter Filestore

Un système de fichiers partagé **pourrait contenir des informations sensibles** intéressantes du point de vue d'un attaquant. Avec l'accès au Filestore, il est possible de **le monter** :

<details>

<summary>Monter le système de fichiers Filestore</summary>
```bash
sudo apt-get update
sudo apt-get install nfs-common
# Check the share name
showmount -e <IP>
# Mount the share
mkdir /mnt/fs
sudo mount [FILESTORE_IP]:/[FILE_SHARE_NAME] /mnt/fs
```
</details>

Pour trouver l'adresse IP d'une instance filestore, consultez la section d'énumération de la page :

{{#ref}}
../gcp-services/gcp-filestore-enum.md
{{#endref}}

### Supprimer les restrictions et obtenir des permissions supplémentaires

Si l'attaquant n'est pas sur une adresse IP ayant accès au partage, mais que vous disposez de suffisamment de permissions pour le modifier, il est possible de supprimer les restrictions d'accès. Il est aussi possible d'accorder plus de privilèges à votre adresse IP pour obtenir un accès administrateur au partage :

<details>

<summary>Mettre à jour l'instance Filestore pour autoriser l'accès</summary>
```bash
gcloud filestore instances update nfstest \
--zone=<exact-zone> \
--flags-file=nfs.json

# Contents of nfs.json
{
"--file-share":
{
"capacity": "1024",
"name": "<share-name>",
"nfs-export-options": [
{
"access-mode": "READ_WRITE",
"ip-ranges": [
"<your-ip-private-address>/32"
],
"squash-mode": "NO_ROOT_SQUASH",
"anon_uid": 1003,
"anon_gid": 1003
}
]
}
}
```
</details>

### Restaurer une sauvegarde

S'il existe une sauvegarde, il est possible de la **restaurer** dans une instance existante ou dans une nouvelle instance afin que ses **informations deviennent accessibles :**

<details>

<summary>Créer une nouvelle instance et restaurer la sauvegarde</summary>
```bash
# Create a new filestore if you don't want to modify the old one
gcloud filestore instances create <new-instance-name> \
--zone=<zone> \
--tier=STANDARD \
--file-share=name=vol1,capacity=1TB \
--network=name=default,reserved-ip-range=10.0.0.0/29

# Restore a backups in a new instance
gcloud filestore instances restore <new-instance-name> \
--zone=<zone> \
--file-share=<instance-file-share-name> \
--source-backup=<backup-name> \
--source-backup-region=<backup-region>

# Follow the previous section commands to mount it
```
</details>

### Créer une sauvegarde et la restaurer

Si vous **n'avez pas accès à un share et ne voulez pas le modifier**, il est possible de **créer une sauvegarde** de celui-ci et de la **restaurer** comme indiqué précédemment :

<details>

<summary>Créer une sauvegarde et la restaurer dans une nouvelle instance</summary>
```bash
# Create share backup
gcloud filestore backups create <back-name> \
--region=<region> \
--instance=<instance-name> \
--instance-zone=<instance-zone> \
--file-share=<share-name>

# Follow the previous section commands to restore it and mount it
```
</details>

{{#include ../../../banners/hacktricks-training.md}}
