# GCP - Filestore Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Filestore

Więcej informacji o Filestore znajdziesz:

{{#ref}}
../gcp-services/gcp-filestore-enum.md
{{#endref}}

### Mount Filestore

Wspólny system plików **może zawierać wrażliwe informacje** interesujące z perspektywy atakującego. Mając dostęp do Filestore, możliwe jest jego **zamontowanie**:

<details>

<summary>Montowanie systemu plików Filestore</summary>
```bash
sudo apt-get update
sudo apt-get install nfs-common
# Check the share name
showmount -e <IP>
# Mount the share
mkdir /mnt/fs
sudo mount [FILESTORE_IP]:/[FILE_SHARE_NAME] /mnt/fs
```
</details>

Aby znaleźć adres IP instancji filestore, sprawdź sekcję enumeracji na stronie:

{{#ref}}
../gcp-services/gcp-filestore-enum.md
{{#endref}}

### Usuń ograniczenia i uzyskaj dodatkowe uprawnienia

Jeśli atakujący nie znajduje się na adresie IP mającym dostęp do udziału, ale ty masz wystarczające uprawnienia, aby go zmodyfikować, możliwe jest usunięcie ograniczeń dostępu do niego. Możliwe jest też przyznanie większych uprawnień dla twojego adresu IP, aby uzyskać uprawnienia administratora do udziału:

<details>

<summary>Zaktualizuj instancję Filestore, aby umożliwić dostęp</summary>
```bash
gcloud filestore instances update nfstest \
--zone=<exact-zone> \
--flags-file=nfs.json

# Contents of nfs.json
{
"--file-share":
{
"capacity": "1024",
"name": "<share-name>",
"nfs-export-options": [
{
"access-mode": "READ_WRITE",
"ip-ranges": [
"<your-ip-private-address>/32"
],
"squash-mode": "NO_ROOT_SQUASH",
"anon_uid": 1003,
"anon_gid": 1003
}
]
}
}
```
</details>

### Przywracanie kopii zapasowej

Jeśli istnieje kopia zapasowa, można ją **przywrócić** w istniejącej lub nowej instancji, dzięki czemu jej **zawartość stanie się dostępna:**

<details>

<summary>Utwórz nową instancję i przywróć kopię zapasową</summary>
```bash
# Create a new filestore if you don't want to modify the old one
gcloud filestore instances create <new-instance-name> \
--zone=<zone> \
--tier=STANDARD \
--file-share=name=vol1,capacity=1TB \
--network=name=default,reserved-ip-range=10.0.0.0/29

# Restore a backups in a new instance
gcloud filestore instances restore <new-instance-name> \
--zone=<zone> \
--file-share=<instance-file-share-name> \
--source-backup=<backup-name> \
--source-backup-region=<backup-region>

# Follow the previous section commands to mount it
```
</details>

### Utwórz kopię zapasową i przywróć ją

Jeśli **nie masz dostępu do udziału i nie chcesz go modyfikować**, możliwe jest **utworzenie jego kopii zapasowej** i **przywrócenie** jej, jak wspomniano wcześniej:

<details>

<summary>Utwórz kopię zapasową i przywróć ją w nowej instancji</summary>
```bash
# Create share backup
gcloud filestore backups create <back-name> \
--region=<region> \
--instance=<instance-name> \
--instance-zone=<instance-zone> \
--file-share=<share-name>

# Follow the previous section commands to restore it and mount it
```
</details>

{{#include ../../../banners/hacktricks-training.md}}
