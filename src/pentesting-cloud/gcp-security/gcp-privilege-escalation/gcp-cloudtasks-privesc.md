# GCP - Cloud Tasks Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Tasks

### `cloudtasks.tasks.create`, `iam.serviceAccounts.actAs`

Ένας επιτιθέμενος με αυτά τα δικαιώματα μπορεί να **υποδυθεί άλλους service accounts** δημιουργώντας tasks που εκτελούνται με την ταυτότητα του συγκεκριμένου service account. Αυτό επιτρέπει την αποστολή **πιστοποιημένων HTTP requests προς υπηρεσίες Cloud Run ή Cloud Functions που προστατεύονται από IAM**.

<details><summary>Create Cloud Task with service account impersonation</summary>
```bash
gcloud tasks create-http-task \
task-$(date '+%Y%m%d%H%M%S') \
--location us-central1 \
--queue <queue_name> \
--url 'https://<service_name>.us-central1.run.app' \
--method POST \
--header 'X-Hello: world' \
--body-content '{"hello":"world"}' \
--oidc-service-account-email <account>@<project_id>.iam.gserviceaccount.com
```
</details>

### `cloudtasks.tasks.run`, `cloudtasks.tasks.list`

Ένας επιτιθέμενος με αυτά τα δικαιώματα μπορεί να **εκτελέσει υπάρχουσες προγραμματισμένες εργασίες** χωρίς να έχει δικαιώματα στον λογαριασμό υπηρεσίας που σχετίζεται με την εργασία. Αυτό επιτρέπει την εκτέλεση εργασιών που είχαν δημιουργηθεί προηγουμένως με λογαριασμούς υπηρεσίας υψηλότερων προνομίων.

<details><summary>Εκτέλεση υπάρχουσας Cloud Task χωρίς δικαίωμα actAs</summary>
```bash
gcloud tasks run projects/<project_id>/locations/us-central1/queues/<queue_name>/tasks/<task_id>
```
</details>

Ο principal που εκτελεί αυτήν την εντολή **δεν χρειάζεται την άδεια `iam.serviceAccounts.actAs`** στον service account του task. Ωστόσο, αυτό επιτρέπει μόνο την εκτέλεση υπαρχόντων tasks — δεν παρέχει τη δυνατότητα δημιουργίας ή τροποποίησης των tasks.

### `cloudtasks.queues.setIamPolicy`

Ένας attacker με αυτήν την άδεια μπορεί να **χορηγήσει στον εαυτό του ή σε άλλους principals ρόλους του Cloud Tasks** σε συγκεκριμένες ουρές, ενδεχομένως κλιμακώνοντας σε `roles/cloudtasks.admin` που περιλαμβάνει τη δυνατότητα δημιουργίας και εκτέλεσης tasks.

<details><summary>Χορήγηση ρόλου admin του Cloud Tasks σε ουρά</summary>
```bash
gcloud tasks queues add-iam-policy-binding \
<queue_name> \
--location us-central1 \
--member serviceAccount:<account>@<project_id>.iam.gserviceaccount.com \
--role roles/cloudtasks.admin
```
</details>

Αυτό επιτρέπει στον επιτιθέμενο να παραχωρήσει πλήρη δικαιώματα διαχειριστή του Cloud Tasks για την ουρά σε οποιοδήποτε service account που ελέγχει.

## Αναφορές

- [Google Cloud Tasks Documentation](https://cloud.google.com/tasks/docs)

{{#include ../../../banners/hacktricks-training.md}}
