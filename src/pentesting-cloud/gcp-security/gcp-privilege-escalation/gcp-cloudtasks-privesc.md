# GCP - Cloud Tasks Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Tasks

### `cloudtasks.tasks.create`, `iam.serviceAccounts.actAs`

इन अनुमतियों वाले हमलावर निर्दिष्ट service account की पहचान के साथ चलने वाले टास्क बनाकर **impersonate other service accounts** कर सकते हैं। यह अनुमति देता है कि वे **authenticated HTTP requests to IAM-protected Cloud Run or Cloud Functions** सेवाओं को भेज सकें।

<details><summary>Create Cloud Task with service account impersonation</summary>
```bash
gcloud tasks create-http-task \
task-$(date '+%Y%m%d%H%M%S') \
--location us-central1 \
--queue <queue_name> \
--url 'https://<service_name>.us-central1.run.app' \
--method POST \
--header 'X-Hello: world' \
--body-content '{"hello":"world"}' \
--oidc-service-account-email <account>@<project_id>.iam.gserviceaccount.com
```
</details>

### `cloudtasks.tasks.run`, `cloudtasks.tasks.list`

इन permissions के साथ एक हमलावर उन service account पर permissions के बिना भी **मौजूदा शेड्यूल किए गए टास्क चला सकता है**। इससे उन टास्क्स को निष्पादित करने की अनुमति मिलती है जिन्हें पहले अधिक विशेषाधिकार वाले service accounts से बनाया गया था।

<details><summary>मौजूदा Cloud Task को बिना actAs permission के चलाएँ</summary>
```bash
gcloud tasks run projects/<project_id>/locations/us-central1/queues/<queue_name>/tasks/<task_id>
```
</details>

इस कमांड को निष्पादित करने वाले principal को टास्क के service account पर **`iam.serviceAccounts.actAs` permission** की आवश्यकता नहीं होती है। हालांकि, इससे केवल मौजूदा tasks को चलाने की अनुमति मिलती है — यह tasks बनाने या संशोधित करने की क्षमता नहीं देता।

### `cloudtasks.queues.setIamPolicy`

इस permission वाले attacker विशेष queues पर खुद को या अन्य principals को **Cloud Tasks roles** दे सकते हैं, जिससे संभावित रूप से `roles/cloudtasks.admin` तक escalate हो सकता है, जो tasks बनाने और चलाने की क्षमता देता है।

<details><summary>Queue पर Cloud Tasks admin role देना</summary>
```bash
gcloud tasks queues add-iam-policy-binding \
<queue_name> \
--location us-central1 \
--member serviceAccount:<account>@<project_id>.iam.gserviceaccount.com \
--role roles/cloudtasks.admin
```
</details>

यह हमलावर को किसी भी service account जिसे वे नियंत्रित करते हैं, उस queue पर पूर्ण Cloud Tasks admin permissions देने की अनुमति देता है।

## संदर्भ

- [Google Cloud Tasks Documentation](https://cloud.google.com/tasks/docs)

{{#include ../../../banners/hacktricks-training.md}}
