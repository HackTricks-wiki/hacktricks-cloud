# GCP - local privilege escalation ssh pivoting

{{#include ../../../banners/hacktricks-training.md}}

इस परिदृश्य में हम यह मानेंगे कि आप Compute Engine प्रोजेक्ट के एक VM के अंदर एक **गैर-प्रिविलेज्ड खाते** से समझौता कर चुके हैं।

हैरत की बात है कि आपने जिस Compute Engine का समझौता किया है उसकी GPC permissions आपकी मदद कर सकती हैं कि आप मशीन के अंदर स्थानीय रूप से **escalate privileges locally inside a machine** कर सकें। यह हमेशा क्लाउड वातावरण में बहुत मददगार नहीं होगा, लेकिन यह जानना अच्छा है कि यह संभव है।

## Read the scripts <a href="#follow-the-scripts" id="follow-the-scripts"></a>

**Compute Instances** संभवतः अपने service accounts के साथ कार्य करने के लिए कुछ स्क्रिप्ट्स **execute** करने के लिए मौजूद होते हैं।

चूँकि IAM काफी granular होता है, एक अकाउंट के पास किसी resource पर **read/write** अधिकार हो सकते हैं पर **no list privileges** हो सकते हैं।

इसका एक अच्छा काल्पनिक उदाहरण एक Compute Instance है जिसे `instance82736-long-term-xyz-archive-0332893` नाम के storage bucket में बैकअप पढ़ने/लिखने की अनुमति है।

कमांड लाइन से `gsutil ls` चलाने पर कुछ भी नहीं लौटता, क्योंकि service account के पास `storage.buckets.list` IAM permission नहीं है। हालाँकि, यदि आप `gsutil ls gs://instance82736-long-term-xyz-archive-0332893` चलाते हैं तो आप एक पूरा filesystem backup पा सकते हैं, जो आपको ऐसे डेटा का clear-text access दे सकता है जिसका आपका local Linux account उपयोग नहीं कर सकता।

आप यह bucket नाम किसी स्क्रिप्ट (bash, Python, Ruby...) के अंदर पा सकते हैं।

## Custom Metadata

प्रशासक [custom metadata](https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom) को **instance** और **project level** पर जोड़ सकते हैं। यह बस instances में **arbitrary key/value pairs** पास करने का एक तरीका है, और आमतौर पर environment variables और startup/shutdown scripts के लिए उपयोग किया जाता है।

इसके अलावा, यह संभव है कि आप **userdata** जोड़ें, जो एक स्क्रिप्ट होती है जो मशीन के हर बार start या restart होने पर **executed everytime** होती है और जिसे **accessed from the metadata endpoint also.**

For more info check:

{{#ref}}
https://book.hacktricks.wiki/en/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf.html
{{#endref}}

## **Abusing IAM permissions**

नीचे दिए गए अधिकांश permissions सामान्यतः **default Compute SA** को दिए जाते हैं, समस्या यह है कि **default access scope उन्हें उपयोग करने से रोकता है**। हालाँकि, यदि **`cloud-platform`** **scope** सक्षम है या केवल **`compute`** **scope** सक्षम है, तो आप उनका दुरुपयोग कर पाएँगे।

Check the following permissions:

- [**compute.instances.osLogin**](gcp-compute-privesc/index.html#compute.instances.oslogin)
- [**compute.instances.osAdminLogin**](gcp-compute-privesc/index.html#compute.instances.osadminlogin)
- [**compute.projects.setCommonInstanceMetadata**](gcp-compute-privesc/index.html#compute.projects.setcommoninstancemetadata)
- [**compute.instances.setMetadata**](gcp-compute-privesc/index.html#compute.instances.setmetadata)
- [**compute.instances.setIamPolicy**](gcp-compute-privesc/index.html#compute.instances.setiampolicy)

## Search for Keys in the filesystem

जाँचें कि क्या अन्य उपयोगकर्ताओं ने box के अंदर gcloud में लॉगिन किया है और अपनी credentials फ़ाइल सिस्टम में छोड़ी हैं:

<details><summary>फ़ाइल सिस्टम में gcloud credentials खोजें</summary>
```
sudo find / -name "gcloud"
```
</details>

ये सबसे दिलचस्प फाइलें:

- `~/.config/gcloud/credentials.db`
- `~/.config/gcloud/legacy_credentials/[ACCOUNT]/adc.json`
- `~/.config/gcloud/legacy_credentials/[ACCOUNT]/.boto`
- `~/.credentials.json`

### अधिक API Keys regexes

<details><summary>Grep patterns for GCP credentials and keys</summary>
```bash
TARGET_DIR="/path/to/whatever"

# Service account keys
grep -Pzr "(?s){[^{}]*?service_account[^{}]*?private_key.*?}" \
"$TARGET_DIR"

# Legacy GCP creds
grep -Pzr "(?s){[^{}]*?client_id[^{}]*?client_secret.*?}" \
"$TARGET_DIR"

# Google API keys
grep -Pr "AIza[a-zA-Z0-9\\-_]{35}" \
"$TARGET_DIR"

# Google OAuth tokens
grep -Pr "ya29\.[a-zA-Z0-9_-]{100,200}" \
"$TARGET_DIR"

# Generic SSH keys
grep -Pzr "(?s)-----BEGIN[ A-Z]*?PRIVATE KEY[a-zA-Z0-9/\+=\n-]*?END[ A-Z]*?PRIVATE KEY-----" \
"$TARGET_DIR"

# Signed storage URLs
grep -Pir "storage.googleapis.com.*?Goog-Signature=[a-f0-9]+" \
"$TARGET_DIR"

# Signed policy documents in HTML
grep -Pzr '(?s)<form action.*?googleapis.com.*?name="signature" value=".*?">' \
"$TARGET_DIR"
```
</details>

## संदर्भ

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{{#include ../../../banners/hacktricks-training.md}}
