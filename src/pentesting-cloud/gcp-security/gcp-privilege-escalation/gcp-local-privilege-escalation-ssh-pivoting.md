# GCP - 本地权限提升 SSH 代理

{{#include ../../../banners/hacktricks-training.md}}

在这个场景中，我们假设你**已经在 Compute Engine 项目中的虚拟机内攻陷了一个非特权账户**。

令人惊讶的是，你攻陷的计算引擎的 GPC 权限可能帮助你**在机器内部提升本地权限**。即使在云环境中这并不总是非常有用，但知道这是可能的还是很好的。

## 阅读脚本 <a href="#follow-the-scripts" id="follow-the-scripts"></a>

**计算实例**可能用于**执行一些脚本**以使用其服务账户执行操作。

由于 IAM 是细粒度的，一个账户可能对某个资源具有**读/写**权限，但**没有列出权限**。

一个很好的假设例子是一个计算实例，它有权限读取/写入名为 `instance82736-long-term-xyz-archive-0332893` 的存储桶的备份。

从命令行运行 `gsutil ls` 不会返回任何内容，因为服务账户缺少 `storage.buckets.list` IAM 权限。然而，如果你运行 `gsutil ls gs://instance82736-long-term-xyz-archive-0332893`，你可能会找到一个完整的文件系统备份，给你提供对你的本地 Linux 账户缺乏的明文数据访问。

你可能能够在脚本中找到这个存储桶的名称（在 bash、Python、Ruby 等中）。

## 自定义元数据

管理员可以在**实例**和**项目级别**添加 [自定义元数据](https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom)。这只是将**任意键/值对传递到实例**的一种方式，通常用于环境变量和启动/关闭脚本。

此外，可以添加**用户数据**，这是一个将在机器每次启动或重启时**执行的脚本**，并且可以**从元数据端点访问**。

更多信息请查看：

{{#ref}}
https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf
{{#endref}}

## **滥用 IAM 权限**

以下大多数提议的权限是**授予默认计算服务账户的，**唯一的问题是**默认访问范围阻止服务账户使用它们**。然而，如果**`cloud-platform`** **范围**启用或仅启用**`compute`** **范围**，你将能够**滥用它们**。

检查以下权限：

- [**compute.instances.osLogin**](gcp-compute-privesc/#compute.instances.oslogin)
- [**compute.instances.osAdminLogin**](gcp-compute-privesc/#compute.instances.osadminlogin)
- [**compute.projects.setCommonInstanceMetadata**](gcp-compute-privesc/#compute.projects.setcommoninstancemetadata)
- [**compute.instances.setMetadata**](gcp-compute-privesc/#compute.instances.setmetadata)
- [**compute.instances.setIamPolicy**](gcp-compute-privesc/#compute.instances.setiampolicy)

## 在文件系统中搜索密钥

检查其他用户是否在盒子内登录了 gcloud 并将其凭据留在文件系统中：
```
sudo find / -name "gcloud"
```
这些是最有趣的文件：

- `~/.config/gcloud/credentials.db`
- `~/.config/gcloud/legacy_credentials/[ACCOUNT]/adc.json`
- `~/.config/gcloud/legacy_credentials/[ACCOUNT]/.boto`
- `~/.credentials.json`

### 更多 API 密钥正则表达式
```bash
TARGET_DIR="/path/to/whatever"

# Service account keys
grep -Pzr "(?s){[^{}]*?service_account[^{}]*?private_key.*?}" \
"$TARGET_DIR"

# Legacy GCP creds
grep -Pzr "(?s){[^{}]*?client_id[^{}]*?client_secret.*?}" \
"$TARGET_DIR"

# Google API keys
grep -Pr "AIza[a-zA-Z0-9\\-_]{35}" \
"$TARGET_DIR"

# Google OAuth tokens
grep -Pr "ya29\.[a-zA-Z0-9_-]{100,200}" \
"$TARGET_DIR"

# Generic SSH keys
grep -Pzr "(?s)-----BEGIN[ A-Z]*?PRIVATE KEY[a-zA-Z0-9/\+=\n-]*?END[ A-Z]*?PRIVATE KEY-----" \
"$TARGET_DIR"

# Signed storage URLs
grep -Pir "storage.googleapis.com.*?Goog-Signature=[a-f0-9]+" \
"$TARGET_DIR"

# Signed policy documents in HTML
grep -Pzr '(?s)<form action.*?googleapis.com.*?name="signature" value=".*?">' \
"$TARGET_DIR"
```
## 参考文献

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{{#include ../../../banners/hacktricks-training.md}}
