# GCP - local privilege escalation ssh pivoting

{{#include ../../../banners/hacktricks-training.md}}

in this scenario we are going to suppose that you **have compromised a non privilege account** inside a VM in a Compute Engine project.

Erstaunlicherweise können die GPC-Berechtigungen der kompromittierten Compute Engine dir dabei helfen, lokal auf einer Maschine Privilegien zu eskalieren. Auch wenn das in einer Cloud-Umgebung nicht immer sehr hilfreich ist, ist es gut zu wissen, dass es möglich ist.

## Read the scripts <a href="#follow-the-scripts" id="follow-the-scripts"></a>

**Compute Instances** dienen wahrscheinlich dazu, **einige Skripte auszuführen**, um Aktionen mit ihren service accounts durchzuführen.

Da IAM sehr granular ist, kann ein Konto Lese-/Schreibrechte für eine Ressource besitzen, aber keine List-Rechte.

Ein gutes hypothetisches Beispiel ist eine Compute Instance, die die Berechtigung hat, Backups in einen storage bucket namens `instance82736-long-term-xyz-archive-0332893` zu lesen/schreiben.

Wenn du `gsutil ls` in der Kommandozeile ausführst, liefert das nichts zurück, da dem service account die `storage.buckets.list` IAM-Berechtigung fehlt. Wenn du jedoch `gsutil ls gs://instance82736-long-term-xyz-archive-0332893` ausführst, findest du möglicherweise ein komplettes Dateisystem-Backup, das dir Klartextzugriff auf Daten gewährt, die deinem lokalen Linux-Konto fehlen.

Du kannst diesen Bucket-Namen möglicherweise in einem Skript (in bash, Python, Ruby...) finden.

## Custom Metadata

Administratoren können [custom metadata](https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom) auf **instance**- und **project level** hinzufügen. Dies ist einfach eine Möglichkeit, **beliebige Schlüssel-/Wert-Paare an eine Instanz** zu übergeben und wird häufig für Umgebungsvariablen sowie Start-/Herunterfahr-Skripte verwendet.

Außerdem ist es möglich, **userdata** hinzuzufügen — ein Skript, das bei jedem Start oder Neustart der Maschine **ausgeführt** wird und das auch über den metadata endpoint **zugänglich** ist.

For more info check:

{{#ref}}
https://book.hacktricks.wiki/en/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf.html
{{#endref}}

## **Abusing IAM permissions**

Die meisten der folgenden vorgeschlagenen Berechtigungen werden dem **default Compute SA** gewährt; das einzige Problem ist, dass der **default access scope den SA an der Nutzung hindert**. Wenn jedoch der `cloud-platform` **scope** oder zumindest der `compute` **scope** aktiviert ist, wirst du in der Lage sein, sie zu **missbrauchen**.

Check the following permissions:

- [**compute.instances.osLogin**](gcp-compute-privesc/index.html#compute.instances.oslogin)
- [**compute.instances.osAdminLogin**](gcp-compute-privesc/index.html#compute.instances.osadminlogin)
- [**compute.projects.setCommonInstanceMetadata**](gcp-compute-privesc/index.html#compute.projects.setcommoninstancemetadata)
- [**compute.instances.setMetadata**](gcp-compute-privesc/index.html#compute.instances.setmetadata)
- [**compute.instances.setIamPolicy**](gcp-compute-privesc/index.html#compute.instances.setiampolicy)

## Search for Keys in the filesystem

Prüfe, ob sich andere Benutzer mit gcloud auf dem System angemeldet und ihre Zugangsdaten im Dateisystem hinterlassen haben:

<details><summary>Nach gcloud-Zugangsdaten im Dateisystem suchen</summary>
```
sudo find / -name "gcloud"
```
</details>

Dies sind die interessantesten Dateien:

- `~/.config/gcloud/credentials.db`
- `~/.config/gcloud/legacy_credentials/[ACCOUNT]/adc.json`
- `~/.config/gcloud/legacy_credentials/[ACCOUNT]/.boto`
- `~/.credentials.json`

### Weitere API-Schlüssel-Regexes

<details><summary>Grep-Muster für GCP-Anmeldeinformationen und Schlüssel</summary>
```bash
TARGET_DIR="/path/to/whatever"

# Service account keys
grep -Pzr "(?s){[^{}]*?service_account[^{}]*?private_key.*?}" \
"$TARGET_DIR"

# Legacy GCP creds
grep -Pzr "(?s){[^{}]*?client_id[^{}]*?client_secret.*?}" \
"$TARGET_DIR"

# Google API keys
grep -Pr "AIza[a-zA-Z0-9\\-_]{35}" \
"$TARGET_DIR"

# Google OAuth tokens
grep -Pr "ya29\.[a-zA-Z0-9_-]{100,200}" \
"$TARGET_DIR"

# Generic SSH keys
grep -Pzr "(?s)-----BEGIN[ A-Z]*?PRIVATE KEY[a-zA-Z0-9/\+=\n-]*?END[ A-Z]*?PRIVATE KEY-----" \
"$TARGET_DIR"

# Signed storage URLs
grep -Pir "storage.googleapis.com.*?Goog-Signature=[a-f0-9]+" \
"$TARGET_DIR"

# Signed policy documents in HTML
grep -Pzr '(?s)<form action.*?googleapis.com.*?name="signature" value=".*?">' \
"$TARGET_DIR"
```
</details>

## Referenzen

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{{#include ../../../banners/hacktricks-training.md}}
