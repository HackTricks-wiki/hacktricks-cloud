# GCP - IAM Privesc

{{#include ../../../banners/hacktricks-training.md}}

## IAM

IAM के बारे में अधिक जानकारी के लिए देखें:

{{#ref}}
../gcp-services/gcp-iam-and-org-policies-enum.md
{{#endref}}

### `iam.roles.update` (`iam.roles.get`)

उल्लेखित permissions वाले attacker आपके लिए असाइन किए गए role को अपडेट कर सकेंगे और आपको अन्य resources जैसे अतिरिक्त permissions दे सकेंगे:

<details><summary>IAM role को अपडेट करके permissions जोड़ें</summary>
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
</details>

आप एक स्क्रिप्ट पा सकते हैं जो vuln environment की **creation, exploit and cleaning** को automate करती है और इस privilege का दुरुपयोग करने के लिए एक python स्क्रिप्ट [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py). अधिक जानकारी के लिए [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) देखें।

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

उल्लेखित permissions वाले attacker किसी Service Account के लिए **access token request** कर पाएगा, इसलिए यह संभव है कि हमसे अधिक privileges वाले Service Account का access token प्राप्त किया जा सके।

<details><summary>Impersonate service account to get access token</summary>
```bash
gcloud --impersonate-service-account="${victim}@${PROJECT_ID}.iam.gserviceaccount.com" \
auth print-access-token
```
</details>

आप एक स्क्रिप्ट पा सकते हैं जो [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh) को ऑटोमेट करती है और इस privilege को दुरुपयोग करने के लिए एक python स्क्रिप्ट [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py) मौजूद है। अधिक जानकारी के लिए [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) देखें।

### `iam.serviceAccountKeys.create`

उल्लेखित अनुमतियाँ रखने वाला एक हमलावर **create a user-managed key for a Service Account** कर सकेगा, जिससे हम उस Service Account के रूप में GCP में access कर सकेंगे।

<details><summary>Service Account की कुंजी बनाएँ और प्रमाणीकरण करें</summary>
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
</details>

You can find a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh) and a python script to abuse this privilege [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py). For more information check the [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

ध्यान दें कि **`iam.serviceAccountKeys.update`** किसी SA की key को संशोधित करने के लिए काम नहीं करेगा क्योंकि उसके लिए अनुमति **`iam.serviceAccountKeys.create`** भी आवश्यक है।

### `iam.serviceAccounts.implicitDelegation`

यदि आपके पास किसी Service Account पर **`iam.serviceAccounts.implicitDelegation`** permission है और उस Service Account के पास किसी तीसरे Service Account पर **`iam.serviceAccounts.getAccessToken`** permission है, तो आप implicitDelegation का उपयोग करके उस तीसरे Service Account के लिए **token बना** सकते हैं। समझाने में मदद के लिए यहाँ एक डायग्राम है।

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

ध्यान दें कि [**documentation**](https://cloud.google.com/iam/docs/understanding-service-accounts) के अनुसार, `gcloud` की delegation केवल [**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken) मेथड का उपयोग करके token जनरेट करने के काम आती है। तो यहाँ बताया गया है कि API का उपयोग करके सीधे token कैसे प्राप्त किया जाए:

<details><summary>API का उपयोग करके delegation के साथ access token जनरेट करें</summary>
```bash
curl -X POST \
'https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/'"${TARGET_SERVICE_ACCOUNT}"':generateAccessToken' \
-H 'Content-Type: application/json' \
-H 'Authorization: Bearer '"$(gcloud auth print-access-token)" \
-d '{
"delegates": ["projects/-/serviceAccounts/'"${DELEGATED_SERVICE_ACCOUNT}"'"],
"scope": ["https://www.googleapis.com/auth/cloud-platform"]
}'
```
</details>

आप [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh) में vuln environment के निर्माण, exploit और क्लीनिंग को ऑटोमेट करने वाली स्क्रिप्ट पा सकते हैं और इस विशेषाधिकार का दुरुपयोग करने के लिए एक python स्क्रिप्ट [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py) में है। अधिक जानकारी के लिए [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) देखें।

### `iam.serviceAccounts.signBlob`

उक्त permissions वाले attacker GCP में arbitrary payloads को साइन कर सकेंगे। इसलिए यह संभव होगा कि हम target SA का unsigned JWT बनाकर उसे blob के रूप में भेजें ताकि लक्षित SA JWT को साइन कर दे। अधिक जानकारी के लिए [**read this**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed) देखें।

आप [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh) में vuln environment के निर्माण, exploit और क्लीनिंग को ऑटोमेट करने वाली स्क्रिप्ट पा सकते हैं और इस विशेषाधिकार का दुरुपयोग करने के लिए एक python स्क्रिप्ट [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py) और [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py) में है। अधिक जानकारी के लिए [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) देखें।

### `iam.serviceAccounts.signJwt`

उक्त permissions वाला attacker अच्छी तरह से बने JSON web tokens (JWTs) को साइन कर सकता है। पिछले तरीके से फर्क यह है कि **ब्लॉब में JWT रखकर google से साइन करवाने के बजाय हम signJWT method का उपयोग करते हैं जो पहले से ही एक JWT की अपेक्षा करता है**। इससे उपयोग करना आसान होता है पर आप केवल JWTs ही साइन कर सकते हैं, किसी भी बाइट्स को नहीं।

आप [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh) में vuln environment के निर्माण, exploit और क्लीनिंग को ऑटोमेट करने वाली स्क्रिप्ट पा सकते हैं और इस विशेषाधिकार का दुरुपयोग करने के लिए एक python स्क्रिप्ट [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py) में है। अधिक जानकारी के लिए [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) देखें।

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

उक्त permissions वाला attacker service accounts पर IAM policies जोड़ सकता है। आप इसे अपने आप को impersonate करने के लिए आवश्यक permissions देने के लिए दुरुपयोग कर सकते हैं। नीचे दिए गए उदाहरण में हम अपने आप को `roles/iam.serviceAccountTokenCreator` role उस रुचिकर SA पर दे रहे हैं:

<details><summary>Service account पर IAM policy binding जोड़ें</summary>
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"

# If you still have prblem grant yourself also this permission
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \ \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountUser"
```
</details>

आप इस स्क्रिप्ट को पा सकते हैं जो [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)** को ऑटोमेट करती है।**

### `iam.serviceAccounts.actAs`

**iam.serviceAccounts.actAs permission** iam:PassRole permission from AWS की तरह है। यह Compute Engine instance शुरू करने जैसे कार्यों को एक Service Account के रूप में करने की क्षमता देता है — यानी एक Service Account के रूप में "actAs" करने की अनुमति, जिससे permissions का सुरक्षित प्रबंधन सुनिश्चित होता है। इसके बिना, उपयोगकर्ता अनुचित पहुँच प्राप्त कर सकते हैं। इसके अलावा, iam.serviceAccounts.actAs का शोषण करने के कई तरीके हैं, जिनमें विभिन्न permissions की आवश्यकता होती है, जबकि अन्य तरीकों में केवल एक permission ही चाहिए होता है।

#### Service account impersonation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

Service account को impersonate करना नई और बेहतर privileges प्राप्त करने के लिए बहुत उपयोगी हो सकता है। आप किसी अन्य service account को impersonate करने के तीन तरीके हैं: https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating_a_service_account

- प्रमाणीकरण (प्रमाणिकरण) RSA private keys का उपयोग करके (ऊपर कवर किया गया)
- प्राधिकरण (authorization) Cloud IAM policies का उपयोग करके (यहाँ कवर किया गया)
- GCP services पर jobs तैनात करना (यह ज़्यादा applicable है user account के compromise के संदर्भ में)

### `iam.serviceAccounts.getOpenIdToken`

उल्लिखित permissions वाले एक attacker OpenID JWT जेनरेट कर पाएगा। OpenID JWT identity को assert करने के लिए उपयोग होते हैं और आवश्यक नहीं कि ये किसी संसाधन के खिलाफ कोई निहित प्राधिकरण प्रदान करें।

According to this [**interesting post**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b), यह आवश्यक है कि आप audience (जिस service पर आप token का उपयोग करके authenticate करना चाहते हैं) बताएं और आपको google द्वारा sign किया हुआ एक JWT मिलेगा जो service account और JWT के audience को दर्शाता है।

You can generate an OpenIDToken (if you have the access) with:

<details><summary>Service account के लिए OpenID token जेनरेट करें</summary>
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
</details>

फिर आप बस इसका उपयोग करके सेवा तक पहुँच सकते हैं:

<details><summary>Use OpenID token to authenticate</summary>
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
</details>

ऐसी कुछ सेवाएँ जो इस तरह के tokens के माध्यम से authentication का समर्थन करती हैं:

- [Google Cloud Run](https://cloud.google.com/run/)
- [Google Cloud Functions](https://cloud.google.com/functions/docs/)
- [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
- [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (if using Google OIDC)

You can find an example on how to create and OpenID token behalf a service account [**here**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py).

## संदर्भ

- [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{{#include ../../../banners/hacktricks-training.md}}
