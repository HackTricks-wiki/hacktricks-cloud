# GCP - IAM Privesc

{{#include ../../../banners/hacktricks-training.md}}

## IAM

IAM hakkında daha fazla bilgi için bakınız:

{{#ref}}
../gcp-services/gcp-iam-and-org-policies-enum.md
{{#endref}}

### `iam.roles.update` (`iam.roles.get`)

Belirtilen izinlere sahip bir attacker, size atanmış bir rolü güncelleyebilir ve size şu gibi diğer kaynaklara ek izinler verebilir:

<details><summary>İzin eklemek için IAM rolünü güncelle</summary>
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
</details>

Bir vuln environment'ın **oluşturulması, exploit edilmesi ve temizlenmesini otomatikleştiren bir scripti burada bulabilirsiniz** ve bu ayrıcalığı kötüye kullanmak için bir python scripti [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py). Daha fazla bilgi için [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

Bahsedilen izinlere sahip bir saldırgan, bir Service Account'a ait bir **access token talep edebilecektir**, bu nedenle bizden daha fazla ayrıcalığa sahip bir Service Account'un access token'ını talep etmek mümkün olabilir.

<details><summary>Service Account'u taklit ederek access token almak</summary>
```bash
gcloud --impersonate-service-account="${victim}@${PROJECT_ID}.iam.gserviceaccount.com" \
auth print-access-token
```
</details>

Otomatikleştirmek için bir scripti [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh) adresinde bulabilirsiniz ve bu ayrıcalığı kötüye kullanmak için bir python scripti [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py). Daha fazla bilgi için [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) sayfasına bakın.

### `iam.serviceAccountKeys.create`

Bahsedilen izinlere sahip bir saldırgan, **bir Service Account için kullanıcı tarafından yönetilen bir anahtar oluşturabilir**, bu da o Service Account olarak GCP'ye erişmemizi sağlar.

<details><summary>Service account anahtarı oluşturma ve kimlik doğrulama</summary>
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
</details>

Zafiyetli bir ortamın [**creation, exploit and cleaning of a vuln environment here**] oluşturulmasını, istismarını ve temizlenmesini otomatikleştiren bir scripti bulabilirsiniz ve bu ayrıcalığı kötüye kullanmak için bir python scripti [**here**] ayrıca mevcuttur. Daha fazla bilgi için [**original research**]’ı inceleyin.

Dikkat: **`iam.serviceAccountKeys.update` bir SA'nın anahtarını değiştirmek için çalışmaz** çünkü bunu yapmak için `iam.serviceAccountKeys.create` izni de gereklidir.

### `iam.serviceAccounts.implicitDelegation`

Bir Service Account üzerinde **`iam.serviceAccounts.implicitDelegation`** iznine sahipseniz ve bu Service Account üçüncü bir Service Account üzerinde **`iam.serviceAccounts.getAccessToken`** iznine sahipse, implicitDelegation'ı kullanarak o üçüncü Service Account için **bir token oluşturabilirsiniz**. Açıklamak için bir diyagram aşağıda.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

Not: [**documentation**]’a göre, `gcloud`'ün delegasyonu yalnızca [**generateAccessToken()**] metodunu kullanarak token üretmek için çalışır. Bu yüzden API'yi doğrudan kullanarak bir token elde etme şekli şöyle:

<details><summary>Delegasyon kullanarak API ile erişim tokenı oluşturma</summary>
```bash
curl -X POST \
'https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/'"${TARGET_SERVICE_ACCOUNT}"':generateAccessToken' \
-H 'Content-Type: application/json' \
-H 'Authorization: Bearer '"$(gcloud auth print-access-token)" \
-d '{
"delegates": ["projects/-/serviceAccounts/'"${DELEGATED_SERVICE_ACCOUNT}"'"],
"scope": ["https://www.googleapis.com/auth/cloud-platform"]
}'
```
</details>

Vulnerable ortamın oluşturulmasını, exploit edilmesini ve temizlenmesini otomatikleştiren bir scripti [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh) ve bu ayrıcalığı suistimal etmek için bir python scriptini [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py) adresinde bulabilirsiniz. Daha fazla bilgi için [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) inceleyin.

### `iam.serviceAccounts.signBlob`

Bahsedilen izinlere sahip bir saldırgan **GCP üzerinde rastgele payload'ları imzalayabilir**. Bu yüzden hedeflediğimiz SA'nın imzalaması için **SA'ya ait imzalanmamış bir JWT oluşturup bunu bir blob olarak göndererek JWT'nin imzalanmasını** sağlamak mümkün olacaktır. Daha fazla bilgi için [**read this**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed) bakın.

Otomatikleştirme için bir scripti [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh) ve bu ayrıcalığı suistimal etmek için bir python scriptini [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py) ve [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py) adreslerinde bulabilirsiniz. Daha fazla bilgi için [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) inceleyin.

### `iam.serviceAccounts.signJwt`

Bahsedilen izinlere sahip bir saldırgan **iyi biçimlendirilmiş JSON web token'ları (JWT'leri) imzalayabilir**. Önceki yöntemle arasındaki fark, **JWT içeren bir blob'un Google tarafından imzalanmasını sağlamak yerine, halihazırda bir JWT bekleyen signJWT yöntemini kullanmamızdır**. Bu kullanımını kolaylaştırır fakat herhangi bir byte dizisi yerine yalnızca JWT imzalayabilirsiniz.

Otomatikleştirme için bir scripti [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh) ve bu ayrıcalığı suistimal etmek için bir python scriptini [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py) adresinde bulabilirsiniz. Daha fazla bilgi için [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) inceleyin.

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

Bahsedilen izinlere sahip bir saldırgan **service account'lara IAM politikaları ekleyebilir**. Bunu, service account'u taklit etmek için ihtiyaç duyduğunuz izinleri kendinize **vermek** için suistimal edebilirsiniz. Aşağıdaki örnekte ilginç SA üzerinde kendimize `roles/iam.serviceAccountTokenCreator` rolünü veriyoruz:

<details><summary>Service account'a IAM policy binding ekle</summary>
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"

# If you still have prblem grant yourself also this permission
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \ \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountUser"
```
</details>

You can find a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)**.**

### `iam.serviceAccounts.actAs`

`iam.serviceAccounts.actAs` izni, AWS'teki `iam:PassRole` iznine benzer. Bir `Compute Engine` örneğini başlatmak gibi görevleri yürütmek için gereklidir; çünkü bir `Service Account` olarak "actAs" yapma yeteneği vererek izin yönetimini güvenli hale getirir. Bu izin olmadan kullanıcılar haksız erişim elde edebilir. Ayrıca, `iam.serviceAccounts.actAs`'ın kötüye kullanılması çeşitli yöntemler içerir ve her biri farklı izinler gerektirir; oysa bazı diğer yöntemler yalnızca tek bir izin gerektirir.

#### Service account impersonation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

Bir service account'un kimliğine bürünmek, yeni ve daha iyi ayrıcalıklar elde etmek için çok faydalı olabilir. Başka bir service account'un kimliğine bürünmenin üç yolu vardır: [impersonate another service account](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating_a_service_account):

- RSA private keys kullanarak authentication (yukarıda ele alındı)
- Cloud IAM policies kullanarak authorization (burada ele alındı)
- GCP servislerinde jobs deploy etme (daha çok bir kullanıcı hesabının ele geçirilmesine uygulanır)

### `iam.serviceAccounts.getOpenIdToken`

Bahsedilen izinlere sahip bir saldırgan, bir OpenID JWT oluşturabilir. Bunlar kimliği doğrulamak için kullanılır ve bir kaynağa karşı otomatik olarak herhangi bir yetki taşımazlar.

According to this [**interesting post**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b), tokenu kullanmak istediğiniz servis (audience) belirtmeniz gerektiğini söylüyor ve size hizmet hesabını ve JWT'nin audience'ını gösteren, google tarafından imzalanmış bir JWT verilecektir.

You can generate an OpenIDToken (if you have the access) with:

<details><summary>Hizmet hesabı için OpenID token oluşturma</summary>
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
</details>

Ardından servise erişmek için bunu kullanabilirsiniz:

<details><summary>OpenID token ile kimlik doğrulayın</summary>
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
</details>

Bu tür token'lar aracılığıyla kimlik doğrulamayı destekleyen bazı servisler şunlardır:

- [Google Cloud Run](https://cloud.google.com/run/)
- [Google Cloud Functions](https://cloud.google.com/functions/docs/)
- [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
- [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (eğer Google OIDC kullanılıyorsa)

Bir service account adına OpenID token oluşturmanın bir örneğini [**burada**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py) bulabilirsiniz.

## Kaynaklar

- [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{{#include ../../../banners/hacktricks-training.md}}
