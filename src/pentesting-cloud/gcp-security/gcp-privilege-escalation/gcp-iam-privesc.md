# GCP - IAM Privesc

{{#include ../../../banners/hacktricks-training.md}}

## IAM

Finden Sie weitere Informationen zu IAM in:

{{#ref}}
../gcp-services/gcp-iam-and-org-policies-enum.md
{{#endref}}

### `iam.roles.update` (`iam.roles.get`)

Ein Angreifer mit den genannten Berechtigungen kann eine Ihnen zugewiesene Rolle aktualisieren und Ihnen zusätzliche Berechtigungen für andere Ressourcen wie:
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
Sie können ein Skript zur Automatisierung der **Erstellung, Ausnutzung und Bereinigung einer verwundbaren Umgebung hier** finden und ein Python-Skript, um dieses Privileg [**hier**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py) auszunutzen. Für weitere Informationen überprüfen Sie die [**ursprüngliche Forschung**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

Ein Angreifer mit den genannten Berechtigungen wird in der Lage sein, **ein Zugriffstoken anzufordern, das zu einem Dienstkonto gehört**, sodass es möglich ist, ein Zugriffstoken eines Dienstkontos mit mehr Berechtigungen als unserem anzufordern.
```bash
gcloud --impersonate-service-account="${victim}@${PROJECT_ID}.iam.gserviceaccount.com" \
auth print-access-token
```
Sie können ein Skript zur Automatisierung der [**Erstellung, Ausnutzung und Bereinigung einer verwundbaren Umgebung hier**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh) finden und ein Python-Skript, um dieses Privileg auszunutzen [**hier**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py). Für weitere Informationen überprüfen Sie die [**ursprüngliche Forschung**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccountKeys.create`

Ein Angreifer mit den genannten Berechtigungen wird in der Lage sein, **einen benutzerverwalteten Schlüssel für ein Dienstkonto zu erstellen**, was uns den Zugriff auf GCP als dieses Dienstkonto ermöglicht.
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
Sie finden ein Skript zur Automatisierung der [**Erstellung, Ausnutzung und Bereinigung einer verwundbaren Umgebung hier**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh) und ein Python-Skript, um dieses Privileg auszunutzen [**hier**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py). Für weitere Informationen siehe die [**ursprüngliche Forschung**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

Beachten Sie, dass **`iam.serviceAccountKeys.update` nicht funktioniert, um den Schlüssel** eines SA zu ändern, da dafür auch die Berechtigung `iam.serviceAccountKeys.create` erforderlich ist.

### `iam.serviceAccounts.implicitDelegation`

Wenn Sie die **`iam.serviceAccounts.implicitDelegation`** Berechtigung für ein Dienstkonto haben, das die **`iam.serviceAccounts.getAccessToken`** Berechtigung für ein drittes Dienstkonto hat, können Sie implicitDelegation verwenden, um **ein Token für dieses dritte Dienstkonto zu erstellen**. Hier ist ein Diagramm zur Erklärung.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

Beachten Sie, dass laut der [**Dokumentation**](https://cloud.google.com/iam/docs/understanding-service-accounts) die Delegation von `gcloud` nur funktioniert, um ein Token mit der [**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken) Methode zu generieren. Hier ist, wie Sie ein Token direkt über die API erhalten:
```bash
curl -X POST \
'https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/'"${TARGET_SERVICE_ACCOUNT}"':generateAccessToken' \
-H 'Content-Type: application/json' \
-H 'Authorization: Bearer '"$(gcloud auth print-access-token)" \
-d '{
"delegates": ["projects/-/serviceAccounts/'"${DELEGATED_SERVICE_ACCOUNT}"'"],
"scope": ["https://www.googleapis.com/auth/cloud-platform"]
}'
```
Sie können ein Skript zur Automatisierung der [**Erstellung, Ausnutzung und Bereinigung einer verwundbaren Umgebung hier**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh) finden und ein Python-Skript, um dieses Privileg auszunutzen, [**hier**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py). Für weitere Informationen lesen Sie die [**ursprüngliche Forschung**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signBlob`

Ein Angreifer mit den genannten Berechtigungen wird in der Lage sein, **beliebige Payloads in GCP zu signieren**. Es wird also möglich sein, **ein unsigniertes JWT des SA zu erstellen und es dann als Blob zu senden, um das JWT vom SA, das wir anvisieren, signieren zu lassen**. Für weitere Informationen [**lesen Sie dies**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed).

Sie können ein Skript zur Automatisierung der [**Erstellung, Ausnutzung und Bereinigung einer verwundbaren Umgebung hier**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh) finden und ein Python-Skript, um dieses Privileg auszunutzen, [**hier**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py) und [**hier**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py). Für weitere Informationen lesen Sie die [**ursprüngliche Forschung**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signJwt`

Ein Angreifer mit den genannten Berechtigungen wird in der Lage sein, **wohlgeformte JSON-Web-Token (JWTs) zu signieren**. Der Unterschied zur vorherigen Methode besteht darin, dass **wir anstelle von Google, das ein Blob mit einem JWT signiert, die signJWT-Methode verwenden, die bereits ein JWT erwartet**. Dies macht die Verwendung einfacher, aber Sie können nur JWTs anstelle von beliebigen Bytes signieren.

Sie können ein Skript zur Automatisierung der [**Erstellung, Ausnutzung und Bereinigung einer verwundbaren Umgebung hier**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh) finden und ein Python-Skript, um dieses Privileg auszunutzen, [**hier**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py). Für weitere Informationen lesen Sie die [**ursprüngliche Forschung**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

Ein Angreifer mit den genannten Berechtigungen wird in der Lage sein, **IAM-Richtlinien zu Dienstkonten hinzuzufügen**. Sie können dies ausnutzen, um **sich selbst** die Berechtigungen zu gewähren, die Sie benötigen, um das Dienstkonto zu impersonieren. Im folgenden Beispiel gewähren wir uns die Rolle `roles/iam.serviceAccountTokenCreator` über das interessante SA:
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"

# If you still have prblem grant yourself also this permission
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \ \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountUser"
```
Sie finden ein Skript zur Automatisierung der [**Erstellung, Ausnutzung und Bereinigung einer verwundbaren Umgebung hier**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)**.**

### `iam.serviceAccounts.actAs`

Die **iam.serviceAccounts.actAs-Berechtigung** ist wie die **iam:PassRole-Berechtigung von AWS**. Sie ist entscheidend für die Ausführung von Aufgaben, wie das Starten einer Compute Engine-Instanz, da sie die Fähigkeit gewährt, "als" ein Dienstkonto zu agieren, was eine sichere Berechtigungsverwaltung gewährleistet. Ohne dies könnten Benutzer unrechtmäßigen Zugriff erhalten. Darüber hinaus umfasst die Ausnutzung der **iam.serviceAccounts.actAs** verschiedene Methoden, von denen jede eine Reihe von Berechtigungen erfordert, im Gegensatz zu anderen Methoden, die nur eine benötigen.

#### Dienstkonto-Impersonation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

Die Impersonation eines Dienstkontos kann sehr nützlich sein, um **neue und bessere Berechtigungen zu erhalten**. Es gibt drei Möglichkeiten, wie Sie [ein anderes Dienstkonto impersonieren können](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating_a_service_account):

- Authentifizierung **mit RSA-Privatschlüsseln** (oben behandelt)
- Autorisierung **mit Cloud IAM-Richtlinien** (hier behandelt)
- **Bereitstellung von Jobs auf GCP-Diensten** (mehr anwendbar auf den Kompromiss eines Benutzerkontos)

### `iam.serviceAccounts.getOpenIdToken`

Ein Angreifer mit den genannten Berechtigungen wird in der Lage sein, ein OpenID JWT zu generieren. Diese werden verwendet, um die Identität zu bestätigen und tragen nicht unbedingt eine implizite Autorisierung gegenüber einer Ressource.

Laut diesem [**interessanten Beitrag**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b) ist es notwendig, das Publikum (den Dienst, bei dem Sie das Token zur Authentifizierung verwenden möchten) anzugeben, und Sie erhalten ein von Google signiertes JWT, das das Dienstkonto und das Publikum des JWT angibt.

Sie können ein OpenIDToken generieren (wenn Sie den Zugriff haben) mit:
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
Dann können Sie es einfach verwenden, um auf den Dienst zuzugreifen mit:
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
Einige Dienste, die die Authentifizierung über diese Art von Tokens unterstützen, sind:

- [Google Cloud Run](https://cloud.google.com/run/)
- [Google Cloud Functions](https://cloud.google.com/functions/docs/)
- [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
- [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (wenn Google OIDC verwendet wird)

Sie finden ein Beispiel, wie man ein OpenID-Token im Namen eines Dienstkontos erstellt [**hier**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py).

## Referenzen

- [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{{#include ../../../banners/hacktricks-training.md}}
