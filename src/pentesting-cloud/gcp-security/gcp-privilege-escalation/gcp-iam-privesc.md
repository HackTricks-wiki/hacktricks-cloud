# GCP - IAM Privesc

{{#include ../../../banners/hacktricks-training.md}}

## IAM

IAM hakkında daha fazla bilgi için:

{{#ref}}
../gcp-services/gcp-iam-and-org-policies-enum.md
{{#endref}}

### `iam.roles.update` (`iam.roles.get`)

Belirtilen izinlere sahip bir saldırgan, size atanan bir rolü güncelleyebilir ve size aşağıdaki gibi diğer kaynaklara ek izinler verebilir:
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
Bir **vuln ortamının oluşturulması, istismar edilmesi ve temizlenmesi için bir script burada** ve bu yetkiyi kötüye kullanmak için bir python scripti [**burada**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py) bulabilirsiniz. Daha fazla bilgi için [**orijinal araştırmaya**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) bakın.

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

Belirtilen izinlere sahip bir saldırgan, **bir Hizmet Hesabına ait bir erişim tokeni talep edebilecektir**, bu nedenle bizden daha fazla yetkiye sahip bir Hizmet Hesabının erişim tokenini talep etmek mümkündür.
```bash
gcloud --impersonate-service-account="${victim}@${PROJECT_ID}.iam.gserviceaccount.com" \
auth print-access-token
```
Bir [**vuln ortamının oluşturulması, istismar edilmesi ve temizlenmesi için bir scripti burada bulabilirsiniz**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh) ve bu yetkileri kötüye kullanmak için bir python scripti [**burada**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py) bulunmaktadır. Daha fazla bilgi için [**orijinal araştırmaya**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) bakın.

### `iam.serviceAccountKeys.create`

Belirtilen izinlere sahip bir saldırgan, **bir Hizmet Hesabı için kullanıcı tarafından yönetilen bir anahtar oluşturabilecektir**, bu da bize GCP'ye o Hizmet Hesabı olarak erişim sağlayacaktır.
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
Bir [**vuln ortamının oluşturulması, istismar edilmesi ve temizlenmesi için bir script burada**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh) ve bu yetkiden yararlanmak için bir python scripti [**burada**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py) bulunmaktadır. Daha fazla bilgi için [**orijinal araştırmaya**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) bakın.

**`iam.serviceAccountKeys.update` anahtarın değiştirilmesi için çalışmayacaktır** çünkü bunu yapmak için `iam.serviceAccountKeys.create` izinleri de gereklidir.

### `iam.serviceAccounts.implicitDelegation`

Eğer **`iam.serviceAccounts.implicitDelegation`** iznine sahipseniz ve bu izin, üçüncü bir Service Account üzerinde **`iam.serviceAccounts.getAccessToken`** iznine sahip bir Service Account üzerinde ise, o zaman implicitDelegation kullanarak **o üçüncü Service Account için bir token oluşturabilirsiniz**. Açıklamaya yardımcı olması için bir diyagram burada.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

[**belgelere**](https://cloud.google.com/iam/docs/understanding-service-accounts) göre, `gcloud` delegasyonu yalnızca [**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken) yöntemini kullanarak bir token oluşturmak için çalışır. İşte API'yi doğrudan kullanarak bir token almanın yolu:
```bash
curl -X POST \
'https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/'"${TARGET_SERVICE_ACCOUNT}"':generateAccessToken' \
-H 'Content-Type: application/json' \
-H 'Authorization: Bearer '"$(gcloud auth print-access-token)" \
-d '{
"delegates": ["projects/-/serviceAccounts/'"${DELEGATED_SERVICE_ACCOUNT}"'"],
"scope": ["https://www.googleapis.com/auth/cloud-platform"]
}'
```
Bir saldırgan, belirtilen izinlere sahip olduğunda **GCP'de rastgele yükleri imzalayabilecektir**. Bu nedenle, **SA'nın imzasız bir JWT'sini oluşturmak ve ardından bunu hedeflediğimiz SA tarafından imzalanmış bir blob olarak göndermek mümkün olacaktır**. Daha fazla bilgi için [**bunu okuyun**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed).

Bir saldırgan, belirtilen izinlere sahip olduğunda **iyi biçimlendirilmiş JSON web token'larını (JWT'leri) imzalayabilecektir**. Önceki yöntemle arasındaki fark, **google'ın bir JWT içeren bir blob'u imzalamasını sağlamak yerine, zaten bir JWT bekleyen signJWT yöntemini kullanmamızdır**. Bu, kullanımını kolaylaştırır ancak yalnızca JWT'leri imzalayabilirsiniz, herhangi bir baytı değil.

Belirtilen izinlere sahip bir saldırgan, **hizmet hesaplarına IAM politikaları ekleyebilecektir**. Bunu, hizmet hesabını taklit etmek için ihtiyaç duyduğunuz izinleri **kendinize vermek** amacıyla kötüye kullanabilirsiniz. Aşağıdaki örnekte, ilginç SA üzerinde `roles/iam.serviceAccountTokenCreator` rolünü kendimize veriyoruz:
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"

# If you still have prblem grant yourself also this permission
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \ \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountUser"
```
Bir **vuln ortamının oluşturulması, istismar edilmesi ve temizlenmesi için otomatikleştirilmiş bir scripti burada bulabilirsiniz**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)**.**

### `iam.serviceAccounts.actAs`

**iam.serviceAccounts.actAs izni**, **AWS'deki iam:PassRole iznine** benzer. Bu, bir Compute Engine örneği başlatmak gibi görevleri yerine getirmek için gereklidir, çünkü bir Hizmet Hesabı olarak "hareket etme" yetkisi verir ve güvenli izin yönetimini sağlar. Bunu olmadan, kullanıcılar haksız yere erişim kazanabilir. Ayrıca, **iam.serviceAccounts.actAs** istismarı, her biri bir dizi izin gerektiren çeşitli yöntemler içerir; bu, yalnızca birine ihtiyaç duyan diğer yöntemlerle karşılaştırıldığında farklıdır.

#### Hizmet hesabı taklidi <a href="#service-account-impersonation" id="service-account-impersonation"></a>

Bir hizmet hesabını taklit etmek, **yeni ve daha iyi ayrıcalıklar elde etmek** için çok faydalı olabilir. Başka bir hizmet hesabını [taklit etmenin üç yolu vardır](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating_a_service_account):

- Kimlik doğrulama **RSA özel anahtarları kullanarak** (yukarıda ele alındı)
- Yetkilendirme **Cloud IAM politikaları kullanarak** (burada ele alındı)
- **GCP hizmetlerinde işler dağıtarak** (bir kullanıcı hesabının ele geçirilmesiyle daha çok ilgili)

### `iam.serviceAccounts.getOpenIdToken`

Bahsedilen izinlere sahip bir saldırgan, bir OpenID JWT oluşturabilecektir. Bunlar kimliği doğrulamak için kullanılır ve bir kaynağa karşı herhangi bir örtük yetkilendirme taşımak zorunda değildir.

Bu [**ilginç yazıya**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b) göre, hedef kitlenin (token ile kimlik doğrulamak istediğiniz hizmet) belirtilmesi gereklidir ve bir JWT alacaksınız; bu JWT, hizmet hesabını ve JWT'nin hedef kitlesini belirten google tarafından imzalanmıştır.

Erişiminiz varsa bir OpenIDToken oluşturabilirsiniz:
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
O zaman sadece hizmete erişmek için bunu kullanabilirsiniz:
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
Bu tür token'lar aracılığıyla kimlik doğrulamayı destekleyen bazı hizmetler şunlardır:

- [Google Cloud Run](https://cloud.google.com/run/)
- [Google Cloud Functions](https://cloud.google.com/functions/docs/)
- [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
- [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (Google OIDC kullanıyorsanız)

Bir hizmet hesabı adına OpenID token oluşturma ile ilgili bir örneği [**burada**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py) bulabilirsiniz.

## Referanslar

- [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{{#include ../../../banners/hacktricks-training.md}}
