# GCP - IAM Privesc

{{#include ../../../banners/hacktricks-training.md}}

## IAM

Pata habari zaidi kuhusu IAM katika:

{{#ref}}
../gcp-services/gcp-iam-and-org-policies-enum.md
{{#endref}}

### `iam.roles.update` (`iam.roles.get`)

Mshambuliaji mwenye ruhusa zilizotajwa ataweza kusasisha cheo kilichokukabidhiwa na kukupa ruhusa za ziada kwa rasilimali nyingine kama:

<details><summary>Sasisha cheo cha IAM ili kuongeza ruhusa</summary>
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
</details>

Unaweza kupata skripti ya ku-automate **uundaji, exploit na kusafisha mazingira ya vuln hapa** na skripti ya Python ya kuitumia vibaya ruhusa hii [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py). Kwa maelezo zaidi angalia [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

Mshambuliaji aliye na ruhusa zilizotajwa ataweza **kuomba access token inayomilikiwa na Service Account**, hivyo inawezekana kuomba access token ya Service Account yenye ruhusa zaidi kuliko zetu.

<details><summary>Kujifanya Service Account ili kupata access token</summary>
```bash
gcloud --impersonate-service-account="${victim}@${PROJECT_ID}.iam.gserviceaccount.com" \
auth print-access-token
```
</details>

Unaweza kupata skripti ya kuendesha kiotomatiki [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh) na skripti ya python ya kutumia ruhusa hii [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py). Kwa maelezo zaidi angalia [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccountKeys.create`

Mshambuliaji mwenye ruhusa zilizotajwa ataweza **create a user-managed key for a Service Account**, ambayo itatuwezesha kufikia GCP kama Service Account hiyo.

<details><summary>Unda key ya Service Account na ujithibitishe</summary>
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
</details>

Unaweza kupata script ili kuendesha kwa otomatiki [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh) na script ya python ya kudharau ruhusa hii [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py). Kwa maelezo zaidi angalia [**original research**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

Kumbuka kwamba **`iam.serviceAccountKeys.update` won't work to modify the key** ya SA kwa sababu kutekeleza hilo inahitaji ruhusa `iam.serviceAccountKeys.create`.

### `iam.serviceAccounts.implicitDelegation`

Ikiwa una ruhusa ya **`iam.serviceAccounts.implicitDelegation`** kwenye Service Account ambayo ina ruhusa ya **`iam.serviceAccounts.getAccessToken`** kwenye Service Account ya tatu, basi unaweza kutumia implicitDelegation ili **kuunda token kwa Service Account hiyo ya tatu**. Hapa kuna mchoro wa kusaidia kufafanua.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

Kumbuka kwamba kwa mujibu wa [**documentation**](https://cloud.google.com/iam/docs/understanding-service-accounts), delegation ya `gcloud` inafanya kazi tu kuunda token kwa kutumia njia ya [**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken). Hivyo hapa una jinsi ya kupata token ukitumia API moja kwa moja:

<details><summary>Generate access token with delegation using API</summary>
```bash
curl -X POST \
'https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/'"${TARGET_SERVICE_ACCOUNT}"':generateAccessToken' \
-H 'Content-Type: application/json' \
-H 'Authorization: Bearer '"$(gcloud auth print-access-token)" \
-d '{
"delegates": ["projects/-/serviceAccounts/'"${DELEGATED_SERVICE_ACCOUNT}"'"],
"scope": ["https://www.googleapis.com/auth/cloud-platform"]
}'
```
</details>

Unaweza kupata script ili kuendesha awtomatiki [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh) na python script ya kuudhulumu ruhusa hii [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py). Kwa taarifa zaidi angalia [**tafiti ya awali**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signBlob`

Mshambuliaji mwenye ruhusa zilizotajwa ataweza **kusaini arbitrary payloads katika GCP**. Hivyo itakuwa inawezekana **kuunda JWT isiyosainiwa ya SA kisha kuituma kama blob ili kupata JWT ilisainiwa** na SA tunayolenga. Kwa taarifa zaidi [**soma hili**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed).

Unaweza kupata script ili kuendesha awtomatiki [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh) na python script ya kuudhulumu ruhusa hii [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py) na [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py). Kwa taarifa zaidi angalia [**tafiti ya awali**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signJwt`

Mshambuliaji mwenye ruhusa zilizotajwa ataweza **kusaini well-formed JSON web tokens (JWTs)**. Tofauti na njia ya awali ni kwamba **badala ya kuifanya google kusaini blob iliyo na JWT, tunatumia method ya signJWT ambayo tayari inatarajia JWT**. Hii inafanya matumizi yake kuwa rahisi zaidi lakini unaweza kusaini tu JWT badala ya bytes yoyote.

Unaweza kupata script ili kuendesha awtomatiki [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh) na python script ya kuudhulumu ruhusa hii [**here**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py). Kwa taarifa zaidi angalia [**tafiti ya awali**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

Mshambuliaji mwenye ruhusa zilizotajwa ataweza **kuongeza sera za IAM kwa service accounts**. Unaweza kuibadilisha ili **kujipa** ruhusa unazo hitaji kuiga service account. Katika mfano ufuatao tunajiweka jukumu la `roles/iam.serviceAccountTokenCreator` juu ya SA inayoonekana kuwa ya kuvutia:

<details><summary>Ongeza binding ya sera za IAM kwa service account</summary>
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"

# If you still have prblem grant yourself also this permission
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \ \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountUser"
```
</details>

Unaweza kupata script ili kuendesha [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)**.**

### `iam.serviceAccounts.actAs`

Ruhusa ya **iam.serviceAccounts.actAs** ni kama ruhusa ya **iam:PassRole permission from AWS**. Ni muhimu kwa kutekeleza kazi, kama kuanzisha instance ya Compute Engine, kwa sababu inatoa uwezo wa "actAs" Service Account, na hivyo kuhakikisha usimamizi salama wa ruhusa. Bila hii, watumiaji wanaweza kupata upatikanaji usiofaa. Zaidi ya hayo, kuchafua au kutumia **iam.serviceAccounts.actAs** kunahusisha mbinu mbalimbali, kila moja ikihitaji seti ya ruhusa, tofauti na mbinu nyingine zinazohitaji moja tu.

#### Service account impersonation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

Kuiga Service Account inaweza kuwa muhimu sana ili **kupata ruhusa mpya na bora**. Kuna njia tatu unaweza [impersonate another service account](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating_a_service_account):

- Uthibitishaji **using RSA private keys** (imeelezewa hapo juu)
- Uhalalishaji **using Cloud IAM policies** (imeelezewa hapa)
- **Deploying jobs on GCP services** (inayoendana zaidi na kuathiriwa kwa user account)

### `iam.serviceAccounts.getOpenIdToken`

Mshambulizi mwenye ruhusa zilizotajwa ataweza kuunda OpenID JWT. Hizi hutumika kuthibitisha utambulisho na si lazima ziwe na mamlaka ya moja kwa moja dhidi ya rasilimali.

Kulingana na chapisho hiki [**interesting post**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b), ni lazima uainishe audience (huduma ambapo unataka kutumia token kuthibitisha) na utapokea JWT iliyotiwa saini na google ikionyesha service account na audience ya JWT.

Unaweza kuzalisha OpenIDToken (kama una access) kwa:

<details><summary>Generate OpenID token for service account</summary>
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
</details>

Kisha unaweza tu kuitumia kufikia huduma kwa:

<details><summary>Tumia token ya OpenID kuthibitisha</summary>
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
</details>

Baadhi ya huduma zinazounga mkono uthibitishaji kupitia tokens za aina hii ni:

- [Google Cloud Run](https://cloud.google.com/run/)
- [Google Cloud Functions](https://cloud.google.com/functions/docs/)
- [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
- [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (ikiwa unatumia Google OIDC)

Unaweza kupata mfano wa jinsi ya kuunda OpenID token kwa niaba ya akaunti ya huduma [**here**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py).

## References

- [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

{{#include ../../../banners/hacktricks-training.md}}
