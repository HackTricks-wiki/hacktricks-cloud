# GCP - Apikeys Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Apikeys

The following permissions are useful to create and steal API keys, not this from the docs: _API key 是一个简单的加密字符串，**在没有任何主体的情况下识别一个应用**。它们对于**匿名访问公共数据** 很有用，并用于**将**API 请求**关联**到你的项目以用于配额和**计费**。_

因此，使用 API key 你可以让该公司为你使用 API 支付费用，但你无法通过它来提升权限。

For more information about API Keys check:

{{#ref}}
../gcp-services/gcp-api-keys-enum.md
{{#endref}}

For other ways to create API keys check:

{{#ref}}
gcp-serviceusage-privesc.md
{{#endref}}

### Brute Force API Key access <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

由于你可能不知道该项目启用了哪些 APIs，或对你发现的 API key 应用了哪些限制，建议运行工具 [**https://github.com/ozguralp/gmapsapiscanner**](https://github.com/ozguralp/gmapsapiscanner) 来检查 **使用该 API key 可以访问到哪些内容。**

### `apikeys.keys.create` <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

此权限允许**创建 API key**：

<details>
<summary>使用 gcloud 创建 API key</summary>
```bash
gcloud services api-keys create
Operation [operations/akmf.p7-[...]9] complete. Result: {
"@type":"type.googleapis.com/google.api.apikeys.v2.Key",
"createTime":"2022-01-26T12:23:06.281029Z",
"etag":"W/\"HOhA[...]=\"",
"keyString":"AIzaSy[...]oU",
"name":"projects/5[...]6/locations/global/keys/f707[...]e8",
"uid":"f707[...]e8",
"updateTime":"2022-01-26T12:23:06.378442Z"
}
```
</details>

你可以在这里找到一个脚本来自动化 [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/b-apikeys.keys.create.sh).

> [!CAUTION]
> 注意：默认情况下，用户有权限创建新项目，并且在新项目上被授予 Owner role。因此用户可以**创建一个项目并在该项目内创建一个 API key**。

### `apikeys.keys.getKeyString` , `apikeys.keys.list` <a href="#apikeys.keys.getkeystringapikeys.keys.list" id="apikeys.keys.getkeystringapikeys.keys.list"></a>

这些权限允许**列出并获取所有 apiKeys 并获取 Key**：

<details>
<summary>列出并检索所有 API 密钥</summary>
```bash
for  key  in  $(gcloud services api-keys list --uri); do
gcloud services api-keys get-key-string "$key"
done
```
</details>

You can find a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/c-apikeys.keys.getKeyString.sh).

### `apikeys.keys.undelete` , `apikeys.keys.list` <a href="#serviceusage.apikeys.regenerateapikeys.keys.list" id="serviceusage.apikeys.regenerateapikeys.keys.list"></a>

这些权限允许你**列出并恢复已删除的 API 密钥**。在执行 **undelete** 操作后，**API 密钥会在输出中给出**：

<details>
<summary>列出并恢复 API 密钥</summary>
```bash
gcloud services api-keys list --show-deleted
gcloud services api-keys undelete <key-uid>
```
</details>

### 创建内部 OAuth 应用以 phish 其他工作人员

查看下列页面以了解如何执行此操作，尽管此操作属于服务 **`clientauthconfig`** [according to the docs](https://cloud.google.com/iap/docs/programmatic-oauth-clients#before-you-begin):

{{#ref}}
../../workspace-security/gws-google-platforms-phishing/
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
