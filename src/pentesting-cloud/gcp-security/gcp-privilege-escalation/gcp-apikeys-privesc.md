# GCP - Apikeys Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Apikeys

Los siguientes permisos son útiles para crear y robar claves API, no esto de la documentación: _Una clave API es una cadena encriptada simple que **identifica una aplicación sin ningún principal**. Son útiles para acceder a **datos públicos de forma anónima**, y se utilizan para **asociar** solicitudes API con tu proyecto para cuota y **facturación**._

Por lo tanto, con una clave API puedes hacer que esa empresa pague por tu uso de la API, pero no podrás escalar privilegios.

Para más información sobre claves API consulta:

{{#ref}}
../gcp-services/gcp-api-keys-enum.md
{{#endref}}

Para otras formas de crear claves API consulta:

{{#ref}}
gcp-serviceusage-privesc.md
{{#endref}}

### Brute Force API Key access <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

Como puede que no sepas qué APIs están habilitadas en el proyecto o las restricciones aplicadas a la clave API que encontraste, sería interesante ejecutar la herramienta [**https://github.com/ozguralp/gmapsapiscanner**](https://github.com/ozguralp/gmapsapiscanner) y verificar **a qué puedes acceder con la clave API.**

### `apikeys.keys.create` <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

Este permiso permite **crear una clave API**:
```bash
gcloud services api-keys create
Operation [operations/akmf.p7-[...]9] complete. Result: {
"@type":"type.googleapis.com/google.api.apikeys.v2.Key",
"createTime":"2022-01-26T12:23:06.281029Z",
"etag":"W/\"HOhA[...]==\"",
"keyString":"AIzaSy[...]oU",
"name":"projects/5[...]6/locations/global/keys/f707[...]e8",
"uid":"f707[...]e8",
"updateTime":"2022-01-26T12:23:06.378442Z"
}
```
Puedes encontrar un script para automatizar la [**creación, explotación y limpieza de un entorno vulnerable aquí**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/b-apikeys.keys.create.sh).

> [!CAUTION]
> Ten en cuenta que, por defecto, los usuarios tienen permisos para crear nuevos proyectos y se les otorga el rol de Owner sobre el nuevo proyecto. Así que un usuario podría **crear un proyecto y una clave API dentro de este proyecto**.

### `apikeys.keys.getKeyString`, `apikeys.keys.list` <a href="#apikeys.keys.getkeystringapikeys.keys.list" id="apikeys.keys.getkeystringapikeys.keys.list"></a>

Estos permisos permiten **listar y obtener todas las apiKeys y obtener la clave**:
```bash
for  key  in  $(gcloud services api-keys list --uri); do
gcloud services api-keys get-key-string "$key"
done
```
Puedes encontrar un script para automatizar la [**creación, explotación y limpieza de un entorno vulnerable aquí**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/c-apikeys.keys.getKeyString.sh).

### `apikeys.keys.undelete` , `apikeys.keys.list` <a href="#serviceusage.apikeys.regenerateapikeys.keys.list" id="serviceusage.apikeys.regenerateapikeys.keys.list"></a>

Estos permisos te permiten **listar y regenerar claves de API eliminadas**. La **clave de API se proporciona en la salida** después de que se complete la **recuperación**:
```bash
gcloud services api-keys list --show-deleted
gcloud services api-keys undelete <key-uid>
```
### Crear una aplicación interna de OAuth para phishing a otros trabajadores

Consulta la siguiente página para aprender cómo hacer esto, aunque esta acción pertenece al servicio **`clientauthconfig`** [según la documentación](https://cloud.google.com/iap/docs/programmatic-oauth-clients#before-you-begin):

{{#ref}}
../../workspace-security/gws-google-platforms-phishing/
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
