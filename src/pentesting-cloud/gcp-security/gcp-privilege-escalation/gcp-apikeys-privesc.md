# GCP - Apikeys Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Apikeys

Los siguientes permisos son útiles para crear y robar API keys, nota esto de la documentación: _Una API key es una cadena simple encriptada que **identifica una aplicación sin ningún principal**. Son útiles para acceder a **datos públicos de forma anónima**, y se usan para **asociar** las solicitudes de API con tu proyecto para cuota y **facturación**._

Por lo tanto, con una API key puedes hacer que la empresa pague por tu uso de la API, pero no podrás escalar privilegios.

For more information about API Keys check:

{{#ref}}
../gcp-services/gcp-api-keys-enum.md
{{#endref}}

For other ways to create API keys check:

{{#ref}}
gcp-serviceusage-privesc.md
{{#endref}}

### Brute Force API Key access <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

Como puede que no sepas qué APIs están habilitadas en el proyecto o las restricciones aplicadas a la API key que encontraste, sería interesante ejecutar la herramienta [**https://github.com/ozguralp/gmapsapiscanner**](https://github.com/ozguralp/gmapsapiscanner) y comprobar **a qué puedes acceder con la API key.**

### `apikeys.keys.create` <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

Este permiso permite **crear una API key**:

<details>
<summary>Create an API key using gcloud</summary>
```bash
gcloud services api-keys create
Operation [operations/akmf.p7-[...]9] complete. Result: {
"@type":"type.googleapis.com/google.api.apikeys.v2.Key",
"createTime":"2022-01-26T12:23:06.281029Z",
"etag":"W/\"HOhA[...]=\"",
"keyString":"AIzaSy[...]oU",
"name":"projects/5[...]6/locations/global/keys/f707[...]e8",
"uid":"f707[...]e8",
"updateTime":"2022-01-26T12:23:06.378442Z"
}
```
</details>

Puedes encontrar un script para automatizar la [**creación, exploit y limpieza de un vuln environment aquí**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/b-apikeys.keys.create.sh).

> [!CAUTION]
> Ten en cuenta que por defecto los usuarios tienen permisos para crear nuevos proyectos y se les concede el rol Owner sobre el nuevo proyecto. Por lo tanto, un usuario podría **crear un proyecto y una API key dentro de este proyecto**.

### `apikeys.keys.getKeyString` , `apikeys.keys.list` <a href="#apikeys.keys.getkeystringapikeys.keys.list" id="apikeys.keys.getkeystringapikeys.keys.list"></a>

Estos permisos permiten **listar y obtener todas las apiKeys y obtener la Key**:

<details>
<summary>Listar y recuperar todas las API keys</summary>
```bash
for  key  in  $(gcloud services api-keys list --uri); do
gcloud services api-keys get-key-string "$key"
done
```
</details>

Puedes encontrar un script para automatizar la [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/c-apikeys.keys.getKeyString.sh).

### `apikeys.keys.undelete` , `apikeys.keys.list` <a href="#serviceusage.apikeys.regenerateapikeys.keys.list" id="serviceusage.apikeys.regenerateapikeys.keys.list"></a>

Estos permisos te permiten **listar y regenerar api keys eliminadas**. La **API key aparece en la salida** después de que se realiza el **undelete**:

<details>
<summary>Listar y undelete API keys</summary>
```bash
gcloud services api-keys list --show-deleted
gcloud services api-keys undelete <key-uid>
```
</details>

### Crear Internal OAuth Application para phish a otros trabajadores

Consulta la siguiente página para aprender cómo hacer esto, aunque esta acción pertenece al servicio **`clientauthconfig`** [según la documentación](https://cloud.google.com/iap/docs/programmatic-oauth-clients#before-you-begin):

{{#ref}}
../../workspace-security/gws-google-platforms-phishing/
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
