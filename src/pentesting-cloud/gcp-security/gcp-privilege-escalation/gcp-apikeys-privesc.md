# GCP - Apikeys Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Apikeys

Les permissions suivantes sont utiles pour créer et voler des clés API, notez ceci d'après la doc : _Une clé API est une chaîne chiffrée simple qui **identifie une application sans aucun principal**. Elles sont utiles pour accéder **anonymement à des données publiques**, et sont utilisées pour **associer** les requêtes API à votre projet pour le quota et la **facturation**._

Par conséquent, avec une clé API vous pouvez faire en sorte que l'entreprise paie pour votre utilisation de l'API, mais vous ne pourrez pas obtenir d'élévation de privilèges.

For more information about API Keys check:

{{#ref}}
../gcp-services/gcp-api-keys-enum.md
{{#endref}}

For other ways to create API keys check:

{{#ref}}
gcp-serviceusage-privesc.md
{{#endref}}

### Brute Force API Key access <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

Comme vous pouvez ne pas savoir quelles APIs sont activées dans le projet ou quelles restrictions s'appliquent à la clé API que vous avez trouvée, il peut être intéressant d'exécuter l'outil [**https://github.com/ozguralp/gmapsapiscanner**](https://github.com/ozguralp/gmapsapiscanner) et vérifier **ce à quoi vous pouvez accéder avec la clé API.**

### `apikeys.keys.create` <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

Cette permission permet de **créer une clé API** :

<details>
<summary>Créer une clé API en utilisant gcloud</summary>
```bash
gcloud services api-keys create
Operation [operations/akmf.p7-[...]9] complete. Result: {
"@type":"type.googleapis.com/google.api.apikeys.v2.Key",
"createTime":"2022-01-26T12:23:06.281029Z",
"etag":"W/\"HOhA[...]=\"",
"keyString":"AIzaSy[...]oU",
"name":"projects/5[...]6/locations/global/keys/f707[...]e8",
"uid":"f707[...]e8",
"updateTime":"2022-01-26T12:23:06.378442Z"
}
```
</details>

Vous pouvez trouver un script pour automatiser la [**création, l'exploitation et le nettoyage d'un environnement vulnérable ici**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/b-apikeys.keys.create.sh).

> [!CAUTION]
> Notez que, par défaut, les utilisateurs ont la permission de créer de nouveaux projets et se voient attribuer le rôle Owner sur le nouveau projet. Ainsi, un utilisateur pourrait **créer un projet et une API key à l'intérieur de ce projet**.

### `apikeys.keys.getKeyString` , `apikeys.keys.list` <a href="#apikeys.keys.getkeystringapikeys.keys.list" id="apikeys.keys.getkeystringapikeys.keys.list"></a>

Ces permissions permettent de **lister toutes les apiKeys et d'obtenir la Key** :

<details>
<summary>Lister et récupérer toutes les API keys</summary>
```bash
for  key  in  $(gcloud services api-keys list --uri); do
gcloud services api-keys get-key-string "$key"
done
```
</details>

Vous pouvez trouver un script pour automatiser la [**création, exploit et nettoyage d'un vuln environment ici**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/c-apikeys.keys.getKeyString.sh).

### `apikeys.keys.undelete` , `apikeys.keys.list` <a href="#serviceusage.apikeys.regenerateapikeys.keys.list" id="serviceusage.apikeys.regenerateapikeys.keys.list"></a>

Ces permissions vous permettent de **lister et régénérer les api keys supprimées**. La **API key est donnée dans la sortie** après que l'**undelete** soit effectué :

<details>
<summary>Lister et undelete les api keys</summary>
```bash
gcloud services api-keys list --show-deleted
gcloud services api-keys undelete <key-uid>
```
</details>

### Créer une application OAuth interne pour phish d'autres employés

Consultez la page suivante pour apprendre comment faire cela, bien que cette action appartienne au service **`clientauthconfig`** [selon la documentation](https://cloud.google.com/iap/docs/programmatic-oauth-clients#before-you-begin):

{{#ref}}
../../workspace-security/gws-google-platforms-phishing/
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
