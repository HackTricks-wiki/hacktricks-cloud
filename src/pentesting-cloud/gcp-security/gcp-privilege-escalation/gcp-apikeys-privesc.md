# GCP - Apikeys Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Apikeys

As permissões a seguir são úteis para criar e roubar chaves de API, não esqueça disso nos documentos: _Uma chave de API é uma string simples criptografada que **identifica uma aplicação sem qualquer principal**. Elas são úteis para acessar **dados públicos anonimamente**, e são usadas para **associar** solicitações de API ao seu projeto para cota e **cobrança**._

Portanto, com uma chave de API você pode fazer com que a empresa pague pelo seu uso da API, mas você não conseguirá escalar privilégios.

Para mais informações sobre Chaves de API, consulte:

{{#ref}}
../gcp-services/gcp-api-keys-enum.md
{{#endref}}

Para outras maneiras de criar chaves de API, consulte:

{{#ref}}
gcp-serviceusage-privesc.md
{{#endref}}

### Acesso por Força Bruta à Chave de API <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

Como você pode não saber quais APIs estão habilitadas no projeto ou as restrições aplicadas à chave de API que você encontrou, seria interessante executar a ferramenta [**https://github.com/ozguralp/gmapsapiscanner**](https://github.com/ozguralp/gmapsapiscanner) e verificar **o que você pode acessar com a chave de API.**

### `apikeys.keys.create` <a href="#apikeys.keys.create" id="apikeys.keys.create"></a>

Esta permissão permite **criar uma chave de API**:
```bash
gcloud services api-keys create
Operation [operations/akmf.p7-[...]9] complete. Result: {
"@type":"type.googleapis.com/google.api.apikeys.v2.Key",
"createTime":"2022-01-26T12:23:06.281029Z",
"etag":"W/\"HOhA[...]==\"",
"keyString":"AIzaSy[...]oU",
"name":"projects/5[...]6/locations/global/keys/f707[...]e8",
"uid":"f707[...]e8",
"updateTime":"2022-01-26T12:23:06.378442Z"
}
```
Você pode encontrar um script para automatizar a [**criação, exploração e limpeza de um ambiente vulnerável aqui**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/b-apikeys.keys.create.sh).

> [!CAUTION]
> Note que, por padrão, os usuários têm permissões para criar novos projetos e recebem o papel de Proprietário sobre o novo projeto. Assim, um usuário poderia **criar um projeto e uma chave de API dentro deste projeto**.

### `apikeys.keys.getKeyString` , `apikeys.keys.list` <a href="#apikeys.keys.getkeystringapikeys.keys.list" id="apikeys.keys.getkeystringapikeys.keys.list"></a>

Essas permissões permitem **listar e obter todas as apiKeys e obter a Chave**:
```bash
for  key  in  $(gcloud services api-keys list --uri); do
gcloud services api-keys get-key-string "$key"
done
```
Você pode encontrar um script para automatizar a [**criação, exploração e limpeza de um ambiente vulnerável aqui**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/c-apikeys.keys.getKeyString.sh).

### `apikeys.keys.undelete` , `apikeys.keys.list` <a href="#serviceusage.apikeys.regenerateapikeys.keys.list" id="serviceusage.apikeys.regenerateapikeys.keys.list"></a>

Essas permissões permitem que você **liste e regenere chaves de API deletadas**. A **chave de API é fornecida na saída** após a **desfazer exclusão** ser concluída:
```bash
gcloud services api-keys list --show-deleted
gcloud services api-keys undelete <key-uid>
```
### Criar Aplicativo OAuth Interno para phishing de outros trabalhadores

Verifique a página a seguir para aprender como fazer isso, embora essa ação pertença ao serviço **`clientauthconfig`** [de acordo com a documentação](https://cloud.google.com/iap/docs/programmatic-oauth-clients#before-you-begin):

{{#ref}}
../../workspace-security/gws-google-platforms-phishing/
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
