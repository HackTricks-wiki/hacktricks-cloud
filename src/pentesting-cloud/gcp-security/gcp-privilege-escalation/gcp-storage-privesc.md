# GCP - Storage Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Storage

Basic Information:

{{#ref}}
../gcp-services/gcp-storage-enum.md
{{#endref}}

### `storage.objects.get`

Ruhusa hii inakuwezesha **kupakua faili zilizohifadhiwa ndani ya Cloud Storage**. Hii inaweza kukuwezesha kuinua ruhusa kwa sababu katika matukio kadhaa **taarifa nyeti zinahifadhiwa hapo**. Zaidi ya hayo, baadhi ya huduma za GCP huhifadhi taarifa zao kwenye buckets:

- **GCP Composer**: Unapotengeneza Composer Environment, **msimbo wa DAGs zote** utawekwa ndani ya **bucket**. Majukumu haya yanaweza kuwa na taarifa za kuvutia ndani ya msimbo wao.
- **GCR (Container Registry)**: **image** za containers huhifadhiwa ndani ya **buckets**, ambayo inamaanisha kwamba ukisoma buckets utaweza kupakua images na **kutafuta leaks na/au source code**.

### `storage.objects.setIamPolicy`

Hii inaweza kukuruhusu **kutumia vibaya mojawapo ya matukio yaliyotajwa hapo juu katika sehemu hii**.

### **`storage.buckets.setIamPolicy`**

Kwa mfano jinsi ya kubadilisha ruhusa kwa kutumia ruhusa hii angalia ukurasa huu:

{{#ref}}
../gcp-unauthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md
{{#endref}}

### `storage.hmacKeys.create`

Feature ya "interoperability" ya Cloud Storage, iliyobuniwa kwa ajili ya **maingiliano kati ya cloud (cross-cloud interactions)** kama ile na AWS S3, inahusisha **utengenezaji wa HMAC keys kwa Service Accounts na users**. Mshambuliaji anaweza kutumia hili kwa **kuzalisha HMAC key kwa Service Account yenye ruhusa zilizoimarishwa**, hivyo **kuinua ruhusa ndani ya Cloud Storage**. Wakati HMAC keys zinazohusishwa na users zinaweza kupatikana tu kupitia web console, zote access na secret keys zinabaki **kupatikana daima**, kuruhusu uhifadhi wa ziada kwa ajili ya ufikiaji. Kinyume chake, HMAC keys zinazounganishwa na Service Accounts zinaweza kupatikana kupitia API, lakini access na secret keys hazipatikani baada ya kuundwa, jambo ambalo linaongeza ugumu kwa upatikanaji wa muda mrefu.

<details><summary>Tengeneza na tumia HMAC key kwa ajili ya kuinua ruhusa</summary>
```bash
# Create key
gsutil hmac create <sa-email> # You might need to execute this inside a VM instance

## If you have TROUBLES creating the HMAC key this was you can also do it contacting the API directly:
PROJECT_ID = '$PROJECT_ID'
TARGET_SERVICE_ACCOUNT = f"exam-storage-sa-read-flag-3@{PROJECT_ID}.iam.gserviceaccount.com"
ACCESS_TOKEN = "$CLOUDSDK_AUTH_ACCESS_TOKEN"
import requests
import json
key = requests.post(
f'https://www.googleapis.com/storage/v1/projects/{PROJECT_ID}/hmacKeys',
params={'access_token': ACCESS_TOKEN, 'serviceAccountEmail': TARGET_SERVICE_ACCOUNT}
).json()
#print(json.dumps(key, indent=4))
print(f'ID: {key["metadata"]["accessId"]}')
print(f'Secret: {key["secret"]}')


# Configure gsutil to use the HMAC key
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
</details>

Script nyingine ya exploit kwa njia hii inaweza kupatikana [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

### `storage.objects.create`, `storage.objects.delete` = Idhini za Kuandika za Storage

Ili **kuunda object mpya** ndani ya bucket unahitaji `storage.objects.create` na, kwa mujibu wa [the docs](https://cloud.google.com/storage/docs/access-control/iam-permissions#object_permissions), unahitaji pia `storage.objects.delete` ili **modify** object iliyopo.

Mfano wa sana wa **common exploitation** wa buckets ambapo unaweza kuandika kwenye cloud ni pale ambapo **bucket inahifadhi faili za web server**; unaweza kuwa na uwezo wa **store new code** ambayo itatumika na web application.

### Composer

**Composer** ni **Apache Airflow** inayosimamiwa ndani ya GCP. Ina sifa kadhaa za kuvutia:

- Inaendesha ndani ya **GKE cluster**, hivyo **SA the cluster uses is accessible** na code inayotekelezwa ndani ya Composer.
- Sehemu zote za mazingira ya composer (**code of DAGs**, plugins na data) zimehifadhiwa ndani ya GCP bucket. Ikiwa attacker ana read na write permissions juu yake, anaweza monitor bucket na **whenever a DAG is created or updated, submit a backdoored version** ili environment ya composer ipoke toleo la backdoored kutoka kwenye storage.

Unaweza kupata PoC ya shambulio hili kwenye repo: [**https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs**](https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs)

### Cloud Functions

- Code za Cloud Functions zimehifadhiwa kwenye Storage na kila toleo jipya linapotengenezwa code inasukumwa kwenye bucket kisha container mpya inajengwa kutoka kwa code hiyo. Kwa hiyo, kwa **overwriting the code before the new version gets built it's possible to make the cloud function execute arbitrary code**.

Unaweza kupata PoC ya shambulio hili kwenye repo: [**https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions**](https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions)

### App Engine

Versions za AppEngine zinazalisha data ndani ya bucket yenye jina: `staging.<project-id>.appspot.com`. Ndani ya bucket hii, inawezekana kupata folda inayoitwa `ae` ambayo itakuwa na folda kwa kila toleo la AppEngine app na ndani ya folda hizi kutakuwa na faili `manifest.json`. Faili hii ina json yenye orodha ya faili zote ambazo zinapaswa kutumika kuunda toleo maalum. Zaidi ya hayo, inawezekana kupata **majina halisi ya faili, URL zao ndani ya GCP bucket (faili ndani ya bucket zimebadilishwa jina lao kwa sha1 hash) na sha1 hash ya kila faili.**

_Note kwamba haiwezekani kufanya pre-takeover ya bucket hii kwa sababu watumiaji wa GCP hawaruhusiwi kuunda buckets kutumia domain name appspot.com._

Hata hivyo, kwa read & write access juu ya bucket hii, inawezekana kufanya escalation ya idhini hadi kwa SA iliyounganishwa na version ya App Engine kwa monitoring bucket na kila wakati mabadiliko yanapofanyika (toleo jipya), kubadilisha toleo jipya haraka iwezekanavyo. Kwa njia hii, container inayojengwa kutoka kwa code hii itaendesha code ya backdoored.

Shambulio lililotajwa linaweza kufanywa kwa njia nyingi tofauti, zote zinaanza kwa ku-monitor `staging.<project-id>.appspot.com` bucket:

- Upload code kamili mpya ya toleo la AppEngine kwenye bucket tofauti na inayoonekana, na andaa **`manifest.json` file with the new bucket name and sha1 hashes of them**. Kisha, wakati toleo jipya linapotengenezwa ndani ya bucket, unahitaji tu kubadilisha faili ya `manifest.json` na upload toleo la malicious.
- Upload toleo lililobadilishwa la `requirements.txt` ambalo litatumia code ya **malicious dependencies** na update `manifest.json` file na jina jipya la faili, URL na hash yake.
- Upload **modified `main.py` or `app.yaml` file that will execute the malicious code** na update `manifest.json` file na jina jipya la faili, URL na hash yake.

Unaweza kupata PoC ya shambulio hili kwenye repo: [**https://github.com/carlospolop/Monitor-Backdoor-AppEngine**](https://github.com/carlospolop/Monitor-Backdoor-AppEngine)

### GCR

- **Google Container Registry** inahifadhi images ndani ya buckets; ikiwa unaweza **write those buckets** unaweza kuwa na uwezo wa **move laterally to where those buckets are being run.**
- Bucket inayotumika na GCR itakuwa na URL inayofanana na `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (The top level subdomains are specified [here](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

> [!TIP]
> Huduma hii imepitwa na wakati hivyo shambulio hili sio muhimu tena. Zaidi ya hayo, Artifact Registry, huduma inayobadilisha hii, haisihifadhi images kwenye buckets.

## **Marejeo**

- [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{{#include ../../../banners/hacktricks-training.md}}
