# GCP - Storage Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Storage

Basiese inligting:

{{#ref}}
../gcp-services/gcp-storage-enum.md
{{#endref}}

### `storage.objects.get`

Hierdie toestemming laat jou toe om **lêers wat in Cloud Storage gestoor is te aflaai**. Dit kan jou moontlik in staat stel om voorregte te verhoog omdat in sommige gevalle **sensitiewe inligting daar gestoor word**. Verder berg sommige GCP-dienste hul inligting in buckets:

- **GCP Composer**: Wanneer jy 'n Composer Environment skep sal die **code of all the DAGs** binne 'n **bucket** gestoor word. Hierdie take kan interessante inligting in hul kode bevat.
- **GCR (Container Registry)**: Die **image** van die containers word in **buckets** gestoor, wat beteken dat as jy die buckets kan lees jy die images kan aflaai en kan **search for leaks and/or source code**.

### `storage.objects.setIamPolicy`

Hierdie toestemming kan jou die vermoë gee om **enige van die voorafgaande scenario's in hierdie afdeling te misbruik**.

### **`storage.buckets.setIamPolicy`**

Vir 'n voorbeeld oor hoe om permissies te wysig met hierdie toestemming, kyk hierdie bladsy:

{{#ref}}
../gcp-unauthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md
{{#endref}}

### `storage.hmacKeys.create`

Cloud Storage se "interoperability" funksie, ontwerp vir **cross-cloud interactions** soos met AWS S3, behels die **creation of HMAC keys for Service Accounts and users**. 'n Aanvaller kan dit uitbuit deur **'n HMAC key te genereer vir 'n Service Account met elevated privileges**, en sodoende **escalating privileges within Cloud Storage**. Terwyl gebruiker-geassosieerde HMAC keys slegs via die web console teruggevind kan word, bly beide die access en secret keys **perpetually accessible**, wat potensiële rugsteun-toegangstoegang moontlik maak. Omgekeerd is Service Account-gekoppelde HMAC keys API-toeganklik, maar hul access en secret keys is nie na skepping herwinbaar nie, wat 'n laag van kompleksiteit vir voortdurende toegang toevoeg.

<details><summary>Skep en gebruik HMAC key vir privilege escalation</summary>
```bash
# Create key
gsutil hmac create <sa-email> # You might need to execute this inside a VM instance

## If you have TROUBLES creating the HMAC key this was you can also do it contacting the API directly:
PROJECT_ID = '$PROJECT_ID'
TARGET_SERVICE_ACCOUNT = f"exam-storage-sa-read-flag-3@{PROJECT_ID}.iam.gserviceaccount.com"
ACCESS_TOKEN = "$CLOUDSDK_AUTH_ACCESS_TOKEN"
import requests
import json
key = requests.post(
f'https://www.googleapis.com/storage/v1/projects/{PROJECT_ID}/hmacKeys',
params={'access_token': ACCESS_TOKEN, 'serviceAccountEmail': TARGET_SERVICE_ACCOUNT}
).json()
#print(json.dumps(key, indent=4))
print(f'ID: {key["metadata"]["accessId"]}')
print(f'Secret: {key["secret"]}')


# Configure gsutil to use the HMAC key
gcloud config set pass_credentials_to_gsutil false
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]

# Restore
gcloud config set pass_credentials_to_gsutil true
```
</details>

Nog 'n exploit-skrip vir hierdie metode kan gevind word [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

### `storage.objects.create`, `storage.objects.delete` = Storage-skryf toestemmings

Om 'n **nuwe object** binne 'n bucket te skep benodig jy `storage.objects.create` en, volgens [the docs](https://cloud.google.com/storage/docs/access-control/iam-permissions#object_permissions), benodig jy ook `storage.objects.delete` om 'n bestaande object te **wysig**.

'n Baie **common exploitation** van buckets waarin jy kan skryf in die cloud is wanneer die **bucket webbediener-lêers stoor**; jy kan dalk **nuwe kode stoor** wat deur die webtoepassing gebruik sal word.

### Composer

**Composer** is **Apache Airflow** wat binne GCP bestuur word. Dit het verskeie interessante kenmerke:

- Dit loop binne 'n **GKE cluster**, dus is die **SA wat die cluster gebruik toeganklik** deur die kode wat binne Composer loop.
- Al die komponente van 'n Composer-omgewing (**code of DAGs**, plugins en data) word gestoor binne 'n GCP-bucket. As die aanvaller lees- en skryftoestemmings oor dit het, kan hy die bucket monitor en **wanneer 'n DAG geskep of opgedateer word, 'n backdoored weergawe indien**, sodat die Composer-omgewing die backdoored weergawe uit die storage kry.

**Jy kan 'n PoC van hierdie aanval in die repo vind:** [**https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs**](https://github.com/carlospolop/Monitor-Backdoor-Composer-DAGs)

### Cloud Functions

- Cloud Functions-kode word in Storage gestoor en elke keer as 'n nuwe weergawe geskep word, word die kode na die bucket ge-pusht en daarna word die nuwe kontainer van hierdie kode gebou. Daarom, deur die kode oor te skryf voordat die nuwe weergawe gebou word, is dit moontlik om die cloud function arbitrêre kode te laat uitvoer.

**Jy kan 'n PoC van hierdie aanval in die repo vind:** [**https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions**](https://github.com/carlospolop/Monitor-Backdoor-Cloud-Functions)

### App Engine

AppEngine-weergawe genereer sekere data binne 'n bucket met die formaat naam: `staging.<project-id>.appspot.com`. Binne hierdie bucket is dit moontlik om 'n gids met die naam `ae` te vind wat 'n gids per weergawe van die AppEngine-app sal bevat, en binne daardie gidse sal jy die `manifest.json` lêer vind. Hierdie lêer bevat 'n json met al die lêers wat gebruik moet word om die spesifieke weergawe te skep. Boonop is dit moontlik om die **werklike name van die lêers, die URL na hulle binne die GCP-bucket (die lêers binne die bucket het hul naam verander na hul sha1-hash) en die sha1-hash van elke lêer** te vind.

_Note dat dit nie moontlik is om hierdie bucket vooraf te pre-takeover nie omdat GCP gebruikers nie gemagtig is om buckets te genereer met die domeinnaam appspot.com nie._

Met lees- en skryftoegang tot hierdie bucket is dit egter moontlik om privilegies te eskaleer na die SA wat aan die App Engine-weergawe gekoppel is deur die bucket te monitor en enige keer dat 'n verandering gemaak word (nuwe weergawe), die nuwe weergawe so vinnig moontlik te wysig. Op hierdie manier sal die kontainer wat van hierdie kode geskep word die backdoored kode uitvoer.

Die genoemde aanval kan op baie verskillende maniere uitgevoer word; almal begin deur die `staging.<project-id>.appspot.com` bucket te monitor:

- Laai die volledige nuwe kode van die AppEngine-weergawe op na 'n ander beskikbare bucket en berei 'n **`manifest.json`-lêer met die nuwe bucketnaam en sha1-hashe van die lêers** voor. Wanneer 'n nuwe weergawe dan binne die bucket geskep word, hoef jy net die `manifest.json` te wysig en die kwaadwillige een op te laai.
- Laai 'n gemodifiseerde `requirements.txt` op wat die **kwaadwillige afhanklikheidskode gebruik en die `manifest.json`** bywerk met die nuwe bestandsnaam, URL en die hash daarvan.
- Laai 'n **gemodifiseerde `main.py` of `app.yaml` lêer wat die kwaadwillige kode sal uitvoer** op en werk die `manifest.json` by met die nuwe bestandsnaam, URL en die hash daarvan.

**Jy kan 'n PoC van hierdie aanval in die repo vind:** [**https://github.com/carlospolop/Monitor-Backdoor-AppEngine**](https://github.com/carlospolop/Monitor-Backdoor-AppEngine)

### GCR

- **Google Container Registry** stoor die images binne buckets; as jy daardie buckets kan skryf mag jy moontlik **move laterally** na waar daardie buckets gedryf word.
- Die bucket wat deur GCR gebruik word sal 'n URL hê soortgelyk aan `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Die top-level subdomeine is gespesifiseer [here](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

> [!TIP]
> Hierdie diens is verouderd, dus is hierdie aanval nie meer nuttig nie. Boonop stoor Artifact Registry, die diens wat hierdie een vervang, nie die images in buckets nie.

## **Verwysings**

- [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{{#include ../../../banners/hacktricks-training.md}}
