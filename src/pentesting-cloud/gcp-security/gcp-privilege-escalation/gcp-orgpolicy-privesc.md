# GCP - Orgpolicy Privesc

{{#include ../../../banners/hacktricks-training.md}}

## orgpolicy

### `orgpolicy.policy.set`

Ένας attacker που εκμεταλλεύεται το **orgpolicy.policy.set** μπορεί να χειριστεί τις οργανωτικές πολιτικές, επιτρέποντάς του να αφαιρέσει ορισμένους περιορισμούς που εμποδίζουν συγκεκριμένες ενέργειες. Για παράδειγμα, ο περιορισμός **appengine.disableCodeDownload** συνήθως εμποδίζει τη λήψη του πηγαίου κώδικα του App Engine. Ωστόσο, χρησιμοποιώντας το **orgpolicy.policy.set**, ένας attacker μπορεί να απενεργοποιήσει αυτόν τον περιορισμό, αποκτώντας έτσι πρόσβαση για να κατεβάσει τον πηγαίο κώδικα, παρότι αρχικά ήταν προστατευμένος.
```bash
# Get info
gcloud resource-manager org-policies describe <org-policy> [--folder <id> | --organization <id> | --project <id>]

# Disable
gcloud resource-manager org-policies disable-enforce <org-policy> [--folder <id> | --organization <id> | --project <id>]
```
Ένα python script για αυτή τη μέθοδο μπορεί να βρεθεί [εδώ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/orgpolicy.policy.set.py).

### `orgpolicy.policy.set`, `iam.serviceAccounts.actAs`

Συνήθως δεν είναι δυνατό να επισυνάψετε ένα service account από διαφορετικό project σε ένα resource επειδή υπάρχει ένας περιορισμός πολιτικής που επιβάλλεται με όνομα **`iam.disableCrossProjectServiceAccountUsage`** ο οποίος αποτρέπει αυτή τη ενέργεια.

Μπορείτε να επαληθεύσετε αν αυτός ο περιορισμός εφαρμόζεται τρέχοντας την ακόλουθη εντολή:
```bash
gcloud resource-manager org-policies describe \
constraints/iam.disableCrossProjectServiceAccountUsage \
--project=<project-id> \
--effective

booleanPolicy:
enforced: true
constraint: constraints/iam.disableCrossProjectServiceAccountUsage
```
Αυτό αποτρέπει έναν επιτιθέμενο από το να καταχράται την άδεια **`iam.serviceAccounts.actAs`** για να προσποιηθεί έναν service account από άλλο project χωρίς τις επιπλέον απαιτούμενες infra άδειες για να ξεκινήσει, για παράδειγμα, ένα νέο VM, κάτι που θα μπορούσε να οδηγήσει σε escalation δικαιωμάτων.

Ωστόσο, ένας επιτιθέμενος με τα δικαιώματα **`orgpolicy.policy.set`** μπορεί να παρακάμψει αυτόν τον περιορισμό απενεργοποιώντας τον περιορισμό **`iam.disableServiceAccountProjectWideAccess`**. Αυτό επιτρέπει στον επιτιθέμενο να επισυνάψει έναν service account από άλλο project σε έναν πόρο στο δικό του project, αυξάνοντας ουσιαστικά τα προνόμια του.
```bash
gcloud resource-manager org-policies disable-enforce \
iam.disableCrossProjectServiceAccountUsage \
--project=<project-id>
```
## Αναφορές

- [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{{#include ../../../banners/hacktricks-training.md}}
