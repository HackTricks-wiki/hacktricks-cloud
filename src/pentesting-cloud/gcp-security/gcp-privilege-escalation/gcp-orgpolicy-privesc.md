# GCP - Orgpolicy Privesc

{{#include ../../../banners/hacktricks-training.md}}

## orgpolicy

### `orgpolicy.policy.set`

Ένας επιτιθέμενος που εκμεταλλεύεται την **orgpolicy.policy.set** μπορεί να χειριστεί τις πολιτικές του οργανισμού, κάτι που του επιτρέπει να αφαιρέσει ορισμένους περιορισμούς που παρεμποδίζουν συγκεκριμένες ενέργειες. Για παράδειγμα, ο περιορισμός **appengine.disableCodeDownload** συνήθως εμποδίζει τη λήψη του πηγαίου κώδικα του App Engine. Ωστόσο, χρησιμοποιώντας την **orgpolicy.policy.set**, ένας επιτιθέμενος μπορεί να απενεργοποιήσει αυτόν τον περιορισμό, αποκτώντας έτσι πρόσβαση για να κατεβάσει τον πηγαίο κώδικα, παρόλο που αρχικά ήταν προστατευμένος.

<details>
<summary>Λήψη πληροφοριών org policy και απενεργοποίηση της επιβολής</summary>
```bash
# Get info
gcloud resource-manager org-policies describe <org-policy> [--folder <id> | --organization <id> | --project <id>]

# Disable
gcloud resource-manager org-policies disable-enforce <org-policy> [--folder <id> | --organization <id> | --project <id>]
```
</details>

Ένα python script για αυτή τη μέθοδο μπορεί να βρεθεί [εδώ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/orgpolicy.policy.set.py).

### `orgpolicy.policy.set`, `iam.serviceAccounts.actAs`

Συνήθως δεν είναι δυνατή η προσάρτηση ενός service account από διαφορετικό project σε ένα resource, επειδή επιβάλλεται ένας policy constraint με την ονομασία **`iam.disableCrossProjectServiceAccountUsage`** που αποτρέπει αυτή την ενέργεια.

Μπορείτε να επαληθεύσετε αν αυτός ο policy constraint εφαρμόζεται εκτελώντας την ακόλουθη εντολή:

<details>
<summary>Επαλήθευση περιορισμού cross-project service account</summary>
```bash
gcloud resource-manager org-policies describe \
constraints/iam.disableCrossProjectServiceAccountUsage \
--project=<project-id> \
--effective

booleanPolicy:
enforced: true
constraint: constraints/iam.disableCrossProjectServiceAccountUsage
```
</details>

Αυτό αποτρέπει έναν επιτιθέμενο από το να καταχραστεί το permission **`iam.serviceAccounts.actAs`** για να πλαστοπροσωπήσει ένα service account από άλλο project χωρίς τις απαραίτητες επιπλέον infra δικαιοδοσίες για να ξεκινήσει, για παράδειγμα, ένα νέο VM, κάτι που θα μπορούσε να οδηγήσει σε privilege escalation.

Ωστόσο, ένας επιτιθέμενος με τα δικαιώματα **`orgpolicy.policy.set`** μπορεί να παρακάμψει αυτόν τον περιορισμό απενεργοποιώντας το constraint **`iam.disableServiceAccountProjectWideAccess`**. Αυτό επιτρέπει στον επιτιθέμενο να επισυνάψει ένα service account από άλλο project σε έναν πόρο στο δικό του project, ανεβάζοντας ουσιαστικά τα προνόμιά του.

<details>
<summary>Απενεργοποίηση του περιορισμού που αποτρέπει τη χρήση service account από άλλο project</summary>
```bash
gcloud resource-manager org-policies disable-enforce \
iam.disableCrossProjectServiceAccountUsage \
--project=<project-id>
```
</details>

## Αναφορές

- [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{{#include ../../../banners/hacktricks-training.md}}
