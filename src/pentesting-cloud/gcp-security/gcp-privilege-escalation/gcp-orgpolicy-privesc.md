# GCP - Orgpolicy Privesc

{{#include ../../../banners/hacktricks-training.md}}

## orgpolicy

### `orgpolicy.policy.set`

Um atacante que explora **orgpolicy.policy.set** pode manipular políticas organizacionais, permitindo-lhe remover certas restrições que impedem operações específicas. Por exemplo, a restrição **appengine.disableCodeDownload** normalmente bloqueia o download do código-fonte do App Engine. Contudo, ao usar **orgpolicy.policy.set**, o atacante pode desativar essa restrição, ganhando assim acesso para baixar o código-fonte, mesmo que inicialmente estivesse protegido.

<details>
<summary>Obter informações da org policy e desativar a aplicação</summary>
```bash
# Get info
gcloud resource-manager org-policies describe <org-policy> [--folder <id> | --organization <id> | --project <id>]

# Disable
gcloud resource-manager org-policies disable-enforce <org-policy> [--folder <id> | --organization <id> | --project <id>]
```
</details>

Um script python para este método pode ser encontrado [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/orgpolicy.policy.set.py).

### `orgpolicy.policy.set`, `iam.serviceAccounts.actAs`

Normalmente não é possível anexar uma service account de um projeto diferente a um recurso porque existe uma restrição de política aplicada chamada **`iam.disableCrossProjectServiceAccountUsage`** que impede essa ação.

É possível verificar se essa restrição está aplicada executando o comando a seguir:

<details>
<summary>Verificar restrição de service account entre projetos</summary>
```bash
gcloud resource-manager org-policies describe \
constraints/iam.disableCrossProjectServiceAccountUsage \
--project=<project-id> \
--effective

booleanPolicy:
enforced: true
constraint: constraints/iam.disableCrossProjectServiceAccountUsage
```
</details>

Isto impede que um atacante abuse da permissão **`iam.serviceAccounts.actAs`** para se passar por uma conta de serviço de outro projeto sem as permissões de infraestrutura adicionais necessárias para, por exemplo, iniciar uma nova VM, o que poderia levar a uma escalada de privilégios.

No entanto, um atacante com a permissão **`orgpolicy.policy.set`** pode contornar essa restrição desativando a constraint **`iam.disableServiceAccountProjectWideAccess`**. Isso permite ao atacante anexar uma conta de serviço de outro projeto a um recurso em seu próprio projeto, escalando efetivamente seus privilégios.

<details>
<summary>Desativar restrição de conta de serviço entre projetos</summary>
```bash
gcloud resource-manager org-policies disable-enforce \
iam.disableCrossProjectServiceAccountUsage \
--project=<project-id>
```
</details>

## Referências

- [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{{#include ../../../banners/hacktricks-training.md}}
