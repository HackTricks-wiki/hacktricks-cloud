# GCP - Orgpolicy Privesc

{{#include ../../../banners/hacktricks-training.md}}

## orgpolicy

### `orgpolicy.policy.set`

Atakujący wykorzystujący **orgpolicy.policy.set** może manipulować politykami organizacji, co pozwoli mu usunąć pewne ograniczenia utrudniające wykonywanie określonych operacji. Na przykład ograniczenie **appengine.disableCodeDownload** zwykle blokuje pobieranie kodu źródłowego App Engine. Jednak używając **orgpolicy.policy.set**, atakujący może dezaktywować to ograniczenie, uzyskując w ten sposób dostęp do pobrania kodu źródłowego, mimo że początkowo był on chroniony.

<details>
<summary>Pobierz informacje o org policy i wyłącz egzekwowanie</summary>
```bash
# Get info
gcloud resource-manager org-policies describe <org-policy> [--folder <id> | --organization <id> | --project <id>]

# Disable
gcloud resource-manager org-policies disable-enforce <org-policy> [--folder <id> | --organization <id> | --project <id>]
```
</details>

Skrypt python dla tej metody znajduje się [tutaj](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/orgpolicy.policy.set.py).

### `orgpolicy.policy.set`, `iam.serviceAccounts.actAs`

Zazwyczaj nie można przypisać service account z innego projektu do zasobu, ponieważ obowiązuje ograniczenie polityki o nazwie **`iam.disableCrossProjectServiceAccountUsage`**, które zapobiega tej akcji.

Można sprawdzić, czy to ograniczenie jest egzekwowane, wykonując następujące polecenie:

<details>
<summary>Weryfikacja ograniczenia użycia service account między projektami</summary>
```bash
gcloud resource-manager org-policies describe \
constraints/iam.disableCrossProjectServiceAccountUsage \
--project=<project-id> \
--effective

booleanPolicy:
enforced: true
constraint: constraints/iam.disableCrossProjectServiceAccountUsage
```
</details>

To uniemożliwia atakującemu nadużycie uprawnienia **`iam.serviceAccounts.actAs`** w celu podszycia się pod service account z innego projektu bez koniecznych dodatkowych uprawnień infra — np. do uruchomienia nowej VM — co mogłoby prowadzić do eskalacji uprawnień.

Jednak atakujący posiadający uprawnienia **`orgpolicy.policy.set`** może obejść to ograniczenie, wyłączając constraint **`iam.disableServiceAccountProjectWideAccess``**. Pozwala to atakującemu przypisać service account z innego projektu do zasobu w swoim własnym projekcie, skutecznie eskalując swoje uprawnienia.

<details>
<summary>Wyłącz ograniczenie przypisywania service account między projektami</summary>
```bash
gcloud resource-manager org-policies disable-enforce \
iam.disableCrossProjectServiceAccountUsage \
--project=<project-id>
```
</details>

## Źródła

- [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{{#include ../../../banners/hacktricks-training.md}}
