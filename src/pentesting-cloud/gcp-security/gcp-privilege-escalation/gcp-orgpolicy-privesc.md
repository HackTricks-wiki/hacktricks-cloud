# GCP - Orgpolicy Privesc

{{#include ../../../banners/hacktricks-training.md}}

## orgpolicy

### `orgpolicy.policy.set`

एक attacker जो **orgpolicy.policy.set** का उपयोग करता है, वह संगठनात्मक नीतियों को बदल सकता है, जिससे वह कुछ ऐसे प्रतिबंध हटा सकेगा जो विशिष्ट ऑपरेशनों को रोक रहे हैं। उदाहरण के लिए, कन्स्ट्रेंट **appengine.disableCodeDownload** आमतौर पर App Engine के स्रोत कोड को डाउनलोड करने से रोकता है। हालांकि, **orgpolicy.policy.set** का उपयोग करके attacker इस कन्स्ट्रेंट को निष्क्रिय कर सकता है, और परिणामस्वरूप प्रारम्भ में संरक्षित होने के बावजूद स्रोत कोड डाउनलोड करने की पहुँच प्राप्त कर सकता है।
```bash
# Get info
gcloud resource-manager org-policies describe <org-policy> [--folder <id> | --organization <id> | --project <id>]

# Disable
gcloud resource-manager org-policies disable-enforce <org-policy> [--folder <id> | --organization <id> | --project <id>]
```
A python स्क्रिप्ट इस विधि के लिए [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/orgpolicy.policy.set.py) पर मिल सकती है।

### `orgpolicy.policy.set`, `iam.serviceAccounts.actAs`

आम तौर पर किसी अलग project के service account को किसी resource से attach करना संभव नहीं होता क्योंकि एक policy constraint लागू रहती है जिसका नाम **`iam.disableCrossProjectServiceAccountUsage`** है जो इस क्रिया को रोकता है।

यह सत्यापित किया जा सकता है कि यह constraint लागू है या नहीं, निम्नलिखित command चलाकर:
```bash
gcloud resource-manager org-policies describe \
constraints/iam.disableCrossProjectServiceAccountUsage \
--project=<project-id> \
--effective

booleanPolicy:
enforced: true
constraint: constraints/iam.disableCrossProjectServiceAccountUsage
```
यह हमलावर को अनुमति **`iam.serviceAccounts.actAs`** का दुरुपयोग करके किसी दूसरे प्रोजेक्ट के service account का impersonate करने से रोकता है — उदाहरण के लिए बिना अतिरिक्त इंफ्रा अनुमतियों के नया VM शुरू करने जैसी क्रियाओं के लिए — जो privilege escalation का कारण बन सकता है।

हालाँकि, जिनके पास अनुमति **`orgpolicy.policy.set`** है वे इस प्रतिबंध को बायपास कर सकते हैं, constraint **`iam.disableServiceAccountProjectWideAccess`** को disable करके। इससे हमलावर अपने प्रोजेक्ट में किसी रिसोर्स के साथ दूसरे प्रोजेक्ट के service account को attach कर सकता है, effectively escalating his privileges.
```bash
gcloud resource-manager org-policies disable-enforce \
iam.disableCrossProjectServiceAccountUsage \
--project=<project-id>
```
## संदर्भ

- [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{{#include ../../../banners/hacktricks-training.md}}
