# GCP - Orgpolicy Privesc

{{#include ../../../banners/hacktricks-training.md}}

## orgpolicy

### `orgpolicy.policy.set`

Ein Angreifer, der **orgpolicy.policy.set** nutzt, kann Organisationsrichtlinien manipulieren, wodurch er bestimmte Einschränkungen aufheben kann, die bestimmte Aktionen verhindern. Zum Beispiel verhindert die Einschränkung **appengine.disableCodeDownload** üblicherweise das Herunterladen des App Engine-Quellcodes. Durch die Verwendung von **orgpolicy.policy.set** kann ein Angreifer diese Einschränkung jedoch deaktivieren und so Zugriff erhalten, um den Quellcode herunterzuladen, obwohl er ursprünglich geschützt war.
```bash
# Get info
gcloud resource-manager org-policies describe <org-policy> [--folder <id> | --organization <id> | --project <id>]

# Disable
gcloud resource-manager org-policies disable-enforce <org-policy> [--folder <id> | --organization <id> | --project <id>]
```
Ein Python-Skript für diese Methode befindet sich [hier](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/orgpolicy.policy.set.py).

### `orgpolicy.policy.set`, `iam.serviceAccounts.actAs`

Normalerweise ist es nicht möglich, ein Servicekonto aus einem anderen Projekt an eine Ressource anzuhängen, da eine Richtlinienbeschränkung mit dem Namen **`iam.disableCrossProjectServiceAccountUsage`** durchgesetzt wird, die diese Aktion verhindert.

Es ist möglich zu überprüfen, ob diese Beschränkung durchgesetzt wird, indem man den folgenden Befehl ausführt:
```bash
gcloud resource-manager org-policies describe \
constraints/iam.disableCrossProjectServiceAccountUsage \
--project=<project-id> \
--effective

booleanPolicy:
enforced: true
constraint: constraints/iam.disableCrossProjectServiceAccountUsage
```
Dies verhindert, dass ein Angreifer die Berechtigung **`iam.serviceAccounts.actAs`** missbraucht, um sich als Servicekonto aus einem anderen Projekt auszugeben, ohne die dafür sonst erforderlichen zusätzlichen Infrastruktur-Berechtigungen (z. B. zum Starten einer neuen VM) zu besitzen, was zu einer Privilegieneskalation führen könnte.

Allerdings kann ein Angreifer mit den Rechten **`orgpolicy.policy.set`** diese Einschränkung umgehen, indem er die Constraint **`iam.disableServiceAccountProjectWideAccess`** deaktiviert. Dadurch kann der Angreifer ein Servicekonto aus einem anderen Projekt an eine Ressource in seinem eigenen Projekt anhängen und so effektiv seine Privilegien eskalieren.
```bash
gcloud resource-manager org-policies disable-enforce \
iam.disableCrossProjectServiceAccountUsage \
--project=<project-id>
```
## Quellen

- [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{{#include ../../../banners/hacktricks-training.md}}
