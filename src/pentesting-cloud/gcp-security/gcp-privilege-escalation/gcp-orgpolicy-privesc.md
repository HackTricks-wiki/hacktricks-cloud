# GCP - Orgpolicy Privesc

{{#include ../../../banners/hacktricks-training.md}}

## orgpolicy

### `orgpolicy.policy.set`

Un atacante que aproveche **orgpolicy.policy.set** puede manipular las políticas organizacionales, lo que le permitirá eliminar ciertas restricciones que impiden operaciones específicas. Por ejemplo, la restricción **appengine.disableCodeDownload** normalmente bloquea la descarga del código fuente de App Engine. Sin embargo, usando **orgpolicy.policy.set**, un atacante puede desactivar esta restricción, obteniendo así acceso para descargar el código fuente, a pesar de que inicialmente estaba protegido.

<details>
<summary>Obtener información de org policy y desactivar la aplicación</summary>
```bash
# Get info
gcloud resource-manager org-policies describe <org-policy> [--folder <id> | --organization <id> | --project <id>]

# Disable
gcloud resource-manager org-policies disable-enforce <org-policy> [--folder <id> | --organization <id> | --project <id>]
```
</details>

Un script en python para este método se puede encontrar [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/orgpolicy.policy.set.py).

### `orgpolicy.policy.set`, `iam.serviceAccounts.actAs`

Generalmente no es posible adjuntar una cuenta de servicio de un proyecto distinto a un recurso porque existe una restricción de política aplicada llamada **`iam.disableCrossProjectServiceAccountUsage`** que impide esta acción.

Es posible verificar si esta restricción está aplicada ejecutando el siguiente comando:

<details>
<summary>Verificar restricción de uso de cuentas de servicio entre proyectos</summary>
```bash
gcloud resource-manager org-policies describe \
constraints/iam.disableCrossProjectServiceAccountUsage \
--project=<project-id> \
--effective

booleanPolicy:
enforced: true
constraint: constraints/iam.disableCrossProjectServiceAccountUsage
```
</details>

Esto evita que un atacante abuse del permiso **`iam.serviceAccounts.actAs`** para suplantar una cuenta de servicio de otro proyecto sin los permisos adicionales de infraestructura necesarios para, por ejemplo, iniciar una nueva VM, lo que podría conducir a una escalada de privilegios.

Sin embargo, un atacante con el permiso **`orgpolicy.policy.set`** puede eludir esta restricción deshabilitando la restricción **`iam.disableServiceAccountProjectWideAccess`**. Esto permite al atacante adjuntar una cuenta de servicio de otro proyecto a un recurso en su propio proyecto, escalando efectivamente sus privilegios.

<details>
<summary>Deshabilitar la restricción de cuentas de servicio entre proyectos</summary>
```bash
gcloud resource-manager org-policies disable-enforce \
iam.disableCrossProjectServiceAccountUsage \
--project=<project-id>
```
</details>

## Referencias

- [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

{{#include ../../../banners/hacktricks-training.md}}
