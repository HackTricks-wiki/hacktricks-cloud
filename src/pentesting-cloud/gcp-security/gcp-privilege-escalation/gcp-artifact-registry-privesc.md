# GCP - Artifact Registry Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Artifact Registry

Kwa maelezo zaidi kuhusu Artifact Registry angalia:

{{#ref}}
../gcp-services/gcp-artifact-registry-enum.md
{{#endref}}

### artifactregistry.repositories.uploadArtifacts

Kwa ruhusa hii mshambuliaji anaweza kupakia matoleo mapya ya artifacts yenye msimbo hatarishi kama Docker images:

<details>
<summary>Pakia Docker image kwenye Artifact Registry</summary>
```bash
# Configure docker to use gcloud to authenticate with Artifact Registry
gcloud auth configure-docker <location>-docker.pkg.dev

# tag the image to upload it
docker tag <local-img-name>:<local-tag> <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>

# Upload it
docker push <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
</details>

> [!CAUTION]
> Ilithibitishwa kuwa ni **inawezekana kupakia docker image mpya hasidi** yenye jina na tag sawa na ile iliyopo, hivyo ile ya zamani **itatoweka tag** na mara ijayo picha hiyo yenye tag hiyo itakapopakuliwa, **ile hasidi ndio itapakuliwa**.

<details>

<summary>Pakia maktaba ya Python</summary>

**Anza kwa kuunda maktaba utakayopakilia** (ikiwa unaweza kupakua toleo la hivi karibuni kutoka registry unaweza kuiepuka hatua hii):

1.  **Tayarisha muundo wa mradi wako**:

- Tengeneza directory mpya kwa maktaba yako, kwa mfano, `hello_world_library`.
- Ndani ya directory hii, tengeneza directory nyingine yenye jina la package yako, kwa mfano, `hello_world`.
- Ndani ya directory ya package yako, unda faili `__init__.py`. Faili hii inaweza kuwa tupu au iwe na uanzishaji wa package yako.

<details>
<summary>Create project structure</summary>

```bash
mkdir hello_world_library
cd hello_world_library
mkdir hello_world
touch hello_world/__init__.py
```

</details>

2.  **Andika msimbo wa maktaba yako**:

- Ndani ya directory `hello_world`, unda faili mpya ya Python kwa module yako, kwa mfano, `greet.py`.
- Andika function yako ya "Hello, World!":

<details>
<summary>Create library module</summary>

```python
# hello_world/greet.py
def say_hello():
return "Hello, World!"
```

</details>

3.  **Tengeneza faili `setup.py`**:

- Katika root ya directory yako `hello_world_library`, unda faili `setup.py`.
- Faili hili lina metadata kuhusu maktaba yako na linamwambia Python jinsi ya kuiweka.

<details>
<summary>Create setup.py file</summary>

```python
# setup.py
from setuptools import setup, find_packages

setup(
name='hello_world',
version='0.1',
packages=find_packages(),
install_requires=[
# Any dependencies your library needs
],
)
```

</details>

**Sasa, wacha tupakie maktaba:**

1.  **Jenga package yako**:

- Kutoka root ya directory yako `hello_world_library`, endesha:

<details>
<summary>Build Python package</summary>

```sh
python3 setup.py sdist bdist_wheel
```

</details>

2.  **Sanidi uthibitisho kwa twine** (inayotumika kupakia package yako):
- Hakikisha umeweka `twine` (`pip install twine`).
- Tumia `gcloud` kusanidi credentials:

<details>
<summary>Pakia package kwa twine</summary>
```sh
twine upload --username 'oauth2accesstoken' --password "$(gcloud auth print-access-token)" --repository-url https://<location>-python.pkg.dev/<project-id>/<repo-name>/ dist/*
```
</details>

3. **Safisha build**

<details>
<summary>Safisha mabaki ya build</summary>
```bash
rm -rf dist build hello_world.egg-info
```
</details>

</details>

> [!CAUTION]
> Haiwezekani kupakia maktaba ya python kwa toleo moja kama ile iliyopo, lakini inawezekana kupakia **matoleo makubwa zaidi** (au kuongeza **`.0` mwishoni** mwa toleo ikiwa inafanya kazi -si katika python ingawa-), au **kufuta toleo la mwisho na kupakia jipya** (inahitaji `artifactregistry.versions.delete`):
>
> <details>
> <summary>Delete artifact version</summary>
>
> ```sh
> gcloud artifacts versions delete <version> --repository=<repo-name> --location=<location> --package=<lib-name>
> ```
>
> </details>

### `artifactregistry.repositories.downloadArtifacts`

Kwa ruhusa hii unaweza **kupakua artifacts** na kutafuta **taarifa nyeti** na **udhaifu**.

Download a **Docker** image:

<details>
<summary>Pakua Docker image kutoka Artifact Registry</summary>
```sh
# Configure docker to use gcloud to authenticate with Artifact Registry
gcloud auth configure-docker <location>-docker.pkg.dev

# Dowload image
docker pull <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
</details>

Pakua maktaba ya **python**:

<details>
<summary>Pakua maktaba ya Python kutoka Artifact Registry</summary>
```bash
pip install <lib-name> --index-url "https://oauth2accesstoken:$(gcloud auth print-access-token)@<location>-python.pkg.dev/<project-id>/<repo-name>/simple/" --trusted-host <location>-python.pkg.dev --no-cache-dir
```
</details>

- Nini kinatokea ikiwa registri ya mbali na registri ya kawaida zimechanganywa katika registri virtual na kifurushi kiko katika zote mbili? Angalia ukurasa huu:

{{#ref}}
../gcp-persistence/gcp-artifact-registry-persistence.md
{{#endref}}

### `artifactregistry.tags.delete`, `artifactregistry.versions.delete`, `artifactregistry.packages.delete`, (`artifactregistry.repositories.get`, `artifactregistry.tags.get`, `artifactregistry.tags.list`)

Futa artifacts kutoka kwenye registry, kama Docker images:

<details>
<summary>Futa Docker image kutoka Artifact Registry</summary>
```bash
# Delete a docker image
gcloud artifacts docker images delete <location>-docker.pkg.dev/<proj-name>/<repo-name>/<img-name>:<tag>
```
</details>

### `artifactregistry.repositories.delete`

Futa repository kamili (hata ikiwa ina maudhui):

<details>
<summary>Futa repository ya Artifact Registry</summary>
```
gcloud artifacts repositories delete <repo-name> --location=<location>
```
</details>

### `artifactregistry.repositories.setIamPolicy`

Mshambuliaji mwenye ruhusa hii anaweza kujipa ruhusa za kutekeleza baadhi ya mashambulizi ya repository yaliyotajwa hapo awali.

### Pivoting kwa huduma nyingine kupitia Artifact Registry Read & Write

- **Cloud Functions**

Wakati Cloud Function inapoundwa image mpya ya docker inasukumwa kwenye Artifact Registry ya project. Nilijaribu kurekebisha image kwa ile mpya, na hata kufuta image ya sasa (na `cache` image) lakini hakuna kilichobadilika, Cloud Function ilibaki ikifanya kazi. Kwa hivyo, inaweza kuwa **might be possible to abuse a Race Condition attack** kama ilivyo kwa bucket kubadilisha docker container itakayotekelezwa lakini **just modifying the stored image isn't possible to compromise the Cloud Function**.

- **App Engine**

Licha App Engine kuunda docker images ndani ya Artifact Registry. Ilijaribiwa kwamba **hata ukiubahisha image ndani ya huduma hii** na ukifuta instance ya App Engine (hivyo nyingine mpya ita-deploy) **msimbo unaotekelezwa hautabadilika**.\
Inawezekana kwamba kwa kufanya **Race Condition attack** kama ilivyo kwa buckets inaweza kuwawezekana kuandika upya msimbo unaotekelezwa, lakini hili halikujaribiwa.

{{#include ../../../banners/hacktricks-training.md}}
