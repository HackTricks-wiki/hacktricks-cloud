# GCP - Network Docker Escape

{{#include ../../../banners/hacktricks-training.md}}

## Aanvanklike Toestand

In beide verslae waar hierdie tegniek gespesifiseer word, het die aanvallers daarin geslaag om **root** toegang binne 'n **Docker** houer wat deur GCP bestuur word, te verkry met toegang tot die gasheer netwerk (en die vermoëns **`CAP_NET_ADMIN`** en **`CAP_NET_RAW`**).

## Aanval Verklaring

Op 'n Google Compute Engine instansie, onthul gereelde inspeksie van netwerkverkeer talle **eenvoudige HTTP versoeke** na die **metadata instansie** by `169.254.169.254`. Die [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), 'n oopbron diens, maak gereeld sulke versoeke.

Hierdie agent is ontwerp om **veranderinge in die metadata te monitor**. Opmerklik is dat die metadata 'n **veld vir SSH publieke sleutels** insluit. Wanneer 'n nuwe publieke SSH sleutel by die metadata gevoeg word, **autorisere** die agent dit outomaties in die `.authorized_key` lêer. Dit kan ook 'n **nuwe gebruiker** skep en hulle indien nodig by **sudoers** voeg.

Die agent monitor veranderinge deur 'n versoek te stuur om **alle metadata waardes rekursief te verkry** (`GET /computeMetadata/v1/?recursive=true`). Hierdie versoek is ontwerp om die metadata bediener te laat reageer slegs as daar enige verandering in die metadata was sedert die laaste verkryging, geïdentifiseer deur 'n Etag (`wait_for_change=true&last_etag=`). Daarbenewens is 'n **timeout** parameter (`timeout_sec=`) ingesluit. As daar geen verandering binne die gespesifiseerde timeout plaasvind nie, reageer die bediener met die **onveranderde waardes**.

Hierdie proses laat die **IMDS** (Instance Metadata Service) toe om na **60 sekondes** te reageer as daar geen konfigurasieverandering plaasgevind het nie, wat 'n potensiële **venster vir die inspuiting van 'n valse konfigurasie antwoord** aan die gasagent skep.

'n Aanvaller kan dit benut deur 'n **Man-in-the-Middle (MitM) aanval** uit te voer, die antwoord van die IMDS bediener te spoof en **'n nuwe publieke sleutel in te voeg**. Dit kan ongeoorloofde SSH toegang tot die gasheer moontlik maak.

### Ontsnapping Tegniek

Terwyl ARP spoofing ondoeltreffend is op Google Compute Engine netwerke, kan 'n [**gewysigde weergawe van rshijack**](https://github.com/ezequielpereira/rshijack) wat deur [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) ontwikkel is, gebruik word vir pakketinspuiting in die kommunikasie om die SSH gebruiker in te spuit.

Hierdie weergawe van rshijack laat die invoer van die ACK en SEQ nommers as opdraglyn argumente toe, wat die spoofing van 'n antwoord voor die werklike Metadata bediener antwoord vergemaklik. Daarbenewens word 'n [**klein Shell skrip**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) gebruik om 'n **spesiaal saamgestelde payload** terug te gee. Hierdie payload laat die Google Guest Agent toe om **'n gebruiker `wouter`** te **skep** met 'n gespesifiseerde publieke sleutel in die `.authorized_keys` lêer.

Die skrip gebruik dieselfde ETag om te voorkom dat die Metadata bediener die Google Guest Agent onmiddellik van verskillende metadata waardes in kennis stel, wat die antwoord vertraag.

Om die spoofing uit te voer, is die volgende stappe nodig:

1. **Monitor versoeke na die Metadata bediener** met **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Soek vir 'n lyn soortgelyk aan:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Stuur die vals metadata data met die korrekte ETAG na rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Hierdie stap magtig die publieke sleutel, wat SSH-verbinding met die ooreenstemmende private sleutel moontlik maak.

## References

- [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
- [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{{#include ../../../banners/hacktricks-training.md}}
