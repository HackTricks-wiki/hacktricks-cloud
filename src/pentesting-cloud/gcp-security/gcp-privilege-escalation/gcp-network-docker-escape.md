# GCP - Network Docker Escape

{{#include ../../../banners/hacktricks-training.md}}

## 初期状態

この技術が指定されている2つの報告書では、攻撃者はGCPによって管理されている**Docker**コンテナ内で**root**アクセスを取得し、ホストネットワークへのアクセス（および**`CAP_NET_ADMIN`**と**`CAP_NET_RAW`**の権限）を持っていました。

## 攻撃の説明

Google Compute Engineインスタンスでは、ネットワークトラフィックの定期的な検査により、**メタデータインスタンス**への多数の**プレーンHTTPリクエスト**が明らかになります。オープンソースサービスである[**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent)は、頻繁にこのようなリクエストを行います。

このエージェントは**メタデータの変更を監視する**ように設計されています。特に、メタデータには**SSH公開鍵用のフィールド**が含まれています。新しい公開SSH鍵がメタデータに追加されると、エージェントは自動的にそれを`.authorized_key`ファイルに**認証**します。また、必要に応じて**新しいユーザーを作成**し、**sudoers**に追加することもあります。

エージェントは、**すべてのメタデータ値を再帰的に取得する**リクエストを送信することで変更を監視します（`GET /computeMetadata/v1/?recursive=true`）。このリクエストは、前回の取得以降にメタデータに変更があった場合のみ、メタデータサーバーが応答を送信するように設計されています。これはEtag（`wait_for_change=true&last_etag=`）によって識別されます。さらに、**タイムアウト**パラメータ（`timeout_sec=`）も含まれています。指定されたタイムアウト内に変更が発生しない場合、サーバーは**変更されていない値**で応答します。

このプロセスにより、**IMDS**（インスタンスメタデータサービス）は、構成変更が発生しなかった場合に**60秒後**に応答することができ、ゲストエージェントに対して**偽の構成応答を注入するための潜在的なウィンドウ**を作成します。

攻撃者は、**Man-in-the-Middle (MitM)攻撃**を実行し、IMDSサーバーからの応答を偽装して**新しい公開鍵を挿入する**ことでこれを悪用できる可能性があります。これにより、ホストへの不正なSSHアクセスが可能になります。

### エスケープ技術

ARPスプーフィングはGoogle Compute Engineネットワークでは効果がありませんが、[**rshijackの修正版**](https://github.com/ezequielpereira/rshijack)が[**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)によって開発され、SSHユーザーを注入するためのパケット注入に使用できます。

このrshijackのバージョンは、ACKおよびSEQ番号をコマンドライン引数として入力できるため、実際のメタデータサーバーの応答の前に応答を偽装することが容易になります。さらに、[**小さなシェルスクリプト**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh)が使用され、**特別に作成されたペイロード**を返します。このペイロードは、Google Guest Agentに対して、`.authorized_keys`ファイルに指定された公開鍵を持つユーザー`wouter`を**作成する**ようにトリガーします。

スクリプトは同じETagを使用して、メタデータサーバーが異なるメタデータ値をGoogle Guest Agentに即座に通知しないようにし、応答を遅延させます。

スプーフィングを実行するには、次の手順が必要です。

1. **tcpdump**を使用してメタデータサーバーへのリクエストを**監視**します：
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
翻訳する内容が見つかりませんでした。具体的なテキストを提供してください。
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. 正しいETAGを持つ偽のメタデータをrshijackに送信します:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
このステップは公開鍵を認証し、対応する秘密鍵を使用してSSH接続を可能にします。

## 参考文献

- [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
- [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{{#include ../../../banners/hacktricks-training.md}}
