# GCP - Network Docker Escape

{{#include ../../../banners/hacktricks-training.md}}

## Hali ya Awali

Katika writeup zote mbili ambapo mbinu hii ilielezewa, washambuliaji waliweza kupata ufikiaji wa **root** ndani ya kontena ya **Docker** inayosimamiwa na GCP yenye ufikiaji wa mtandao wa mwenyeji (na uwezo **`CAP_NET_ADMIN`** na **`CAP_NET_RAW`**).

## Maelezo ya Shambulio

Kwenye instance ya Google Compute Engine, ukaguzi wa kawaida wa trafiki ya mtandao unaonyesha maombi mengi ya **plain HTTP requests** kwa **metadata instance** kwa `169.254.169.254`. [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), huduma ya open-source, mara nyingi hufanya maombi haya.

Agent huyu ameundwa ili **kufuatilia mabadiliko kwenye metadata**. Kwa kuzingatia, metadata inajumuisha **field for SSH public keys**. Wakati ufunguo mpya wa umma wa SSH unaongezwa kwenye metadata, agent huiaidhinisha moja kwa moja katika faili `.authorized_key`. Inaweza pia **kuunda user mpya** na kuwaunda kuwa sehemu ya **sudoers** ikiwa inahitajika.

Agent hufuatilia mabadiliko kwa kutuma ombi la **kuchukua thamani zote za metadata kwa mfululizo** (`GET /computeMetadata/v1/?recursive=true`). Ombi hili limetengenezwa ili kusukuma metadata server itume jibu tu ikiwa kumekuwa na mabadiliko yoyote tangu ulipokagua mara ya mwisho, kitambulisho ni Etag (`wait_for_change=true&last_etag=`). Zaidi ya hayo, kigezo cha **timeout** (`timeout_sec=`) kimejumuishwa. Ikiwa hakuna mabadiliko yanayotokea ndani ya timeout iliyobainishwa, server itajibu kwa **thamani zisizobadilika**.

Mchakato huu unaruhusu **IMDS** (Instance Metadata Service) kujibu baada ya **60 seconds** ikiwa hakuna mabadiliko ya usanidi, na kuunda dirisha la nafasi la **kuingiza fake configuration response** kwa guest agent.

Mshambuliaji anaweza kutumia fursa hii kwa kufanya **Man-in-the-Middle (MitM) attack**, kupotosha jibu kutoka kwa IMDS server na **kuingiza a new public key**. Hii inaweza kuruhusu upatikanaji wa SSH usioidhinishwa kwenye mwenyeji.

### Mbinu ya Kutoroka

Ingawa ARP spoofing haifanyi kazi kwa ufanisi kwenye mitandao ya Google Compute Engine, [**modified version of rshijack**](https://github.com/ezequielpereira/rshijack) iliyotengenezwa na [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) inaweza kutumika kwa packet injection katika mawasiliano ili kuingiza mtumiaji wa SSH.

Toleo hili la rshijack huruhusu kuingiza nambari za ACK na SEQ kama vigezo vya command-line, kurahisisha kupotosha jibu kabla ya jibu halisi kutoka kwa Metadata server. Zaidi ya hayo, [**small Shell script**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) inatumika kurudisha **specially crafted payload**. Payload hii inasababisha Google Guest Agent **kuunda user `wouter`** akiwa na ufunguo wa umma uliotajwa kwenye faili `.authorized_keys`.

Skripti hutumia ETag ile ile ili kuzuia Metadata server itangaze mara moja kwa Google Guest Agent kuhusu thamani tofauti za metadata, na hivyo kuchelewesha jibu.

Ili kutekeleza spoofing, hatua zifuatazo zinahitajika:

1. **Fuata maombi kwa Metadata server** ukitumia **tcpdump**:

<details>
<summary>Monitor metadata server requests with tcpdump</summary>
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
</details>

Tafuta mstari linalofanana na:

<details>
<summary>Mfano wa mstari wa matokeo ya tcpdump</summary>
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
</details>

2. Tuma data ya metadata bandia ikiwa na ETAG sahihi kwa rshijack:

<details>
<summary>Tuma metadata bandia na ingia kwa SSH kwenye mwenyeji</summary>
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
</details>

Hatua hii inaidhinisha funguo za umma, ikiruhusu muunganisho wa SSH kwa kutumia funguo binafsi zinazolingana.

## Marejeo

- [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
- [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{{#include ../../../banners/hacktricks-training.md}}
