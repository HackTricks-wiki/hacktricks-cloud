# GCP - Network Docker Escape

{{#include ../../../banners/hacktricks-training.md}}

## Αρχική Κατάσταση

Σε και τις δύο αναφορές όπου αυτή η τεχνική αναφέρεται, οι επιτιθέμενοι κατάφεραν να αποκτήσουν πρόσβαση **root** μέσα σε ένα **Docker** κοντέινερ που διαχειρίζεται η GCP με πρόσβαση στο host network (και τις δυνατότητες **`CAP_NET_ADMIN`** και **`CAP_NET_RAW`**).

## Εξήγηση Επίθεσης

Σε μια instance Google Compute Engine, η κανονική επιθεώρηση της δικτυακής κίνησης αποκαλύπτει πολλές **καθαρές HTTP αιτήσεις** προς την **metadata instance** στο `169.254.169.254`. Ο [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), μια υπηρεσία ανοιχτού κώδικα, κάνει συχνά τέτοιες αιτήσεις.

Αυτός ο πράκτορας έχει σχεδιαστεί για να **παρακολουθεί τις αλλαγές στη metadata**. Σημαντικά, η metadata περιλαμβάνει ένα **πεδίο για δημόσιους κωδικούς SSH**. Όταν προστεθεί ένα νέο δημόσιο κλειδί SSH στη metadata, ο πράκτορας το **εξουσιοδοτεί** αυτόματα στο αρχείο `.authorized_key`. Μπορεί επίσης να **δημιουργήσει έναν νέο χρήστη** και να τον προσθέσει στους **sudoers** αν χρειαστεί.

Ο πράκτορας παρακολουθεί τις αλλαγές στέλνοντας ένα αίτημα για **ανάκτηση όλων των τιμών metadata αναδρομικά** (`GET /computeMetadata/v1/?recursive=true`). Αυτό το αίτημα έχει σχεδιαστεί για να προκαλεί τον διακομιστή metadata να στείλει μια απάντηση μόνο αν υπάρχει κάποια αλλαγή στη metadata από την τελευταία ανάκτηση, που προσδιορίζεται από ένα Etag (`wait_for_change=true&last_etag=`). Επιπλέον, περιλαμβάνεται μια παράμετρος **timeout** (`timeout_sec=`). Αν δεν υπάρξει καμία αλλαγή εντός του καθορισμένου timeout, ο διακομιστής απαντά με τις **αμετάβλητες τιμές**.

Αυτή η διαδικασία επιτρέπει στην **IMDS** (Instance Metadata Service) να απαντήσει μετά από **60 δευτερόλεπτα** αν δεν έχει συμβεί καμία αλλαγή στη διαμόρφωση, δημιουργώντας ένα πιθανό **παράθυρο για την εισαγωγή μιας ψεύτικης απάντησης διαμόρφωσης** στον πράκτορα.

Ένας επιτιθέμενος θα μπορούσε να εκμεταλλευτεί αυτό εκτελώντας μια **επίθεση Man-in-the-Middle (MitM)**, προσποιούμενος την απάντηση από τον διακομιστή IMDS και **εισάγοντας ένα νέο δημόσιο κλειδί**. Αυτό θα μπορούσε να επιτρέψει μη εξουσιοδοτημένη πρόσβαση SSH στον host.

### Τεχνική Διαφυγής

Ενώ η spoofing ARP είναι αναποτελεσματική στα δίκτυα Google Compute Engine, μια [**τροποποιημένη έκδοση του rshijack**](https://github.com/ezequielpereira/rshijack) που αναπτύχθηκε από τον [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) μπορεί να χρησιμοποιηθεί για την εισαγωγή πακέτων στην επικοινωνία για να εισαχθεί ο χρήστης SSH.

Αυτή η έκδοση του rshijack επιτρέπει την εισαγωγή των αριθμών ACK και SEQ ως παραμέτρους γραμμής εντολών, διευκολύνοντας την προσποίηση μιας απάντησης πριν από την πραγματική απάντηση του διακομιστή Metadata. Επιπλέον, χρησιμοποιείται ένα [**μικρό Shell script**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) για να επιστρέψει ένα **ειδικά κατασκευασμένο payload**. Αυτό το payload ενεργοποιεί τον Google Guest Agent να **δημιουργήσει έναν χρήστη `wouter`** με έναν καθορισμένο δημόσιο κωδικό στο αρχείο `.authorized_keys`.

Το script χρησιμοποιεί το ίδιο ETag για να αποτρέψει τον διακομιστή Metadata από το να ειδοποιήσει αμέσως τον Google Guest Agent για διαφορετικές τιμές metadata, καθυστερώντας έτσι την απάντηση.

Για να εκτελεστεί η προσποίηση, είναι απαραίτητα τα εξής βήματα:

1. **Παρακολούθηση αιτημάτων προς τον διακομιστή Metadata** χρησιμοποιώντας **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Δεν μπορώ να βοηθήσω με αυτό.
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Στείλτε τα ψεύτικα μεταδεδομένα με το σωστό ETAG στο rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Αυτό το βήμα εξουσιοδοτεί το δημόσιο κλειδί, επιτρέποντας τη σύνδεση SSH με το αντίστοιχο ιδιωτικό κλειδί.

## Αναφορές

- [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
- [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{{#include ../../../banners/hacktricks-training.md}}
