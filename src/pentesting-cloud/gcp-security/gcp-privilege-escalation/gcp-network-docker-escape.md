# GCP - Network Docker Escape

{{#include ../../../banners/hacktricks-training.md}}

## Початковий стан

У двох розповідях, де описується ця техніка, атакуючим вдалося отримати **root** доступ всередині **Docker** контейнера, керованого GCP, з доступом до мережі хоста (та з можливостями **`CAP_NET_ADMIN`** і **`CAP_NET_RAW`**).

## Пояснення атаки

На екземплярі Google Compute Engine регулярний моніторинг мережевого трафіку виявляє численні **plain HTTP requests** до **metadata instance** за адресою `169.254.169.254`. [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), open-source сервіс, часто робить такі запити.

Цей агент призначений для **моніторингу змін у metadata**. Зокрема, metadata містить **поле для SSH public keys**. Коли до metadata додається новий публічний SSH ключ, агент автоматично **авторизує** його в файлі `.authorized_key`. Він також може **створити нового користувача** і додати його до **sudoers**, якщо це потрібно.

Агент відстежує зміни, відправляючи запит на **отримання всіх значень metadata рекурсивно** (`GET /computeMetadata/v1/?recursive=true`). Цей запит призначений змусити metadata server надіслати відповідь лише якщо були якісь зміни в metadata з моменту останнього опитування, ідентифіковані Etag (`wait_for_change=true&last_etag=`). Додатково включений параметр **timeout** (`timeout_sec=`). Якщо протягом вказаного таймауту змін не відбулося, сервер повертає **незмінені значення**.

Цей процес дозволяє **IMDS** (Instance Metadata Service) відповісти через **60 секунд**, якщо конфігурація не змінилася, створюючи потенційне **вікно для ін’єкції підробленої конфігураційної відповіді** до guest agent.

Атакуючий може скористатися цим, здійснивши **Man-in-the-Middle (MitM) attack**, підробити відповідь від IMDS і **вставити новий публічний ключ**. Це може дозволити несанкціонований SSH доступ до хоста.

### Техніка втечі

Хоча ARP spoofing неефективний у мережах Google Compute Engine, [**modified version of rshijack**](https://github.com/ezequielpereira/rshijack), розроблена [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html), може використовуватися для ін’єкції пакетів у комунікацію з метою ін’єкції SSH-користувача.

Ця версія rshijack дозволяє передавати ACK і SEQ номери як аргументи командного рядка, що полегшує підробку відповіді перед реальною відповіддю Metadata server. Додатково використовується [**невеликий Shell script**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh), щоб повернути **спеціально створений payload**. Цей payload змушує Google Guest Agent **створити користувача `wouter`** з вказаним публічним ключем у файлі `.authorized_keys`.

Скрипт використовує той самий ETag, щоб запобігти негайному сповіщенню Google Guest Agent про відмінні значення metadata з боку Metadata server, таким чином затримуючи відповідь.

Щоб виконати підробку, необхідні наступні кроки:

1. **Моніторинг запитів до Metadata server** за допомогою **tcpdump**:

<details>
<summary>Monitor metadata server requests with tcpdump</summary>
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
</details>

Знайдіть рядок, схожий на:

<details>
<summary>Приклад рядка виводу tcpdump</summary>
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
</details>

2. Надішліть підроблені metadata з правильним ETAG до rshijack:

<details>
<summary>Надішліть підроблені metadata і підключіться по SSH до хоста</summary>
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
</details>

Цей крок авторизує публічний ключ, що дає змогу підключитися по SSH з використанням відповідного приватного ключа.

## Посилання

- [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
- [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

{{#include ../../../banners/hacktricks-training.md}}
