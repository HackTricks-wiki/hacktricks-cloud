# GCP - Privilege Escalation

{{#include ../../../banners/hacktricks-training.md}}

## Introduction to GCP Privilege Escalation <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP，和其他云一样，有一些**原则**：用户、组和服务账户，以及一些**资源**，如计算引擎、云函数……\
然后，通过角色，**权限被授予这些原则对资源的访问**。这就是在GCP中指定一个原则对资源拥有的权限的方式。\
有某些权限将允许用户**获得更多权限**，无论是在资源上还是第三方资源上，这就是所谓的**权限提升**（此外，利用漏洞获取更多权限）。

因此，我想将GCP权限提升技术分为**两组**：

- **对一个原则的权限提升**：这将允许你**冒充另一个原则**，因此以其所有权限的身份行事。例如：滥用_getAccessToken_来冒充一个服务账户。
- **对资源的权限提升**：这将允许你**在特定资源上获得更多权限**。例如：你可以滥用_setIamPolicy_权限来允许你触发云函数。
- 请注意，一些**资源权限还将允许你将任意服务账户附加到资源上**。这意味着你将能够启动一个带有SA的资源，进入该资源，并**窃取SA令牌**。因此，这将允许通过资源提升来提升到一个原则。这在之前的多个资源中发生过，但现在不太频繁（但仍然可能发生）。

显然，最有趣的权限提升技术是**第二组**的，因为它将允许你**在你已经拥有某些权限的资源之外获得更多权限**。然而，请注意，**在资源中提升**也可能使你访问到**敏感信息**，甚至**其他原则**（可能通过读取包含SA令牌的秘密）。

> [!WARNING]
> 还需要注意的是，在**GCP中，服务账户既是原则也是权限**，因此在SA中提升权限也将允许你冒充它。

> [!NOTE]
> 括号中的权限表示利用漏洞所需的权限，使用`gcloud`。如果通过API利用，则可能不需要这些权限。

## Permissions for Privilege Escalation Methodology

这是我**测试特定权限**以在GCP内部执行特定操作的方法。

1. 下载github repo [https://github.com/carlospolop/gcp_privesc_scripts](https://github.com/carlospolop/gcp_privesc_scripts)
2. 在tests/中添加新的脚本

## Bypassing access scopes <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

从GCP元数据服务泄露的SA令牌具有**访问范围**。这些是对令牌拥有的**权限**的**限制**。例如，如果令牌具有**`https://www.googleapis.com/auth/cloud-platform`**范围，它将对所有GCP服务具有**完全访问权限**。然而，如果令牌具有**`https://www.googleapis.com/auth/cloud-platform.read-only`**范围，即使SA在IAM中具有更多权限，它也只会对所有GCP服务具有**只读访问权限**。

没有直接的方法来绕过这些权限，但你可以尝试在被攻陷的主机中搜索**新凭据**，**找到服务密钥**以生成没有限制的OAuth令牌，或**跳转到一个限制较少的不同VM**。

当使用[访问范围](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam)时，为计算实例（VM）生成的OAuth令牌将**包含**[**范围**](https://oauth.net/2/scope/)**限制**。然而，你可能能够**绕过**此限制并利用被攻陷账户的权限。

**绕过**此限制的**最佳方法**是要么在被攻陷的主机中**找到新凭据**，要么**找到服务密钥以生成没有限制的OAuth令牌**，或者**攻陷一个限制较少的不同VM**。

检查使用生成的密钥的SA：
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## 权限提升技术

在 AWS 中提升权限的方法是拥有足够的权限，以便以某种方式访问其他服务帐户/用户/组的权限。通过链式提升，直到您获得对组织的管理员访问权限。

> [!WARNING]
> GCP 有 **数百**（如果不是数千）个 **权限** 可以授予实体。在本书中，您可以找到 **我知道的所有权限**，您可以利用这些权限来 **提升权限**，但如果您 **知道一些未提及的路径**， **请分享**。

**本节的子页面按服务排序。您可以在每个服务中找到不同的权限提升方法。**

### 利用 GCP 在本地提升权限

如果您在 GCP 的一台机器内部，您可能能够利用权限在本地提升权限：

{{#ref}}
gcp-local-privilege-escalation-ssh-pivoting.md
{{#endref}}

## 参考

- [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
- [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{{#include ../../../banners/hacktricks-training.md}}
