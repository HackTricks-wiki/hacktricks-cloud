# GCP - Persistência do Registro de Artefatos

{{#include ../../../banners/hacktricks-training.md}}

## Registro de Artefatos

Para mais informações sobre o Registro de Artefatos, consulte:

{{#ref}}
../gcp-services/gcp-artifact-registry-enum.md
{{#endref}}

### Confusão de Dependência

- O que acontece se um **repositório remoto e um padrão** **forem misturados em um virtual** e um pacote existir em ambos?
- O que tem a **maior prioridade definida no repositório virtual** é usado
- Se a **prioridade for a mesma**:
- Se a **versão** for a **mesma**, o **nome da política em ordem alfabética** primeiro no repositório virtual é usado
- Se não, a **maior versão** é usada

> [!CAUTION]
> Portanto, é possível **abusar de uma maior versão (confusão de dependência)** em um registro de pacotes público se o repositório remoto tiver uma prioridade maior ou igual

Esta técnica pode ser útil para **persistência** e **acesso não autenticado**, pois para abusar dela, basta **saber o nome de uma biblioteca** armazenada no Registro de Artefatos e **criar essa mesma biblioteca no repositório público (PyPi para python, por exemplo)** com uma versão maior.

Para persistência, estes são os passos que você precisa seguir:

- **Requisitos**: Um **repositório virtual** deve **existir** e ser usado, um **pacote interno** com um **nome** que não exista no **repositório público** deve ser usado.
- Crie um repositório remoto se ele não existir
- Adicione o repositório remoto ao repositório virtual
- Edite as políticas do registro virtual para dar uma prioridade maior (ou igual) ao repositório remoto.\
Execute algo como:
- [gcloud artifacts repositories update --upstream-policy-file ...](https://cloud.google.com/sdk/gcloud/reference/artifacts/repositories/update#--upstream-policy-file)
- Baixe o pacote legítimo, adicione seu código malicioso e registre-o no repositório público com a mesma versão. Toda vez que um desenvolvedor o instalar, ele instalará o seu!

Para mais informações sobre confusão de dependência, consulte:

{{#ref}}
https://book.hacktricks.xyz/pentesting-web/dependency-confusion
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
