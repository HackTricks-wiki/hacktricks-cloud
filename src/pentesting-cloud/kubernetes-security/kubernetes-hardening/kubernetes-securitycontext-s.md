# Kubernetes SecurityContext(s)

{{#include ../../../banners/hacktricks-training.md}}

## PodSecurityContext <a href="#podsecuritycontext-v1-core" id="podsecuritycontext-v1-core"></a>

[**Da documentação:**](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)

Ao especificar o contexto de segurança de um Pod, você pode usar vários atributos. Do ponto de vista da segurança defensiva, você deve considerar:

- Ter **runASNonRoot** como **True**
- Configurar **runAsUser**
- Se possível, considere **limitar** **permissões** indicando **seLinuxOptions** e **seccompProfile**
- **NÃO** conceda acesso ao **grupo** de **privilegio** via **runAsGroup** e **supplementaryGroups**

| Parâmetro                                                                                                                                                                                                                                                                                                                                                                                                                                  | Descrição                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroup</strong></a><br><em>inteiro</em></p>                                                                                                                                                                                                                                                 | <p>Um grupo suplementar especial que se aplica a <strong>todos os contêineres em um pod</strong>. Alguns tipos de volume permitem que o Kubelet <strong>mude a propriedade desse volume</strong> para ser de propriedade do pod:<br>1. O GID proprietário será o FSGroup<br>2. O bit setgid é definido (novos arquivos criados no volume serão de propriedade do FSGroup)<br>3. Os bits de permissão são OR'd com rw-rw---- Se não definido, o Kubelet não modificará a propriedade e permissões de nenhum volume</p> |

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroupChangePolicy</strong></a><br><em>string</em></p>                                                                                                                                                                                                                                      | Isso define o comportamento de **mudança de propriedade e permissão do volume** antes de ser exposto dentro do Pod.                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsGroup</strong></a><br><em>inteiro</em></p>                                                                                                                                                                                                                                              | O **GID para executar o ponto de entrada do processo do contêiner**. Usa o padrão de tempo de execução se não definido. Pode também ser definido em SecurityContext.                                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>booleano</em></p>                                                                                                                                                                                                                                            | Indica que o contêiner deve ser executado como um usuário não-root. Se verdadeiro, o Kubelet validará a imagem em tempo de execução para garantir que não seja executada como UID 0 (root) e falhará ao iniciar o contêiner se o fizer.                                                                                                                                                                                                                                                                          |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsUser</strong></a><br><em>inteiro</em></p>                                                                                                                                                                                                                                               | O **UID para executar o ponto de entrada do processo do contêiner**. Padrão para o usuário especificado nos metadados da imagem se não especificado.                                                                                                                                                                                                                                                                                                                                                              |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>Mais informações sobre</em> <em><strong>seLinux</strong></em></p>                                                           | O **contexto SELinux a ser aplicado a todos os contêineres**. Se não especificado, o tempo de execução do contêiner alocará um contexto SELinux aleatório para cada contêiner.                                                                                                                                                                                                                                                                                                                             |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a><br><em>Mais informações sobre</em> <em><strong>Seccomp</strong></em></p>                                                           | As **opções seccomp a serem usadas pelos contêineres** neste pod.                                                                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>supplementalGroups</strong></a><br><em>array de inteiros</em></p>                                                                                                                                                                                                                                | Uma lista de **grupos aplicados ao primeiro processo executado em cada contêiner**, além do GID primário do contêiner.                                                                                                                                                                                                                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>sysctls</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#sysctl-v1-core"><em>Sysctl</em></a> <em>array</em><br><em>Mais informações sobre</em> <a href="https://www.garron.me/en/go2linux/sysctl-linux.html"><em><strong>sysctls</strong></em></a></p> | Sysctls mantém uma lista de **sysctls namespaced usados para o pod**. Pods com sysctls não suportados (pelo tempo de execução do contêiner) podem falhar ao iniciar.                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                                                                           | As configurações específicas do Windows aplicadas a todos os contêineres. Se não especificado, as opções dentro do SecurityContext de um contêiner serão usadas.                                                                                                                                                                                                                                                                                                                                               |

## SecurityContext

[**Da documentação:**](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

Este contexto é definido dentro das **definições de contêineres**. Do ponto de vista da segurança defensiva, você deve considerar:

- **allowPrivilegeEscalation** como **False**
- Não adicione **capacidades** sensíveis (e remova as que você não precisa)
- **privileged** como **False**
- Se possível, defina **readOnlyFilesystem** como **True**
- Defina **runAsNonRoot** como **True** e defina um **runAsUser**
- Se possível, considere **limitar** **permissões** indicando **seLinuxOptions** e **seccompProfile**
- **NÃO** conceda acesso ao **grupo** de **privilegio** via **runAsGroup.**

Observe que os atributos definidos em **ambos SecurityContext e PodSecurityContext**, o valor especificado em **SecurityContext** tem **precedência**.

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>allowPrivilegeEscalation</strong></a><br><em>booleano</em></p>                                                                                                                                                                      | **AllowPrivilegeEscalation** controla se um processo pode **ganhar mais privilégios** do que seu processo pai. Este booleano controla diretamente se a flag no_new_privs será definida no processo do contêiner. AllowPrivilegeEscalation é sempre verdadeiro quando o contêiner é executado como **Privileged** ou tem **CAP_SYS_ADMIN** |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>capabilities</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#capabilities-v1-core"><em>Capabilities</em></a><br><em>Mais informações sobre</em> <em><strong>Capabilities</strong></em></p>  | As **capacidades a serem adicionadas/removidas ao executar contêineres**. Padrão para o conjunto padrão de capacidades.                                                                                                                                                                                                                |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>privileged</strong></a><br><em>booleano</em></p>                                                                                                                                                                                    | Executar contêiner em modo privilegiado. Processos em contêineres privilegiados são essencialmente **equivalentes ao root no host**. Padrão é falso.                                                                                                                                                                           |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>procMount</strong></a><br><em>string</em></p>                                                                                                                                                                                      | procMount denota o **tipo de montagem proc a ser usado para os contêineres**. O padrão é DefaultProcMount, que usa os padrões de tempo de execução do contêiner para caminhos somente leitura e caminhos mascarados.                                                                                                                                |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>readOnlyRootFilesystem</strong></a><br><em>booleano</em></p>                                                                                                                                                                        | Se este **contêiner tem um sistema de arquivos raiz somente leitura**. O padrão é falso.                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsGroup</strong></a><br><em>inteiro</em></p>                                                                                                                                                                                    | O **GID para executar o ponto de entrada** do processo do contêiner. Usa o padrão de tempo de execução se não definido.                                                                                                                                                                                                                            |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>booleano</em></p>                                                                                                                                                                                  | Indica que o contêiner deve **executar como um usuário não-root**. Se verdadeiro, o Kubelet validará a imagem em tempo de execução para garantir que não seja executada como UID 0 (root) e falhará ao iniciar o contêiner se o fizer.                                                                                                      |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsUser</strong></a><br><em>inteiro</em></p>                                                                                                                                                                                     | O **UID para executar o ponto de entrada** do processo do contêiner. Padrão para o usuário especificado nos metadados da imagem se não especificado.                                                                                                                                                                                              |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>Mais informações sobre</em> <em><strong>seLinux</strong></em></p> | O **contexto SELinux a ser aplicado ao contêiner**. Se não especificado, o tempo de execução do contêiner alocará um contexto SELinux aleatório para cada contêiner.                                                                                                                                                              |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a></p>                                                               | As **opções seccomp** a serem usadas por este contêiner.                                                                                                                                                                                                                                                                     |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                 | As **configurações específicas do Windows** aplicadas a todos os contêineres.                                                                                                                                                                                                                                                          |

## Referências

- [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)
- [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

{{#include ../../../banners/hacktricks-training.md}}
