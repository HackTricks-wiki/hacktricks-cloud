# Kubernetes SecurityContext(s)

{{#include ../../../banners/hacktricks-training.md}}

## PodSecurityContext <a href="#podsecuritycontext-v1-core" id="podsecuritycontext-v1-core"></a>

[**来自文档:**](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)

在指定 Pod 的安全上下文时，可以使用多个属性。从防御安全的角度来看，您应该考虑：

- 将 **runASNonRoot** 设置为 **True**
- 配置 **runAsUser**
- 如果可能，考虑 **限制** **权限**，指明 **seLinuxOptions** 和 **seccompProfile**
- **不要** 通过 **runAsGroup** 和 **supplementaryGroups** 提供 **特权** **组** 访问

| 参数                                                                                                                                                                                                                                                                                                                                                                                                                                  | 描述                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroup</strong></a><br><em>integer</em></p>                                                                                                                                                                                                                                                 | <p>适用于<strong>所有容器的特殊补充组</strong>。某些卷类型允许 Kubelet <strong>更改该卷的所有权</strong>，使其归 Pod 所有：<br>1. 拥有的 GID 将是 FSGroup<br>2. 设置 setgid 位（在卷中创建的新文件将由 FSGroup 拥有）<br>3. 权限位与 rw-rw---- 进行 OR 运算。如果未设置，Kubelet 将不会修改任何卷的所有权和权限</p> |

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroupChangePolicy</strong></a><br><em>string</em></p>                                                                                                                                                                                                                                      | 这定义了在 Pod 内部暴露之前 **更改卷的所有权和权限** 的行为。                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsGroup</strong></a><br><em>integer</em></p>                                                                                                                                                                                                                                              | **运行容器进程的入口点的 GID**。如果未设置，则使用运行时默认值。                                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>boolean</em></p>                                                                                                                                                                                                                                            | 表示容器必须以非根用户身份运行。如果为 true，Kubelet 将在运行时验证映像，以确保它不以 UID 0（根）身份运行，如果是，则无法启动容器。                                                                                                                                                                                                                                                                          |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsUser</strong></a><br><em>integer</em></p>                                                                                                                                                                                                                                               | **运行容器进程的入口点的 UID**。如果未指定，则默认为映像元数据中指定的用户。                                                                                                                                                                                                                                                                                                                                                              |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>有关</em> <em><strong>seLinux</strong></em> 的更多信息</p>                                                           | **应用于所有容器的 SELinux 上下文**。如果未指定，容器运行时将为每个容器分配一个随机的 SELinux 上下文。                                                                                                                                                                                                                                                                                                                             |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a><br><em>有关</em> <em><strong>Seccomp</strong></em> 的更多信息</p>                                                           | 此 Pod 中容器使用的 **seccomp 选项**。                                                                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>supplementalGroups</strong></a><br><em>integer array</em></p>                                                                                                                                                                                                                                | 除了容器的主要 GID 之外，**应用于每个容器中运行的第一个进程的组** 列表。                                                                                                                                                                                                                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>sysctls</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#sysctl-v1-core"><em>Sysctl</em></a> <em>array</em><br><em>有关</em> <a href="https://www.garron.me/en/go2linux/sysctl-linux.html"><em><strong>sysctls</strong></em></a></p> | Sysctls 持有 **用于 Pod 的命名空间 sysctls 列表**。具有不受支持的 sysctls（由容器运行时）可能会导致 Pod 启动失败。                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                                                                           | 应用于所有容器的 Windows 特定设置。如果未指定，将使用容器的 SecurityContext 中的选项。                                                                                                                                                                                                                                                                                                                                               |

## SecurityContext

[**来自文档:**](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

此上下文设置在 **容器定义** 内。从防御安全的角度来看，您应该考虑：

- **allowPrivilegeEscalation** 设置为 **False**
- 不要添加敏感的 **capabilities**（并删除不需要的）
- **privileged** 设置为 **False**
- 如果可能，将 **readOnlyFilesystem** 设置为 **True**
- 将 **runAsNonRoot** 设置为 **True** 并设置 **runAsUser**
- 如果可能，考虑 **限制** **权限**，指明 **seLinuxOptions** 和 **seccompProfile**
- **不要** 通过 **runAsGroup** 提供 **特权** **组** 访问。

请注意，在 **SecurityContext 和 PodSecurityContext** 中设置的属性，**SecurityContext** 中指定的值具有 **优先权**。

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>allowPrivilegeEscalation</strong></a><br><em>boolean</em></p>                                                                                                                                                                      | **AllowPrivilegeEscalation** 控制进程是否可以 **获得比其父进程更多的权限**。此布尔值直接控制是否将在容器进程上设置 no_new_privs 标志。当容器以 **Privileged** 身份运行或具有 **CAP_SYS_ADMIN** 时，AllowPrivilegeEscalation 始终为 true。 |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>capabilities</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#capabilities-v1-core"><em>Capabilities</em></a><br><em>有关</em> <em><strong>Capabilities</strong></em> 的更多信息</p>  | **运行容器时添加/删除的能力**。默认为默认的能力集。                                                                                                                                                                                                                |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>privileged</strong></a><br><em>boolean</em></p>                                                                                                                                                                                    | 以特权模式运行容器。特权容器中的进程基本上与主机上的 **root 等效**。默认为 false。                                                                                                                                                                           |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>procMount</strong></a><br><em>string</em></p>                                                                                                                                                                                      | procMount 表示 **用于容器的 proc 挂载类型**。默认值为 DefaultProcMount，它使用容器运行时的只读路径和屏蔽路径的默认值。                                                                                                                                |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>readOnlyRootFilesystem</strong></a><br><em>boolean</em></p>                                                                                                                                                                        | 此 **容器是否具有只读根文件系统**。默认值为 false。                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsGroup</strong></a><br><em>integer</em></p>                                                                                                                                                                                    | **运行容器进程的入口点的 GID**。如果未设置，则使用运行时默认值。                                                                                                                                                                                                                            |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>boolean</em></p>                                                                                                                                                                                  | 表示容器必须 **以非根用户身份运行**。如果为 true，Kubelet 将在运行时验证映像，以确保它不以 UID 0（根）身份运行，如果是，则无法启动容器。                                                                                                      |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsUser</strong></a><br><em>integer</em></p>                                                                                                                                                                                     | **运行容器进程的入口点的 UID**。如果未指定，则默认为映像元数据中指定的用户。                                                                                                                                                                                              |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>有关</em> <em><strong>seLinux</strong></em> 的更多信息</p> | **应用于容器的 SELinux 上下文**。如果未指定，容器运行时将为每个容器分配一个随机的 SELinux 上下文。                                                                                                                                                              |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a></p>                                                               | 此容器使用的 **seccomp 选项**。                                                                                                                                                                                                                                                                     |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                 | 应用于所有容器的 **Windows 特定设置**。                                                                                                                                                                                                                                                          |

## References

- [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)
- [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

{{#include ../../../banners/hacktricks-training.md}}
