# Kubernetes SecurityContext(s)

{{#include ../../../banners/hacktricks-training.md}}

## PodSecurityContext <a href="#podsecuritycontext-v1-core" id="podsecuritycontext-v1-core"></a>

[**De la documentación:**](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)

Al especificar el contexto de seguridad de un Pod, puedes usar varios atributos. Desde un punto de vista de seguridad defensiva, deberías considerar:

- Tener **runASNonRoot** como **True**
- Configurar **runAsUser**
- Si es posible, considera **limitar** **permisos** indicando **seLinuxOptions** y **seccompProfile**
- No dar acceso de **grupo** de **privilegios** a través de **runAsGroup** y **supplementaryGroups**

| Parámetro                                                                                                                                                                                                                                                                                                                                                                                                                                  | Descripción                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroup</strong></a><br><em>entero</em></p>                                                                                                                                                                                                                                                 | <p>Un grupo suplementario especial que se aplica a <strong>todos los contenedores en un pod</strong>. Algunos tipos de volúmenes permiten que el Kubelet <strong>cambie la propiedad de ese volumen</strong> para que sea propiedad del pod:<br>1. El GID propietario será el FSGroup<br>2. El bit setgid está establecido (los nuevos archivos creados en el volumen serán propiedad del FSGroup)<br>3. Los bits de permiso se OR'd con rw-rw---- Si no se establece, el Kubelet no modificará la propiedad y los permisos de ningún volumen</p> |

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroupChangePolicy</strong></a><br><em>cadena</em></p>                                                                                                                                                                                                                                      | Esto define el comportamiento de **cambio de propiedad y permiso del volumen** antes de ser expuesto dentro del Pod.                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsGroup</strong></a><br><em>entero</em></p>                                                                                                                                                                                                                                              | El **GID para ejecutar el punto de entrada del proceso del contenedor**. Usa el valor predeterminado de tiempo de ejecución si no se establece.                                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>booleano</em></p>                                                                                                                                                                                                                                            | Indica que el contenedor debe ejecutarse como un usuario no root. Si es verdadero, el Kubelet validará la imagen en tiempo de ejecución para asegurarse de que no se ejecute como UID 0 (root) y fallará al iniciar el contenedor si lo hace.                                                                                                                                                                                                                                                                          |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsUser</strong></a><br><em>entero</em></p>                                                                                                                                                                                                                                               | El **UID para ejecutar el punto de entrada del proceso del contenedor**. Por defecto, se utiliza el usuario especificado en los metadatos de la imagen si no se especifica.                                                                                                                                                                                                                                                                                                                                                              |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>Más información sobre</em> <em><strong>seLinux</strong></em></p>                                                           | El **contexto SELinux que se aplicará a todos los contenedores**. Si no se especifica, el tiempo de ejecución del contenedor asignará un contexto SELinux aleatorio para cada contenedor.                                                                                                                                                                                                                                                                                                                             |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a><br><em>Más información sobre</em> <em><strong>Seccomp</strong></em></p>                                                           | Las **opciones seccomp que usarán los contenedores** en este pod.                                                                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>supplementalGroups</strong></a><br><em>array de enteros</em></p>                                                                                                                                                                                                                                | Una lista de **grupos aplicados al primer proceso ejecutado en cada contenedor**, además del GID principal del contenedor.                                                                                                                                                                                                                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>sysctls</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#sysctl-v1-core"><em>Sysctl</em></a> <em>array</em><br><em>Más información sobre</em> <a href="https://www.garron.me/en/go2linux/sysctl-linux.html"><em><strong>sysctls</strong></em></a></p> | Los sysctls contienen una lista de **sysctls con espacio de nombres utilizados para el pod**. Los pods con sysctls no soportados (por el tiempo de ejecución del contenedor) podrían fallar al lanzarse.                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                                                                           | La configuración específica de Windows aplicada a todos los contenedores. Si no se especifica, se utilizarán las opciones dentro del SecurityContext de un contenedor.                                                                                                                                                                                                                                                                                                                                               |

## SecurityContext

[**De la documentación:**](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

Este contexto se establece dentro de las **definiciones de contenedores**. Desde un punto de vista de seguridad defensiva, deberías considerar:

- **allowPrivilegeEscalation** como **False**
- No agregar **capabilities** sensibles (y eliminar las que no necesites)
- **privileged** como **False**
- Si es posible, establecer **readOnlyFilesystem** como **True**
- Establecer **runAsNonRoot** como **True** y establecer un **runAsUser**
- Si es posible, considera **limitar** **permisos** indicando **seLinuxOptions** y **seccompProfile**
- No dar acceso de **grupo** de **privilegios** a través de **runAsGroup.**

Ten en cuenta que los atributos establecidos en **tanto SecurityContext como PodSecurityContext**, el valor especificado en **SecurityContext** tiene **precedencia**.

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>allowPrivilegeEscalation</strong></a><br><em>booleano</em></p>                                                                                                                                                                      | **AllowPrivilegeEscalation** controla si un proceso puede **obtener más privilegios** que su proceso padre. Este booleano controla directamente si se establecerá la bandera no_new_privs en el proceso del contenedor. AllowPrivilegeEscalation es verdadero siempre que el contenedor se ejecute como **Privileged** o tenga **CAP_SYS_ADMIN** |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>capabilities</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#capabilities-v1-core"><em>Capabilities</em></a><br><em>Más información sobre</em> <em><strong>Capabilities</strong></em></p>  | Las **capacidades para agregar/eliminar al ejecutar contenedores**. Por defecto, se utiliza el conjunto predeterminado de capacidades.                                                                                                                                                                                                                |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>privileged</strong></a><br><em>booleano</em></p>                                                                                                                                                                                    | Ejecutar el contenedor en modo privilegiado. Los procesos en contenedores privilegiados son esencialmente **equivalentes a root en el host**. Por defecto, es falso.                                                                                                                                                                           |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>procMount</strong></a><br><em>cadena</em></p>                                                                                                                                                                                      | procMount denota el **tipo de montaje proc a usar para los contenedores**. El valor predeterminado es DefaultProcMount, que utiliza los valores predeterminados del tiempo de ejecución del contenedor para rutas de solo lectura y rutas enmascaradas.                                                                                                                                |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>readOnlyRootFilesystem</strong></a><br><em>booleano</em></p>                                                                                                                                                                        | Si este **contenedor tiene un sistema de archivos raíz de solo lectura**. El valor predeterminado es falso.                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsGroup</strong></a><br><em>entero</em></p>                                                                                                                                                                                    | El **GID para ejecutar el punto de entrada** del proceso del contenedor. Usa el valor predeterminado de tiempo de ejecución si no se establece.                                                                                                                                                                                                                            |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>booleano</em></p>                                                                                                                                                                                  | Indica que el contenedor debe **ejecutarse como un usuario no root**. Si es verdadero, el Kubelet validará la imagen en tiempo de ejecución para asegurarse de que no se ejecute como UID 0 (root) y fallará al iniciar el contenedor si lo hace.                                                                                                      |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsUser</strong></a><br><em>entero</em></p>                                                                                                                                                                                     | El **UID para ejecutar el punto de entrada** del proceso del contenedor. Por defecto, se utiliza el usuario especificado en los metadatos de la imagen si no se especifica.                                                                                                                                                                                              |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>Más información sobre</em> <em><strong>seLinux</strong></em></p> | El **contexto SELinux que se aplicará al contenedor**. Si no se especifica, el tiempo de ejecución del contenedor asignará un contexto SELinux aleatorio para cada contenedor.                                                                                                                                                              |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a></p>                                                               | Las **opciones seccomp** que usará este contenedor.                                                                                                                                                                                                                                                                     |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                 | La **configuración específica de Windows** aplicada a todos los contenedores.                                                                                                                                                                                                                                                          |

## Referencias

- [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)
- [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

{{#include ../../../banners/hacktricks-training.md}}
