# Kubernetes Güçlendirme

{{#include ../../../banners/hacktricks-training.md}}

## Bir küme analiz etmek için araçlar

### [**Steampipe - Kubernetes Uyum**](https://github.com/turbot/steampipe-mod-kubernetes-compliance)

Bu, **Kubernetes kümesi üzerinde birkaç uyum kontrolü gerçekleştirecektir**. CIS, Ulusal Güvenlik Ajansı (NSA) ve Siber Güvenlik ve Altyapı Güvenliği Ajansı (CISA) için Kubernetes güçlendirme teknik raporunu destekler.
```bash
# Install Steampipe
brew install turbot/tap/powerpipe
brew install turbot/tap/steampipe
steampipe plugin install kubernetes

# Start the service
steampipe service start

# Install the module
mkdir dashboards
cd dashboards
powerpipe mod init
powerpipe mod install github.com/turbot/steampipe-mod-kubernetes-compliance

# Run the module
powerpipe server
```
### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape), risk analizi, güvenlik uyumluluğu, RBAC görselleştirici ve görüntü zafiyet taraması dahil olmak üzere çoklu bulut K8s tek bir görünüm sağlayan bir K8s açık kaynak aracıdır. Kubescape, K8s kümelerini, YAML dosyalarını ve HELM grafiklerini tarar, birden fazla çerçeveye (örneğin, [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)) göre yanlış yapılandırmaları, yazılım zafiyetlerini ve RBAC (rol tabanlı erişim kontrolü) ihlallerini CI/CD boru hattının erken aşamalarında tespit eder, risk puanını anında hesaplar ve zaman içindeki risk eğilimlerini gösterir.
```bash
curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | /bin/bash
kubescape scan --verbose
```
### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye), canlı Kubernetes kümesini tarayan ve **dağıtılan kaynaklar ve yapılandırmalarla ilgili potansiyel sorunları raporlayan** bir yardımcı programdır. Kümenizi, disk üzerinde bulunan değil, dağıtılanlara göre temizler. Kümenizi tarayarak, yanlış yapılandırmaları tespit eder ve en iyi uygulamaların yerinde olmasını sağlamanıza yardımcı olur, böylece gelecekteki sorunları önler. Amacı, bir Kubernetes kümesini yönetirken karşılaşılan bilişsel \_yükü azaltmaktır. Ayrıca, kümeniz bir metric-server kullanıyorsa, potansiyel kaynakların aşırı/az tahsislerini raporlar ve kümeniz kapasiteyi doldurursa sizi uyarmaya çalışır.

### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Araç [**kube-bench**](https://github.com/aquasecurity/kube-bench), Kubernetes'in güvenli bir şekilde dağıtılıp dağıtılmadığını kontrol eden bir araçtır ve [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/) belgelerinde yer alan kontrolleri çalıştırır.\
Şunları seçebilirsiniz:

- kube-bench'i bir konteynerin içinden çalıştırmak (ana bilgisayarla PID ad alanını paylaşarak)
- ana bilgisayara kube-bench yükleyen bir konteyner çalıştırmak ve ardından kube-bench'i doğrudan ana bilgisayarda çalıştırmak
- [Releases page](https://github.com/aquasecurity/kube-bench/releases) sayfasından en son ikili dosyaları yüklemek,
- kaynaktan derlemek.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

**[DEPRECEATED]** Araç [**kubeaudit**](https://github.com/Shopify/kubeaudit), çeşitli güvenlik endişeleri için **Kubernetes kümelerini denetlemek** amacıyla bir komut satırı aracı ve Go paketidir.

Kubeaudit, bir küme içinde bir konteynerde çalışıp çalışmadığını tespit edebilir. Eğer öyleyse, o kümedeki tüm Kubernetes kaynaklarını denetlemeye çalışacaktır:
```
kubeaudit all
```
Bu araç ayrıca tespit edilen sorunları **otomatik olarak düzeltmek için** `autofix` argümanına sahiptir.

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

**[KULLANIMDIŞI]** Araç [**kube-hunter**](https://github.com/aquasecurity/kube-hunter), Kubernetes kümelerindeki güvenlik zayıflıklarını avlar. Araç, Kubernetes ortamlarındaki güvenlik sorunları için farkındalığı ve görünürlüğü artırmak amacıyla geliştirilmiştir.
```bash
kube-hunter --remote some.node.com
```
### [Trivy](https://github.com/aquasecurity/trivy)

[Trivy](https://github.com/aquasecurity/trivy), güvenlik sorunlarını arayan tarayıcılara sahiptir ve bu sorunları bulabileceği hedefleri belirler:

- Konteyner Görüntüsü
- Dosya Sistemi
- Git Deposu (uzaktan)
- Sanal Makine Görüntüsü
- Kubernetes


### [**Kubei**](https://github.com/Erezf-p/kubei)

**[Bakımda değil gibi görünüyor]**

[**Kubei**](https://github.com/Erezf-p/kubei), kullanıcıların Kubernetes kümelerinin doğru ve anlık risk değerlendirmesini almasına olanak tanıyan bir zafiyet tarama ve CIS Docker benchmark aracıdır. Kubei, bir Kubernetes kümesinde kullanılan tüm görüntüleri, uygulama podlarının ve sistem podlarının görüntülerini tarar.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan), Kubernetes'in Rol tabanlı erişim kontrolü (RBAC) yetkilendirme modelinde riskli izinleri taramak için bir araçtır.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit), diğer araçlarla karşılaştırıldığında yüksek riskli kontrolleri test etmek için oluşturulmuş bir araçtır. Temelde 3 farklı moda sahiptir:

- **`find-role-relationships`**: Hangi AWS rollerinin hangi podlarda çalıştığını bulur.
- **`find-secrets`**: Pods, ConfigMaps ve Secrets gibi K8s kaynaklarında gizli bilgileri tanımlamaya çalışır.
- **`test-imds-access`**: Podları çalıştırmaya ve metadata v1 ve v2'ye erişmeye çalışır. UYARI: Bu, kümede bir pod çalıştıracaktır, dikkatli olun çünkü bunu yapmak istemiyor olabilirsiniz!

## **IaC Kodunu Denetleme**

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics), aşağıdaki **Kod Olarak Altyapı çözümlerinde** **güvenlik açıklarını**, uyum sorunlarını ve altyapı yanlış yapılandırmalarını bulur: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM ve OpenAPI 3.0 spesifikasyonları.

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov), altyapı-as-kod için statik kod analizi aracıdır.

[Terraform](https://terraform.io), Terraform planı, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) veya [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) kullanılarak sağlanan bulut altyapısını tarar ve grafik tabanlı tarama kullanarak güvenlik ve uyum yanlış yapılandırmalarını tespit eder.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score), Kubernetes nesne tanımlarınızın statik kod analizini gerçekleştiren bir araçtır.

Kurmak için:

| Dağıtım                                            | Komut / Bağlantı                                                                         |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| macOS, Linux ve Windows için önceden derlenmiş ikililer | [GitHub sürümleri](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub](https://hub.docker.com/r/zegl/kube-score/)) |
| Homebrew (macOS ve Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS ve Linux) | `kubectl krew install score`                                                            |

## İpuçları

### Kubernetes PodSecurityContext ve SecurityContext

**Pod'ların güvenlik bağlamını** (_PodSecurityContext_) ve çalıştırılacak **konteynerlerin** (_SecurityContext_) güvenlik bağlamını yapılandırabilirsiniz. Daha fazla bilgi için okuyun:

{{#ref}}
kubernetes-securitycontext-s.md
{{#endref}}

### Kubernetes API Güçlendirme

**Kubernetes Api Sunucusuna erişimi korumak** çok önemlidir çünkü yeterli ayrıcalıklara sahip kötü niyetli bir aktör bunu kötüye kullanabilir ve ortamda birçok şekilde zarar verebilir.\
Hem **erişimi** (**API Sunucusuna erişim için beyaz liste** kökenleri ve diğer bağlantıları reddetmek) hem de [**kimlik doğrulama**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (en az ayrıcalık ilkesini takip ederek) güvence altına almak önemlidir. Ve kesinlikle **asla** **anonim** **isteklere** **izin vermeyin**.

**Ortak İstek süreci:**\
Kullanıcı veya K8s ServiceAccount –> Kimlik Doğrulama –> Yetkilendirme –> Kabul Kontrolü.

**İpuçları**:

- Portları kapatın.
- Anonim erişimi önleyin.
- NodeRestriction; Belirli düğümlerden API'ye erişim yok.
- [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
- Temelde, kubelet'lerin node-restriction.kubernetes.io/ ön eki ile etiket eklemesini/çıkarmasını/güncellemesini engeller. Bu etiket ön eki, yöneticilerin iş yükü izolasyonu amacıyla Düğüm nesnelerini etiketlemesi için ayrılmıştır ve kubelet'lerin bu ön ekle etiketleri değiştirmesine izin verilmeyecektir.
- Ayrıca, kubelet'lerin bu etiketleri ve etiket ön eklerini eklemesine/çıkarmasına/güncellemesine izin verir.
- Güvenli iş yükü izolasyonunu etiketlerle sağlayın.
- Belirli podların API erişimini önleyin.
- ApiServer'ın internete maruz kalmasını önleyin.
- Yetkisiz erişim RBAC'sını önleyin.
- ApiServer portunu güvenlik duvarı ve IP beyaz listesi ile koruyun.

### SecurityContext Güçlendirme

Varsayılan olarak, başka bir kullanıcı belirtilmediği sürece bir Pod başlatıldığında root kullanıcısı kullanılacaktır. Uygulamanızı daha güvenli bir bağlamda çalıştırmak için aşağıdaki gibi bir şablon kullanabilirsiniz:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
- [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
- [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Genel Güçlendirme

Kubernetes ortamınızı, aşağıdakilere sahip olmak için gerektiği sıklıkta güncellemelisiniz:

- Bağımlılıkların güncel olması.
- Hata ve güvenlik yamanmaları.

[**Sürüm döngüleri**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Her 3 ayda bir yeni bir küçük sürüm çıkar -- 1.20.3 = 1(Büyük).20(Küçük).3(yaman)

**Kubernetes Kümesini güncellemenin en iyi yolu (şuradan** [**buraya**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

- Master Node bileşenlerini şu sırayla yükseltin:
- etcd (tüm örnekler).
- kube-apiserver (tüm kontrol düzlemi sunucuları).
- kube-controller-manager.
- kube-scheduler.
- bir tane kullanıyorsanız cloud controller manager.
- Worker Node bileşenlerini, kube-proxy, kubelet gibi yükseltin.

## Kubernetes izleme & güvenlik:

- Kyverno Politika Motoru
- Cilium Tetragon - eBPF tabanlı Güvenlik Gözlemlenmesi ve Çalışma Zamanı Uygulaması
- Ağ Güvenlik Politikaları
- Falco - Çalışma Zamanı güvenlik izleme & tespiti

{{#include ../../../banners/hacktricks-training.md}}
