# Kubernetes Hardening

{{#include ../../../banners/hacktricks-training.md}}

## Tools to analyse a cluster

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) ni chombo cha K8s cha chanzo wazi kinachotoa muonekano mmoja wa K8s wa multi-cloud, ikiwa ni pamoja na uchambuzi wa hatari, utii wa usalama, mchoraji wa RBAC na skanning ya udhaifu wa picha. Kubescape inachanganua makundi ya K8s, faili za YAML, na chati za HELM, ikigundua makosa ya usanidi kulingana na mifumo mbalimbali (kama vile [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo) , [MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), udhaifu wa programu, na ukiukaji wa RBAC (udhibiti wa ufikiaji kulingana na majukumu) katika hatua za awali za mchakato wa CI/CD, inakadiria alama ya hatari mara moja na inaonyesha mwenendo wa hatari kwa muda.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Chombo [**kube-bench**](https://github.com/aquasecurity/kube-bench) ni chombo kinachokagua ikiwa Kubernetes imewekwa kwa usalama kwa kukimbia ukaguzi ulioandikwa katika [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Unaweza kuchagua:

- kukimbia kube-bench kutoka ndani ya kontena (kushiriki PID namespace na mwenyeji)
- kukimbia kontena linalosakinisha kube-bench kwenye mwenyeji, na kisha kukimbia kube-bench moja kwa moja kwenye mwenyeji
- kusakinisha binaries za hivi karibuni kutoka kwenye [Releases page](https://github.com/aquasecurity/kube-bench/releases),
- kuandika kutoka chanzo.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

Chombo [**kubeaudit**](https://github.com/Shopify/kubeaudit) ni chombo cha mistari ya amri na pakiti ya Go ili **kukagua makundi ya Kubernetes** kwa wasiwasi mbalimbali wa usalama.

Kubeaudit inaweza kugundua ikiwa inakimbia ndani ya kontena katika kundi. Ikiwa ndivyo, itajaribu kukagua rasilimali zote za Kubernetes katika kundi hilo:
```
kubeaudit all
```
Hii zana pia ina hoja `autofix` ili **kurekebisha kiotomatiki matatizo yaliyogundulika.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

Zana [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) inatafuta udhaifu wa usalama katika makundi ya Kubernetes. Zana hii ilitengenezwa kuongeza ufahamu na mwonekano wa matatizo ya usalama katika mazingira ya Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) ni chombo cha kuchanganua udhaifu na kipimo cha CIS Docker ambacho kinawawezesha watumiaji kupata tathmini sahihi na ya haraka ya hatari ya makundi yao ya kubernetes. Kubei inachanganua picha zote zinazotumika katika kundi la Kubernetes, ikiwa ni pamoja na picha za pods za programu na pods za mfumo.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) ni chombo cha kuchanganua kundi la Kubernetes kwa ruhusa hatari katika mfano wa idhini wa Role-based access control (RBAC) wa Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) ni chombo kilichojengwa ili kujaribu aina nyingine za ukaguzi wa hatari kubwa ikilinganishwa na zana nyingine. Kimsingi ina hali 3 tofauti:

- **`find-role-relationships`**: Ambayo itapata ni AWS roles zipi zinaendesha katika pods zipi
- **`find-secrets`**: Ambayo inajaribu kubaini siri katika rasilimali za K8s kama vile Pods, ConfigMaps, na Secrets.
- **`test-imds-access`**: Ambayo itajaribu kuendesha pods na kujaribu kufikia metadata v1 na v2. ONYO: Hii itakimbiza pod katika kundi, kuwa makini sana kwa sababu huenda hutaki kufanya hivi!

## **Audit IaC Code**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) ni chombo kinachochanganua kundi la Kubernetes lililo hai na **kutoa ripoti za matatizo yanayoweza kutokea na rasilimali na mipangilio iliyowekwa**. Inasafisha kundi lako kulingana na kile kilichowekwa na si kile kilichoko kwenye diski. Kwa kuchanganua kundi lako, inagundua makosa ya mipangilio na inakusaidia kuhakikisha kuwa mbinu bora zipo, hivyo kuzuia maumivu ya baadaye. Inalenga kupunguza mzigo wa kiakili \_over_load mtu anayeweza kukutana nao anapofanya kazi katika kundi la Kubernetes katika mazingira ya kawaida. Zaidi ya hayo, ikiwa kundi lako linatumia metric-server, inatoa ripoti za rasilimali zinazoweza kuwa juu/chini na inajaribu kukujulisha ikiwa kundi lako litakosa uwezo.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) inapata **udhaifu wa usalama**, masuala ya kufuata sheria, na makosa ya mipangilio ya miundombinu katika **Suluhisho za Miundombinu kama Msimbo** zifuatazo: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM, na OpenAPI 3.0 specifications

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) ni chombo cha uchanganuzi wa msimbo wa statiki kwa miundombinu-kama-msimbo.

Inachanganua miundombinu ya wingu iliyowekwa kwa kutumia [Terraform](https://terraform.io), mpango wa Terraform, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) au [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) na kugundua makosa ya usalama na kufuata sheria kwa kutumia uchanganuzi wa msingi wa grafu.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) ni chombo kinachofanya uchanganuzi wa msimbo wa statiki wa ufafanuzi wa vitu vya Kubernetes.

Ili kusakinisha:

| Usambazaji                                        | Amri / Kiungo                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Binaries zilizojengwa kwa macOS, Linux, na Windows    | [GitHub releases](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS na Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS na Linux) | `kubectl krew install score`                                                            |

## Tips

### Kubernetes PodSecurityContext na SecurityContext

Unaweza kuunda **muktadha wa usalama wa Pods** (kwa _PodSecurityContext_) na wa **michakato** ambayo itakimbizwa (kwa _SecurityContext_). Kwa maelezo zaidi soma:

{{#ref}}
kubernetes-securitycontext-s.md
{{#endref}}

### Kubernetes API Hardening

Ni muhimu sana **kulinda ufikiaji wa Kubernetes Api Server** kwani mhusika mbaya mwenye ruhusa ya kutosha anaweza kuweza kuutumia vibaya na kuharibu mazingira kwa njia nyingi.\
Ni muhimu kulinda **ufikiaji** (**whitelist** asili za kufikia API Server na kukataa uhusiano mwingine wowote) na [**uthibitishaji**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (kufuata kanuni ya **kidogo** **ruhusa**). Na hakika **kamwe** **usiruhusu** **maombi** **yasiyo na jina**.

**Mchakato wa Maombi ya Kawaida:**\
Mtumiaji au K8s ServiceAccount –> Uthibitishaji –> Uidhinishaji –> Udhibiti wa Kukubali.

**Vidokezo**:

- Funga bandari.
- Epuka ufikiaji wa Kijadi.
- NodeRestriction; Hakuna ufikiaji kutoka nodi maalum kwenda API.
- [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
- Kimsingi inazuia kubelets kuongeza/kuondoa/kubadilisha lebo zenye prefix ya node-restriction.kubernetes.io/. Prefix hii ya lebo imehifadhiwa kwa wasimamizi kuweka lebo kwenye vitu vya Node kwa madhumuni ya kutenganisha kazi, na kubelets hawataruhusiwa kubadilisha lebo zenye prefix hiyo.
- Na pia, inaruhusu kubelets kuongeza/kuondoa/kubadilisha lebo hizi na prefix za lebo.
- Hakikisha kwa lebo kutenganisha kazi salama.
- Epuka pods maalum kutoka kwa ufikiaji wa API.
- Epuka kufichua ApiServer kwa mtandao.
- Epuka ufikiaji usioidhinishwa RBAC.
- Bandari ya ApiServer na firewall na IP whitelisting.

### SecurityContext Hardening

Kwa kawaida mtumiaji wa root atatumika wakati Pod inaanza ikiwa mtumiaji mwingine hajakabidhiwa. Unaweza kuendesha programu yako ndani ya muktadha salama zaidi kwa kutumia kigezo kinachofanana na hiki:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
- [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
- [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Uimarishaji wa Jumla

Unapaswa kusasisha mazingira yako ya Kubernetes mara kwa mara kadri inavyohitajika ili uwe na:

- Mtegemeo wa kisasa.
- Marekebisho ya makosa na usalama.

[**Mizunguko ya kutolewa**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Kila miezi 3 kuna toleo jipya dogo -- 1.20.3 = 1(Mkubwa).20(Dogo).3(marekebisho)

**Njia bora ya kusasisha Kundi la Kubernetes ni (kutoka** [**hapa**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

- Pandisha viungo vya Node ya Mwalimu ukifuatilia mpangilio huu:
- etcd (mifano yote).
- kube-apiserver (mashine zote za udhibiti).
- kube-controller-manager.
- kube-scheduler.
- meneja wa udhibiti wa wingu, ikiwa unatumia mmoja.
- Pandisha viungo vya Node ya Kazi kama kube-proxy, kubelet.

{{#include ../../../banners/hacktricks-training.md}}
