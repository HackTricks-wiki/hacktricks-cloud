# Kubernetes Hardening

{{#include ../../../banners/hacktricks-training.md}}

## Інструменти для аналізу кластера

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) - це відкритий інструмент K8s, який надає єдину панель управління для багатохмарного K8s, включаючи аналіз ризиків, відповідність безпеки, візуалізацію RBAC та сканування вразливостей зображень. Kubescape сканує кластери K8s, файли YAML та HELM-діаграми, виявляючи неправильні налаштування відповідно до кількох фреймворків (таких як [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), вразливості програмного забезпечення та порушення RBAC (контроль доступу на основі ролей) на ранніх етапах CI/CD, миттєво розраховує бал ризику та показує тенденції ризику з часом.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Інструмент [**kube-bench**](https://github.com/aquasecurity/kube-bench) - це інструмент, який перевіряє, чи безпечно розгорнуто Kubernetes, виконуючи перевірки, задокументовані в [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Ви можете вибрати:

- запустити kube-bench зсередини контейнера (ділячи простір PID з хостом)
- запустити контейнер, який встановлює kube-bench на хост, а потім запустити kube-bench безпосередньо на хості
- встановити останні бінарні файли з [сторінки релізів](https://github.com/aquasecurity/kube-bench/releases),
- скомпілювати його з виходу.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

Інструмент [**kubeaudit**](https://github.com/Shopify/kubeaudit) - це інструмент командного рядка та пакет Go для **аудиту кластерів Kubernetes** з різних питань безпеки.

Kubeaudit може виявити, чи працює він у контейнері в кластері. Якщо так, він спробує провести аудит усіх ресурсів Kubernetes у цьому кластері:
```
kubeaudit all
```
Цей інструмент також має аргумент `autofix`, щоб **автоматично виправляти виявлені проблеми.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

Інструмент [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) шукає вразливості безпеки в кластерах Kubernetes. Інструмент був розроблений для підвищення обізнаності та видимості проблем безпеки в середовищах Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) - це інструмент для сканування вразливостей та стандартів CIS Docker, який дозволяє користувачам отримати точну та миттєву оцінку ризиків їхніх кластерів kubernetes. Kubei сканує всі образи, які використовуються в кластері Kubernetes, включаючи образи додатків та системних подів.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) - це інструмент для сканування кластера Kubernetes на наявність ризикованих дозволів у моделі авторизації на основі ролей (RBAC) Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) - це інструмент, створений для тестування інших типів перевірок високого ризику в порівнянні з іншими інструментами. Він має 3 різні режими:

- **`find-role-relationships`**: Який знайде, які ролі AWS працюють у яких подах
- **`find-secrets`**: Який намагається виявити секрети в ресурсах K8s, таких як Pods, ConfigMaps та Secrets.
- **`test-imds-access`**: Який спробує запустити поди та спробує отримати доступ до метаданих v1 та v2. УВАГА: Це запустить под у кластері, будьте дуже обережні, оскільки, можливо, ви не хочете цього робити!

## **Аудит IaC коду**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) - це утиліта, яка сканує живий кластер Kubernetes та **повідомляє про потенційні проблеми з розгорнутими ресурсами та конфігураціями**. Вона очищає ваш кластер на основі того, що розгорнуто, а не на основі того, що знаходиться на диску. Скануючи ваш кластер, вона виявляє неправильні конфігурації та допомагає вам забезпечити дотримання найкращих практик, запобігаючи майбутнім проблемам. Вона спрямована на зменшення когнітивного \_перевантаження, з яким стикаються при управлінні кластером Kubernetes у реальних умовах. Крім того, якщо ваш кластер використовує сервер метрик, він повідомляє про потенційні надмірні/недостатні виділення ресурсів і намагається попередити вас, якщо ваш кластер вичерпає потужності.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) знаходить **вразливості безпеки**, проблеми відповідності та неправильні конфігурації інфраструктури в наступних **рішеннях Інфраструктури як Код**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM та специфікаціях OpenAPI 3.0

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) - це інструмент статичного аналізу коду для інфраструктури як коду.

Він сканує хмарну інфраструктуру, що надається за допомогою [Terraform](https://terraform.io), плану Terraform, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) або [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) та виявляє неправильні конфігурації безпеки та відповідності за допомогою графового сканування.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) - це інструмент, який виконує статичний аналіз коду ваших визначень об'єктів Kubernetes.

Щоб встановити:

| Дистрибуція                                        | Команда / Посилання                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Попередньо зібрані бінарні файли для macOS, Linux та Windows    | [Випуски GitHub](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS та Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS та Linux) | `kubectl krew install score`                                                            |

## Поради

### Kubernetes PodSecurityContext та SecurityContext

Ви можете налаштувати **контекст безпеки подів** (з _PodSecurityContext_) та **контекст безпеки** контейнерів, які будуть запущені (з _SecurityContext_). Для отримання додаткової інформації читайте:

{{#ref}}
kubernetes-securitycontext-s.md
{{#endref}}

### Ускладнення безпеки API Kubernetes

Дуже важливо **захистити доступ до сервера API Kubernetes**, оскільки зловмисник з достатніми привілеями може зловживати ним і завдати шкоди середовищу.\
Важливо забезпечити як **доступ** (**білі списки** джерел для доступу до сервера API та заборонити будь-яке інше з'єднання), так і [**автентифікацію**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (дотримуючись принципу **найменших** **привілеїв**). І, безумовно, **ніколи** **не** **дозволяйте** **анонімні** **запити**.

**Загальний процес запиту:**\
Користувач або K8s ServiceAccount –> Автентифікація –> Авторизація –> Контроль доступу.

**Поради**:

- Закрийте порти.
- Уникайте анонімного доступу.
- NodeRestriction; Немає доступу з певних вузлів до API.
- [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
- В основному забороняє kubelet додавати/видаляти/оновлювати мітки з префіксом node-restriction.kubernetes.io/. Цей префікс мітки зарезервований для адміністраторів, щоб мітити свої об'єкти Node для цілей ізоляції навантаження, і kubelet не буде дозволено змінювати мітки з цим префіксом.
- А також дозволяє kubelet додавати/видаляти/оновлювати ці мітки та префікси міток.
- Забезпечте з мітками безпечну ізоляцію навантаження.
- Уникайте доступу до API для певних подів.
- Уникайте експозиції ApiServer в Інтернеті.
- Уникайте несанкціонованого доступу RBAC.
- Порт ApiServer з брандмауером та білим списком IP.

### Ускладнення SecurityContext

За замовчуванням, користувач root буде використовуватися, коли под запускається, якщо не вказано іншого користувача. Ви можете запустити свій додаток у більш безпечному контексті, використовуючи шаблон, подібний до наступного:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
- [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
- [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Загальне зміцнення

Вам слід оновлювати ваше середовище Kubernetes так часто, як це необхідно, щоб мати:

- Залежності в актуальному стані.
- Виправлення помилок і безпеки.

[**Цикли випуску**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Кожні 3 місяці виходить новий незначний реліз -- 1.20.3 = 1(Основний).20(Незначний).3(патч)

**Найкращий спосіб оновити кластер Kubernetes це (з** [**тут**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

- Оновіть компоненти Master Node, дотримуючись цієї послідовності:
- etcd (всі екземпляри).
- kube-apiserver (всі хости контрольної площини).
- kube-controller-manager.
- kube-scheduler.
- cloud controller manager, якщо ви його використовуєте.
- Оновіть компоненти Worker Node, такі як kube-proxy, kubelet.

{{#include ../../../banners/hacktricks-training.md}}
