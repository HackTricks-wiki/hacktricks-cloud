# Endurecimiento de Kubernetes

{{#include ../../../banners/hacktricks-training.md}}

## Herramientas para analizar un clúster

### [Steampipe - Kubernetes Compliance](https://github.com/turbot/steampipe-mod-kubernetes-compliance)

Realiza **varias comprobaciones de cumplimiento en el clúster de Kubernetes**. Incluye soporte para CIS, la National Security Agency (NSA) y la Cybersecurity and Infrastructure Security Agency (CISA), así como para el informe técnico de ciberseguridad sobre el endurecimiento de Kubernetes.
```bash
# Install Steampipe
brew install turbot/tap/powerpipe
brew install turbot/tap/steampipe
steampipe plugin install kubernetes

# Start the service
steampipe service start

# Install the module
mkdir dashboards
cd dashboards
powerpipe mod init
powerpipe mod install github.com/turbot/steampipe-mod-kubernetes-compliance

# Run the module
powerpipe server
```
### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) es una herramienta de código abierto para K8s que proporciona una vista unificada para entornos K8s multicloud, incluyendo análisis de riesgo, cumplimiento de seguridad, visualizador de RBAC y escaneo de vulnerabilidades de imágenes. Kubescape escanea clústeres K8s, archivos YAML y HELM charts, detectando configuraciones erróneas según múltiples frameworks (such as the [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo) , [MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), vulnerabilidades de software y violaciones de RBAC (role-based-access-control) en las primeras etapas del pipeline CI/CD, calcula la puntuación de riesgo al instante y muestra las tendencias de riesgo a lo largo del tiempo.
```bash
curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | /bin/bash
kubescape scan --verbose
```
### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) es una utilidad que escanea un clúster de Kubernetes en tiempo real y **informa de problemas potenciales con los recursos desplegados y las configuraciones**. Sanea tu clúster basándose en lo que está desplegado y no en lo que hay en disco. Al escanear tu clúster, detecta configuraciones incorrectas y te ayuda a asegurarte de que se aplican las mejores prácticas, evitando así problemas futuros. Su objetivo es reducir la sobrecarga cognitiva que se afronta al operar un clúster de Kubernetes en entornos reales. Además, si tu clúster emplea un metric-server, informa de posibles sobreasignaciones o subasignaciones de recursos y trata de advertirte si tu clúster se queda sin capacidad.

### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

La herramienta [**kube-bench**](https://github.com/aquasecurity/kube-bench) comprueba si Kubernetes está desplegado de forma segura ejecutando las comprobaciones documentadas en el [**CIS Kubernetes Benchmark**].\
Puedes elegir:

- ejecutar kube-bench desde dentro de un contenedor (compartiendo el PID namespace con el host)
- ejecutar un contenedor que instale kube-bench en el host y luego ejecutar kube-bench directamente en el host
- instalar los últimos binarios desde la [Releases page](https://github.com/aquasecurity/kube-bench/releases),
- compilarlo desde el código fuente.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

**[OBSOLETO]** La herramienta [**kubeaudit**](https://github.com/Shopify/kubeaudit) es una herramienta de línea de comandos y un paquete Go para **auditar clusters de Kubernetes** por diversas preocupaciones de seguridad.

Kubeaudit puede detectar si se está ejecutando dentro de un contenedor en un clúster. Si es así, intentará auditar todos los recursos de Kubernetes en ese clúster:
```
kubeaudit all
```
Esta herramienta también tiene el argumento `autofix` para **corregir automáticamente los problemas detectados.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

**[DEPRECADO]** La herramienta [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) busca debilidades de seguridad en clústeres de Kubernetes. La herramienta fue desarrollada para aumentar la concienciación y la visibilidad de los problemas de seguridad en entornos de Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### [Trivy](https://github.com/aquasecurity/trivy)

[Trivy](https://github.com/aquasecurity/trivy) tiene escáneres que buscan problemas de seguridad y objetivos donde puede encontrar esos problemas:

- Imagen de contenedor
- Sistema de archivos
- Git Repository (remote)
- Imagen de máquina virtual
- Kubernetes


### [**Kubei**](https://github.com/Erezf-p/kubei)

**[Parece no estar mantenido]**

[**Kubei**](https://github.com/Erezf-p/kubei) es una herramienta de escaneo de vulnerabilidades y CIS Docker benchmark que permite a los usuarios obtener una evaluación precisa e inmediata del riesgo de sus clústeres de Kubernetes. Kubei escanea todas las imágenes que se están usando en un clúster de Kubernetes, incluidas las imágenes de los pods de aplicaciones y de sistema.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) es una herramienta para escanear un clúster de Kubernetes en busca de permisos riesgosos en el modelo de autorización Role-based access control (RBAC) de Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) es una herramienta diseñada para probar otro tipo de comprobaciones de alto riesgo en comparación con las demás herramientas. Principalmente tiene 3 modos diferentes:

- **`find-role-relationships`**: Que encontrará qué AWS roles se están ejecutando en qué pods
- **`find-secrets`**: Que intenta identificar secrets en recursos de K8s como Pods, ConfigMaps y Secrets.
- **`test-imds-access`**: Que intentará ejecutar pods y tratar de acceder al metadata v1 y v2. ADVERTENCIA: Esto ejecutará un pod en el cluster, ten mucho cuidado porque quizá no quieras hacerlo!

## **Auditar código IaC**

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) encuentra **vulnerabilidades de seguridad**, problemas de cumplimiento y malas configuraciones de infraestructura en las siguientes soluciones de **Infrastructure as Code**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM y especificaciones OpenAPI 3.0

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) es una herramienta de análisis estático de código para infrastructure-as-code.

Escanea infraestructura en la nube aprovisionada usando [Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) o [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) y detecta malas configuraciones de seguridad y cumplimiento utilizando escaneo basado en grafos.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) es una herramienta que realiza análisis estático de código de las definiciones de objetos de tu Kubernetes.

To install:

| Distribution                                        | Command / Link                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Pre-built binaries for macOS, Linux, and Windows    | [GitHub releases](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS and Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS and Linux) | `kubectl krew install score`                                                            |

## Herramientas para analizar archivos YAML & Helm Charts

### [**Kube-linter**](https://github.com/stackrox/kube-linter)
```bash
# Install Kube-linter
brew install kube-linter

# Run Kube-linter
## lint ./path/to/yaml/or/chart
```
### [Checkov](https://github.com/bridgecrewio/checkov)
```bash
# Install Checkov
pip install checkov

# Run Checkov
checkov -d ./path/to/yaml/or/chart
```
### [kube‑score](https://github.com/zegl/kube-score)
```bash
# Install kube-score
brew install kube-score

# Run kube-score
kube-score score ./path/to/yaml
# or
helm template chart /path/to/chart | kube-score score -
# or if the chart needs some values
helm template chart /path/to/chart \
--set 'config.urls[0]=https://dummy.backend.internal' \
| kube-score score -
```
### [Kubesec](https://github.com/controlplaneio/kubesec)
```bash
# Install Kubesec
## Download from https://github.com/controlplaneio/kubesec/releases

# Run Kubesec in a yaml
kubesec scan ./path/to/yaml
# or
helm template chart /path/to/chart | kubesec scan -
# or if the chart needs some values
helm template chart /path/to/chart \
--set 'config.urls[0]=https://dummy.backend.internal' \
| kubesec scan -
```
## Consejos

### Kubernetes PodSecurityContext and SecurityContext

Puedes configurar el **security context of the Pods** (con _PodSecurityContext_) y de los **contenedores** que se van a ejecutar (con _SecurityContext_). Para más información lee:

{{#ref}}
kubernetes-securitycontext-s.md
{{#endref}}

### Endurecimiento de la API de Kubernetes

Es muy importante **proteger el acceso al Kubernetes Api Server** ya que un actor malicioso con suficientes privilegios podría abusar de él y dañar de muchas maneras el entorno.\
Es importante asegurar tanto el **access** (**whitelist** orígenes que puedan acceder al API Server y denegar cualquier otra conexión) como la [**authentication**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (siguiendo el principio de **mínimo** **privilegio**). Y definitivamente **nunca** **permitas** **solicitudes** **anónimas**.

**Common Request process:**\
User or K8s ServiceAccount –> Authentication –> Authorization –> Admission Control.

**Consejos**:

- Cerrar puertos.
- Evitar acceso anónimo.
- NodeRestriction; sin acceso desde nodos específicos al API.
- [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
- Básicamente evita que kubelets agreguen/eliminan/actualicen labels con un prefijo node-restriction.kubernetes.io/. Este prefijo de etiqueta está reservado para administradores para etiquetar sus Node objects con fines de aislamiento de workload, y a los kubelets no se les permitirá modificar etiquetas con ese prefijo.
- Y además, permite a los kubelets agregar/eliminar/actualizar estas labels y prefijos de label.
- Asegurar con labels el aislamiento seguro de cargas de trabajo.
- Evitar que pods específicos accedan al API.
- Evitar la exposición del ApiServer a Internet.
- Evitar acceso no autorizado mediante RBAC.
- Proteger el puerto del ApiServer con firewall y whitelist de IPs.

### Endurecimiento de SecurityContext

Por defecto se usará el usuario root cuando se inicie un Pod si no se especifica otro usuario. Puedes ejecutar tu aplicación dentro de un contexto más seguro usando una plantilla similar a la siguiente:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
- [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
- [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Endurecimiento general

Debes actualizar tu entorno Kubernetes con la frecuencia necesaria para tener:

- Dependencias actualizadas.
- Correcciones de errores y parches de seguridad.

[**Release cycles**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Cada 3 meses hay una nueva versión menor -- 1.20.3 = 1(mayor).20(menor).3(parche)

**La mejor manera de actualizar un Kubernetes Cluster es (desde** [**here**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

- Actualiza los componentes del nodo maestro siguiendo esta secuencia:
- etcd (todas las instancias).
- kube-apiserver (todos los hosts del plano de control).
- kube-controller-manager.
- kube-scheduler.
- cloud controller manager, si lo usas.
- Actualiza los componentes de los nodos de trabajo, como kube-proxy y kubelet.

## Monitoreo y seguridad de Kubernetes:

- Kyverno Policy Engine
- Cilium Tetragon - Observabilidad de seguridad basada en eBPF e imposición en tiempo de ejecución
- Políticas de seguridad de red
- Falco - Monitoreo y detección de seguridad en tiempo de ejecución

{{#include ../../../banners/hacktricks-training.md}}
