# Kuimarisha Kubernetes

{{#include ../../../banners/hacktricks-training.md}}

## Zana za kuchambua cluster

### [Steampipe - Kubernetes Compliance](https://github.com/turbot/steampipe-mod-kubernetes-compliance)

Inafanya **ukaguzi kadhaa wa ulinganifu kwenye cluster ya Kubernetes**. Inajumuisha msaada kwa CIS, National Security Agency (NSA) na Cybersecurity and Infrastructure Security Agency (CISA) ripoti ya kiufundi ya Cybersecurity kwa kuimarisha Kubernetes.
```bash
# Install Steampipe
brew install turbot/tap/powerpipe
brew install turbot/tap/steampipe
steampipe plugin install kubernetes

# Start the service
steampipe service start

# Install the module
mkdir dashboards
cd dashboards
powerpipe mod init
powerpipe mod install github.com/turbot/steampipe-mod-kubernetes-compliance

# Run the module
powerpipe server
```
### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) ni zana ya chanzo wazi ya K8s inayotoa single pane of glass kwa K8s katika multi-cloud, ikijumuisha uchambuzi wa hatari, uzingatiaji wa usalama, visualizer ya RBAC na ukaguzi wa udhaifu wa image. Kubescape hupima cluster za K8s, faili za YAML, na charts za HELM, ikigundua mipangilio isiyo sahihi kwa mujibu wa mifumo mbalimbali (kama the [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo) , [MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), udhaifu wa software, na ukiukwaji wa RBAC (role-based-access-control) katika hatua za mwanzo za CI/CD pipeline, inahesabu risk score papo kwa papo na inaonyesha mwelekeo wa hatari kwa muda.
```bash
curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | /bin/bash
kubescape scan --verbose
```
### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) ni utility ambayo inascan live Kubernetes cluster na **inaripoti matatizo yanayowezekana na resources na configurations zilizowekwa**. Inasafisha cluster yako kulingana na kilichowekwa na si kile kilicho kwenye diski. Kwa kuscan cluster yako, inagundua misconfigurations na inakusaidia kuhakikisha kwamba best practices ziko mahali, hivyo kuzuia shida za baadaye. Inalenga kupunguza cognitive \_over_load mtu anakutana nayo anapoendesha Kubernetes cluster katika mazingira ya wazi. Zaidi ya hayo, ikiwa cluster yako inatumia metric-server, inaripoti allocations za resources zinazoweza kuwa za ziada/ndogo na inajaribu kukutahadharisha ikiwa cluster yako itakosa capacity.

### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

The tool [**kube-bench**](https://github.com/aquasecurity/kube-bench) ni zana inayothibitisha kama Kubernetes imewekwa kwa usalama kwa kuendesha ukaguzi unaoelezwa katika [**CIS Kubernetes Benchmark**].\
Unaweza kuchagua:

- kuendesha kube-bench kutoka ndani ya container (sharing PID namespace with the host)
- kuendesha container inayosakinisha kube-bench kwenye host, kisha kuendesha kube-bench moja kwa moja kwenye host
- install the latest binaries from the [Releases page](https://github.com/aquasecurity/kube-bench/releases),
- compile it from source.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

**[DEPRECATED]** The tool [**kubeaudit**](https://github.com/Shopify/kubeaudit) ni command line tool na Go package kwa **kukagua Kubernetes clusters** kwa masuala mbalimbali ya usalama.

Kubeaudit inaweza kugundua ikiwa inakimbia ndani ya container katika cluster. Ikiwa hivyo, itajaribu kukagua all Kubernetes resources katika cluster hiyo:
```
kubeaudit all
```
Zana hii pia ina hoja `autofix` ili **kurekebisha matatizo yaliyotambuliwa moja kwa moja.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

**[HAITUMIKI]** Zana [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) hufuatilia udhaifu wa usalama katika clusters za Kubernetes. Zana ilibuniwa ili kuongeza uelewa na uwazi wa masuala ya usalama katika mazingira ya Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### [Trivy](https://github.com/aquasecurity/trivy)

[Trivy](https://github.com/aquasecurity/trivy) ina scanners zinazotafuta masuala ya usalama, na malengo ambapo inaweza kupata masuala hayo:

- Container Image
- Filesystem
- Git Repository (remote)
- Virtual Machine Image
- Kubernetes


### [**Kubei**](https://github.com/Erezf-p/kubei)

**[Inaonekana haitosimamiwa]**

[**Kubei**](https://github.com/Erezf-p/kubei) ni zana ya vulnerabilities scanning na CIS Docker benchmark ambayo inawawezesha watumiaji kupata tathmini sahihi na ya papo hapo ya hatari za kubernetes clusters zao. Kubei inascans all images ambazo zinatumiwa katika Kubernetes cluster, ikijumuisha images za application pods na system pods.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) ni zana ya kuchunguza Kubernetes cluster kwa ruhusa zenye hatari katika modeli ya uthibitishaji ya Role-based access control (RBAC) ya Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) ni zana iliyojengwa kutesta aina nyingine za ukaguzi zenye hatari kubwa ikilinganishwa na zana nyingine. Kimsingi ina modes 3 tofauti:

- **`find-role-relationships`**: Ambayo itagundua ni AWS roles zipi zinaendeshwa katika pods gani
- **`find-secrets`**: Inajitahidi kutambua secrets katika rasilimali za K8s kama Pods, ConfigMaps, na Secrets.
- **`test-imds-access`**: Itajaribu kuendesha pods na kujaribu kupata metadata v1 na v2. ONYO: Hii itaendesha pod kwenye cluster; kuwa mwangalifu sana kwa sababu huenda haukutaki kufanya hivyo!

## **Kagua IaC Code**

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) inapata security vulnerabilities, masuala ya compliance, na misconfiguration za miundombinu katika suluhisho zifuatazo za Infrastructure as Code: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM, na OpenAPI 3.0 specifications

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) ni zana ya static code analysis kwa infrastructure-as-code.

Inascans cloud infrastructure iliyotolewa kwa kutumia [Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) au [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) na inagundua security na compliance misconfigurations kwa kutumia graph-based scanning.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) ni zana inayofanya static code analysis ya Kubernetes object definitions zako.

To install:

| Usambazaji                                          | Amri / Kiungo                                                                            |
| --------------------------------------------------- | ---------------------------------------------------------------------------------------- |
| Binary zilizotengenezwa tayari kwa macOS, Linux, na Windows    | [GitHub releases](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS and Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS and Linux) | `kubectl krew install score`                                                            |

## Zana za kuchambua faili za YAML & Helm Charts

### [**Kube-linter**](https://github.com/stackrox/kube-linter)
```bash
# Install Kube-linter
brew install kube-linter

# Run Kube-linter
## lint ./path/to/yaml/or/chart
```
### [Checkov](https://github.com/bridgecrewio/checkov)
```bash
# Install Checkov
pip install checkov

# Run Checkov
checkov -d ./path/to/yaml/or/chart
```
### [kube‑score](https://github.com/zegl/kube-score)
```bash
# Install kube-score
brew install kube-score

# Run kube-score
kube-score score ./path/to/yaml
# or
helm template chart /path/to/chart | kube-score score -
# or if the chart needs some values
helm template chart /path/to/chart \
--set 'config.urls[0]=https://dummy.backend.internal' \
| kube-score score -
```
### [Kubesec](https://github.com/controlplaneio/kubesec)
```bash
# Install Kubesec
## Download from https://github.com/controlplaneio/kubesec/releases

# Run Kubesec in a yaml
kubesec scan ./path/to/yaml
# or
helm template chart /path/to/chart | kubesec scan -
# or if the chart needs some values
helm template chart /path/to/chart \
--set 'config.urls[0]=https://dummy.backend.internal' \
| kubesec scan -
```
## Vidokezo

### Kubernetes PodSecurityContext na SecurityContext

Unaweza kusanidi **security context ya Pods** (kwa _PodSecurityContext_) na ya **containers** zitakazotumika (kwa _SecurityContext_). Kwa taarifa zaidi soma:

{{#ref}}
kubernetes-securitycontext-s.md
{{#endref}}

### Kukaza usalama wa Kubernetes API

Ni muhimu sana **kulinda ufikiaji wa Kubernetes Api Server** kwani mhalifu mwenye vibali vya kutosha anaweza kuweza kuitumia vibaya na kuharibu mazingira kwa njia nyingi.\
Ni muhimu kuhakikisha usalama wa both **access** (**whitelist** origins za kufikia API Server na kukataa muunganisho mwingine wowote) na [**authentication**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (ikifuata kanuni ya **least** **privilege**). Na bila shaka **kamwe** usiruhusu **anonymous** **requests**.

Mchakato wa kawaida wa Ombi:\
User au K8s ServiceAccount –> Authentication –> Authorization –> Admission Control.

Vidokezo:

- Funga bandari.
- Epuka ufikiaji wa Anonymous.
- NodeRestriction; Hakuna ufikiaji kutoka nodes maalum kwa API.
- [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
- Kwa msingi, inazuia kubelets kuingiza/kuondoa/kusasisha labels zenye kiambishi node-restriction.kubernetes.io/. Kiambishi hiki cha label kimehifadhiwa kwa administrators kwa ajili ya kuweka lebo kwenye Node objects kwa madhumuni ya kutenganisha workloads, na kubelets hazitaruhusiwa kubadilisha labels zenye kiambishi hicho.
- Na pia, inaruhusu kubelets kuongeza/kuondoa/kusasisha label hizi na viambishi vya lebo.
- Hakikisha utenganisho salama wa workloads kwa kutumia lebo.
- Zuia pods maalum kupata ufikiaji wa API.
- Epuka kuonyesha ApiServer kwenye intaneti.
- Epuka ufikiaji usioidhinishwa kwa RBAC.
- Weka bandari ya ApiServer nyuma ya firewall na fanya IP whitelisting.

### Kukaza SecurityContext

Kwa default mtumiaji root atatumika wakati Pod inapoanzishwa ikiwa hakuna mtumiaji mwingine ameainishwa. Unaweza kuendesha application yako ndani ya context yenye usalama zaidi ukitumia template inayofanana na ile ifuatayo:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
- [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
- [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Kuimarisha kwa jumla

Unapaswa kusasisha mazingira yako ya Kubernetes mara kwa mara kadri inavyohitajika ili kuwa na:

- Tegemezi zikiwa za kisasa.
- Patch za hitilafu (bug) na usalama.

[**Release cycles**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Kila miezi 3 kuna toleo ndogo jipya -- 1.20.3 = 1(Major).20(Minor).3(patch)

**Njia bora ya kusasisha Kubernetes Cluster ni (kutoka** [**here**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

- Sasisha vipengele vya Master Node kwa kufuata mfuatano huu:
- etcd (instances zote).
- kube-apiserver (host zote za control plane).
- kube-controller-manager.
- kube-scheduler.
- cloud controller manager, ikiwa unatumia moja.
- Sasisha vipengele vya Worker Node kama kube-proxy, kubelet.

## Kubernetes ufuatiliaji na usalama:

- Kyverno Policy Engine
- Cilium Tetragon - Observability ya usalama inayotegemea eBPF na utekelezaji wakati wa runtime
- Sera za Usalama za Mtandao
- Falco - Ufuatiliaji wa usalama wakati wa runtime na utambuzi

{{#include ../../../banners/hacktricks-training.md}}
