# Kubernetes Hardening

{{#include ../../../banners/hacktricks-training.md}}

## Εργαλεία για ανάλυση ενός cluster

### [**Steampipe - Kubernetes Compliance](https://github.com/turbot/steampipe-mod-kubernetes-compliance)

Θα **εκτελέσει αρκετούς ελέγχους συμμόρφωσης πάνω στο Kubernetes cluster**. Περιλαμβάνει υποστήριξη για CIS, Εθνική Υπηρεσία Ασφαλείας (NSA) και την Υπηρεσία Κυβερνοασφάλειας και Ασφάλειας Υποδομών (CISA) τεχνική αναφορά για την ενίσχυση της ασφάλειας του Kubernetes.
```bash
# Install Steampipe
brew install turbot/tap/powerpipe
brew install turbot/tap/steampipe
steampipe plugin install kubernetes

# Start the service
steampipe service start

# Install the module
mkdir dashboards
cd dashboards
powerpipe mod init
powerpipe mod install github.com/turbot/steampipe-mod-kubernetes-compliance

# Run the module
powerpipe server
```
### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) είναι ένα εργαλείο ανοιχτού κώδικα K8s που παρέχει μια ενιαία οθόνη πολλαπλών σύννεφων K8s, συμπεριλαμβανομένης της ανάλυσης κινδύνου, της συμμόρφωσης ασφαλείας, του οπτικοποιητή RBAC και της σάρωσης ευπαθειών εικόνας. Το Kubescape σαρώνει τα K8s clusters, τα αρχεία YAML και τα HELM charts, ανιχνεύοντας κακοδιαμορφώσεις σύμφωνα με πολλαπλά πλαίσια (όπως το [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo) , [MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), ευπάθειες λογισμικού και παραβιάσεις RBAC (role-based-access-control) σε πρώιμα στάδια της CI/CD pipeline, υπολογίζει άμεσα το σκορ κινδύνου και δείχνει τις τάσεις κινδύνου με την πάροδο του χρόνου.
```bash
curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | /bin/bash
kubescape scan --verbose
```
### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) είναι ένα εργαλείο που σκανάρει ζωντανά Kubernetes clusters και **αναφέρει πιθανά προβλήματα με τους αναπτυγμένους πόρους και τις ρυθμίσεις**. Καθαρίζει το cluster σας με βάση το τι είναι αναπτυγμένο και όχι το τι βρίσκεται στον δίσκο. Σαρώνοντας το cluster σας, ανιχνεύει κακές ρυθμίσεις και σας βοηθά να διασφαλίσετε ότι οι καλύτερες πρακτικές είναι σε εφαρμογή, αποτρέποντας έτσι μελλοντικά προβλήματα. Στοχεύει στη μείωση της γνωστικής \_over_load που αντιμετωπίζει κανείς όταν λειτουργεί ένα Kubernetes cluster σε πραγματικές συνθήκες. Επιπλέον, αν το cluster σας χρησιμοποιεί έναν metric-server, αναφέρει πιθανά υπερβολικά/υπο-κατανεμημένα πόρους και προσπαθεί να σας προειδοποιήσει αν το cluster σας εξαντληθεί από χωρητικότητα.

### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Το εργαλείο [**kube-bench**](https://github.com/aquasecurity/kube-bench) είναι ένα εργαλείο που ελέγχει αν το Kubernetes είναι αναπτυγμένο με ασφάλεια εκτελώντας τους ελέγχους που τεκμηριώνονται στο [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Μπορείτε να επιλέξετε να:

- εκτελέσετε το kube-bench από μέσα σε ένα container (μοιράζοντας το PID namespace με τον host)
- εκτελέσετε ένα container που εγκαθιστά το kube-bench στον host, και στη συνέχεια να εκτελέσετε το kube-bench απευθείας στον host
- εγκαταστήσετε τα τελευταία binaries από τη [σελίδα Releases](https://github.com/aquasecurity/kube-bench/releases),
- το συντάξετε από πηγή.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

**[DEPRECATED]** Το εργαλείο [**kubeaudit**](https://github.com/Shopify/kubeaudit) είναι ένα εργαλείο γραμμής εντολών και ένα πακέτο Go για **έλεγχο των Kubernetes clusters** για διάφορες διαφορετικές ανησυχίες ασφαλείας.

Το Kubeaudit μπορεί να ανιχνεύσει αν εκτελείται μέσα σε ένα container σε ένα cluster. Αν ναι, θα προσπαθήσει να ελέγξει όλους τους πόρους Kubernetes σε αυτό το cluster:
```
kubeaudit all
```
Αυτό το εργαλείο έχει επίσης το επιχείρημα `autofix` για **αυτόματη διόρθωση ανιχνευμένων προβλημάτων.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

**[DEPRECATED]** Το εργαλείο [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) αναζητά αδυναμίες ασφαλείας σε κλάστερ Kubernetes. Το εργαλείο αναπτύχθηκε για να αυξήσει την ευαισθητοποίηση και την ορατότητα για ζητήματα ασφαλείας σε περιβάλλοντα Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### [Trivy](https://github.com/aquasecurity/trivy)

[Trivy](https://github.com/aquasecurity/trivy) έχει σαρωτές που αναζητούν ζητήματα ασφάλειας και στόχους όπου μπορεί να βρει αυτά τα ζητήματα:

- Εικόνα κοντέινερ
- Σύστημα αρχείων
- Αποθετήριο Git (απομακρυσμένο)
- Εικόνα εικονικής μηχανής
- Kubernetes


### [**Kubei**](https://github.com/Erezf-p/kubei)

**[Φαίνεται ότι δεν συντηρείται]**

[**Kubei**](https://github.com/Erezf-p/kubei) είναι ένα εργαλείο σάρωσης ευπαθειών και CIS Docker benchmark που επιτρέπει στους χρήστες να αποκτούν μια ακριβή και άμεση εκτίμηση κινδύνου των κλάστερ Kubernetes τους. Το Kubei σαρώσει όλες τις εικόνες που χρησιμοποιούνται σε ένα κλάστερ Kubernetes, συμπεριλαμβανομένων των εικόνων των pods εφαρμογών και των pods συστήματος.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) είναι ένα εργαλείο για τη σάρωση του κλάστερ Kubernetes για επικίνδυνες άδειες στο μοντέλο εξουσιοδότησης Role-based access control (RBAC) του Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) είναι ένα εργαλείο που έχει κατασκευαστεί για να δοκιμάσει άλλους τύπους ελέγχων υψηλού κινδύνου σε σύγκριση με τα άλλα εργαλεία. Έχει κυρίως 3 διαφορετικούς τρόπους:

- **`find-role-relationships`**: Που θα βρει ποιες ρόλοι AWS εκτελούνται σε ποια pods
- **`find-secrets`**: Που προσπαθεί να εντοπίσει μυστικά σε πόρους K8s όπως Pods, ConfigMaps και Secrets.
- **`test-imds-access`**: Που θα προσπαθήσει να εκτελέσει pods και να προσπαθήσει να αποκτήσει πρόσβαση στα μεταδεδομένα v1 και v2. ΠΡΟΕΙΔΟΠΟΙΗΣΗ: Αυτό θα εκτελέσει ένα pod στο κλάστερ, να είστε πολύ προσεκτικοί γιατί ίσως δεν θέλετε να το κάνετε αυτό!

## **Audit IaC Code**

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) βρίσκει **ευπάθειες ασφαλείας**, ζητήματα συμμόρφωσης και κακοδιαρθρώσεις υποδομής στις παρακάτω **λύσεις Infrastructure as Code**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM και προδιαγραφές OpenAPI 3.0

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) είναι ένα εργαλείο στατικής ανάλυσης κώδικα για infrastructure-as-code.

Σαρώσει την υποδομή του cloud που έχει παρασχεθεί χρησιμοποιώντας [Terraform](https://terraform.io), σχέδιο Terraform, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) ή [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) και ανιχνεύει κακοδιαρθρώσεις ασφαλείας και συμμόρφωσης χρησιμοποιώντας σάρωση βασισμένη σε γράφους.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) είναι ένα εργαλείο που εκτελεί στατική ανάλυση κώδικα των ορισμών αντικειμένων Kubernetes σας.

Για να εγκαταστήσετε:

| Διανομή                                            | Εντολή / Σύνδεσμος                                                                         |
| --------------------------------------------------- | ------------------------------------------------------------------------------------------ |
| Προκατασκευασμένα δυαδικά αρχεία για macOS, Linux και Windows | [GitHub releases](https://github.com/zegl/kube-score/releases)                             |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/)  |
| Homebrew (macOS και Linux)                          | `brew install kube-score`                                                                  |
| [Krew](https://krew.sigs.k8s.io/) (macOS και Linux) | `kubectl krew install score`                                                               |

## Tips

### Kubernetes PodSecurityContext και SecurityContext

Μπορείτε να διαμορφώσετε το **security context των Pods** (με _PodSecurityContext_) και των **κοντέινερ** που πρόκειται να εκτελούνται (με _SecurityContext_). Για περισσότερες πληροφορίες διαβάστε:

{{#ref}}
kubernetes-securitycontext-s.md
{{#endref}}

### Kubernetes API Hardening

Είναι πολύ σημαντικό να **προστατεύσετε την πρόσβαση στον Kubernetes Api Server** καθώς ένας κακόβουλος παράγοντας με αρκετά προνόμια θα μπορούσε να είναι σε θέση να το καταχραστεί και να προκαλέσει ζημιά με πολλούς τρόπους στο περιβάλλον.\
Είναι σημαντικό να ασφαλίσετε τόσο την **πρόσβαση** (**whitelist** προελεύσεις για πρόσβαση στον API Server και να απορρίψετε οποιαδήποτε άλλη σύνδεση) όσο και την [**αυθεντικοποίηση**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (ακολουθώντας την αρχή της **ελάχιστης** **εξουσίας**). Και σίγουρα **ποτέ** **μην** **επιτρέπετε** **ανώνυμες** **αιτήσεις**.

**Κοινή διαδικασία Αίτησης:**\
Χρήστης ή K8s ServiceAccount –> Αυθεντικοποίηση –> Εξουσιοδότηση –> Έλεγχος Εισόδου.

**Συμβουλές**:

- Κλείστε τις θύρες.
- Αποφύγετε την ανώνυμη πρόσβαση.
- NodeRestriction; Καμία πρόσβαση από συγκεκριμένους κόμβους στον API.
- [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
- Βασικά αποτρέπει τους kubelets από το να προσθέτουν/αφαιρούν/ενημερώνουν ετικέτες με ένα prefix node-restriction.kubernetes.io/. Αυτό το prefix ετικέτας είναι επιφυλαγμένο για τους διαχειριστές για να ετικετοποιούν τα αντικείμενα Node τους για σκοπούς απομόνωσης φορτίου εργασίας, και οι kubelets δεν θα επιτρέπεται να τροποποιούν ετικέτες με αυτό το prefix.
- Και επίσης, επιτρέπει στους kubelets να προσθέτουν/αφαιρούν/ενημερώνουν αυτές τις ετικέτες και τα prefix ετικετών.
- Διασφαλίστε με ετικέτες την ασφαλή απομόνωση φορτίου εργασίας.
- Αποφύγετε συγκεκριμένα pods από την πρόσβαση στο API.
- Αποφύγετε την έκθεση του ApiServer στο διαδίκτυο.
- Αποφύγετε την μη εξουσιοδοτημένη πρόσβαση RBAC.
- Θύρα ApiServer με τείχος προστασίας και whitelist IP.

### SecurityContext Hardening

Από προεπιλογή, ο χρήστης root θα χρησιμοποιείται όταν ξεκινά ένα Pod αν δεν έχει καθοριστεί άλλος χρήστης. Μπορείτε να εκτελέσετε την εφαρμογή σας μέσα σε ένα πιο ασφαλές περιβάλλον χρησιμοποιώντας ένα πρότυπο παρόμοιο με το παρακάτω:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
- [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
- [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Γενική Σκληροποίηση

Πρέπει να ενημερώνετε το περιβάλλον Kubernetes σας όσο συχνά είναι απαραίτητο για να έχετε:

- Εξαρτήσεις ενημερωμένες.
- Διορθώσεις σφαλμάτων και ασφαλείας.

[**Κύκλοι κυκλοφορίας**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Κάθε 3 μήνες υπάρχει μια νέα μικρή κυκλοφορία -- 1.20.3 = 1(Μεγάλο).20(Μικρό).3(διορθωτική)

**Ο καλύτερος τρόπος για να ενημερώσετε ένα Kubernetes Cluster είναι (από** [**εδώ**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

- Αναβαθμίστε τα συστατικά του Master Node ακολουθώντας αυτή τη σειρά:
- etcd (όλες οι περιπτώσεις).
- kube-apiserver (όλοι οι κεντρικοί υπολογιστές ελέγχου).
- kube-controller-manager.
- kube-scheduler.
- cloud controller manager, αν χρησιμοποιείτε.
- Αναβαθμίστε τα συστατικά του Worker Node όπως kube-proxy, kubelet.

## Παρακολούθηση & ασφάλεια Kubernetes:

- Kyverno Policy Engine
- Cilium Tetragon - eBPF-based Security Observability and Runtime Enforcement
- Πολιτικές Ασφαλείας Δικτύου
- Falco - Παρακολούθηση & ανίχνευση ασφάλειας σε πραγματικό χρόνο

{{#include ../../../banners/hacktricks-training.md}}
