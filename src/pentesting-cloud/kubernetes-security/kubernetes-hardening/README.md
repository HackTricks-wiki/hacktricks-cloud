# Kubernetes Verharding

{{#include ../../../banners/hacktricks-training.md}}

## Gereedskap om 'n cluster te ontleed

### [Steampipe - Kubernetes Compliance](https://github.com/turbot/steampipe-mod-kubernetes-compliance)

Dit sal **verskeie nakomingskontroles op die Kubernetes-cluster** uitvoer. Dit sluit ondersteuning in vir CIS, die National Security Agency (NSA) en die Cybersecurity and Infrastructure Security Agency (CISA) se Cybersecurity-tegniese verslag vir Kubernetes-verharding.
```bash
# Install Steampipe
brew install turbot/tap/powerpipe
brew install turbot/tap/steampipe
steampipe plugin install kubernetes

# Start the service
steampipe service start

# Install the module
mkdir dashboards
cd dashboards
powerpipe mod init
powerpipe mod install github.com/turbot/steampipe-mod-kubernetes-compliance

# Run the module
powerpipe server
```
### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) is 'n open-source K8s-hulpmiddel wat 'n multi-cloud K8s enkele beheerpaneel bied, insluitend risiko-analise, sekuriteitsnakoming, RBAC-visualiseerder en skandering vir image-kwesbaarhede. Kubescape skandeer K8s-klusters, YAML-lêers en HELM-charts, bespeur wankonfigurasies volgens verskeie raamwerke (such as the [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo) , [MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), sagteware-kwesbaarhede en RBAC (role-based-access-control) oortredings in vroeë stadiums van die CI/CD-pyplyn, bereken onmiddellik 'n risikoscore en wys risikoneigings oor tyd.
```bash
curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | /bin/bash
kubescape scan --verbose
```
### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) is 'n nutsfoefie wat lewendige Kubernetes-clusters skandeer en **meld potensiële probleme met uitgerolde bronne en konfigurasies**. Dit sanitiseer jou cluster op grond van wat uitgerol is en nie wat op die skyf lê nie. Deur jou cluster te skandeer, ontdek dit verkeerde konfigurasies en help dit jou om te verseker dat beste praktyke geïmplementeer is, wat toekomstige hoofpyne voorkom. Dit poog om die kognitiewe \_oorlaai te verminder wat iemand ervaar wanneer 'n Kubernetes-cluster in die veld bedryf word. Verder, as jou cluster 'n metric-server gebruik, rapporteer dit potensiële oor-/onder-toekennings van hulpbronne en probeer dit jou waarsku sou jou cluster opraak van kapasiteit.

### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Die hulpmiddel [**kube-bench**](https://github.com/aquasecurity/kube-bench) is 'n instrument wat nagaan of Kubernetes veilig uitgerol is deur die kontrole uit te voer wat in die [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/) gedokumenteer is.\
Jy kan kies om:

- voer kube-bench uit van binne 'n container (deel PID namespace met die host)
- voer 'n container uit wat kube-bench op die host installeer, en voer dan kube-bench direk op die host uit
- installeer die nuutste binaries vanaf die [Releases page](https://github.com/aquasecurity/kube-bench/releases),
- kompileer dit vanaf bronkode.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

**[DEPRECATED]** Die hulpmiddel [**kubeaudit**](https://github.com/Shopify/kubeaudit) is 'n command line tool en 'n Go-pakket om **oudit Kubernetes-klusters** vir verskeie sekuriteitskwessies.

Kubeaudit kan opspoor of dit binne 'n container in 'n cluster loop. Indien wel, sal dit probeer om alle Kubernetes-hulpbronne in daardie cluster te oudit:
```
kubeaudit all
```
Hierdie hulpmiddel het ook die argument `autofix` om **opgespoorde probleme outomaties reg te stel.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

**[DEPRECATED]** Die hulpmiddel [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) soek na sekuriteitskwesbaarhede in Kubernetes clusters. Die hulpmiddel is ontwikkel om die bewustheid en sigbaarheid van sekuriteitskwessies in Kubernetes-omgewings te verhoog.
```bash
kube-hunter --remote some.node.com
```
### [Trivy](https://github.com/aquasecurity/trivy)

[Trivy](https://github.com/aquasecurity/trivy) het skandeerders wat na sekuriteitsprobleme soek, en teikens waar dit die probleme kan vind:

- Container Image
- Lêerstelsel
- Git-bewaarplek (afgeleë)
- Virtuele masjienbeeld
- Kubernetes


### [**Kubei**](https://github.com/Erezf-p/kubei)

**[Lyk ononderhou]**

[**Kubei**](https://github.com/Erezf-p/kubei) is 'n hulpmiddel vir die skandering van kwesbaarhede en 'n CIS Docker-benchmark wat gebruikers in staat stel om 'n akkurate en onmiddellike risiko-assessering van hul Kubernetes-klusters te kry. Kubei skandeer alle beelde wat in 'n Kubernetes-kluster gebruik word, insluitend beelde van toepassings-pods en stelsel-pods.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) is 'n hulpmiddel om Kubernetes-klusters na riskante toestemmings te skandeer binne Kubernetes se rolgebaseerde toegangbeheer (RBAC) magtigingsmodel.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) is 'n instrument wat gebou is om ander tipes hoërisiko-kontroles te toets in vergelyking met die ander gereedskap. Dit het hoofsaaklik 3 verskillende modusse:

- **`find-role-relationships`**: Wat sal opspoor watter AWS-rolle in watter pods uitgevoer word
- **`find-secrets`**: Wat probeer om geheime in K8s-hulpbronne soos Pods, ConfigMaps, en Secrets te identifiseer.
- **`test-imds-access`**: Wat sal probeer om pods te laat loop en toegang tot die metadata v1 en v2 te kry. WAARSKUWING: Dit sal 'n pod in die kluster laat loop; wees baie versigtig aangesien jy dit dalk nie wil doen nie!


## **Oudit IaC-kode**

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) vind **sekuriteitskwesbaarhede**, nakomingsprobleme, en infrastruktuurverkeerde konfigurasies in die volgende **Infrastructure as Code-oplossings**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM, en OpenAPI 3.0 spesifikasies

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) is 'n statiese kode-analisehulpmiddel vir infrastructure-as-code.

Dit skandeer wolkinfrastruktuur wat voorsien word met behulp van [Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) of [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) en ontdek sekuriteits- en nakomingskonfigurasies deur grafgebaseerde skandering.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) is 'n hulpmiddel wat statiese kode-analise van jou Kubernetes-objekdefinisies uitvoer.

Om te installeer:

| Distribution                                        | Command / Link                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Pre-built binaries for macOS, Linux, and Windows    | [GitHub releases](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS and Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS and Linux) | `kubectl krew install score`                                                            |

## Gereedskap om YAML-lêers & Helm Charts te ontleed

### [**Kube-linter**](https://github.com/stackrox/kube-linter)
```bash
# Install Kube-linter
brew install kube-linter

# Run Kube-linter
## lint ./path/to/yaml/or/chart
```
### [Checkov](https://github.com/bridgecrewio/checkov)
```bash
# Install Checkov
pip install checkov

# Run Checkov
checkov -d ./path/to/yaml/or/chart
```
### [kube‑score](https://github.com/zegl/kube-score)
```bash
# Install kube-score
brew install kube-score

# Run kube-score
kube-score score ./path/to/yaml
# or
helm template chart /path/to/chart | kube-score score -
# or if the chart needs some values
helm template chart /path/to/chart \
--set 'config.urls[0]=https://dummy.backend.internal' \
| kube-score score -
```
### [Kubesec](https://github.com/controlplaneio/kubesec)
```bash
# Install Kubesec
## Download from https://github.com/controlplaneio/kubesec/releases

# Run Kubesec in a yaml
kubesec scan ./path/to/yaml
# or
helm template chart /path/to/chart | kubesec scan -
# or if the chart needs some values
helm template chart /path/to/chart \
--set 'config.urls[0]=https://dummy.backend.internal' \
| kubesec scan -
```
## Wenke

### Kubernetes PodSecurityContext and SecurityContext

Jy kan die **sekuriteitskonteks van die Pods** (met _PodSecurityContext_) en van die **containers** wat uitgevoer gaan word (met _SecurityContext_) configureer. Vir meer inligting lees:

{{#ref}}
kubernetes-securitycontext-s.md
{{#endref}}

### Kubernetes API Hardening

Dit is baie belangrik om die **toegang tot die Kubernetes Api Server te beskerm** aangesien 'n kwaadwillige akteur met genoeg voorregte dit kan misbruik en op baie maniere skade aan die omgewing kan aanrig.\
Dit is belangrik om beide die **toegang** (**whitelist** oorspronge om toegang tot die API Server te verleen en enige ander konneksie te weier) en die [**authentication**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (volgens die beginsel van **minste** **voorregte**) te beveilig. En beslis **nooit** **anonieme** **versoeke** toelaat nie.

**Algemene versoekproses:**\
Gebruiker of K8s ServiceAccount –> Authentication –> Authorization –> Admission Control.

**Wenke**:

- Sluit poorte.
- Vermy anonieme toegang.
- NodeRestriction; Geen toegang vanaf spesifieke nodes tot die API.
- [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
- Verhoed in die praktyk dat kubelets labels met 'n node-restriction.kubernetes.io/ prefix byvoeg/verwyder/opdateer. Hierdie label-prefix is gereserveer vir administrateurs om hul Node-objekte te label vir werkbelasting-isolasiedoeleindes, en kubelets sal nie toegelaat word om labels met daardie prefix te wysig nie.
- En ook, laat kubelets toe om hierdie labels en label-prefixe by te voeg/verwyder/opdateer.
- Sorg met labels vir veilige werkbelasting-isolasie.
- Voorkom dat sekere pods toegang tot die API het.
- Voorkom ApiServer-blootstelling aan die internet.
- Voorkom ongemagtigde toegang via RBAC.
- Beskerm die ApiServer-poort met 'n firewall en IP-whitelisting.

### SecurityContext Hardening

Per verstek sal die root-gebruiker gebruik word wanneer 'n Pod begin word as geen ander gebruiker gespesifiseer is nie. Jy kan jou toepassing binne 'n meer veilige konteks laat loop deur 'n sjabloon soortgelyk aan die volgende te gebruik:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
- [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
- [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Algemene Verharding

Jy moet jou Kubernetes-omgewing so gereeld as nodig opdateer om te hê:

- Afhanklikhede op datum.
- Fout- en sekuriteitspatches.

[**Release cycles**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Elke 3 maande is daar 'n nuwe minor release -- 1.20.3 = 1(Major).20(Minor).3(patch)

**Die beste manier om 'n Kubernetes Cluster op te dateer is (van** [**here**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

- Werk die Master Node-komponente op volgens hierdie volgorde:
- etcd (alle instansies).
- kube-apiserver (alle control plane-hosts).
- kube-controller-manager.
- kube-scheduler.
- cloud controller manager, indien jy een gebruik.
- Werk die Worker Node-komponente op, soos kube-proxy, kubelet.

## Kubernetes monitering & sekuriteit:

- Kyverno Policy Engine
- Cilium Tetragon - eBPF-gebaseerde sekuriteitswaarneembaarheid en runtime-dwinging
- Network Security Policies
- Falco - Runtime-sekuriteitsmonitering & opsporing

{{#include ../../../banners/hacktricks-training.md}}
