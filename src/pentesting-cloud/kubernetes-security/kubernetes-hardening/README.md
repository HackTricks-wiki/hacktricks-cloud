# Kubernetes Sertleştirme

{{#include ../../../banners/hacktricks-training.md}}

## Bir kümeyi analiz etmek için araçlar

### [Steampipe - Kubernetes Compliance](https://github.com/turbot/steampipe-mod-kubernetes-compliance)

Kubernetes kümesi üzerinde **birkaç uyumluluk kontrolü** yapar. CIS, National Security Agency (NSA) ve Cybersecurity and Infrastructure Security Agency (CISA) tarafından Kubernetes sertleştirmesi için hazırlanmış siber güvenlik teknik raporlarını destekler.
```bash
# Install Steampipe
brew install turbot/tap/powerpipe
brew install turbot/tap/steampipe
steampipe plugin install kubernetes

# Start the service
steampipe service start

# Install the module
mkdir dashboards
cd dashboards
powerpipe mod init
powerpipe mod install github.com/turbot/steampipe-mod-kubernetes-compliance

# Run the module
powerpipe server
```
### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) risk analizi, güvenlik uyumluluğu, RBAC görselleştirici ve image zafiyet taraması da dahil olmak üzere çoklu bulut K8s için tek bir görünüm sağlayan açık kaynaklı bir K8s aracıdır. Kubescape, K8s cluster'larını, YAML dosyalarını ve HELM chart'larını tarar, (such as the [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo) , [MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)) gibi birden çok framework'e göre yanlış yapılandırmaları, yazılım zafiyetlerini ve CI/CD pipeline'ın erken aşamalarındaki RBAC (role-based-access-control) ihlallerini tespit eder, risk skorunu anında hesaplar ve zaman içindeki risk eğilimlerini gösterir.
```bash
curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | /bin/bash
kubescape scan --verbose
```
### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) canlı bir Kubernetes cluster'ını tarayan ve **dağıtılan kaynaklar ve yapılandırmalarla ilgili potansiyel sorunları raporlayan** bir yardımcı programdır. Kümenizi diskte ne olduğuna değil, dağıtılmış olanlara göre temizler. Kümenizi tarayarak yanlış yapılandırmaları tespit eder ve en iyi uygulamaların uygulanmasını sağlamanıza yardımcı olur; böylece gelecekteki sorunları önler. Bir Kubernetes kümesini sahada işletirken karşılaşılan bilişsel \_over_load'u azaltmayı hedefler. Ayrıca, kümeniz metric-server kullanıyorsa, olası kaynak fazla/az tahsislerini bildirir ve kümeniz kapasite tükenirse sizi uyarmaya çalışır.

### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Araç [**kube-bench**](https://github.com/aquasecurity/kube-bench), Kubernetes'in [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/)’te belgelenen kontrolleri çalıştırarak güvenli bir şekilde dağıtılıp dağıtılmadığını denetleyen bir araçtır.\
Şunlardan birini seçebilirsiniz:

- kube-bench'i bir container içinde çalıştırmak (host ile PID namespace paylaşımıyla)
- kube-bench'i host'a kuran bir container çalıştırmak ve ardından kube-bench'i doğrudan host üzerinde çalıştırmak
- en son binary'leri [Releases page](https://github.com/aquasecurity/kube-bench/releases) sayfasından kurmak,
- kaynaktan derlemek.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

**[DEPRECATED]** Araç [**kubeaudit**](https://github.com/Shopify/kubeaudit), çeşitli güvenlik konuları için **Kubernetes kümelerini denetlemek** üzere kullanılan bir komut satırı aracı ve bir Go paketidir.

Kubeaudit kendisinin bir cluster içindeki bir container içinde çalışıp çalışmadığını tespit edebilir. Eğer öyleyse, o cluster'daki tüm Kubernetes kaynaklarını denetlemeye çalışacaktır:
```
kubeaudit all
```
Bu araç ayrıca tespit edilen sorunları **otomatik olarak düzeltmek** için `autofix` argümanına sahiptir.

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

**[DEPRECATED]** Araç [**kube-hunter**](https://github.com/aquasecurity/kube-hunter), Kubernetes kümelerindeki güvenlik zayıflıklarını araştırır. Araç, Kubernetes ortamlarındaki güvenlik sorunları konusunda farkındalık ve görünürlük sağlamak amacıyla geliştirilmiştir.
```bash
kube-hunter --remote some.node.com
```
### [Trivy](https://github.com/aquasecurity/trivy)

[Trivy](https://github.com/aquasecurity/trivy) güvenlik sorunlarını arayan tarayıcılara sahiptir ve bu sorunları bulabileceği hedefler şunlardır:

- Container görüntüsü
- Dosya sistemi
- Git deposu (uzak)
- Sanal makine görüntüsü
- Kubernetes


### [**Kubei**](https://github.com/Erezf-p/kubei)

**[Bakımı yapılmıyor gibi görünüyor]**

[**Kubei**](https://github.com/Erezf-p/kubei) kullanıcılara kubernetes kümelerinin doğru ve anlık bir risk değerlendirmesini almasını sağlayan bir zafiyet tarama ve CIS Docker benchmark aracıdır. Kubei, uygulama pod'larının ve sistem pod'larının imajları dahil olmak üzere bir Kubernetes kümesinde kullanılan tüm imajları tarar.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) Kubernetes'in Role-based access control (RBAC) yetkilendirme modelindeki riskli izinleri taramak için bir araçtır.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) diğer araçlarla karşılaştırıldığında farklı türde yüksek riskli kontrolleri test etmek için oluşturulmuş bir araçtır. Temelde 3 farklı moda sahiptir:

- **`find-role-relationships`**: Hangi AWS rollerinin hangi pod'larda çalıştığını bulur
- **`find-secrets`**: Pod'lar, ConfigMaps ve Secrets gibi K8s kaynaklarındaki secret'ları tanımlamaya çalışır.
- **`test-imds-access`**: Pod'ları çalıştırmayı ve metadata v1 ile v2'ye erişmeyi deneyecektir. UYARI: Bu, kümede bir pod çalıştıracaktır; çok dikkatli olun çünkü bunu yapmak istemeyebilirsiniz!

## **IaC Kodunu Denetle**

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) aşağıdaki **Infrastructure as Code çözümlerinde** **güvenlik açıklarını**, uyumluluk sorunlarını ve altyapı yanlış yapılandırmalarını bulur: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM ve OpenAPI 3.0 spesifikasyonları

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) infrastructure-as-code için bir statik kod analizi aracıdır.

[Terraform](https://terraform.io), Terraform planı, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) veya [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) kullanılarak sağlanan bulut altyapısını tarar ve grafik tabanlı tarama kullanarak güvenlik ve uyumluluk yanlış yapılandırmalarını tespit eder.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) Kubernetes nesne tanımlarınızın statik kod analizini gerçekleştiren bir araçtır.

Kurulum:

| Dağıtım                                             | Komut / Bağlantı                                                                         |
| --------------------------------------------------- | ---------------------------------------------------------------------------------------- |
| macOS, Linux ve Windows için önceden derlenmiş ikili dosyalar | [GitHub releases](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS and Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS and Linux) | `kubectl krew install score`                                                            |

## YAML dosyalarını ve Helm Charts'ı analiz etmek için araçlar

### [**Kube-linter**](https://github.com/stackrox/kube-linter)
```bash
# Install Kube-linter
brew install kube-linter

# Run Kube-linter
## lint ./path/to/yaml/or/chart
```
### [Checkov](https://github.com/bridgecrewio/checkov)
```bash
# Install Checkov
pip install checkov

# Run Checkov
checkov -d ./path/to/yaml/or/chart
```
### [kube‑score](https://github.com/zegl/kube-score)
```bash
# Install kube-score
brew install kube-score

# Run kube-score
kube-score score ./path/to/yaml
# or
helm template chart /path/to/chart | kube-score score -
# or if the chart needs some values
helm template chart /path/to/chart \
--set 'config.urls[0]=https://dummy.backend.internal' \
| kube-score score -
```
### [Kubesec](https://github.com/controlplaneio/kubesec)
```bash
# Install Kubesec
## Download from https://github.com/controlplaneio/kubesec/releases

# Run Kubesec in a yaml
kubesec scan ./path/to/yaml
# or
helm template chart /path/to/chart | kubesec scan -
# or if the chart needs some values
helm template chart /path/to/chart \
--set 'config.urls[0]=https://dummy.backend.internal' \
| kubesec scan -
```
## İpuçları

### Kubernetes PodSecurityContext ve SecurityContext

Pod'ların **security context'ini** ( _PodSecurityContext_ ile) ve çalıştırılacak **konteynerlerin** **security context'ini** ( _SecurityContext_ ile) yapılandırabilirsiniz. Daha fazla bilgi için okuyun:

{{#ref}}
kubernetes-securitycontext-s.md
{{#endref}}

### Kubernetes API Sertleştirme

Kubernetes Api Server erişimini korumak çok önemlidir; yeterli ayrıcalığa sahip kötü niyetli bir aktör bunu kötüye kullanarak ortama birçok şekilde zarar verebilir.\
Hem **erişimi** (API Server'a erişim için originleri **whitelist** yapıp diğer bağlantıları reddetmek) hem de [**authentication**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) güvence altına alınmalıdır ( **least** **privilege** ilkesine uygun olarak). Ve kesinlikle **asla** **anonim** **isteklere** izin vermeyin.

**Ortak İstek süreci:**\
Kullanıcı veya K8s ServiceAccount –> Authentication –> Authorization –> Admission Control.

**İpuçları**:

- Portları kapatın.
- Anonim erişimden kaçının.
- NodeRestriction; belirli node'lardan API'ye erişimi engeller.
- [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
- Temelde kubelet'lerin node-restriction.kubernetes.io/ önekiyle etiket eklemesini/kaldırmasını/güncellemesini engeller. Bu etiket öneki, yöneticilerin Node nesnelerini iş yükü izolasyonu amaçlarıyla etiketlemeleri için ayrılmıştır ve kubelet'lerin bu önekle etiketleri değiştirmesine izin verilmeyecektir.
- Ve ayrıca, kubelet'lerin bu etiketleri ve etiket öneklerini ekleyip/kaldırıp/güncellemesine izin verir.
- Etiketlerle güvenli iş yükü izolasyonunu sağlayın.
- Belirli pod'ların API erişimini engelleyin.
- ApiServer'ın internete maruz kalmasını önleyin.
- Yetkisiz erişime karşı RBAC uygulayın.
- ApiServer portunu firewall ve IP whitelisting ile koruyun.

### SecurityContext Sertleştirme

Varsayılan olarak, başka bir kullanıcı belirtilmemişse bir Pod başlatıldığında root kullanıcısı kullanılır. Uygulamanızı aşağıdakine benzer bir şablon kullanarak daha güvenli bir context içinde çalıştırabilirsiniz:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
- [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
- [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Genel Sertleştirme

Kubernetes ortamınızı aşağıdakilere sahip olacak şekilde gerektiği sıklıkta güncellemelisiniz:

- Bağımlılıkların güncel olması.
- Hata ve güvenlik yamaları.

[**Release cycles**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Her 3 ayda bir yeni bir minor release yayımlanır -- 1.20.3 = 1(Major).20(Minor).3(patch)

**Bir Kubernetes Cluster'ını güncellemenin en iyi yolu (kaynak olarak** [**here**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

- Master Node bileşenlerini şu sırayla yükseltin:
- etcd (tüm örnekler).
- kube-apiserver (tüm kontrol düzlemi host'ları).
- kube-controller-manager.
- kube-scheduler.
- cloud controller manager (kullanıyorsanız).
- Worker Node bileşenlerini, örn. kube-proxy, kubelet, yükseltin.

## Kubernetes izleme ve güvenlik:

- Kyverno Policy Engine
- Cilium Tetragon - eBPF-based Security Observability and Runtime Enforcement
- Network Security Policies
- Falco - Çalışma zamanı güvenlik izleme ve tespiti

{{#include ../../../banners/hacktricks-training.md}}
