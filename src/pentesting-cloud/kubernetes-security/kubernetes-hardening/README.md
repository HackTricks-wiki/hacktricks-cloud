# Kubernetes-Härtung

{{#include ../../../banners/hacktricks-training.md}}

## Tools zur Analyse eines Clusters

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) ist ein K8s Open-Source-Tool, das eine Multi-Cloud-K8s-Einzelansicht bietet, einschließlich Risikoanalyse, Sicherheitskonformität, RBAC-Visualisierung und Scannen von Bildanfälligkeiten. Kubescape scannt K8s-Cluster, YAML-Dateien und HELM-Diagramme, erkennt Fehlkonfigurationen gemäß mehreren Rahmenwerken (wie dem [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), Softwareanfälligkeiten und RBAC (role-based-access-control)-Verstöße in frühen Phasen der CI/CD-Pipeline, berechnet sofort den Risikowert und zeigt Risikotrends im Laufe der Zeit an.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Das Tool [**kube-bench**](https://github.com/aquasecurity/kube-bench) ist ein Werkzeug, das überprüft, ob Kubernetes sicher bereitgestellt ist, indem es die im [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/) dokumentierten Prüfungen durchführt.\
Sie können wählen, um:

- kube-bench aus einem Container (mit gemeinsamem PID-Namespace mit dem Host) auszuführen
- einen Container auszuführen, der kube-bench auf dem Host installiert, und dann kube-bench direkt auf dem Host auszuführen
- die neuesten Binärdateien von der [Releases-Seite](https://github.com/aquasecurity/kube-bench/releases) zu installieren,
- es aus dem Quellcode zu kompilieren.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

Das Tool [**kubeaudit**](https://github.com/Shopify/kubeaudit) ist ein Befehlszeilenwerkzeug und ein Go-Paket, um **Kubernetes-Cluster** auf verschiedene Sicherheitsbedenken zu **auditieren**.

Kubeaudit kann erkennen, ob es innerhalb eines Containers in einem Cluster ausgeführt wird. Wenn ja, wird es versuchen, alle Kubernetes-Ressourcen in diesem Cluster zu auditieren:
```
kubeaudit all
```
Dieses Tool hat auch das Argument `autofix`, um **erkannt Probleme automatisch zu beheben.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

Das Tool [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) sucht nach Sicherheitsanfälligkeiten in Kubernetes-Clustern. Das Tool wurde entwickelt, um das Bewusstsein und die Sichtbarkeit für Sicherheitsprobleme in Kubernetes-Umgebungen zu erhöhen.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) ist ein Tool zur Schwachstellenscannung und zum CIS Docker-Benchmark, das Benutzern eine genaue und sofortige Risikobewertung ihrer Kubernetes-Cluster ermöglicht. Kubei scannt alle Images, die in einem Kubernetes-Cluster verwendet werden, einschließlich der Images von Anwendungs-Pods und System-Pods.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) ist ein Tool zum Scannen von Kubernetes-Clustern auf riskante Berechtigungen im rollenbasierten Zugriffskontrollmodell (RBAC) von Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) ist ein Tool, das entwickelt wurde, um andere Arten von Hochrisikoprüfungen im Vergleich zu anderen Tools zu testen. Es hat hauptsächlich 3 verschiedene Modi:

- **`find-role-relationships`**: Der herausfindet, welche AWS-Rollen in welchen Pods ausgeführt werden
- **`find-secrets`**: Der versucht, Geheimnisse in K8s-Ressourcen wie Pods, ConfigMaps und Secrets zu identifizieren.
- **`test-imds-access`**: Der versucht, Pods auszuführen und auf die Metadaten v1 und v2 zuzugreifen. WARNUNG: Dies wird einen Pod im Cluster ausführen, seien Sie sehr vorsichtig, da Sie dies möglicherweise nicht tun möchten!

## **Audit IaC Code**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) ist ein Dienstprogramm, das live Kubernetes-Cluster scannt und **potenzielle Probleme mit bereitgestellten Ressourcen und Konfigurationen meldet**. Es bereinigt Ihr Cluster basierend auf dem, was bereitgestellt ist, und nicht auf dem, was auf der Festplatte liegt. Durch das Scannen Ihres Clusters erkennt es Fehlkonfigurationen und hilft Ihnen sicherzustellen, dass bewährte Verfahren vorhanden sind, um zukünftige Kopfschmerzen zu vermeiden. Es zielt darauf ab, die kognitive _Überlastung zu reduzieren, die man beim Betrieb eines Kubernetes-Clusters in der Wildnis hat. Darüber hinaus, wenn Ihr Cluster einen Metric-Server verwendet, meldet es potenzielle Ressourcenüber- oder -unterzuweisungen und versucht, Sie zu warnen, falls Ihr Cluster die Kapazität erschöpft.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) findet **Sicherheitsanfälligkeiten**, Compliance-Probleme und Infrastrukturfehlkonfigurationen in den folgenden **Infrastructure as Code-Lösungen**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM und OpenAPI 3.0-Spezifikationen.

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) ist ein Tool zur statischen Codeanalyse für Infrastructure-as-Code.

Es scannt Cloud-Infrastruktur, die mit [Terraform](https://terraform.io), Terraform-Plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) oder [ARM-Vorlagen](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) bereitgestellt wurde, und erkennt Sicherheits- und Compliance-Fehlkonfigurationen mithilfe von graphbasierter Analyse.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) ist ein Tool, das eine statische Codeanalyse Ihrer Kubernetes-Objektdokumentationen durchführt.

Um zu installieren:

| Distribution                                        | Command / Link                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Vorgefertigte Binärdateien für macOS, Linux und Windows    | [GitHub-Releases](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS und Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS und Linux) | `kubectl krew install score`                                                            |

## Tipps

### Kubernetes PodSecurityContext und SecurityContext

Sie können den **Sicherheitskontext der Pods** (mit _PodSecurityContext_) und der **Container**, die ausgeführt werden sollen (mit _SecurityContext_), konfigurieren. Für weitere Informationen lesen Sie:

{{#ref}}
kubernetes-securitycontext-s.md
{{#endref}}

### Kubernetes API-Härtung

Es ist sehr wichtig, den **Zugang zum Kubernetes Api Server zu schützen**, da ein böswilliger Akteur mit ausreichenden Berechtigungen ihn missbrauchen und die Umgebung auf viele Arten schädigen könnte.\
Es ist wichtig, sowohl den **Zugang** (**Whitelist**-Ursprünge für den Zugriff auf den API-Server und Ablehnung jeder anderen Verbindung) als auch die [**Authentifizierung**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (nach dem Prinzip der **geringsten** **Berechtigung**) zu sichern. Und auf keinen Fall **anonyme** **Anfragen** **erlauben**.

**Allgemeiner Anfrageprozess:**\
Benutzer oder K8s ServiceAccount –> Authentifizierung –> Autorisierung –> Zulassungssteuerung.

**Tipps**:

- Ports schließen.
- Anonymen Zugriff vermeiden.
- NodeRestriction; Kein Zugriff von bestimmten Knoten auf die API.
- [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
- Verhindert im Wesentlichen, dass Kubelets Labels mit einem node-restriction.kubernetes.io/ Präfix hinzufügen/entfernen/aktualisieren. Dieses Label-Präfix ist für Administratoren reserviert, um ihre Node-Objekte zu Labeln, um Arbeitslastisolierung zu ermöglichen, und Kubelets wird nicht erlaubt, Labels mit diesem Präfix zu ändern.
- Und außerdem erlaubt es Kubelets, diese Labels und Label-Präfixe hinzuzufügen/zu entfernen/zu aktualisieren.
- Stellen Sie mit Labels die sichere Arbeitslastisolierung sicher.
- Verhindern Sie, dass bestimmte Pods auf die API zugreifen.
- Vermeiden Sie die Exposition des ApiServers zum Internet.
- Vermeiden Sie unbefugten Zugriff RBAC.
- ApiServer-Port mit Firewall und IP-Whitelist.

### SecurityContext-Härtung

Standardmäßig wird der Root-Benutzer verwendet, wenn ein Pod gestartet wird, wenn kein anderer Benutzer angegeben ist. Sie können Ihre Anwendung in einem sichereren Kontext ausführen, indem Sie eine Vorlage verwenden, die der folgenden ähnlich ist:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
- [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
- [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Allgemeine Härtung

Sie sollten Ihre Kubernetes-Umgebung so häufig wie nötig aktualisieren, um Folgendes zu gewährleisten:

- Abhängigkeiten auf dem neuesten Stand.
- Fehler- und Sicherheitsupdates.

[**Release-Zyklen**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Alle 3 Monate gibt es ein neues Minor-Release -- 1.20.3 = 1(Haupt).20(Minor).3(Patch)

**Der beste Weg, ein Kubernetes-Cluster zu aktualisieren, ist (von** [**hier**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

- Aktualisieren Sie die Master-Node-Komponenten in folgender Reihenfolge:
- etcd (alle Instanzen).
- kube-apiserver (alle Control-Plane-Hosts).
- kube-controller-manager.
- kube-scheduler.
- cloud controller manager, falls Sie einen verwenden.
- Aktualisieren Sie die Worker-Node-Komponenten wie kube-proxy, kubelet.

{{#include ../../../banners/hacktricks-training.md}}
