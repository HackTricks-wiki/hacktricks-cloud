# Kubernetes Güçlendirme

{{#include ../../../banners/hacktricks-training.md}}

## Bir küme analiz etmek için araçlar

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape), risk analizi, güvenlik uyumluluğu, RBAC görselleştirici ve görüntü güvenlik açıkları taraması dahil olmak üzere çoklu bulut K8s tek bir görünüm sağlayan açık kaynaklı bir K8s aracıdır. Kubescape, K8s kümelerini, YAML dosyalarını ve HELM grafiklerini tarar, birden fazla çerçeveye (örneğin, [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo) , [MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)) göre yanlış yapılandırmaları, yazılım güvenlik açıklarını ve RBAC (rol tabanlı erişim kontrolü) ihlallerini CI/CD boru hattının erken aşamalarında tespit eder, risk puanını anında hesaplar ve zaman içindeki risk eğilimlerini gösterir.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Araç [**kube-bench**](https://github.com/aquasecurity/kube-bench), Kubernetes'in güvenli bir şekilde dağıtılıp dağıtılmadığını kontrol eden bir araçtır ve [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/) belgelerinde yer alan kontrolleri çalıştırır.\
Şunları seçebilirsiniz:

- kube-bench'i bir konteynerin içinde çalıştırmak (ana bilgisayarla PID ad alanını paylaşarak)
- ana bilgisayarda kube-bench'i kuran bir konteyner çalıştırmak ve ardından kube-bench'i doğrudan ana bilgisayarda çalıştırmak
- [Releases sayfasından](https://github.com/aquasecurity/kube-bench/releases) en son ikili dosyaları kurmak,
- kaynaktan derlemek.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

Araç [**kubeaudit**](https://github.com/Shopify/kubeaudit), çeşitli güvenlik endişeleri için **Kubernetes kümelerini denetlemek** amacıyla bir komut satırı aracı ve bir Go paketidir.

Kubeaudit, bir küme içinde bir konteynerde çalışıp çalışmadığını tespit edebilir. Eğer öyleyse, o kümedeki tüm Kubernetes kaynaklarını denetlemeye çalışacaktır:
```
kubeaudit all
```
Bu araç ayrıca tespit edilen sorunları **otomatik olarak düzeltmek** için `autofix` argümanına sahiptir.

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

Araç [**kube-hunter**](https://github.com/aquasecurity/kube-hunter), Kubernetes kümelerindeki güvenlik zayıflıklarını avlar. Araç, Kubernetes ortamlarındaki güvenlik sorunları için farkındalığı ve görünürlüğü artırmak amacıyla geliştirilmiştir.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei), kullanıcıların Kubernetes kümelerinin doğru ve anlık risk değerlendirmesini almasına olanak tanıyan bir güvenlik açığı tarama ve CIS Docker benchmark aracıdır. Kubei, bir Kubernetes kümesinde kullanılan tüm görüntüleri, uygulama podları ve sistem podları dahil olmak üzere tarar.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan), Kubernetes'in Rol tabanlı erişim kontrolü (RBAC) yetkilendirme modelinde riskli izinler için Kubernetes kümesini tarayan bir araçtır.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit), diğer araçlarla karşılaştırıldığında yüksek riskli kontrollerin test edilmesi için oluşturulmuş bir araçtır. Temelde 3 farklı moda sahiptir:

- **`find-role-relationships`**: Hangi AWS rollerinin hangi podlarda çalıştığını bulur.
- **`find-secrets`**: K8s kaynaklarında (Pods, ConfigMaps ve Secrets gibi) gizli bilgileri tanımlamaya çalışır.
- **`test-imds-access`**: Podları çalıştırmaya ve metadata v1 ve v2'ye erişmeye çalışır. UYARI: Bu, kümede bir pod çalıştıracaktır, dikkatli olun çünkü bunu yapmak istemiyor olabilirsiniz!

## **Audit IaC Code**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye), canlı Kubernetes kümesini tarayan ve **dağıtılan kaynaklar ve yapılandırmalarla ilgili potansiyel sorunları raporlayan** bir yardımcı programdır. Dağıtılanlara göre kümenizi temizler ve disk üzerinde bulunanlara göre değil. Kümenizi tarayarak, yanlış yapılandırmaları tespit eder ve en iyi uygulamaların yerinde olmasını sağlamanıza yardımcı olur, böylece gelecekteki baş ağrılarını önler. Ayrıca, kümeniz bir metric-server kullanıyorsa, potansiyel kaynak aşırı/az tahsislerini raporlar ve kümeniz kapasiteyi doldurursa sizi uyarmaya çalışır.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics), aşağıdaki **Infrastructure as Code çözümlerinde** **güvenlik açıklarını**, uyum sorunlarını ve altyapı yanlış yapılandırmalarını bulur: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM ve OpenAPI 3.0 spesifikasyonları.

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov), altyapı-as-code için statik kod analizi aracıdır.

[Terraform](https://terraform.io), Terraform planı, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) veya [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) kullanılarak sağlanan bulut altyapısını tarar ve grafik tabanlı tarama kullanarak güvenlik ve uyum yanlış yapılandırmalarını tespit eder.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score), Kubernetes nesne tanımlarınızın statik kod analizini gerçekleştiren bir araçtır.

Kurmak için:

| Dağıtım                                            | Komut / Bağlantı                                                                          |
| --------------------------------------------------- | ----------------------------------------------------------------------------------------- |
| macOS, Linux ve Windows için önceden derlenmiş ikililer | [GitHub sürümleri](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub](https://hub.docker.com/r/zegl/kube-score/)) |
| Homebrew (macOS ve Linux)                          | `brew install kube-score`                                                                 |
| [Krew](https://krew.sigs.k8s.io/) (macOS ve Linux) | `kubectl krew install score`                                                              |

## İpuçları

### Kubernetes PodSecurityContext ve SecurityContext

**Podların güvenlik bağlamını** ( _PodSecurityContext_ ile) ve çalıştırılacak **konteynerlerin** güvenlik bağlamını ( _SecurityContext_ ile) yapılandırabilirsiniz. Daha fazla bilgi için okuyun:

{{#ref}}
kubernetes-securitycontext-s.md
{{#endref}}

### Kubernetes API Güçlendirme

**Kubernetes Api Sunucusuna erişimi korumak** çok önemlidir çünkü yeterli ayrıcalıklara sahip kötü niyetli bir aktör bunu kötüye kullanabilir ve ortamı birçok şekilde zarar verebilir.\
Hem **erişimi** (API Sunucusuna erişim için **beyaz liste** kökenleri ve diğer tüm bağlantıları reddetmek) hem de [**kimlik doğrulama**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) ( **en az ayrıcalık** ilkesini izleyerek) güvence altına almak önemlidir. Ve kesinlikle **asla** **anonim** **isteklere** **izin vermeyin**.

**Ortak İstek süreci:**\
Kullanıcı veya K8s ServiceAccount –> Kimlik Doğrulama –> Yetkilendirme –> Kabul Kontrolü.

**İpuçları**:

- Portları kapatın.
- Anonim erişimi önleyin.
- NodeRestriction; API'ye belirli düğümlerden erişimi engelleyin.
- [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
- Temelde, kubeletlerin node-restriction.kubernetes.io/ ön eki ile etiket eklemesini/çıkarmasını/güncellemesini engeller. Bu etiket ön eki, yöneticilerin iş yükü izolasyonu amacıyla Düğüm nesnelerini etiketlemesi için ayrılmıştır ve kubeletlerin bu ön ekle etiketleri değiştirmesine izin verilmeyecektir.
- Ayrıca, kubeletlerin bu etiketleri ve etiket ön eklerini eklemesine/çıkarmasına/güncellemesine izin verir.
- Etiketlerle güvenli iş yükü izolasyonunu sağlayın.
- Belirli podların API erişimini önleyin.
- ApiServer'ın internete maruz kalmasını önleyin.
- Yetkisiz erişim RBAC'sını önleyin.
- ApiServer portunu güvenlik duvarı ve IP beyaz listeleme ile koruyun.

### SecurityContext Güçlendirme

Varsayılan olarak, başka bir kullanıcı belirtilmediğinde bir Pod başlatıldığında root kullanıcısı kullanılacaktır. Uygulamanızı aşağıdaki gibi bir şablon kullanarak daha güvenli bir bağlamda çalıştırabilirsiniz:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
- [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
- [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Genel Güçlendirme

Kubernetes ortamınızı, aşağıdakilere sahip olmak için gerektiği sıklıkta güncellemelisiniz:

- Bağımlılıkların güncel olması.
- Hata ve güvenlik yamaları.

[**Sürüm döngüleri**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Her 3 ayda bir yeni bir küçük sürüm çıkar -- 1.20.3 = 1(Büyük).20(Küçük).3(yama)

**Kubernetes Kümesini güncellemenin en iyi yolu (şuradan** [**buraya**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

- Master Node bileşenlerini şu sırayla yükseltin:
- etcd (tüm örnekler).
- kube-apiserver (tüm kontrol düzlemi sunucuları).
- kube-controller-manager.
- kube-scheduler.
- bir tane kullanıyorsanız, cloud controller manager.
- kube-proxy, kubelet gibi Worker Node bileşenlerini yükseltin.

{{#include ../../../banners/hacktricks-training.md}}
