# Kubernetes Hardening

{{#include ../../../banners/hacktricks-training.md}}

## Εργαλεία για ανάλυση ενός cluster

### [Steampipe - Kubernetes Compliance](https://github.com/turbot/steampipe-mod-kubernetes-compliance)

Εκτελεί **πολλούς ελέγχους συμμόρφωσης στο Kubernetes cluster**. Περιλαμβάνει υποστήριξη για τα πρότυπα CIS, καθώς και για τις οδηγίες της National Security Agency (NSA) και της Cybersecurity and Infrastructure Security Agency (CISA) σχετικά με το hardening του Kubernetes.
```bash
# Install Steampipe
brew install turbot/tap/powerpipe
brew install turbot/tap/steampipe
steampipe plugin install kubernetes

# Start the service
steampipe service start

# Install the module
mkdir dashboards
cd dashboards
powerpipe mod init
powerpipe mod install github.com/turbot/steampipe-mod-kubernetes-compliance

# Run the module
powerpipe server
```
### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) είναι ένα K8s open-source εργαλείο που παρέχει ένα multi-cloud K8s single pane of glass, περιλαμβάνοντας ανάλυση κινδύνου, security compliance, RBAC visualizer και image vulnerabilities scanning. Το Kubescape σαρώνει K8s clusters, YAML αρχεία και HELM charts, εντοπίζοντας misconfigurations σύμφωνα με πολλαπλά frameworks (όπως τα [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo) , [MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), ευπάθειες λογισμικού και παραβάσεις RBAC (role-based-access-control) σε πρώιμα στάδια του CI/CD pipeline, υπολογίζει άμεσα το risk score και εμφανίζει τις τάσεις κινδύνου με την πάροδο του χρόνου.
```bash
curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | /bin/bash
kubescape scan --verbose
```
### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) είναι ένα utility που σαρώνει live Kubernetes cluster και **αναφέρει πιθανά προβλήματα με τους αναπτυγμένους πόρους και τις διαμορφώσεις**. Καθαρίζει το cluster σας βασιζόμενο σε αυτό που είναι αναπτυγμένο και όχι σε αυτό που βρίσκεται στο δίσκο. Σαρώνοντας το cluster σας, εντοπίζει misconfigurations και σας βοηθά να διασφαλίσετε ότι οι βέλτιστες πρακτικές εφαρμόζονται, προλαμβάνοντας μελλοντικούς πονοκεφάλους. Στοχεύει στη μείωση του γνωστικού \_φορτίου που αντιμετωπίζει κανείς όταν λειτουργεί ένα Kubernetes cluster στο wild. Επιπλέον, αν το cluster σας χρησιμοποιεί metric-server, αναφέρει πιθανές υπερ/υπο-εκχωρήσεις πόρων και προσπαθεί να σας προειδοποιήσει σε περίπτωση που το cluster σας εξαντλήσει τη χωρητικότητα.

### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

The tool [**kube-bench**](https://github.com/aquasecurity/kube-bench) is a tool that checks whether Kubernetes is deployed securely by running the checks documented in the [**CIS Kubernetes Benchmark**].\
Μπορείτε να επιλέξετε να:

- τρέξετε kube-bench από μέσα σε ένα container (μοιράζοντας το PID namespace με το host)
- τρέξετε ένα container που εγκαθιστά το kube-bench στο host, και στη συνέχεια να τρέξετε το kube-bench απευθείας στο host
- εγκαταστήσετε τα τελευταία binaries από τη [Releases page](https://github.com/aquasecurity/kube-bench/releases),
- κάνετε compile από το source.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

**[DEPRECATED]** Το εργαλείο [**kubeaudit**](https://github.com/Shopify/kubeaudit) είναι ένα command line tool και ένα πακέτο Go για να **ελέγχει Kubernetes clusters** για διάφορα ζητήματα ασφάλειας.

Το Kubeaudit μπορεί να ανιχνεύσει αν τρέχει μέσα σε ένα container σε ένα cluster. Αν ναι, θα προσπαθήσει να ελέγξει όλους τους Kubernetes πόρους σε αυτό το cluster:
```
kubeaudit all
```
Αυτό το εργαλείο έχει επίσης το όρισμα `autofix` για **αυτόματη διόρθωση των εντοπισμένων προβλημάτων.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

**[DEPRECATED]** Το εργαλείο [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) ανιχνεύει αδυναμίες ασφαλείας σε Kubernetes clusters. Το εργαλείο αναπτύχθηκε για να αυξήσει την ευαισθητοποίηση και την ορατότητα για ζητήματα ασφαλείας σε περιβάλλοντα Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### [Trivy](https://github.com/aquasecurity/trivy)

[Trivy](https://github.com/aquasecurity/trivy) διαθέτει σαρωτές που αναζητούν θέματα ασφάλειας και στόχους όπου μπορεί να εντοπίσει αυτά τα ζητήματα:

- Εικόνα container
- Filesystem
- Αποθετήριο Git (remote)
- Εικόνα Virtual Machine
- Kubernetes


### [**Kubei**](https://github.com/Erezf-p/kubei)

**[Φαίνεται μη συντηρούμενο]**

[**Kubei**](https://github.com/Erezf-p/kubei) είναι ένα εργαλείο σάρωσης ευπαθειών και CIS Docker benchmark που επιτρέπει στους χρήστες να λάβουν μια ακριβή και άμεση εκτίμηση κινδύνου των Kubernetes clusters τους. Το Kubei σαρώνει όλες τις εικόνες που χρησιμοποιούνται σε ένα cluster Kubernetes, συμπεριλαμβανομένων των εικόνων των application pods και system pods.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) είναι ένα εργαλείο για σάρωση cluster Kubernetes για επικίνδυνα δικαιώματα στο μοντέλο εξουσιοδότησης Role-based access control (RBAC) του Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) είναι ένα εργαλείο φτιαγμένο για να ελέγχει άλλου τύπου ελέγχους υψηλού κινδύνου σε σύγκριση με τα άλλα εργαλεία. Κυρίως έχει 3 διαφορετικές λειτουργίες:

- **`find-role-relationships`**: Θα βρει ποιες AWS roles τρέχουν σε ποια pods
- **`find-secrets`**: Προσπαθεί να εντοπίσει secrets σε K8s resources όπως Pods, ConfigMaps, και Secrets.
- **`test-imds-access`**: Θα προσπαθήσει να τρέξει pods και να προσπελάσει το metadata v1 και v2. WARNING: Αυτό θα τρέξει ένα pod στο cluster — να είστε πολύ προσεκτικοί γιατί ίσως να μην θέλετε να το κάνετε!

## **Έλεγχος IaC Κώδικα**

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) εντοπίζει **security vulnerabilities**, ζητήματα συμμόρφωσης και λανθασμένες ρυθμίσεις υποδομής στα ακόλουθα **Infrastructure as Code solutions**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM, και προδιαγραφές OpenAPI 3.0

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) είναι ένα εργαλείο στατικής ανάλυσης κώδικα για infrastructure-as-code.

Σαρώει υποδομή cloud που έχει προμηθευτεί χρησιμοποιώντας [Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) ή [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) και εντοπίζει security και compliance misconfigurations χρησιμοποιώντας graph-based scanning.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) είναι ένα εργαλείο που εκτελεί στατική ανάλυση κώδικα των ορισμών αντικειμένων Kubernetes.

Για εγκατάσταση:

| Distribution                                        | Command / Link                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Pre-built binaries for macOS, Linux, and Windows    | [GitHub releases](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS and Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS and Linux) | `kubectl krew install score`                                                            |

## Εργαλεία για ανάλυση αρχείων YAML & Helm Charts

### [**Kube-linter**](https://github.com/stackrox/kube-linter)
```bash
# Install Kube-linter
brew install kube-linter

# Run Kube-linter
## lint ./path/to/yaml/or/chart
```
### [Checkov](https://github.com/bridgecrewio/checkov)
```bash
# Install Checkov
pip install checkov

# Run Checkov
checkov -d ./path/to/yaml/or/chart
```
### [kube‑score](https://github.com/zegl/kube-score)
```bash
# Install kube-score
brew install kube-score

# Run kube-score
kube-score score ./path/to/yaml
# or
helm template chart /path/to/chart | kube-score score -
# or if the chart needs some values
helm template chart /path/to/chart \
--set 'config.urls[0]=https://dummy.backend.internal' \
| kube-score score -
```
### [Kubesec](https://github.com/controlplaneio/kubesec)
```bash
# Install Kubesec
## Download from https://github.com/controlplaneio/kubesec/releases

# Run Kubesec in a yaml
kubesec scan ./path/to/yaml
# or
helm template chart /path/to/chart | kubesec scan -
# or if the chart needs some values
helm template chart /path/to/chart \
--set 'config.urls[0]=https://dummy.backend.internal' \
| kubesec scan -
```
## Συμβουλές

### Kubernetes PodSecurityContext και SecurityContext

Μπορείτε να διαμορφώσετε το **security context των Pods** (με _PodSecurityContext_) και των **containers** που θα εκτελεστούν (με _SecurityContext_). Για περισσότερες πληροφορίες διαβάστε:

{{#ref}}
kubernetes-securitycontext-s.md
{{#endref}}

### Ενίσχυση ασφάλειας του Kubernetes API

Είναι πολύ σημαντικό να **προστατεύσετε την πρόσβαση στο Kubernetes Api Server** καθώς ένας κακόβουλος παράγοντας με επαρκή δικαιώματα θα μπορούσε να το καταχραστεί και να βλάψει με πολλούς τρόπους το περιβάλλον.\
Είναι σημαντικό να ασφαλίσετε τόσο την **πρόσβαση** (**whitelist** origins για πρόσβαση στον API Server και να απορρίπτετε οποιαδήποτε άλλη σύνδεση) όσο και την [**authentication**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (ακολουθώντας την αρχή του **ελαχίστου** **δικαιώματος**). Και σίγουρα **μην** **επιτρέπετε** **ποτέ** **ανώνυμα** **αιτήματα**.

**Συνήθης ροή αιτήματος:**\
User or K8s ServiceAccount –> Authentication –> Authorization –> Admission Control.

**Συμβουλές**:

- Κλείστε τις θύρες.
- Αποφύγετε την ανώνυμη πρόσβαση.
- NodeRestriction; Χωρίς πρόσβαση από συγκεκριμένους nodes στο API.
- [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
- Βασικά αποτρέπει τα kubelets από το να προσθέτουν/αφαιρούν/ενημερώνουν labels με το prefix node-restriction.kubernetes.io/. Αυτό το prefix είναι δεσμευμένο για τους administrators ώστε να επισημαίνουν τα Node αντικείμενά τους για σκοπούς απομόνωσης workload, και τα kubelets δεν θα επιτρέπεται να τροποποιούν labels με αυτό το prefix.
- Επιπλέον, επιτρέπει στα kubelets να προσθέτουν/αφαιρούν/ενημερώνουν αυτά τα labels και τα αντίστοιχα prefix.
- Διασφαλίστε με labels την ασφαλή απομόνωση workload.
- Αποτρέψτε συγκεκριμένα pods από την πρόσβαση στο API.
- Αποφύγετε την έκθεση του ApiServer στο internet.
- Αποφύγετε μη εξουσιοδοτημένη πρόσβαση μέσω RBAC.
- Βάλτε την θύρα του ApiServer πίσω από firewall και whitelist διευθύνσεων IP.

### SecurityContext Hardening

Εξ ορισμού ο χρήστης root θα χρησιμοποιείται όταν ένα Pod ξεκινάει εάν δεν έχει οριστεί άλλος χρήστης. Μπορείτε να τρέξετε την εφαρμογή σας μέσα σε ένα πιο ασφαλές context χρησιμοποιώντας ένα πρότυπο παρόμοιο με το ακόλουθο:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
- [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
- [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Γενική Σκληρυνση

Πρέπει να ενημερώνετε το περιβάλλον Kubernetes όσο συχνά χρειάζεται ώστε να έχει:

- Ενημερωμένες εξαρτήσεις.
- Διορθώσεις σφαλμάτων και ενημερώσεις ασφάλειας.

[**Release cycles**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Κάθε 3 μήνες υπάρχει μια νέα δευτερεύουσα έκδοση -- 1.20.3 = 1(Κύρια).20(Δευτερεύουσα).3(διόρθωση)

**Ο καλύτερος τρόπος για να ενημερώσετε ένα Kubernetes Cluster είναι (από** [**here**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

- Αναβαθμίστε τα components του Master Node ακολουθώντας αυτή τη σειρά:
- etcd (όλες οι περιπτώσεις).
- kube-apiserver (όλοι οι hosts του control plane).
- kube-controller-manager.
- kube-scheduler.
- cloud controller manager, αν χρησιμοποιείτε κάποιο.
- Αναβαθμίστε τα components των Worker Node όπως kube-proxy, kubelet.

## Παρακολούθηση & ασφάλεια Kubernetes:

- Kyverno Policy Engine
- Cilium Tetragon - Παρατηρησιμότητα ασφάλειας και επιβολή σε χρόνο εκτέλεσης βασισμένη σε eBPF
- Network Security Policies
- Falco - Παρακολούθηση ασφάλειας σε χρόνο εκτέλεσης & ανίχνευση

{{#include ../../../banners/hacktricks-training.md}}
