# Kubernetes Hardening

{{#include ../../../banners/hacktricks-training.md}}

## クラスターを分析するためのツール

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) は、リスク分析、セキュリティコンプライアンス、RBACビジュアライザー、イメージ脆弱性スキャンを含む、マルチクラウドK8sのシングルペインオブグラスを提供するK8sオープンソースツールです。KubescapeはK8sクラスター、YAMLファイル、HELMチャートをスキャンし、複数のフレームワーク（例えば、[NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo) 、[MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)）に従って誤設定、ソフトウェアの脆弱性、RBAC（ロールベースアクセス制御）違反をCI/CDパイプラインの初期段階で検出し、リスクスコアを即座に計算し、時間の経過に伴うリスクの傾向を表示します。
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

ツール [**kube-bench**](https://github.com/aquasecurity/kube-bench) は、[**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/) に記載されたチェックを実行することによって、Kubernetes が安全にデプロイされているかどうかを確認するツールです。\
次の方法を選択できます：

- コンテナ内から kube-bench を実行する（ホストと PID 名前空間を共有）
- ホストに kube-bench をインストールするコンテナを実行し、その後ホスト上で直接 kube-bench を実行する
- [Releases page](https://github.com/aquasecurity/kube-bench/releases) から最新のバイナリをインストールする
- ソースからコンパイルする

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

ツール [**kubeaudit**](https://github.com/Shopify/kubeaudit) は、さまざまなセキュリティ上の懸念に対して **Kubernetes クラスターを監査** するためのコマンドラインツールおよび Go パッケージです。

Kubeaudit は、クラスター内のコンテナ内で実行されているかどうかを検出できます。もしそうであれば、そのクラスター内のすべての Kubernetes リソースを監査しようとします：
```
kubeaudit all
```
このツールには、検出された問題を**自動的に修正する**ための引数`autofix`もあります。

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

ツール[**kube-hunter**](https://github.com/aquasecurity/kube-hunter)は、Kubernetesクラスターのセキュリティの弱点を探します。このツールは、Kubernetes環境におけるセキュリティ問題への意識と可視性を高めるために開発されました。
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) は、ユーザーが自分の Kubernetes クラスターの正確で即時のリスク評価を得ることを可能にする脆弱性スキャンおよび CIS Docker ベンチマークツールです。Kubei は、アプリケーションポッドやシステムポッドのイメージを含む、Kubernetes クラスターで使用されているすべてのイメージをスキャンします。

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) は、Kubernetes のロールベースアクセス制御 (RBAC) 認可モデルにおけるリスクのある権限をスキャンするためのツールです。

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) は、他のツールと比較して他のタイプの高リスクチェックをテストするために構築されたツールです。主に 3 つの異なるモードがあります：

- **`find-role-relationships`**: どの AWS ロールがどのポッドで実行されているかを見つけます
- **`find-secrets`**: Pods、ConfigMaps、Secrets などの K8s リソース内の秘密を特定しようとします。
- **`test-imds-access`**: ポッドを実行し、メタデータ v1 および v2 にアクセスしようとします。警告：これはクラスター内でポッドを実行しますので、注意してください。おそらくこれを行いたくないかもしれません！

## **Audit IaC Code**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) は、ライブ Kubernetes クラスターをスキャンし、**デプロイされたリソースと構成に関する潜在的な問題を報告する**ユーティリティです。ディスク上にあるものではなく、デプロイされたものに基づいてクラスターをサニタイズします。クラスターをスキャンすることで、誤った構成を検出し、ベストプラクティスが確立されていることを確認するのに役立ち、将来の頭痛を防ぎます。Kubernetes クラスターを運用する際の認知的負荷を軽減することを目指しています。さらに、クラスターがメトリックサーバーを使用している場合、リソースの過剰/不足割り当てを報告し、クラスターが容量不足になる場合に警告を試みます。

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) は、以下の **Infrastructure as Code ソリューション** における **セキュリティ脆弱性**、コンプライアンスの問題、およびインフラストラクチャの誤設定を見つけます：Terraform、Kubernetes、Docker、AWS CloudFormation、Ansible、Helm、Microsoft ARM、および OpenAPI 3.0 仕様

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) は、インフラストラクチャ・アズ・コードのための静的コード分析ツールです。

[Terraform](https://terraform.io)、Terraform プラン、[Cloudformation](https://aws.amazon.com/cloudformation/)、[AWS SAM](https://aws.amazon.com/serverless/sam/)、[Kubernetes](https://kubernetes.io)、[Dockerfile](https://www.docker.com)、[Serverless](https://www.serverless.com) または [ARM テンプレート](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) を使用してプロビジョニングされたクラウドインフラストラクチャをスキャンし、グラフベースのスキャンを使用してセキュリティおよびコンプライアンスの誤設定を検出します。

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) は、Kubernetes オブジェクト定義の静的コード分析を実行するツールです。

インストール方法：

| ディストリビューション                                   | コマンド / リンク                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| macOS、Linux、Windows 用のプリビルドバイナリ          | [GitHub リリース](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS および Linux)                       | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS および Linux) | `kubectl krew install score`                                                            |

## Tips

### Kubernetes PodSecurityContext と SecurityContext

**Pod のセキュリティコンテキスト** (_PodSecurityContext_) と実行される **コンテナ** のセキュリティコンテキスト (_SecurityContext_) を構成できます。詳細については、次をお読みください：

{{#ref}}
kubernetes-securitycontext-s.md
{{#endref}}

### Kubernetes API ハードニング

Kubernetes Api Server への **アクセスを保護すること** は非常に重要です。十分な権限を持つ悪意のあるアクターがそれを悪用し、環境に多くの方法で損害を与える可能性があります。\
**アクセス**（API サーバーにアクセスするためのオリジンを **ホワイトリスト** に登録し、他の接続を拒否する）と [**認証**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/)（**最小限の権限** の原則に従う）を確保することが重要です。そして、**決して** **匿名** **リクエストを許可しない**ことが重要です。

**一般的なリクエストプロセス：**\
ユーザーまたは K8s ServiceAccount –> 認証 –> 認可 –> 受け入れ制御。

**ヒント**：

- ポートを閉じる。
- 匿名アクセスを避ける。
- NodeRestriction; 特定のノードから API へのアクセスを制限する。
- [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
- 基本的に、kubelets が node-restriction.kubernetes.io/ プレフィックスを持つラベルを追加/削除/更新するのを防ぎます。このラベルプレフィックスは、ワークロードの分離目的でノードオブジェクトにラベルを付けるために管理者に予約されています。kubelets はそのプレフィックスを持つラベルを変更することは許可されません。
- また、kubelets がこれらのラベルおよびラベルプレフィックスを追加/削除/更新することを許可します。
- ラベルを使用して安全なワークロードの分離を確保します。
- 特定のポッドが API アクセスを避けるようにします。
- ApiServer をインターネットにさらすことを避けます。
- 認可されていないアクセス RBAC を避けます。
- ファイアウォールと IP ホワイトリストを使用した ApiServer ポート。

### SecurityContext ハードニング

デフォルトでは、他のユーザーが指定されていない場合、ポッドが起動するときに root ユーザーが使用されます。次のようなテンプレートを使用して、より安全なコンテキスト内でアプリケーションを実行できます：
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
- [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
- [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### 一般的なハードニング

Kubernetes 環境は、次のように必要に応じて頻繁に更新する必要があります。

- 依存関係を最新の状態に保つ。
- バグおよびセキュリティパッチ。

[**リリースサイクル**](https://kubernetes.io/docs/setup/release/version-skew-policy/): 3ヶ月ごとに新しいマイナーリリースがあります -- 1.20.3 = 1(メジャー).20(マイナー).3(パッチ)

**Kubernetes クラスターを更新する最良の方法は (こちらから)** [**こちら**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**:**

- 次の順序でマスターノードコンポーネントをアップグレードします。
- etcd (すべてのインスタンス)。
- kube-apiserver (すべてのコントロールプレーンホスト)。
- kube-controller-manager。
- kube-scheduler。
- クラウドコントローラーマネージャー (使用している場合)。
- kube-proxy、kubelet などのワーカーノードコンポーネントをアップグレードします。

{{#include ../../../banners/hacktricks-training.md}}
