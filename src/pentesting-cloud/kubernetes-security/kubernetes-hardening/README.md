# Kubernetes Hardening

{{#include ../../../banners/hacktricks-training.md}}

## Strumenti per analizzare un cluster

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) è uno strumento open-source K8s che fornisce un'unica interfaccia multi-cloud K8s, inclusa l'analisi dei rischi, la conformità alla sicurezza, il visualizzatore RBAC e la scansione delle vulnerabilità delle immagini. Kubescape scansiona i cluster K8s, i file YAML e i grafici HELM, rilevando configurazioni errate secondo diversi framework (come il [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), vulnerabilità software e violazioni RBAC (controllo degli accessi basato sui ruoli) nelle prime fasi della pipeline CI/CD, calcola istantaneamente il punteggio di rischio e mostra le tendenze di rischio nel tempo.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Lo strumento [**kube-bench**](https://github.com/aquasecurity/kube-bench) è uno strumento che verifica se Kubernetes è distribuito in modo sicuro eseguendo i controlli documentati nel [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Puoi scegliere di:

- eseguire kube-bench all'interno di un container (condividendo lo spazio dei nomi PID con l'host)
- eseguire un container che installa kube-bench sull'host, e poi eseguire kube-bench direttamente sull'host
- installare gli ultimi binari dalla [pagina delle Release](https://github.com/aquasecurity/kube-bench/releases),
- compilarlo dal sorgente.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

Lo strumento [**kubeaudit**](https://github.com/Shopify/kubeaudit) è uno strumento da riga di comando e un pacchetto Go per **auditare i cluster Kubernetes** per vari problemi di sicurezza.

Kubeaudit può rilevare se sta girando all'interno di un container in un cluster. Se sì, cercherà di auditare tutte le risorse Kubernetes in quel cluster:
```
kubeaudit all
```
Questo strumento ha anche l'argomento `autofix` per **correggere automaticamente i problemi rilevati.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

Lo strumento [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) cerca vulnerabilità di sicurezza nei cluster Kubernetes. Lo strumento è stato sviluppato per aumentare la consapevolezza e la visibilità sui problemi di sicurezza negli ambienti Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) è uno strumento di scansione delle vulnerabilità e benchmark CIS Docker che consente agli utenti di ottenere una valutazione del rischio accurata e immediata dei propri cluster Kubernetes. Kubei scansiona tutte le immagini utilizzate in un cluster Kubernetes, comprese le immagini dei pod delle applicazioni e dei pod di sistema.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) è uno strumento per la scansione dei cluster Kubernetes alla ricerca di permessi rischiosi nel modello di autorizzazione Role-based access control (RBAC) di Kubernetes.

### [Managed Kubernetes Auditing Toolkit](https://github.com/DataDog/managed-kubernetes-auditing-toolkit)

[**Mkat**](https://github.com/DataDog/managed-kubernetes-auditing-toolkit) è uno strumento progettato per testare altri tipi di controlli ad alto rischio rispetto agli altri strumenti. Ha principalmente 3 modalità diverse:

- **`find-role-relationships`**: Che troverà quali ruoli AWS sono in esecuzione in quali pod
- **`find-secrets`**: Che cerca di identificare segreti nelle risorse K8s come Pods, ConfigMaps e Secrets.
- **`test-imds-access`**: Che cercherà di eseguire pod e tentare di accedere ai metadati v1 e v2. ATTENZIONE: Questo eseguirà un pod nel cluster, fai molta attenzione perché potresti non volerlo fare!

## **Audit IaC Code**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) è un'utilità che scansiona i cluster Kubernetes attivi e **riporta potenziali problemi con le risorse e le configurazioni distribuite**. Sanitizza il tuo cluster in base a ciò che è distribuito e non a ciò che è memorizzato su disco. Scansionando il tuo cluster, rileva le configurazioni errate e ti aiuta a garantire che le migliori pratiche siano in atto, prevenendo così futuri mal di testa. Mira a ridurre il carico cognitivo che si affronta quando si opera in un cluster Kubernetes in produzione. Inoltre, se il tuo cluster utilizza un metric-server, riporta potenziali sovra/sotto allocazioni delle risorse e cerca di avvisarti nel caso in cui il tuo cluster esaurisca la capacità.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) trova **vulnerabilità di sicurezza**, problemi di conformità e configurazioni errate dell'infrastruttura nelle seguenti **soluzioni Infrastructure as Code**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM e specifiche OpenAPI 3.0

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) è uno strumento di analisi statica del codice per l'infrastructure-as-code.

Scansiona l'infrastruttura cloud fornita utilizzando [Terraform](https://terraform.io), il piano Terraform, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) o [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) e rileva configurazioni errate di sicurezza e conformità utilizzando la scansione basata su grafi.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) è uno strumento che esegue analisi statica del codice delle definizioni degli oggetti Kubernetes.

Per installare:

| Distribuzione                                        | Comando / Link                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Binaries precompilati per macOS, Linux e Windows    | [GitHub releases](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS e Linux)                            | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS e Linux)  | `kubectl krew install score`                                                            |

## Tips

### Kubernetes PodSecurityContext e SecurityContext

Puoi configurare il **contesto di sicurezza dei Pod** (con _PodSecurityContext_) e dei **container** che verranno eseguiti (con _SecurityContext_). Per ulteriori informazioni leggi:

{{#ref}}
kubernetes-securitycontext-s.md
{{#endref}}

### Indurimento dell'API Kubernetes

È molto importante **proteggere l'accesso al Kubernetes Api Server** poiché un attore malintenzionato con privilegi sufficienti potrebbe abusarne e danneggiare l'ambiente in molti modi.\
È importante garantire sia l'**accesso** (**whitelist** delle origini per accedere all'API Server e negare qualsiasi altra connessione) sia la [**autenticazione**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (seguendo il principio del **minimo** **privilegio**). E sicuramente **mai** **consentire** **richieste** **anonime**.

**Processo di richiesta comune:**\
Utente o K8s ServiceAccount –> Autenticazione –> Autorizzazione –> Controllo di ammissione.

**Suggerimenti**:

- Chiudi le porte.
- Evita l'accesso anonimo.
- NodeRestriction; Nessun accesso da nodi specifici all'API.
- [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
- Fondamentalmente impedisce ai kubelet di aggiungere/rimuovere/aggiornare etichette con un prefisso node-restriction.kubernetes.io/. Questo prefisso di etichetta è riservato agli amministratori per etichettare i loro oggetti Node per scopi di isolamento del carico di lavoro, e i kubelet non saranno autorizzati a modificare le etichette con quel prefisso.
- E inoltre, consente ai kubelet di aggiungere/rimuovere/aggiornare queste etichette e prefissi di etichetta.
- Assicurati con le etichette l'isolamento sicuro del carico di lavoro.
- Evita che pod specifici accedano all'API.
- Evita l'esposizione dell'ApiServer a Internet.
- Evita l'accesso non autorizzato RBAC.
- Porta dell'ApiServer con firewall e whitelist IP.

### Indurimento del SecurityContext

Per impostazione predefinita, verrà utilizzato l'utente root quando un Pod viene avviato se non viene specificato un altro utente. Puoi eseguire la tua applicazione all'interno di un contesto più sicuro utilizzando un modello simile al seguente:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
- [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
- [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Indurimento Generale

Dovresti aggiornare il tuo ambiente Kubernetes con la frequenza necessaria per avere:

- Dipendenze aggiornate.
- Correzioni di bug e di sicurezza.

[**Cicli di rilascio**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Ogni 3 mesi c'è un nuovo rilascio minore -- 1.20.3 = 1(Maggiore).20(Minore).3(patch)

**Il modo migliore per aggiornare un Cluster Kubernetes è (da** [**qui**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

- Aggiorna i componenti del nodo Master seguendo questa sequenza:
- etcd (tutte le istanze).
- kube-apiserver (tutti gli host del piano di controllo).
- kube-controller-manager.
- kube-scheduler.
- cloud controller manager, se ne utilizzi uno.
- Aggiorna i componenti del nodo Worker come kube-proxy, kubelet.

{{#include ../../../banners/hacktricks-training.md}}
