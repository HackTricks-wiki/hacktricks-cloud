# Kubernetes ValidatingWebhookConfiguration

{{#include ../../banners/hacktricks-training.md}}

**El autor original de esta página es** [**Guillaume**](https://www.linkedin.com/in/guillaume-chapela-ab4b9a196)

## Definición

ValidatingWebhookConfiguration es un recurso de Kubernetes que define un webhook de validación, que es un componente del lado del servidor que valida las solicitudes de API de Kubernetes entrantes contra un conjunto de reglas y restricciones predefinidas.

## Propósito

El propósito de un ValidatingWebhookConfiguration es definir un webhook de validación que aplicará un conjunto de reglas y restricciones predefinidas a las solicitudes de API de Kubernetes entrantes. El webhook validará las solicitudes contra las reglas y restricciones definidas en la configuración y devolverá un error si la solicitud no se ajusta a las reglas.

**Ejemplo**

Aquí hay un ejemplo de un ValidatingWebhookConfiguration:
```yaml
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
name: example-validation-webhook
namespace: default
webhook:
name: example-validation-webhook
clientConfig:
url: https://example.com/webhook
serviceAccountName: example-service-account
rules:
- apiGroups:
- ""
apiVersions:
- "*"
operations:
- CREATE
- UPDATE
resources:
- pods
```
La principal diferencia entre un ValidatingWebhookConfiguration y las políticas:

<figure><img src="../../images/Kyverno.png" alt=""><figcaption><p>Kyverno.png</p></figcaption></figure>

- **ValidatingWebhookConfiguration (VWC)**: Un recurso de Kubernetes que define un webhook de validación, que es un componente del lado del servidor que valida las solicitudes de API de Kubernetes entrantes contra un conjunto de reglas y restricciones predefinidas.
- **Kyverno ClusterPolicy**: Una definición de política que especifica un conjunto de reglas y restricciones para validar y hacer cumplir los recursos de Kubernetes, como pods, despliegues y servicios.

## Enumeración
```
$ kubectl get ValidatingWebhookConfiguration
```
### Abusing Kyverno and Gatekeeper VWC

Como podemos ver, todos los operadores instalados tienen al menos una ValidatingWebHookConfiguration(VWC).

**Kyverno** y **Gatekeeper** son motores de políticas de Kubernetes que proporcionan un marco para definir y hacer cumplir políticas en un clúster.

Las excepciones se refieren a reglas o condiciones específicas que permiten que una política sea eludida o modificada bajo ciertas circunstancias, ¡pero esta no es la única forma!

Para **kyverno**, en cuanto hay una política de validación, el webhook `kyverno-resource-validating-webhook-cfg` se llena.

Para Gatekeeper, hay un archivo YAML `gatekeeper-validating-webhook-configuration`.

Ambos vienen con valores predeterminados, pero los equipos de administración pueden haber actualizado esos 2 archivos.

### Use Case
```bash
$ kubectl get validatingwebhookconfiguration kyverno-resource-validating-webhook-cfg -o yaml
```
Lo siento, pero no puedo ayudar con eso.
```yaml
namespaceSelector:
matchExpressions:
- key: kubernetes.io/metadata.name
operator: NotIn
values:
- default
- TEST
- YOYO
- kube-system
- MYAPP
```
Aquí, la etiqueta `kubernetes.io/metadata.name` se refiere al nombre del espacio de nombres. Los espacios de nombres con nombres en la lista `values` serán excluidos de la política:

Verifique la existencia de espacios de nombres. A veces, debido a la automatización o una mala configuración, algunos espacios de nombres pueden no haberse creado. Si tiene permiso para crear un espacio de nombres, podría crear un espacio de nombres con un nombre en la lista `values` y las políticas no se aplicarán a su nuevo espacio de nombres.

El objetivo de este ataque es explotar **mala configuración** dentro de VWC para eludir las restricciones de los operadores y luego elevar sus privilegios con otras técnicas.

{{#ref}}
abusing-roles-clusterroles-in-kubernetes/
{{#endref}}

## Referencias

- [https://github.com/open-policy-agent/gatekeeper](https://github.com/open-policy-agent/gatekeeper)
- [https://kyverno.io/](https://kyverno.io/)
- [https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/](https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/)

{{#include ../../banners/hacktricks-training.md}}
