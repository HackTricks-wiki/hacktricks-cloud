# Kubernetes OPA Gatekeeper bypass

{{#include ../../../banners/hacktricks-training.md}}

**Ο αρχικός συγγραφέας αυτής της σελίδας είναι** [**Guillaume**](https://www.linkedin.com/in/guillaume-chapela-ab4b9a196)

## Κατάχρηση κακής διαμόρφωσης

### Καταμέτρηση κανόνων

Η επισκόπηση μπορεί να βοηθήσει στο να γνωρίζουμε ποιες κανόνες είναι ενεργοί, σε ποιον τρόπο και ποιος μπορεί να τους παρακάμψει.

#### Με το CLI
```bash
$ kubectl api-resources | grep gatekeeper
k8smandatoryannotations                                                             constraints.gatekeeper.sh/v1beta1                  false        K8sMandatoryAnnotations
k8smandatorylabels                                                                  constraints.gatekeeper.sh/v1beta1                  false        K8sMandatoryLabel
constrainttemplates                                                                 templates.gatekeeper.sh/v1                         false        ConstraintTemplate
```
**ConstraintTemplate** και **Constraint** μπορούν να χρησιμοποιηθούν στο Open Policy Agent (OPA) Gatekeeper για την επιβολή κανόνων στους πόρους Kubernetes.
```bash
$ kubectl get constrainttemplates
$ kubectl get k8smandatorylabels
```
#### Με το GUI

Μια Γραφική Διεπαφή Χρήστη μπορεί επίσης να είναι διαθέσιμη για την πρόσβαση στους κανόνες OPA με το **Gatekeeper Policy Manager.** Είναι "μια απλή _μόνο για ανάγνωση_ διαδικτυακή διεπαφή για την προβολή της κατάστασης των πολιτικών OPA Gatekeeper σε ένα Kubernetes Cluster."

<figure><img src="../../../images/05-constraints.png" alt=""><figcaption></figcaption></figure>

Αναζητήστε την εκτεθειμένη υπηρεσία :
```bash
$ kubectl get services -A | grep gatekeeper
$ kubectl get services -A | grep 'gatekeeper-policy-manager-system'
```
### Εξαιρούμενα namespaces

Όπως απεικονίζεται στην παραπάνω εικόνα, ορισμένοι κανόνες ενδέχεται να μην εφαρμόζονται καθολικά σε όλα τα namespaces ή χρήστες. Αντίθετα, λειτουργούν με βάση μια λευκή λίστα. Για παράδειγμα, ο περιορισμός `liveness-probe` εξαιρείται από την εφαρμογή σε πέντε συγκεκριμένα namespaces.

### Bypass

Με μια ολοκληρωμένη επισκόπηση της διαμόρφωσης του Gatekeeper, είναι δυνατόν να εντοπιστούν πιθανές κακοδιαμορφώσεις που θα μπορούσαν να εκμεταλλευτούν για να αποκτήσουν προνόμια. Αναζητήστε whitelisted ή εξαιρούμενα namespaces όπου ο κανόνας δεν ισχύει, και στη συνέχεια εκτελέστε την επίθεσή σας εκεί.

{{#ref}}
../abusing-roles-clusterroles-in-kubernetes/
{{#endref}}

## Abusing ValidatingWebhookConfiguration

Ένας άλλος τρόπος για να παρακάμψετε τους περιορισμούς είναι να εστιάσετε στον πόρο ValidatingWebhookConfiguration:

{{#ref}}
../kubernetes-validatingwebhookconfiguration.md
{{#endref}}

## Αναφορές

- [https://github.com/open-policy-agent/gatekeeper](https://github.com/open-policy-agent/gatekeeper)
- [https://github.com/sighupio/gatekeeper-policy-manager](https://github.com/sighupio/gatekeeper-policy-manager)

{{#include ../../../banners/hacktricks-training.md}}
