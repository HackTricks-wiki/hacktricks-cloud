# Kubernetes OPA Gatekeeper bypass

**Oryginalnym autorem tej strony jest** [**Guillaume**](https://www.linkedin.com/in/guillaume-chapela-ab4b9a196)

## Wykorzystywanie błędnej konfiguracji

### Wyszukiwanie reguł

Posiadanie przeglądu może pomóc w zrozumieniu, które reguły są aktywne, w jakim trybie i kto może je obejść.

#### Z użyciem CLI
```bash
$ kubectl api-resources | grep gatekeeper
k8smandatoryannotations                                                             constraints.gatekeeper.sh/v1beta1                  false        K8sMandatoryAnnotations
k8smandatorylabels                                                                  constraints.gatekeeper.sh/v1beta1                  false        K8sMandatoryLabel
constrainttemplates                                                                 templates.gatekeeper.sh/v1                         false        ConstraintTemplate
```
**ConstraintTemplate** i **Constraint** mogą być używane w Open Policy Agent (OPA) Gatekeeper do egzekwowania reguł na zasobach Kubernetes.
```bash
$ kubectl get constrainttemplates
$ kubectl get k8smandatorylabels
```
#### Z interfejsem graficznym

Interfejs graficzny może być również dostępny do uzyskania dostępu do reguł OPA za pomocą **Gatekeeper Policy Manager.** Jest to "prosty _tylko do odczytu_ interfejs webowy do przeglądania statusu polityk OPA Gatekeeper w klastrze Kubernetes."

<figure><img src="../../../images/05-constraints.png" alt=""><figcaption></figcaption></figure>

Szukaj wystawionej usługi:
```bash
$ kubectl get services -A | grep gatekeeper
$ kubectl get services -A | grep 'gatekeeper-policy-manager-system'
```
### Wykluczone przestrzenie nazw

Jak pokazano na powyższym obrazku, niektóre zasady mogą nie być stosowane uniwersalnie we wszystkich przestrzeniach nazw lub użytkownikach. Zamiast tego działają na zasadzie białej listy. Na przykład, ograniczenie `liveness-probe` jest wyłączone z zastosowania do pięciu określonych przestrzeni nazw.

### Ominięcie

Mając pełny przegląd konfiguracji Gatekeepera, można zidentyfikować potencjalne błędy konfiguracyjne, które mogą być wykorzystane do uzyskania uprawnień. Szukaj przestrzeni nazw na białej liście lub wykluczonych, gdzie zasada nie ma zastosowania, a następnie przeprowadź atak tam.

{{#ref}}
../abusing-roles-clusterroles-in-kubernetes/
{{#endref}}

## Wykorzystywanie ValidatingWebhookConfiguration

Innym sposobem na ominięcie ograniczeń jest skupienie się na zasobie ValidatingWebhookConfiguration :&#x20;

{{#ref}}
../kubernetes-validatingwebhookconfiguration.md
{{#endref}}

## Odniesienia

- [https://github.com/open-policy-agent/gatekeeper](https://github.com/open-policy-agent/gatekeeper)
- [https://github.com/sighupio/gatekeeper-policy-manager](https://github.com/sighupio/gatekeeper-policy-manager)
