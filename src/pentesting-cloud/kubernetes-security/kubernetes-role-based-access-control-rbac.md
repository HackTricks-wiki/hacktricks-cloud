# Kubernetes Rol Tabanlı Erişim Kontrolü (RBAC)

{{#include ../../banners/hacktricks-training.md}}

## Rol Tabanlı Erişim Kontrolü (RBAC)

Kubernetes'in **Rol Tabanlı Erişim Kontrolü** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) adında bir **yetkilendirme modülü** vardır ve bu modül API sunucusuna kullanım izinleri ayarlamaya yardımcı olur.

RBAC'nin izin modeli **üç ayrı bölümden** oluşmaktadır:

1. **Role\ClusterRole ­–** Gerçek izin. Bir dizi izni temsil eden _**kurallar**_ içerir. Her kural, [kaynaklar](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) ve [fiiller](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb) içerir. Fiil, kaynağa uygulanacak eylemdir.
2. **Konu (Kullanıcı, Grup veya ServiceAccount) –** İzinleri alacak nesne.
3. **RoleBinding\ClusterRoleBinding –** Role\ClusterRole ile konu arasındaki bağlantı.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding_serviceaccount_and_role-1024x551.png)

“**Roller**” ile “**ClusterRoller**” arasındaki fark, rolün nerede uygulanacağıdır – bir “**Rol**” yalnızca **bir** **belirli** **namespace** için erişim verirken, bir “**ClusterRol**” **tüm namespace'lerde** kullanılabilir. Ayrıca, **ClusterRoller** şunlara da erişim verebilir:

- **küme kapsamlı** kaynaklar (örneğin düğümler).
- **kaynak dışı** uç noktalar (örneğin /healthz).
- **tüm namespace'lerde** **namespaced** kaynaklar (örneğin Podlar).

**Kubernetes** 1.6'dan itibaren, **RBAC** politikaları **varsayılan olarak etkin** durumdadır. Ancak RBAC'yi etkinleştirmek için şunu kullanabilirsiniz:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Şablonlar

Bir **Rol** veya **ClusterRole** şablonunda **rolün adı**, **namespace** (rollerde) ve ardından rolün **apiGrupları**, **kaynakları** ve **fiillerini** belirtmeniz gerekecektir:

- **apiGrupları**, bu kuralın uygulandığı farklı **API namespace'lerini** içeren bir dizidir. Örneğin, bir Pod tanımı apiVersion: v1 kullanır. _rbac.authorization.k8s.io veya \[\*] gibi değerler alabilir_.
- **kaynaklar**, bu kuralın uygulandığı **kaynakları tanımlayan** bir dizidir. Tüm kaynakları bulmak için: `kubectl api-resources --namespaced=true` komutunu kullanabilirsiniz.
- **fiiller**, **izin verilen fiilleri** içeren bir dizidir. Kubernetes'teki fiil, kaynağa uygulamanız gereken **hareket türünü** tanımlar. Örneğin, liste fiili koleksiyonlar için kullanılırken "get" tek bir kaynak için kullanılır.

### Kurallar Fiilleri

(_Bu bilgi_ [_**belgelerden**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb) _alınmıştır_)

| HTTP fiili | istek fiili                                                                                                                                                  |
| ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST       | oluştur                                                                                                                                                |
| GET, HEAD  | al (bireysel kaynaklar için), listele (koleksiyonlar için, tam nesne içeriği dahil), izle (bireysel bir kaynak veya kaynak koleksiyonunu izlemek için) |
| PUT        | güncelle                                                                                                                                                |
| PATCH      | yamala                                                                                                                                                   |
| DELETE     | sil (bireysel kaynaklar için), koleksiyonu sil (koleksiyonlar için)                                                                                     |

Kubernetes bazen özel fiiller kullanarak ek izinler için yetkilendirmeyi kontrol eder. Örneğin:

- [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
- `policy` API grubundaki `podsecuritypolicies` kaynaklarında `use` fiili.
- [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
- `rbac.authorization.k8s.io` API grubundaki `roles` ve `clusterroles` kaynaklarında `bind` ve `escalate` fiilleri.
- [Kimlik Doğrulama](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
- `core` API grubundaki `users`, `groups` ve `serviceaccounts` üzerinde `impersonate` fiili, ve `authentication.k8s.io` API grubundaki `userextras`.

> [!WARNING]
> **Her kaynağın desteklediği tüm fiilleri** bulmak için `kubectl api-resources --sort-by name -o wide` komutunu çalıştırabilirsiniz.

### Örnekler
```yaml:Role
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```

```yaml:ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
Örneğin, belirli bir kullanıcının çalıştırmasına izin vermek için bir **ClusterRole** kullanabilirsiniz:
```
kubectl get pods --all-namespaces
```
### **RoleBinding ve ClusterRoleBinding**

[**Belgelerden:**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding) Bir **role binding, bir rolde tanımlanan izinleri bir kullanıcıya veya kullanıcı grubuna verir**. Kullanıcılar, gruplar veya hizmet hesapları gibi bir konu listesi ve verilen role bir referans içerir. Bir **RoleBinding**, belirli bir **namespace** içinde izinler verirken, bir **ClusterRoleBinding** bu erişimi **küme genelinde** sağlar.
```yaml:RoleBinding
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```

```yaml:ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
**İzinler toplamsaldır** bu nedenle eğer "listele" ve "sil" izinlerine sahip bir clusterRole'unuz varsa, bunu "al" iznine sahip bir Role ile ekleyebilirsiniz. Bu yüzden her zaman rollerinizi ve izinlerinizi test edin ve **İZİN VERİLENİ belirtin, çünkü varsayılan olarak her şey REDDEDİLİR.**

## **RBAC'ı Sayma**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Abuse Role/ClusterRoles for Privilege Escalation

{{#ref}}
abusing-roles-clusterroles-in-kubernetes/
{{#endref}}

{{#include ../../banners/hacktricks-training.md}}
