# Kubernetes Role-Based Access Control(RBAC)

{{#include ../../banners/hacktricks-training.md}}

## Role-Based Access Control (RBAC)

Το Kubernetes έχει ένα **module εξουσιοδότησης που ονομάζεται Role-Based Access Control** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) που βοηθά στη ρύθμιση των δικαιωμάτων χρήσης στον API server.

Το μοντέλο δικαιωμάτων του RBAC είναι δομημένο από **τρία ξεχωριστά μέρη**:

1. **Role\ClusterRole ­–** Το πραγματικό δικαίωμα. Περιέχει _**κανόνες**_ που αντιπροσωπεύουν ένα σύνολο δικαιωμάτων. Κάθε κανόνας περιέχει [πόρους](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) και [ρήματα](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). Το ρήμα είναι η ενέργεια που θα εφαρμοστεί στον πόρο.
2. **Subject (Χρήστης, Ομάδα ή ServiceAccount) –** Το αντικείμενο που θα λάβει τα δικαιώματα.
3. **RoleBinding\ClusterRoleBinding –** Η σύνδεση μεταξύ Role\ClusterRole και του υποκειμένου.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding_serviceaccount_and_role-1024x551.png)

Η διαφορά μεταξύ “**Roles**” και “**ClusterRoles**” είναι απλώς το πού θα εφαρμοστεί ο ρόλος – μια “**Role**” θα παραχωρήσει πρόσβαση μόνο σε **ένα** **συγκεκριμένο** **namespace**, ενώ μια “**ClusterRole**” μπορεί να χρησιμοποιηθεί σε **όλα τα namespaces** στο cluster. Επιπλέον, οι **ClusterRoles** μπορούν επίσης να παραχωρήσουν πρόσβαση σε:

- **πόρους κλίμακας cluster** (όπως οι κόμβοι).
- **μη-πόρους** endpoints (όπως το /healthz).
- πόρους με namespace (όπως τα Pods), **σε όλα τα namespaces**.

Από το **Kubernetes** 1.6 και μετά, οι πολιτικές **RBAC** είναι **ενεργοποιημένες από προεπιλογή**. Αλλά για να ενεργοποιήσετε το RBAC μπορείτε να χρησιμοποιήσετε κάτι όπως:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Templates

Στο πρότυπο ενός **Role** ή ενός **ClusterRole** θα χρειαστεί να υποδείξετε το **όνομα του ρόλου**, το **namespace** (σε ρόλους) και στη συνέχεια τις **apiGroups**, **resources** και **verbs** του ρόλου:

- Οι **apiGroups** είναι ένας πίνακας που περιέχει τα διάφορα **API namespaces** στα οποία ισχύει αυτός ο κανόνας. Για παράδειγμα, μια ορισμός Pod χρησιμοποιεί apiVersion: v1. _Μπορεί να έχει τιμές όπως rbac.authorization.k8s.io ή \[\*]_.
- Οι **resources** είναι ένας πίνακας που ορίζει **σε ποιους πόρους ισχύει αυτός ο κανόνας**. Μπορείτε να βρείτε όλους τους πόρους με: `kubectl api-resources --namespaced=true`
- Οι **verbs** είναι ένας πίνακας που περιέχει τα **επιτρεπόμενα ρήματα**. Το ρήμα στο Kubernetes ορίζει τον **τύπο ενέργειας** που πρέπει να εφαρμόσετε στον πόρο. Για παράδειγμα, το ρήμα list χρησιμοποιείται κατά συλλογών ενώ το "get" χρησιμοποιείται κατά ενός μεμονωμένου πόρου.

### Rules Verbs

(_Αυτές οι πληροφορίες ελήφθησαν από_ [_**the docs**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| HTTP verb | request verb                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get (για μεμονωμένους πόρους), list (για συλλογές, συμπεριλαμβανομένου του πλήρους περιεχομένου αντικειμένων), watch (για παρακολούθηση ενός μεμονωμένου πόρου ή συλλογής πόρων) |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete (για μεμονωμένους πόρους), deletecollection (για συλλογές)                                                                                         |

Το Kubernetes μερικές φορές ελέγχει την εξουσιοδότηση για πρόσθετες άδειες χρησιμοποιώντας εξειδικευμένα ρήματα. Για παράδειγμα:

- [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
- `use` ρήμα στους πόρους `podsecuritypolicies` στην ομάδα API `policy`.
- [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
- `bind` και `escalate` ρήματα στους πόρους `roles` και `clusterroles` στην ομάδα API `rbac.authorization.k8s.io`.
- [Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
- `impersonate` ρήμα στους `users`, `groups`, και `serviceaccounts` στην κύρια ομάδα API, και το `userextras` στην ομάδα API `authentication.k8s.io`.

> [!WARNING]
> Μπορείτε να βρείτε **όλα τα ρήματα που υποστηρίζει κάθε πόρος** εκτελώντας `kubectl api-resources --sort-by name -o wide`

### Examples
```yaml:Role
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```

```yaml:ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
Για παράδειγμα, μπορείτε να χρησιμοποιήσετε ένα **ClusterRole** για να επιτρέψετε σε έναν συγκεκριμένο χρήστη να εκτελεί:
```
kubectl get pods --all-namespaces
```
### **RoleBinding και ClusterRoleBinding**

[**Από τα έγγραφα:**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding) Ένα **role binding παραχωρεί τις άδειες που ορίζονται σε έναν ρόλο σε έναν χρήστη ή σε ένα σύνολο χρηστών**. Περιέχει μια λίστα υποκειμένων (χρηστών, ομάδων ή λογαριασμών υπηρεσιών) και μια αναφορά στον ρόλο που παραχωρείται. Ένα **RoleBinding** παραχωρεί άδειες εντός ενός συγκεκριμένου **namespace** ενώ ένα **ClusterRoleBinding** παραχωρεί αυτή την πρόσβαση **σε επίπεδο cluster**.
```yaml:RoleBinding
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```

```yaml:ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
**Οι άδειες είναι προσθετικές** οπότε αν έχετε ένα clusterRole με “list” και “delete” μυστικά μπορείτε να το προσθέσετε με ένα Role με “get”. Οπότε να είστε προσεκτικοί και να δοκιμάζετε πάντα τους ρόλους και τις άδειές σας και **να καθορίζετε τι είναι ΕΠΙΤΡΕΠΤΟ, γιατί τα πάντα είναι ΑΠΑΓΟΡΕΥΜΕΝΑ από προεπιλογή.**

## **Καταμέτρηση RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Κατάχρηση Ρόλων/ClusterRoles για Κλιμάκωση Προνομίων

{{#ref}}
abusing-roles-clusterroles-in-kubernetes/
{{#endref}}

{{#include ../../banners/hacktricks-training.md}}
