# Kubernetes Basics

## Kubernetes Basics

{{#include ../../banners/hacktricks-training.md}}

**ì´ í˜ì´ì§€ì˜ ì›ë˜ ì €ìëŠ”** [**Jorge**](https://www.linkedin.com/in/jorge-belmonte-a924b616b/) **ì…ë‹ˆë‹¤ (ê·¸ì˜ ì›ë˜ ê²Œì‹œë¬¼ì€** [**ì—¬ê¸°**](https://sickrov.github.io)**)**

## Architecture & Basics

### KubernetesëŠ” ë¬´ì—‡ì„ í•˜ë‚˜ìš”?

- ì»¨í…Œì´ë„ˆ ì—”ì§„ì—ì„œ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.
- ìŠ¤ì¼€ì¤„ë§ì„ í†µí•´ ì»¨í…Œì´ë„ˆì˜ ì„ë¬´ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
- ì»¨í…Œì´ë„ˆë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
- ì»¨í…Œì´ë„ˆ ê°„ì˜ í†µì‹ ì„ í—ˆìš©í•©ë‹ˆë‹¤.
- ë°°í¬ ê¸°ìˆ ì„ í—ˆìš©í•©ë‹ˆë‹¤.
- ì •ë³´ì˜ ì–‘ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.

### Architecture

![](https://sickrov.github.io/media/Screenshot-68.jpg)

- **Node**: pod ë˜ëŠ” podsê°€ ìˆëŠ” ìš´ì˜ ì²´ì œì…ë‹ˆë‹¤.
- **Pod**: í•˜ë‚˜ì˜ ì»¨í…Œì´ë„ˆ ë˜ëŠ” ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆë¥¼ ê°ì‹¸ëŠ” ë˜í¼ì…ë‹ˆë‹¤. í•˜ë‚˜ì˜ podëŠ” í•˜ë‚˜ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ë§Œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤ (ê·¸ë˜ì„œ ë³´í†µ í•˜ë‚˜ì˜ podëŠ” 1ê°œì˜ ì»¨í…Œì´ë„ˆë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤). podëŠ” Kubernetesê°€ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ê¸°ìˆ ì„ ì¶”ìƒí™”í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.
- **Service**: ê° podëŠ” ë…¸ë“œì˜ ë‚´ë¶€ ë²”ìœ„ì—ì„œ 1ê°œì˜ ë‚´ë¶€ **IP ì£¼ì†Œ**ë¥¼ ê°€ì§‘ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì„œë¹„ìŠ¤ë¡œ ë…¸ì¶œë  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. **ì„œë¹„ìŠ¤ëŠ” ë˜í•œ IP ì£¼ì†Œë¥¼ ê°€ì§€ë©°** ê·¸ ëª©í‘œëŠ” pod ê°„ì˜ í†µì‹ ì„ ìœ ì§€í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë”°ë¼ì„œ í•˜ë‚˜ê°€ ì£½ìœ¼ë©´ **ìƒˆë¡œìš´ ëŒ€ì²´** (ë‹¤ë¥¸ ë‚´ë¶€ IPë¥¼ ê°€ì§„)ê°€ **ì„œë¹„ìŠ¤ì˜ ë™ì¼í•œ IPë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ë©ë‹ˆë‹¤**. ë‚´ë¶€ ë˜ëŠ” ì™¸ë¶€ë¡œ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì„œë¹„ìŠ¤ëŠ” ë˜í•œ **2ê°œì˜ podê°€ ë™ì¼í•œ ì„œë¹„ìŠ¤ì— ì—°ê²°ë  ë•Œ ë¡œë“œ ë°¸ëŸ°ì„œ ì—­í• ì„ í•©ë‹ˆë‹¤**.\
ì„œë¹„ìŠ¤ê°€ **ìƒì„±ë˜ë©´** `kubectl get endpoints`ë¥¼ ì‹¤í–‰í•˜ì—¬ ê° ì„œë¹„ìŠ¤ì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **Kubelet**: ê¸°ë³¸ ë…¸ë“œ ì—ì´ì „íŠ¸ì…ë‹ˆë‹¤. ë…¸ë“œì™€ kubectl ê°„ì˜ í†µì‹ ì„ ì„¤ì •í•˜ëŠ” êµ¬ì„± ìš”ì†Œì´ë©°, podë§Œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (API ì„œë²„ë¥¼ í†µí•´). Kubeletì€ Kubernetesì— ì˜í•´ ìƒì„±ë˜ì§€ ì•Šì€ ì»¨í…Œì´ë„ˆë¥¼ ê´€ë¦¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- **Kube-proxy**: apiserverì™€ ë…¸ë“œ ê°„ì˜ í†µì‹  (ì„œë¹„ìŠ¤)ì„ ë‹´ë‹¹í•˜ëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ë…¸ë“œë¥¼ ìœ„í•œ IPtablesì…ë‹ˆë‹¤. ê°€ì¥ ìˆ™ë ¨ëœ ì‚¬ìš©ìëŠ” ë‹¤ë¥¸ ê³µê¸‰ìì˜ kube-proxyë¥¼ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **Sidecar container**: ì‚¬ì´ë“œì¹´ ì»¨í…Œì´ë„ˆëŠ” podì˜ ì£¼ìš” ì»¨í…Œì´ë„ˆì™€ í•¨ê»˜ ì‹¤í–‰ë˜ì–´ì•¼ í•˜ëŠ” ì»¨í…Œì´ë„ˆì…ë‹ˆë‹¤. ì´ ì‚¬ì´ë“œì¹´ íŒ¨í„´ì€ í˜„ì¬ ì»¨í…Œì´ë„ˆì˜ ê¸°ëŠ¥ì„ ë³€ê²½í•˜ì§€ ì•Šê³  í™•ì¥í•˜ê³  í–¥ìƒì‹œí‚µë‹ˆë‹¤. í˜„ì¬ ìš°ë¦¬ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì–´ë””ì—ì„œë‚˜ ì‹¤í–‰ë  ìˆ˜ ìˆë„ë¡ ëª¨ë“  ì¢…ì†ì„±ì„ ë˜í•‘í•˜ê¸° ìœ„í•´ ì»¨í…Œì´ë„ˆ ê¸°ìˆ ì„ ì‚¬ìš©í•œë‹¤ëŠ” ê²ƒì„ ì•Œê³  ìˆìŠµë‹ˆë‹¤. ì»¨í…Œì´ë„ˆëŠ” ë‹¨ í•˜ë‚˜ì˜ ì‘ì—…ë§Œ ìˆ˜í–‰í•˜ë©° ê·¸ ì‘ì—…ì„ ë§¤ìš° ì˜ ìˆ˜í–‰í•©ë‹ˆë‹¤.
- **Master process:**
- **Api Server:** ì‚¬ìš©ìê°€ ë§ˆìŠ¤í„° í”„ë¡œì„¸ìŠ¤ì™€ í†µì‹ í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤. ì¸ì¦ëœ ìš”ì²­ë§Œ í—ˆìš©ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
- **Scheduler**: ìŠ¤ì¼€ì¤„ë§ì€ Podsê°€ Kubeletì´ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ë…¸ë“œì— ë§¤ì¹­ë˜ë„ë¡ í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì–´ë–¤ ë…¸ë“œì— ë” ë§ì€ ì‚¬ìš© ê°€ëŠ¥í•œ ë¦¬ì†ŒìŠ¤ê°€ ìˆëŠ”ì§€ ê²°ì •í•  ìˆ˜ ìˆëŠ” ì¶©ë¶„í•œ ì§€ëŠ¥ì„ ê°€ì§€ê³  ìˆìœ¼ë©°, ìƒˆë¡œìš´ podë¥¼ ê·¸ ë…¸ë“œì— í• ë‹¹í•©ë‹ˆë‹¤. ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” ìƒˆë¡œìš´ podë¥¼ ì‹œì‘í•˜ì§€ ì•Šìœ¼ë©°, ë…¸ë“œ ë‚´ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ Kubelet í”„ë¡œì„¸ìŠ¤ì™€ í†µì‹ í•˜ì—¬ ìƒˆë¡œìš´ podë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
- **Kube Controller manager**: replica sets ë˜ëŠ” deploymentsì™€ ê°™ì€ ë¦¬ì†ŒìŠ¤ë¥¼ í™•ì¸í•˜ì—¬ ì˜ˆë¥¼ ë“¤ì–´ ì˜¬ë°”ë¥¸ ìˆ˜ì˜ pod ë˜ëŠ” ë…¸ë“œê°€ ì‹¤í–‰ë˜ê³  ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. podê°€ ëˆ„ë½ëœ ê²½ìš°, ìƒˆë¡œìš´ podë¥¼ ì‹œì‘í•˜ê¸° ìœ„í•´ ìŠ¤ì¼€ì¤„ëŸ¬ì™€ í†µì‹ í•©ë‹ˆë‹¤. APIì— ëŒ€í•œ ë³µì œ, í† í° ë° ê³„ì • ì„œë¹„ìŠ¤ë¥¼ ì œì–´í•©ë‹ˆë‹¤.
- **etcd**: ë°ì´í„° ì €ì¥ì†Œë¡œ, ì§€ì†ì ì´ê³  ì¼ê´€ë˜ë©° ë¶„ì‚°ë©ë‹ˆë‹¤. Kubernetesì˜ ë°ì´í„°ë² ì´ìŠ¤ì´ë©° í´ëŸ¬ìŠ¤í„°ì˜ ì „ì²´ ìƒíƒœë¥¼ ìœ ì§€í•˜ëŠ” í‚¤-ê°’ ì €ì¥ì†Œì…ë‹ˆë‹¤ (ê° ë³€ê²½ ì‚¬í•­ì´ ì—¬ê¸°ì—ì„œ ê¸°ë¡ë©ë‹ˆë‹¤). ìŠ¤ì¼€ì¤„ëŸ¬ë‚˜ ì»¨íŠ¸ë¡¤ëŸ¬ ë§¤ë‹ˆì €ì™€ ê°™ì€ êµ¬ì„± ìš”ì†ŒëŠ” ì–´ë–¤ ë³€ê²½ì´ ë°œìƒí–ˆëŠ”ì§€ ì•Œê¸° ìœ„í•´ ì´ ë°ì´í„°ì— ì˜ì¡´í•©ë‹ˆë‹¤ (ë…¸ë“œì˜ ì‚¬ìš© ê°€ëŠ¥í•œ ë¦¬ì†ŒìŠ¤, ì‹¤í–‰ ì¤‘ì¸ podì˜ ìˆ˜ ë“±).
- **Cloud controller manager**: AWS ë˜ëŠ” OpenStackì— í´ëŸ¬ìŠ¤í„°ê°€ ìˆëŠ” ê²½ìš° íë¦„ ì œì–´ ë° ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìœ„í•œ íŠ¹ì • ì»¨íŠ¸ë¡¤ëŸ¬ì…ë‹ˆë‹¤.

ì—¬ëŸ¬ ë…¸ë“œ (ì—¬ëŸ¬ pod ì‹¤í–‰)ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ Api ì„œë²„ì— ëŒ€í•œ ì ‘ê·¼ì´ ë¡œë“œ ë°¸ëŸ°ì‹±ë˜ê³  etcdê°€ ë™ê¸°í™”ëœ ì—¬ëŸ¬ ë§ˆìŠ¤í„° í”„ë¡œì„¸ìŠ¤ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Volumes:**

podê°€ ìƒì„±í•œ ë°ì´í„°ê°€ podê°€ ì‚¬ë¼ì§ˆ ë•Œ ìƒì–´ë²„ë¦¬ì§€ ì•Šë„ë¡ í•˜ë ¤ë©´ ë¬¼ë¦¬ì  ë³¼ë¥¨ì— ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤. **KubernetesëŠ” ë°ì´í„°ë¥¼ ì§€ì†í•˜ê¸° ìœ„í•´ podì— ë³¼ë¥¨ì„ ì—°ê²°í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤**. ë³¼ë¥¨ì€ ë¡œì»¬ ë¨¸ì‹ ì— ìˆê±°ë‚˜ **ì›ê²© ì €ì¥ì†Œ**ì— ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì„œë¡œ ë‹¤ë¥¸ ë¬¼ë¦¬ì  ë…¸ë“œì—ì„œ podë¥¼ ì‹¤í–‰í•˜ëŠ” ê²½ìš° ëª¨ë“  podê°€ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì›ê²© ì €ì¥ì†Œë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

**Other configurations:**

- **ConfigMap**: ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ **URL**ì„ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. podëŠ” ë‚˜ë¨¸ì§€ ì„œë¹„ìŠ¤ (pod)ì™€ í†µì‹ í•˜ëŠ” ë°©ë²•ì„ ì•Œê¸° ìœ„í•´ ì—¬ê¸°ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. ì´ê³³ì€ ìê²© ì¦ëª…ì„ ì €ì¥í•˜ëŠ” ë° ê¶Œì¥ë˜ëŠ” ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤!
- **Secret**: ë¹„ë°€ë²ˆí˜¸, API í‚¤ ë“±ê³¼ ê°™ì€ **ë¹„ë°€ ë°ì´í„°**ë¥¼ B64ë¡œ ì¸ì½”ë”©í•˜ì—¬ ì €ì¥í•˜ëŠ” ì¥ì†Œì…ë‹ˆë‹¤. podëŠ” í•„ìš”í•œ ìê²© ì¦ëª…ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì´ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **Deployments**: Kubernetesê°€ ì‹¤í–‰í•  êµ¬ì„± ìš”ì†Œê°€ í‘œì‹œë˜ëŠ” ê³³ì…ë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ì¼ë°˜ì ìœ¼ë¡œ podì™€ ì§ì ‘ ì‘ì—…í•˜ì§€ ì•Šìœ¼ë©°, podëŠ” **ReplicaSets** (ë³µì œëœ ë™ì¼í•œ podì˜ ìˆ˜)ë¡œ ì¶”ìƒí™”ë˜ì–´ ë°°í¬ë¥¼ í†µí•´ ì‹¤í–‰ë©ë‹ˆë‹¤. ë°°í¬ëŠ” **ë¬´ìƒíƒœ** ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìœ„í•œ ê²ƒì…ë‹ˆë‹¤. ë°°í¬ì˜ ìµœì†Œ êµ¬ì„±ì€ ì´ë¦„ê³¼ ì‹¤í–‰í•  ì´ë¯¸ì§€ì…ë‹ˆë‹¤.
- **StatefulSet**: ì´ êµ¬ì„± ìš”ì†ŒëŠ” **ë°ì´í„°ë² ì´ìŠ¤**ì™€ ê°™ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìœ„í•´ íŠ¹ë³„íˆ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. **ë™ì¼í•œ ì €ì¥ì†Œì— ì ‘ê·¼í•´ì•¼ í•©ë‹ˆë‹¤**.
- **Ingress**: ì• í”Œë¦¬ì¼€ì´ì…˜ì„ **URLë¡œ ê³µê°œì ìœ¼ë¡œ ë…¸ì¶œí•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” êµ¬ì„±ì…ë‹ˆë‹¤**. ì™¸ë¶€ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ë„ ìˆì§€ë§Œ, ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë…¸ì¶œí•˜ëŠ” ì˜¬ë°”ë¥¸ ë°©ë²•ì…ë‹ˆë‹¤.
- Ingressë¥¼ êµ¬í˜„í•˜ë©´ **Ingress Controllers**ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤. Ingress ControllerëŠ” ìš”ì²­ì„ ìˆ˜ì‹ í•˜ê³  í™•ì¸í•˜ë©° ì„œë¹„ìŠ¤ë¥¼ ë¡œë“œ ë°¸ëŸ°ì‹±í•  ì—”ë“œí¬ì¸íŠ¸ê°€ ë  **pod**ì…ë‹ˆë‹¤. Ingress ControllerëŠ” **êµ¬ì„±ëœ ingress ê·œì¹™ì— ë”°ë¼ ìš”ì²­ì„ ì „ì†¡í•©ë‹ˆë‹¤**. ingress ê·œì¹™ì€ ì„œë¡œ ë‹¤ë¥¸ ê²½ë¡œ ë˜ëŠ” ì‹¬ì§€ì–´ ì„œë¡œ ë‹¤ë¥¸ ë‚´ë¶€ Kubernetes ì„œë¹„ìŠ¤ì— ëŒ€í•œ í•˜ìœ„ ë„ë©”ì¸ì„ ê°€ë¦¬í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ë” ë‚˜ì€ ë³´ì•ˆ ê´€í–‰ì€ Kubernetes í´ëŸ¬ìŠ¤í„°ì˜ ì–´ë–¤ ë¶€ë¶„ë„ ë…¸ì¶œë˜ì§€ ì•Šë„ë¡ í´ë¼ìš°ë“œ ë¡œë“œ ë°¸ëŸ°ì„œ ë˜ëŠ” í”„ë¡ì‹œ ì„œë²„ë¥¼ ì§„ì…ì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
- ì–´ë–¤ ingress ê·œì¹™ê³¼ë„ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ìš”ì²­ì´ ìˆ˜ì‹ ë˜ë©´, ingress controllerëŠ” ì´ë¥¼ "**Default backend**"ë¡œ ì•ˆë‚´í•©ë‹ˆë‹¤. ì´ ë§¤ê°œë³€ìˆ˜ì˜ ì£¼ì†Œë¥¼ ì–»ìœ¼ë ¤ë©´ ingress controllerë¥¼ `describe`í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- `minikube addons enable ingress`

### PKI infrastructure - Certificate Authority CA:

![](https://sickrov.github.io/media/Screenshot-66.jpg)

- CAëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ ëª¨ë“  ì¸ì¦ì„œì˜ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë£¨íŠ¸ì…ë‹ˆë‹¤.
- êµ¬ì„± ìš”ì†Œê°€ ì„œë¡œë¥¼ ê²€ì¦í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.
- ëª¨ë“  í´ëŸ¬ìŠ¤í„° ì¸ì¦ì„œëŠ” CAì— ì˜í•´ ì„œëª…ë©ë‹ˆë‹¤.
- etcdëŠ” ìì²´ ì¸ì¦ì„œë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.
- ìœ í˜•:
- apiserver cert.
- kubelet cert.
- scheduler cert.

## Basic Actions

### Minikube

**Minikube**ëŠ” ì „ì²´ Kubernetes í™˜ê²½ì„ ë°°í¬í•  í•„ìš” ì—†ì´ Kubernetesì—ì„œ ëª‡ ê°€ì§€ **ë¹ ë¥¸ í…ŒìŠ¤íŠ¸**ë¥¼ ìˆ˜í–‰í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **ë§ˆìŠ¤í„° ë° ë…¸ë“œ í”„ë¡œì„¸ìŠ¤ë¥¼ í•œ ëŒ€ì˜ ë¨¸ì‹ ì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤**. MinikubeëŠ” ë…¸ë“œë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ virtualboxë¥¼ ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤. [**ì—¬ê¸°ì—ì„œ ì„¤ì¹˜ ë°©ë²•ì„ í™•ì¸í•˜ì„¸ìš”**](https://minikube.sigs.k8s.io/docs/start/).
```
$ minikube start
ğŸ˜„  minikube v1.19.0 on Ubuntu 20.04
âœ¨  Automatically selected the virtualbox driver. Other choices: none, ssh
ğŸ’¿  Downloading VM boot image ...
> minikube-v1.19.0.iso.sha256: 65 B / 65 B [-------------] 100.00% ? p/s 0s
> minikube-v1.19.0.iso: 244.49 MiB / 244.49 MiB  100.00% 1.78 MiB p/s 2m17.
ğŸ‘  Starting control plane node minikube in cluster minikube
ğŸ’¾  Downloading Kubernetes v1.20.2 preload ...
> preloaded-images-k8s-v10-v1...: 491.71 MiB / 491.71 MiB  100.00% 2.59 MiB
ğŸ”¥  Creating virtualbox VM (CPUs=2, Memory=3900MB, Disk=20000MB) ...
ğŸ³  Preparing Kubernetes v1.20.2 on Docker 20.10.4 ...
â–ª Generating certificates and keys ...
â–ª Booting up control plane ...
â–ª Configuring RBAC rules ...
ğŸ”  Verifying Kubernetes components...
â–ª Using image gcr.io/k8s-minikube/storage-provisioner:v5
ğŸŒŸ  Enabled addons: storage-provisioner, default-storageclass
ğŸ„  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by defaul

$ minikube status
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured

---- ONCE YOU HAVE A K8 SERVICE RUNNING WITH AN EXTERNAL SERVICE -----
$ minikube service mongo-express-service
(This will open your browser to access the service exposed port)

$ minikube delete
ğŸ”¥  Deleting "minikube" in virtualbox ...
ğŸ’€  Removed all traces of the "minikube" cluster
```
### Kubectl ê¸°ë³¸

**`Kubectl`**ì€ kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ìœ„í•œ ëª…ë ¹ì¤„ ë„êµ¬ì…ë‹ˆë‹¤. ì´ëŠ” ë§ˆìŠ¤í„° í”„ë¡œì„¸ìŠ¤ì˜ Api ì„œë²„ì™€ í†µì‹ í•˜ì—¬ kubernetesì—ì„œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê±°ë‚˜ ë°ì´í„°ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
```bash
kubectl version #Get client and server version
kubectl get pod
kubectl get services
kubectl get deployment
kubectl get replicaset
kubectl get secret
kubectl get all
kubectl get ingress
kubectl get endpoints

#kubectl create deployment <deployment-name> --image=<docker image>
kubectl create deployment nginx-deployment --image=nginx
#Access the configuration of the deployment and modify it
#kubectl edit deployment <deployment-name>
kubectl edit deployment nginx-deployment
#Get the logs of the pod for debbugging (the output of the docker container running)
#kubectl logs <replicaset-id/pod-id>
kubectl logs nginx-deployment-84cd76b964
#kubectl describe pod <pod-id>
kubectl describe pod mongo-depl-5fd6b7d4b4-kkt9q
#kubectl exec -it <pod-id> -- bash
kubectl exec -it mongo-depl-5fd6b7d4b4-kkt9q -- bash
#kubectl describe service <service-name>
kubectl describe service mongodb-service
#kubectl delete deployment <deployment-name>
kubectl delete deployment mongo-depl
#Deploy from config file
kubectl apply -f deployment.yml
```
### Minikube ëŒ€ì‹œë³´ë“œ

ëŒ€ì‹œë³´ë“œëŠ” minikubeê°€ ë¬´ì—‡ì„ ì‹¤í–‰í•˜ê³  ìˆëŠ”ì§€ ë” ì‰½ê²Œ ë³¼ ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” URLì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
```
minikube dashboard --url


ğŸ”Œ  Enabling dashboard ...
â–ª Using image kubernetesui/dashboard:v2.3.1
â–ª Using image kubernetesui/metrics-scraper:v1.0.7
ğŸ¤”  Verifying dashboard health ...
ğŸš€  Launching proxy ...
ğŸ¤”  Verifying proxy health ...
http://127.0.0.1:50034/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/
```
### YAML êµ¬ì„± íŒŒì¼ ì˜ˆì œ

ê° êµ¬ì„± íŒŒì¼ì€ 3ë¶€ë¶„ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤: **ë©”íƒ€ë°ì´í„°**, **ì‚¬ì–‘** (ì‹¤í–‰í•´ì•¼ í•  ë‚´ìš©), **ìƒíƒœ** (ì›í•˜ëŠ” ìƒíƒœ).\
ë°°í¬ êµ¬ì„± íŒŒì¼ì˜ ì‚¬ì–‘ ì•ˆì—ëŠ” ì‹¤í–‰í•  ì´ë¯¸ì§€ë¥¼ ì •ì˜í•˜ëŠ” ìƒˆë¡œìš´ êµ¬ì„± êµ¬ì¡°ë¡œ ì •ì˜ëœ í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

**ê°™ì€ êµ¬ì„± íŒŒì¼ì— ì„ ì–¸ëœ ë°°í¬ + ì„œë¹„ìŠ¤ì˜ ì˜ˆ (ì¶œì²˜** [**ì—¬ê¸°**](https://gitlab.com/nanuchi/youtube-tutorial-series/-/blob/master/demo-kubernetes-components/mongo.yaml)**)**

ì„œë¹„ìŠ¤ëŠ” ì¼ë°˜ì ìœ¼ë¡œ í•˜ë‚˜ì˜ ë°°í¬ì™€ ê´€ë ¨ì´ ìˆìœ¼ë¯€ë¡œ, ê°™ì€ êµ¬ì„± íŒŒì¼ì— ë‘ ê°€ì§€ë¥¼ ì„ ì–¸í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤ (ì´ êµ¬ì„±ì—ì„œ ì„ ì–¸ëœ ì„œë¹„ìŠ¤ëŠ” ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤):
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
name: mongodb-deployment
labels:
app: mongodb
spec:
replicas: 1
selector:
matchLabels:
app: mongodb
template:
metadata:
labels:
app: mongodb
spec:
containers:
- name: mongodb
image: mongo
ports:
- containerPort: 27017
env:
- name: MONGO_INITDB_ROOT_USERNAME
valueFrom:
secretKeyRef:
name: mongodb-secret
key: mongo-root-username
- name: MONGO_INITDB_ROOT_PASSWORD
valueFrom:
secretKeyRef:
name: mongodb-secret
key: mongo-root-password
---
apiVersion: v1
kind: Service
metadata:
name: mongodb-service
spec:
selector:
app: mongodb
ports:
- protocol: TCP
port: 27017
targetPort: 27017
```
**ì™¸ë¶€ ì„œë¹„ìŠ¤ êµ¬ì„± ì˜ˆì‹œ**

ì´ ì„œë¹„ìŠ¤ëŠ” ì™¸ë¶€ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ ( `nodePort` ë° `type: LoadBlancer` ì†ì„±ì„ í™•ì¸í•˜ì„¸ìš”):
```yaml
---
apiVersion: v1
kind: Service
metadata:
name: mongo-express-service
spec:
selector:
app: mongo-express
type: LoadBalancer
ports:
- protocol: TCP
port: 8081
targetPort: 8081
nodePort: 30000
```
> [!NOTE]
> ì´ê²ƒì€ í…ŒìŠ¤íŠ¸ì— ìœ ìš©í•˜ì§€ë§Œ, í”„ë¡œë•ì…˜ì—ì„œëŠ” ë‚´ë¶€ ì„œë¹„ìŠ¤ë§Œ ìˆê³  ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë…¸ì¶œí•˜ê¸° ìœ„í•œ Ingressê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

**Ingress êµ¬ì„± íŒŒì¼ì˜ ì˜ˆ**

ì´ê²ƒì€ `http://dashboard.com`ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë…¸ì¶œí•©ë‹ˆë‹¤.
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
name: dashboard-ingress
namespace: kubernetes-dashboard
spec:
rules:
- host: dashboard.com
http:
paths:
- backend:
serviceName: kubernetes-dashboard
servicePort: 80
```
**ë¹„ë°€ êµ¬ì„± íŒŒì¼ì˜ ì˜ˆ**

ë¹„ë°€ë²ˆí˜¸ê°€ B64ë¡œ ì¸ì½”ë”©ë˜ì–´ ìˆëŠ” ê²ƒì„ ì£¼ëª©í•˜ì„¸ìš”(ì•ˆì „í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!).
```yaml
apiVersion: v1
kind: Secret
metadata:
name: mongodb-secret
type: Opaque
data:
mongo-root-username: dXNlcm5hbWU=
mongo-root-password: cGFzc3dvcmQ=
```
**ConfigMapì˜ ì˜ˆ**

A **ConfigMap**ì€ í¬ë“œì— ì œê³µë˜ëŠ” êµ¬ì„±ìœ¼ë¡œ, í¬ë“œê°€ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë¥¼ ì°¾ê³  ì ‘ê·¼í•˜ëŠ” ë°©ë²•ì„ ì•Œ ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. ì´ ê²½ìš°, ê° í¬ë“œëŠ” `mongodb-service`ë¼ëŠ” ì´ë¦„ì´ ê·¸ë“¤ì´ í†µì‹ í•  ìˆ˜ ìˆëŠ” í¬ë“œì˜ ì£¼ì†Œì„ì„ ì•Œê²Œ ë©ë‹ˆë‹¤(ì´ í¬ë“œëŠ” mongodbë¥¼ ì‹¤í–‰í•  ê²ƒì…ë‹ˆë‹¤):
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
name: mongodb-configmap
data:
database_url: mongodb-service
```
ê·¸ëŸ° ë‹¤ìŒ, **deployment config** ë‚´ì—ì„œ ì´ ì£¼ì†ŒëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì§€ì •ë˜ì–´ podì˜ env ë‚´ì—ì„œ ë¡œë“œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```yaml
[...]
spec:
[...]
template:
[...]
spec:
containers:
- name: mongo-express
image: mongo-express
ports:
- containerPort: 8081
env:
- name: ME_CONFIG_MONGODB_SERVER
valueFrom:
configMapKeyRef:
name: mongodb-configmap
key: database_url
[...]
```
**ë³¼ë¥¨ êµ¬ì„± ì˜ˆì‹œ**

ë‹¤ì–‘í•œ ì €ì¥ì†Œ êµ¬ì„± yaml íŒŒì¼ì˜ ì˜ˆì‹œëŠ” [https://gitlab.com/nanuchi/youtube-tutorial-series/-/tree/master/kubernetes-volumes](https://gitlab.com/nanuchi/youtube-tutorial-series/-/tree/master/kubernetes-volumes)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
**ë³¼ë¥¨ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì— ìˆì§€ ì•Šë‹¤ëŠ” ì ì— ìœ ì˜í•˜ì„¸ìš”.**

### ë„¤ì„ìŠ¤í˜ì´ìŠ¤

KubernetesëŠ” ë™ì¼í•œ ë¬¼ë¦¬ì  í´ëŸ¬ìŠ¤í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” **ë‹¤ìˆ˜ì˜ ê°€ìƒ í´ëŸ¬ìŠ¤í„°**ë¥¼ ì§€ì›í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ê°€ìƒ í´ëŸ¬ìŠ¤í„°ë¥¼ **ë„¤ì„ìŠ¤í˜ì´ìŠ¤**ë¼ê³  í•©ë‹ˆë‹¤. ì´ëŠ” ì—¬ëŸ¬ íŒ€ì´ë‚˜ í”„ë¡œì íŠ¸ì— ê±¸ì³ ë§ì€ ì‚¬ìš©ìê°€ ìˆëŠ” í™˜ê²½ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. ëª‡ ëª…ì—ì„œ ìˆ˜ì‹­ ëª…ì˜ ì‚¬ìš©ìë¡œ êµ¬ì„±ëœ í´ëŸ¬ìŠ¤í„°ì˜ ê²½ìš°, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ê³ ë ¤í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. Kubernetesì— ë°°í¬ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê° ë¶€ë¶„ì„ ë” ì˜ ì œì–´í•˜ê³  ì¡°ì§í•˜ê¸° ìœ„í•´ì„œë§Œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê¸° ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.

ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ì´ë¦„ì— ëŒ€í•œ ë²”ìœ„ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ë¦¬ì†ŒìŠ¤ì˜ ì´ë¦„ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œ ê³ ìœ í•´ì•¼ í•˜ì§€ë§Œ, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê°„ì—ëŠ” ê³ ìœ í•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ì„œë¡œ ì¤‘ì²©ë  ìˆ˜ ì—†ìœ¼ë©°, **ê°** Kubernetes **ë¦¬ì†ŒìŠ¤**ëŠ” **í•˜ë‚˜ì˜** **ë„¤ì„ìŠ¤í˜ì´ìŠ¤**ì—ë§Œ **ìˆì„ ìˆ˜** ìˆìŠµë‹ˆë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ minikubeë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° 4ê°œì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ìˆìŠµë‹ˆë‹¤:
```
kubectl get namespace
NAME              STATUS   AGE
default           Active   1d
kube-node-lease   Active   1d
kube-public       Active   1d
kube-system       Active   1d
```
- **kube-system**: ì‚¬ìš©ì ì‚¬ìš©ì„ ìœ„í•œ ê²ƒì´ ì•„ë‹ˆë©° ê±´ë“œë¦¬ì§€ ë§ì•„ì•¼ í•©ë‹ˆë‹¤. ë§ˆìŠ¤í„° ë° kubectl í”„ë¡œì„¸ìŠ¤ë¥¼ ìœ„í•œ ê²ƒì…ë‹ˆë‹¤.
- **kube-public**: ê³µê°œì ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•œ ë°ì´í„°. í´ëŸ¬ìŠ¤í„° ì •ë³´ë¥¼ í¬í•¨í•˜ëŠ” configmapì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
- **kube-node-lease**: ë…¸ë“œì˜ ê°€ìš©ì„±ì„ ê²°ì •í•©ë‹ˆë‹¤.
- **default**: ì‚¬ìš©ìê°€ ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©í•  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì…ë‹ˆë‹¤.
```bash
#Create namespace
kubectl create namespace my-namespace
```
> [!NOTE]
> ëŒ€ë¶€ë¶„ì˜ Kubernetes ë¦¬ì†ŒìŠ¤(ì˜ˆ: pods, services, replication controllers ë“±)ëŠ” ì¼ë¶€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¦¬ì†ŒìŠ¤ì™€ ë…¸ë“œ ë° persistenVolumesì™€ ê°™ì€ ì €ìˆ˜ì¤€ ë¦¬ì†ŒìŠ¤ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì—†ìŠµë‹ˆë‹¤. ì–´ë–¤ Kubernetes ë¦¬ì†ŒìŠ¤ê°€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ìˆê³  ì—†ëŠ”ì§€ ë³´ë ¤ë©´:
>
> ```bash
> kubectl api-resources --namespaced=true #ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ìˆìŒ
> kubectl api-resources --namespaced=false #ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì—†ìŒ
> ```

í•´ë‹¹ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ëª¨ë“  í›„ì† kubectl ëª…ë ¹ì— ëŒ€í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
kubectl config set-context --current --namespace=<insert-namespace-name-here>
```
### Helm

Helmì€ Kubernetesì˜ **íŒ¨í‚¤ì§€ ê´€ë¦¬ì**ì…ë‹ˆë‹¤. YAML íŒŒì¼ì„ íŒ¨í‚¤ì§•í•˜ê³  ì´ë¥¼ ê³µìš© ë° ê°œì¸ ì €ì¥ì†Œì— ë°°í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ íŒ¨í‚¤ì§€ëŠ” **Helm Charts**ë¼ê³  í•©ë‹ˆë‹¤.
```
helm search <keyword>
```
Helmì€ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬ì„± íŒŒì¼ì„ ìƒì„±í•  ìˆ˜ ìˆëŠ” í…œí”Œë¦¿ ì—”ì§„ì´ê¸°ë„ í•©ë‹ˆë‹¤:

## Kubernetes ë¹„ë°€

**ë¹„ë°€(Secret)**ì€ ë¹„ë°€ë²ˆí˜¸, í† í° ë˜ëŠ” í‚¤ì™€ ê°™ì€ **ë¯¼ê°í•œ ë°ì´í„°**ë¥¼ **í¬í•¨í•˜ëŠ” ê°ì²´**ì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ì •ë³´ëŠ” Pod ì‚¬ì–‘ì´ë‚˜ ì´ë¯¸ì§€ì— í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ë¹„ë°€ì„ ìƒì„±í•  ìˆ˜ ìˆìœ¼ë©° ì‹œìŠ¤í…œì—ì„œë„ ë¹„ë°€ì„ ìƒì„±í•©ë‹ˆë‹¤. ë¹„ë°€ ê°ì²´ì˜ ì´ë¦„ì€ ìœ íš¨í•œ **DNS í•˜ìœ„ ë„ë©”ì¸ ì´ë¦„**ì´ì–´ì•¼ í•©ë‹ˆë‹¤. [ê³µì‹ ë¬¸ì„œ](https://kubernetes.io/docs/concepts/configuration/secret/)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

ë¹„ë°€ì€ ë‹¤ìŒê³¼ ê°™ì€ ê²ƒì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- API, SSH í‚¤.
- OAuth í† í°.
- ìê²© ì¦ëª…, ë¹„ë°€ë²ˆí˜¸(ì¼ë°˜ í…ìŠ¤íŠ¸ ë˜ëŠ” b64 + ì•”í˜¸í™”).
- ì •ë³´ ë˜ëŠ” ì£¼ì„.
- ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì½”ë“œ, ë¬¸ìì—´â€¦ .

Kubernetesì—ëŠ” ë‹¤ì–‘í•œ ìœ í˜•ì˜ ë¹„ë°€ì´ ìˆìŠµë‹ˆë‹¤.

| ë‚´ì¥ ìœ í˜•                           | ì‚¬ìš©                                     |
| ----------------------------------- | ----------------------------------------- |
| **Opaque**                          | **ì„ì˜ì˜ ì‚¬ìš©ì ì •ì˜ ë°ì´í„°(ê¸°ë³¸ê°’)**     |
| kubernetes.io/service-account-token | ì„œë¹„ìŠ¤ ê³„ì • í† í°                        |
| kubernetes.io/dockercfg             | ì§ë ¬í™”ëœ \~/.dockercfg íŒŒì¼              |
| kubernetes.io/dockerconfigjson      | ì§ë ¬í™”ëœ \~/.docker/config.json íŒŒì¼     |
| kubernetes.io/basic-auth            | ê¸°ë³¸ ì¸ì¦ì„ ìœ„í•œ ìê²© ì¦ëª…               |
| kubernetes.io/ssh-auth              | SSH ì¸ì¦ì„ ìœ„í•œ ìê²© ì¦ëª…                |
| kubernetes.io/tls                   | TLS í´ë¼ì´ì–¸íŠ¸ ë˜ëŠ” ì„œë²„ë¥¼ ìœ„í•œ ë°ì´í„°   |
| bootstrap.kubernetes.io/token       | ë¶€íŠ¸ìŠ¤íŠ¸ë© í† í° ë°ì´í„°                   |

> [!NOTE]
> **Opaque ìœ í˜•ì€ ê¸°ë³¸ê°’ìœ¼ë¡œ, ì‚¬ìš©ìê°€ ì •ì˜í•œ ì „í˜•ì ì¸ í‚¤-ê°’ ìŒì…ë‹ˆë‹¤.**

**ë¹„ë°€ì´ ì‘ë™í•˜ëŠ” ë°©ì‹:**

![](https://sickrov.github.io/media/Screenshot-164.jpg)

ë‹¤ìŒ êµ¬ì„± íŒŒì¼ì€ `mysecret`ì´ë¼ëŠ” **ë¹„ë°€**ì„ ì •ì˜í•˜ë©°, 2ê°œì˜ í‚¤-ê°’ ìŒ `username: YWRtaW4=` ë° `password: MWYyZDFlMmU2N2Rm`ì„ í¬í•¨í•©ë‹ˆë‹¤. ë˜í•œ `mysecret`ì— ì •ì˜ëœ `username` ë° `password`ê°€ **í™˜ê²½ ë³€ìˆ˜** `SECRET_USERNAME` \_\_ ë° \_\_ `SECRET_PASSWOR`ì— ë…¸ì¶œë˜ëŠ” `secretpod`ë¼ëŠ” **pod**ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ë˜í•œ `mysecret` ë‚´ì˜ `username` ë¹„ë°€ì„ `/etc/foo/my-group/my-username` ê²½ë¡œì— `0640` ê¶Œí•œìœ¼ë¡œ **ë§ˆìš´íŠ¸**í•©ë‹ˆë‹¤.
```yaml:secretpod.yaml
apiVersion: v1
kind: Secret
metadata:
name: mysecret
type: Opaque
data:
username: YWRtaW4=
password: MWYyZDFlMmU2N2Rm
---
apiVersion: v1
kind: Pod
metadata:
name: secretpod
spec:
containers:
- name: secretpod
image: nginx
env:
- name: SECRET_USERNAME
valueFrom:
secretKeyRef:
name: mysecret
key: username
- name: SECRET_PASSWORD
valueFrom:
secretKeyRef:
name: mysecret
key: password
volumeMounts:
- name: foo
mountPath: "/etc/foo"
restartPolicy: Never
volumes:
- name: foo
secret:
secretName: mysecret
items:
- key: username
path: my-group/my-username
mode: 0640
```

```bash
kubectl apply -f <secretpod.yaml>
kubectl get pods #Wait until the pod secretpod is running
kubectl exec -it  secretpod -- bash
env | grep SECRET && cat /etc/foo/my-group/my-username && echo
```
### Secrets in etcd <a href="#discover-secrets-in-etcd" id="discover-secrets-in-etcd"></a>

**etcd**ëŠ” ëª¨ë“  í´ëŸ¬ìŠ¤í„° ë°ì´í„°ì— ëŒ€í•œ Kubernetes ë°±ì—… ì €ì¥ì†Œë¡œ ì‚¬ìš©ë˜ëŠ” ì¼ê´€ì„± ìˆê³  ê³ ê°€ìš©ì„± **í‚¤-ê°’ ì €ì¥ì†Œ**ì…ë‹ˆë‹¤. etcdì— ì €ì¥ëœ ë¹„ë°€ì— ì ‘ê·¼í•´ ë³´ê² ìŠµë‹ˆë‹¤:
```bash
cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep etcd
```
ë‹¹ì‹ ì€ FSì— ìœ„ì¹˜í•œ certs, keys ë° urlì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ì–»ìœ¼ë©´ etcdì— ì—°ê²°í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.
```bash
#ETCDCTL_API=3 etcdctl --cert <path to client.crt> --key <path to client.ket> --cacert <path to CA.cert> endpoint=[<ip:port>] health

ETCDCTL_API=3 etcdctl --cert /etc/kubernetes/pki/apiserver-etcd-client.crt --key /etc/kubernetes/pki/apiserver-etcd-client.key --cacert /etc/kubernetes/pki/etcd/etcd/ca.cert endpoint=[127.0.0.1:1234] health
```
í•œ ë²ˆ í†µì‹ ì„ ì„¤ì •í•˜ë©´ ë¹„ë°€ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
#ETCDCTL_API=3 etcdctl --cert <path to client.crt> --key <path to client.ket> --cacert <path to CA.cert> endpoint=[<ip:port>] get <path/to/secret>

ETCDCTL_API=3 etcdctl --cert /etc/kubernetes/pki/apiserver-etcd-client.crt --key /etc/kubernetes/pki/apiserver-etcd-client.key --cacert /etc/kubernetes/pki/etcd/etcd/ca.cert endpoint=[127.0.0.1:1234] get /registry/secrets/default/secret_02
```
**ETCDì— ì•”í˜¸í™” ì¶”ê°€í•˜ê¸°**

ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  ë¹„ë°€ì€ **ì¼ë°˜** í…ìŠ¤íŠ¸ë¡œ etcdì— ì €ì¥ë˜ë©°, ì•”í˜¸í™” ê³„ì¸µì„ ì ìš©í•˜ì§€ ì•ŠëŠ” í•œ ê·¸ë ‡ìŠµë‹ˆë‹¤. ë‹¤ìŒ ì˜ˆì‹œëŠ” [https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/](https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.
```yaml:encryption.yaml
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
- resources:
- secrets
providers:
- aescbc:
keys:
- name: key1
secret: cjjPMcWpTPKhAdieVtd+KhG4NN+N6e3NmBPMXJvbfrY= #Any random key
- identity: {}
```
ê·¸ í›„, ìƒì„±ëœ êµ¬ì„± íŒŒì¼ì˜ ìœ„ì¹˜ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ `kube-apiserver`ì—ì„œ `--encryption-provider-config` í”Œë˜ê·¸ë¥¼ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤. `/etc/kubernetes/manifest/kube-apiserver.yaml`ë¥¼ ìˆ˜ì •í•˜ê³  ë‹¤ìŒ ì¤„ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```yaml
containers:
- command:
- kube-apiserver
- --encriyption-provider-config=/etc/kubernetes/etcd/<configFile.yaml>
```
volumeMountsì—ì„œ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ì„¸ìš”:
```yaml
- mountPath: /etc/kubernetes/etcd
name: etcd
readOnly: true
```
volumeMountsì—ì„œ hostPathë¡œ ìŠ¤í¬ë¡¤í•˜ì„¸ìš”:
```yaml
- hostPath:
path: /etc/kubernetes/etcd
type: DirectoryOrCreate
name: etcd
```
**ë°ì´í„°ê°€ ì•”í˜¸í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê¸°**

ë°ì´í„°ëŠ” etcdì— ê¸°ë¡ë  ë•Œ ì•”í˜¸í™”ë©ë‹ˆë‹¤. `kube-apiserver`ë¥¼ ì¬ì‹œì‘í•œ í›„, ìƒˆë¡œ ìƒì„±ë˜ê±°ë‚˜ ì—…ë°ì´íŠ¸ëœ ë¹„ë°€ì€ ì €ì¥ë  ë•Œ ì•”í˜¸í™”ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. í™•ì¸í•˜ë ¤ë©´ `etcdctl` ëª…ë ¹ì¤„ í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•˜ì—¬ ë¹„ë°€ì˜ ë‚´ìš©ì„ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

1.  `default` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— `secret1`ì´ë¼ëŠ” ìƒˆ ë¹„ë°€ì„ ìƒì„±í•©ë‹ˆë‹¤:

```
kubectl create secret generic secret1 -n default --from-literal=mykey=mydata
```

2.  etcdctl ëª…ë ¹ì¤„ì„ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ ë¹„ë°€ì„ etcdì—ì„œ ì½ìŠµë‹ˆë‹¤:

`ETCDCTL_API=3 etcdctl get /registry/secrets/default/secret1 [...] | hexdump -C`

ì—¬ê¸°ì„œ `[...]`ëŠ” etcd ì„œë²„ì— ì—°ê²°í•˜ê¸° ìœ„í•œ ì¶”ê°€ ì¸ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.

3.  ì €ì¥ëœ ë¹„ë°€ì´ `k8s:enc:aescbc:v1:`ë¡œ ì ‘ë‘ì‚¬ê°€ ë¶™ì–´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ì´ëŠ” `aescbc` ì œê³µìê°€ ê²°ê³¼ ë°ì´í„°ë¥¼ ì•”í˜¸í™”í–ˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
4.  APIë¥¼ í†µí•´ ê²€ìƒ‰í•  ë•Œ ë¹„ë°€ì´ ì˜¬ë°”ë¥´ê²Œ ë³µí˜¸í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤:

```
kubectl describe secret secret1 -n default
```

`mykey: bXlkYXRh`ì™€ ì¼ì¹˜í•´ì•¼ í•˜ë©°, mydataëŠ” ì¸ì½”ë”©ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë¹„ë°€ì„ ì™„ì „íˆ ë³µí˜¸í™”í•˜ë ¤ë©´ [ë¹„ë°€ ë³µí˜¸í™”](https://kubernetes.io/docs/concepts/configuration/secret#decoding-a-secret)ë¥¼ í™•ì¸í•˜ì„¸ìš”.

**ë¹„ë°€ì€ ê¸°ë¡ ì‹œ ì•”í˜¸í™”ë˜ë¯€ë¡œ, ë¹„ë°€ì„ ì—…ë°ì´íŠ¸í•˜ë©´ í•´ë‹¹ ë‚´ìš©ì´ ì•”í˜¸í™”ë©ë‹ˆë‹¤:**
```
kubectl get secrets --all-namespaces -o json | kubectl replace -f -
```
**ìµœì¢… íŒ:**

- íŒŒì¼ ì‹œìŠ¤í…œì— ë¹„ë°€ì„ ì €ì¥í•˜ì§€ ì•Šë„ë¡ í•˜ê³ , ë‹¤ë¥¸ ê³³ì—ì„œ ê°€ì ¸ì˜¤ì„¸ìš”.
- ë¹„ë°€ì„ ë³´í˜¸í•˜ê¸° ìœ„í•´ [https://www.vaultproject.io/](https://www.vaultproject.io) ë¥¼ í™•ì¸í•˜ì„¸ìš”.
- [https://kubernetes.io/docs/concepts/configuration/secret/#risks](https://kubernetes.io/docs/concepts/configuration/secret/#risks)
- [https://docs.cyberark.com/Product-Doc/OnlineHelp/AAM-DAP/11.2/en/Content/Integrations/Kubernetes_deployApplicationsConjur-k8s-Secrets.htm](https://docs.cyberark.com/Product-Doc/OnlineHelp/AAM-DAP/11.2/en/Content/Integrations/Kubernetes_deployApplicationsConjur-k8s-Secrets.htm)

## ì°¸ê³ ë¬¸í—Œ

{{#ref}}
https://sickrov.github.io/
{{#endref}}

{{#ref}}
https://www.youtube.com/watch?v=X48VuDVv0do
{{#endref}}

{{#include ../../banners/hacktricks-training.md}}
