# Pentesting Kubernetes Services

{{#include ../../../banners/hacktricks-training.md}}

Kubernetes inatumia **huduma maalum za mtandao** kadhaa ambazo unaweza kupata **zilizo wazi kwa Mtandao** au katika **mtandao wa ndani mara tu unapovunja pod moja**.

## Kutafuta pods zilizo wazi kwa OSINT

Njia moja inaweza kuwa kutafuta `Identity LIKE "k8s.%.com"` katika [crt.sh](https://crt.sh) ili kupata subdomains zinazohusiana na kubernetes. Njia nyingine inaweza kuwa kutafuta `"k8s.%.com"` katika github na kutafuta **faili za YAML** zinazojumuisha string hiyo.

## Jinsi Kubernetes Inavyofichua Huduma

Inaweza kuwa na manufaa kwako kuelewa jinsi Kubernetes inaweza **kufichua huduma hadharani** ili kuweza kuzitafuta:

{{#ref}}
../exposing-services-in-kubernetes.md
{{#endref}}

## Kutafuta pods zilizo wazi kupitia skanning ya port

Port zifuatazo zinaweza kuwa wazi katika klasta ya Kubernetes:

| Port            | Process        | Maelezo                                                               |
| --------------- | -------------- | --------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Port ya API ya Kubernetes                                             |
| 2379/TCP        | etcd           |                                                                       |
| 6666/TCP        | etcd           | etcd                                                                  |
| 4194/TCP        | cAdvisor       | Vipimo vya kontena                                                   |
| 6443/TCP        | kube-apiserver | Port ya API ya Kubernetes                                             |
| 8443/TCP        | kube-apiserver | Port ya API ya Minikube                                              |
| 8080/TCP        | kube-apiserver | Port ya API isiyo salama                                            |
| 10250/TCP       | kubelet        | API ya HTTPS inayoruhusu ufikiaji wa hali kamili                    |
| 10255/TCP       | kubelet        | Port ya HTTP isiyo na uthibitisho ya kusoma pekee: pods, pods zinazotembea na hali ya node |
| 10256/TCP       | kube-proxy     | Server ya ukaguzi wa afya ya Kube Proxy                             |
| 9099/TCP        | calico-felix   | Server ya ukaguzi wa afya kwa Calico                                 |
| 6782-4/TCP      | weave          | Vipimo na mwisho                                                    |
| 30000-32767/TCP | NodePort       | Proxy kwa huduma                                                     |
| 44134/TCP       | Tiller         | Huduma ya Helm inayosikiliza                                         |

### Nmap
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
### Kube-apiserver

Hii ni **huduma ya API ya Kubernetes** ambayo wasimamizi huwasiliana nayo mara nyingi wakitumia chombo **`kubectl`**.

**Bandari za kawaida: 6443 na 443**, lakini pia 8443 katika minikube na 8080 kama isiyo salama.
```bash
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Angalia ukurasa ufuatao kujifunza jinsi ya kupata data nyeti na kutekeleza hatua nyeti ukizungumza na huduma hii:**

{{#ref}}
../kubernetes-enumeration.md
{{#endref}}

### Kubelet API

Huduma hii **inafanya kazi katika kila node ya klasta**. Ni huduma ambayo itakuwa **na udhibiti** wa pods ndani ya **node**. Inazungumza na **kube-apiserver**.

Ikiwa utapata huduma hii imewekwa wazi unaweza kuwa umepata **RCE isiyo na uthibitisho**.

#### Kubelet API
```bash
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Ikiwa jibu ni `Unauthorized` basi inahitaji uthibitisho.

Ikiwa unaweza kuorodhesha nodi unaweza kupata orodha ya mwisho za kubelets kwa:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Soma tu)
```bash
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API
```bash
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```bash
helm --host tiller-deploy.kube-system:44134 version
```
You could abuse this service to escalate privileges inside Kubernetes:

### cAdvisor

Huduma inayofaa kukusanya metriki.
```bash
curl -k https://<IP Address>:4194
```
### NodePort

Wakati bandari inafichuliwa katika nodi zote kupitia **NodePort**, bandari hiyo hiyo inafunguliwa katika nodi zote ikipitia trafiki kwenye **Service** iliyotangazwa. Kwa default, bandari hii itakuwa katika **range 30000-32767**. Hivyo, huduma mpya zisizokaguliwa zinaweza kupatikana kupitia bandari hizo.
```bash
sudo nmap -sS -p 30000-32767 <IP>
```
## Vulnerable Misconfigurations

### Kube-apiserver Anonymous Access

Upatikanaji wa bila jina kwa **kube-apiserver API endpoints haukubaliwi**. Lakini unaweza kuangalia baadhi ya endpoints:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Checking for ETCD Anonymous Access**

ETCD inahifadhi siri za klasta, faili za usanidi na data **nyeti zaidi**. Kwa **kawaida**, ETCD **haiwezi** kufikiwa **bila jina**, lakini kila wakati ni vizuri kuangalia.

Ikiwa ETCD inaweza kufikiwa bila jina, unaweza kuhitaji **kutumia** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **chombo**. Amri ifuatayo itapata funguo zote zilizohifadhiwa:
```bash
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

The [**Kubelet documentation**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) inaeleza kwamba kwa **default ufikiaji wa kutotambulika** kwa huduma unaruhusiwa:

> Inaruhusu maombi ya kutotambulika kwa seva ya Kubelet. Maombi ambayo hayakukataliwa na njia nyingine ya uthibitishaji yanachukuliwa kama maombi ya kutotambulika. Maombi ya kutotambulika yana jina la mtumiaji `system:anonymous`, na jina la kundi `system:unauthenticated`

Ili kuelewa vizuri jinsi **uthibitishaji na idhini ya Kubelet API inavyofanya kazi**, angalia ukurasa huu:

{{#ref}}
kubelet-authentication-and-authorization.md
{{#endref}}

Huduma ya **Kubelet** **API haijandikwa**, lakini msimbo wa chanzo unaweza kupatikana hapa na kupata mwisho ulio wazi ni rahisi kama **kukimbia**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Yote yanaonekana kuwa ya kuvutia.

Unaweza kutumia chombo cha [**Kubeletctl**](https://github.com/cyberark/kubeletctl) kuingiliana na Kubelets na mwisho wao.

#### /pods

Mwishoni hapa orodha ya pods na konteina zao:
```bash
kubeletctl pods
```
#### /exec

Hii endpoint inaruhusu kutekeleza msimbo ndani ya kontena yoyote kwa urahisi:
```bash
kubeletctl exec [command]
```
> [!NOTE]
> Ili kuepuka shambulio hili, huduma ya _**kubelet**_ inapaswa kuendeshwa na `--anonymous-auth false` na huduma hiyo inapaswa kutengwa katika ngazi ya mtandao.

### **Kuangalia Kuwekwa wazi kwa Taarifa za Kubelet (Bandari ya Kusoma Tu)**

Wakati **bandari ya kubelet ya kusoma tu** imewekwa wazi, inakuwa inawezekana kwa taarifa kutolewa kutoka kwa API na wahusika wasioidhinishwa. Kuwekwa wazi kwa bandari hii kunaweza kusababisha kufichuliwa kwa vipengele mbalimbali vya **mipangilio ya klasta**. Ingawa taarifa, ikiwa ni pamoja na **majina ya pod, maeneo ya faili za ndani, na mipangilio mingine**, inaweza isiwe muhimu, kuwekwa wazi kwake bado kunaweka hatari ya usalama na inapaswa kuepukwa.

Mfano wa jinsi udhaifu huu unaweza kutumika ni pamoja na mshambuliaji wa mbali kufikia URL maalum. Kwa kuingia kwenye `http://<external-IP>:10255/pods`, mshambuliaji anaweza kupata taarifa nyeti kutoka kwa kubelet:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Marejeo

{{#ref}}
https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2
{{#endref}}

{{#ref}}
https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
