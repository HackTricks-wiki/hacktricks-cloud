# Pentesting Mbinu za Wingu

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## Mbinu za Msingi

Kila wingu lina sifa zake, lakini kwa ujumla kuna mambo machache ya **kawaida ambayo pentester anapaswa kukagua** anapomfanyia mtihani mazingira ya wingu:

- **Ukaguzi wa benchmark**
- Hii itakusaidia **kuelewa ukubwa** wa mazingira na **huduma zinazotumika**
- Pia itakuwezesha kupata baadhi ya **misconfigurations za haraka** kwani unaweza kufanya sehemu kubwa ya vipimo hivi kwa **zana za otomatiki**
- **Uorodheshaji wa huduma**
- Huenda usipate misconfigurations nyingi zaidi hapa ikiwa umefanya kwa usahihi ukaguzi wa benchmark, lakini unaweza kupata baadhi ambazo hazikutazamwa katika ukaguzi wa benchmark.
- Hii itakuwezesha kujua **ni nini hasa kinachotumika** katika mazingira ya wingu
- Hii itasaidia sana katika hatua zinazofuata
- **Kagua assets zilizo wazi**
- Hii inaweza kufanywa wakati wa sehemu iliyopita; unahitaji **gundua kila kitu kinachoweza kufichuliwa** kwa Internet kwa njia fulani na jinsi kinavyoweza kupatikana.
- Hapa ninamaanisha **infrastruktura iliyofichuliwa kwa mkono** kama instances zenye kurasa za wavuti au port nyingine zilizo wazi, na pia huduma nyingine zinazodhibitiwa na cloud zinazoweza kusanidiwa kufichuliwa (kama DBs au buckets)
- Kisha unapaswa kukagua **kama rasilimali hiyo inaweza kufichuliwa au la** (maelezo ya siri? vulnerabilities? misconfigurations katika huduma iliyofichuliwa?)
- **Kagua ruhusa**
- Hapa unapaswa **kubaini ruhusa zote za kila role/user** ndani ya wingu na jinsi zinavyotumika
- Je, kuna akaunti nyingi zenye **ruhusa za juu sana** (zinadhibiti kila kitu)? Mifumo ya funguo iliyotengenezwa haitumiki?... Sehemu kubwa za ukaguzi hizi zilipaswa kufanywa tayari katika ukaguzi wa benchmark
- Ikiwa mteja anatumia OpenID au SAML au utoaji mwingine wa **federation** unaweza kuhitaji kuwauliza taarifa zaidi kuhusu **jinsi kila role inavyoteuliwa** (si sawa role ya admin kupewa mtumiaji 1 au 100)
- Haijatosha kupata ni watumiaji gani wenye ruhusa za admin "*:*". Kuna ruhusa nyingi nyingine ambazo, kulingana na huduma zinazotumika, zinaweza kuwa sana **nyeti**.
- Zaidi ya hayo, kuna njia za **privesc** zinazowezekana kufuatwa kwa kutumia vibaya ruhusa. Mambo haya yote yanapaswa kuzingatiwa na **mara nyingi iwezekanavyo njia za privesc** ziwasilishwe katika ripoti.
- **Kagua Integrations**
- Inawezekana sana kwamba **integrations na wingu zingine au SaaS** zimetumika ndani ya mazingira ya wingu.
- Kwa **integrations za wingu unayechunguza** na platform nyingine unapaswa kuwajulisha **nani anaweza kufikia (au kutumia vibaya) integration hiyo** na unapaswa kuuliza **je, kitendo kinachofanywa ni cha kiasi gani nyeti**.\
Kwa mfano, nani anaweza kuandika katika bucket ya AWS ambapo GCP inachukua data kutoka (uliza jinsi kitendo hicho kinavyonyeti kwa GCP kinaposhughulikia data hiyo).
- Kwa **integrations ndani ya wingu unayechunguza** kutoka kwa platform za nje, unapaswa kuuliza **nani ana ufikiaji wa nje wa (kutumia vibaya) integration hiyo** na kukagua jinsi data hiyo inavyotumika.\
Kwa mfano, ikiwa huduma inatumia Docker image iliyohostwa katika GCR, unapaswa kuuliza nani ana ufikiaji wa kuibadilisha na ni taarifa nyeti na upatikanaji gani vitapatikana kwa image hiyo ikitekelezwa ndani ya AWS cloud.

## Multi-Cloud tools

Kuna zana kadhaa zinazoweza kutumika kujaribu mazingira tofauti ya wingu. Hatua za usakinishaji na viungo vitatajwa katika sehemu hii.

### [PurplePanda](https://github.com/carlospolop/purplepanda)

Zana ya **kutambua misconfigurations na privesc path katika cloud na kwa kuvuka cloud/SaaS.**

{{#tabs }}
{{#tab name="Install" }}
```bash
# You need to install and run neo4j also
git clone https://github.com/carlospolop/PurplePanda
cd PurplePanda
python3 -m venv .
source bin/activate
python3 -m pip install -r requirements.txt
export PURPLEPANDA_NEO4J_URL="bolt://neo4j@localhost:7687"
export PURPLEPANDA_PWD="neo4j_pwd_4_purplepanda"
python3 main.py -h # Get help
```
{{#endtab }}

{{#tab name="GCP" }}
```bash
export GOOGLE_DISCOVERY=$(echo 'google:
- file_path: ""

- file_path: ""
service_account_id: "some-sa-email@sidentifier.iam.gserviceaccount.com"' | base64)

python3 main.py -a -p google #Get basic info of the account to check it's correctly configured
python3 main.py -e -p google #Enumerate the env
```
{{#endtab }}
{{#endtabs }}

### [Prowler](https://github.com/prowler-cloud/prowler)

Inasaidia **AWS, GCP & Azure**. Angalia jinsi ya kusanidi kila mtoa huduma kwenye [https://docs.prowler.cloud/en/latest/#aws](https://docs.prowler.cloud/en/latest/#aws)
```bash
# Install
pip install prowler
prowler -v

# Run
prowler <provider>
# Example
prowler aws --profile custom-profile [-M csv json json-asff html]

# Get info about checks & services
prowler <provider> --list-checks
prowler <provider> --list-services
```
### [CloudSploit](https://github.com/aquasecurity/cloudsploit)

AWS, Azure, Github, Google, Oracle, Alibaba

{{#tabs }}
{{#tab name="Install" }}
```bash
# Install
git clone https://github.com/aquasecurity/cloudsploit.git
cd cloudsploit
npm install
./index.js -h
## Docker instructions in github
```
{{#endtab }}

{{#tab name="GCP" }}
```bash
## You need to have creds for a service account and set them in config.js file
./index.js --cloud google --config </abs/path/to/config.js>
```
{{#endtab }}
{{#endtabs }}

### [ScoutSuite](https://github.com/nccgroup/ScoutSuite)

AWS, Azure, GCP, Alibaba Cloud, Oracle Cloud Infrastructure

{{#tabs }}
{{#tab name="Install" }}
```bash
mkdir scout; cd scout
virtualenv -p python3 venv
source venv/bin/activate
pip install scoutsuite
scout --help
## Using Docker: https://github.com/nccgroup/ScoutSuite/wiki/Docker-Image
```
{{#endtab }}

{{#tab name="GCP" }}
```bash
scout gcp --report-dir /tmp/gcp --user-account --all-projects
## use "--service-account KEY_FILE" instead of "--user-account" to use a service account

SCOUT_FOLDER_REPORT="/tmp"
for pid in $(gcloud projects list --format="value(projectId)"); do
echo "================================================"
echo "Checking $pid"
mkdir "$SCOUT_FOLDER_REPORT/$pid"
scout gcp --report-dir "$SCOUT_FOLDER_REPORT/$pid" --no-browser --user-account --project-id "$pid"
done
```
{{#endtab }}
{{#endtabs }}

### [Steampipe](https://github.com/turbot)

{{#tabs }}
{{#tab name="Install" }}
Pakua na sakinisha Steampipe ([https://steampipe.io/downloads](https://steampipe.io/downloads)). Au tumia Brew:
```
brew tap turbot/tap
brew install steampipe
```
{{#endtab }}

{{#tab name="GCP" }}
```bash
# Install gcp plugin
steampipe plugin install gcp

# Use https://github.com/turbot/steampipe-mod-gcp-compliance.git
git clone https://github.com/turbot/steampipe-mod-gcp-compliance.git
cd steampipe-mod-gcp-compliance
# To run all the checks from the dashboard
steampipe dashboard
# To run all the checks from rhe cli
steampipe check all
```
<details>

<summary>Angalia Miradi Zote</summary>

Ili kukagua miradi yote, unahitaji kuunda faili `gcp.spc` inayotaja miradi yote ya kujaribu. Unaweza kufuata maelekezo kutoka kwenye script ifuatayo.
```bash
FILEPATH="/tmp/gcp.spc"
rm -rf "$FILEPATH" 2>/dev/null

# Generate a json like object for each project
for pid in $(gcloud projects list --format="value(projectId)"); do
echo "connection \"gcp_$(echo -n $pid | tr "-" "_" )\" {
plugin  = \"gcp\"
project = \"$pid\"
}" >> "$FILEPATH"
done

# Generate the aggragator to call
echo 'connection "gcp_all" {
plugin      = "gcp"
type        = "aggregator"
connections = ["gcp_*"]
}' >> "$FILEPATH"

echo "Copy $FILEPATH in ~/.steampipe/config/gcp.spc if it was correctly generated"
```
</details>

Ili kuangalia **insights nyingine za GCP** (zinazotumika kuorodhesha huduma) tumia: [https://github.com/turbot/steampipe-mod-gcp-insights](https://github.com/turbot/steampipe-mod-gcp-insights)

Ili kuangalia msimbo wa Terraform wa GCP: [https://github.com/turbot/steampipe-mod-terraform-gcp-compliance](https://github.com/turbot/steampipe-mod-terraform-gcp-compliance)

Viendelezi vingine vya GCP vya Steampipe: [https://github.com/turbot?q=gcp](https://github.com/turbot?q=gcp)
{{#endtab }}

{{#tab name="AWS" }}
```bash
# Install aws plugin
steampipe plugin install aws

# Modify the spec indicating in "profile" the profile name to use
nano ~/.steampipe/config/aws.spc

# Get some info on how the AWS account is being used
git clone https://github.com/turbot/steampipe-mod-aws-insights.git
cd steampipe-mod-aws-insights
steampipe dashboard

# Get the services exposed to the internet
git clone https://github.com/turbot/steampipe-mod-aws-perimeter.git
cd steampipe-mod-aws-perimeter
steampipe dashboard

# Run the benchmarks
git clone https://github.com/turbot/steampipe-mod-aws-compliance
cd steampipe-mod-aws-compliance
steampipe dashboard # To see results in browser
steampipe check all --export=/tmp/output4.json
```
Ili kukagua msimbo wa Terraform wa AWS: [https://github.com/turbot/steampipe-mod-terraform-aws-compliance](https://github.com/turbot/steampipe-mod-terraform-aws-compliance)

Viendeleo zaidi za AWS za Steampipe: [https://github.com/orgs/turbot/repositories?q=aws](https://github.com/orgs/turbot/repositories?q=aws)
{{#endtab }}
{{#endtabs }}

### [~~cs-suite~~](https://github.com/SecurityFTW/cs-suite)

AWS, GCP, Azure, DigitalOcean.\
Inahitaji python2.7 na inaonekana haijatunzwa.

### Nessus

Nessus ina skani ya _**Audit Cloud Infrastructure**_ inayounga mkono: AWS, Azure, Office 365, Rackspace, Salesforce. Marekebisho ya ziada kwenye **Azure** yanahitajika kupata a **Client Id**.

### [**cloudlist**](https://github.com/projectdiscovery/cloudlist)

Cloudlist ni chombo cha **multi-cloud** kwa kupata Assets (Hostnames, IP Addresses) kutoka kwa Cloud Providers.

{{#tabs }}
{{#tab name="Cloudlist" }}
```bash
cd /tmp
wget https://github.com/projectdiscovery/cloudlist/releases/latest/download/cloudlist_1.0.1_macOS_arm64.zip
unzip cloudlist_1.0.1_macOS_arm64.zip
chmod +x cloudlist
sudo mv cloudlist /usr/local/bin
```
{{#endtab }}

{{#tab name="Second Tab" }}
```bash
## For GCP it requires service account JSON credentials
cloudlist -config </path/to/config>
```
{{#endtab }}
{{#endtabs }}

### [**cartography**](https://github.com/lyft/cartography)

Cartography ni zana ya Python inayokusanya rasilimali za miundombinu na uhusiano kati yao katika mtazamo wa grafu unaoeleweka kwa urahisi unaotumia hifadhidata ya Neo4j.

{{#tabs }}
{{#tab name="Install" }}
```bash
# Installation
docker image pull ghcr.io/lyft/cartography
docker run --platform linux/amd64 ghcr.io/lyft/cartography cartography --help
## Install a Neo4j DB version 3.5.*
```
{{#endtab }}

{{#tab name="GCP" }}
```bash
docker run --platform linux/amd64 \
--volume "$HOME/.config/gcloud/application_default_credentials.json:/application_default_credentials.json" \
-e GOOGLE_APPLICATION_CREDENTIALS="/application_default_credentials.json" \
-e NEO4j_PASSWORD="s3cr3t" \
ghcr.io/lyft/cartography  \
--neo4j-uri bolt://host.docker.internal:7687 \
--neo4j-password-env-var NEO4j_PASSWORD \
--neo4j-user neo4j


# It only checks for a few services inside GCP (https://lyft.github.io/cartography/modules/gcp/index.html)
## Cloud Resource Manager
## Compute
## DNS
## Storage
## Google Kubernetes Engine
### If you can run starbase or purplepanda you will get more info
```
{{#endtab }}
{{#endtabs }}

### [**starbase**](https://github.com/JupiterOne/starbase)

Starbase inakusanya mali na uhusiano kutoka kwa huduma na mifumo, ikijumuisha cloud infrastructure, SaaS applications, udhibiti wa usalama, na zaidi, yote katika muonekano wa grafu unaoeleweka ulioungwa mkono na Neo4j database.

{{#tabs }}
{{#tab name="Install" }}
```bash
# You are going to need Node version 14, so install nvm following https://tecadmin.net/install-nvm-macos-with-homebrew/
npm install --global yarn
nvm install 14
git clone https://github.com/JupiterOne/starbase.git
cd starbase
nvm use 14
yarn install
yarn starbase --help
# Configure manually config.yaml depending on the env to analyze
yarn starbase setup
yarn starbase run

# Docker
git clone https://github.com/JupiterOne/starbase.git
cd starbase
cp config.yaml.example config.yaml
# Configure manually config.yaml depending on the env to analyze
docker build --no-cache -t starbase:latest .
docker-compose run starbase setup
docker-compose run starbase run
```
{{#endtab }}

{{#tab name="GCP" }}
```yaml
## Config for GCP
### Check out: https://github.com/JupiterOne/graph-google-cloud/blob/main/docs/development.md
### It requires service account credentials

integrations:
- name: graph-google-cloud
instanceId: testInstanceId
directory: ./.integrations/graph-google-cloud
gitRemoteUrl: https://github.com/JupiterOne/graph-google-cloud.git
config:
SERVICE_ACCOUNT_KEY_FILE: "{Check https://github.com/JupiterOne/graph-google-cloud/blob/main/docs/development.md#service_account_key_file-string}"
PROJECT_ID: ""
FOLDER_ID: ""
ORGANIZATION_ID: ""
CONFIGURE_ORGANIZATION_PROJECTS: false

storage:
engine: neo4j
config:
username: neo4j
password: s3cr3t
uri: bolt://localhost:7687
#Consider using host.docker.internal if from docker
```
{{#endtab }}
{{#endtabs }}

### [**SkyArk**](https://github.com/cyberark/SkyArk)

Gundua watumiaji walio na ruhusa za juu zaidi katika mazingira ya AWS au Azure yaliyokaguliwa, ikijumuisha AWS Shadow Admins. Inatumia powershell.
```bash
Import-Module .\SkyArk.ps1 -force
Start-AzureStealth

# in the Cloud Console
IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/cyberark/SkyArk/master/AzureStealth/AzureStealth.ps1')
Scan-AzureAdmins
```
### [Cloud Brute](https://github.com/0xsha/CloudBrute)

Zana ya kutafuta miundombinu ya kampuni (lengo), faili, na apps kwenye watoa huduma wakubwa wa cloud (Amazon, Google, Microsoft, DigitalOcean, Alibaba, Vultr, Linode).

### [CloudFox](https://github.com/BishopFox/cloudfox)

- CloudFox ni zana ya kutafuta exploitable attack paths katika cloud infrastructure (kwa sasa inasaidia tu AWS & Azure na GCP inakuja hivi karibuni).
- Ni enumeration tool iliyokusudiwa kukamilisha manual pentesting.
- Haiundii wala kuharibu data yoyote ndani ya cloud environment.

### More lists of cloud security tools

- [https://github.com/RyanJarv/awesome-cloud-sec](https://github.com/RyanJarv/awesome-cloud-sec)

## Google

### GCP

{{#ref}}
gcp-security/
{{#endref}}

### Workspace

{{#ref}}
workspace-security/
{{#endref}}

## AWS

{{#ref}}
aws-security/
{{#endref}}

## Azure

{{#ref}}
azure-security/
{{#endref}}

### Attack Graph

[**Stormspotter** ](https://github.com/Azure/Stormspotter) inaunda an “attack graph” ya rasilimali katika Azure subscription. Inawawezesha red teams na pentesters kuona attack surface na fursa za pivot ndani ya tenant, na kuwapa defenders nguvu ya ziada kujiwekea mwelekeo na kipaumbele haraka katika kazi za incident response.

### Office365

Unahitaji **Global Admin** au angalau **Global Admin Reader** (lakini kumbuka kwamba Global Admin Reader ina vikwazo vidogo). Hata hivyo, vikwazo hivyo vinaonekana katika baadhi ya PS modules na vinaweza kuepukwa kwa kufikia features **via the web application**.

{{#include ../banners/hacktricks-training.md}}
