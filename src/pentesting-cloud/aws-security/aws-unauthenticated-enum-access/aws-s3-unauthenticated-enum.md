# AWS - S3 Kimlik Doğrulaması Olmadan Enum

{{#include ../../../banners/hacktricks-training.md}}

## S3 Kamu Bucket'ları

Bir bucket, **herhangi bir kullanıcının** bucket'ın içeriğini listeleyebilmesi durumunda **“kamu”** olarak kabul edilir ve **sadece belirli kullanıcılar tarafından** bucket'ın içeriğinin **listeleyip yazılabildiği** durumlarda **“özel”** olarak kabul edilir.

Şirketler, AWS'deki herhangi bir hesapta **her şeye veya herkese** erişim sağlayan **bucket izinlerini yanlış yapılandırmış** olabilir (yani, herkese). Bu tür yanlış yapılandırmalarda, bucket'ların kendi erişim kontrol listeleri (ACL'ler) olabileceğinden bazı eylemlerin gerçekleştirilemeyeceğini unutmayın.

**AWS-S3 yanlış yapılandırması hakkında bilgi edinin:** [**http://flaws.cloud**](http://flaws.cloud/) **ve** [**http://flaws2.cloud/**](http://flaws2.cloud)

### AWS Bucket'larını Bulma

Bir web sayfasının bazı kaynakları depolamak için AWS kullanıp kullanmadığını bulmanın farklı yöntemleri:

#### Enum ve OSINT:

- **wappalyzer** tarayıcı eklentisini kullanma
- Burp kullanarak (**web'i tarama**) veya sayfada manuel olarak gezinerek tüm **yüklenen kaynaklar** Geçmiş'e kaydedilecektir.
- **Kaynakları kontrol et** şu alanlarda:

```
http://s3.amazonaws.com/[bucket_name]/
http://[bucket_name].s3.amazonaws.com/
```

- `resources.domain.com` gibi **CNAMES** kontrol edin, bu CNAME `bucket.s3.amazonaws.com` olabilir.
- Zaten **keşfedilmiş açık bucket'lar** ile bir web olan [https://buckets.grayhatwarfare.com](https://buckets.grayhatwarfare.com/) adresini kontrol edin.
- **bucket adı** ve **bucket alan adı** **aynı olmalıdır.**
- **flaws.cloud** **IP** 52.92.181.107'dir ve oraya giderseniz sizi [https://aws.amazon.com/s3/](https://aws.amazon.com/s3/) adresine yönlendirir. Ayrıca, `dig -x 52.92.181.107` komutu `s3-website-us-west-2.amazonaws.com` verir.
- Bir bucket olup olmadığını kontrol etmek için [https://flaws.cloud.s3.amazonaws.com/](https://flaws.cloud.s3.amazonaws.com/) adresini de **ziyaret edebilirsiniz**.

#### Kaba Kuvvet

Kaba kuvvet kullanarak, pentesting yaptığınız şirketle ilgili **isimleri zorlayarak** bucket'ları bulabilirsiniz:

- [https://github.com/sa7mon/S3Scanner](https://github.com/sa7mon/S3Scanner)
- [https://github.com/clario-tech/s3-inspector](https://github.com/clario-tech/s3-inspector)
- [https://github.com/jordanpotti/AWSBucketDump](https://github.com/jordanpotti/AWSBucketDump) (Potansiyel bucket adları içeren bir liste içerir)
- [https://github.com/fellchase/flumberboozle/tree/master/flumberbuckets](https://github.com/fellchase/flumberboozle/tree/master/flumberbuckets)
- [https://github.com/smaranchand/bucky](https://github.com/smaranchand/bucky)
- [https://github.com/tomdev/teh_s3_bucketeers](https://github.com/tomdev/teh_s3_bucketeers)
- [https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/s3](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/s3)
- [https://github.com/Eilonh/s3crets_scanner](https://github.com/Eilonh/s3crets_scanner)
- [https://github.com/belane/CloudHunter](https://github.com/belane/CloudHunter)

<pre class="language-bash"><code class="lang-bash"># Permutasyonlar oluşturmak için bir kelime listesi oluştur
curl -s https://raw.githubusercontent.com/cujanovic/goaltdns/master/words.txt > /tmp/words-s3.txt.temp
curl -s https://raw.githubusercontent.com/jordanpotti/AWSBucketDump/master/BucketNames.txt >>/tmp/words-s3.txt.temp
cat /tmp/words-s3.txt.temp | sort -u > /tmp/words-s3.txt

# Test etmek için alanlar ve alt alanlar temelinde bir kelime listesi oluştur
## Bu alanları ve alt alanları subdomains.txt dosyasına yazın
cat subdomains.txt > /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "-" >> /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "\n" | sort -u >> /tmp/words-hosts-s3.txt

# Saldırı için alanlar ve alt alanlar içeren bir listeye dayalı permutasyonlar oluştur
goaltdns -l /tmp/words-hosts-s3.txt -w /tmp/words-s3.txt -o /tmp/final-words-s3.txt.temp
## Önceki araç, alt alanlar için permutasyonlar oluşturma konusunda uzmanlaşmıştır, bu listeyi filtreleyelim
<strong>### "." ile biten satırları kaldır
</strong>cat /tmp/final-words-s3.txt.temp | grep -Ev "\.$" > /tmp/final-words-s3.txt.temp2
### TLD olmadan liste oluştur
cat /tmp/final-words-s3.txt.temp2 | sed -E 's/\.[a-zA-Z0-9]+$//' > /tmp/final-words-s3.txt.temp3
### Noktalar olmadan liste oluştur
cat /tmp/final-words-s3.txt.temp3 | tr -d "." > /tmp/final-words-s3.txt.temp4http://phantom.s3.amazonaws.com/
### Tireler olmadan liste oluştur
cat /tmp/final-words-s3.txt.temp3 | tr "." "-" > /tmp/final-words-s3.txt.temp5

## Nihai kelime listesini oluştur
cat /tmp/final-words-s3.txt.temp2 /tmp/final-words-s3.txt.temp3 /tmp/final-words-s3.txt.temp4 /tmp/final-words-s3.txt.temp5 | grep -v -- "-\." | awk '{print tolower($0)}' | sort -u > /tmp/final-words-s3.txt

## s3scanner'ı çağır
s3scanner --threads 100 scan --buckets-file /tmp/final-words-s3.txt  | grep bucket_exists
</code></pre>

#### S3 Bucket'larından Loot

Açık S3 bucket'ları verildiğinde, [**BucketLoot**](https://github.com/redhuntlabs/BucketLoot) otomatik olarak **ilginç bilgileri arayabilir**.

### Bölgeyi Bulma

AWS tarafından desteklenen tüm bölgeleri [**https://docs.aws.amazon.com/general/latest/gr/s3.html**](https://docs.aws.amazon.com/general/latest/gr/s3.html) adresinde bulabilirsiniz.

#### DNS ile

Bir bucket'ın bölgesini, keşfedilen IP'nin **DNS isteğini** yaparak **`dig`** ve **`nslookup`** ile alabilirsiniz:
```bash
dig flaws.cloud
;; ANSWER SECTION:
flaws.cloud.    5    IN    A    52.218.192.11

nslookup 52.218.192.11
Non-authoritative answer:
11.192.218.52.in-addr.arpa name = s3-website-us-west-2.amazonaws.com.
```
Kontrol edin ki çözümlenen alan adında "website" kelimesi var.\
Statik web sitesine erişmek için: `flaws.cloud.s3-website-us-west-2.amazonaws.com` adresine gidebilirsiniz\
veya kovaya erişmek için: `flaws.cloud.s3-us-west-2.amazonaws.com` adresini ziyaret edebilirsiniz.

#### Deneyerek

Bir kovaya erişmeye çalıştığınızda, ancak **belirttiğiniz alan adında başka bir bölge** varsa (örneğin, kova `bucket.s3.amazonaws.com` içindeyse ama siz `bucket.s3-website-us-west-2.amazonaws.com` adresine erişmeye çalışıyorsanız, o zaman **doğru konuma yönlendirileceksiniz**:

![](<../../../images/image (106).png>)

### Kovanın Enumerasyonu

Kovanın açıklığını test etmek için bir kullanıcı sadece URL'yi web tarayıcısına girebilir. Özel bir kova "Erişim Reddedildi" yanıtı verir. Kamuya açık bir kova, depolanan ilk 1.000 nesneyi listeleyecektir.

Herkese açık:

![](<../../../images/image (201).png>)

Özel:

![](<../../../images/image (83).png>)

Bunu cli ile de kontrol edebilirsiniz:
```bash
#Use --no-sign-request for check Everyones permissions
#Use --profile <PROFILE_NAME> to indicate the AWS profile(keys) that youwant to use: Check for "Any Authenticated AWS User" permissions
#--recursive if you want list recursivelyls
#Opcionally you can select the region if you now it
aws s3 ls s3://flaws.cloud/ [--no-sign-request] [--profile <PROFILE_NAME>] [ --recursive] [--region us-west-2]
```
Eğer bucket'ın bir alan adı yoksa, onu listelemeye çalışırken **sadece bucket adını** yazın ve tüm AWSs3 alan adını değil. Örnek: `s3://<BUCKETNAME>`

### Kamu URL şablonu
```
https://{user_provided}.s3.amazonaws.com
```
### Kamuya Açık Bucket'tan Hesap Kimliği Alın

Yeni **`S3:ResourceAccount`** **Politika Koşul Anahtarı**'ndan yararlanarak bir AWS hesabını belirlemek mümkündür. Bu koşul, bir hesabın bulunduğu S3 bucket'a dayalı olarak **erişimi kısıtlar** (diğer hesap tabanlı politikalar, talep eden ilkenin bulunduğu hesaba göre kısıtlar).\
Ve politika **joker karakterler** içerebildiğinden, hesap numarasını **sadece bir rakamda** bulmak mümkündür.

Bu araç süreci otomatikleştirir:
```bash
# Installation
pipx install s3-account-search
pip install s3-account-search
# With a bucket
s3-account-search arn:aws:iam::123456789012:role/s3_read s3://my-bucket
# With an object
s3-account-search arn:aws:iam::123456789012:role/s3_read s3://my-bucket/path/to/object.ext
```
Bu teknik, API Gateway URL'leri, Lambda URL'leri, Data Exchange veri setleri ile çalışır ve hatta etiketlerin değerini almak için (etiket anahtarını biliyorsanız) kullanılabilir. Daha fazla bilgi için [**orijinal araştırma**](https://blog.plerion.com/conditional-love-for-aws-metadata-enumeration/) ve bu istismarı otomatikleştirmek için [**conditional-love**](https://github.com/plerionhq/conditional-love/) aracını bulabilirsiniz.

### Bir bucket'ın AWS hesabına ait olduğunu doğrulama

[**bu blog yazısında**](https://blog.plerion.com/things-you-wish-you-didnt-need-to-know-about-s3/) açıklandığı gibi, **bir bucket'ı listeleme izinleriniz varsa** bir isteği göndererek bucket'ın ait olduğu accountID'yi doğrulamak mümkündür:
```bash
curl -X GET "[bucketname].amazonaws.com/" \
-H "x-amz-expected-bucket-owner: [correct-account-id]"

<?xml version="1.0" encoding="UTF-8"?>
<ListBucketResult xmlns="http://s3.amazonaws.com/doc/2006-03-01/">...</ListBucketResult>
```
Eğer hata “Erişim Reddedildi” ise, bu hesap kimliğinin yanlış olduğu anlamına gelir.

### Root hesap numaralandırması için Kullanılan E-postalar

[**bu blog yazısında**](https://blog.plerion.com/things-you-wish-you-didnt-need-to-know-about-s3/) açıklandığı gibi, bir e-posta adresinin herhangi bir AWS hesabıyla ilişkili olup olmadığını **bir e-posta adresine S3 bucket üzerinde ACL'ler aracılığıyla izin vermeyi deneyerek** kontrol etmek mümkündür. Eğer bu bir hata tetiklemiyorsa, bu e-posta bazı AWS hesaplarının root kullanıcısıdır:
```python
s3_client.put_bucket_acl(
Bucket=bucket_name,
AccessControlPolicy={
'Grants': [
{
'Grantee': {
'EmailAddress': 'some@emailtotest.com',
'Type': 'AmazonCustomerByEmail',
},
'Permission': 'READ'
},
],
'Owner': {
'DisplayName': 'Whatever',
'ID': 'c3d78ab5093a9ab8a5184de715d409c2ab5a0e2da66f08c2f6cc5c0bdeadbeef'
}
}
)
```
## Referanslar

- [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
- [https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/](https://cloudar.be/awsblog/finding-the-account-id-of-any-public-s3-bucket/)

{{#include ../../../banners/hacktricks-training.md}}
