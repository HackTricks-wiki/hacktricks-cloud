# AWS - API Gateway Unauthenticated Enum

{{#include ../../../banners/hacktricks-training.md}}

### API Invoke bypass

Σύμφωνα με την ομιλία [Attack Vectors for APIs Using AWS API Gateway Lambda Authorizers - Alexandre & Leonardo](https://www.youtube.com/watch?v=bsPKk7WDOnE), οι Lambda Authorizers μπορούν να ρυθμιστούν **χρησιμοποιώντας σύνταξη IAM** για να δώσουν δικαιώματα για την κλήση API endpoints. Αυτό προέρχεται [**από τα έγγραφα**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Permission",
"Action": ["execute-api:Execution-operation"],
"Resource": [
"arn:aws:execute-api:region:account-id:api-id/stage/METHOD_HTTP_VERB/Resource-path"
]
}
]
}
```
Το πρόβλημα με αυτόν τον τρόπο παροχής δικαιωμάτων για την κλήση endpoints είναι ότι το **"\*" υποδηλώνει "οτιδήποτε"** και δεν υποστηρίζεται **καμία άλλη σύνταξη regex**.

Ορισμένα παραδείγματα:

- Ένας κανόνας όπως `arn:aws:execute-apis:sa-east-1:accid:api-id/prod/*/dashboard/*` προκειμένου να δώσει σε κάθε χρήστη πρόσβαση στο `/dashboard/user/{username}` θα τους δώσει πρόσβαση σε άλλες διαδρομές όπως το `/admin/dashboard/createAdmin` για παράδειγμα.

> [!WARNING]
> Σημειώστε ότι το **"\*" δεν σταματά να επεκτείνεται με διαχωριστικά**, επομένως, αν χρησιμοποιήσετε "\*" στο api-id για παράδειγμα, μπορεί επίσης να υποδηλώνει "οποιοδήποτε στάδιο" ή "οποιαδήποτε μέθοδο" εφόσον η τελική regex είναι ακόμα έγκυρη.\
> Έτσι, `arn:aws:execute-apis:sa-east-1:accid:*/prod/GET/dashboard/*`\
> Μπορεί να επικυρώσει ένα αίτημα POST για να δοκιμάσει το στάδιο στη διαδρομή `/prod/GET/dashboard/admin` για παράδειγμα.

Πρέπει πάντα να έχετε σαφές τι θέλετε να επιτρέψετε να έχει πρόσβαση και στη συνέχεια να ελέγξετε αν είναι δυνατές άλλες καταστάσεις με τα παραχωρηθέντα δικαιώματα.

Για περισσότερες πληροφορίες, εκτός από τα [**docs**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html), μπορείτε να βρείτε κώδικα για την υλοποίηση authorizers σε [**αυτό το επίσημο aws github**](https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/tree/master/blueprints).

### IAM Policy Injection

Στην ίδια [**ομιλία**](https://www.youtube.com/watch?v=bsPKk7WDOnE) εκτίθεται το γεγονός ότι αν ο κώδικας χρησιμοποιεί **είσοδο χρήστη** για να **δημιουργήσει τις IAM πολιτικές**, wildcards (και άλλα όπως "." ή συγκεκριμένες συμβολοσειρές) μπορούν να περιληφθούν εκεί με στόχο την **παράκαμψη περιορισμών**.

### Δημόσιο πρότυπο URL
```
https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided}
```
### Πάρε το ID λογαριασμού από το δημόσιο URL του API Gateway

Ακριβώς όπως με τα S3 buckets, τα Data Exchange και τα URLs των Lambda gateways, είναι δυνατό να βρείτε το ID λογαριασμού ενός λογαριασμού εκμεταλλευόμενοι το **`aws:ResourceAccount`** **Policy Condition Key** από ένα δημόσιο URL του API Gateway. Αυτό γίνεται βρίσκοντας το ID λογαριασμού ένα χαρακτήρα τη φορά εκμεταλλευόμενοι τα wildcard στην ενότητα **`aws:ResourceAccount`** της πολιτικής.\
Αυτή η τεχνική επιτρέπει επίσης να αποκτήσετε **τιμές ετικετών** αν γνωρίζετε το κλειδί της ετικέτας (υπάρχουν μερικές προεπιλεγμένες ενδιαφέρουσες).

Μπορείτε να βρείτε περισσότερες πληροφορίες στην [**πρωτότυπη έρευνα**](https://blog.plerion.com/conditional-love-for-aws-metadata-enumeration/) και το εργαλείο [**conditional-love**](https://github.com/plerionhq/conditional-love/) για να αυτοματοποιήσετε αυτή την εκμετάλλευση.

{{#include ../../../banners/hacktricks-training.md}}
