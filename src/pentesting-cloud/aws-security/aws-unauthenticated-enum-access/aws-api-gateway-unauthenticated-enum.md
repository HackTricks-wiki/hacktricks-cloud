# AWS - API Gateway Yetkisiz Enum

{{#include ../../../banners/hacktricks-training.md}}

### API Çağrısı atlatma

[Attack Vectors for APIs Using AWS API Gateway Lambda Authorizers - Alexandre & Leonardo](https://www.youtube.com/watch?v=bsPKk7WDOnE) konuşmasına göre, Lambda Authorizers, API uç noktalarını çağırmak için izin vermek üzere **IAM sözdizimi** kullanılarak yapılandırılabilir. Bu, [**belgelerden alınmıştır**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Permission",
"Action": ["execute-api:Execution-operation"],
"Resource": [
"arn:aws:execute-api:region:account-id:api-id/stage/METHOD_HTTP_VERB/Resource-path"
]
}
]
}
```
Bu yöntemle uç noktaları çağırmak için izin vermenin sorunu, **"\*"nın "her şey" anlamına gelmesidir** ve **daha fazla regex sözdizimi desteklenmemektedir**.

Bazı örnekler:

- Her kullanıcıya `/dashboard/user/{username}` erişimi vermek için `arn:aws:execute-apis:sa-east-1:accid:api-id/prod/*/dashboard/*` gibi bir kural, onlara örneğin `/admin/dashboard/createAdmin` gibi diğer rotalara erişim verecektir.

> [!WARNING]
> **"\*" kesmelerle genişlemeyi durdurmaz**, bu nedenle, örneğin api-id'de "\*" kullanırsanız, bu "herhangi bir aşama" veya "herhangi bir yöntem" anlamına da gelebilir, son regex geçerli olduğu sürece.\
> Bu nedenle `arn:aws:execute-apis:sa-east-1:accid:*/prod/GET/dashboard/*`\
> Örneğin `/prod/GET/dashboard/admin` yoluna test aşamasında bir post isteğini doğrulayabilir.

Her zaman neye erişim izni vermek istediğinizi net bir şekilde belirlemeli ve ardından verilen izinlerle başka senaryoların mümkün olup olmadığını kontrol etmelisiniz.

Daha fazla bilgi için, [**docs**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html) dışında, [**bu resmi aws github**](https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/tree/master/blueprints) üzerinde yetkilendiricileri uygulamak için kod bulabilirsiniz.

### IAM Politika Enjeksiyonu

Aynı [**konuşmada**](https://www.youtube.com/watch?v=bsPKk7WDOnE), eğer kod **kullanıcı girdisini** **IAM politikalarını oluşturmak için** kullanıyorsa, joker karakterler (ve "." veya belirli dizeler gibi diğerleri) **kısıtlamaları aşmak** amacıyla dahil edilebileceği gerçeği ortaya konmuştur.

### Kamu URL şablonu
```
https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided}
```
### Hesap ID'sini genel API Gateway URL'sinden alın

S3 bucket'ları, Data Exchange ve Lambda URL'si geçitlerinde olduğu gibi, genel bir API Gateway URL'sinden **`aws:ResourceAccount`** **Policy Condition Key**'sini kötüye kullanarak bir hesabın hesap ID'sini bulmak mümkündür. Bu, politikanın **`aws:ResourceAccount`** bölümünde joker karakterleri kötüye kullanarak hesap ID'sini bir karakter bir seferde bulmakla yapılır.\
Bu teknik, tag anahtarını biliyorsanız **tag değerlerini** de almanıza olanak tanır (bazı varsayılan ilginç olanlar vardır).

Daha fazla bilgi için [**orijinal araştırmaya**](https://blog.plerion.com/conditional-love-for-aws-metadata-enumeration/) ve bu istismarı otomatikleştirmek için [**conditional-love**](https://github.com/plerionhq/conditional-love/) aracına bakabilirsiniz.

{{#include ../../../banners/hacktricks-training.md}}
