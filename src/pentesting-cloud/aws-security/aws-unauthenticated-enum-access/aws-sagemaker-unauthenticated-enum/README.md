# AWS - SageMaker Nieautoryzowany dostęp

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker Studio - Przejęcie konta poprzez CreatePresignedDomainUrl (podszycie się pod dowolny UserProfile)

### Opis
Tożsamość z uprawnieniem do wywołania `sagemaker:CreatePresignedDomainUrl` na docelowym Studio `UserProfile` może wygenerować URL logowania, który uwierzytelnia bezpośrednio do SageMaker Studio jako ten profil. Daje to przeglądarce atakującego sesję Studio, która dziedziczy uprawnienia `ExecutionRole` profilu oraz pełny dostęp do katalogu domowego i aplikacji profilu opartych na EFS. Nie jest wymagane `iam:PassRole` ani dostęp do konsoli.

### Wymagania
- SageMaker Studio `Domain` i docelowy `UserProfile` w jego obrębie.
- Principal atakującego musi mieć `sagemaker:CreatePresignedDomainUrl` na docelowym `UserProfile` (na poziomie zasobu) lub `*`.

Minimal policy example (scoped to one UserProfile):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedDomainUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:user-profile/<domain-id>/<user-profile-name>"
}
]
}
```
### Kroki nadużycia

1) Wyenumeruj Studio Domain i UserProfiles, które możesz zaatakować
```bash
DOM=$(aws sagemaker list-domains --query 'Domains[0].DomainId' --output text)
aws sagemaker list-user-profiles --domain-id-equals $DOM
TARGET_USER=<UserProfileName>
```
2) Wygeneruj presigned URL (domyślnie ważny przez ~5 minut)
```bash
aws sagemaker create-presigned-domain-url \
--domain-id $DOM \
--user-profile-name $TARGET_USER \
--query AuthorizedUrl --output text
```
3) Otwórz zwrócony URL w przeglądarce, aby zalogować się do Studio jako docelowy użytkownik. W terminalu Jupyter w Studio zweryfikuj efektywną tożsamość:
```bash
aws sts get-caller-identity
```
Uwagi:
- `--landing-uri` można pominąć. Niektóre wartości (np. `app:JupyterLab:/lab`) mogą być odrzucone w zależności od wariantu/wersji Studio; domyślne ustawienia zazwyczaj przekierowują do strony głównej Studio, a następnie do Jupyter.
- Org policies/VPC endpoint restrictions mogą nadal blokować dostęp sieciowy; token minting nie wymaga logowania do konsoli ani `iam:PassRole`.

### Wpływ
- Ruch boczny i eskalacja uprawnień poprzez przyjęcie dowolnego Studio `UserProfile`, którego ARN jest dozwolony, dziedzicząc jego `ExecutionRole` oraz system plików/aplikacje.

### Dowody (z kontrolowanego testu)
- Mając tylko `sagemaker:CreatePresignedDomainUrl` na docelowym `UserProfile`, rola atakującego pomyślnie zwróciła `AuthorizedUrl` podobny do:
```
https://studio-d-xxxxxxxxxxxx.studio.<region>.sagemaker.aws/auth?token=eyJhbGciOi...
```
- Bezpośrednie żądanie HTTP zwraca przekierowanie (HTTP 302) do Studio, potwierdzając, że URL jest ważny i aktywny do momentu wygaśnięcia.


## SageMaker MLflow Tracking Server - ATO przez CreatePresignedMlflowTrackingServerUrl

### Opis
Tożsamość mająca uprawnienie do wywołania `sagemaker:CreatePresignedMlflowTrackingServerUrl` dla docelowego SageMaker MLflow Tracking Server może wygenerować jednorazowy presigned URL, który uwierzytelnia się bezpośrednio w zarządzanym MLflow UI tego serwera. Zapewnia to taki sam dostęp, jaki miałby prawidłowy użytkownik do serwera (wyświetlanie/tworzenie eksperymentów i runs oraz pobieranie/wysyłanie artefaktów w magazynie artefaktów S3 serwera) bez dostępu do konsoli lub `iam:PassRole`.

### Wymagania
- SageMaker MLflow Tracking Server w koncie/regionie oraz jego nazwa.
- Podmiot atakujący potrzebuje uprawnienia `sagemaker:CreatePresignedMlflowTrackingServerUrl` na docelowym zasobie MLflow Tracking Server (lub `*`).

Minimalny przykład polityki (ograniczony do jednego Tracking Servera):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedMlflowTrackingServerUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:mlflow-tracking-server/<tracking-server-name>"
}
]
}
```
### Kroki nadużycia

1) Enumerate MLflow Tracking Servers you can target i wybierz jedną nazwę
```bash
aws sagemaker list-mlflow-tracking-servers \
--query 'TrackingServerSummaries[].{Name:TrackingServerName,Status:TrackingServerStatus}'
TS_NAME=<tracking-server-name>
```
2) Wygeneruj presigned MLflow UI URL (ważny przez krótki czas)
```bash
aws sagemaker create-presigned-mlflow-tracking-server-url \
--tracking-server-name "$TS_NAME" \
--expires-in-seconds 300 \
--session-expiration-duration-in-seconds 1800 \
--query AuthorizedUrl --output text
```
3) Otwórz zwrócony URL w przeglądarce, aby uzyskać dostęp do MLflow UI jako uwierzytelniony użytkownik dla tego Tracking Server.

Notes:
- Tracking Server musi być w stanie gotowości (np. `Created/Active`). Jeśli jest nadal w stanie `Creating`, wywołanie zostanie odrzucone.
- The presigned URL jest jednorazowy i krótkotrwały; wygeneruj nowy, gdy będzie potrzebny.

### Wpływ
- Bezpośredni dostęp do zarządzanego MLflow UI dla docelowego Tracking Server, umożliwiający przeglądanie i modyfikację experiments/runs oraz pobieranie lub przesyłanie artifacts przechowywanych w skonfigurowanym S3 artifact store serwera, zgodnie z uprawnieniami wymuszonymi przez konfigurację serwera.

{{#include ../../../../banners/hacktricks-training.md}}
