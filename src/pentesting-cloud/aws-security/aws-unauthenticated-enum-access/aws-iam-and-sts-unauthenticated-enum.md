# AWS - IAM & STS Yetkisiz Enum

{{#include ../../../banners/hacktricks-training.md}}

## Bir hesapta Rolleri ve Kullanıcı Adlarını Listele

### ~~Rolü Varsayma Kaba Kuvvet~~

> [!CAUTION]
> **Bu teknik artık çalışmıyor** çünkü rol var olsa da olmasa da her zaman bu hatayı alırsınız:
>
> `An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::947247140022:user/testenv is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::429217632764:role/account-balanceasdas`
>
> Bunu **test edebilirsiniz**:
>
> `aws sts assume-role --role-arn arn:aws:iam::412345678909:role/superadmin --role-session-name s3-access-example`

Gerekli izinler olmadan **bir rolü varsaymaya çalışmak**, bir AWS hata mesajı tetikler. Örneğin, yetkisizseniz, AWS şunları döndürebilir:
```ruby
An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::012345678901:user/MyUser is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::111111111111:role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS
```
Bu mesaj, rolün varlığını onaylar ancak onun üstlenme rolü politikasının sizin üstlenmenize izin vermediğini belirtir. Aksine, **var olmayan bir rolü üstlenmeye çalışmak farklı bir hataya yol açar**:
```less
An error occurred (AccessDenied) when calling the AssumeRole operation: Not authorized to perform sts:AssumeRole
```
İlginç bir şekilde, **mevcut ve mevcut olmayan roller arasında ayırt etme** yöntemi, farklı AWS hesapları arasında bile geçerlidir. Geçerli bir AWS hesap kimliği ve hedeflenen bir kelime listesi ile, hesapta bulunan rolleri herhangi bir iç sınırlama ile karşılaşmadan listeleyebilirsiniz.

Bu sorunu kötüye kullanarak potansiyel ilkeleri listelemek için bu [scripti kullanabilirsiniz](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/assume_role_enum).

### Güven Politikaları: Brute-Force Çapraz Hesap rolleri ve kullanıcıları

Bir **IAM rolünün güven politikasını yapılandırmak veya güncellemek, hangi AWS kaynaklarının veya hizmetlerinin o rolü üstlenmesine izin verileceğini tanımlamayı içerir** ve geçici kimlik bilgileri alır. Politika içindeki belirtilen kaynak **varsa**, güven politikası **başarıyla** kaydedilir. Ancak, kaynak **yoksa**, geçersiz bir ilke sağlandığını belirten bir **hata üretilir**.

> [!WARNING]
> O kaynakta bir çapraz hesap rolü veya kullanıcı belirtebileceğinizi unutmayın:
>
> - `arn:aws:iam::acc_id:role/role_name`
> - `arn:aws:iam::acc_id:user/user_name`

Bu bir politika örneğidir:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::216825089941:role/Test"
},
"Action": "sts:AssumeRole"
}
]
}
```
#### GUI

Eğer **var olmayan bir rol** kullanırsanız, bu **hata** ile karşılaşacaksınız. Eğer rol **varsa**, politika **hatasız** bir şekilde **kaydedilecektir**. (Hata güncelleme içindir, ancak oluşturma sırasında da çalışır)

![](<../../../images/image (153).png>)

#### CLI
```bash
### You could also use: aws iam update-assume-role-policy
# When it works
aws iam create-role --role-name Test-Role --assume-role-policy-document file://a.json
{
"Role": {
"Path": "/",
"RoleName": "Test-Role",
"RoleId": "AROA5ZDCUJS3DVEIYOB73",
"Arn": "arn:aws:iam::947247140022:role/Test-Role",
"CreateDate": "2022-05-03T20:50:04Z",
"AssumeRolePolicyDocument": {
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::316584767888:role/account-balance"
},
"Action": [
"sts:AssumeRole"
]
}
]
}
}
}

# When it doesn't work
aws iam create-role --role-name Test-Role2 --assume-role-policy-document file://a.json
An error occurred (MalformedPolicyDocument) when calling the CreateRole operation: Invalid principal in policy: "AWS":"arn:aws:iam::316584767888:role/account-balanceefd23f2"
```
Bu süreci [https://github.com/carlospolop/aws_tools](https://github.com/carlospolop/aws_tools) ile otomatikleştirebilirsiniz.

- `bash unauth_iam.sh -t user -i 316584767888 -r TestRole -w ./unauth_wordlist.txt`

Pacu kullanarak [Pacu](https://github.com/RhinoSecurityLabs/pacu):

- `run iam__enum_users --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
- `run iam__enum_roles --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
- Örnekte kullanılan `admin` rolü, pacu tarafından **taklit edilmek üzere hesabınızdaki bir roldür** ve gerekli politikaları oluşturmak için gereklidir.

### Privesc

Rol kötü yapılandırılmışsa ve herkesin onu üstlenmesine izin veriyorsa:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
Saldırgan bunu varsayabilir.

## Üçüncü Taraf OIDC Federasyonu

Bir **Github Actions iş akışı** okuyabildiğinizi hayal edin, bu iş akışı **AWS** içindeki bir **role** erişiyor.\
Bu güven, aşağıdaki **güven politikası** ile bir role erişim sağlayabilir:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::<acc_id>:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
Bu güven politikası doğru olabilir, ancak **daha fazla koşulun olmaması** buna güvenmemeniz gerektiğini göstermelidir.\
Bu, önceki rolün **Github Actions'tan HERHANGİ BİRİ** tarafından üstlenilebileceği anlamına gelir! Koşullarda ayrıca org adı, repo adı, env, brach gibi diğer şeyleri de belirtmelisiniz...

Bir diğer potansiyel yanlış yapılandırma, aşağıdaki gibi bir **koşul eklemektir**:
```json
"StringLike": {
"token.actions.githubusercontent.com:sub": "repo:org_name*:*"
}
```
Not edin ki **joker karakter** (\*) **noktalama işareti** (:) öncesindedir. **org_name1** gibi bir organizasyon oluşturabilir ve bir Github Action'dan **rolü üstlenebilirsiniz**.

## Referanslar

- [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
- [https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/](https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/)

{{#include ../../../banners/hacktricks-training.md}}
