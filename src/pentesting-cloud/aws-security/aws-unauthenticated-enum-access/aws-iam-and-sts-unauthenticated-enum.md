# AWS - IAM & STS Unauthenticated Enum

{{#include ../../../banners/hacktricks-training.md}}

## Enumerate Roles & Usernames in an account

### ~~Assume Role Brute-Force~~

> [!CAUTION]
> **Αυτή η τεχνική δεν λειτουργεί** πια καθώς αν ο ρόλος υπάρχει ή όχι πάντα λαμβάνετε αυτό το σφάλμα:
>
> `An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::947247140022:user/testenv is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::429217632764:role/account-balanceasdas`
>
> Μπορείτε να **δοκιμάσετε αυτό εκτελώντας**:
>
> `aws sts assume-role --role-arn arn:aws:iam::412345678909:role/superadmin --role-session-name s3-access-example`

Η προσπάθεια **να αναλάβετε έναν ρόλο χωρίς τις απαραίτητες άδειες** ενεργοποιεί ένα μήνυμα σφάλματος από την AWS. Για παράδειγμα, αν δεν έχετε άδεια, η AWS μπορεί να επιστρέψει:
```ruby
An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::012345678901:user/MyUser is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::111111111111:role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS
```
Αυτό το μήνυμα επιβεβαιώνει την ύπαρξη του ρόλου αλλά υποδεικνύει ότι η πολιτική ανάληψης ρόλου δεν επιτρέπει την ανάληψή σας. Αντίθετα, η προσπάθεια να **αναλάβετε έναν ανύπαρκτο ρόλο οδηγεί σε διαφορετικό σφάλμα**:
```less
An error occurred (AccessDenied) when calling the AssumeRole operation: Not authorized to perform sts:AssumeRole
```
Αξιοσημείωτο είναι ότι αυτή η μέθοδος του **να διακρίνουμε μεταξύ υπαρχόντων και μη υπαρχόντων ρόλων** είναι εφαρμόσιμη ακόμη και σε διαφορετικούς λογαριασμούς AWS. Με ένα έγκυρο AWS account ID και μια στοχευμένη λίστα λέξεων, μπορεί κανείς να απαριθμήσει τους ρόλους που υπάρχουν στον λογαριασμό χωρίς να αντιμετωπίσει εγγενείς περιορισμούς.

Μπορείτε να χρησιμοποιήσετε αυτό το [script για να απαριθμήσετε πιθανούς principals](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/assume_role_enum) εκμεταλλευόμενοι αυτό το ζήτημα.

### Πολιτικές Εμπιστοσύνης: Brute-Force Ρόλοι και χρήστες Διαφορετικών Λογαριασμών

Η ρύθμιση ή η ενημέρωση μιας **πολιτικής εμπιστοσύνης IAM ρόλου περιλαμβάνει τον καθορισμό ποιες AWS πόροι ή υπηρεσίες επιτρέπεται να αναλάβουν αυτόν τον ρόλο** και να αποκτήσουν προσωρινές διαπιστεύσεις. Εάν ο καθορισμένος πόρος στην πολιτική **υπάρχει**, η πολιτική εμπιστοσύνης αποθηκεύεται **επιτυχώς**. Ωστόσο, εάν ο πόρος **δεν υπάρχει**, δημιουργείται ένα **σφάλμα**, υποδεικνύοντας ότι παρέχεται ένας μη έγκυρος principal.

> [!WARNING]
> Σημειώστε ότι σε αυτόν τον πόρο μπορείτε να καθορίσετε έναν ρόλο ή χρήστη διαφοράς λογαριασμού:
>
> - `arn:aws:iam::acc_id:role/role_name`
> - `arn:aws:iam::acc_id:user/user_name`

Αυτή είναι ένα παράδειγμα πολιτικής:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::216825089941:role/Test"
},
"Action": "sts:AssumeRole"
}
]
}
```
#### GUI

Αυτό είναι το **σφάλμα** που θα βρείτε αν χρησιμοποιήσετε έναν **ρόλο που δεν υπάρχει**. Αν ο ρόλος **υπάρχει**, η πολιτική θα **αποθηκευτεί** χωρίς κανένα σφάλμα. (Το σφάλμα είναι για ενημέρωση, αλλά λειτουργεί επίσης κατά τη δημιουργία)

![](<../../../images/image (153).png>)

#### CLI
```bash
### You could also use: aws iam update-assume-role-policy
# When it works
aws iam create-role --role-name Test-Role --assume-role-policy-document file://a.json
{
"Role": {
"Path": "/",
"RoleName": "Test-Role",
"RoleId": "AROA5ZDCUJS3DVEIYOB73",
"Arn": "arn:aws:iam::947247140022:role/Test-Role",
"CreateDate": "2022-05-03T20:50:04Z",
"AssumeRolePolicyDocument": {
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::316584767888:role/account-balance"
},
"Action": [
"sts:AssumeRole"
]
}
]
}
}
}

# When it doesn't work
aws iam create-role --role-name Test-Role2 --assume-role-policy-document file://a.json
An error occurred (MalformedPolicyDocument) when calling the CreateRole operation: Invalid principal in policy: "AWS":"arn:aws:iam::316584767888:role/account-balanceefd23f2"
```
Μπορείτε να αυτοματοποιήσετε αυτή τη διαδικασία με [https://github.com/carlospolop/aws_tools](https://github.com/carlospolop/aws_tools)

- `bash unauth_iam.sh -t user -i 316584767888 -r TestRole -w ./unauth_wordlist.txt`

Η χρήση του [Pacu](https://github.com/RhinoSecurityLabs/pacu):

- `run iam__enum_users --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
- `run iam__enum_roles --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
- Ο ρόλος `admin` που χρησιμοποιείται στο παράδειγμα είναι ένας **ρόλος στον λογαριασμό σας που μπορεί να μιμηθεί** από το pacu για να δημιουργήσει τις πολιτικές που χρειάζεται να δημιουργήσει για την καταμέτρηση

### Privesc

Σε περίπτωση που ο ρόλος έχει ρυθμιστεί λανθασμένα και επιτρέπει σε οποιονδήποτε να τον αναλάβει:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
Ο επιτιθέμενος θα μπορούσε απλώς να το υποθέσει.

## Ομοσπονδία OIDC Τρίτων

Φανταστείτε ότι καταφέρατε να διαβάσετε μια **ροή εργασίας Github Actions** που έχει πρόσβαση σε έναν **ρόλο** μέσα στο **AWS**.\
Αυτή η εμπιστοσύνη μπορεί να δώσει πρόσβαση σε έναν ρόλο με την ακόλουθη **πολιτική εμπιστοσύνης**:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::<acc_id>:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
Αυτή η πολιτική εμπιστοσύνης μπορεί να είναι σωστή, αλλά η **έλλειψη περισσότερων συνθηκών** θα πρέπει να σας κάνει να την αμφισβητήσετε.\
Αυτό συμβαίνει επειδή ο προηγούμενος ρόλος μπορεί να αναληφθεί από **ΟΠΟΙΟΝΔΗΠΟΤΕ από το Github Actions**! Θα πρέπει να καθορίσετε στις συνθήκες και άλλα πράγματα όπως το όνομα του οργανισμού, το όνομα του αποθετηρίου, το περιβάλλον, το κλάδο...

Μια άλλη πιθανή κακή ρύθμιση είναι να **προσθέσετε μια συνθήκη** όπως η παρακάτω:
```json
"StringLike": {
"token.actions.githubusercontent.com:sub": "repo:org_name*:*"
}
```
Σημειώστε ότι το **wildcard** (\*) πριν από τον **κόλον** (:). Μπορείτε να δημιουργήσετε έναν οργανισμό όπως το **org_name1** και να **assume the role** από μια ενέργεια Github.

## Αναφορές

- [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
- [https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/](https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/)

{{#include ../../../banners/hacktricks-training.md}}
