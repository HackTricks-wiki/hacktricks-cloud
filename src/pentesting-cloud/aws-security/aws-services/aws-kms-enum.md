# AWS - KMS Enum

{{#include ../../../banners/hacktricks-training.md}}

## KMS - Υπηρεσία Διαχείρισης Κλειδιών

Η Υπηρεσία Διαχείρισης Κλειδιών AWS (AWS KMS) παρουσιάζεται ως μια διαχειριζόμενη υπηρεσία, απλοποιώντας τη διαδικασία για τους χρήστες να **δημιουργούν και να διαχειρίζονται τα κλειδιά κύριας εξουσίας πελάτη** (CMKs). Αυτά τα CMKs είναι αναπόσπαστα στην κρυπτογράφηση των δεδομένων των χρηστών. Ένα αξιοσημείωτο χαρακτηριστικό του AWS KMS είναι ότι τα CMKs είναι κυρίως **ασφαλισμένα από υλικές μονάδες ασφαλείας** (HSMs), ενισχύοντας την προστασία των κλειδιών κρυπτογράφησης.

Το KMS χρησιμοποιεί **συμμετρική κρυπτογραφία**. Αυτό χρησιμοποιείται για να **κρυπτογραφεί πληροφορίες σε κατάσταση ανάπαυσης** (για παράδειγμα, μέσα σε ένα S3). Εάν χρειάζεστε να **κρυπτογραφήσετε πληροφορίες σε μεταφορά**, πρέπει να χρησιμοποιήσετε κάτι όπως το **TLS**.

Το KMS είναι μια **υπηρεσία συγκεκριμένης περιοχής**.

**Οι διαχειριστές της Amazon δεν έχουν πρόσβαση στα κλειδιά σας**. Δεν μπορούν να ανακτήσουν τα κλειδιά σας και δεν σας βοηθούν με την κρυπτογράφηση των κλειδιών σας. Το AWS απλώς διαχειρίζεται το λειτουργικό σύστημα και την υποκείμενη εφαρμογή, είναι δική μας ευθύνη να διαχειριζόμαστε τα κλειδιά κρυπτογράφησης και να διαχειριζόμαστε πώς χρησιμοποιούνται αυτά τα κλειδιά.

**Κλειδιά Κύριας Εξουσίας Πελάτη** (CMK): Μπορούν να κρυπτογραφήσουν δεδομένα έως 4KB σε μέγεθος. Χρησιμοποιούνται συνήθως για τη δημιουργία, κρυπτογράφηση και αποκρυπτογράφηση των DEKs (Κλειδιά Κρυπτογράφησης Δεδομένων). Στη συνέχεια, τα DEKs χρησιμοποιούνται για την κρυπτογράφηση των δεδομένων.

Ένα κλειδί κύριας εξουσίας πελάτη (CMK) είναι μια λογική αναπαράσταση ενός κύριου κλειδιού στο AWS KMS. Εκτός από τους αναγνωριστικούς αριθμούς του κύριου κλειδιού και άλλα μεταδεδομένα, συμπεριλαμβανομένης της ημερομηνίας δημιουργίας του, της περιγραφής και της κατάστασης του κλειδιού, ένα **CMK περιέχει το υλικό κλειδιού που χρησιμοποιείται για την κρυπτογράφηση και αποκρυπτογράφηση των δεδομένων**. Όταν δημιουργείτε ένα CMK, από προεπιλογή, το AWS KMS δημιουργεί το υλικό κλειδιού για αυτό το CMK. Ωστόσο, μπορείτε να επιλέξετε να δημιουργήσετε ένα CMK χωρίς υλικό κλειδιού και στη συνέχεια να εισάγετε το δικό σας υλικό κλειδιού σε αυτό το CMK.

Υπάρχουν 2 τύποι κύριων κλειδιών:

- **CMKs διαχειριζόμενα από το AWS: Χρησιμοποιούνται από άλλες υπηρεσίες για την κρυπτογράφηση δεδομένων**. Χρησιμοποιούνται από την υπηρεσία που τα δημιούργησε σε μια περιοχή. Δημιουργούνται την πρώτη φορά που εφαρμόζετε την κρυπτογράφηση σε αυτή την υπηρεσία. Ανανεώνονται κάθε 3 χρόνια και δεν είναι δυνατή η αλλαγή τους.
- **CMKs διαχειριζόμενα από τον πελάτη**: Ευελιξία, ανανέωση, ρυθμιζόμενη πρόσβαση και πολιτική κλειδιού. Ενεργοποίηση και απενεργοποίηση κλειδιών.

**Κρυπτογράφηση Φακέλου** στο πλαίσιο της Υπηρεσίας Διαχείρισης Κλειδιών (KMS): Σύστημα ιεραρχίας δύο επιπέδων για **να κρυπτογραφεί δεδομένα με το κλειδί δεδομένων και στη συνέχεια να κρυπτογραφήσει το κλειδί δεδομένων με το κύριο κλειδί**.

### Πολιτικές Κλειδιών

Αυτές καθορίζουν **ποιος μπορεί να χρησιμοποιήσει και να έχει πρόσβαση σε ένα κλειδί στο KMS**.

Από **προεπιλογή:**

- Δίνει στο **IAM του** **AWS λογαριασμού που κατέχει το κλειδί KMS πρόσβαση** για να διαχειρίζεται την πρόσβαση στο κλειδί KMS μέσω IAM.

Σε αντίθεση με άλλες πολιτικές πόρων AWS, μια πολιτική **κλειδιού KMS δεν δίνει αυτόματα άδεια σε κανένα από τα πρόσωπα του λογαριασμού**. Για να δώσετε άδεια στους διαχειριστές του λογαριασμού, η **πολιτική κλειδιού πρέπει να περιλαμβάνει μια ρητή δήλωση** που παρέχει αυτή την άδεια, όπως αυτή.

- Χωρίς να επιτρέπεται ο λογαριασμός(`"AWS": "arn:aws:iam::111122223333:root"`), οι άδειες IAM δεν θα λειτουργήσουν.

- Επιτρέπει στον λογαριασμό να χρησιμοποιεί πολιτικές IAM για να επιτρέπει την πρόσβαση στο κλειδί KMS, εκτός από την πολιτική κλειδιού.

**Χωρίς αυτή την άδεια, οι πολιτικές IAM που επιτρέπουν την πρόσβαση στο κλειδί είναι αναποτελεσματικές**, αν και οι πολιτικές IAM που αρνούνται την πρόσβαση στο κλειδί παραμένουν αποτελεσματικές.

- Μειώνει **τον κίνδυνο το κλειδί να γίνει μη διαχειρίσιμο** δίνοντας άδεια ελέγχου πρόσβασης στους διαχειριστές του λογαριασμού, συμπεριλαμβανομένου του χρήστη ρίζας του λογαριασμού, ο οποίος δεν μπορεί να διαγραφεί.

**Παράδειγμα προεπιλεγμένης πολιτικής**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
> [!WARNING]
> Αν το **account επιτρέπεται** (`"arn:aws:iam::111122223333:root"`), ένας **principal** από το account **θα χρειαστεί IAM permissions** για να χρησιμοποιήσει το KMS key. Ωστόσο, αν το **ARN** ενός ρόλου για παράδειγμα είναι **συγκεκριμένα επιτρεπτό** στην **Key Policy**, αυτός ο ρόλος **δεν χρειάζεται IAM permissions**.

<details>

<summary>Λεπτομέρειες Πολιτικής</summary>

Ιδιότητες μιας πολιτικής:

- Έγγραφο βασισμένο σε JSON
- Πόρος --> Επηρεαζόμενοι πόροι (μπορεί να είναι "\*")
- Δράση --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (δικαιώματα)
- Επίδραση --> Επιτρέπεται/Αρνείται
- Principal --> arn που επηρεάζεται
- Συνθήκες (προαιρετικό) --> Συνθήκη για να δοθούν τα δικαιώματα

Παραχωρήσεις:

- Επιτρέπει την ανάθεση των δικαιωμάτων σας σε άλλο AWS principal εντός του AWS account σας. Πρέπει να τα δημιουργήσετε χρησιμοποιώντας τα AWS KMS APIs. Μπορεί να υποδειχθεί ο αναγνωριστικός αριθμός CMK, ο παραχωρητής principal και το απαιτούμενο επίπεδο λειτουργίας (Decrypt, Encrypt, GenerateDataKey...)
- Αφού δημιουργηθεί η παραχώρηση, εκδίδεται ένα GrantToken και ένα GrantID

**Πρόσβαση**:

- Μέσω **πολιτικής κλειδιού** -- Αν αυτό υπάρχει, αυτό έχει **προτεραιότητα** πάνω από την πολιτική IAM
- Μέσω **πολιτικής IAM**
- Μέσω **παραχωρήσεων**

</details>

### Διαχειριστές Κλειδιών

Διαχειριστής κλειδιών από προεπιλογή:

- Έχουν πρόσβαση για να διαχειρίζονται το KMS αλλά όχι για να κρυπτογραφούν ή να αποκρυπτογραφούν δεδομένα
- Μόνο οι χρήστες και οι ρόλοι IAM μπορούν να προστεθούν στη λίστα Διαχειριστών Κλειδιών (όχι ομάδες)
- Αν χρησιμοποιείται εξωτερικό CMK, οι Διαχειριστές Κλειδιών έχουν την άδεια να εισάγουν υλικό κλειδιού

### Περιστροφή CMKs

- Όσο περισσότερο παραμένει το ίδιο κλειδί στη θέση του, τόσο περισσότερα δεδομένα κρυπτογραφούνται με αυτό το κλειδί, και αν αυτό το κλειδί παραβιαστεί, τότε η περιοχή έκρηξης των δεδομένων είναι σε κίνδυνο. Επιπλέον, όσο περισσότερο είναι ενεργό το κλειδί, αυξάνεται η πιθανότητα να παραβιαστεί.
- **Το KMS περιστρέφει τα κλειδιά πελατών κάθε 365 ημέρες** (ή μπορείτε να εκτελέσετε τη διαδικασία χειροκίνητα όποτε θέλετε) και **τα κλειδιά που διαχειρίζεται το AWS κάθε 3 χρόνια** και αυτή τη φορά δεν μπορεί να αλλάξει.
- **Τα παλαιότερα κλειδιά διατηρούνται** για να αποκρυπτογραφούν δεδομένα που κρυπτογραφήθηκαν πριν από την περιστροφή
- Σε περίπτωση παραβίασης, η περιστροφή του κλειδιού δεν θα αφαιρέσει την απειλή καθώς θα είναι δυνατή η αποκρυπτογράφηση όλων των δεδομένων που κρυπτογραφήθηκαν με το παραβιασμένο κλειδί. Ωστόσο, τα **νέα δεδομένα θα κρυπτογραφηθούν με το νέο κλειδί**.
- Αν το **CMK** είναι σε κατάσταση **απενεργοποιημένο** ή **σε εκκρεμότητα** **διαγραφής**, το KMS **δεν θα εκτελέσει περιστροφή κλειδιού** μέχρι να επανενεργοποιηθεί το CMK ή να ακυρωθεί η διαγραφή.

#### Χειροκίνητη περιστροφή

- Ένα **νέο CMK πρέπει να δημιουργηθεί**, στη συνέχεια, δημιουργείται ένα νέο CMK-ID, οπότε θα χρειαστεί να **ενημερώσετε** οποιαδήποτε **εφαρμογή** για να **αναφέρεται** στο νέο CMK-ID.
- Για να διευκολύνετε αυτή τη διαδικασία μπορείτε να **χρησιμοποιήσετε ψευδώνυμα για να αναφέρετε ένα key-id** και στη συνέχεια απλώς να ενημερώσετε το κλειδί στο οποίο αναφέρεται το ψευδώνυμο.
- Πρέπει να **διατηρήσετε τα παλιά κλειδιά για να αποκρυπτογραφήσετε παλιά αρχεία** που κρυπτογραφήθηκαν με αυτό.

Μπορείτε να εισάγετε κλειδιά από την υποδομή κλειδιών σας.

### Άλλες σχετικές πληροφορίες KMS

Το KMS χρεώνεται ανά αριθμό αιτημάτων κρυπτογράφησης/αποκρυπτογράφησης που λαμβάνονται από όλες τις υπηρεσίες ανά μήνα.

Το KMS έχει πλήρη έλεγχο και συμμόρφωση **ενσωμάτωσης με το CloudTrail**; εδώ μπορείτε να ελέγξετε όλες τις αλλαγές που πραγματοποιήθηκαν στο KMS.

Με την πολιτική KMS μπορείτε να κάνετε τα εξής:

- Περιορίστε ποιος μπορεί να δημιουργήσει κλειδιά δεδομένων και ποιες υπηρεσίες έχουν πρόσβαση για να χρησιμοποιήσουν αυτά τα κλειδιά
- Περιορίστε την πρόσβαση των συστημάτων μόνο για κρυπτογράφηση, μόνο για αποκρυπτογράφηση ή και τα δύο
- Ορίστε να επιτρέπεται στα συστήματα να έχουν πρόσβαση σε κλειδιά σε διάφορες περιοχές (αν και δεν συνιστάται καθώς μια αποτυχία στην περιοχή που φιλοξενεί το KMS θα επηρεάσει τη διαθεσιμότητα των συστημάτων σε άλλες περιοχές).

Δεν μπορείτε να συγχρονίσετε ή να μετακινήσετε/αντιγράψετε κλειδιά σε διάφορες περιοχές; μπορείτε μόνο να ορίσετε κανόνες για να επιτρέψετε την πρόσβαση σε διάφορες περιοχές.

### Αριθμητική
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{{#ref}}
../aws-privilege-escalation/aws-kms-privesc.md
{{#endref}}

### Post Exploitation

{{#ref}}
../aws-post-exploitation/aws-kms-post-exploitation.md
{{#endref}}

### Persistence

{{#ref}}
../aws-persistence/aws-kms-persistence.md
{{#endref}}

## Αναφορές

- [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

{{#include ../../../banners/hacktricks-training.md}}
