# AWS - Relational Database (RDS) Enum

{{#include ../../../banners/hacktricks-training.md}}

## 基本情報

AWSが提供する**Relational Database Service (RDS)**は、**クラウド内のリレーショナルデータベースの展開、運用、スケーリング**を簡素化するように設計されています。このサービスは、コスト効率とスケーラビリティの利点を提供し、ハードウェアのプロビジョニング、データベースの構成、パッチ適用、バックアップなどの労働集約的なタスクを自動化します。

AWS RDSは、MySQL、PostgreSQL、MariaDB、Oracle Database、Microsoft SQL Server、Amazon Auroraなど、広く使用されているさまざまなリレーショナルデータベースエンジンをサポートしており、MySQLとPostgreSQLの両方に互換性があります。

RDSの主な機能には以下が含まれます：

- **データベースインスタンスの管理**が簡素化されています。
- 読み取りパフォーマンスを向上させるための**リードレプリカ**の作成。
- 高可用性とフェイルオーバーメカニズムを確保するための**マルチアベイラビリティゾーン（AZ）デプロイメント**の構成。
- 他のAWSサービスとの**統合**、例えば：
  - AWS Identity and Access Management (**IAM**)による堅牢なアクセス制御。
  - AWS **CloudWatch**による包括的な監視とメトリクス。
  - AWS Key Management Service (**KMS**)による静止データの暗号化の確保。

## 認証情報

DBクラスターを作成する際、マスター**ユーザー名**は設定可能です（デフォルトは**`admin`**）。このユーザーのパスワードを生成するには、以下の方法があります：

- **自分で**パスワードを指定する
- RDSに**自動生成**させる
- RDSに**AWS Secret Manager**でKMSキーで暗号化されたものを管理させる

<figure><img src="../../../images/image (144).png" alt=""><figcaption></figcaption></figure>

### 認証

認証オプションは3種類ありますが、**マスターパスワードの使用は常に許可されています**：

<figure><img src="../../../images/image (227).png" alt=""><figcaption></figcaption></figure>

### 公開アクセスとVPC

デフォルトでは**データベースに対する公開アクセスは付与されていません**が、**付与される可能性があります**。したがって、デフォルトでは、選択した**セキュリティグループ**（EC2 SGに保存されている）が許可している場合にのみ、同じVPC内のマシンがアクセスできます。

DBインスタンスを公開する代わりに、**RDS Proxy**を作成することが可能で、これによりDBクラスターの**スケーラビリティ**と**可用性**が向上します。

さらに、**データベースポートも変更可能**です。

### 暗号化

**暗号化はデフォルトで有効**になっており、AWS管理キーを使用します（代わりにCMKを選択することも可能です）。

暗号化を有効にすることで、**ストレージ、スナップショット、リードレプリカ、バックアップの静止データの暗号化**が有効になります。この暗号化を管理するためのキーは**KMS**を使用して発行できます。\
データベースが作成された後にこのレベルの暗号化を追加することはできません。**作成時に行う必要があります**。

ただし、**暗号化されていないデータベースを暗号化するための回避策があります**。暗号化されていないデータベースのスナップショットを作成し、そのスナップショットの暗号化されたコピーを作成し、その暗号化されたスナップショットを使用して新しいデータベースを作成することで、最終的にデータベースが暗号化されます。

#### 透過的データ暗号化 (TDE)

アプリケーションレベルでのRDSに固有の暗号化機能に加えて、RDSは静止データを保護するための**追加のプラットフォームレベルの暗号化メカニズム**もサポートしています。これには、OracleおよびSQL Server用の**透過的データ暗号化 (TDE)**が含まれます。ただし、TDEは静止データを暗号化することでセキュリティを強化しますが、**データベースのパフォーマンスに影響を与える可能性がある**ことに注意が必要です。このパフォーマンスへの影響は、MySQLの暗号化関数やMicrosoft Transact-SQLの暗号化関数と併用した場合に特に顕著です。

TDEを利用するには、いくつかの前提条件が必要です：

1. **オプショングループの関連付け**：
   - データベースはオプショングループに関連付けられている必要があります。オプショングループは、設定や機能のコンテナとして機能し、セキュリティの強化を含むデータベース管理を容易にします。
   - ただし、オプショングループは特定のデータベースエンジンとバージョンにのみ利用可能であることに注意が必要です。
2. **オプショングループへのTDEの含有**：
   - オプショングループに関連付けられた後、Oracleの透過的データ暗号化オプションをそのグループに含める必要があります。
   - TDEオプションがオプショングループに追加されると、それは恒久的なものであり、削除することはできません。
3. **TDE暗号化モード**：
   - TDEは2つの異なる暗号化モードを提供します：
     - **TDEテーブルスペース暗号化**：このモードは、全体のテーブルを暗号化し、より広範なデータ保護を提供します。
     - **TDEカラム暗号化**：このモードは、データベース内の特定の個別要素を暗号化することに焦点を当て、暗号化されるデータに対するより細かな制御を可能にします。

これらの前提条件とTDEの運用の複雑さを理解することは、RDS内での暗号化の効果的な実装と管理において重要であり、データのセキュリティと必要な基準への準拠を確保します。

### 列挙
```bash
# Clusters info
## Get Endpoints, username, port, iam auth enabled, attached roles, SG
aws rds describe-db-clusters
aws rds describe-db-cluster-endpoints #Cluster URLs
aws rds describe-db-cluster-backtracks --db-cluster-identifier <cluster-name>

## Cluster snapshots
aws rds describe-db-cluster-snapshots

# Get DB instances info
aws rds describe-db-instances #username, url, port, vpc, SG, is public?
aws rds describe-db-security-groups

## Find automated backups
aws rds describe-db-instance-automated-backups

## Find snapshots
aws rds describe-db-snapshots
aws rds describe-db-snapshots --include-public --snapshot-type public
## Restore snapshot as new instance
aws rds restore-db-instance-from-db-snapshot --db-instance-identifier <ID> --db-snapshot-identifier <ID> --availability-zone us-west-2a

# Any public snapshot in the account
aws rds describe-db-snapshots --snapshot-type public

# Proxies
aws rds describe-db-proxy-endpoints
aws rds describe-db-proxy-target-groups
aws rds describe-db-proxy-targets

## reset credentials of MasterUsername
aws rds modify-db-instance --db-instance-identifier <ID> --master-user-password <NewPassword> --apply-immediately
```
### 認証されていないアクセス

{{#ref}}
../aws-unauthenticated-enum-access/aws-rds-unauthenticated-enum.md
{{#endref}}

### 特権昇格

{{#ref}}
../aws-privilege-escalation/aws-rds-privesc.md
{{#endref}}

### ポストエクスプロイト

{{#ref}}
../aws-post-exploitation/aws-rds-post-exploitation.md
{{#endref}}

### 永続性

{{#ref}}
../aws-persistence/aws-rds-persistence.md
{{#endref}}

### SQLインジェクション

DynamoDBデータに**SQL構文**でアクセスする方法があるため、典型的な**SQLインジェクションも可能です**。

{{#ref}}
https://book.hacktricks.wiki/en/pentesting-web/sql-injection/index.html
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
