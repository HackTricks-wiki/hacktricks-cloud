# AWS - ECR Enum

## AWS - ECR Enum

{{#include ../../../banners/hacktricks-training.md}}

### ECR

#### Basic Information

Η Amazon **Elastic Container Registry** (Amazon ECR) είναι μια **διαχειριζόμενη υπηρεσία καταχώρησης εικόνων κοντέινερ**. Σχεδιάστηκε για να παρέχει ένα περιβάλλον όπου οι πελάτες μπορούν να αλληλεπιδρούν με τις εικόνες κοντέινερ τους χρησιμοποιώντας γνωστές διεπαφές. Συγκεκριμένα, υποστηρίζεται η χρήση του Docker CLI ή οποιουδήποτε προτιμώμενου πελάτη, επιτρέποντας δραστηριότητες όπως η αποστολή, η λήψη και η διαχείριση εικόνων κοντέινερ.

Το ECR αποτελείται από 2 τύπους αντικειμένων: **Registries** και **Repositories**.

**Registries**

Κάθε λογαριασμός AWS έχει 2 registries: **Private** & **Public**.

1. **Private Registries**:

- **Ιδιωτικό από προεπιλογή**: Οι εικόνες κοντέινερ που αποθηκεύονται σε μια ιδιωτική καταχώρηση Amazon ECR είναι **προσβάσιμες μόνο σε εξουσιοδοτημένους χρήστες** εντός του λογαριασμού AWS σας ή σε εκείνους που έχουν λάβει άδεια.
- Η URI μιας **ιδιωτικής αποθήκης** ακολουθεί τη μορφή `<account_id>.dkr.ecr.<region>.amazonaws.com/<repo-name>`
- **Έλεγχος πρόσβασης**: Μπορείτε να **ελέγξετε την πρόσβαση** στις ιδιωτικές εικόνες κοντέινερ σας χρησιμοποιώντας **πολιτικές IAM**, και μπορείτε να διαμορφώσετε λεπτομερείς άδειες με βάση τους χρήστες ή τους ρόλους.
- **Ενσωμάτωση με υπηρεσίες AWS**: Οι ιδιωτικές καταχωρήσεις Amazon ECR μπορούν να ενσωματωθούν εύκολα με άλλες υπηρεσίες AWS, όπως EKS, ECS...
- **Άλλες επιλογές ιδιωτικής καταχώρησης**:
- Η στήλη αμεταβλητότητας ετικετών αναφέρει την κατάσταση της, αν η αμεταβλητότητα ετικετών είναι ενεργοποιημένη θα **αποτρέπει** τις **αποστολές** εικόνας με **προϋπάρχουσες ετικέτες** από το να αντικαθιστούν τις εικόνες.
- Η στήλη **τύπου κρυπτογράφησης** αναφέρει τις ιδιότητες κρυπτογράφησης της αποθήκης, δείχνει τους προεπιλεγμένους τύπους κρυπτογράφησης όπως AES-256, ή έχει **KMS** ενεργοποιημένες κρυπτογραφήσεις.
- Η στήλη **Pull through cache** αναφέρει την κατάσταση της, αν η κατάσταση Pull through cache είναι Ενεργή θα αποθηκεύει **αποθήκες σε μια εξωτερική δημόσια αποθήκη στην ιδιωτική σας αποθήκη**.
- Συγκεκριμένες **πολιτικές IAM** μπορούν να διαμορφωθούν για να παραχωρήσουν διαφορετικές **άδειες**.
- Η **διαμόρφωση σάρωσης** επιτρέπει τη σάρωση για ευπάθειες στις εικόνες που αποθηκεύονται μέσα στην αποθήκη.

2. **Public Registries**:

- **Δημόσια προσβασιμότητα**: Οι εικόνες κοντέινερ που αποθηκεύονται σε μια δημόσια καταχώρηση ECR είναι **προσβάσιμες σε οποιονδήποτε στο διαδίκτυο χωρίς αυθεντικοποίηση.**
- Η URI μιας **δημόσιας αποθήκης** είναι όπως `public.ecr.aws/<random>/<name>`. Αν και το `<random>` μέρος μπορεί να αλλάξει από τον διαχειριστή σε μια άλλη συμβολοσειρά πιο εύκολη στην ανάμνηση.

**Repositories**

Αυτές είναι οι **εικόνες** που βρίσκονται στην **ιδιωτική καταχώρηση** ή στην **δημόσια**.

> [!NOTE]
> Σημειώστε ότι για να ανεβάσετε μια εικόνα σε μια αποθήκη, η **αποθήκη ECR πρέπει να έχει το ίδιο όνομα με την εικόνα**.

#### Registry & Repository Policies

**Registries & repositories** έχουν επίσης **πολιτικές που μπορούν να χρησιμοποιηθούν για να παραχωρήσουν άδειες σε άλλους φορείς/λογαριασμούς**. Για παράδειγμα, στην παρακάτω πολιτική αποθήκης μπορείτε να δείτε πώς οποιοσδήποτε χρήστης από ολόκληρη την οργάνωση θα μπορεί να έχει πρόσβαση στην εικόνα:

<figure><img src="../../../images/image (280).png" alt=""><figcaption></figcaption></figure>

#### Enumeration
```bash
# Get repos
aws ecr describe-repositories
aws ecr describe-registry

# Get image metadata
aws ecr list-images --repository-name <repo_name>
aws ecr describe-images --repository-name <repo_name>
aws ecr describe-image-replication-status --repository-name <repo_name> --image-id <image_id>
aws ecr describe-image-scan-findings --repository-name <repo_name> --image-id <image_id>
aws ecr describe-pull-through-cache-rules --repository-name <repo_name> --image-id <image_id>

# Get public repositories
aws ecr-public describe-repositories

# Get policies
aws ecr get-registry-policy
aws ecr get-repository-policy --repository-name <repo_name>
```
#### Μη Αυθεντικοποιημένη Enum

{{#ref}}
../aws-unauthenticated-enum-access/aws-ecr-unauthenticated-enum.md
{{#endref}}

#### Privesc

Στην παρακάτω σελίδα μπορείτε να ελέγξετε πώς να **καταχραστείτε τα δικαιώματα ECR για να κλιμακώσετε τα προνόμια**:

{{#ref}}
../aws-privilege-escalation/aws-ecr-privesc.md
{{#endref}}

#### Μετά την Εκμετάλλευση

{{#ref}}
../aws-post-exploitation/aws-ecr-post-exploitation.md
{{#endref}}

#### Επιμονή

{{#ref}}
../aws-persistence/aws-ecr-persistence.md
{{#endref}}

## Αναφορές

- [https://docs.aws.amazon.com/AmazonECR/latest/APIReference/Welcome.html](https://docs.aws.amazon.com/AmazonECR/latest/APIReference/Welcome.html)

{{#include ../../../banners/hacktricks-training.md}}
