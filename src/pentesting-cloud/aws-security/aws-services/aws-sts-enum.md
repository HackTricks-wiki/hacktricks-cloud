# AWS - STS Enum

{{#include ../../../banners/hacktricks-training.md}}

## STS

**AWS Security Token Service (STS)** ist hauptsächlich dafür konzipiert, **temporäre, eingeschränkte Berechtigungsnachweise** auszustellen. Diese Berechtigungsnachweise können für **AWS Identity and Access Management (IAM)**-Benutzer oder für authentifizierte Benutzer (federierte Benutzer) angefordert werden.

Da der Zweck von STS darin besteht, **Berechtigungsnachweise für Identitätsübernahme** auszustellen, ist der Dienst äußerst wertvoll für **Privilegieneskalation und Aufrechterhaltung der Persistenz**, auch wenn er möglicherweise nicht über eine breite Palette von Optionen verfügt.

### Assume Role Impersonation

Die Aktion [AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html), die von AWS STS bereitgestellt wird, ist entscheidend, da sie einem Principal erlaubt, Berechtigungsnachweise für einen anderen Principal zu erwerben, indem er ihn im Wesentlichen impersoniert. Bei der Ausführung antwortet sie mit einer Zugangs-ID, einem geheimen Schlüssel und einem Sitzungstoken, das dem angegebenen ARN entspricht.

Für Penetration Tester oder Red Team-Mitglieder ist diese Technik entscheidend für die Privilegieneskalation (wie [**hier**](../aws-privilege-escalation/aws-sts-privesc.md#sts-assumerole) erläutert). Es ist jedoch erwähnenswert, dass diese Technik recht auffällig ist und einen Angreifer möglicherweise nicht unvorbereitet trifft.

#### Assume Role Logic

Um eine Rolle im selben Konto zu übernehmen, wenn die **zu übernehmende Rolle speziell eine Rollen-ARN zulässt**, wie in:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:role/priv-role"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
Die Rolle **`priv-role`** muss in diesem Fall **nicht speziell erlaubt sein**, um diese Rolle zu übernehmen (mit dieser Erlaubnis ist es ausreichend).

Wenn jedoch eine Rolle einem Konto erlaubt, sie zu übernehmen, wie in:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:root"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
Die Rolle, die versucht, sie zu übernehmen, benötigt eine **spezifische `sts:AssumeRole`-Berechtigung** für diese Rolle, **um sie zu übernehmen**.

Wenn Sie versuchen, eine **Rolle** **aus einem anderen Konto** zu übernehmen, **muss die übernommene Rolle dies erlauben** (indem die Rolle **ARN** oder das **externe Konto** angegeben wird), und die **Rolle, die versucht,** die andere zu übernehmen, **MUSS** die **Berechtigungen haben, um sie zu übernehmen** (in diesem Fall ist dies nicht optional, selbst wenn die übernommene Rolle eine ARN angibt).

### Enumeration
```bash
# Get basic info of the creds
aws sts get-caller-identity
aws sts get-access-key-info --access-key-id <AccessKeyID>

# Get CLI a session token with current creds
## Using CLI creds
## You cannot get session creds using session creds
aws sts get-session-token
## MFA
aws sts get-session-token --serial-number <arn_device> --token-code <otp_code>
```
### Privesc

In der folgenden Seite kannst du überprüfen, wie man **STS-Berechtigungen missbraucht, um Privilegien zu eskalieren**:

{{#ref}}
../aws-privilege-escalation/aws-sts-privesc.md
{{#endref}}

### Post Exploitation

{{#ref}}
../aws-post-exploitation/aws-sts-post-exploitation.md
{{#endref}}

### Persistence

{{#ref}}
../aws-persistence/aws-sts-persistence.md
{{#endref}}

## References

- [https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm_source=pocket_mylist](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm_source=pocket_mylist)

{{#include ../../../banners/hacktricks-training.md}}
