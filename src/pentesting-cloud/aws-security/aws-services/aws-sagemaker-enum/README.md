# AWS - SageMaker Καταγραφή

{{#include ../../../../banners/hacktricks-training.md}}

## Επισκόπηση Υπηρεσίας

Το Amazon SageMaker είναι η διαχειριζόμενη πλατφόρμα μηχανικής μάθησης της AWS που συνδέει notebooks, υποδομές εκπαίδευσης, orchestration, registries και managed endpoints. Μια παραβίαση πόρων SageMaker συνήθως παρέχει:

- Μακροχρόνιες IAM execution roles με εκτεταμένη πρόσβαση σε S3, ECR, Secrets Manager ή KMS.
- Πρόσβαση σε ευαίσθητα datasets αποθηκευμένα σε S3, EFS ή μέσα σε feature stores.
- Δικτυακές εστίες μέσα σε VPCs (Studio apps, training jobs, endpoints).
- Presigned URLs υψηλών προνομίων που παρακάμπτουν την αυθεντικοποίηση της κονσόλας.

Η κατανόηση του πώς συναρμολογείται το SageMaker είναι κρίσιμη πριν pivot, persist, ή exfiltrate δεδομένα.

## Κύρια Συστατικά

- **Studio Domains & Spaces**: Web IDE (JupyterLab, Code Editor, RStudio). Κάθε domain έχει κοινόχρηστο σύστημα αρχείων EFS και προεπιλεγμένο execution role.
- **Notebook Instances**: Managed EC2 instances για standalone notebooks· χρησιμοποιούν ξεχωριστούς ρόλους εκτέλεσης.
- **Training / Processing / Transform Jobs**: Εφήμερα containers που τραβούν code από ECR και δεδομένα από S3.
- **Pipelines & Experiments**: Ορχηστρωμένες ροές εργασίας που περιγράφουν όλα τα βήματα, τις εισόδους και τις εξόδους.
- **Models & Endpoints**: Συσκευασμένα artefacts αναπτυγμένα για inference μέσω HTTPS endpoints.
- **Feature Store & Data Wrangler**: Managed υπηρεσίες για προετοιμασία δεδομένων και διαχείριση features.
- **Autopilot & JumpStart**: Automated ML και curated κατάλογος μοντέλων.
- **MLflow Tracking Servers**: Managed MLflow UI/API με presigned access tokens.

Κάθε resource αναφέρεται σε execution role, S3 locations, container images και προαιρετική VPC/KMS διαμόρφωση — καταγράψτε όλα αυτά κατά τη διάρκεια της enumeration.

## Λογαριασμός & Παγκόσμια Μεταδεδομένα
```bash
REGION=us-east-1
# Portfolio status, used when provisioning Studio resources
aws sagemaker get-sagemaker-servicecatalog-portfolio-status --region $REGION

# List execution roles used by models (extend to other resources as needed)
aws sagemaker list-models --region $REGION --query 'Models[].ExecutionRoleArn' --output text | tr '	' '
' | sort -u

# Generic tag sweep across any SageMaker ARN you know
aws sagemaker list-tags --resource-arn <sagemaker-arn> --region $REGION
```
Σημειώστε οποιαδήποτε cross-account trust (execution roles ή S3 buckets με external principals) και βασικούς περιορισμούς όπως service control policies ή SCPs.

## Studio Domains, Apps & Shared Spaces
```bash
aws sagemaker list-domains --region $REGION
aws sagemaker describe-domain --domain-id <domain-id> --region $REGION
aws sagemaker list-user-profiles --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-user-profile --domain-id <domain-id> --user-profile-name <profile> --region $REGION

# Enumerate apps (JupyterServer, KernelGateway, RStudioServerPro, CodeEditor, Canvas, etc.)
aws sagemaker list-apps --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-app --domain-id <domain-id> --user-profile-name <profile> --app-type JupyterServer --app-name default --region $REGION

# Shared collaborative spaces
aws sagemaker list-spaces --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-space --domain-id <domain-id> --space-name <space> --region $REGION

# Studio lifecycle configurations (shell scripts at start/stop)
aws sagemaker list-studio-lifecycle-configs --region $REGION
aws sagemaker describe-studio-lifecycle-config --studio-lifecycle-config-name <name> --region $REGION
```
Τι να καταγράψετε:

- `DomainArn`, `AppSecurityGroupIds`, `SubnetIds`, `DefaultUserSettings.ExecutionRole`.
- Προσαρτημένο EFS (`HomeEfsFileSystemId`) και καταλόγους home στο S3.
- Lifecycle scripts (συχνά περιέχουν bootstrap διαπιστευτήρια ή πρόσθετο push/pull κώδικα).

> [!TIP]
> Presigned Studio URLs μπορούν να παρακάμψουν τον έλεγχο ταυτότητας εάν χορηγηθούν ευρέως.

## Notebook Instances & Lifecycle Configs
```bash
aws sagemaker list-notebook-instances --region $REGION
aws sagemaker describe-notebook-instance --notebook-instance-name <name> --region $REGION
aws sagemaker list-notebook-instance-lifecycle-configs --region $REGION
aws sagemaker describe-notebook-instance-lifecycle-config --notebook-instance-lifecycle-config-name <cfg> --region $REGION
```
Τα μεταδεδομένα του notebook αποκαλύπτουν:

- Ρόλος εκτέλεσης (`RoleArn`), άμεση πρόσβαση στο Internet έναντι λειτουργίας μόνο σε VPC.
- Τοποθεσίες S3 σε `DefaultCodeRepository`, `DirectInternetAccess`, `RootAccess`.
- Lifecycle scripts για credentials ή persistence hooks.

## Εκπαίδευση, Επεξεργασία, Transform & Batch Jobs
```bash
aws sagemaker list-training-jobs --region $REGION
aws sagemaker describe-training-job --training-job-name <job> --region $REGION

aws sagemaker list-processing-jobs --region $REGION
aws sagemaker describe-processing-job --processing-job-name <job> --region $REGION

aws sagemaker list-transform-jobs --region $REGION
aws sagemaker describe-transform-job --transform-job-name <job> --region $REGION
```
Εξετάστε:

- `AlgorithmSpecification.TrainingImage` / `AppSpecification.ImageUri` – ποια ECR images έχουν αναπτυχθεί.
- `InputDataConfig` & `OutputDataConfig` – S3 buckets, prefixes και KMS keys.
- `ResourceConfig.VolumeKmsKeyId`, `VpcConfig`, `EnableNetworkIsolation` – καθορίζουν τη δικτυακή ή κρυπτογραφική διαμόρφωση.
- `HyperParameters` may leak environment secrets or connection strings.

## Pipelines, Πειράματα & Δοκιμές
```bash
aws sagemaker list-pipelines --region $REGION
aws sagemaker list-pipeline-executions --pipeline-name <pipeline> --region $REGION
aws sagemaker describe-pipeline --pipeline-name <pipeline> --region $REGION

aws sagemaker list-experiments --region $REGION
aws sagemaker list-trials --experiment-name <experiment> --region $REGION
aws sagemaker list-trial-components --trial-name <trial> --region $REGION
```
Οι ορισμοί pipeline περιγράφουν κάθε βήμα, τους συναφείς ρόλους, τις container images και τις μεταβλητές περιβάλλοντος. Τα Trial components συχνά περιέχουν training artefact URIs, S3 logs και μετρικές που υποδηλώνουν τη ροή ευαίσθητων δεδομένων.

## Μοντέλα, Διαμορφώσεις Endpoint & Αναπτυγμένα Endpoints
```bash
aws sagemaker list-models --region $REGION
aws sagemaker describe-model --model-name <name> --region $REGION

aws sagemaker list-endpoint-configs --region $REGION
aws sagemaker describe-endpoint-config --endpoint-config-name <cfg> --region $REGION

aws sagemaker list-endpoints --region $REGION
aws sagemaker describe-endpoint --endpoint-name <endpoint> --region $REGION
```
Focus areas:

- S3 URIs των artefact του μοντέλου (`PrimaryContainer.ModelDataUrl`) και inference container images.
- Διαμόρφωση data capture του Endpoint (S3 bucket, KMS) για πιθανό log exfil.
- Multi-model endpoints που χρησιμοποιούν `S3DataSource` ή `ModelPackage` (έλεγχος για cross-account packaging).
- Network configs και security groups που είναι επισυναπτόμενα στα endpoints.

## Feature Store, Data Wrangler & Clarify
```bash
aws sagemaker list-feature-groups --region $REGION
aws sagemaker describe-feature-group --feature-group-name <feature-group> --region $REGION

aws sagemaker list-data-wrangler-flows --region $REGION
aws sagemaker describe-data-wrangler-flow --flow-name <flow> --region $REGION

aws sagemaker list-model-quality-job-definitions --region $REGION
aws sagemaker list-model-monitoring-schedule --region $REGION
```
Συμπεράσματα ασφάλειας:

- Online feature stores αναπαράγουν δεδομένα στο Kinesis· ελέγξτε το `OnlineStoreConfig.SecurityConfig.KmsKeyId` και το VPC.
- Data Wrangler flows συχνά ενσωματώνουν JDBC/Redshift διαπιστευτήρια ή ιδιωτικά endpoints.
- Clarify/Model Monitor jobs εξάγουν δεδομένα σε S3 που ενδέχεται να είναι αναγνώσιμα από όλους ή προσβάσιμα cross-account.

## MLflow Tracking Servers, Autopilot & JumpStart
```bash
aws sagemaker list-mlflow-tracking-servers --region $REGION
aws sagemaker describe-mlflow-tracking-server --tracking-server-name <name> --region $REGION

aws sagemaker list-auto-ml-jobs --region $REGION
aws sagemaker describe-auto-ml-job --auto-ml-job-name <name> --region $REGION

aws sagemaker list-jumpstart-models --region $REGION
aws sagemaker list-jumpstart-script-resources --region $REGION
```
- MLflow tracking servers αποθηκεύουν πειράματα και artefacts; presigned URLs μπορούν να εκθέσουν τα πάντα.
- Οι Autopilot jobs εκκινούν πολλαπλά training jobs — απαριθμήστε τα outputs για κρυμμένα δεδομένα.
- Οι JumpStart reference architectures ενδέχεται να αναπτύξουν privileged roles στον λογαριασμό.

## IAM & Networking Considerations

- Απαριθμήστε τις IAM policies που είναι συνδεδεμένες με όλους τους ρόλους εκτέλεσης (Studio, notebooks, training jobs, pipelines, endpoints).
- Ελέγξτε τα network contexts: subnets, security groups, VPC endpoints. Πολλοί οργανισμοί απομονώνουν training jobs αλλά ξεχνούν να περιορίσουν την εξερχόμενη κίνηση.
- Ελέγξτε τις S3 bucket policies που αναφέρονται σε `ModelDataUrl`, `DataCaptureConfig`, `InputDataConfig` για εξωτερική πρόσβαση.

## Privilege Escalation

{{#ref}}
../../aws-privilege-escalation/aws-sagemaker-privesc/README.md
{{#endref}}

## Persistence

{{#ref}}
../../aws-persistence/aws-sagemaker-persistence/README.md
{{#endref}}

## Post-Exploitation

{{#ref}}
../../aws-post-exploitation/aws-sagemaker-post-exploitation/README.md
{{#endref}}

## Unauthorized Access

{{#ref}}
../../aws-sagemaker-unauthenticated-enum/README.md
{{#endref}}

## References

- [AWS SageMaker Documentation](https://docs.aws.amazon.com/sagemaker/latest/dg/whatis.html)
- [AWS CLI SageMaker Reference](https://docs.aws.amazon.com/cli/latest/reference/sagemaker/index.html)
- [SageMaker Studio Architecture](https://docs.aws.amazon.com/sagemaker/latest/dg/gs-studio.html)
- [SageMaker Security Best Practices](https://docs.aws.amazon.com/sagemaker/latest/dg/security.html)

{{#include ../../../../banners/hacktricks-training.md}}
