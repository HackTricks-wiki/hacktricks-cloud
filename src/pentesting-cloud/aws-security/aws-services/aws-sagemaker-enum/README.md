# AWS - SageMaker Enumération

{{#include ../../../../banners/hacktricks-training.md}}

## Présentation du service

Amazon SageMaker est la plateforme de machine learning gérée par AWS qui relie notebooks, infrastructure de training, orchestration, registries et endpoints gérés. Une compromission des ressources SageMaker fournit typiquement :

- Des execution roles IAM longue durée avec un large accès à S3, ECR, Secrets Manager, ou KMS.
- L'accès à des jeux de données sensibles stockés dans S3, EFS, ou à l'intérieur de feature stores.
- Des points d'appui réseau à l'intérieur de VPCs (Studio apps, training jobs, endpoints).
- Des presigned URLs à privilèges élevés qui contournent l'authentification console.

Comprendre comment SageMaker est assemblé est essentiel avant you pivot, persist, or exfiltrate data.

## Composants principaux

- **Studio Domains & Spaces**: Web IDE (JupyterLab, Code Editor, RStudio). Chaque domain dispose d'un système de fichiers EFS partagé et d'un execution role par défaut.
- **Notebook Instances**: Instances EC2 gérées pour notebooks autonomes ; utilisent des execution roles séparés.
- **Training / Processing / Transform Jobs**: Conteneurs éphémères qui pull du code depuis ECR et des données depuis S3.
- **Pipelines & Experiments**: Workflows orchestrés décrivant toutes les étapes, les entrées et les sorties.
- **Models & Endpoints**: Artefacts packagés déployés pour l'inférence via des endpoints HTTPS.
- **Feature Store & Data Wrangler**: Services gérés pour la préparation des données et la gestion des features.
- **Autopilot & JumpStart**: ML automatisé et catalogue de modèles sélectionnés.
- **MLflow Tracking Servers**: UI/API MLflow gérées avec des presigned access tokens.

Chaque ressource référence un execution role, des emplacements S3, des images de conteneur, et une configuration VPC/KMS optionnelle — capturez-les tous pendant l'énumération.

## Métadonnées du compte et globales
```bash
REGION=us-east-1
# Portfolio status, used when provisioning Studio resources
aws sagemaker get-sagemaker-servicecatalog-portfolio-status --region $REGION

# List execution roles used by models (extend to other resources as needed)
aws sagemaker list-models --region $REGION --query 'Models[].ExecutionRoleArn' --output text | tr '	' '
' | sort -u

# Generic tag sweep across any SageMaker ARN you know
aws sagemaker list-tags --resource-arn <sagemaker-arn> --region $REGION
```
Notez toute relation de confiance inter-comptes (execution roles ou S3 buckets avec des external principals) et les restrictions de base telles que service control policies ou SCPs.

## Studio Domains, Apps & Shared Spaces
```bash
aws sagemaker list-domains --region $REGION
aws sagemaker describe-domain --domain-id <domain-id> --region $REGION
aws sagemaker list-user-profiles --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-user-profile --domain-id <domain-id> --user-profile-name <profile> --region $REGION

# Enumerate apps (JupyterServer, KernelGateway, RStudioServerPro, CodeEditor, Canvas, etc.)
aws sagemaker list-apps --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-app --domain-id <domain-id> --user-profile-name <profile> --app-type JupyterServer --app-name default --region $REGION

# Shared collaborative spaces
aws sagemaker list-spaces --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-space --domain-id <domain-id> --space-name <space> --region $REGION

# Studio lifecycle configurations (shell scripts at start/stop)
aws sagemaker list-studio-lifecycle-configs --region $REGION
aws sagemaker describe-studio-lifecycle-config --studio-lifecycle-config-name <name> --region $REGION
```
À enregistrer :

- `DomainArn`, `AppSecurityGroupIds`, `SubnetIds`, `DefaultUserSettings.ExecutionRole`.
- EFS monté (`HomeEfsFileSystemId`) et répertoires home S3.
- Lifecycle scripts (contiennent souvent des identifiants bootstrap ou du code supplémentaire push/pull).

> [!TIP]
> Les Presigned Studio URLs peuvent contourner l'authentification si leur accès est trop large.

## Notebook Instances & Lifecycle Configs
```bash
aws sagemaker list-notebook-instances --region $REGION
aws sagemaker describe-notebook-instance --notebook-instance-name <name> --region $REGION
aws sagemaker list-notebook-instance-lifecycle-configs --region $REGION
aws sagemaker describe-notebook-instance-lifecycle-config --notebook-instance-lifecycle-config-name <cfg> --region $REGION
```
Les métadonnées du notebook révèlent :

- Rôle d'exécution (`RoleArn`), accès direct à Internet vs VPC-only.
- Emplacements S3 dans `DefaultCodeRepository`, `DirectInternetAccess`, `RootAccess`.
- Scripts de lifecycle pour credentials ou hooks de persistance.

## Training, Processing, Transform & Batch Jobs
```bash
aws sagemaker list-training-jobs --region $REGION
aws sagemaker describe-training-job --training-job-name <job> --region $REGION

aws sagemaker list-processing-jobs --region $REGION
aws sagemaker describe-processing-job --processing-job-name <job> --region $REGION

aws sagemaker list-transform-jobs --region $REGION
aws sagemaker describe-transform-job --transform-job-name <job> --region $REGION
```
Scrutez :

- `AlgorithmSpecification.TrainingImage` / `AppSpecification.ImageUri` – quelles images ECR sont déployées.
- `InputDataConfig` & `OutputDataConfig` – les buckets S3, les préfixes et les clés KMS.
- `ResourceConfig.VolumeKmsKeyId`, `VpcConfig`, `EnableNetworkIsolation` – déterminent la posture réseau ou de chiffrement.
- `HyperParameters` peuvent leak des secrets d'environnement ou des chaînes de connexion.

## Pipelines, Experiments & Trials
```bash
aws sagemaker list-pipelines --region $REGION
aws sagemaker list-pipeline-executions --pipeline-name <pipeline> --region $REGION
aws sagemaker describe-pipeline --pipeline-name <pipeline> --region $REGION

aws sagemaker list-experiments --region $REGION
aws sagemaker list-trials --experiment-name <experiment> --region $REGION
aws sagemaker list-trial-components --trial-name <trial> --region $REGION
```
Les définitions de pipeline détaillent chaque étape, les rôles associés, les images de conteneurs et les variables d'environnement. Les Trial components contiennent souvent des URI d'artefacts d'entraînement, des logs S3 et des métriques qui laissent entrevoir le flux de données sensibles.

## Modèles, configurations des points de terminaison et points de terminaison déployés
```bash
aws sagemaker list-models --region $REGION
aws sagemaker describe-model --model-name <name> --region $REGION

aws sagemaker list-endpoint-configs --region $REGION
aws sagemaker describe-endpoint-config --endpoint-config-name <cfg> --region $REGION

aws sagemaker list-endpoints --region $REGION
aws sagemaker describe-endpoint --endpoint-name <endpoint> --region $REGION
```
- URIs S3 des artefacts de modèle (`PrimaryContainer.ModelDataUrl`) et images des conteneurs d'inférence.
- Configuration de capture de données des endpoints (S3 bucket, KMS) pour une éventuelle exfiltration de logs.
- Endpoints multi-modèles utilisant `S3DataSource` ou `ModelPackage` (vérifier le packaging cross-account).
- Configurations réseau et groupes de sécurité attachés aux endpoints.

## Feature Store, Data Wrangler & Clarify
```bash
aws sagemaker list-feature-groups --region $REGION
aws sagemaker describe-feature-group --feature-group-name <feature-group> --region $REGION

aws sagemaker list-data-wrangler-flows --region $REGION
aws sagemaker describe-data-wrangler-flow --flow-name <flow> --region $REGION

aws sagemaker list-model-quality-job-definitions --region $REGION
aws sagemaker list-model-monitoring-schedule --region $REGION
```
Points de sécurité :

- Online feature stores répliquent des données vers Kinesis ; vérifiez `OnlineStoreConfig.SecurityConfig.KmsKeyId` et VPC.
- Data Wrangler flows intègrent souvent des identifiants JDBC/Redshift ou des points de terminaison privés.
- Les jobs Clarify/Model Monitor exportent des données vers S3 qui peuvent être lisibles publiquement ou accessibles par d'autres comptes.

## Serveurs de tracking MLflow, Autopilot & JumpStart
```bash
aws sagemaker list-mlflow-tracking-servers --region $REGION
aws sagemaker describe-mlflow-tracking-server --tracking-server-name <name> --region $REGION

aws sagemaker list-auto-ml-jobs --region $REGION
aws sagemaker describe-auto-ml-job --auto-ml-job-name <name> --region $REGION

aws sagemaker list-jumpstart-models --region $REGION
aws sagemaker list-jumpstart-script-resources --region $REGION
```
- MLflow tracking servers stockent des expériences et des artefacts ; les URLs pré-signées peuvent tout exposer.
- Les jobs Autopilot lancent plusieurs training jobs — énumérez les sorties pour trouver des données cachées.
- Les architectures de référence JumpStart peuvent déployer des rôles privilégiés dans le compte.

## IAM & Networking Considerations

- Énumérez les politiques IAM attachées à tous les rôles d'exécution (Studio, notebooks, training jobs, pipelines, endpoints).
- Vérifiez le contexte réseau : subnets, security groups, VPC endpoints. De nombreuses organisations isolent les training jobs mais oublient de restreindre le trafic sortant.
- Passez en revue les bucket policies S3 référencées dans `ModelDataUrl`, `DataCaptureConfig`, `InputDataConfig` pour détecter un accès externe.

## Privilege Escalation

{{#ref}}
../../aws-privilege-escalation/aws-sagemaker-privesc/README.md
{{#endref}}

## Persistence

{{#ref}}
../../aws-persistence/aws-sagemaker-persistence/README.md
{{#endref}}

## Post-Exploitation

{{#ref}}
../../aws-post-exploitation/aws-sagemaker-post-exploitation/README.md
{{#endref}}

## Unauthorized Access

{{#ref}}
../../aws-sagemaker-unauthenticated-enum/README.md
{{#endref}}

## References

- [AWS SageMaker Documentation](https://docs.aws.amazon.com/sagemaker/latest/dg/whatis.html)
- [AWS CLI SageMaker Reference](https://docs.aws.amazon.com/cli/latest/reference/sagemaker/index.html)
- [SageMaker Studio Architecture](https://docs.aws.amazon.com/sagemaker/latest/dg/gs-studio.html)
- [SageMaker Security Best Practices](https://docs.aws.amazon.com/sagemaker/latest/dg/security.html)

{{#include ../../../../banners/hacktricks-training.md}}
