# AWS - SageMaker Καταγραφή

{{#include ../../../../banners/hacktricks-training.md}}

## Επισκόπηση Υπηρεσίας

Amazon SageMaker είναι η managed πλατφόρμα machine-learning της AWS που συνδέει notebooks, training infrastructure, orchestration, registries και managed endpoints. Μια παραβίαση πόρων SageMaker συνήθως παρέχει:

- Long-lived IAM execution roles με ευρύ access σε S3, ECR, Secrets Manager ή KMS.
- Πρόσβαση σε ευαίσθητα datasets αποθηκευμένα σε S3, EFS, ή μέσα σε feature stores.
- Network footholds μέσα σε VPCs (Studio apps, training jobs, endpoints).
- High-privilege presigned URLs που παρακάμπτουν το console authentication.

Η κατανόηση του πώς συναρμολογείται το SageMaker είναι κλειδί πριν pivot, persist, ή exfiltrate data.

## Βασικά Συστατικά

- **Studio Domains & Spaces**: Web IDE (JupyterLab, Code Editor, RStudio). Κάθε domain έχει κοινό σύστημα αρχείων EFS και προεπιλεγμένο ρόλο εκτέλεσης.
- **Notebook Instances**: Managed EC2 instances για standalone notebooks; χρησιμοποιούν ξεχωριστούς ρόλους εκτέλεσης.
- **Training / Processing / Transform Jobs**: Ephemeral containers που τραβούν code από ECR και δεδομένα από S3.
- **Pipelines & Experiments**: Orchestrated workflows που περιγράφουν όλα τα βήματα, inputs, και outputs.
- **Models & Endpoints**: Πακεταρισμένα artefacts αναπτυγμένα για inference μέσω HTTPS endpoints.
- **Feature Store & Data Wrangler**: Managed services για προετοιμασία δεδομένων και διαχείριση features.
- **Autopilot & JumpStart**: Αυτοματοποιημένο ML και curated κατάλογος μοντέλων.
- **MLflow Tracking Servers**: Managed MLflow UI/API με presigned access tokens.

Κάθε resource αναφέρεται σε execution role, S3 locations, container images, και προαιρετική VPC/KMS configuration—capture όλα αυτά κατά τη διάρκεια της enumeration.

## Account & Global Metadata
```bash
REGION=us-east-1
# Portfolio status, used when provisioning Studio resources
aws sagemaker get-sagemaker-servicecatalog-portfolio-status --region $REGION

# List execution roles used by models (extend to other resources as needed)
aws sagemaker list-models --region $REGION --query 'Models[].ExecutionRoleArn' --output text | tr '	' '
' | sort -u

# Generic tag sweep across any SageMaker ARN you know
aws sagemaker list-tags --resource-arn <sagemaker-arn> --region $REGION
```
Σημειώστε τυχόν cross-account trust (execution roles ή S3 buckets με external principals) και βασικούς περιορισμούς, όπως service control policies ή SCPs.

## Studio Domains, Apps & Shared Spaces
```bash
aws sagemaker list-domains --region $REGION
aws sagemaker describe-domain --domain-id <domain-id> --region $REGION
aws sagemaker list-user-profiles --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-user-profile --domain-id <domain-id> --user-profile-name <profile> --region $REGION

# Enumerate apps (JupyterServer, KernelGateway, RStudioServerPro, CodeEditor, Canvas, etc.)
aws sagemaker list-apps --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-app --domain-id <domain-id> --user-profile-name <profile> --app-type JupyterServer --app-name default --region $REGION

# Shared collaborative spaces
aws sagemaker list-spaces --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-space --domain-id <domain-id> --space-name <space> --region $REGION

# Studio lifecycle configurations (shell scripts at start/stop)
aws sagemaker list-studio-lifecycle-configs --region $REGION
aws sagemaker describe-studio-lifecycle-config --studio-lifecycle-config-name <name> --region $REGION
```
Τι να καταγράψετε:

- `DomainArn`, `AppSecurityGroupIds`, `SubnetIds`, `DefaultUserSettings.ExecutionRole`.
- Τοποθετημένο EFS (`HomeEfsFileSystemId`) και S3 home directories.
- Lifecycle scripts (συχνά περιέχουν bootstrap credentials ή push/pull επιπλέον κώδικα).

> [!TIP]
> Presigned Studio URLs μπορούν να παρακάμψουν την επαλήθευση ταυτότητας αν χορηγηθούν ευρέως.

## Notebook Instances & Lifecycle Configs
```bash
aws sagemaker list-notebook-instances --region $REGION
aws sagemaker describe-notebook-instance --notebook-instance-name <name> --region $REGION
aws sagemaker list-notebook-instance-lifecycle-configs --region $REGION
aws sagemaker describe-notebook-instance-lifecycle-config --notebook-instance-lifecycle-config-name <cfg> --region $REGION
```
Τα metadata του notebook αποκαλύπτουν:

- Ρόλος εκτέλεσης (`RoleArn`), άμεση πρόσβαση στο Internet έναντι VPC-only mode.
- Τοποθεσίες S3 σε `DefaultCodeRepository`, `DirectInternetAccess`, `RootAccess`.
- Σενάρια Lifecycle για credentials ή persistence hooks.

## Training, Processing, Transform & Batch Jobs
```bash
aws sagemaker list-training-jobs --region $REGION
aws sagemaker describe-training-job --training-job-name <job> --region $REGION

aws sagemaker list-processing-jobs --region $REGION
aws sagemaker describe-processing-job --processing-job-name <job> --region $REGION

aws sagemaker list-transform-jobs --region $REGION
aws sagemaker describe-transform-job --transform-job-name <job> --region $REGION
```
Επιθεωρήστε:

- `AlgorithmSpecification.TrainingImage` / `AppSpecification.ImageUri` – ποιες ECR images αναπτύσσονται.
- `InputDataConfig` & `OutputDataConfig` – S3 buckets, prefixes, και KMS keys.
- `ResourceConfig.VolumeKmsKeyId`, `VpcConfig`, `EnableNetworkIsolation` – καθορίστε τη δικτυακή ή κρυπτογραφική διαμόρφωση.
- `HyperParameters` may leak environment secrets or connection strings.

## Pipelines, Experiments & Trials
```bash
aws sagemaker list-pipelines --region $REGION
aws sagemaker list-pipeline-executions --pipeline-name <pipeline> --region $REGION
aws sagemaker describe-pipeline --pipeline-name <pipeline> --region $REGION

aws sagemaker list-experiments --region $REGION
aws sagemaker list-trials --experiment-name <experiment> --region $REGION
aws sagemaker list-trial-components --trial-name <trial> --region $REGION
```
Οι ορισμοί pipeline αναλύουν κάθε βήμα, τους συνδεδεμένους ρόλους, τα container images και τις environment variables. Τα Trial components συχνά περιέχουν training artefact URIs, S3 logs και metrics που υποδηλώνουν τη ροή ευαίσθητων δεδομένων.

## Μοντέλα, Διαμορφώσεις Endpoint & Αναπτυγμένα Endpoints
```bash
aws sagemaker list-models --region $REGION
aws sagemaker describe-model --model-name <name> --region $REGION

aws sagemaker list-endpoint-configs --region $REGION
aws sagemaker describe-endpoint-config --endpoint-config-name <cfg> --region $REGION

aws sagemaker list-endpoints --region $REGION
aws sagemaker describe-endpoint --endpoint-name <endpoint> --region $REGION
```
- S3 URIs των artefact του μοντέλου (`PrimaryContainer.ModelDataUrl`) και των inference container images.
- Ρυθμίσεις endpoint data capture (S3 bucket, KMS) για πιθανή log exfil.
- Multi-model endpoints που χρησιμοποιούν `S3DataSource` ή `ModelPackage` (έλεγχος για cross-account packaging).
- Network configs και ομάδες ασφαλείας που συνδέονται με τα endpoints.

## Feature Store, Data Wrangler & Clarify
```bash
aws sagemaker list-feature-groups --region $REGION
aws sagemaker describe-feature-group --feature-group-name <feature-group> --region $REGION

aws sagemaker list-data-wrangler-flows --region $REGION
aws sagemaker describe-data-wrangler-flow --flow-name <flow> --region $REGION

aws sagemaker list-model-quality-job-definitions --region $REGION
aws sagemaker list-model-monitoring-schedule --region $REGION
```
Σημεία ασφαλείας:

- Τα online αποθετήρια χαρακτηριστικών αναπαράγουν δεδομένα στο Kinesis· ελέγξτε το `OnlineStoreConfig.SecurityConfig.KmsKeyId` και το VPC.
- Οι ροές Data Wrangler συχνά ενσωματώνουν διαπιστευτήρια JDBC/Redshift ή ιδιωτικά endpoints.
- Οι εργασίες Clarify/Model Monitor εξάγουν δεδομένα σε S3 που μπορεί να είναι world-readable ή cross-account accessible.

## MLflow Tracking Servers, Autopilot & JumpStart
```bash
aws sagemaker list-mlflow-tracking-servers --region $REGION
aws sagemaker describe-mlflow-tracking-server --tracking-server-name <name> --region $REGION

aws sagemaker list-auto-ml-jobs --region $REGION
aws sagemaker describe-auto-ml-job --auto-ml-job-name <name> --region $REGION

aws sagemaker list-jumpstart-models --region $REGION
aws sagemaker list-jumpstart-script-resources --region $REGION
```
- Οι MLflow tracking servers αποθηκεύουν πειράματα και artefacts· οι presigned URLs μπορούν να αποκαλύψουν τα πάντα.
- Τα Autopilot jobs εκκινούν πολλαπλά training jobs — εξετάστε τα outputs για κρυμμένα δεδομένα.
- Οι JumpStart reference architectures ενδέχεται να αναπτύξουν privileged roles στον λογαριασμό.

## IAM & Θέματα Δικτύωσης

- Καταγράψτε τις IAM policies που είναι επισυναπτόμενες σε όλους τους execution roles (Studio, notebooks, training jobs, pipelines, endpoints).
- Ελέγξτε τα network contexts: subnets, security groups, VPC endpoints. Πολλές οργανώσεις απομονώνουν training jobs αλλά ξεχνούν να περιορίσουν την εξερχόμενη κίνηση.
- Ελέγξτε τις S3 bucket policies που αναφέρονται σε `ModelDataUrl`, `DataCaptureConfig`, `InputDataConfig` για εξωτερική πρόσβαση.

## Privilege Escalation

{{#ref}}
../../aws-privilege-escalation/aws-sagemaker-privesc/README.md
{{#endref}}

## Persistence

{{#ref}}
../../aws-persistence/aws-sagemaker-persistence/README.md
{{#endref}}

## Post-Exploitation

{{#ref}}
../../aws-post-exploitation/aws-sagemaker-post-exploitation/README.md
{{#endref}}

## Unauthorized Access

{{#ref}}
../aws-sagemaker-unauthorized-access/README.md
{{#endref}}

## Αναφορές

- [AWS SageMaker Documentation](https://docs.aws.amazon.com/sagemaker/latest/dg/whatis.html)
- [AWS CLI SageMaker Reference](https://docs.aws.amazon.com/cli/latest/reference/sagemaker/index.html)
- [SageMaker Studio Architecture](https://docs.aws.amazon.com/sagemaker/latest/dg/gs-studio.html)
- [SageMaker Security Best Practices](https://docs.aws.amazon.com/sagemaker/latest/dg/security.html)

{{#include ../../../../banners/hacktricks-training.md}}
