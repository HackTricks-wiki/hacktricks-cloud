# AWS - SageMaker Enum

{{#include ../../../../banners/hacktricks-training.md}}

## Pregled servisa

Amazon SageMaker je AWS-ova upravljana platforma za machine-learning koja povezuje notebooks, infrastrukturu za obuku, orkestraciju, registre i upravljane endpoints. Kompromitovanje SageMaker resursa obično omogućava:

- Dugotrajne IAM execution role sa širokim pristupom S3, ECR, Secrets Manager ili KMS.
- Pristup osetljivim dataset-ima pohranjenim u S3, EFS ili unutar feature store-ova.
- Mrežni footholds unutar VPC-ova (Studio apps, training jobs, endpoints).
- Visoko-privilegovane presigned URLs koje zaobilaze console authentication.

Razumevanje kako je SageMaker sastavljen je ključno pre nego što pivot, persist, ili exfiltrate data.

## Osnovne komponente

- **Studio Domains & Spaces**: Web IDE (JupyterLab, Code Editor, RStudio). Svaki domain ima deljeni EFS file system i podrazumevanu execution role.
- **Notebook Instances**: Managed EC2 instances za standalone notebooks; koriste odvojene execution roles.
- **Training / Processing / Transform Jobs**: Ephemeral containers koji povlače kod iz ECR i podatke iz S3.
- **Pipelines & Experiments**: Orkestrirani workflows koji opisuju sve korake, inputs i outputs.
- **Models & Endpoints**: Packaged artefakti deploy-ovani za inference preko HTTPS endpoints.
- **Feature Store & Data Wrangler**: Upravljani servisi za pripremu podataka i upravljanje feature-ima.
- **Autopilot & JumpStart**: Automated ML i kurirana katalog modela.
- **MLflow Tracking Servers**: Managed MLflow UI/API sa presigned access tokens.

Svaki resurs referencira execution role, S3 lokacije, container images i opcioni VPC/KMS konfiguraciju — zabeležite sve tokom enumeration.

## Nalog i globalni metapodaci
```bash
REGION=us-east-1
# Portfolio status, used when provisioning Studio resources
aws sagemaker get-sagemaker-servicecatalog-portfolio-status --region $REGION

# List execution roles used by models (extend to other resources as needed)
aws sagemaker list-models --region $REGION --query 'Models[].ExecutionRoleArn' --output text | tr '	' '
' | sort -u

# Generic tag sweep across any SageMaker ARN you know
aws sagemaker list-tags --resource-arn <sagemaker-arn> --region $REGION
```
Zabeležite svaku cross-account trust (execution roles ili S3 buckets sa external principals) i osnovna ograničenja kao što su service control policies ili SCPs.

## Studio Domains, Apps & Shared Spaces
```bash
aws sagemaker list-domains --region $REGION
aws sagemaker describe-domain --domain-id <domain-id> --region $REGION
aws sagemaker list-user-profiles --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-user-profile --domain-id <domain-id> --user-profile-name <profile> --region $REGION

# Enumerate apps (JupyterServer, KernelGateway, RStudioServerPro, CodeEditor, Canvas, etc.)
aws sagemaker list-apps --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-app --domain-id <domain-id> --user-profile-name <profile> --app-type JupyterServer --app-name default --region $REGION

# Shared collaborative spaces
aws sagemaker list-spaces --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-space --domain-id <domain-id> --space-name <space> --region $REGION

# Studio lifecycle configurations (shell scripts at start/stop)
aws sagemaker list-studio-lifecycle-configs --region $REGION
aws sagemaker describe-studio-lifecycle-config --studio-lifecycle-config-name <name> --region $REGION
```
What to record:

- `DomainArn`, `AppSecurityGroupIds`, `SubnetIds`, `DefaultUserSettings.ExecutionRole`.
- Montirani EFS (`HomeEfsFileSystemId`) i S3 home direktorijumi.
- Lifecycle skripte (često sadrže bootstrap credentials ili push/pull dodatnog koda).

> [!TIP]
> Presigned Studio URLs mogu zaobići autentifikaciju ako su široko dodeljene.

## Notebook Instances & Lifecycle Configs
```bash
aws sagemaker list-notebook-instances --region $REGION
aws sagemaker describe-notebook-instance --notebook-instance-name <name> --region $REGION
aws sagemaker list-notebook-instance-lifecycle-configs --region $REGION
aws sagemaker describe-notebook-instance-lifecycle-config --notebook-instance-lifecycle-config-name <cfg> --region $REGION
```
Metapodaci notebooka otkrivaju:

- Uloga za izvršavanje (`RoleArn`), direktan pristup internetu naspram režima samo u VPC-u.
- S3 lokacije u `DefaultCodeRepository`, `DirectInternetAccess`, `RootAccess`.
- Lifecycle skripte za kredencijale ili hook-ove za perzistenciju.

## Trening, obrada, transformacija i Batch poslovi
```bash
aws sagemaker list-training-jobs --region $REGION
aws sagemaker describe-training-job --training-job-name <job> --region $REGION

aws sagemaker list-processing-jobs --region $REGION
aws sagemaker describe-processing-job --processing-job-name <job> --region $REGION

aws sagemaker list-transform-jobs --region $REGION
aws sagemaker describe-transform-job --transform-job-name <job> --region $REGION
```
Detaljno pregledajte:

- `AlgorithmSpecification.TrainingImage` / `AppSpecification.ImageUri` – koji ECR images su raspoređeni.
- `InputDataConfig` & `OutputDataConfig` – S3 bucketi, prefiksi i KMS ključevi.
- `ResourceConfig.VolumeKmsKeyId`, `VpcConfig`, `EnableNetworkIsolation` – procenite mrežni i enkripcioni status.
- `HyperParameters` mogu leakovati tajne okruženja ili connection strings.

## Pipelines, Experiments & Trials
```bash
aws sagemaker list-pipelines --region $REGION
aws sagemaker list-pipeline-executions --pipeline-name <pipeline> --region $REGION
aws sagemaker describe-pipeline --pipeline-name <pipeline> --region $REGION

aws sagemaker list-experiments --region $REGION
aws sagemaker list-trials --experiment-name <experiment> --region $REGION
aws sagemaker list-trial-components --trial-name <trial> --region $REGION
```
Definicije pipeline-a detaljno opisuju svaki korak, pripadajuće role, container image-e i promenljive okruženja. Komponente trial-a često sadrže training artefact URI-je, S3 logove i metrike koje nagoveštavaju tok osetljivih podataka.

## Modeli, konfiguracije endpoint-a i raspoređeni endpointi
```bash
aws sagemaker list-models --region $REGION
aws sagemaker describe-model --model-name <name> --region $REGION

aws sagemaker list-endpoint-configs --region $REGION
aws sagemaker describe-endpoint-config --endpoint-config-name <cfg> --region $REGION

aws sagemaker list-endpoints --region $REGION
aws sagemaker describe-endpoint --endpoint-name <endpoint> --region $REGION
```
Fokus oblasti:

- S3 URI-ovi artefakata modela (`PrimaryContainer.ModelDataUrl`) i slike kontejnera za inferencu.
- Konfiguracija Endpoint data capture (S3 bucket, KMS) za mogući izvoz logova.
- Multi-model endpoints koji koriste `S3DataSource` ili `ModelPackage` (proverite cross-account packaging).
- Mrežne konfiguracije i security groups pridružene endpointima.

## Feature Store, Data Wrangler & Clarify
```bash
aws sagemaker list-feature-groups --region $REGION
aws sagemaker describe-feature-group --feature-group-name <feature-group> --region $REGION

aws sagemaker list-data-wrangler-flows --region $REGION
aws sagemaker describe-data-wrangler-flow --flow-name <flow> --region $REGION

aws sagemaker list-model-quality-job-definitions --region $REGION
aws sagemaker list-model-monitoring-schedule --region $REGION
```
Bezbednosne napomene:

- Online feature store-ovi repliciraju podatke u Kinesis; proverite `OnlineStoreConfig.SecurityConfig.KmsKeyId` i VPC.
- Data Wrangler flow-ovi često sadrže JDBC/Redshift podatke za prijavu ili privatne endpoint-e.
- Clarify/Model Monitor poslovi izvoze podatke u S3 koji mogu biti čitljivi svima (world-readable) ili dostupni između naloga (cross-account).

## MLflow Tracking Servers, Autopilot & JumpStart
```bash
aws sagemaker list-mlflow-tracking-servers --region $REGION
aws sagemaker describe-mlflow-tracking-server --tracking-server-name <name> --region $REGION

aws sagemaker list-auto-ml-jobs --region $REGION
aws sagemaker describe-auto-ml-job --auto-ml-job-name <name> --region $REGION

aws sagemaker list-jumpstart-models --region $REGION
aws sagemaker list-jumpstart-script-resources --region $REGION
```
- MLflow tracking servers čuvaju eksperimente i artefakte; presigned URLs mogu izložiti sve.
- Autopilot jobs pokreću više training jobs — enumerišite izlaze radi skrivenih podataka.
- JumpStart reference architectures mogu deploy-ovati privileged roles u account.

## IAM & mrežna razmatranja

- Enumerišite IAM policies prikačene na sve execution roles (Studio, notebooks, training jobs, pipelines, endpoints).
- Proverite mrežne kontekte: subnets, security groups, VPC endpoints. Mnoge organizacije izoliraju training jobs ali zaborave da ograniče outbound traffic.
- Pregledajte S3 bucket policies referenced u `ModelDataUrl`, `DataCaptureConfig`, `InputDataConfig` radi eksternog pristupa.

## Privilege Escalation

{{#ref}}
../../aws-privilege-escalation/aws-sagemaker-privesc/README.md
{{#endref}}

## Persistence

{{#ref}}
../../aws-persistence/aws-sagemaker-persistence/README.md
{{#endref}}

## Post-Exploitation

{{#ref}}
../../aws-post-exploitation/aws-sagemaker-post-exploitation/README.md
{{#endref}}

## Unauthorized Access

{{#ref}}
../aws-sagemaker-unauthorized-access/README.md
{{#endref}}

## References

- [AWS SageMaker Documentation](https://docs.aws.amazon.com/sagemaker/latest/dg/whatis.html)
- [AWS CLI SageMaker Reference](https://docs.aws.amazon.com/cli/latest/reference/sagemaker/index.html)
- [SageMaker Studio Architecture](https://docs.aws.amazon.com/sagemaker/latest/dg/gs-studio.html)
- [SageMaker Security Best Practices](https://docs.aws.amazon.com/sagemaker/latest/dg/security.html)

{{#include ../../../../banners/hacktricks-training.md}}
