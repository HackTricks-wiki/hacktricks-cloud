# AWS - SageMaker Enum

{{#include ../../../../banners/hacktricks-training.md}}

## サービス概要

Amazon SageMaker は、ノートブック、トレーニングインフラ、オーケストレーション、レジストリ、マネージドエンドポイントを結びつける AWS のマネージド機械学習プラットフォームです。SageMaker リソースが侵害されると通常、次のような権限やアクセスが得られます:

- 長期的な IAM 実行ロール（広範な S3、ECR、Secrets Manager、または KMS へのアクセス権を持つ）。
- S3、EFS、または feature stores 内に保存された機密データセットへのアクセス。
- VPC 内のネットワーク足場（Studio apps、training jobs、endpoints）。
- コンソール認証を回避する高権限の presigned URLs。

SageMaker の構成を理解することは、ピボット、永続化、またはデータの持ち出しを行う前に重要です。

## コア構成要素

- **Studio Domains & Spaces**: Web IDE (JupyterLab, Code Editor, RStudio)。各ドメインは共有の EFS ファイルシステムとデフォルトの実行ロールを持ちます。
- **Notebook Instances**: スタンドアロンのノートブック用に管理された EC2 インスタンス。実行ロールは別々に設定されます。
- **Training / Processing / Transform Jobs**: ECR からコードを、S3 からデータを取得するエフェメラルなコンテナ。
- **Pipelines & Experiments**: すべてのステップ、入力、出力を記述するオーケストレーションされたワークフロー。
- **Models & Endpoints**: HTTPS エンドポイント経由で推論にデプロイされるパッケージ化されたアーティファクト。
- **Feature Store & Data Wrangler**: データ準備と特徴量管理のためのマネージドサービス。
- **Autopilot & JumpStart**: 自動化された ML とキュレーションされたモデルカタログ。
- **MLflow Tracking Servers**: presigned アクセストークンを使ったマネージドな MLflow UI/API。

すべてのリソースは実行ロール、S3 の位置、コンテナイメージ、および任意の VPC/KMS 構成を参照しているため、列挙時にそれらをすべて取得してください。

## アカウントとグローバルメタデータ
```bash
REGION=us-east-1
# Portfolio status, used when provisioning Studio resources
aws sagemaker get-sagemaker-servicecatalog-portfolio-status --region $REGION

# List execution roles used by models (extend to other resources as needed)
aws sagemaker list-models --region $REGION --query 'Models[].ExecutionRoleArn' --output text | tr '	' '
' | sort -u

# Generic tag sweep across any SageMaker ARN you know
aws sagemaker list-tags --resource-arn <sagemaker-arn> --region $REGION
```
クロスアカウントの信頼関係（execution roles または S3 buckets に external principals が含まれている場合）や、service control policies や SCPs のようなベースライン制限を記録してください。

## Studio ドメイン、アプリ & 共有スペース
```bash
aws sagemaker list-domains --region $REGION
aws sagemaker describe-domain --domain-id <domain-id> --region $REGION
aws sagemaker list-user-profiles --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-user-profile --domain-id <domain-id> --user-profile-name <profile> --region $REGION

# Enumerate apps (JupyterServer, KernelGateway, RStudioServerPro, CodeEditor, Canvas, etc.)
aws sagemaker list-apps --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-app --domain-id <domain-id> --user-profile-name <profile> --app-type JupyterServer --app-name default --region $REGION

# Shared collaborative spaces
aws sagemaker list-spaces --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-space --domain-id <domain-id> --space-name <space> --region $REGION

# Studio lifecycle configurations (shell scripts at start/stop)
aws sagemaker list-studio-lifecycle-configs --region $REGION
aws sagemaker describe-studio-lifecycle-config --studio-lifecycle-config-name <name> --region $REGION
```
記録する項目:

- `DomainArn`, `AppSecurityGroupIds`, `SubnetIds`, `DefaultUserSettings.ExecutionRole`.
- マウントされた EFS (`HomeEfsFileSystemId`) および S3 のホームディレクトリ。
- Lifecycle scripts（しばしば bootstrap credentials を含む、または push/pull による追加コードを含む）。

> [!TIP]
> Presigned Studio URLs は、広く付与されていると認証をバイパスする可能性があります。

## Notebook Instances & Lifecycle Configs
```bash
aws sagemaker list-notebook-instances --region $REGION
aws sagemaker describe-notebook-instance --notebook-instance-name <name> --region $REGION
aws sagemaker list-notebook-instance-lifecycle-configs --region $REGION
aws sagemaker describe-notebook-instance-lifecycle-config --notebook-instance-lifecycle-config-name <cfg> --region $REGION
```
Notebook のメタデータから判明すること:

- 実行ロール (`RoleArn`)、直接インターネットアクセスか VPC-only モードか。
- `DefaultCodeRepository`、`DirectInternetAccess`、`RootAccess` に記載された S3 の場所。
- 資格情報や永続化用のフックを仕込むためのライフサイクルスクリプト。

## トレーニング、プロセッシング、トランスフォーム、およびバッチジョブ
```bash
aws sagemaker list-training-jobs --region $REGION
aws sagemaker describe-training-job --training-job-name <job> --region $REGION

aws sagemaker list-processing-jobs --region $REGION
aws sagemaker describe-processing-job --processing-job-name <job> --region $REGION

aws sagemaker list-transform-jobs --region $REGION
aws sagemaker describe-transform-job --transform-job-name <job> --region $REGION
```
精査する:

- `AlgorithmSpecification.TrainingImage` / `AppSpecification.ImageUri` – どの ECR イメージがデプロイされているかを確認する。
- `InputDataConfig` & `OutputDataConfig` – S3 バケット、プレフィックス、および KMS キー。
- `ResourceConfig.VolumeKmsKeyId`, `VpcConfig`, `EnableNetworkIsolation` – ネットワークや暗号化の構成を判断する。
- `HyperParameters` may leak environment secrets or connection strings.

## パイプライン、実験 & トライアル
```bash
aws sagemaker list-pipelines --region $REGION
aws sagemaker list-pipeline-executions --pipeline-name <pipeline> --region $REGION
aws sagemaker describe-pipeline --pipeline-name <pipeline> --region $REGION

aws sagemaker list-experiments --region $REGION
aws sagemaker list-trials --experiment-name <experiment> --region $REGION
aws sagemaker list-trial-components --trial-name <trial> --region $REGION
```
パイプライン定義は、各ステップ、関連するロール、コンテナイメージ、および環境変数を詳細に記述します。トライアルコンポーネントには、トレーニングアーティファクトのURI、S3ログ、および機密データのフローを示唆するメトリクスが含まれていることが多いです。

## モデル、エンドポイント構成 & デプロイ済みエンドポイント
```bash
aws sagemaker list-models --region $REGION
aws sagemaker describe-model --model-name <name> --region $REGION

aws sagemaker list-endpoint-configs --region $REGION
aws sagemaker describe-endpoint-config --endpoint-config-name <cfg> --region $REGION

aws sagemaker list-endpoints --region $REGION
aws sagemaker describe-endpoint --endpoint-name <endpoint> --region $REGION
```
注力領域:

- モデルアーティファクトのS3 URI (`PrimaryContainer.ModelDataUrl`) と推論用コンテナイメージ。
- エンドポイントのデータキャプチャ設定（S3 bucket、KMS）を確認し、ログのexfil 可能性を調査。
- `S3DataSource` または `ModelPackage` を使用するマルチモデルエンドポイント（クロスアカウントのパッケージ化を確認）。
- エンドポイントに紐づくネットワーク構成とセキュリティグループ。

## Feature Store, Data Wrangler & Clarify
```bash
aws sagemaker list-feature-groups --region $REGION
aws sagemaker describe-feature-group --feature-group-name <feature-group> --region $REGION

aws sagemaker list-data-wrangler-flows --region $REGION
aws sagemaker describe-data-wrangler-flow --flow-name <flow> --region $REGION

aws sagemaker list-model-quality-job-definitions --region $REGION
aws sagemaker list-model-monitoring-schedule --region $REGION
```
セキュリティの要点:

- Online feature stores はデータを Kinesis に複製します。`OnlineStoreConfig.SecurityConfig.KmsKeyId` と VPC を確認してください。
- Data Wrangler のフローには、JDBC/Redshift の認証情報やプライベートエンドポイントが埋め込まれていることが多いです。
- Clarify/Model Monitor ジョブはデータを S3 にエクスポートします。S3 が world-readable だったりクロスアカウントでアクセス可能になっている可能性があります。

## MLflow Tracking Servers, Autopilot & JumpStart
```bash
aws sagemaker list-mlflow-tracking-servers --region $REGION
aws sagemaker describe-mlflow-tracking-server --tracking-server-name <name> --region $REGION

aws sagemaker list-auto-ml-jobs --region $REGION
aws sagemaker describe-auto-ml-job --auto-ml-job-name <name> --region $REGION

aws sagemaker list-jumpstart-models --region $REGION
aws sagemaker list-jumpstart-script-resources --region $REGION
```
- MLflow tracking servers は実験とアーティファクトを保存します。presigned URLs によりすべてが露出する可能性があります。
- Autopilot ジョブは複数の training jobs を起動します — 隠れたデータのために出力を列挙してください。
- JumpStart の reference architectures はアカウント内に特権ロールをデプロイする場合があります。

## IAM とネットワーキングの考慮事項

- Studio、notebooks、training jobs、pipelines、endpoints を含むすべての実行ロールにアタッチされた IAM ポリシーを列挙してください。
- ネットワークの文脈（subnets、security groups、VPC endpoints）を確認してください。多くの組織は training jobs を分離しますが、アウトバウンド通信の制限を忘れがちです。
- 外部アクセスについて、`ModelDataUrl`、`DataCaptureConfig`、`InputDataConfig` で参照される S3 バケットポリシーを確認してください。

## Privilege Escalation

{{#ref}}
../../aws-privilege-escalation/aws-sagemaker-privesc/README.md
{{#endref}}

## Persistence

{{#ref}}
../../aws-persistence/aws-sagemaker-persistence/README.md
{{#endref}}

## Post-Exploitation

{{#ref}}
../../aws-post-exploitation/aws-sagemaker-post-exploitation/README.md
{{#endref}}

## Unauthorized Access

{{#ref}}
../aws-sagemaker-unauthenticated-enum/README.md
{{#endref}}

## 参考資料

- [AWS SageMaker Documentation](https://docs.aws.amazon.com/sagemaker/latest/dg/whatis.html)
- [AWS CLI SageMaker Reference](https://docs.aws.amazon.com/cli/latest/reference/sagemaker/index.html)
- [SageMaker Studio Architecture](https://docs.aws.amazon.com/sagemaker/latest/dg/gs-studio.html)
- [SageMaker Security Best Practices](https://docs.aws.amazon.com/sagemaker/latest/dg/security.html)

{{#include ../../../../banners/hacktricks-training.md}}
