# AWS - SageMaker Enum

{{#include ../../../../banners/hacktricks-training.md}}

## Service Overview

Amazon SageMaker est la plateforme ML gérée d'AWS qui relie notebooks, infrastructure de training, orchestration, registries et endpoints gérés. Une compromission des ressources SageMaker fournit typiquement :

- Rôles d'exécution IAM longuement valides avec de larges accès à S3, ECR, Secrets Manager ou KMS.
- Accès à des jeux de données sensibles stockés dans S3, EFS ou dans des feature stores.
- Points d'appui réseau à l'intérieur de VPCs (Studio apps, training jobs, endpoints).
- URLs présignées à haute privilège qui contournent l'authentification console.

Comprendre comment SageMaker est assemblé est essentiel avant de pivoter, persister ou exfiltrer des données.

## Core Building Blocks

- **Studio Domains & Spaces**: IDE web (JupyterLab, Code Editor, RStudio). Chaque domain a un système de fichiers EFS partagé et un rôle d'exécution par défaut.
- **Notebook Instances**: Instances EC2 gérées pour notebooks autonomes ; utilisent des rôles d'exécution séparés.
- **Training / Processing / Transform Jobs**: Conteneurs éphémères qui tirent du code depuis ECR et des données depuis S3.
- **Pipelines & Experiments**: Workflows orchestrés qui décrivent toutes les étapes, entrées et sorties.
- **Models & Endpoints**: Artefacts empaquetés déployés pour l'inférence via des endpoints HTTPS.
- **Feature Store & Data Wrangler**: Services gérés pour la préparation des données et la gestion des features.
- **Autopilot & JumpStart**: ML automatisé et catalogue de modèles sélectionnés.
- **MLflow Tracking Servers**: UI/API MLflow gérées avec tokens d'accès présignés.

Chaque ressource référence un rôle d'exécution, des emplacements S3, des images de conteneur, et une configuration VPC/KMS optionnelle — capturez-les tous durant l'énumération.

## Account & Global Metadata
```bash
REGION=us-east-1
# Portfolio status, used when provisioning Studio resources
aws sagemaker get-sagemaker-servicecatalog-portfolio-status --region $REGION

# List execution roles used by models (extend to other resources as needed)
aws sagemaker list-models --region $REGION --query 'Models[].ExecutionRoleArn' --output text | tr '	' '
' | sort -u

# Generic tag sweep across any SageMaker ARN you know
aws sagemaker list-tags --resource-arn <sagemaker-arn> --region $REGION
```
Notez toute relation de confiance inter-comptes (rôles d'exécution ou S3 buckets avec des principals externes) et les restrictions de base telles que les service control policies (SCPs).

## Studio Domains, Apps & Shared Spaces
```bash
aws sagemaker list-domains --region $REGION
aws sagemaker describe-domain --domain-id <domain-id> --region $REGION
aws sagemaker list-user-profiles --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-user-profile --domain-id <domain-id> --user-profile-name <profile> --region $REGION

# Enumerate apps (JupyterServer, KernelGateway, RStudioServerPro, CodeEditor, Canvas, etc.)
aws sagemaker list-apps --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-app --domain-id <domain-id> --user-profile-name <profile> --app-type JupyterServer --app-name default --region $REGION

# Shared collaborative spaces
aws sagemaker list-spaces --domain-id-equals <domain-id> --region $REGION
aws sagemaker describe-space --domain-id <domain-id> --space-name <space> --region $REGION

# Studio lifecycle configurations (shell scripts at start/stop)
aws sagemaker list-studio-lifecycle-configs --region $REGION
aws sagemaker describe-studio-lifecycle-config --studio-lifecycle-config-name <name> --region $REGION
```
À enregistrer :

- `DomainArn`, `AppSecurityGroupIds`, `SubnetIds`, `DefaultUserSettings.ExecutionRole`.
- EFS monté (`HomeEfsFileSystemId`) et répertoires home S3.
- Lifecycle scripts (contiennent souvent des identifiants bootstrap ou du code additionnel push/pull).

> [!TIP]
> Presigned Studio URLs peuvent contourner l'authentification si elles sont accordées de manière trop large.

## Notebook Instances & Lifecycle Configs
```bash
aws sagemaker list-notebook-instances --region $REGION
aws sagemaker describe-notebook-instance --notebook-instance-name <name> --region $REGION
aws sagemaker list-notebook-instance-lifecycle-configs --region $REGION
aws sagemaker describe-notebook-instance-lifecycle-config --notebook-instance-lifecycle-config-name <cfg> --region $REGION
```
Les métadonnées du notebook révèlent :

- Le rôle d'exécution (`RoleArn`), accès direct à Internet vs. en mode VPC uniquement.
- Emplacements S3 dans `DefaultCodeRepository`, `DirectInternetAccess`, `RootAccess`.
- Scripts de lifecycle susceptibles de contenir des credentials ou des hooks de persistance.

## Jobs de Training, Processing, Transform et Batch
```bash
aws sagemaker list-training-jobs --region $REGION
aws sagemaker describe-training-job --training-job-name <job> --region $REGION

aws sagemaker list-processing-jobs --region $REGION
aws sagemaker describe-processing-job --processing-job-name <job> --region $REGION

aws sagemaker list-transform-jobs --region $REGION
aws sagemaker describe-transform-job --transform-job-name <job> --region $REGION
```
Examinez :

- `AlgorithmSpecification.TrainingImage` / `AppSpecification.ImageUri` – quelles images ECR sont déployées.
- `InputDataConfig` & `OutputDataConfig` – les buckets S3, les préfixes et les clés KMS.
- `ResourceConfig.VolumeKmsKeyId`, `VpcConfig`, `EnableNetworkIsolation` – déterminer la posture réseau ou de chiffrement.
- `HyperParameters` peuvent leak des secrets d'environnement ou des chaînes de connexion.

## Pipelines, Expériences et Essais
```bash
aws sagemaker list-pipelines --region $REGION
aws sagemaker list-pipeline-executions --pipeline-name <pipeline> --region $REGION
aws sagemaker describe-pipeline --pipeline-name <pipeline> --region $REGION

aws sagemaker list-experiments --region $REGION
aws sagemaker list-trials --experiment-name <experiment> --region $REGION
aws sagemaker list-trial-components --trial-name <trial> --region $REGION
```
Les définitions de pipeline décrivent chaque étape, les rôles associés, les images de conteneur et les variables d'environnement. Les Trial components contiennent souvent des URI d'artefacts d'entraînement, des logs S3 et des métriques qui laissent entrevoir le flux de données sensibles.

## Modèles, configurations d'endpoint & endpoints déployés
```bash
aws sagemaker list-models --region $REGION
aws sagemaker describe-model --model-name <name> --region $REGION

aws sagemaker list-endpoint-configs --region $REGION
aws sagemaker describe-endpoint-config --endpoint-config-name <cfg> --region $REGION

aws sagemaker list-endpoints --region $REGION
aws sagemaker describe-endpoint --endpoint-name <endpoint> --region $REGION
```
- URIs S3 des artefacts de modèle (`PrimaryContainer.ModelDataUrl`) et images de conteneurs d'inférence.
- Configuration de la capture de données des endpoints (S3 bucket, KMS) pour une possible log exfil.
- Endpoints multi-modèles utilisant `S3DataSource` ou `ModelPackage` (vérifier le cross-account packaging).
- Configurations réseau et security groups attachés aux endpoints.

## Feature Store, Data Wrangler & Clarify
```bash
aws sagemaker list-feature-groups --region $REGION
aws sagemaker describe-feature-group --feature-group-name <feature-group> --region $REGION

aws sagemaker list-data-wrangler-flows --region $REGION
aws sagemaker describe-data-wrangler-flow --flow-name <flow> --region $REGION

aws sagemaker list-model-quality-job-definitions --region $REGION
aws sagemaker list-model-monitoring-schedule --region $REGION
```
Points de sécurité à retenir :

- Les feature stores en ligne répliquent des données vers Kinesis ; vérifiez `OnlineStoreConfig.SecurityConfig.KmsKeyId` et la VPC.
- Les flows Data Wrangler contiennent souvent des identifiants JDBC/Redshift ou des endpoints privés intégrés.
- Les jobs Clarify/Model Monitor exportent des données vers S3 qui peuvent être publiquement lisibles ou accessibles depuis d'autres comptes.

## MLflow Tracking Servers, Autopilot & JumpStart
```bash
aws sagemaker list-mlflow-tracking-servers --region $REGION
aws sagemaker describe-mlflow-tracking-server --tracking-server-name <name> --region $REGION

aws sagemaker list-auto-ml-jobs --region $REGION
aws sagemaker describe-auto-ml-job --auto-ml-job-name <name> --region $REGION

aws sagemaker list-jumpstart-models --region $REGION
aws sagemaker list-jumpstart-script-resources --region $REGION
```
- Les serveurs de tracking MLflow stockent les expériences et artefacts ; les URLs présignées peuvent tout exposer.
- Les jobs Autopilot lancent plusieurs training jobs — énumérez les outputs à la recherche de données cachées.
- Les architectures de référence JumpStart peuvent déployer des rôles privilégiés dans le compte.

## Considérations IAM & réseau

- Enumérez les IAM policies attachées à tous les rôles d'exécution (Studio, notebooks, training jobs, pipelines, endpoints).
- Vérifiez les contextes réseau : subnets, security groups, VPC endpoints. De nombreuses organisations isolent les training jobs mais oublient de restreindre le trafic sortant.
- Examinez les politiques des buckets S3 référencées dans `ModelDataUrl`, `DataCaptureConfig`, `InputDataConfig` pour détecter un accès externe.

## Privilege Escalation

{{#ref}}
../../aws-privilege-escalation/aws-sagemaker-privesc/README.md
{{#endref}}

## Persistence

{{#ref}}
../../aws-persistence/aws-sagemaker-persistence/README.md
{{#endref}}

## Post-Exploitation

{{#ref}}
../../aws-post-exploitation/aws-sagemaker-post-exploitation/README.md
{{#endref}}

## Unauthorized Access

{{#ref}}
../aws-sagemaker-unauthorized-access/README.md
{{#endref}}

## References

- [AWS SageMaker Documentation](https://docs.aws.amazon.com/sagemaker/latest/dg/whatis.html)
- [AWS CLI SageMaker Reference](https://docs.aws.amazon.com/cli/latest/reference/sagemaker/index.html)
- [SageMaker Studio Architecture](https://docs.aws.amazon.com/sagemaker/latest/dg/gs-studio.html)
- [SageMaker Security Best Practices](https://docs.aws.amazon.com/sagemaker/latest/dg/security.html)

{{#include ../../../../banners/hacktricks-training.md}}
