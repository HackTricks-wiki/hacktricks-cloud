# AWS - Directory Services / WorkDocs Enum

{{#include ../../../banners/hacktricks-training.md}}

## Directory Services

AWS Directory Service for Microsoft Active Directory ni huduma inayosimamiwa ambayo inafanya iwe rahisi **kuanzisha, kuendesha, na kupanua directory** katika AWS Cloud. Imejengwa juu ya **Microsoft Active Directory** halisi na inajumuisha kwa karibu na huduma nyingine za AWS, ikifanya iwe rahisi kusimamia kazi zako zinazojua directory na rasilimali za AWS. Pamoja na AWS Managed Microsoft AD, unaweza **kutumia** watumiaji, vikundi, na sera zako za Active Directory zilizopo kusimamia ufikiaji wa rasilimali zako za AWS. Hii inaweza kusaidia kurahisisha usimamizi wa utambulisho wako na kupunguza hitaji la suluhisho za utambulisho za ziada. AWS Managed Microsoft AD pia inatoa nakala za otomatiki na uwezo wa urejeleaji wa majanga, kusaidia kuhakikisha upatikanaji na kudumu kwa directory yako. Kwa ujumla, AWS Directory Service for Microsoft Active Directory inaweza kusaidia kuokoa muda na rasilimali kwa kutoa huduma ya Active Directory inayosimamiwa, inayopatikana kwa urahisi, na inayoweza kupanuka katika AWS Cloud.

### Options

Directory Services inaruhusu kuunda aina 5 za directories:

- **AWS Managed Microsoft AD**: Ambayo itakimbia **Microsoft AD mpya katika AWS**. Utaweza kuweka nenosiri la admin na kufikia DCs katika VPC.
- **Simple AD**: Ambayo itakuwa **Linux-Samba** seva inayofanana na Active Directory. Utaweza kuweka nenosiri la admin na kufikia DCs katika VPC.
- **AD Connector**: Proxy kwa **kupeleka maombi ya directory kwa Microsoft Active Directory yako iliyopo** bila kuhifadhi taarifa yoyote katika wingu. Itakuwa inasikiliza katika **VPC** na unahitaji kutoa **vithibitisho vya kufikia AD iliyopo**.
- **Amazon Cognito User Pools**: Hii ni sawa na Cognito User Pools.
- **Cloud Directory**: Hii ndiyo **rahisi zaidi**. Directory **isiyo na seva** ambapo unaonyesha **schema** ya kutumia na unatozwa **kulingana na matumizi**.

AWS Directory services inaruhusu **kusawazisha** na **Microsoft AD** yako iliyopo **kwenye tovuti**, **kukimbia yako mwenyewe** katika AWS au kusawazisha na **aina nyingine za directory**.

### Lab

Hapa unaweza kupata mafunzo mazuri ya kuunda Microsoft AD yako mwenyewe katika AWS: [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms_ad_tutorial_test_lab_base.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms_ad_tutorial_test_lab_base.html)

### Enumeration
```bash
# Get directories and DCs
aws ds describe-directories
aws ds describe-domain-controllers --directory-id <id>
# Get directory settings
aws ds describe-trusts
aws ds describe-ldaps-settings --directory-id <id>
aws ds describe-shared-directories --owner-directory-id <id>
aws ds get-directory-limits
aws ds list-certificates --directory-id <id>
aws ds describe-certificate --directory-id <id> --certificate-id <id>
```
### Login

Kumbuka kwamba ikiwa **maelezo** ya directory yana **domain** katika uwanja wa **`AccessUrl`** ni kwa sababu **mtumiaji** anaweza labda **kuingia** kwa kutumia **akidi za AD** katika baadhi ya **huduma za AWS:**

- `<name>.awsapps.com/connect` (Amazon Connect)
- `<name>.awsapps.com/workdocs` (Amazon WorkDocs)
- `<name>.awsapps.com/workmail` (Amazon WorkMail)
- `<name>.awsapps.com/console` (Amazon Management Console)
- `<name>.awsapps.com/start` (IAM Identity Center)

### Privilege Escalation

{{#ref}}
../aws-privilege-escalation/aws-directory-services-privesc.md
{{#endref}}

## Persistence

### Using an AD user

Mtumiaji wa **AD** anaweza kupewa **ufikiaji juu ya AWS management console** kupitia Rol ambayo itachukuliwa. **Jina la mtumiaji wa default ni Admin** na inawezekana **kubadilisha nenosiri lake** kutoka kwa AWS console.

Hivyo, inawezekana **kubadilisha nenosiri la Admin**, **kuunda mtumiaji mpya** au **kubadilisha nenosiri** la mtumiaji na kumpa mtumiaji huyo Rol ili kudumisha ufikiaji.\
Pia inawezekana **kuongeza mtumiaji katika kundi ndani ya AD** na **kumpa kundi hilo la AD ufikiaji kwa Rol** (ili kufanya kudumu huku kuwa na siri zaidi).

### Sharing AD (from victim to attacker)

Inawezekana kushiriki mazingira ya AD kutoka kwa mwathirika hadi kwa mshambuliaji. Kwa njia hii mshambuliaji ataweza kuendelea kupata ufikiaji wa mazingira ya AD.\
Hata hivyo, hii inamaanisha kushiriki AD inayosimamiwa na pia kuunda muunganisho wa VPC peering.

Unaweza kupata mwongozo hapa: [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1_setup_networking.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1_setup_networking.html)

### ~~Sharing AD (from attacker to victim)~~

Haionekani kuwa inawezekana kutoa ufikiaji wa AWS kwa watumiaji kutoka mazingira tofauti ya AD hadi akaunti moja ya AWS.

## WorkDocs

Amazon Web Services (AWS) WorkDocs ni huduma ya **hifadhi na ushirikiano wa faili** inayotegemea wingu. Ni sehemu ya suite ya huduma za kompyuta za wingu za AWS na imeundwa kutoa suluhisho salama na linaloweza kupanuka kwa mashirika kuhifadhi, kushiriki, na kushirikiana kwenye faili na hati.

AWS WorkDocs inatoa kiolesura kinachotegemea wavuti kwa watumiaji kupakia, kufikia, na kusimamia faili na hati zao. Pia inatoa vipengele kama udhibiti wa toleo, ushirikiano wa wakati halisi, na uunganisho na huduma nyingine za AWS na zana za wahusika wa tatu.

### Enumeration
```bash
# Get AD users (Admin not included)
aws workdocs describe-users --organization-id <directory-id>
# Get AD groups (containing "a")
aws workdocs describe-groups --organization-id d-9067a0285c --search-query a

# Create user (created inside the AD)
aws workdocs create-user --username testingasd --given-name testingasd --surname testingasd --password <password> --email-address name@directory.domain --organization-id <directory-id>

# Get what each user has created
aws workdocs describe-activities --user-id "S-1-5-21-377..."

# Get what was created in the directory
aws workdocs describe-activities --organization-id <directory-id>

# Get folder content
aws workdocs describe-folder-contents --folder-id <fold-id>

# Get file (a url to access with the content will be retreived)
aws workdocs get-document --document-id <doc-id>

# Get resource permissions if any
aws workdocs describe-resource-permissions --resource-id <value>

# Add permission so anyway can see the file
aws workdocs add-resource-permissions --resource-id <id> --principals Id=anonymous,Type=ANONYMOUS,Role=VIEWER
## This will give an id, the file will be acesible in: https://<name>.awsapps.com/workdocs/index.html#/share/document/<id>
```
### Privesc

{{#ref}}
../aws-privilege-escalation/aws-workdocs-privesc.md
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
