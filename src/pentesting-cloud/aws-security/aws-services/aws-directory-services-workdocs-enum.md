# AWS - Directory Services / WorkDocs Enum

{{#include ../../../banners/hacktricks-training.md}}

## Directory Services

AWS Directory Service for Microsoft Active Directory, AWS Cloud'da bir dizin **kurmayı, işletmeyi ve ölçeklendirmeyi** kolaylaştıran yönetilen bir hizmettir. Gerçek **Microsoft Active Directory** üzerine inşa edilmiştir ve diğer AWS hizmetleriyle sıkı bir şekilde entegre edilmiştir, bu da dizin bilincine sahip iş yüklerinizi ve AWS kaynaklarınızı yönetmeyi kolaylaştırır. AWS Managed Microsoft AD ile mevcut Active Directory kullanıcılarınızı, gruplarınızı ve politikalarınızı kullanarak AWS kaynaklarınıza erişimi yönetebilirsiniz. Bu, kimlik yönetiminizi basitleştirmeye ve ek kimlik çözümlerine olan ihtiyacı azaltmaya yardımcı olabilir. AWS Managed Microsoft AD ayrıca otomatik yedeklemeler ve felaket kurtarma yetenekleri sunarak dizininizin kullanılabilirliğini ve dayanıklılığını sağlamaya yardımcı olur. Genel olarak, AWS Directory Service for Microsoft Active Directory, AWS Cloud'da yönetilen, yüksek kullanılabilirlikte ve ölçeklenebilir bir Active Directory hizmeti sunarak zaman ve kaynak tasarrufu yapmanıza yardımcı olabilir.

### Options

Directory Services, 5 tür dizin oluşturmanıza olanak tanır:

- **AWS Managed Microsoft AD**: AWS'de yeni bir **Microsoft AD** çalıştıracaktır. Yönetici parolasını ayarlayabilecek ve bir VPC'deki DC'lere erişebileceksiniz.
- **Simple AD**: **Linux-Samba** Active Directory uyumlu bir sunucu olacaktır. Yönetici parolasını ayarlayabilecek ve bir VPC'deki DC'lere erişebileceksiniz.
- **AD Connector**: **mevcut Microsoft Active Directory'nize dizin isteklerini yönlendiren** bir proxy. Bulutta herhangi bir bilgi önbelleğe almadan çalışacaktır. Bir **VPC**'de dinleyecek ve **mevcut AD'ye erişim için kimlik bilgileri** vermeniz gerekecek.
- **Amazon Cognito User Pools**: Bu, Cognito User Pools ile aynıdır.
- **Cloud Directory**: Bu, **en basit** olanıdır. Kullanacağınız **şemayı** belirttiğiniz ve **kullanıma göre faturalandırıldığınız** bir **sunucusuz** dizin.

AWS Directory services, mevcut **yerel** Microsoft AD'nizle **senkronize** olmanıza, AWS'de **kendi dizininizi** çalıştırmanıza veya **diğer dizin türleriyle** senkronize olmanıza olanak tanır.

### Lab

AWS'de kendi Microsoft AD'nizi oluşturmak için güzel bir öğretici bulabilirsiniz: [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms_ad_tutorial_test_lab_base.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms_ad_tutorial_test_lab_base.html)

### Enumeration
```bash
# Get directories and DCs
aws ds describe-directories
aws ds describe-domain-controllers --directory-id <id>
# Get directory settings
aws ds describe-trusts
aws ds describe-ldaps-settings --directory-id <id>
aws ds describe-shared-directories --owner-directory-id <id>
aws ds get-directory-limits
aws ds list-certificates --directory-id <id>
aws ds describe-certificate --directory-id <id> --certificate-id <id>
```
### Giriş

Dizin **`AccessUrl`** alanında bir **alan** içeriyorsa, bu, bir **kullanıcının** muhtemelen bazı **AWS hizmetlerinde** **AD kimlik bilgileri** ile **giriş yapabileceği** anlamına gelir:

- `<name>.awsapps.com/connect` (Amazon Connect)
- `<name>.awsapps.com/workdocs` (Amazon WorkDocs)
- `<name>.awsapps.com/workmail` (Amazon WorkMail)
- `<name>.awsapps.com/console` (Amazon Yönetim Konsolu)
- `<name>.awsapps.com/start` (IAM Kimlik Merkezi)

### Yetki Yükseltme

{{#ref}}
../aws-privilege-escalation/aws-directory-services-privesc.md
{{#endref}}

## Süreklilik

### Bir AD kullanıcısı kullanarak

Bir **AD kullanıcısına**, üstlenmesi gereken bir Rol aracılığıyla **AWS yönetim konsoluna erişim** verilebilir. **Varsayılan kullanıcı adı Admin**'dir ve şifresinin **AWS konsolundan değiştirilmesi** mümkündür.

Bu nedenle, **Admin'in şifresini değiştirmek**, **yeni bir kullanıcı oluşturmak** veya bir kullanıcının **şifresini değiştirmek** ve o kullanıcıya erişimi sürdürmek için bir Rol vermek mümkündür.\
Ayrıca, **AD içinde bir gruba kullanıcı eklemek** ve **o AD grubuna bir Role erişim vermek** de mümkündür (bu sürekliliği daha gizli hale getirmek için).

### AD'yi paylaşma (kurbanın saldırgana)

Bir AD ortamını bir kurbandan bir saldırgana paylaşmak mümkündür. Bu şekilde saldırgan, AD ortamına erişmeye devam edebilecektir.\
Ancak, bu, yönetilen AD'yi paylaşmayı ve ayrıca bir VPC peering bağlantısı oluşturmayı gerektirir.

Burada bir kılavuz bulabilirsiniz: [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1_setup_networking.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1_setup_networking.html)

### ~~AD'yi paylaşma (saldırgandan kurbana)~~

Farklı bir AD ortamındaki kullanıcılara bir AWS hesabına AWS erişimi vermenin mümkün olmadığı görünmektedir.

## WorkDocs

Amazon Web Services (AWS) WorkDocs, bulut tabanlı bir **dosya depolama ve paylaşım hizmetidir**. AWS'nin bulut bilişim hizmetleri paketinin bir parçasıdır ve organizasyonların dosyaları ve belgeleri depolamak, paylaşmak ve üzerinde işbirliği yapmak için güvenli ve ölçeklenebilir bir çözüm sunmak üzere tasarlanmıştır.

AWS WorkDocs, kullanıcıların dosyalarını ve belgelerini yüklemeleri, erişmeleri ve yönetmeleri için web tabanlı bir arayüz sağlar. Ayrıca sürüm kontrolü, gerçek zamanlı işbirliği ve diğer AWS hizmetleri ve üçüncü taraf araçlarla entegrasyon gibi özellikler sunar.

### Sayım
```bash
# Get AD users (Admin not included)
aws workdocs describe-users --organization-id <directory-id>
# Get AD groups (containing "a")
aws workdocs describe-groups --organization-id d-9067a0285c --search-query a

# Create user (created inside the AD)
aws workdocs create-user --username testingasd --given-name testingasd --surname testingasd --password <password> --email-address name@directory.domain --organization-id <directory-id>

# Get what each user has created
aws workdocs describe-activities --user-id "S-1-5-21-377..."

# Get what was created in the directory
aws workdocs describe-activities --organization-id <directory-id>

# Get folder content
aws workdocs describe-folder-contents --folder-id <fold-id>

# Get file (a url to access with the content will be retreived)
aws workdocs get-document --document-id <doc-id>

# Get resource permissions if any
aws workdocs describe-resource-permissions --resource-id <value>

# Add permission so anyway can see the file
aws workdocs add-resource-permissions --resource-id <id> --principals Id=anonymous,Type=ANONYMOUS,Role=VIEWER
## This will give an id, the file will be acesible in: https://<name>.awsapps.com/workdocs/index.html#/share/document/<id>
```
### Privesc

{{#ref}}
../aws-privilege-escalation/aws-workdocs-privesc.md
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
