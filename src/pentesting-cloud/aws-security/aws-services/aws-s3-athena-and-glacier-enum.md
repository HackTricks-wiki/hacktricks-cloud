# AWS - S3, Athena & Glacier Enum

{{#include ../../../banners/hacktricks-training.md}}

## S3

Amazon S3 είναι μια υπηρεσία που σας επιτρέπει να **αποθηκεύετε μεγάλα ποσά δεδομένων**.

Amazon S3 παρέχει πολλαπλές επιλογές για να επιτύχετε την **προστασία** των δεδομένων σε REST. Οι επιλογές περιλαμβάνουν **Permission** (Policy), **Encryption** (Client and Server Side), **Bucket Versioning** και **MFA** **based delete**. Ο **χρήστης μπορεί να ενεργοποιήσει** οποιαδήποτε από αυτές τις επιλογές για να επιτύχει την προστασία των δεδομένων. Η **Data replication** είναι μια εσωτερική λειτουργία από την AWS όπου **S3 αντιγράφει αυτόματα κάθε αντικείμενο σε όλες τις Availability Zones** και ο οργανισμός δεν χρειάζεται να την ενεργοποιήσει σε αυτή την περίπτωση.

With resource-based permissions, you can define permissions for sub-directories of your bucket separately.

### Bucket Versioning and MFA based delete

When bucket versioning is enabled, any action that tries to alter a file inside a file will generate a new version of the file, keeping also the previous content of the same. Therefore, it won't overwrite its content.

Moreover, MFA based delete will prevent versions of file in the S3 bucket from being deleted and also Bucket Versioning from being disabled, so an attacker won't be able to alter these files.

### S3 Access logs

It's possible to **enable S3 access login** (which by default is disabled) to some bucket and save the logs in a different bucket to know who is accessing the bucket (both buckets must be in the same region).

### S3 Presigned URLs

It's possible to generate a presigned URL that can usually be used to **access the specified file** in the bucket. A **presigned URL looks like this**:
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
Ένα presigned URL μπορεί να **δημιουργηθεί από το cli χρησιμοποιώντας credentials ενός principal με πρόσβαση στο αντικείμενο** (εάν ο λογαριασμός που χρησιμοποιείτε δεν έχει πρόσβαση, θα δημιουργηθεί ένα πιο σύντομο presigned URL αλλά θα είναι άχρηστο)
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
> [!NOTE]
> Η μόνη απαιτούμενη άδεια για τη δημιουργία ενός presigned URL είναι η άδεια που δίνεται, οπότε στην προηγούμενη εντολή η μόνη άδεια που χρειάζεται ο principal είναι `s3:GetObject`

Είναι επίσης δυνατό να δημιουργηθούν presigned URLs με **άλλες άδειες**:
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### Μηχανισμοί κρυπτογράφησης S3

**DEK σημαίνει Κλειδί Κρυπτογράφησης Δεδομένων (Data Encryption Key)** και είναι το κλειδί που πάντα δημιουργείται και χρησιμοποιείται για την κρυπτογράφηση δεδομένων.

<details>

<summary><strong>Server-side κρυπτογράφηση με διαχειριζόμενα κλειδιά S3, SSE-S3</strong></summary>

Αυτή η επιλογή απαιτεί ελάχιστη ρύθμιση και όλη η διαχείριση των κλειδιών κρυπτογράφησης γίνεται από την AWS. Το μόνο που χρειάζεται να κάνετε είναι να **ανεβάσετε τα δεδομένα σας και το S3 θα χειριστεί όλα τα υπόλοιπα**. Σε κάθε bucket σε έναν λογαριασμό S3 ανατίθεται ένα bucket key.

- Κρυπτογράφηση:
- Object Data + δημιουργημένο plaintext DEK --> Κρυπτογραφημένα δεδομένα (αποθηκεύονται μέσα στο S3)
- Created plaintext DEK + S3 Master Key --> Encrypted DEK (αποθηκεύεται μέσα στο S3) και το plain text διαγράφεται από τη μνήμη
- Αποκρυπτογράφηση:
- Encrypted DEK + S3 Master Key --> Plaintext DEK
- Plaintext DEK + Encrypted data --> Object Data

Παρακαλώ σημειώστε ότι σε αυτή την περίπτωση **το κλειδί διαχειρίζεται από την AWS** (rotation μόνο κάθε 3 χρόνια). Εάν χρησιμοποιήσετε το δικό σας κλειδί θα μπορείτε να το περιστρέψετε, να το απενεργοποιήσετε και να εφαρμόσετε έλεγχο πρόσβασης.

</details>

<details>

<summary><strong>Server-side κρυπτογράφηση με KMS διαχειριζόμενα κλειδιά, SSE-KMS</strong></summary>

Αυτή η μέθοδος επιτρέπει στο S3 να χρησιμοποιήσει το Key Management Service για να δημιουργήσει τα data encryption keys σας. Το KMS σας δίνει πολύ μεγαλύτερη ευελιξία στον τρόπο διαχείρισης των κλειδιών σας. Για παράδειγμα, μπορείτε να απενεργοποιήσετε, να περιστρέψετε και να εφαρμόσετε ελέγχους πρόσβασης στο CMK, καθώς και να καταγράψετε/ελέγξετε τη χρήση τους μέσω AWS CloudTrail.

- Κρυπτογράφηση:
- Το S3 ζητά data keys από το KMS CMK
- Το KMS χρησιμοποιεί ένα CMK για να δημιουργήσει το ζευγάρι plaintext DEK και DEK encrypted και τα στέλνει στο S3
- Το S3 χρησιμοποιεί το plaintext key για να κρυπτογραφήσει τα δεδομένα, αποθηκεύει τα κρυπτογραφημένα δεδομένα και το κρυπτογραφημένο κλειδί και διαγράφει από τη μνήμη το plain text key
- Αποκρυπτογράφηση:
- Το S3 ζητά από το KMS να αποκρυπτογραφήσει το encrypted data key του αντικειμένου
- Το KMS αποκρυπτογραφεί το data key με το CMK και το επιστρέφει στο S3
- Το S3 αποκρυπτογραφεί τα δεδομένα του αντικειμένου

</details>

<details>

<summary><strong>Server-side κρυπτογράφηση με πελάτη-παρεχόμενα κλειδιά, SSE-C</strong></summary>

Αυτή η επιλογή σας δίνει τη δυνατότητα να παρέχετε το δικό σας master key που μπορεί ήδη να χρησιμοποιείτε εκτός AWS. Το customer-provided key σας θα αποστέλλεται μαζί με τα δεδομένα σας στο S3, όπου το S3 θα εκτελεί την κρυπτογράφηση για εσάς.

- Κρυπτογράφηση:
- Ο χρήστης στέλνει τα object data + Customer key στο S3
- Το customer key χρησιμοποιείται για να κρυπτογραφήσει τα δεδομένα και τα κρυπτογραφημένα δεδομένα αποθηκεύονται
- Μια salted HMAC τιμή του customer key αποθηκεύεται επίσης για μελλοντική επικύρωση κλειδιού
- Το customer key διαγράφεται από τη μνήμη
- Αποκρυπτογράφηση:
- Ο χρήστης στέλνει το customer key
- Το κλειδί επικυρώνεται έναντι της αποθηκευμένης HMAC τιμής
- Το customer provided key χρησιμοποιείται στη συνέχεια για την αποκρυπτογράφηση των δεδομένων

</details>

<details>

<summary><strong>Client-side κρυπτογράφηση με KMS, CSE-KMS</strong></summary>

Παρομοίως με το SSE-KMS, αυτή η μέθοδος χρησιμοποιεί επίσης το Key Management Service για να δημιουργήσει τα data encryption keys σας. Ωστόσο, αυτή τη φορά το KMS καλείται μέσω του client και όχι του S3. Η κρυπτογράφηση πραγματοποιείται client-side και τα κρυπτογραφημένα δεδομένα αποστέλλονται στο S3 για αποθήκευση.

- Κρυπτογράφηση:
- Ο client αιτείται data key από το KMS
- Το KMS επιστρέφει το plaintext DEK και το encrypted DEK με το CMK
- Και τα δύο κλειδιά επιστρέφονται
- Ο client κρυπτογραφεί τα δεδομένα με το plaintext DEK και στέλνει στο S3 τα encrypted data + το encrypted DEK (το οποίο αποθηκεύεται ως metadata των κρυπτογραφημένων δεδομένων στο S3)
- Αποκρυπτογράφηση:
- Τα encrypted data με το encrypted DEK αποστέλλονται στον client
- Ο client ζητά από το KMS να αποκρυπτογραφήσει το encrypted key χρησιμοποιώντας το CMK και το KMS επιστρέφει το plaintext DEK
- Ο client μπορεί τώρα να αποκρυπτογραφήσει τα κρυπτογραφημένα δεδομένα

</details>

<details>

<summary><strong>Client-side κρυπτογράφηση με πελάτη-παρεχόμενα κλειδιά, CSE-C</strong></summary>

Χρησιμοποιώντας αυτόν τον μηχανισμό, μπορείτε να χρησιμοποιήσετε τα δικά σας παρεχόμενα κλειδιά και έναν AWS-SDK client για να κρυπτογραφήσετε τα δεδομένα σας πριν τα στείλετε στο S3 για αποθήκευση.

- Κρυπτογράφηση:
- Ο client δημιουργεί ένα DEK και κρυπτογραφεί τα plaintext δεδομένα
- Έπειτα, χρησιμοποιώντας το δικό του custom CMK, κρυπτογραφεί το DEK
- Υποβάλλει τα encrypted data + encrypted DEK στο S3 όπου αποθηκεύονται
- Αποκρυπτογράφηση:
- Το S3 στέλνει τα encrypted data και το DEK
- Εφόσον ο client ήδη έχει το CMK που χρησιμοποιήθηκε για την κρυπτογράφηση του DEK, το αποκρυπτογραφεί και στη συνέχεια χρησιμοποιεί το plaintext DEK για να αποκρυπτογραφήσει τα δεδομένα

</details>

### **Enumeration**

Ένας από τους παραδοσιακούς κύριους τρόπους παραβίασης οργανισμών AWS ξεκινά με τον συμβιβασμό δημόσια προσβάσιμων buckets. **Μπορείτε να βρείτε** [**public buckets enumerators in this page**](../aws-unauthenticated-enum-access/index.html#s3-buckets)**.**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name –-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

Μπορείτε να αποκτήσετε πρόσβαση σε ένα S3 bucket μέσω ενός dual-stack endpoint χρησιμοποιώντας ένα virtual hosted-style ή ένα path-style endpoint name. Αυτά είναι χρήσιμα για πρόσβαση στο S3 μέσω IPv6.

Dual-stack endpoints χρησιμοποιούν την εξής σύνταξη:

- `bucketname.s3.dualstack.aws-region.amazonaws.com`
- `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

Στην ακόλουθη σελίδα μπορείτε να δείτε πώς να **abuse S3 permissions to escalate privileges**:

{{#ref}}
../aws-privilege-escalation/aws-s3-privesc/README.md
{{#endref}}

### Unauthenticated Access

{{#ref}}
../aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum/README.md
{{#endref}}

### S3 Post Exploitation

{{#ref}}
../aws-post-exploitation/aws-s3-post-exploitation/README.md
{{#endref}}

### Persistence

{{#ref}}
../aws-persistence/aws-s3-persistence/README.md
{{#endref}}

## Άλλες ευπάθειες S3

### S3 HTTP Cache Poisoning Issue <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**Σύμφωνα με αυτή την έρευνα**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue) ήταν δυνατό να αποθηκευτεί στην cache η απάντηση ενός αυθαίρετου bucket σαν να ανήκε σε διαφορετικό. Αυτό θα μπορούσε να έχει χρησιμοποιηθεί για να τροποποιήσει, για παράδειγμα, τις απαντήσεις αρχείων JavaScript και να θέσει σε κίνδυνο αυθαίρετες σελίδες που χρησιμοποιούν το S3 για την αποθήκευση στατικού κώδικα.

## Amazon Athena

Amazon Athena είναι μια διαδραστική υπηρεσία ερωτημάτων που καθιστά εύκολο να **αναλύσετε δεδομένα** απευθείας στο Amazon Simple Storage Service (Amazon **S3**) **χρησιμοποιώντας** το πρότυπο **SQL**.

Πρέπει να **ετοιμάσετε έναν σχεσιακό πίνακα DB** με τη μορφή του περιεχομένου που πρόκειται να εμφανιστεί στα παρακολουθούμενα S3 buckets. Στη συνέχεια, το Amazon Athena θα μπορεί να γεμίσει τη βάση από τα logs, ώστε να μπορείτε να εκτελείτε ερωτήματα.

Το Amazon Athena υποστηρίζει την **ικανότητα εκτέλεσης ερωτημάτων σε δεδομένα S3 που είναι ήδη κρυπτογραφημένα** και, αν έχει ρυθμιστεί έτσι, **το Athena μπορεί επίσης να κρυπτογραφήσει τα αποτελέσματα του ερωτήματος τα οποία στη συνέχεια μπορούν να αποθηκευτούν στο S3**.

**Αυτή η κρυπτογράφηση των αποτελεσμάτων είναι ανεξάρτητη από τα υποκείμενα δεδομένα S3 που ερωτώνται**, πράγμα που σημαίνει ότι ακόμη και αν τα δεδομένα S3 δεν είναι κρυπτογραφημένα, τα αποτελέσματα των ερωτημάτων μπορούν να κρυπτογραφηθούν. Ένα ζήτημα που πρέπει να γνωρίζετε είναι ότι το Amazon Athena υποστηρίζει μόνο δεδομένα που έχουν **κρυπτογραφηθεί** με τις **εξής μεθόδους κρυπτογράφησης S3**, **SSE-S3, SSE-KMS, και CSE-KMS**.

Οι SSE-C και CSE-C δεν υποστηρίζονται. Επιπλέον, είναι σημαντικό να κατανοήσετε ότι το Amazon Athena θα εκτελεί ερωτήματα μόνο σε **κρυπτογραφημένα αντικείμενα που βρίσκονται στην ίδια region με το ίδιο το ερώτημα**. Εάν χρειάζεται να ερωτήσετε δεδομένα S3 που έχουν κρυπτογραφηθεί χρησιμοποιώντας KMS, απαιτούνται συγκεκριμένα permissions από τον χρήστη του Athena για να μπορέσει να εκτελέσει το ερώτημα.

### Enumeration
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## Αναφορές

- [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
- [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

{{#include ../../../banners/hacktricks-training.md}}
