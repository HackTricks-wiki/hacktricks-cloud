# AWS - S3, Athena & Glacier Keşfi

{{#include ../../../banners/hacktricks-training.md}}

## S3

Amazon S3, **büyük miktarda veri depolamanıza** olanak sağlayan bir servistir.

Amazon S3, durgun verilerin **korunmasını** sağlamak için birden fazla seçenek sunar. Bu seçenekler arasında **Permission** (Policy), **Encryption** (client ve server side), **Bucket Versioning** ve **MFA based delete** bulunur. **Kullanıcı** veri koruması sağlamak için bu seçeneklerin herhangi birini etkinleştirebilir. **Data replication**, AWS tarafından sağlanan dahili bir özelliktir; **S3, her nesneyi tüm Availability Zones arasında otomatik olarak çoğaltır** ve organizasyonun bunu etkinleştirmesine gerek yoktur.

With resource-based permissions, you can define permissions for sub-directories of your bucket separately.

### Bucket Versioning and MFA based delete

When Bucket Versioning is enabled, any action that tries to alter a file inside a file will generate a new version of the file, keeping also the previous content of the same. Therefore, it won't overwrite its content.

Moreover, MFA based delete will prevent versions of file in the S3 bucket from being deleted and also Bucket Versioning from being disabled, so an attacker won't be able to alter these files.

### S3 Erişim logları

Bazı bucket'larda (varsayılan olarak kapalı olan) **S3 access logging** etkinleştirilip loglar farklı bir bucket'a kaydedilebilir; böylece kimin bucket'a eriştiği tespit edilebilir (her iki bucket da aynı bölgede olmalıdır).

### S3 Presigned URLs

Belirli bir dosyaya erişmek için genellikle kullanılabilen presigned URL oluşturmak mümkündür. Bir **presigned URL şu şekilde görünür**:
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
Bir presigned URL **cli üzerinden, objeye erişimi olan bir principal'in kimlik bilgilerini kullanarak oluşturulabilir** (kullandığınız account'un erişimi yoksa, daha kısa bir presigned URL oluşturulur ama işe yaramaz)
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
> [!NOTE]
> Bir presigned URL oluşturmak için gerekli tek izin, verilecek izindir; bu yüzden önceki komut için principal'in ihtiyaç duyduğu tek izin `s3:GetObject`'tir.

Ayrıca presigned URL'ler **diğer izinlerle** oluşturulabilir:
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3 Şifreleme Mekanizmaları

**DEK means Data Encryption Key** ve veriyi her zaman şifrelemek için oluşturulan ve kullanılan anahtardır.

<details>

<summary><strong>Server-side encryption with S3 managed keys, SSE-S3</strong></summary>

Bu seçenek en az yapılandırma gerektirir ve kullanılan şifreleme anahtarlarının tüm yönetimi AWS tarafından gerçekleştirilir. Yapmanız gereken tek şey **verinizi yüklemektir; S3 diğer tüm yönleri halleder**. Her bucket bir S3 hesabında bir bucket key ile atanır.

- Şifreleme:
- Nesne Verisi + oluşturulan düz metin DEK --> Şifrelenmiş veri (S3 içinde saklanır)
- Oluşturulan düz metin DEK + S3 Master Key --> Şifrelenmiş DEK (S3 içinde saklanır) ve düz metin hafızadan silinir
- Deşifre:
- Şifrelenmiş DEK + S3 Master Key --> Düz metin DEK
- Düz metin DEK + Şifrelenmiş veri --> Nesne Verisi

Lütfen, bu durumda **anahtarın AWS tarafından yönetildiğini** (rotasyon sadece her 3 yılda bir) unutmayın. Kendi anahtarınızı kullanırsanız anahtarı döndürebilir, devre dışı bırakabilir ve erişim kontrolü uygulayabilirsiniz.

</details>

<details>

<summary><strong>Server-side encryption with KMS managed keys, SSE-KMS</strong></summary>

Bu yöntem S3'ün data encryption key'lerinizi oluşturmak için key management service'i kullanmasına izin verir. KMS anahtarlarınızın nasıl yönetileceği konusunda çok daha fazla esneklik sağlar. Örneğin, CMK'yi devre dışı bırakabilir, döndürebilir ve erişim kontrolleri uygulayabilir ve kullanımını AWS Cloud Trail ile denetleyebilirsiniz.

- Şifreleme:
- S3, veri anahtarlarını KMS CMK'den talep eder
- KMS, bir CMK kullanarak düz metin DEK ve şifrelenmiş DEK çiftini üretir ve bunları S£'ye gönderir
- S3, düz metin anahtarı veriyi şifrelemek için kullanır, şifrelenmiş veriyi ve şifrelenmiş anahtarı saklar ve düz metin anahtarı bellekten siler
- Deşifre:
- S3, nesnenin şifrelenmiş veri anahtarını çözmesi için KMS'e talepte bulunur
- KMS, veri anahtarını CMK ile çözer ve S3'e geri gönderir
- S3 nesne verisini çözer

</details>

<details>

<summary><strong>Server-side encryption with customer provided keys, SSE-C</strong></summary>

Bu seçenek, AWS dışında zaten kullanıyor olabileceğiniz kendi anahtarınızı sağlamanıza olanak tanır. Müşteri tarafından sağlanan anahtarınız verilerinizle birlikte S3'e gönderilir ve S3 sizin için şifrelemeyi gerçekleştirir.

- Şifreleme:
- Kullanıcı nesne verisi + Müşteri anahtarını S3'e gönderir
- Müşteri anahtarı veriyi şifrelemek için kullanılır ve şifrelenmiş veri saklanır
- Müşteri anahtarının tuzlanmış bir HMAC değeri de gelecekteki anahtar doğrulaması için saklanır
- Müşteri anahtarı bellekten silinir
- Deşifre:
- Kullanıcı müşteri anahtarını gönderir
- Anahtar saklanan HMAC değeri ile doğrulanır
- Müşteri tarafından sağlanan anahtar daha sonra veriyi çözmek için kullanılır

</details>

<details>

<summary><strong>Client-side encryption with KMS, CSE-KMS</strong></summary>

SSE-KMS'ye benzer şekilde, bu da data encryption key'lerinizi oluşturmak için key management service'i kullanır. Ancak bu sefer KMS, S3 yerine istemci tarafından çağrılır. Şifreleme istemci tarafında gerçekleşir ve şifrelenmiş veri saklanmak üzere S3'e gönderilir.

- Şifreleme:
- İstemci KMS'den bir veri anahtarı talep eder
- KMS düz metin DEK ve CMK ile şifrelenmiş DEK'i döndürür
- Her iki anahtar da geri gönderilir
- İstemci düz metin DEK ile veriyi şifreler ve S3'e şifrelenmiş veri + şifrelenmiş DEK'i (S3 içinde şifrelenmiş verinin metadata'sı olarak saklanır) gönderir
- Deşifre:
- Şifrelenmiş veri ve şifrelenmiş DEK istemciye gönderilir
- İstemci, CMK kullanarak şifrelenmiş anahtarı çözmesi için KMS'e talep eder ve KMS düz metin DEK'i geri gönderir
- İstemci artık şifrelenmiş veriyi çözebilir

</details>

<details>

<summary><strong>Client-side encryption with customer provided keys, CSE-C</strong></summary>

Bu mekanizma ile kendi sağladığınız anahtarları kullanabilir ve bir AWS-SDK istemcisi ile verinizi S3'e göndermeden önce şifreleyebilirsiniz.

- Şifreleme:
- İstemci bir DEK oluşturur ve düz metin veriyi şifreler
- Ardından kendi özel CMK'si ile DEK'i şifreler
- Şifrelenmiş veri + şifrelenmiş DEK'i S3'e gönderir ve orada saklanır
- Deşifre:
- S3 şifrelenmiş veri ve DEK'i gönderir
- İstemci, DEK'i şifrelemek için kullanılan CMK'ye zaten sahip olduğundan DEK'i çözer ve ardından düz metin DEK ile veriyi çözer

</details>

### **Enumeration**

AWS organizasyonlarını ele geçirmenin geleneksel ana yollarından biri, herkese açık erişime sahip bucket'ların ele geçirilmesiyle başlar. **You can find** [**public buckets enumerators in this page**](../aws-unauthenticated-enum-access/index.html#s3-buckets)**.**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name –-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

Bir S3 bucket'ına dual-stack endpoint üzerinden, virtual hosted-style veya path-style endpoint adı kullanarak erişebilirsiniz. Bunlar S3'e IPv6 üzerinden erişim için kullanışlıdır.

Dual-stack endpoint'leri şu sözdizimini kullanır:

- `bucketname.s3.dualstack.aws-region.amazonaws.com`
- `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

Aşağıdaki sayfada **abuse S3 permissions to escalate privileges** konusunu inceleyebilirsiniz:

{{#ref}}
../aws-privilege-escalation/aws-s3-privesc/README.md
{{#endref}}

### Unauthenticated Access

{{#ref}}
../aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum/README.md
{{#endref}}

### S3 Post Exploitation

{{#ref}}
../aws-post-exploitation/aws-s3-post-exploitation/README.md
{{#endref}}

### Persistence

{{#ref}}
../aws-persistence/aws-s3-persistence/README.md
{{#endref}}

## Other S3 vulns

### S3 HTTP Cache Poisoning Issue <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**According to this research**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue) rastgele bir bucket'ın yanıtını sanki farklı bir bucket'a aitmiş gibi önbelleğe almak mümkün oldu. Bu, örneğin javascript dosyası yanıtlarını değiştirmek ve S3'ü statik kod depolamak için kullanan herhangi bir sayfayı tehlikeye atmak için kötüye kullanılabilirdi.

## Amazon Athena

Amazon Athena, verileri doğrudan Amazon Simple Storage Service (Amazon **S3**) üzerinde standart **SQL** kullanarak **analiz etmeyi** kolaylaştıran etkileşimli bir sorgu servisidir.

İzlenen S3 bucket'larında görünecek içeriğin formatına uygun olarak **ilişkisel bir DB tablosu hazırlamanız gerekir**. Sonrasında Amazon Athena, günlüklerden DB'yi doldurabilecek ve sorgulayabilirsiniz.

Amazon Athena, zaten şifrelenmiş S3 verilerini sorgulama yeteneğini destekler ve yapılandırıldığı takdirde **Athena sorgu sonuçlarını şifreleyebilir ve bunlar daha sonra S3'te depolanabilir**.

**Bu sonuçların şifrelenmesi, sorgulanan altındaki S3 verilerinden bağımsızdır**, yani S3 verileri şifrelenmemiş olsa bile sorgu sonuçları şifrelenebilir. Bilinmesi gereken birkaç nokta: Amazon Athena yalnızca aşağıdaki S3 şifreleme yöntemleriyle **şifrelenmiş** verileri destekler: **SSE-S3, SSE-KMS, ve CSE-KMS**.

SSE-C ve CSE-C desteklenmez. Ayrıca, Amazon Athena'nın yalnızca sorgunun kendisiyle aynı bölgedeki **şifrelenmiş objelere** karşı sorgu yürüteceğini anlamak önemlidir. KMS kullanılarak şifrelenmiş S3 verilerini sorgulamanız gerekiyorsa, sorguyu gerçekleştirebilmek için Athena kullanıcısına özel izinler verilmesi gerekir.

### Enumeration
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## Referanslar

- [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
- [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

{{#include ../../../banners/hacktricks-training.md}}
