# AWS - S3, Athena & Glacier Enum

{{#include ../../../banners/hacktricks-training.md}}

## S3

Amazon S3, **büyük miktarda veri depolamanıza** olanak tanıyan bir hizmettir.

Amazon S3, verilerin dinlenme halindeki **korunmasını** sağlamak için birden fazla seçenek sunar. Seçenekler arasında **İzin** (Politika), **Şifreleme** (İstemci ve Sunucu Tarafı), **Kova Sürümleme** ve **MFA** **tabanlı silme** bulunmaktadır. **Kullanıcı,** veri koruması sağlamak için bu seçeneklerden herhangi birini etkinleştirebilir. **Veri çoğaltma**, AWS tarafından sağlanan bir iç olanak olup, **S3 her nesneyi tüm Erişilebilirlik Alanları arasında otomatik olarak çoğaltır** ve bu durumda organizasyonun bunu etkinleştirmesi gerekmez.

Kaynak tabanlı izinlerle, kovanızın alt dizinleri için izinleri ayrı ayrı tanımlayabilirsiniz.

### Kova Sürümleme ve MFA tabanlı silme

Kova sürümleme etkinleştirildiğinde, bir dosyanın içindeki bir dosyayı değiştirmeye çalışan herhangi bir işlem, dosyanın yeni bir sürümünü oluşturacak ve aynı zamanda önceki içeriği de koruyacaktır. Bu nedenle, içeriğini üzerine yazmayacaktır.

Ayrıca, MFA tabanlı silme, S3 kovasındaki dosya sürümlerinin silinmesini ve Kova Sürümlemenin devre dışı bırakılmasını engelleyecektir, böylece bir saldırgan bu dosyaları değiştiremeyecektir.

### S3 Erişim günlükleri

Bir kovaya **S3 erişim kaydını etkinleştirmek** (varsayılan olarak devre dışıdır) ve günlükleri farklı bir kovada saklamak mümkündür, böylece kovanın kimler tarafından erişildiğini bilebilirsiniz (her iki kova da aynı bölgede olmalıdır).

### S3 Önceden İmzalı URL'ler

Kovadaki **belirtilen dosyaya erişmek için** genellikle kullanılabilecek bir önceden imzalı URL oluşturmak mümkündür. **Önceden imzalı bir URL şöyle görünür:**
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
A presigned URL **bir nesneye erişimi olan bir yetkilinin kimlik bilgileri kullanılarak cli'dan oluşturulabilir** (kullandığınız hesap erişime sahip değilse, daha kısa bir presigned URL oluşturulacak ancak bu işe yaramayacaktır)
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
> [!NOTE]
> Önceden imzalı bir URL oluşturmak için gereken tek izin, verilen izindir, bu nedenle önceki komut için anahtarın ihtiyaç duyduğu tek izin `s3:GetObject`'dır.

Ayrıca **diğer izinlerle** önceden imzalı URL'ler oluşturmak da mümkündür:
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3 Şifreleme Mekanizmaları

**DEK, Veri Şifreleme Anahtarı** anlamına gelir ve verileri şifrelemek için her zaman oluşturulan ve kullanılan anahtardır.

<details>

<summary><strong>S3 yönetilen anahtarlarla sunucu tarafı şifreleme, SSE-S3</strong></summary>

Bu seçenek, minimum yapılandırma gerektirir ve kullanılan şifreleme anahtarlarının tüm yönetimi AWS tarafından yapılır. Tek yapmanız gereken **verilerinizi yüklemek ve S3 diğer tüm yönleriyle ilgilenecektir**. Bir S3 hesabındaki her bir kovaya bir kova anahtarı atanır.

- Şifreleme:
- Nesne Verisi + oluşturulan düz metin DEK --> Şifrelenmiş veri (S3 içinde saklanır)
- Oluşturulan düz metin DEK + S3 Anahtarları --> Şifrelenmiş DEK (S3 içinde saklanır) ve düz metin bellekten silinir
- Şifre çözme:
- Şifrelenmiş DEK + S3 Anahtarları --> Düz metin DEK
- Düz metin DEK + Şifrelenmiş veri --> Nesne Verisi

Lütfen, bu durumda **anahtarın AWS tarafından yönetildiğini** unutmayın (sadece 3 yılda bir döndürme). Kendi anahtarınızı kullanırsanız, döndürebilir, devre dışı bırakabilir ve erişim kontrolü uygulayabilirsiniz.

</details>

<details>

<summary><strong>KMS yönetilen anahtarlarla sunucu tarafı şifreleme, SSE-KMS</strong></summary>

Bu yöntem, S3'ün veri şifreleme anahtarlarınızı oluşturmak için anahtar yönetim hizmetini kullanmasına olanak tanır. KMS, anahtarlarınızın nasıl yönetileceği konusunda çok daha fazla esneklik sağlar. Örneğin, CMK'yı devre dışı bırakabilir, döndürebilir ve erişim kontrolleri uygulayabilirsiniz ve bunların kullanımına karşı AWS Cloud Trail kullanarak sipariş verebilirsiniz.

- Şifreleme:
- S3, KMS CMK'dan veri anahtarları talep eder
- KMS, düz metin DEK ve şifrelenmiş DEK çiftini oluşturmak için bir CMK kullanır ve bunları S3'e gönderir
- S3, düz metin anahtarı kullanarak verileri şifreler, şifrelenmiş veriyi ve şifrelenmiş anahtarı saklar ve düz metin anahtarı bellekte siler
- Şifre çözme:
- S3, nesnenin şifrelenmiş veri anahtarını KMS'ten çözmesini ister
- KMS, veri anahtarını CMK ile çözer ve S3'e geri gönderir
- S3, nesne verisini çözer

</details>

<details>

<summary><strong>Müşteri sağlanan anahtarlarla sunucu tarafı şifreleme, SSE-C</strong></summary>

Bu seçenek, AWS dışında zaten kullanıyor olabileceğiniz kendi anahtarınızı sağlamanıza olanak tanır. Müşteri sağlanan anahtarınız, verilerinizle birlikte S3'e gönderilir ve burada S3 sizin için şifreleme işlemini gerçekleştirir.

- Şifreleme:
- Kullanıcı, nesne verisini + Müşteri anahtarını S3'e gönderir
- Müşteri anahtarı verileri şifrelemek için kullanılır ve şifrelenmiş veri saklanır
- Müşteri anahtarının gelecekteki anahtar doğrulaması için tuzlu bir HMAC değeri de saklanır
- Müşteri anahtarı bellekten silinir
- Şifre çözme:
- Kullanıcı müşteri anahtarını gönderir
- Anahtar, saklanan HMAC değeri ile doğrulanır
- Müşteri sağlanan anahtar, verileri çözmek için kullanılır

</details>

<details>

<summary><strong>KMS ile istemci tarafı şifreleme, CSE-KMS</strong></summary>

SSE-KMS'ye benzer şekilde, bu da veri şifreleme anahtarlarınızı oluşturmak için anahtar yönetim hizmetini kullanır. Ancak, bu sefer KMS, S3 değil, istemci aracılığıyla çağrılır. Şifreleme istemci tarafında gerçekleşir ve şifrelenmiş veri daha sonra saklanmak üzere S3'e gönderilir.

- Şifreleme:
- İstemci, KMS'ten bir veri anahtarı talep eder
- KMS, düz metin DEK ve CMK ile şifrelenmiş DEK'i döner
- Her iki anahtar geri gönderilir
- İstemci, düz metin DEK ile verileri şifreler ve şifrelenmiş veriyi + şifrelenmiş DEK'i (S3 içindeki şifrelenmiş verinin meta verisi olarak saklanır) S3'e gönderir
- Şifre çözme:
- Şifrelenmiş veri ve şifrelenmiş DEK istemciye gönderilir
- İstemci, CMK kullanarak şifrelenmiş anahtarı çözmek için KMS'e başvurur ve KMS düz metin DEK'i geri gönderir
- İstemci artık şifrelenmiş veriyi çözebilir

</details>

<details>

<summary><strong>Müşteri sağlanan anahtarlarla istemci tarafı şifreleme, CSE-C</strong></summary>

Bu mekanizmayı kullanarak, kendi sağladığınız anahtarları kullanabilir ve verilerinizi S3'e göndermeden önce şifrelemek için bir AWS-SDK istemcisi kullanabilirsiniz.

- Şifreleme:
- İstemci bir DEK oluşturur ve düz metin verileri şifreler
- Ardından, kendi özel CMK'sini kullanarak DEK'i şifreler
- Şifrelenmiş veriyi + şifrelenmiş DEK'i S3'e gönderir ve burada saklanır
- Şifre çözme:
- S3, şifrelenmiş veriyi ve DEK'i gönderir
- İstemci, DEK'i şifrelemek için kullanılan CMK'ya zaten sahip olduğundan, DEK'i çözer ve ardından düz metin DEK'i verileri çözmek için kullanır

</details>

### **Numaralandırma**

AWS organizasyonlarını tehlikeye atmanın geleneksel ana yollarından biri, kamuya açık erişilebilir kovaları tehlikeye atmaktır. **[**Bu sayfada kamuya açık kova numaralandırıcıları bulabilirsiniz**](../aws-unauthenticated-enum-access/#s3-buckets)**.**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name –-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

Bir S3 bucket'ına, sanal barındırma tarzı veya yol tarzı bir uç nokta adı kullanarak çift yığın uç noktası aracılığıyla erişebilirsiniz. Bunlar, S3'e IPv6 üzerinden erişmek için faydalıdır.

Çift yığın uç noktaları aşağıdaki sözdizimini kullanır:

- `bucketname.s3.dualstack.aws-region.amazonaws.com`
- `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

Aşağıdaki sayfada **S3 izinlerini kötüye kullanarak ayrıcalıkları artırma** yöntemini kontrol edebilirsiniz:

{{#ref}}
../aws-privilege-escalation/aws-s3-privesc.md
{{#endref}}

### Kimlik Doğrulaması Olmayan Erişim

{{#ref}}
../aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md
{{#endref}}

### S3 Sonrası İstismar

{{#ref}}
../aws-post-exploitation/aws-s3-post-exploitation.md
{{#endref}}

### Süreklilik

{{#ref}}
../aws-persistence/aws-s3-persistence.md
{{#endref}}

## Diğer S3 zafiyetleri

### S3 HTTP Önbellek Zehirlenmesi Sorunu <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**Bu araştırmaya göre**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue) rastgele bir bucket'ın yanıtını, farklı birine aitmiş gibi önbelleğe almak mümkündü. Bu, örneğin javascript dosyası yanıtlarını değiştirmek ve S3'ü statik kod depolamak için kullanan rastgele sayfaları tehlikeye atmak için kötüye kullanılabilirdi.

## Amazon Athena

Amazon Athena, verileri doğrudan Amazon Basit Depolama Servisi (Amazon **S3**) **kullanarak** standart **SQL** ile **analiz etmeyi** kolaylaştıran etkileşimli bir sorgu hizmetidir.

Gözetlenen S3 bucket'larında görünecek içeriğin formatında bir **ilişkisel DB tablosu** **hazırlamanız** gerekir. Ardından, Amazon Athena, günlüklerden DB'yi doldurabilecektir, böylece sorgulayabilirsiniz.

Amazon Athena, **zaten şifrelenmiş S3 verilerini sorgulama yeteneğini** destekler ve böyle yapılandırıldığında, **Athena ayrıca sorgu sonuçlarını şifreleyebilir ve bunlar daha sonra S3'te saklanabilir**.

**Bu sonuçların şifrelenmesi, sorgulanan S3 verilerinin altında yatan şifrelemeden bağımsızdır**, yani S3 verileri şifrelenmemiş olsa bile, sorgulanan sonuçlar şifrelenebilir. Bilinmesi gereken birkaç nokta, Amazon Athena'nın yalnızca **aşağıdaki S3 şifreleme yöntemleriyle şifrelenmiş** verileri desteklediğidir: **SSE-S3, SSE-KMS ve CSE-KMS**.

SSE-C ve CSE-E desteklenmemektedir. Bunun yanı sıra, Amazon Athena'nın yalnızca **sorgunun kendisiyle aynı bölgede bulunan şifrelenmiş nesneler üzerinde sorgu çalıştıracağını** anlamak önemlidir. KMS kullanılarak şifrelenmiş S3 verilerini sorgulamanız gerekiyorsa, Athena kullanıcısının sorguyu gerçekleştirebilmesi için belirli izinlere sahip olması gerekir.

### Enumeration
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## Referanslar

- [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
- [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

{{#include ../../../banners/hacktricks-training.md}}
