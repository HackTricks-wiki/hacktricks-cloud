# AWS - S3, Athena & Glacier Enum

{{#include ../../../banners/hacktricks-training.md}}

## S3

Amazon S3 je servis koji vam omogućava **da skladištite velike količine podataka**.

Amazon S3 nudi više opcija za postizanje **zaštite** podataka u mirovanju. Opcije uključuju **Permission** (Policy), **Encryption** (Client and Server Side), **Bucket Versioning** i **MFA** **based delete**. **Korisnik može omogućiti** bilo koju od ovih opcija radi zaštite podataka. **Data replication** je interna AWS funkcija gde **S3 automatski replicira svaki objekat preko svih Availability Zones** i organizacija ne mora to posebno da omogućava.

Sa resource-based permissions možete posebno definisati dozvole za pod-direktorijume unutar vašeg bucket-a.

### Bucket Versioning and MFA based delete

Kada je Bucket Versioning omogućen, svaka akcija koja pokuša da izmeni fajl će generisati novu verziju fajla, pri čemu se čuva i prethodni sadržaj. Dakle, neće prepisati sadržaj.

Pored toga, MFA based delete će sprečiti brisanje verzija fajlova u S3 bucket-u i takođe onemogućiti isključivanje Bucket Versioning-a, tako da napadač neće moći da menja te fajlove.

### S3 Access logs

Moguće je **omogućiti S3 access logging** (što je po defaultu onemogućeno) za neki bucket i sačuvati logove u drugom bucket-u kako biste znali ko pristupa bucket-u (oba bucketa moraju biti u istoj regiji).

### S3 Presigned URLs

Moguće je generisati presigned URL koji se obično može koristiti za **pristup navedenom fajlu** u bucket-u. A **presigned URL izgleda ovako**:
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
Presigned URL može biti **kreiran iz cli koristeći kredencijale principala koji ima pristup objektu** (ako account koji koristite nema pristup, biće kreiran kraći presigned URL ali će biti beskoristan)
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
> [!NOTE]
> Jedino neophodno dopuštenje za generisanje presigned URL-a je dopuštenje koje se dodeljuje, tako da za prethodnu komandu jedino dopuštenje koje je potrebno principal-u je `s3:GetObject`
 
Moguće je takođe kreirati presigned URL-ove sa **drugim dozvolama**:
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3 mehanizmi enkripcije

**DEK znači Data Encryption Key (ključ za enkripciju podataka)** i predstavlja ključ koji se uvek generiše i koristi za enkripciju podataka.

<details>

<summary><strong>Server-side enkripcija sa S3 upravljanim ključevima, SSE-S3</strong></summary>

Ova opcija zahteva minimalnu konfiguraciju i sva upravljanje ključevima za enkripciju vrši AWS. Sve što treba da uradite je da **otpremite podatke i S3 će se pobrinuti za sve ostalo**. Svakom bucket-u u S3 nalogu dodeljen je bucket key.

- Enkripcija:
- Podaci objekta + generisani plaintext DEK --> Enkriptovani podaci (sačuvani u S3)
- Generisani plaintext DEK + S3 Master Key --> Enkriptovani DEK (sačuvan u S3) i plaintext se briše iz memorije
- Dekripcija:
- Enkriptovani DEK + S3 Master Key --> Plaintext DEK
- Plaintext DEK + enkriptovani podaci --> Podaci objekta

Napomena: u ovom slučaju **ključ je u rukama AWS-a** (rotacija samo na 3 godine). Ako koristite sopstveni ključ moći ćete da vršite rotaciju, onemogućavanje i primenu kontrole pristupa.

</details>

<details>

<summary><strong>Server-side enkripcija sa KMS upravljanim ključevima, SSE-KMS</strong></summary>

Ovaj metod omogućava S3 da koristi Key Management Service za generisanje vaših data encryption key-eva. KMS vam daje znatno veću fleksibilnost u načinu na koji se ključevi upravljaju. Na primer, možete da onemogućite, rotirate i primenite kontrole pristupa na CMK, kao i da kontrolišete njihovu upotrebu koristeći AWS Cloud Trail.

- Enkripcija:
- S3 zahteva data key od KMS
- KMS koristi CMK da generiše par: plaintext DEK i enkriptovani DEK i šalje ih S3
- S3 koristi plaintext ključ da enkriptuje podatke, čuva enkriptovane podatke i enkriptovani ključ, i briše plaintext ključ iz memorije
- Dekripcija:
- S3 traži od KMS da dekriptuje enkriptovani data key objekta
- KMS dekriptuje data key koristeći CMK i šalje ga nazad S3
- S3 dekriptuje podatak objekta

</details>

<details>

<summary><strong>Server-side enkripcija sa korisnički dostavljenim ključevima, SSE-C</strong></summary>

Ova opcija vam omogućava da obezbedite sopstveni master ključ koji možda već koristite van AWS-a. Vaš korisnički ključ bi tada bio poslat zajedno sa podacima u S3, gde bi S3 obavio enkripciju za vas.

- Enkripcija:
- Korisnik šalje podatke objekta + customer key u S3
- Customer key se koristi za enkripciju podataka i enkriptovani podaci se čuvaju
- Saltovana HMAC vrednost customer key-a se takođe čuva radi buduće validacije ključa
- Customer key se briše iz memorije
- Dekripcija:
- Korisnik šalje customer key
- Ključ se validira upoređivanjem sa sačuvanom HMAC vrednošću
- Customer provided key se zatim koristi za dekripciju podataka

</details>

<details>

<summary><strong>Client-side enkripcija sa KMS, CSE-KMS</strong></summary>

Slično SSE-KMS, i ovde se koristi Key Management Service za generisanje vaših data encryption key-eva. Međutim, ovog puta KMS se poziva od strane klijenta, a ne S3. Enkripcija se zatim dešava na strani klijenta, a enkriptovani podaci se šalju u S3 na čuvanje.

- Enkripcija:
- Klijent traži data key od KMS
- KMS vraća plaintext DEK i enkriptovani DEK potpisan CMK-om
- Oba ključa se vraćaju klijentu
- Klijent enkriptuje podatke plaintext DEK-om i šalje u S3 enkriptovane podatke + enkriptovani DEK (koji se čuva kao metadata enkriptovanih podataka u S3)
- Dekripcija:
- Enkriptovani podaci sa enkriptovanim DEK-om se šalju klijentu
- Klijent traži od KMS da dekriptuje enkriptovani ključ koristeći CMK i KMS vraća plaintext DEK
- Klijent sada može da dekriptuje enkriptovane podatke

</details>

<details>

<summary><strong>Client-side enkripcija sa korisnički dostavljenim ključevima, CSE-C</strong></summary>

Koristeći ovaj mehanizam, možete da koristite sopstvene ključeve i AWS-SDK klijent da enkriptujete podatke pre slanja u S3 na čuvanje.

- Enkripcija:
- Klijent generiše DEK i enkriptuje plaintext podatke
- Zatim, koristeći sopstveni CMK, enkriptuje DEK
- Podnese enkriptovane podatke + enkriptovani DEK u S3 gde se čuvaju
- Dekripcija:
- S3 šalje enkriptovane podatke i DEK
- Pošto klijent već poseduje CMK koji je korišćen za enkripciju DEK-a, dekriptuje DEK i potom koristi plaintext DEK da dekriptuje podatke

</details>

### **Enumeracija**

Jedan od tradicionalnih glavnih načina kompromitacije AWS organizacija počinje kompromitacijom javno dostupnih bucket-a. **Možete pronaći [**public buckets enumerators in this page**](../aws-unauthenticated-enum-access/index.html#s3-buckets)**.**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name –-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

You can access an S3 bucket through a dual-stack endpoint by using a virtual hosted-style or a path-style endpoint name. These are useful to access S3 through IPv6.

Dual-stack endpoints use the following syntax:

- `bucketname.s3.dualstack.aws-region.amazonaws.com`
- `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

In the following page you can check how to **abuse S3 permissions to escalate privileges**:

{{#ref}}
../aws-privilege-escalation/aws-s3-privesc/README.md
{{#endref}}

### Unauthenticated Access

{{#ref}}
../aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum/README.md
{{#endref}}

### S3 Post Exploitation

{{#ref}}
../aws-post-exploitation/aws-s3-post-exploitation/README.md
{{#endref}}

### Persistence

{{#ref}}
../aws-persistence/aws-s3-persistence/README.md
{{#endref}}

## Other S3 vulns

### S3 HTTP Cache Poisoning Issue <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**According to this research**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue) it was possible to cache the response of an arbitrary bucket as if it belonged to a different one. This could have been abused to change for example javascript file responses and compromise arbitrary pages using S3 to store static code.

## Amazon Athena

Amazon Athena is an interactive query service that makes it easy to **analyze data** directly in Amazon Simple Storage Service (Amazon **S3**) **using** standard **SQL**.

You need to **prepare a relational DB table** with the format of the content that is going to appear in the monitored S3 buckets. And then, Amazon Athena will be able to populate the DB from the logs, so you can query it.

Amazon Athena supports the **ability to query S3 data that is already encrypted** and if configured to do so, **Athena can also encrypt the results of the query which can then be stored in S3**.

**This encryption of results is independent of the underlying queried S3 data**, meaning that even if the S3 data is not encrypted, the queried results can be encrypted. A couple of points to be aware of is that Amazon Athena only supports data that has been **encrypted** with the **following S3 encryption methods**, **SSE-S3, SSE-KMS, and CSE-KMS**.

SSE-C and CSE-C are not supported. In addition to this, it's important to understand that Amazon Athena will only run queries against **encrypted objects that are in the same region as the query itself**. If you need to query S3 data that's been encrypted using KMS, then specific permissions are required by the Athena user to enable them to perform the query.

### Enumeration
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## Reference

- [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
- [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

{{#include ../../../banners/hacktricks-training.md}}
