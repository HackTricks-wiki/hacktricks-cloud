# AWS - VPC & Networking Basic Information

{{#include ../../../../banners/hacktricks-training.md}}

## AWS Networking in a Nutshell

**VPC** zawiera **CIDR sieci** jak 10.0.0.0/16 (z jego **tablicą routingu** i **ACL sieci**).

Ta sieć VPC jest podzielona na **podsieci**, więc **podsieć** jest bezpośrednio **związana** z **VPC**, **tablicą routingu** i **ACL sieci**.

Następnie, **Interfejsy sieciowe** podłączone do usług (jak instancje EC2) są **połączone** z **podsieciami** za pomocą **grup zabezpieczeń**.

Dlatego **grupa zabezpieczeń** ograniczy wystawione porty interfejsów sieciowych, które jej używają, **niezależnie od podsieci**. A **ACL sieci** będzie **ograniczać** wystawione porty do **całej sieci**.

Ponadto, aby **uzyskać dostęp do Internetu**, istnieją interesujące konfiguracje do sprawdzenia:

- **Podsieć** może **automatycznie przypisywać publiczne adresy IPv4**
- **Instancja** utworzona w sieci, która **automatycznie przypisuje adresy IPv4, może go uzyskać**
- **Brama internetowa** musi być **podłączona** do **VPC**
- Możesz również użyć **bram internetowych tylko do wyjścia**
- Możesz również mieć **bramę NAT** w **prywatnej podsieci**, aby możliwe było **połączenie z zewnętrznymi usługami** z tej prywatnej podsieci, ale **nie jest możliwe, aby dotrzeć do nich z zewnątrz**.
- Brama NAT może być **publiczna** (dostęp do internetu) lub **prywatna** (dostęp do innych VPC)

![](<../../../../images/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) umożliwia uruchamianie zasobów AWS w wirtualnej sieci, którą zdefiniowałeś. Ta wirtualna sieć będzie miała kilka podsieci, bramy internetowe do uzyskania dostępu do Internetu, ACL, grupy zabezpieczeń, IP...

### Subnets

Podsieci pomagają w egzekwowaniu wyższego poziomu bezpieczeństwa. **Logiczne grupowanie podobnych zasobów** również pomaga w utrzymaniu **łatwości zarządzania** w całej infrastrukturze.

- Ważne CIDR są od maski /16 do maski /28.
- Podsiec nie może znajdować się w różnych strefach dostępności w tym samym czasie.
- **AWS rezerwuje pierwsze trzy adresy IP hostów** każdej podsieci **do** **wewnętrznego użytku AWS**: pierwszy adres hosta jest używany dla routera VPC. Drugi adres jest zarezerwowany dla DNS AWS, a trzeci adres jest zarezerwowany do przyszłego użytku.
- Nazywa się **publicznymi podsieciami** te, które mają **bezpośredni dostęp do Internetu, podczas gdy prywatne podsieci nie mają.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Route Tables

Tablice routingu określają trasowanie ruchu dla podsieci w VPC. Określają, który ruch sieciowy jest przesyłany do internetu lub do połączenia VPN. Zwykle znajdziesz dostęp do:

- Lokalnego VPC
- NAT
- Bram internetowych / Bram internetowych tylko do wyjścia (potrzebnych do zapewnienia VPC dostępu do Internetu).
- Aby uczynić podsieć publiczną, musisz **utworzyć** i **podłączyć** **bramę internetową** do swojego VPC.
- Punkty końcowe VPC (do uzyskania dostępu do S3 z prywatnych sieci)

Na poniższych obrazach możesz sprawdzić różnice w domyślnej publicznej sieci i prywatnej:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Listy Kontroli Dostępu do Sieci (ACLs)**: ACL sieci to zasady zapory, które kontrolują przychodzący i wychodzący ruch sieciowy do podsieci. Mogą być używane do zezwalania lub odmawiania ruchu do określonych adresów IP lub zakresów.

- Najczęściej zezwala się/odmawia dostępu za pomocą grup zabezpieczeń, ale to jedyny sposób na całkowite przerwanie ustanowionych odwrotnych powłok. Zmodyfikowana zasada w grupach zabezpieczeń nie zatrzymuje już ustanowionych połączeń.
- Jednak to dotyczy całej podsieci, bądź ostrożny przy zabranianiu rzeczy, ponieważ potrzebna funkcjonalność może być zakłócona.

### Security Groups

Grupy zabezpieczeń to wirtualna **zapora**, która kontroluje przychodzący i wychodzący ruch sieciowy **do instancji** w VPC. Relacja 1 SG do M instancji (zwykle 1 do 1).\
Zwykle używa się tego do otwierania niebezpiecznych portów w instancjach, takich jak port 22 na przykład:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastic IP Addresses

_Adres IP Elastic_ to **statyczny adres IPv4** zaprojektowany do dynamicznego przetwarzania w chmurze. Adres IP Elastic jest przypisany do twojego konta AWS i jest twój, dopóki go nie zwolnisz. Używając adresu IP Elastic, możesz zamaskować awarię instancji lub oprogramowania, szybko przemapowując adres na inną instancję w swoim koncie.

### Connection between subnets

Domyślnie wszystkie podsieci mają **automatyczne przypisanie publicznych adresów IP wyłączone**, ale można je włączyć.

**Lokalna trasa w tablicy routingu umożliwia komunikację między podsieciami VPC.**

Jeśli **łączysz podsieć z inną podsiecią, nie możesz uzyskać dostępu do podsieci połączonej** z inną podsiecią, musisz stworzyć połączenie z nimi bezpośrednio. **To również dotyczy bram internetowych**. Nie możesz przejść przez połączenie podsieci, aby uzyskać dostęp do internetu, musisz przypisać bramę internetową do swojej podsieci.

### VPC Peering

VPC peering pozwala na **połączenie dwóch lub więcej VPC**, używając IPV4 lub IPV6, tak jakby były częścią tej samej sieci.

Gdy połączenie peer jest ustanowione, **zasoby w jednym VPC mogą uzyskiwać dostęp do zasobów w drugim**. Połączenie między VPC jest realizowane przez istniejącą infrastrukturę sieciową AWS, więc jest wysoce dostępne bez wąskich gardeł w przepustowości. Ponieważ **połączenia peer działają tak, jakby były częścią tej samej sieci**, istnieją ograniczenia dotyczące zakresów bloków CIDR, które mogą być używane.\
Jeśli masz **nakładające się lub duplikujące się zakresy CIDR** dla swojego VPC, to **nie będziesz mógł połączyć VPC** razem.\
Każde VPC AWS **będzie komunikować się tylko ze swoim peerem**. Na przykład, jeśli masz połączenie peeringowe między VPC 1 a VPC 2, oraz inne połączenie między VPC 2 a VPC 3, jak pokazano, to VPC 1 i 2 mogą komunikować się ze sobą bezpośrednio, tak jak VPC 2 i VPC 3, jednak VPC 1 i VPC 3 nie mogą. **Nie możesz routować przez jedno VPC, aby dotrzeć do drugiego.**

### **VPC Flow Logs**

W ramach swojego VPC możesz mieć potencjalnie setki lub nawet tysiące zasobów, które komunikują się między różnymi podsieciami, zarówno publicznymi, jak i prywatnymi, a także między różnymi VPC za pośrednictwem połączeń peeringowych VPC. **VPC Flow Logs pozwalają na uchwycenie informacji o ruchu IP, który przepływa między interfejsami sieciowymi twoich zasobów w ramach twojego VPC**.

W przeciwieństwie do logów dostępu S3 i logów dostępu CloudFront, **dane logów generowane przez VPC Flow Logs nie są przechowywane w S3. Zamiast tego, dane logów są wysyłane do logów CloudWatch**.

Ograniczenia:

- Jeśli uruchamiasz połączenie peeringowe VPC, to będziesz mógł zobaczyć tylko logi przepływu peeringowych VPC, które są w tym samym koncie.
- Jeśli nadal uruchamiasz zasoby w środowisku EC2-Classic, to niestety nie możesz uzyskać informacji z ich interfejsów.
- Gdy log przepływu VPC został utworzony, nie można go zmienić. Aby zmienić konfigurację logu przepływu VPC, musisz go usunąć, a następnie utworzyć nowy.
- Następujący ruch nie jest monitorowany i rejestrowany przez logi. Ruch DHCP w ramach VPC, ruch z instancji skierowany do serwera DNS Amazon.
- Wszelki ruch skierowany do adresu IP domyślnego routera VPC oraz ruch do i z następujących adresów, 169.254.169.254, który jest używany do zbierania metadanych instancji, oraz 169.254.169.123, który jest używany do usługi synchronizacji czasu Amazon.
- Ruch związany z licencją aktywacyjną systemu Windows Amazon z instancji Windows.
- Ruch między interfejsem równoważenia obciążenia sieciowego a interfejsem sieciowym punktu końcowego.

Dla każdego interfejsu sieciowego, który publikuje dane do grupy logów CloudWatch, będzie używany inny strumień logów. A w ramach każdego z tych strumieni będą dane zdarzeń logów przepływu, które pokazują zawartość wpisów logów. Każdy z tych **logów rejestruje dane w oknie czasowym wynoszącym około 10 do 15 minut**.

## VPN

### Basic AWS VPN Components

1. **Customer Gateway**:
- Customer Gateway to zasób, który tworzysz w AWS, aby reprezentować swoją stronę połączenia VPN.
- Jest to zasadniczo fizyczne urządzenie lub aplikacja programowa po twojej stronie połączenia VPN Site-to-Site.
- Podajesz informacje o routingu i publiczny adres IP swojego urządzenia sieciowego (takiego jak router lub zapora) do AWS, aby utworzyć Customer Gateway.
- Służy jako punkt odniesienia do skonfigurowania połączenia VPN i nie generuje dodatkowych opłat.
2. **Virtual Private Gateway**:
- Wirtualna brama prywatna (VPG) to koncentrator VPN po stronie Amazon w połączeniu VPN Site-to-Site.
- Jest podłączona do twojego VPC i służy jako cel dla twojego połączenia VPN.
- VPG jest punktem końcowym po stronie AWS dla połączenia VPN.
- Obsługuje bezpieczną komunikację między twoim VPC a twoją siecią lokalną.
3. **Site-to-Site VPN Connection**:
- Połączenie VPN Site-to-Site łączy twoją lokalną sieć z VPC przez bezpieczny tunel VPN IPsec.
- Ten typ połączenia wymaga Customer Gateway i Wirtualnej Bramy Prywatnej.
- Jest używany do bezpiecznej, stabilnej i spójnej komunikacji między twoim centrum danych lub siecią a twoim środowiskiem AWS.
- Zwykle używany do regularnych, długoterminowych połączeń i jest rozliczany na podstawie ilości danych przesyłanych przez połączenie.
4. **Client VPN Endpoint**:
- Punkt końcowy Client VPN to zasób, który tworzysz w AWS, aby umożliwić i zarządzać sesjami VPN klientów.
- Jest używany do umożliwienia indywidualnym urządzeniom (takim jak laptopy, smartfony itp.) bezpiecznego połączenia z zasobami AWS lub twoją lokalną siecią.
- Różni się od VPN Site-to-Site tym, że jest zaprojektowany dla indywidualnych klientów, a nie do łączenia całych sieci.
- Z Client VPN każde urządzenie klienckie używa oprogramowania klienta VPN do nawiązania bezpiecznego połączenia.

### Site-to-Site VPN

**Połącz swoją lokalną sieć z twoim VPC.**

- **Połączenie VPN**: Bezpieczne połączenie między twoim sprzętem lokalnym a twoimi VPC.
- **Tunel VPN**: Szyfrowane połączenie, przez które dane mogą przechodzić z sieci klienta do AWS lub odwrotnie.

Każde połączenie VPN zawiera dwa tunele VPN, które możesz jednocześnie używać dla wysokiej dostępności.

- **Customer gateway**: Zasób AWS, który dostarcza informacje do AWS o twoim urządzeniu bramy klienta.
- **Customer gateway device**: Fizyczne urządzenie lub aplikacja programowa po twojej stronie połączenia VPN Site-to-Site.
- **Virtual private gateway**: Koncentrator VPN po stronie Amazon w połączeniu VPN Site-to-Site. Używasz wirtualnej bramy prywatnej lub bramy tranzytowej jako bramy po stronie Amazon w połączeniu VPN Site-to-Site.
- **Transit gateway**: Hub tranzytowy, który może być używany do łączenia twoich VPC i lokalnych sieci. Używasz bramy tranzytowej lub wirtualnej bramy prywatnej jako bramy po stronie Amazon w połączeniu VPN Site-to-Site.

#### Limitations

- Ruch IPv6 nie jest obsługiwany dla połączeń VPN na wirtualnej bramie prywatnej.
- Połączenie VPN AWS nie obsługuje odkrywania MTU ścieżki.

Dodatkowo, weź pod uwagę następujące kwestie, gdy używasz VPN Site-to-Site.

- Podczas łączenia swoich VPC z wspólną lokalną siecią, zalecamy użycie niepokrywających się bloków CIDR dla twoich sieci.

### Client VPN <a href="#what-is-components" id="what-is-components"></a>

**Połącz się z twojego urządzenia z twoim VPC**

#### Concepts

- **Client VPN endpoint:** Zasób, który tworzysz i konfigurujesz, aby umożliwić i zarządzać sesjami VPN klientów. To zasób, w którym kończą się wszystkie sesje VPN klientów.
- **Target network:** Sieć docelowa to sieć, którą kojarzysz z punktem końcowym Client VPN. **Podsieć z VPC jest siecią docelową**. Powiązanie podsieci z punktem końcowym Client VPN umożliwia nawiązanie sesji VPN. Możesz powiązać wiele podsieci z punktem końcowym Client VPN dla wysokiej dostępności. Wszystkie podsieci muszą pochodzić z tego samego VPC. Każda podsieć musi należeć do innej strefy dostępności.
- **Route**: Każdy punkt końcowy Client VPN ma tablicę routingu, która opisuje dostępne trasy sieciowe. Każda trasa w tablicy routingu określa ścieżkę dla ruchu do określonych zasobów lub sieci.
- **Authorization rules:** Zasada autoryzacji **ogranicza użytkowników, którzy mogą uzyskać dostęp do sieci**. Dla określonej sieci konfigurujesz grupę Active Directory lub dostawcy tożsamości (IdP), która ma dostęp. Tylko użytkownicy należący do tej grupy mogą uzyskać dostęp do określonej sieci. **Domyślnie nie ma zasad autoryzacji** i musisz skonfigurować zasady autoryzacji, aby umożliwić użytkownikom dostęp do zasobów i sieci.
- **Client:** Użytkownik końcowy łączący się z punktem końcowym Client VPN, aby nawiązać sesję VPN. Użytkownicy końcowi muszą pobrać klienta OpenVPN i użyć pliku konfiguracyjnego Client VPN, który utworzyłeś, aby nawiązać sesję VPN.
- **Client CIDR range:** Zakres adresów IP, z którego przypisujesz adresy IP klientom. Każde połączenie z punktem końcowym Client VPN otrzymuje unikalny adres IP z zakresu CIDR klienta. Wybierasz zakres CIDR klienta, na przykład `10.2.0.0/16`.
- **Client VPN ports:** AWS Client VPN obsługuje porty 443 i 1194 zarówno dla TCP, jak i UDP. Domyślnie jest to port 443.
- **Client VPN network interfaces:** Gdy powiążesz podsieć z punktem końcowym Client VPN, tworzymy interfejsy sieciowe Client VPN w tej podsieci. **Ruch, który jest wysyłany do VPC z punktu końcowego Client VPN, jest wysyłany przez interfejs sieciowy Client VPN**. Następnie stosuje się translację adresu źródłowego (SNAT), gdzie adres IP źródłowego z zakresu CIDR klienta jest tłumaczony na adres IP interfejsu sieciowego Client VPN.
- **Connection logging:** Możesz włączyć rejestrowanie połączeń dla swojego punktu końcowego Client VPN, aby rejestrować zdarzenia połączeń. Możesz użyć tych informacji do przeprowadzania analiz, analizowania, jak twój punkt końcowy Client VPN jest używany, lub debugowania problemów z połączeniem.
- **Self-service portal:** Możesz włączyć portal samoobsługowy dla swojego punktu końcowego Client VPN. Klienci mogą zalogować się do portalu internetowego, używając swoich danych uwierzytelniających, i pobrać najnowszą wersję pliku konfiguracyjnego punktu końcowego Client VPN lub najnowszą wersję klienta dostarczonego przez AWS.

#### Limitations

- **Zakresy CIDR klienta nie mogą pokrywać się z lokalnym CIDR** VPC, w którym znajduje się powiązana podsieć, ani z żadnymi trasami ręcznie dodanymi do tablicy routingu punktu końcowego Client VPN.
- Zakresy CIDR klienta muszą mieć rozmiar bloku **co najmniej /22** i **nie mogą być większe niż /12.**
- **Część adresów** w zakresie CIDR klienta jest używana do **wsparcia modelu dostępności** punktu końcowego Client VPN i nie może być przypisana do klientów. Dlatego zalecamy, abyś **przypisał blok CIDR, który zawiera dwukrotność liczby adresów IP, które są wymagane** do umożliwienia maksymalnej liczby jednoczesnych połączeń, które planujesz obsługiwać na punkcie końcowym Client VPN.
- **Zakres CIDR klienta nie może być zmieniony** po utworzeniu punktu końcowego Client VPN.
- **Podsieci** powiązane z punktem końcowym Client VPN **muszą znajdować się w tym samym VPC**.
- **Nie możesz powiązać wielu podsieci z tej samej strefy dostępności z punktem końcowym Client VPN**.
- Punkt końcowy Client VPN **nie obsługuje powiązań podsieci w VPC z dedykowanym najmem**.
- Client VPN obsługuje **tylko** ruch IPv4.
- Client VPN **nie jest** zgodny z Federal Information Processing Standards (**FIPS**).
- Jeśli uwierzytelnianie wieloskładnikowe (MFA) jest wyłączone dla twojej Active Directory, hasło użytkownika nie może być w następującym formacie.

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```

- Portal samoobsługowy **nie jest dostępny dla klientów, którzy uwierzytelniają się za pomocą uwierzytelniania wzajemnego**.

{{#include ../../../../banners/hacktricks-training.md}}
