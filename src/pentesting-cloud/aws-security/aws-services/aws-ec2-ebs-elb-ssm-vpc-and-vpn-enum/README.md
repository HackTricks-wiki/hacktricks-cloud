# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

{{#include ../../../../banners/hacktricks-training.md}}

## VPC & Networking

Bir VPC'nin ne olduğunu ve bileşenlerini öğrenin:

{{#ref}}
aws-vpc-and-networking-basic-information.md
{{#endref}}

## EC2

Amazon EC2, **sanallaştırılmış sunucular** başlatmak için kullanılır. **Güvenlik** ve **ağ** yapılandırmasına izin verir ve **depolama** yönetimini sağlar. Amazon EC2'nin esnekliği, kaynakları yukarı ve aşağı ölçeklendirme yeteneğinde belirgindir; bu, değişen gereksinim değişikliklerine veya popülaritedeki artışlara etkili bir şekilde uyum sağlamasını sağlar. Bu özellik, kesin trafik tahminleri yapma gereksinimini azaltır.

EC2'de sayılacak ilginç şeyler:

- Sanal Makineler
- SSH Anahtarları
- Kullanıcı Verisi
- Mevcut EC2'ler/AMI'ler/Anlık Görüntüler
- Ağ
- Ağlar
- Alt Ağlar
- Genel IP'ler
- Açık portlar
- AWS dışındaki diğer ağlarla entegre bağlantılar

### Instance Profiles

**EC2 örnekleri** üzerinde çalışan uygulamalara izin vermek için **roller** kullanmak biraz ekstra yapılandırma gerektirir. Bir EC2 örneğinde çalışan bir uygulama, sanallaştırılmış işletim sistemi tarafından AWS'den soyutlanmıştır. Bu ekstra ayrım nedeniyle, bir AWS rolünü ve ona bağlı izinleri bir EC2 örneğine atamak ve bunları uygulamalarına sunmak için ek bir adım gereklidir.

Bu ek adım, örneğe bağlı bir [_**instance profile**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html) **oluşturulmasıdır**. **Instance profile, rolü içerir ve** örnekte çalışan bir uygulamaya rolün geçici kimlik bilgilerini sağlayabilir. Bu geçici kimlik bilgileri, uygulamanın API çağrılarında kaynaklara erişmek ve yalnızca rolün belirttiği kaynaklara erişimi sınırlamak için kullanılabilir. **Bir EC2 örneğine yalnızca bir rol atanabileceğini** ve örnekteki tüm uygulamaların aynı rolü ve izinleri paylaştığını unutmayın.

### Metadata Endpoint

AWS EC2 metadata, bir Amazon Elastic Compute Cloud (EC2) örneği hakkında, örneğin çalışma zamanında mevcut olan bilgilerdir. Bu metadata, örneğin örnek kimliği, çalıştığı kullanılabilirlik bölgesi, örneğe bağlı IAM rolü ve örneğin ana bilgisayar adı gibi bilgileri sağlamak için kullanılır.

{{#ref}}
https://book.hacktricks.wiki/en/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf.html
{{#endref}}

### Enumeration
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Kimlik Doğrulama Olmadan Erişim

{{#ref}}
../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md
{{#endref}}

### Yetki Yükseltme

Aşağıdaki sayfada **EC2 izinlerini kötüye kullanarak yetki yükseltmeyi** kontrol edebilirsiniz:

{{#ref}}
../../aws-privilege-escalation/aws-ec2-privesc.md
{{#endref}}

### Sonrası-İstismar

{{#ref}}
../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/
{{#endref}}

## EBS

Amazon **EBS** (Elastic Block Store) **anlık görüntüleri**, temelde AWS EBS hacimlerinin statik **yedekleridir**. Diğer bir deyişle, belirli bir zamanda bir **EC2** Instance'a bağlı olan **disklerin** **kopyalarıdır**. EBS anlık görüntüleri bölgeler ve hesaplar arasında kopyalanabilir veya hatta indirilebilir ve yerel olarak çalıştırılabilir.

Anlık görüntüler, **kaynak kodu veya API anahtarları** gibi **hassas bilgiler** içerebilir, bu nedenle, şansınız varsa, kontrol etmeniz önerilir.

### AMI & EBS Farkı

Bir **AMI**, **EC2 örneği başlatmak için** kullanılırken, bir EC2 **Anlık Görüntüsü**, **EBS hacminde depolanan verileri yedeklemek ve kurtarmak için** kullanılır. Bir EC2 Anlık Görüntüsü yeni bir AMI oluşturmak için kullanılabilir, ancak bu bir AMI ile aynı şey değildir ve bir uygulamayı çalıştırmak için gereken işletim sistemi, uygulama sunucusu veya diğer yazılımlar hakkında bilgi içermez.

### Yetki Yükseltme

Aşağıdaki sayfada **EBS izinlerini kötüye kullanarak yetki yükseltmeyi** kontrol edebilirsiniz:

{{#ref}}
../../aws-privilege-escalation/aws-ebs-privesc.md
{{#endref}}

## SSM

**Amazon Simple Systems Manager (SSM)**, EC2 örneklerinin yönetimini uzaktan yaparak yönetimlerini çok daha kolay hale getirir. Bu örneklerin her biri, **SSM Agent hizmetini çalıştırıyor olmalıdır, çünkü bu hizmet AWS API'sinden gelen eylemleri alıp gerçekleştirecektir**.

**SSM Agent**, Sistem Yöneticisi'nin bu kaynakları güncellemesini, yönetmesini ve yapılandırmasını mümkün kılar. Ajan, **AWS Cloud'daki Sistem Yöneticisi hizmetinden gelen istekleri işler** ve ardından isteklerde belirtildiği gibi çalıştırır.

**SSM Agent**, [**bazı AMI'lerde önceden yüklenmiş olarak gelir**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) veya örneklerde [**manuel olarak yüklemeniz gerekir**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html). Ayrıca, örnek içinde kullanılan IAM Rolü'nün, iletişim kurabilmesi için **AmazonEC2RoleforSSM** politikasına sahip olması gerekir.

### Sayım
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Bir EC2 örneğinde Systems Manager'ın çalışıp çalışmadığını kontrol etmek için sadece şunu çalıştırabilirsiniz:
```bash
ps aux | grep amazon-ssm
```
### Privesc

Aşağıdaki sayfada **SSM izinlerini kötüye kullanarak ayrıcalıkları artırma** yöntemini kontrol edebilirsiniz:

{{#ref}}
../../aws-privilege-escalation/aws-ssm-privesc.md
{{#endref}}

## ELB

**Elastic Load Balancing** (ELB), **Amazon Web Services** (AWS) dağıtımları için bir **yük dengeleme hizmetidir**. ELB, gelen uygulama trafiğini otomatik olarak **dağıtır** ve trafik taleplerini karşılamak için kaynakları ölçeklendirir.

### Enumeration
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Başlatma Şablonları ve Otomatik Ölçekleme Grupları

### Sayım
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
## Nitro

AWS Nitro, AWS EC2 örneklerinin temel platformunu oluşturan **yenilikçi teknolojiler** paketidir. Amazon tarafından **güvenliği, performansı ve güvenilirliği artırmak** amacıyla tanıtılan Nitro, özel **donanım bileşenleri ve hafif bir hipervizör** kullanır. Geleneksel sanallaştırma işlevlerinin çoğunu özel donanım ve yazılıma soyutlayarak, **saldırı yüzeyini minimize eder** ve kaynak verimliliğini artırır. Sanallaştırma işlevlerini devrederek, Nitro'nun EC2 örneklerinin **neredeyse bare-metal performansı** sunmasına olanak tanır, bu da kaynak yoğun uygulamalar için özellikle faydalıdır. Ayrıca, Nitro Güvenlik Çipi, **donanım ve yazılım güvenliğini** özel olarak sağlar ve sağlam mimarisini daha da güçlendirir.

Daha fazla bilgi ve nasıl sayılacağını öğrenmek için:

{{#ref}}
aws-nitro-enum.md
{{#endref}}

## VPN

Bir VPN, **on-premise ağınızı (site-to-site VPN)** veya **çalışanların dizüstü bilgisayarlarını (Client VPN)** bir **AWS VPC** ile bağlayarak hizmetlerin internete maruz kalmadan erişilmesini sağlar.

#### Temel AWS VPN Bileşenleri

1. **Müşteri Geçidi**:
- Müşteri Geçidi, bir VPN bağlantısının sizin tarafınızı temsil etmek için AWS'de oluşturduğunuz bir kaynaktır.
- Temelde, Site-to-Site VPN bağlantınızın sizin tarafınızdaki fiziksel bir cihaz veya yazılım uygulamasıdır.
- AWS'ye bir Müşteri Geçidi oluşturmak için yönlendirme bilgilerini ve ağ cihazınızın (örneğin bir yönlendirici veya bir güvenlik duvarı) genel IP adresini sağlarsınız.
- VPN bağlantısını kurmak için bir referans noktası olarak hizmet eder ve ek ücret talep etmez.
2. **Sanal Özel Geçit**:
- Sanal Özel Geçit (VPG), Site-to-Site VPN bağlantısının Amazon tarafındaki VPN konsantratörüdür.
- VPC'nize bağlıdır ve VPN bağlantınız için hedef olarak hizmet eder.
- VPG, VPN bağlantısının AWS tarafı uç noktasıdır.
- VPC'niz ile on-premises ağınız arasındaki güvenli iletişimi yönetir.
3. **Site-to-Site VPN Bağlantısı**:
- Site-to-Site VPN bağlantısı, on-premises ağınızı güvenli bir IPsec VPN tüneli aracılığıyla bir VPC'ye bağlar.
- Bu tür bir bağlantı, bir Müşteri Geçidi ve bir Sanal Özel Geçit gerektirir.
- Veri merkeziniz veya ağınız ile AWS ortamınız arasında güvenli, kararlı ve tutarlı iletişim için kullanılır.
- Genellikle düzenli, uzun vadeli bağlantılar için kullanılır ve bağlantı üzerinden aktarılan veri miktarına göre faturalandırılır.
4. **Client VPN Uç Noktası**:
- Client VPN uç noktası, AWS'de oluşturduğunuz bir kaynaktır ve istemci VPN oturumlarını etkinleştirmek ve yönetmek için kullanılır.
- Bireysel cihazların (dizüstü bilgisayarlar, akıllı telefonlar vb.) AWS kaynaklarına veya on-premises ağınıza güvenli bir şekilde bağlanmasına olanak tanır.
- Site-to-Site VPN'den farklı olarak, tüm ağları bağlamak yerine bireysel istemciler için tasarlanmıştır.
- Client VPN ile her istemci cihazı, güvenli bir bağlantı kurmak için bir VPN istemci yazılımı kullanır.

[**AWS VPN'lerin faydaları ve bileşenleri hakkında daha fazla bilgi bulabilirsiniz**](aws-vpc-and-networking-basic-information.md#vpn).

### Enumeration
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Yerel Enumere Etme

**Yerel Geçici Kimlik Bilgileri**

AWS VPN Client bir VPN'e bağlanmak için kullanıldığında, kullanıcı genellikle **AWS'ye giriş yapar** ve VPN'e erişim elde eder. Ardından, VPN bağlantısını kurmak için bazı **AWS kimlik bilgileri oluşturulur ve yerel olarak saklanır**. Bu kimlik bilgileri **şu konumda saklanır**: `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` ve bir **AccessKey**, bir **SecretKey** ve bir **Token** içerir.

Kimlik bilgileri `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` kullanıcısına aittir (TODO: bu kimlik bilgilerinin izinleri hakkında daha fazla araştırma yap).

**opvn yapılandırma dosyaları**

Eğer bir **VPN bağlantısı kurulduysa**, sistemde **`.opvn`** yapılandırma dosyalarını aramalısınız. Ayrıca, **yapılandırmaları** bulabileceğiniz bir yer **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**'dir.

#### **Sonrası İstismar**

{{#ref}}
../../aws-post-exploitation/aws-vpn-post-exploitation.md
{{#endref}}

## Referanslar

- [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

{{#include ../../../../banners/hacktricks-training.md}}
