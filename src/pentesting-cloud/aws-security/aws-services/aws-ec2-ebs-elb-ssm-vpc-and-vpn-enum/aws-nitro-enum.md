# AWS - Nitro Enum

{{#include ../../../../banners/hacktricks-training.md}}

## Basic Information

AWS Nitro एक **नवोन्मेषी प्रौद्योगिकियों** का एक सेट है जो AWS EC2 इंस्टेंस के लिए आधारभूत प्लेटफॉर्म बनाता है। इसे Amazon द्वारा **सुरक्षा, प्रदर्शन, और विश्वसनीयता** को **बढ़ाने** के लिए पेश किया गया था, Nitro कस्टम **हार्डवेयर घटकों और एक हल्के हाइपरवाइज़र** का उपयोग करता है। यह पारंपरिक वर्चुअलाइजेशन कार्यक्षमता के अधिकांश हिस्से को समर्पित हार्डवेयर और सॉफ़्टवेयर में एब्सट्रैक्ट करता है, **हमले की सतह को कम करते हुए** और संसाधन दक्षता में सुधार करता है। वर्चुअलाइजेशन कार्यों को ऑफलोड करके, Nitro EC2 इंस्टेंस को **नजदीकी बARE-मेटल प्रदर्शन** प्रदान करने की अनुमति देता है, जो संसाधन-गहन अनुप्रयोगों के लिए विशेष रूप से फायदेमंद है। इसके अतिरिक्त, Nitro सुरक्षा चिप विशेष रूप से **हार्डवेयर और फर्मवेयर की सुरक्षा** सुनिश्चित करती है, जिससे इसकी मजबूत आर्किटेक्चर को और मजबूत किया जाता है।

### Nitro Enclaves

**AWS Nitro Enclaves** एक सुरक्षित, **अलग कंप्यूट वातावरण प्रदान करता है जो Amazon EC2 इंस्टेंस के भीतर** है, जिसे अत्यधिक संवेदनशील डेटा को संसाधित करने के लिए विशेष रूप से डिज़ाइन किया गया है। AWS Nitro सिस्टम का लाभ उठाते हुए, ये एनक्लेव मजबूत **अलगाव और सुरक्षा** सुनिश्चित करते हैं, जो **गोपनीय जानकारी** जैसे PII या वित्तीय रिकॉर्ड को **संभालने** के लिए आदर्श हैं। इनमें एक न्यूनतम वातावरण होता है, जो डेटा के उजागर होने के जोखिम को काफी कम करता है। इसके अतिरिक्त, Nitro Enclaves क्रिप्टोग्राफिक अटेस्टेशन का समर्थन करते हैं, जिससे उपयोगकर्ता यह सत्यापित कर सकते हैं कि केवल अधिकृत कोड चल रहा है, जो सख्त अनुपालन और डेटा सुरक्षा मानकों को बनाए रखने के लिए महत्वपूर्ण है।

> [!CAUTION]
> Nitro Enclave छवियाँ **EC2 इंस्टेंस के अंदर से चलती हैं** और आप AWS वेब कंसोल से नहीं देख सकते कि क्या कोई EC2 इंस्टेंस Nitro Enclave में छवियाँ चला रहा है या नहीं।

## Nitro Enclave CLI installation

सभी निर्देशों का पालन करें [**दस्तावेज़ से**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave)। हालाँकि, ये सबसे महत्वपूर्ण हैं:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Images

जो इमेजेज़ आप Nitro Enclave में चला सकते हैं, वे डॉकर इमेजेज़ पर आधारित हैं, इसलिए आप अपने Nitro Enclave इमेजेज़ को डॉकर इमेजेज़ से बना सकते हैं जैसे:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
जैसा कि आप देख सकते हैं, Nitro Enclave छवियाँ **`eif`** (Enclave Image File) एक्सटेंशन का उपयोग करती हैं।

आउटपुट इस तरह दिखेगा:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Run an Image

जैसा कि [**दस्तावेज़**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave) में बताया गया है, एक एन्क्लेव इमेज चलाने के लिए आपको इसे **`eif` फ़ाइल के आकार का कम से कम 4 गुना मेमोरी** आवंटित करनी होगी। इसे फ़ाइल में डिफ़ॉल्ट संसाधनों को कॉन्फ़िगर करना संभव है।
```shell
/etc/nitro_enclaves/allocator.yaml
```
> [!CAUTION]
> हमेशा याद रखें कि आपको **माता EC2** इंस्टेंस के लिए भी कुछ संसाधनों को **आरक्षित** करना होगा!

छवि को देने के लिए संसाधनों को जानने के बाद और यहां तक कि कॉन्फ़िगरेशन फ़ाइल को संशोधित करने के बाद, एक एन्क्लेव छवि को चलाना संभव है:
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
### Enclaves की गणना करें

यदि आप एक EC2 होस्ट को समझौता करते हैं, तो चल रहे एन्क्लेव छवियों की सूची प्राप्त करना संभव है:
```bash
nitro-cli describe-enclaves
```
यह **चल रहे एन्क्लेव इमेज** के अंदर एक शेल प्राप्त करना **संभव नहीं है** क्योंकि यही एन्क्लेव का मुख्य उद्देश्य है, हालाँकि, यदि आपने पैरामीटर **`--debug-mode`** का उपयोग किया, तो आप इसे **stdout** प्राप्त कर सकते हैं:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Terminate Enclaves

यदि एक हमलावर एक EC2 उदाहरण को समझौता करता है, तो डिफ़ॉल्ट रूप से वह उनके अंदर एक शेल प्राप्त नहीं कर पाएगा, लेकिन वह उन्हें **terminate** करने में सक्षम होगा:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsocks

**enclave** चलाने वाली छवि के साथ संवाद करने का एकमात्र तरीका **vsocks** का उपयोग करना है।

**Virtual Socket (vsock)** लिनक्स में एक सॉकेट परिवार है जिसे विशेष रूप से वर्चुअल मशीनों (**VMs**) और उनके **hypervisors** के बीच या VMs **के बीच** संवाद को सुविधाजनक बनाने के लिए डिज़ाइन किया गया है। Vsock कुशल, **द्वि-दिशात्मक संचार** को सक्षम बनाता है बिना मेज़बान के नेटवर्किंग स्टैक पर निर्भर किए। यह VMs को नेटवर्क कॉन्फ़िगरेशन के बिना संवाद करने की अनुमति देता है, **32-बिट Context ID (CID) और पोर्ट नंबरों** का उपयोग करके कनेक्शनों की पहचान और प्रबंधन करने के लिए। vsock API स्ट्रीम और डेटाग्राम सॉकेट प्रकारों का समर्थन करता है, TCP और UDP के समान, वर्चुअल वातावरण में उपयोगकर्ता-स्तरीय अनुप्रयोगों के लिए एक बहुपरकारी उपकरण प्रदान करता है।

> [!TIP]
> इसलिए, एक vsock पता इस तरह दिखता है: `<CID>:<Port>`

**CIDs** खोजने के लिए जो enclave चलाने वाली छवियों के लिए हैं, आप बस निम्नलिखित cmd निष्पादित कर सकते हैं और **`EnclaveCID`** प्राप्त कर सकते हैं:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

> [!WARNING]
> ध्यान दें कि मेज़बान से यह जानने का कोई तरीका नहीं है कि कोई CID किसी पोर्ट को उजागर कर रहा है! जब तक कि कुछ **vsock पोर्ट स्कैनर जैसे** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner) का उपयोग न किया जाए।

### Vsock Server/Listener

यहाँ कुछ उदाहरण दिए गए हैं:

- [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Simple Python Listener</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock Client

Examples:

- [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>सरल पायथन क्लाइंट</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

टूल vsock-proxy एक vsock प्रॉक्सी को दूसरे पते के साथ प्रॉक्सी करने की अनुमति देता है, उदाहरण के लिए:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
यह **स्थानीय पोर्ट 8001 को vsock** पर `ip-ranges.amazonaws.com:443` पर अग्रेषित करेगा और फ़ाइल **`your-vsock-proxy.yaml`** में यह सामग्री हो सकती है जो `ip-ranges.amazonaws.com:443` तक पहुँचने की अनुमति देती है:
```yaml
allowlist:
- { address: ip-ranges.amazonaws.com, port: 443 }
```
यह संभव है कि EC2 होस्ट द्वारा उपयोग किए जाने वाले vsock पते (**`<CID>:<Port>`**) को देखा जा सके (ध्यान दें `3:8001`, 3 CID है और 8001 पोर्ट है):
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
## Nitro Enclave Atestation & KMS

Nitro Enclaves SDK एक enclave को Nitro **Hypervisor** से एक **क्रिप्टोग्राफिक रूप से हस्ताक्षरित अटेस्टेशन दस्तावेज** मांगने की अनुमति देता है, जिसमें उस enclave के लिए **विशिष्ट अद्वितीय माप** शामिल होते हैं। ये माप, जिसमें **हैश और प्लेटफ़ॉर्म कॉन्फ़िगरेशन रजिस्टर (PCRs)** शामिल हैं, अटेस्टेशन प्रक्रिया के दौरान **enclave की पहचान साबित करने** और **बाहरी सेवाओं के साथ विश्वास बनाने** के लिए उपयोग किए जाते हैं। अटेस्टेशन दस्तावेज़ में आमतौर पर ऐसे मान होते हैं जैसे PCR0, PCR1, और PCR2, जिनका आपने पहले एक enclave EIF बनाने और सहेजने के दौरान सामना किया है।

[**docs**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves) से, ये PCR मान हैं:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash of ...</th><th>Description</th></tr></thead><tbody><tr><td>PCR0</td><td>Enclave image file</td><td>इमेज फ़ाइल की सामग्री का एक निरंतर माप, बिना अनुभाग डेटा के।</td></tr><tr><td>PCR1</td><td>Linux kernel and bootstrap</td><td>कर्नेल और बूट ramfs डेटा का एक निरंतर माप।</td></tr><tr><td>PCR2</td><td>Application</td><td>उपयोगकर्ता अनुप्रयोगों का एक निरंतर, क्रमबद्ध माप, बिना बूट ramfs के।</td></tr><tr><td>PCR3</td><td>IAM role assigned to the parent instance</td><td>माता-पिता उदाहरण को सौंपा गया IAM भूमिका का एक निरंतर माप। सुनिश्चित करता है कि अटेस्टेशन प्रक्रिया केवल तभी सफल होती है जब माता-पिता उदाहरण के पास सही IAM भूमिका हो।</td></tr><tr><td>PCR4</td><td>Instance ID of the parent instance</td><td>माता-पिता उदाहरण के ID का एक निरंतर माप। सुनिश्चित करता है कि अटेस्टेशन प्रक्रिया केवल तभी सफल होती है जब माता-पिता उदाहरण के पास एक विशिष्ट उदाहरण ID हो।</td></tr><tr><td>PCR8</td><td>Enclave image file signing certificate</td><td>enclave image file के लिए निर्दिष्ट हस्ताक्षर प्रमाणपत्र का एक माप। सुनिश्चित करता है कि अटेस्टेशन प्रक्रिया केवल तभी सफल होती है जब enclave को एक विशिष्ट प्रमाणपत्र द्वारा हस्ताक्षरित enclave image file से बूट किया गया हो।</td></tr></tbody></table>

आप अपने अनुप्रयोगों में **क्रिप्टोग्राफिक अटेस्टेशन** को एकीकृत कर सकते हैं और **AWS KMS** जैसी सेवाओं के साथ पूर्व-निर्मित एकीकरण का लाभ उठा सकते हैं। AWS KMS **enclave attestations** को **मान्य** कर सकता है और इसके कुंजी नीतियों में अटेस्टेशन-आधारित स्थिति कुंजी (`kms:RecipientAttestation:ImageSha384` और `kms:RecipientAttestation:PCR`) प्रदान करता है। ये नीतियाँ सुनिश्चित करती हैं कि AWS KMS केवल तभी KMS कुंजी का उपयोग करने की अनुमति देता है **जब enclave का अटेस्टेशन दस्तावेज़ मान्य हो** और **निर्धारित शर्तों** को पूरा करता हो।

> [!TIP]
> ध्यान दें कि डिबग (--debug) मोड में Enclaves अटेस्टेशन दस्तावेज़ उत्पन्न करते हैं जिनमें PCRs शून्य (`000000000000000000000000000000000000000000000000`) होते हैं। इसलिए, इन मानों की जांच करने वाली KMS नीतियाँ विफल होंगी।

### PCR Bypass

एक हमलावर के दृष्टिकोण से, ध्यान दें कि कुछ PCRs कुछ भागों या सभी enclave image को संशोधित करने की अनुमति देंगे और फिर भी मान्य रहेंगे (उदाहरण के लिए PCR4 केवल माता-पिता उदाहरण के ID की जांच करता है, इसलिए उस EC2 में कोई भी enclave image चलाना इस संभावित PCR आवश्यकता को पूरा करने की अनुमति देगा)।

इसलिए, एक हमलावर जो EC2 उदाहरण को समझौता करता है, इन सुरक्षा उपायों को बायपास करने के लिए अन्य enclave images को चलाने में सक्षम हो सकता है।

प्रत्येक सुरक्षा को बायपास करने के लिए नए इमेज को संशोधित/बनाने पर शोध (विशेष रूप से जो स्पष्ट नहीं हैं) अभी भी TODO है।

## References

- [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
- AWS से Nitro ट्यूटोरियल के सभी भाग: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

{{#include ../../../../banners/hacktricks-training.md}}
