# AWS - STS Privesc

{{#include ../../../banners/hacktricks-training.md}}

## STS

### `sts:AssumeRole`

Κάθε ρόλος δημιουργείται με μια **πολιτική εμπιστοσύνης ρόλου**, αυτή η πολιτική υποδεικνύει **ποιος μπορεί να αναλάβει τον δημιουργημένο ρόλο**. Αν ένας ρόλος από τον **ίδιο λογαριασμό** λέει ότι ένας λογαριασμός μπορεί να τον αναλάβει, σημαίνει ότι ο λογαριασμός θα μπορεί να έχει πρόσβαση στον ρόλο (και πιθανώς **privesc**).

Για παράδειγμα, η παρακάτω πολιτική εμπιστοσύνης ρόλου υποδεικνύει ότι οποιοσδήποτε μπορεί να τον αναλάβει, επομένως **οποιοσδήποτε χρήστης θα μπορεί να privesc** στις άδειες που σχετίζονται με αυτόν τον ρόλο.
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
Μπορείτε να προσποιηθείτε έναν ρόλο που εκτελεί:
```bash
aws sts assume-role --role-arn $ROLE_ARN --role-session-name sessionname
```
**Πιθανές Επιπτώσεις:** Privesc στον ρόλο.

> [!CAUTION]
> Σημειώστε ότι σε αυτή την περίπτωση η άδεια `sts:AssumeRole` πρέπει να είναι **καθορισμένη στον ρόλο που θα εκμεταλλευτεί** και όχι σε μια πολιτική που ανήκει στον επιτιθέμενο.\
> Με μία εξαίρεση, προκειμένου να **αναλάβει έναν ρόλο από διαφορετικό λογαριασμό** ο λογαριασμός του επιτιθέμενου **πρέπει επίσης** να έχει την **`sts:AssumeRole`** πάνω στον ρόλο.

### **`sts:GetFederationToken`**

Με αυτή την άδεια είναι δυνατό να δημιουργηθούν διαπιστευτήρια για να προσποιηθεί οποιοσδήποτε χρήστης:
```bash
aws sts get-federation-token --name <username>
```
Αυτή είναι η διαδικασία με την οποία μπορεί να δοθεί αυτή η άδεια με ασφάλεια χωρίς να παραχωρηθεί πρόσβαση για να προσποιηθεί άλλους χρήστες:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "VisualEditor0",
"Effect": "Allow",
"Action": "sts:GetFederationToken",
"Resource": "arn:aws:sts::947247140022:federated-user/${aws:username}"
}
]
}
```
### `sts:AssumeRoleWithSAML`

Μια πολιτική εμπιστοσύνης με αυτόν τον ρόλο παρέχει **σε χρήστες που έχουν πιστοποιηθεί μέσω SAML πρόσβαση για να προσποιηθούν τον ρόλο.**

Ένα παράδειγμα πολιτικής εμπιστοσύνης με αυτήν την άδεια είναι:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "OneLogin",
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::290594632123:saml-provider/OneLogin"
},
"Action": "sts:AssumeRoleWithSAML",
"Condition": {
"StringEquals": {
"SAML:aud": "https://signin.aws.amazon.com/saml"
}
}
}
]
}
```
Για να δημιουργήσετε διαπιστευτήρια για να προσποιηθείτε τον ρόλο, γενικά θα μπορούσατε να χρησιμοποιήσετε κάτι όπως:
```bash
aws sts  assume-role-with-saml --role-arn <value> --principal-arn <value>
```
Αλλά οι **πάροχοι** μπορεί να έχουν τα **δικά τους εργαλεία** για να διευκολύνουν αυτό, όπως το [onelogin-aws-assume-role](https://github.com/onelogin/onelogin-python-aws-assume-role):
```bash
onelogin-aws-assume-role --onelogin-subdomain mettle --onelogin-app-id 283740 --aws-region eu-west-1 -z 3600
```
**Πιθανές Επιπτώσεις:** Privesc στον ρόλο.

### `sts:AssumeRoleWithWebIdentity`

Αυτή η άδεια παρέχει την άδεια να αποκτηθούν ένα σύνολο προσωρινών διαπιστευτηρίων ασφαλείας για **χρήστες που έχουν αυθεντικοποιηθεί σε μια κινητή, διαδικτυακή εφαρμογή, EKS...** με έναν πάροχο διαδικτυακής ταυτότητας. [Μάθετε περισσότερα εδώ.](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRoleWithWebIdentity.html)

Για παράδειγμα, αν ένας **λογαριασμός υπηρεσίας EKS** θα έπρεπε να μπορεί να **παριστάνει έναν ρόλο IAM**, θα έχει ένα διακριτικό στο **`/var/run/secrets/eks.amazonaws.com/serviceaccount/token`** και μπορεί να **αναλάβει τον ρόλο και να αποκτήσει διαπιστευτήρια** κάνοντας κάτι όπως:
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/<role_name> --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
# The role name can be found in the metadata of the configuration of the pod
```
### Κατάχρηση Ομοσπονδίας

{{#ref}}
../aws-basic-information/aws-federation-abuse.md
{{#endref}}

### IAM Roles Anywhere Privesc

AWS IAM RolesAnywhere επιτρέπει σε φόρτους εργασίας εκτός AWS να αναλαμβάνουν IAM ρόλους χρησιμοποιώντας πιστοποιητικά X.509. Αλλά όταν οι πολιτικές εμπιστοσύνης δεν είναι σωστά καθορισμένες, μπορούν να καταχραστούν για αναβάθμιση δικαιωμάτων.

Αυτή η πολιτική στερείται περιορισμών σχετικά με το ποιοι κόμβοι εμπιστοσύνης ή χαρακτηριστικά πιστοποιητικών επιτρέπονται. Ως αποτέλεσμα, οποιοδήποτε πιστοποιητικό συνδεδεμένο με οποιονδήποτε κόμβο εμπιστοσύνης στον λογαριασμό μπορεί να χρησιμοποιηθεί για να αναλάβει αυτόν τον ρόλο.
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Service": "rolesanywhere.amazonaws.com"
},
"Action": [
"sts:AssumeRole",
"sts:SetSourceIdentity",
"sts:TagSession"
]
}
]
}

```
Για privesc, απαιτείται το `aws_signing_helper` από https://docs.aws.amazon.com/rolesanywhere/latest/userguide/credential-helper.html

Στη συνέχεια, χρησιμοποιώντας ένα έγκυρο πιστοποιητικό, ο επιτιθέμενος μπορεί να μεταβεί στον ρόλο με υψηλότερα δικαιώματα.
```bash
aws_signing_helper credential-process \
--certificate readonly.pem \
--private-key readonly.key \
--trust-anchor-arn arn:aws:rolesanywhere:us-east-1:123456789012:trust-anchor/ta-id \
--profile-arn arn:aws:rolesanywhere:us-east-1:123456789012:profile/default \
--role-arn arn:aws:iam::123456789012:role/Admin
```
### Αναφορές

- [https://www.ruse.tech/blogs/aws-roles-anywhere-privilege-escalation](https://www.ruse.tech/blogs/aws-roles-anywhere-privilege-escalation)

{{#include ../../../banners/hacktricks-training.md}}
