# AWS - STS Privesc

{{#include ../../../banners/hacktricks-training.md}}

## STS

### `sts:AssumeRole`

Κάθε role δημιουργείται με ένα **role trust policy**· αυτή η πολιτική καθορίζει **who can assume the created role**. Εάν ένας role από τον **same account** δηλώνει ότι ένας account μπορεί να τον αναλάβει, τότε το account θα μπορεί να αποκτήσει πρόσβαση στον role (και ενδεχομένως να πραγματοποιήσει **privesc**).

Για παράδειγμα, το παρακάτω role trust policy υποδεικνύει ότι ο οποιοσδήποτε μπορεί να τον αναλάβει, επομένως **any user will be able to privesc** στα permissions που είναι συνδεδεμένα με αυτόν τον role.
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
Μπορείτε να προσωποποιήσετε έναν ρόλο εκτελώντας:
```bash
aws sts assume-role --role-arn $ROLE_ARN --role-session-name sessionname
```
**Πιθανός Αντίκτυπος:** Privesc στον ρόλο.

> [!CAUTION]
> Σημειώστε ότι σε αυτήν την περίπτωση η άδεια `sts:AssumeRole` πρέπει να **αναφέρεται στον ρόλο που θα καταχραστείτε** και όχι σε μια policy που ανήκει στον επιτιθέμενο.\
> Με μία εξαίρεση, για να **αναλάβει κανείς ρόλο από διαφορετικό λογαριασμό** ο λογαριασμός του επιτιθέμενου **επίσης χρειάζεται** να έχει το **`sts:AssumeRole`** πάνω στον ρόλο.


### `sts:AssumeRoleWithSAML`

Μια trust policy με αυτόν τον ρόλο δίνει τη δυνατότητα σε **χρήστες που αυθεντικοποιούνται μέσω SAML** να υποδυθούν τον ρόλο.

Ένα παράδειγμα trust policy με αυτήν την άδεια είναι:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "OneLogin",
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::290594632123:saml-provider/OneLogin"
},
"Action": "sts:AssumeRoleWithSAML",
"Condition": {
"StringEquals": {
"SAML:aud": "https://signin.aws.amazon.com/saml"
}
}
}
]
}
```
Για να δημιουργήσετε διαπιστευτήρια για να προσποιηθείτε τον ρόλο, γενικά μπορείτε να χρησιμοποιήσετε κάτι σαν:
```bash
aws sts  assume-role-with-saml --role-arn <value> --principal-arn <value>
```
Αλλά οι **πάροχοι** μπορεί να έχουν τα **δικά τους εργαλεία** για να το κάνουν πιο εύκολο, όπως [onelogin-aws-assume-role](https://github.com/onelogin/onelogin-python-aws-assume-role):
```bash
onelogin-aws-assume-role --onelogin-subdomain mettle --onelogin-app-id 283740 --aws-region eu-west-1 -z 3600
```
**Δυνητικός Αντίκτυπος:** Privesc στον ρόλο.

### `sts:AssumeRoleWithWebIdentity`

Αυτό το δικαίωμα επιτρέπει την απόκτηση ενός συνόλου προσωρινών διαπιστευτηρίων ασφαλείας για **χρήστες που έχουν πιστοποιηθεί σε κινητή εφαρμογή, εφαρμογή web, EKS...** με έναν πάροχο ταυτότητας web. [Learn more here.](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRoleWithWebIdentity.html)

Για παράδειγμα, αν ένας **EKS service account** πρέπει να μπορεί να **impersonate an IAM role**, θα έχει ένα token στο **`/var/run/secrets/eks.amazonaws.com/serviceaccount/token`** και μπορεί να **assume the role and get credentials** κάνοντας κάτι σαν:
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/<role_name> --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
# The role name can be found in the metadata of the configuration of the pod
```
### Federation Abuse

{{#ref}}
../aws-basic-information/aws-federation-abuse.md
{{#endref}}

### IAM Roles Anywhere Privesc

AWS IAM RolesAnywhere επιτρέπει σε workloads εκτός AWS να αναλάβουν IAM roles χρησιμοποιώντας πιστοποιητικά X.509. Όταν όμως οι trust policies δεν ορίζονται σωστά, μπορούν να καταχραστούν για privilege escalation.

Για να κατανοηθεί αυτή η επίθεση, είναι απαραίτητο να εξηγήσουμε τι είναι ένα trust anchor. Ένα trust anchor στο AWS IAM RolesAnywhere είναι η οντότητα ρίζα εμπιστοσύνης· περιέχει το δημόσιο πιστοποιητικό μιας Αρχής Πιστοποίησης (Certificate Authority, CA) που είναι καταχωρημένη στον λογαριασμό, ώστε το AWS να μπορεί να επαληθεύσει τα παρουσιαζόμενα πιστοποιητικά X.509. Με αυτόν τον τρόπο, αν το client certificate έχει εκδοθεί από αυτήν την CA και το trust anchor είναι ενεργό, το AWS το αναγνωρίζει ως έγκυρο.

Επιπλέον, ένα profile είναι η διαμόρφωση που ορίζει ποια χαρακτηριστικά του πιστοποιητικού X.509 (όπως CN, OU ή SAN) θα μετατραπούν σε session tags, τα οποία στη συνέχεια θα συγκριθούν με τις συνθήκες της trust policy.

Αυτή η policy δεν έχει περιορισμούς σχετικά με το ποιο trust anchor ή ποια attributes του πιστοποιητικού επιτρέπονται. Ως αποτέλεσμα, οποιοδήποτε πιστοποιητικό συνδεδεμένο με οποιοδήποτε trust anchor στον λογαριασμό μπορεί να χρησιμοποιηθεί για να αναλάβει αυτόν τον ρόλο.
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Service": "rolesanywhere.amazonaws.com"
},
"Action": [
"sts:AssumeRole",
"sts:SetSourceIdentity",
"sts:TagSession"
]
}
]
}

```
Για privesc, το `aws_signing_helper` απαιτείται από https://docs.aws.amazon.com/rolesanywhere/latest/userguide/credential-helper.html

Στη συνέχεια, χρησιμοποιώντας ένα έγκυρο πιστοποιητικό, ο attacker μπορεί να pivot σε higher privilege role
```bash
aws_signing_helper credential-process \
--certificate readonly.pem \
--private-key readonly.key \
--trust-anchor-arn arn:aws:rolesanywhere:us-east-1:123456789012:trust-anchor/ta-id \
--profile-arn arn:aws:rolesanywhere:us-east-1:123456789012:profile/default \
--role-arn arn:aws:iam::123456789012:role/Admin
```
Το trust anchor επαληθεύει ότι το πιστοποιητικό `readonly.pem` του client προέρχεται από την εξουσιοδοτημένη CA του, και μέσα στο πιστοποιητικό `readonly.pem` βρίσκεται το δημόσιο κλειδί που χρησιμοποιεί το AWS για να επαληθεύσει ότι η υπογραφή έγινε με το αντίστοιχο ιδιωτικό κλειδί `readonly.key`.

Το πιστοποιητικό παρέχει επίσης attributes (όπως CN ή OU) που το προφίλ `default` μετατρέπει σε tags, τα οποία η trust policy του role μπορεί να χρησιμοποιήσει για να αποφασίσει αν θα χορηγήσει πρόσβαση. Αν δεν υπάρχουν conditions στην trust policy, αυτά τα tags δεν έχουν χρήση και η πρόσβαση χορηγείται σε οποιονδήποτε έχει έγκυρο πιστοποιητικό.

Για να είναι δυνατή αυτή η επίθεση, πρέπει να είναι ενεργά τόσο το trust anchor όσο και το προφίλ `default`.

### Αναφορές

- [https://www.ruse.tech/blogs/aws-roles-anywhere-privilege-escalation](https://www.ruse.tech/blogs/aws-roles-anywhere-privilege-escalation)

{{#include ../../../banners/hacktricks-training.md}}
