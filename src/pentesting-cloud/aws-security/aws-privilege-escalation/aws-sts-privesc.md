# AWS - STS Privesc

{{#include ../../../banners/hacktricks-training.md}}

## STS

### `sts:AssumeRole`

Chaque rôle est créé avec une **politique de confiance du rôle**, cette politique indique **qui peut assumer le rôle créé**. Si un rôle du **même compte** indique qu'un compte peut l'assumer, cela signifie que le compte pourra accéder au rôle (et potentiellement **privesc**).

Par exemple, la politique de confiance suivante indique que n'importe qui peut l'assumer, donc **n'importe quel utilisateur pourra effectuer un privesc** sur les permissions associées à ce rôle.
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
Vous pouvez usurper un rôle en cours d'exécution :
```bash
aws sts assume-role --role-arn $ROLE_ARN --role-session-name sessionname
```
**Impact potentiel :** Privesc sur le rôle.

> [!CAUTION]
> Notez que dans ce cas la permission `sts:AssumeRole` doit être **indiquée dans le rôle à abuser** et non dans une policy appartenant à l'attaquant.\
> Avec une exception : pour **assumer un rôle dans un autre compte** le compte de l'attaquant **doit également** disposer de la **`sts:AssumeRole`** sur le rôle.


### `sts:AssumeRoleWithSAML`

Une trust policy associée à ce rôle accorde **aux utilisateurs authentifiés via SAML l'accès pour usurper le rôle.**

Un exemple de trust policy avec cette permission est:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "OneLogin",
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::290594632123:saml-provider/OneLogin"
},
"Action": "sts:AssumeRoleWithSAML",
"Condition": {
"StringEquals": {
"SAML:aud": "https://signin.aws.amazon.com/saml"
}
}
}
]
}
```
Pour générer des identifiants pour usurper le rôle, en général vous pouvez utiliser quelque chose comme :
```bash
aws sts  assume-role-with-saml --role-arn <value> --principal-arn <value>
```
Mais **les fournisseurs** peuvent proposer **leurs propres outils** pour rendre cela plus facile, comme [onelogin-aws-assume-role](https://github.com/onelogin/onelogin-python-aws-assume-role):
```bash
onelogin-aws-assume-role --onelogin-subdomain mettle --onelogin-app-id 283740 --aws-region eu-west-1 -z 3600
```
**Impact potentiel :** Privesc au rôle.

### `sts:AssumeRoleWithWebIdentity`

Cette permission permet d'obtenir un ensemble d'identifiants de sécurité temporaires pour **les utilisateurs qui ont été authentifiés dans une application mobile, une application web, EKS...** avec un fournisseur d'identité web. [Learn more here.](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRoleWithWebIdentity.html)

Par exemple, si un **compte de service EKS** doit pouvoir **se faire passer pour un rôle IAM**, il aura un token dans **`/var/run/secrets/eks.amazonaws.com/serviceaccount/token`** et peut **assumer le rôle et obtenir des identifiants** en faisant quelque chose comme :
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/<role_name> --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
# The role name can be found in the metadata of the configuration of the pod
```
### Federation Abuse

{{#ref}}
../aws-basic-information/aws-federation-abuse.md
{{#endref}}

### IAM Roles Anywhere Privesc

AWS IAM RolesAnywhere permet à des workloads situés en dehors d'AWS d'assumer des IAM roles en utilisant des certificats X.509. Mais lorsque les politiques de confiance ne sont pas correctement limitées, elles peuvent être abusées pour une escalation de privilèges.

Pour comprendre cette attaque, il est nécessaire d'expliquer ce qu'est une trust anchor. Une trust anchor dans AWS IAM RolesAnywhere est l'entité racine de confiance : elle contient le certificat public d'une Certificate Authority (CA) enregistrée dans le compte afin qu'AWS puisse valider les certificats X.509 présentés. Ainsi, si le certificat client a été émis par cette CA et que la trust anchor est active, AWS le reconnaît comme valide.

De plus, un profil est la configuration qui définit quels attributs du certificat X.509 (comme CN, OU ou SAN) seront transformés en tags de session, et ces tags seront ensuite comparés aux conditions de la politique de confiance.

Cette politique n'impose pas de restrictions sur les trust anchors ou les attributs de certificat autorisés. En conséquence, tout certificat lié à n'importe quelle trust anchor du compte peut être utilisé pour assumer ce rôle.
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Service": "rolesanywhere.amazonaws.com"
},
"Action": [
"sts:AssumeRole",
"sts:SetSourceIdentity",
"sts:TagSession"
]
}
]
}

```
Pour privesc, le `aws_signing_helper` est requis depuis https://docs.aws.amazon.com/rolesanywhere/latest/userguide/credential-helper.html

Ensuite, en utilisant un certificat valide, l'attaquant peut pivoter vers un rôle de privilèges supérieurs.
```bash
aws_signing_helper credential-process \
--certificate readonly.pem \
--private-key readonly.key \
--trust-anchor-arn arn:aws:rolesanywhere:us-east-1:123456789012:trust-anchor/ta-id \
--profile-arn arn:aws:rolesanywhere:us-east-1:123456789012:profile/default \
--role-arn arn:aws:iam::123456789012:role/Admin
```
L'ancre de confiance valide que le certificat `readonly.pem` du client provient de sa CA autorisée, et à l'intérieur de ce certificat `readonly.pem` se trouve la clé publique qu'AWS utilise pour vérifier que la signature a été faite avec sa clé privée correspondante `readonly.key`.

Le certificat fournit également des attributs (comme CN ou OU) que le profil `default` transforme en tags, que la trust policy du rôle peut utiliser pour décider d'autoriser l'accès. S'il n'y a pas de conditions dans la trust policy, ces tags sont inutiles et l'accès est accordé à toute personne disposant d'un certificat valide.

Pour que cette attaque soit possible, l'ancre de confiance et le profil `default` doivent être actifs.

### Références

- [https://www.ruse.tech/blogs/aws-roles-anywhere-privilege-escalation](https://www.ruse.tech/blogs/aws-roles-anywhere-privilege-escalation)

{{#include ../../../banners/hacktricks-training.md}}
