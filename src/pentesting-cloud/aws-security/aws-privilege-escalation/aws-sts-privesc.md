# AWS - STS Privesc

{{#include ../../../banners/hacktricks-training.md}}

## STS

### `sts:AssumeRole`

Κάθε role δημιουργείται με μια **role trust policy**, αυτή η πολιτική υποδεικνύει **ποιος μπορεί να αναλάβει το δημιουργημένο role**. Αν ένα role από τον **same account** δηλώνει ότι ένας account μπορεί να το αναλάβει, αυτό σημαίνει ότι ο account θα μπορέσει να έχει πρόσβαση στο role (και ενδεχομένως να κάνει **privesc**).

For example, the following role trust policy indicates that anyone can assume it, therefore **any user will be able to privesc** to the permissions associated with that role.
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
Μπορείτε να προσποιηθείτε έναν ρόλο που εκτελεί:
```bash
aws sts assume-role --role-arn $ROLE_ARN --role-session-name sessionname
```
**Πιθανός Αντίκτυπος:** Privesc στο ρόλο.

> [!CAUTION]
> Σημειώστε ότι σε αυτή την περίπτωση η άδεια `sts:AssumeRole` πρέπει να **αναφέρεται στον ρόλο που θα καταχραστείτε** και όχι σε μια πολιτική που ανήκει στον επιτιθέμενο.\
> Με μία εξαίρεση, για να **αναλάβει κανείς έναν ρόλο από διαφορετικό λογαριασμό** ο λογαριασμός του επιτιθέμενου **χρειάζεται επίσης** να έχει την **`sts:AssumeRole`** πάνω στον ρόλο.


### `sts:AssumeRoleWithSAML`

Μια πολιτική εμπιστοσύνης για αυτόν τον ρόλο παρέχει **σε χρήστες που έχουν αυθεντικοποιηθεί μέσω SAML πρόσβαση να υποδυθούν τον ρόλο.**

Ένα παράδειγμα πολιτικής εμπιστοσύνης με αυτή την άδεια είναι:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "OneLogin",
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::290594632123:saml-provider/OneLogin"
},
"Action": "sts:AssumeRoleWithSAML",
"Condition": {
"StringEquals": {
"SAML:aud": "https://signin.aws.amazon.com/saml"
}
}
}
]
}
```
Για να δημιουργήσετε credentials για να impersonate το role, γενικά μπορείτε να χρησιμοποιήσετε κάτι σαν:
```bash
aws sts  assume-role-with-saml --role-arn <value> --principal-arn <value>
```
Αλλά οι **πάροχοι** μπορεί να έχουν τα δικά τους **εργαλεία** για να το κάνουν πιο εύκολο, όπως το [onelogin-aws-assume-role](https://github.com/onelogin/onelogin-python-aws-assume-role):
```bash
onelogin-aws-assume-role --onelogin-subdomain mettle --onelogin-app-id 283740 --aws-region eu-west-1 -z 3600
```
**Potential Impact:** Privesc to the role.

### `sts:AssumeRoleWithWebIdentity`

Αυτό το δικαίωμα παρέχει δυνατότητα απόκτησης ενός συνόλου προσωρινών διαπιστευτηρίων ασφαλείας για **users who have been authenticated in a mobile, web application, EKS...** με έναν web identity provider. [Learn more here.](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRoleWithWebIdentity.html)

Για παράδειγμα, αν ένας **EKS service account** πρέπει να μπορεί να **impersonate an IAM role**, θα έχει ένα token στο **`/var/run/secrets/eks.amazonaws.com/serviceaccount/token`** και μπορεί να **assume the role and get credentials** κάνοντας κάτι σαν:
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/<role_name> --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
# The role name can be found in the metadata of the configuration of the pod
```
### Federation Abuse

{{#ref}}
../aws-basic-information/aws-federation-abuse.md
{{#endref}}

### IAM Roles Anywhere Privesc

Το AWS IAM RolesAnywhere επιτρέπει σε υπολογιστικά φορτία εκτός AWS να αναλαμβάνουν IAM roles χρησιμοποιώντας πιστοποιητικά X.509. Ωστόσο, όταν οι πολιτικές εμπιστοσύνης δεν είναι σωστά περιορισμένες, μπορούν να καταχραστούν για privilege escalation.

Αυτή η πολιτική δεν περιέχει περιορισμούς σχετικά με το ποιος trust anchor ή ποια χαρακτηριστικά πιστοποιητικού επιτρέπονται. Ως αποτέλεσμα, οποιοδήποτε πιστοποιητικό συνδεδεμένο με οποιονδήποτε trust anchor στον λογαριασμό μπορεί να χρησιμοποιηθεί για να αναλάβει αυτόν τον ρόλο.
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Service": "rolesanywhere.amazonaws.com"
},
"Action": [
"sts:AssumeRole",
"sts:SetSourceIdentity",
"sts:TagSession"
]
}
]
}

```
Για privesc, απαιτείται το `aws_signing_helper` από https://docs.aws.amazon.com/rolesanywhere/latest/userguide/credential-helper.html

Στη συνέχεια, χρησιμοποιώντας ένα έγκυρο πιστοποιητικό, ο attacker μπορεί να pivot στον ρόλο με υψηλότερα προνόμια
```bash
aws_signing_helper credential-process \
--certificate readonly.pem \
--private-key readonly.key \
--trust-anchor-arn arn:aws:rolesanywhere:us-east-1:123456789012:trust-anchor/ta-id \
--profile-arn arn:aws:rolesanywhere:us-east-1:123456789012:profile/default \
--role-arn arn:aws:iam::123456789012:role/Admin
```
Η αγκύρωση εμπιστοσύνης επαληθεύει ότι το πιστοποιητικό πελάτη `readonly.pem` προέρχεται από την εξουσιοδοτημένη CA του. Όταν δημιουργήθηκε η αγκύρωση εμπιστοσύνης, το δημόσιο πιστοποιητικό της CA συμπεριλήφθηκε (και τώρα χρησιμοποιείται για να επαληθεύσει το `readonly.pem`). Στο `readonly.pem` περιέχεται το δημόσιο κλειδί, το οποίο η AWS χρησιμοποιεί για να επαληθεύσει ότι η υπογραφή έγινε με το αντίστοιχο ιδιωτικό κλειδί `readonly.key`.

Το πιστοποιητικό επίσης αποδεικνύει ταυτότητα και παρέχει χαρακτηριστικά (όπως CN ή OU) που το προφίλ `default` μετατρέπει σε ετικέτες, τις οποίες η πολιτική εμπιστοσύνης του ρόλου μπορεί να χρησιμοποιήσει για να αποφασίσει εάν θα εξουσιοδοτήσει την πρόσβαση. Εάν δεν υπάρχουν προϋποθέσεις στην πολιτική εμπιστοσύνης, αυτές οι ετικέτες αγνοούνται και οποιοσδήποτε με έγκυρο πιστοποιητικό επιτρέπεται.

Για να είναι δυνατή αυτή η επίθεση, τόσο η αγκύρωση εμπιστοσύνης όσο και το προφίλ `default` πρέπει να είναι ενεργά.

### Αναφορές

- [https://www.ruse.tech/blogs/aws-roles-anywhere-privilege-escalation](https://www.ruse.tech/blogs/aws-roles-anywhere-privilege-escalation)

{{#include ../../../banners/hacktricks-training.md}}
