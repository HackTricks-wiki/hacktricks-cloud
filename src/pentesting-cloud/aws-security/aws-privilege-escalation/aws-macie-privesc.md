# AWS - Macie Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Macie

Для отримання додаткової інформації про Macie перегляньте:

{{#ref}}
../aws-services/aws-macie-enum.md
{{#endref}}

### Amazon Macie - Обхід перевірки цілісності `Reveal Sample`

AWS Macie - це сервіс безпеки, який автоматично виявляє чутливі дані в середовищах AWS, такі як облікові дані, особисто ідентифікована інформація (PII) та інші конфіденційні дані. Коли Macie виявляє чутливі облікові дані, такі як секретний ключ AWS, збережений у S3 бакеті, він генерує висновок, який дозволяє власнику переглянути "зразок" виявлених даних. Зазвичай, після видалення чутливого файлу з S3 бакету очікується, що секрет більше не можна буде відновити.

Однак було виявлено **обхід**, при якому зловмисник з достатніми правами може **завантажити файл з тією ж назвою**, але з різними, не чутливими даними. Це призводить до того, що Macie асоціює новозавантажений файл з оригінальним висновком, що дозволяє зловмиснику використовувати **функцію "Reveal Sample"** для витягування раніше виявленого секрету. Ця проблема становить значний ризик для безпеки, оскільки секрети, які вважалися видаленими, залишаються доступними через цей метод.

![flow](https://github.com/user-attachments/assets/7b83f2d3-1690-41f1-98cc-05ccd0154a66)

**Кроки для відтворення:**

1. Завантажте файл (наприклад, `test-secret.txt`) до S3 бакету з чутливими даними, такими як секретний ключ AWS. Дочекайтеся, поки AWS Macie просканує і згенерує висновок.

2. Перейдіть до висновків AWS Macie, знайдіть згенерований висновок і використайте функцію **Reveal Sample** для перегляду виявленого секрету.

3. Видаліть `test-secret.txt` з S3 бакету і перевірте, що його більше не існує.

4. Створіть новий файл з назвою `test-secret.txt` з фальшивими даними і повторно завантажте його до того ж S3 бакету, використовуючи **обліковий запис зловмисника**.

5. Поверніться до висновків AWS Macie, отримайте доступ до оригінального висновку і знову натисніть **Reveal Sample**.

6. Спостерігайте, що Macie все ще розкриває оригінальний секрет, незважаючи на те, що файл був видалений і замінений на інший вміст **з різних облікових записів, у нашому випадку це буде обліковий запис зловмисника**.

**Резюме:**

Ця вразливість дозволяє зловмиснику з достатніми правами AWS IAM відновлювати раніше виявлені секрети, навіть після того, як оригінальний файл був видалений з S3. Якщо секретний ключ AWS, токен доступу або інші чутливі облікові дані будуть розкриті, зловмисник може скористатися цим недоліком, щоб отримати їх і отримати несанкціонований доступ до ресурсів AWS. Це може призвести до ескалації привілеїв, несанкціонованого доступу до даних або подальшого компрометації хмарних активів, що призведе до витоків даних і збоїв у роботі сервісів.
