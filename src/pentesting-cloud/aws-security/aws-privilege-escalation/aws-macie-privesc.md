# AWS - Macie Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Macie

Aby uzyskać więcej informacji o Macie, sprawdź:

{{#ref}}
../aws-services/aws-macie-enum.md
{{#endref}}

### Amazon Macie - Ominięcie `Reveal Sample` Integrity Check

AWS Macie to usługa zabezpieczeń, która automatycznie wykrywa wrażliwe dane w środowiskach AWS, takie jak dane uwierzytelniające, informacje umożliwiające identyfikację osób (PII) i inne poufne dane. Gdy Macie zidentyfikuje wrażliwe dane uwierzytelniające, takie jak klucz tajny AWS przechowywany w wiadrze S3, generuje ustalenie, które pozwala właścicielowi zobaczyć "przykład" wykrytych danych. Zazwyczaj, gdy wrażliwy plik zostanie usunięty z wiadra S3, oczekuje się, że sekret nie może być już odzyskany.

Jednak zidentyfikowano **ominięcie**, w którym atakujący z wystarczającymi uprawnieniami może **ponownie przesłać plik o tej samej nazwie**, ale zawierający różne, niewrażliwe dane zastępcze. Powoduje to, że Macie kojarzy nowo przesłany plik z oryginalnym ustaleniem, co pozwala atakującemu skorzystać z funkcji **"Reveal Sample"**, aby wydobyć wcześniej wykryty sekret. Problem ten stanowi poważne ryzyko bezpieczeństwa, ponieważ sekrety, które uznano za usunięte, pozostają do odzyskania tą metodą.

![flow](https://github.com/user-attachments/assets/7b83f2d3-1690-41f1-98cc-05ccd0154a66)

**Kroki do odtworzenia:**

1. Prześlij plik (np. `test-secret.txt`) do wiadra S3 z wrażliwymi danymi, takimi jak klucz tajny AWS. Poczekaj, aż AWS Macie przeskanuje i wygeneruje ustalenie.

2. Przejdź do ustaleń AWS Macie, zlokalizuj wygenerowane ustalenie i skorzystaj z funkcji **Reveal Sample**, aby zobaczyć wykryty sekret.

3. Usuń `test-secret.txt` z wiadra S3 i upewnij się, że już nie istnieje.

4. Utwórz nowy plik o nazwie `test-secret.txt` z danymi zastępczymi i ponownie prześlij go do tego samego wiadra S3, używając **konta atakującego**.

5. Wróć do ustaleń AWS Macie, uzyskaj dostęp do oryginalnego ustalenia i ponownie kliknij **Reveal Sample**.

6. Zauważ, że Macie nadal ujawnia oryginalny sekret, mimo że plik został usunięty i zastąpiony inną zawartością **z różnych kont, w naszym przypadku będzie to konto atakującego**.

**Podsumowanie:**

Ta luka pozwala atakującemu z wystarczającymi uprawnieniami AWS IAM na odzyskanie wcześniej wykrytych sekretów, nawet po usunięciu oryginalnego pliku z S3. Jeśli klucz tajny AWS, token dostępu lub inne wrażliwe dane uwierzytelniające zostaną ujawnione, atakujący może wykorzystać tę wadę, aby je odzyskać i uzyskać nieautoryzowany dostęp do zasobów AWS. Może to prowadzić do eskalacji uprawnień, nieautoryzowanego dostępu do danych lub dalszego kompromitowania zasobów w chmurze, co skutkuje naruszeniami danych i zakłóceniami w usługach.
