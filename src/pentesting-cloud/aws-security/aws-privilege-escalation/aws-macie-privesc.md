# Amazon Macie - Bypass `Reveal Sample` Integrity Check

AWS Macie es un servicio de seguridad que detecta automáticamente datos sensibles dentro de entornos de AWS, como credenciales, información de identificación personal (PII) y otros datos confidenciales. Cuando Macie identifica una credencial sensible, como una clave secreta de AWS almacenada en un bucket S3, genera un hallazgo que permite al propietario ver una "muestra" de los datos detectados. Típicamente, una vez que el archivo sensible se elimina del bucket S3, se espera que la clave secreta ya no pueda ser recuperada.

Sin embargo, se ha identificado un **bypass** donde un atacante con permisos suficientes puede **volver a subir un archivo con el mismo nombre** pero que contenga datos ficticios diferentes y no sensibles. Esto provoca que Macie asocie el archivo recién subido con el hallazgo original, permitiendo al atacante usar la **función "Reveal Sample"** para extraer la clave secreta detectada anteriormente. Este problema representa un riesgo de seguridad significativo, ya que las claves que se asumían eliminadas siguen siendo recuperables a través de este método.

<img src="https://github.com/user-attachments/assets/c44228ae-12cd-41bd-9a04-57f503a63281" height="800" width="auto"/>

## Steps To Reproduce:

1. Sube un archivo (por ejemplo, `test-secret.txt`) a un bucket S3 con datos sensibles, como una clave secreta de AWS. Espera a que AWS Macie escanee y genere un hallazgo.

2. Navega a los Hallazgos de AWS Macie, localiza el hallazgo generado y usa la función **Reveal Sample** para ver la clave secreta detectada.

3. Elimina `test-secret.txt` del bucket S3 y verifica que ya no exista.

4. Crea un nuevo archivo llamado `test-secret.txt` con datos ficticios y vuelve a subirlo al mismo bucket S3 usando la **cuenta del atacante**.

5. Regresa a los Hallazgos de AWS Macie, accede al hallazgo original y haz clic en **Reveal Sample** nuevamente.

6. Observa que Macie aún revela la clave secreta original, a pesar de que el archivo ha sido eliminado y reemplazado con contenido diferente **de diferentes cuentas, en nuestro caso será la cuenta del atacante**.

## Summary:

Esta vulnerabilidad permite a un atacante con permisos suficientes de AWS IAM recuperar claves secretas detectadas anteriormente incluso después de que el archivo original ha sido eliminado de S3. Si una clave secreta de AWS, un token de acceso u otra credencial sensible se expone, un atacante podría aprovechar este defecto para recuperarla y obtener acceso no autorizado a los recursos de AWS. Esto podría llevar a una escalada de privilegios, acceso no autorizado a datos o un mayor compromiso de activos en la nube, resultando en violaciones de datos y interrupciones del servicio.
