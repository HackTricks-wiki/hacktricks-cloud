# AWS - Macie Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Macie

Για περισσότερες πληροφορίες σχετικά με το Macie, ελέγξτε:

{{#ref}}
../aws-services/aws-macie-enum.md
{{#endref}}

### Amazon Macie - Παράκαμψη Ελέγχου Ακεραιότητας `Reveal Sample`

Το AWS Macie είναι μια υπηρεσία ασφαλείας που ανιχνεύει αυτόματα ευαίσθητα δεδομένα εντός των περιβαλλόντων AWS, όπως διαπιστευτήρια, προσωπικά αναγνωρίσιμες πληροφορίες (PII) και άλλα εμπιστευτικά δεδομένα. Όταν το Macie εντοπίσει ένα ευαίσθητο διαπιστευτήριο, όπως ένα μυστικό κλειδί AWS που είναι αποθηκευμένο σε ένα S3 bucket, δημιουργεί μια εύρεση που επιτρέπει στον κάτοχο να δει ένα "δείγμα" των ανιχνευθέντων δεδομένων. Συνήθως, μόλις το ευαίσθητο αρχείο αφαιρεθεί από το S3 bucket, αναμένεται ότι το μυστικό δεν μπορεί πλέον να ανακτηθεί.

Ωστόσο, έχει εντοπιστεί μια **παράκαμψη** όπου ένας επιτιθέμενος με επαρκή δικαιώματα μπορεί να **ξαναφορτώσει ένα αρχείο με το ίδιο όνομα** αλλά περιέχοντας διαφορετικά, μη ευαίσθητα δεδομένα. Αυτό προκαλεί το Macie να συσχετίσει το νεοφορτωμένο αρχείο με την αρχική εύρεση, επιτρέποντας στον επιτιθέμενο να χρησιμοποιήσει τη δυνατότητα **"Reveal Sample"** για να εξάγει το προηγουμένως ανιχνευθέν μυστικό. Αυτό το ζήτημα θέτει σημαντικό κίνδυνο ασφαλείας, καθώς τα μυστικά που θεωρούνταν διαγραμμένα παραμένουν ανακτήσιμα μέσω αυτής της μεθόδου.

![flow](https://github.com/user-attachments/assets/7b83f2d3-1690-41f1-98cc-05ccd0154a66)

**Βήματα Αναπαραγωγής:**

1. Φορτώστε ένα αρχείο (π.χ., `test-secret.txt`) σε ένα S3 bucket με ευαίσθητα δεδομένα, όπως ένα μυστικό κλειδί AWS. Περιμένετε να σαρώσει το AWS Macie και να δημιουργήσει μια εύρεση.

2. Μεταβείτε στις Ευρήματα του AWS Macie, εντοπίστε την παραγόμενη εύρεση και χρησιμοποιήστε τη δυνατότητα **Reveal Sample** για να δείτε το ανιχνευθέν μυστικό.

3. Διαγράψτε το `test-secret.txt` από το S3 bucket και επιβεβαιώστε ότι δεν υπάρχει πλέον.

4. Δημιουργήστε ένα νέο αρχείο με το όνομα `test-secret.txt` με δεδομένα dummy και ξαναφορτώστε το στο ίδιο S3 bucket χρησιμοποιώντας **τον λογαριασμό του επιτιθέμενου**.

5. Επιστρέψτε στις Ευρήματα του AWS Macie, αποκτήστε πρόσβαση στην αρχική εύρεση και κάντε κλικ στο **Reveal Sample** ξανά.

6. Παρατηρήστε ότι το Macie αποκαλύπτει ακόμα το αρχικό μυστικό, παρά το γεγονός ότι το αρχείο έχει διαγραφεί και αντικατασταθεί με διαφορετικό περιεχόμενο **από διαφορετικούς λογαριασμούς, στην περίπτωσή μας θα είναι ο λογαριασμός του επιτιθέμενου**.

**Σύνοψη:**

Αυτή η ευπάθεια επιτρέπει σε έναν επιτιθέμενο με επαρκή δικαιώματα AWS IAM να ανακτήσει προηγουμένως ανιχνευθέντα μυστικά ακόμη και μετά τη διαγραφή του αρχικού αρχείου από το S3. Εάν ένα μυστικό κλειδί AWS, ένα διακριτικό πρόσβασης ή άλλο ευαίσθητο διαπιστευτήριο εκτεθεί, ένας επιτιθέμενος θα μπορούσε να εκμεταλλευτεί αυτή την αδυναμία για να το ανακτήσει και να αποκτήσει μη εξουσιοδοτημένη πρόσβαση στους πόρους AWS. Αυτό θα μπορούσε να οδηγήσει σε κλιμάκωση προνομίων, μη εξουσιοδοτημένη πρόσβαση σε δεδομένα ή περαιτέρω συμβιβασμό των περιουσιακών στοιχείων του cloud, με αποτέλεσμα παραβιάσεις δεδομένων και διακοπές υπηρεσιών.
