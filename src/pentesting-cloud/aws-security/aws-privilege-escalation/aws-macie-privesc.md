# AWS - Macie Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Macie

有关 Macie 的更多信息，请查看：

{{#ref}}
../aws-services/aws-macie-enum.md
{{#endref}}

### Amazon Macie - 绕过 `Reveal Sample` 完整性检查

AWS Macie 是一种安全服务，能够自动检测 AWS 环境中的敏感数据，例如凭证、个人身份信息 (PII) 和其他机密数据。当 Macie 识别到敏感凭证（例如存储在 S3 桶中的 AWS 秘密密钥）时，它会生成一个发现，允许所有者查看检测到的数据的“样本”。通常，一旦敏感文件从 S3 桶中删除，预计该秘密将无法再被检索。

然而，已识别出一种 **绕过** 方法，攻击者在具有足够权限的情况下可以 **重新上传一个同名** 但包含不同的、非敏感的虚拟数据的文件。这导致 Macie 将新上传的文件与原始发现关联，从而允许攻击者使用 **“Reveal Sample” 功能** 提取先前检测到的秘密。此问题构成了重大安全风险，因为被认为已删除的秘密仍然可以通过此方法检索。

![flow](https://github.com/user-attachments/assets/7b83f2d3-1690-41f1-98cc-05ccd0154a66)

**重现步骤：**

1. 将一个文件（例如 `test-secret.txt`）上传到包含敏感数据的 S3 桶，例如 AWS 秘密密钥。等待 AWS Macie 扫描并生成发现。

2. 导航到 AWS Macie 发现，找到生成的发现，并使用 **Reveal Sample** 功能查看检测到的秘密。

3. 从 S3 桶中删除 `test-secret.txt` 并验证它不再存在。

4. 创建一个名为 `test-secret.txt` 的新文件，包含虚拟数据，并使用 **攻击者的账户** 重新上传到同一个 S3 桶。

5. 返回 AWS Macie 发现，访问原始发现，并再次点击 **Reveal Sample**。

6. 观察到 Macie 仍然揭示原始秘密，尽管文件已被删除并被不同内容 **替换， 在我们的案例中将是攻击者的账户**。

**总结：**

此漏洞允许具有足够 AWS IAM 权限的攻击者恢复先前检测到的秘密，即使原始文件已从 S3 中删除。如果 AWS 秘密密钥、访问令牌或其他敏感凭证被暴露，攻击者可以利用此缺陷检索它并获得对 AWS 资源的未经授权访问。这可能导致权限提升、未经授权的数据访问或进一步危害云资产，从而导致数据泄露和服务中断。
