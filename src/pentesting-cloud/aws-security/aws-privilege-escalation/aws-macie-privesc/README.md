# AWS - Macie Privesc

{{#include ../../../../banners/hacktricks-training.md}}

## Macie

Για περισσότερες πληροφορίες σχετικά με την Macie δείτε:

{{#ref}}
../../aws-services/aws-macie-enum.md
{{#endref}}

### Amazon Macie - Bypass `Reveal Sample` Integrity Check

AWS Macie είναι μια υπηρεσία ασφάλειας που εντοπίζει αυτόματα ευαίσθητα δεδομένα εντός περιβαλλόντων AWS, όπως credentials, personally identifiable information (PII) και άλλα εμπιστευτικά δεδομένα. Όταν η Macie εντοπίζει ένα ευαίσθητο credential, όπως ένα AWS secret key αποθηκευμένο σε ένα S3 bucket, δημιουργεί ένα finding που επιτρέπει στον ιδιοκτήτη να δει ένα "sample" των εντοπισμένων δεδομένων. Τυπικά, μόλις το ευαίσθητο αρχείο αφαιρεθεί από το S3 bucket, αναμένεται ότι το secret δεν μπορεί πλέον να ανακτηθεί.

Ωστόσο, έχει εντοπιστεί ένα **bypass** όπου ένας attacker με επαρκή permissions μπορεί να **re-upload a file with the same name** αλλά με διαφορετικά, μη-ευαίσθητα dummy δεδομένα. Αυτό προκαλεί τη Macie να συσχετίσει το νεοανεβασμένο αρχείο με το αρχικό finding, επιτρέποντας στον attacker να χρησιμοποιήσει τη λειτουργία **"Reveal Sample" feature** για να εξάγει το προηγουμένως εντοπισμένο secret. Αυτό το ζήτημα αποτελεί σημαντικό κίνδυνο ασφάλειας, καθώς τα secrets που θεωρούνταν διαγραμμένα παραμένουν ανακτήσιμα μέσω αυτής της μεθόδου.

![flow](https://github.com/user-attachments/assets/7b83f2d3-1690-41f1-98cc-05ccd0154a66)

**Steps To Reproduce:**

1. Upload ένα αρχείο (π.χ. `test-secret.txt`) σε ένα S3 bucket με ευαίσθητα δεδομένα, όπως ένα AWS secret key. Περιμένετε μέχρι η AWS Macie να σαρώσει και να δημιουργήσει ένα finding.

2. Μεταβείτε στα AWS Macie Findings, εντοπίστε το δημιουργημένο finding, και χρησιμοποιήστε τη λειτουργία **Reveal Sample** για να δείτε το εντοπισμένο secret.

3. Διαγράψτε το `test-secret.txt` από το S3 bucket και επαληθεύστε ότι δεν υπάρχει πλέον.

4. Δημιουργήστε ένα νέο αρχείο με όνομα `test-secret.txt` με dummy δεδομένα και ανεβάστε το ξανά στο ίδιο S3 bucket χρησιμοποιώντας τον **attacker's account**.

5. Επιστρέψτε στα AWS Macie Findings, ανοίξτε το αρχικό finding, και κάντε κλικ ξανά στο **Reveal Sample**.

6. Παρατηρήστε ότι η Macie εξακολουθεί να αποκαλύπτει το αρχικό secret, παρόλο που το αρχείο είχε διαγραφεί και αντικατασταθεί με διαφορετικό περιεχόμενο **από διαφορετικούς λογαριασμούς, στην περίπτωσή μας θα είναι ο attacker's account**.

**Summary:**

Αυτή η ευπάθεια επιτρέπει σε έναν attacker με επαρκή AWS IAM permissions να ανακτήσει προηγουμένως εντοπισμένα secrets ακόμα και μετά την διαγραφή του αρχικού αρχείου από το S3. Εάν ένα AWS secret key, access token, ή άλλο ευαίσθητο credential εκτεθεί, ένας attacker μπορεί να εκμεταλλευτεί αυτό το σφάλμα για να το ανακτήσει και να αποκτήσει μη εξουσιοδοτημένη πρόσβαση σε πόρους AWS. Αυτό μπορεί να οδηγήσει σε privilege escalation, μη εξουσιοδοτημένη πρόσβαση σε δεδομένα, ή περαιτέρω συμβιβασμό cloud assets, προκαλώντας data breaches και διακοπές υπηρεσιών.
{{#include ../../../../banners/hacktricks-training.md}}
