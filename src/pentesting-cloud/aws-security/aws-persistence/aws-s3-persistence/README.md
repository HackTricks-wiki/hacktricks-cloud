# AWS - S3 Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## S3

Para más información consulta:

{{#ref}}
../../aws-services/aws-s3-athena-and-glacier-enum.md
{{#endref}}

### KMS Client-Side Encryption

Cuando se completa el proceso de encriptación, el usuario usará la API de KMS para generar una nueva clave (`aws kms generate-data-key`) y él **almacenará la clave cifrada generada dentro de los metadatos** del archivo ([python code example](https://aioboto3.readthedocs.io/en/latest/cse.html#how-it-works-kms-managed-keys)) de modo que, cuando ocurra la desencriptación, pueda descifrarla usando KMS de nuevo:

<figure><img src="../../../images/image (226).png" alt=""><figcaption></figcaption></figure>

Por lo tanto, un atacante podría obtener esta clave de los metadatos y descifrarla con KMS (`aws kms decrypt`) para obtener la clave usada para cifrar la información. De este modo el atacante tendrá la clave de cifrado y, si esa clave se reutiliza para cifrar otros archivos, podrá usarla.

### Using S3 ACLs

Aunque normalmente los ACLs de los buckets están deshabilitados, un atacante con privilegios suficientes podría abusar de ellos (si están habilitados o si el atacante puede habilitarlos) para mantener el acceso al bucket de S3.

{{#include ../../../../banners/hacktricks-training.md}}
