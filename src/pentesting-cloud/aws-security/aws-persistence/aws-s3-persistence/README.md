# AWS - S3 Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## S3

欲了解更多信息，请参阅：

{{#ref}}
../../aws-services/aws-s3-athena-and-glacier-enum.md
{{#endref}}

### KMS Client-Side Encryption

When the encryption process is done the user will use the KMS API to generate a new key (`aws kms generate-data-key`) and he will **store the generated encrypted key inside the metadata** of the file ([python code example](https://aioboto3.readthedocs.io/en/latest/cse.html#how-it-works-kms-managed-keys)) so when the decrypting occur it can decrypt it using KMS again:

<figure><img src="../../../images/image (226).png" alt=""><figcaption></figcaption></figure>

因此，攻击者可以从元数据中获取该密钥，并使用 KMS (`aws kms decrypt`) 解密以获取用于加密信息的密钥。这样，攻击者将掌握加密密钥，如果该密钥被重用于加密其他文件，攻击者也能解密这些文件。

### Using S3 ACLs

尽管存储桶的 ACLs 通常是禁用的，但具有足够权限的攻击者可以滥用它们（如果已启用或攻击者可以启用它们）来保持对 S3 存储桶的访问。

{{#include ../../../../banners/hacktricks-training.md}}
