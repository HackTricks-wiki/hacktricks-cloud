# AWS - Lambda Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

자세한 내용은 다음을 확인하세요:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Lambda Layer Persistence

lambda가 실행될 때 은밀하게 임의 코드를 실행하도록 layer를 삽입/백도어화할 수 있습니다:

{{#ref}}
aws-lambda-layers-persistence.md
{{#endref}}

### Lambda Extension Persistence

Lambda Layers를 악용하면 extensions를 남용하여 lambda에 영구화(persist)할 수 있으며 요청을 탈취하거나 수정할 수도 있습니다.

{{#ref}}
aws-abusing-lambda-extensions.md
{{#endref}}

### Via resource policies

외부 계정에 대해 lambda의 다양한 액션(예: invoke 또는 update code)에 대한 접근을 부여할 수 있습니다:

<figure><img src="../../../../images/image (255).png" alt=""><figcaption></figcaption></figure>

### Versions, Aliases & Weights

A Lambda는 서로 다른 코드로 구성된 여러 versions를 가질 수 있습니다.\
그런 다음, 서로 다른 versions를 가리키는 aliases를 생성하고 각 alias에 대해 weights를 설정할 수 있습니다.\
이렇게 하면 공격자는 backdoored version 1과 정상 코드만 포함된 version 2를 만들고, 은밀하게 유지하기 위해 요청의 1%에서만 version 1을 실행하도록 설정할 수 있습니다.

<figure><img src="../../../../images/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Copy the original code of the Lambda
2. **Create a new version backdooring** the original code (or just with malicious code). Publish and **deploy that version** to $LATEST
1. Call the API gateway related to the lambda to execute the code
3. **Create a new version with the original code**, Publish and deploy that **version** to $LATEST.
1. This will hide the backdoored code in a previous version
4. Go to the API Gateway and **create a new POST method** (or choose any other method) that will execute the backdoored version of the lambda: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Note the final :1 of the arn **indicating the version of the function** (version 1 will be the backdoored one in this scenario).
5. Select the POST method created and in Actions select **`Deploy API`**
6. Now, when you **call the function via POST your Backdoor** will be invoked

### Cron/Event actuator

무언가가 발생하거나 일정 시간이 지나면 lambda functions를 실행시킬 수 있다는 점 때문에 lambda는 persistence를 얻고 탐지를 피하는 흔한 방법입니다.\
다음은 lambdas를 생성하여 AWS에서의 존재를 더 은밀하게 만드는 몇 가지 아이디어입니다.

- Every time a new user is created lambda generates a new user key and send it to the attacker.
- Every time a new role is created lambda gives assume role permissions to compromised users.
- Every time new cloudtrail logs are generated, delete/alter them

### RCE abusing AWS_LAMBDA_EXEC_WRAPPER + Lambda Layers

환경 변수 `AWS_LAMBDA_EXEC_WRAPPER`를 악용하여 runtime/handler가 시작되기 전에 공격자가 제어하는 wrapper 스크립트를 실행할 수 있습니다. wrapper를 Lambda Layer로 `/opt/bin/htwrap`에 전달하고 `AWS_LAMBDA_EXEC_WRAPPER=/opt/bin/htwrap`로 설정한 다음 함수를 호출하세요. wrapper는 함수 runtime 프로세스 내부에서 실행되며 함수 execution role을 상속하고 최종적으로 실제 runtime을 `exec`하여 원래 handler가 정상적으로 계속 실행되도록 합니다.

{{#ref}}
aws-lambda-exec-wrapper-persistence.md
{{#endref}}

### AWS - Lambda Function URL Public Exposure

Lambda의 asynchronous destinations와 Recursion 설정을 함께 악용하면 외부 스케줄러(EventBridge, cron 등) 없이도 함수가 스스로 지속적으로 재호출되도록 만들 수 있습니다. 기본적으로 Lambda는 재귀 루프를 종료하지만 recursion config를 Allow로 설정하면 이를 다시 활성화할 수 있습니다. Destinations는 비동기 호출에 대해 서비스 측에서 전달되므로 단일 시드 호출로 코드 없는 은밀한 heartbeat/backdoor 채널을 만들 수 있습니다. 선택적으로 reserved concurrency로 스로틀링하여 잡음을 낮출 수 있습니다.

{{#ref}}
aws-lambda-async-self-loop-persistence.md
{{#endref}}

### AWS - Lambda Alias-Scoped Resource Policy Backdoor

공격자 로직을 담은 숨겨진 Lambda version을 생성하고 `lambda add-permission`에서 `--qualifier` 파라미터를 사용하여 해당 특정 version(또는 alias)에 리소스 기반 정책을 범위(scope) 지정하세요. 공격자 주체에 대해 `arn:aws:lambda:REGION:ACCT:function:FN:VERSION`에만 `lambda:InvokeFunction` 권한을 부여합니다. 함수 이름 또는 기본 alias를 통한 정상 호출은 영향을 받지 않으며, 공격자는 백도어된 version ARN을 직접 호출할 수 있습니다.

이 방법은 Function URL을 노출하는 것보다 은밀하며 주 트래픽 alias를 변경하지 않습니다.

{{#ref}}
aws-lambda-alias-version-policy-backdoor.md
{{#endref}}


{{#include ../../../../banners/hacktricks-training.md}}
