# AWS - Lambda Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

Para más información consulta:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Lambda Layer Persistence

Es posible **introduce/backdoor a layer to execute arbitrary code** cuando la lambda se ejecuta de forma sigilosa:

{{#ref}}
aws-lambda-layers-persistence.md
{{#endref}}

### Lambda Extension Persistence

Abusando de Lambda Layers también es posible abusar de extensions y persistir en la lambda, además de robar y modificar requests.

{{#ref}}
aws-abusing-lambda-extensions.md
{{#endref}}

### Via resource policies

Es posible conceder acceso a diferentes lambda actions (such as invoke or update code) a cuentas externas:

<figure><img src="../../../../images/image (255).png" alt=""><figcaption></figcaption></figure>

### Versions, Aliases & Weights

Una Lambda puede tener **diferentes versiones** (con diferente código en cada versión).\
Luego, puedes crear **diferentes aliases con diferentes versiones** de la lambda y asignar diferentes weights a cada una.\
De este modo un atacante podría crear una **backdoored version 1** y una **version 2 con solo el legit code** y **ejecutar solo la version 1 en 1%** de las requests para permanecer sigiloso.

<figure><img src="../../../../images/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Copy the original code of the Lambda
2. **Create a new version backdooring** the original code (or just with malicious code). Publish and **deploy that version** to $LATEST
1. Call the API gateway related to the lambda to execute the code
3. **Create a new version with the original code**, Publish and deploy that **version** to $LATEST.
1. This will hide the backdoored code in a previous version
4. Go to the API Gateway and **create a new POST method** (or choose any other method) that will execute the backdoored version of the lambda: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Note the final :1 of the arn **indicating the version of the function** (version 1 will be the backdoored one in this scenario).
5. Select the POST method created and in Actions select **`Deploy API`**
6. Now, when you **call the function via POST your Backdoor** will be invoked

### Cron/Event actuator

El hecho de que puedas hacer que las funciones lambda se ejecuten cuando ocurre algo o cuando pasa cierto tiempo hace de lambda una forma común y útil para obtener persistence y evitar la detección.\
Aquí tienes algunas ideas para hacer tu presencia en AWS más sigilosa creando lambdas.

- Cada vez que se crea un nuevo usuario, lambda genera una nueva user key y la envía al atacante.
- Cada vez que se crea un nuevo role, lambda da permisos de assume role a usuarios comprometidos.
- Cada vez que se generan nuevos cloudtrail logs, borrarlos/alterarlos

### RCE abusing AWS_LAMBDA_EXEC_WRAPPER + Lambda Layers

Abusa de la variable de entorno `AWS_LAMBDA_EXEC_WRAPPER` para ejecutar un script wrapper controlado por el atacante antes de que arranque el runtime/handler. Entrega el wrapper vía un Lambda Layer en `/opt/bin/htwrap`, configura `AWS_LAMBDA_EXEC_WRAPPER=/opt/bin/htwrap` y luego invoca la función. El wrapper se ejecuta dentro del proceso del runtime de la función, hereda el function execution role, y finalmente `exec`s el runtime real para que el handler original siga ejecutándose normalmente.

{{#ref}}
aws-lambda-exec-wrapper-persistence.md
{{#endref}}

### AWS - Lambda Function URL Public Exposure

Abusa de Lambda asynchronous destinations junto con la configuración de Recursion para hacer que una función se re-invoque continuamente sin un scheduler externo (no EventBridge, cron, etc.). Por defecto, Lambda termina loops recursivos, pero configurando recursion a Allow los vuelve a habilitar. Las destinations entregan en el lado del servicio para invocaciones async, así que una única seed invoke crea un canal sigiloso tipo heartbeat/backdoor sin código. Opcionalmente, limita con reserved concurrency para mantener el ruido bajo.

{{#ref}}
aws-lambda-async-self-loop-persistence.md
{{#endref}}

### AWS - Lambda Alias-Scoped Resource Policy Backdoor

Crea una version oculta de Lambda con lógica del atacante y aplica una resource-based policy a esa versión específica (o alias) usando el parámetro `--qualifier` en `lambda add-permission`. Otorga únicamente `lambda:InvokeFunction` sobre `arn:aws:lambda:REGION:ACCT:function:FN:VERSION` a un principal atacante. Las invocaciones normales vía el nombre de la función o el alias primario no se ven afectadas, mientras que el atacante puede invocar directamente el ARN de la versión backdoored.

Esto es más sigiloso que exponer una Function URL y no cambia el alias de tráfico primario.

{{#ref}}
aws-lambda-alias-version-policy-backdoor.md
{{#endref}}


{{#include ../../../../banners/hacktricks-training.md}}
