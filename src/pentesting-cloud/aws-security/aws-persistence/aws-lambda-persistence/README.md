# AWS - Lambda Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

Po więcej informacji sprawdź:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Lambda Layer Persistence

Możliwe jest **introduce/backdoor a layer to execute arbitrary code** gdy lambda jest uruchamiana w ukryty sposób:

{{#ref}}
aws-lambda-layers-persistence.md
{{#endref}}

### Lambda Extension Persistence

Nadużywając Lambda Layers można też wykorzystać extensions i persistować w lambda oraz kraść i modyfikować requests.

{{#ref}}
aws-abusing-lambda-extensions.md
{{#endref}}

### Via resource policies

Można przyznać dostęp do różnych lambda actions (takich jak invoke lub update code) zewnętrznym kontom:

<figure><img src="../../../../images/image (255).png" alt=""><figcaption></figcaption></figure>

### Versions, Aliases & Weights

A Lambda może mieć **different versions** (z innym code w każdej wersji).\
Następnie możesz utworzyć **different aliases with different versions** funkcji lambda i ustawić różne weights dla każdej.\
W ten sposób atakujący może stworzyć **backdoored version 1** i **version 2 z only the legit code** i **wykonywać version 1 tylko w 1%** żądań, aby pozostać stealth.

<figure><img src="../../../../images/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Skopiuj oryginalny code funkcji Lambda
2. **Create a new version backdooring** oryginalnego code (lub po prostu z malicious code). Opublikuj i **deploy that version** do $LATEST
1. Call the API gateway related to the lambda to execute the code
3. **Create a new version with the original code**, Publish and deploy that **version** to $LATEST.
1. This will hide the backdoored code in a previous version
4. Przejdź do API Gateway i **create a new POST method** (lub wybierz dowolną inną metodę), która wykona backdoored version funkcji lambda: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Note the final :1 of the arn **indicating the version of the function** (version 1 will be the backdoored one in this scenario).
5. Wybierz utworzoną metodę POST i w Actions wybierz **`Deploy API`**
6. Teraz, gdy **call the function via POST your Backdoor** zostanie wywołany

### Cron/Event actuator

Fakt, że można uruchamiać **lambda functions when something happen or when some time pass** sprawia, że lambda jest popularnym sposobem na uzyskanie persistence i unikanie wykrycia.\
Oto kilka pomysłów, jak uczynić swoją **presence in AWS more stealth by creating lambdas**.

- Za każdym razem, gdy utworzone zostanie nowe user, lambda generuje nowy user key i wysyła go do atakującego.
- Za każdym razem, gdy tworzona jest nowa rola, lambda przyznaje assume role permissions kompromitowanym użytkownikom.
- Za każdym razem, gdy generowane są nowe cloudtrail logs, usuń/zmodyfikuj je

### RCE abusing AWS_LAMBDA_EXEC_WRAPPER + Lambda Layers

Nadużyj zmiennej środowiskowej `AWS_LAMBDA_EXEC_WRAPPER`, aby wykonać kontrolowany przez atakującego wrapper script przed startem runtime/handlera. Dostarcz wrapper poprzez Lambda Layer w `/opt/bin/htwrap`, ustaw `AWS_LAMBDA_EXEC_WRAPPER=/opt/bin/htwrap`, a następnie wywołaj funkcję. Wrapper uruchamia się wewnątrz procesu runtime funkcji, dziedziczy function execution role i ostatecznie `exec`s rzeczywisty runtime, więc oryginalny handler nadal wykonuje się normalnie.

{{#ref}}
aws-lambda-exec-wrapper-persistence.md
{{#endref}}

### AWS - Lambda Function URL Public Exposure

Nadużyj Lambda asynchronous destinations razem z konfiguracją Recursion, aby funkcja stale ponownie wywoływała samą siebie bez zewnętrznego schedulera (bez EventBridge, cron itp.). Domyślnie Lambda przerywa pętle rekurencyjne, ale ustawienie recursion config na Allow ponownie je włącza. Destinations dostarczają po stronie usługi dla async invokes, więc pojedyncze seed invoke tworzy stealthy, code-free kanał heartbeat/backdoor. Opcjonalnie użyj reserved concurrency, aby ograniczyć hałas.

{{#ref}}
aws-lambda-async-self-loop-persistence.md
{{#endref}}

### AWS - Lambda Alias-Scoped Resource Policy Backdoor

Utwórz ukrytą Lambda version z logiką atakującego i scope resource-based policy do tej konkretnej version (lub aliasu) używając parametru `--qualifier` w `lambda add-permission`. Przyznaj tylko `lambda:InvokeFunction` na `arn:aws:lambda:REGION:ACCT:function:FN:VERSION` principalowi atakującego. Normalne wywołania przez nazwę funkcji lub primary alias pozostają bez zmian, podczas gdy atakujący może bezpośrednio wywołać backdoored version ARN.

Jest to bardziej stealth niż wystawienie Function URL i nie zmienia primary traffic alias.

{{#ref}}
aws-lambda-alias-version-policy-backdoor.md
{{#endref}}


{{#include ../../../../banners/hacktricks-training.md}}
