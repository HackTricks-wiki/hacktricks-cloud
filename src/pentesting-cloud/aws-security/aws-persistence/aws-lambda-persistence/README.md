# AWS - Lambda Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

Για περισσότερες πληροφορίες ελέγξτε:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Lambda Layer Persistence

Είναι δυνατόν να **εισαγάγετε/πίσω πόρτα μια layer για να εκτελέσετε αυθαίρετο κώδικα** όταν η lambda εκτελείται με stealth τρόπο:

{{#ref}}
aws-lambda-layers-persistence.md
{{#endref}}

### Lambda Extension Persistence

Καταχρώντας τις Lambda Layers είναι επίσης δυνατό να καταχραστείτε τις επεκτάσεις και να παραμείνετε στη lambda αλλά και να κλέψετε και να τροποποιήσετε αιτήματα.

{{#ref}}
aws-abusing-lambda-extensions.md
{{#endref}}

### Via resource policies

Είναι δυνατόν να παραχωρήσετε πρόσβαση σε διάφορες ενέργειες lambda (όπως invoke ή update code) σε εξωτερικούς λογαριασμούς:

<figure><img src="../../../../images/image (255).png" alt=""><figcaption></figcaption></figure>

### Versions, Aliases & Weights

Μια Lambda μπορεί να έχει **διαφορετικές εκδόσεις** (με διαφορετικό κώδικα σε κάθε έκδοση).\
Στη συνέχεια, μπορείτε να δημιουργήσετε **διαφορετικά aliases με διαφορετικές εκδόσεις** της lambda και να ορίσετε διαφορετικά βάρη σε κάθε μία.\
Με αυτόν τον τρόπο, ένας επιτιθέμενος θα μπορούσε να δημιουργήσει μια **πίσω πόρτα στην έκδοση 1** και μια **έκδοση 2 με μόνο τον νόμιμο κώδικα** και **να εκτελεί μόνο την έκδοση 1 στο 1%** των αιτημάτων για να παραμείνει stealth.

<figure><img src="../../../../images/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Αντιγράψτε τον αρχικό κώδικα της Lambda
2. **Δημιουργήστε μια νέα έκδοση πίσω πόρτας** του αρχικού κώδικα (ή απλώς με κακόβουλο κώδικα). Δημοσιεύστε και **αναπτύξτε αυτήν την έκδοση** στο $LATEST
1. Καλέστε την API gateway που σχετίζεται με τη lambda για να εκτελέσετε τον κώδικα
3. **Δημιουργήστε μια νέα έκδοση με τον αρχικό κώδικα**, Δημοσιεύστε και αναπτύξτε αυτήν την **έκδοση** στο $LATEST.
1. Αυτό θα κρύψει τον κώδικα πίσω πόρτας σε μια προηγούμενη έκδοση
4. Μεταβείτε στην API Gateway και **δημιουργήστε μια νέα μέθοδο POST** (ή επιλέξτε οποιαδήποτε άλλη μέθοδο) που θα εκτελεί την έκδοση πίσω πόρτας της lambda: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Σημειώστε το τελικό :1 του arn **που υποδεικνύει την έκδοση της συνάρτησης** (η έκδοση 1 θα είναι η πίσω πόρτα σε αυτό το σενάριο).
5. Επιλέξτε τη μέθοδο POST που δημιουργήθηκε και στις Ενέργειες επιλέξτε **`Deploy API`**
6. Τώρα, όταν **καλέσετε τη συνάρτηση μέσω POST η Πίσω Πόρτα σας** θα ενεργοποιηθεί

### Cron/Event actuator

Το γεγονός ότι μπορείτε να κάνετε **συναρτήσεις lambda να εκτελούνται όταν συμβαίνει κάτι ή όταν περνάει κάποιος χρόνος** καθιστά τη lambda έναν ωραίο και κοινό τρόπο για να αποκτήσετε επιμονή και να αποφύγετε την ανίχνευση.\
Εδώ έχετε μερικές ιδέες για να κάνετε την **παρουσία σας στο AWS πιο stealth δημιουργώντας lambdas**.

- Κάθε φορά που δημιουργείται ένας νέος χρήστης, η lambda δημιουργεί ένα νέο κλειδί χρήστη και το στέλνει στον επιτιθέμενο.
- Κάθε φορά που δημιουργείται ένας νέος ρόλος, η lambda δίνει δικαιώματα ανάληψης ρόλου σε συμβιβασμένους χρήστες.
- Κάθε φορά που δημιουργούνται νέα logs cloudtrail, διαγράψτε/τροποποιήστε τα

{{#include ../../../../banners/hacktricks-training.md}}
