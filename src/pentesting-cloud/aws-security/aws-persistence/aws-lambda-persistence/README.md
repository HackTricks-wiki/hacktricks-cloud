# AWS - Lambda Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

Aby uzyskać więcej informacji, zobacz:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Lambda Layer Persistence

Możliwe jest **introduce/backdoor a layer to execute arbitrary code** gdy Lambda jest uruchamiana w sposób stealthy:

{{#ref}}
aws-lambda-layers-persistence.md
{{#endref}}

### Lambda Extension Persistence

Nadużywając Lambda Layers można też wykorzystać extensions, aby persist w Lambda oraz steal i modify requests.

{{#ref}}
aws-abusing-lambda-extensions.md
{{#endref}}

### Via resource policies

Za pomocą polityk zasobów można nadać dostęp do różnych lambda actions (takich jak invoke lub update code) dla kont zewnętrznych:

<figure><img src="../../../../images/image (255).png" alt=""><figcaption></figcaption></figure>

### Versions, Aliases & Weights

Lambda może mieć **różne wersje** (z różnym kodem w każdej wersji).\
Następnie możesz utworzyć **różne aliasy z różnymi wersjami** Lambdy i ustawić różne wagi dla każdego.\
W ten sposób atakujący mógłby stworzyć **backdoored version 1** i **version 2 with only the legit code** oraz **only execute the version 1 in 1%** zapytań, aby pozostać stealth.

<figure><img src="../../../../images/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Sklonuj oryginalny kod Lambdy  
2. **Create a new version backdooring** oryginalnego kodu (lub tylko z złośliwym kodem). Publish i **deploy that version** do $LATEST  
1. Wywołaj API Gateway powiązany z Lambdą, aby uruchomić kod  
3. **Create a new version with the original code**, Publish i deploy that **version** do $LATEST.  
1. To ukryje backdoored code w poprzedniej wersji  
4. Przejdź do API Gateway i **create a new POST method** (lub wybierz inny method), która wykona backdoored version Lambdy: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`  
1. Zwróć uwagę na końcówkę :1 w ARN **indicating the version of the function** (version 1 będzie backdoored w tym scenariuszu).  
5. Wybierz utworzony POST method i w Actions wybierz **`Deploy API`**  
6. Teraz, gdy wywołasz funkcję przez POST, **your Backdoor** zostanie uruchomiony

### Cron/Event actuator

Możliwość uruchamiania **lambda functions run when something happen or when some time pass** sprawia, że Lambda jest popularnym sposobem na uzyskanie persistence i unikanie wykrycia.\
Poniżej kilka pomysłów, jak uczynić swoją **presence in AWS more stealth by creating lambdas**.

- Za każdym razem, gdy tworzone jest nowe konto użytkownika, lambda generuje nowy user key i wysyła go do atakującego.
- Za każdym razem, gdy tworzona jest nowa rola, lambda nadaje assume role permissions skompromitowanym użytkownikom.
- Za każdym razem, gdy generowane są nowe cloudtrail logs, usuń/zmodyfikuj je

### RCE abusing AWS_LAMBDA_EXEC_WRAPPER + Lambda Layers

Wykorzystaj zmienną środowiskową `AWS_LAMBDA_EXEC_WRAPPER`, aby uruchomić skrypt wrapper kontrolowany przez atakującego przed startem runtime/handlera. Dostarcz wrapper przez Lambda Layer w `/opt/bin/htwrap`, ustaw `AWS_LAMBDA_EXEC_WRAPPER=/opt/bin/htwrap`, a następnie invoke funkcję. Wrapper uruchamia się wewnątrz procesu runtime funkcji, dziedziczy function execution role i w końcu `exec`uje prawdziwy runtime, więc oryginalny handler nadal wykonuje się normalnie.

{{#ref}}
aws-lambda-exec-wrapper-persistence.md
{{#endref}}

### AWS - Lambda Function URL Public Exposure

Nadużyj Lambda asynchronous destinations razem z konfiguracją Recursion, aby funkcja ciągle re-invoke'owała sama siebie bez zewnętrznego scheduler'a (bez EventBridge, cron itd.). Domyślnie Lambda przerywa rekursywne pętle, ale ustawienie recursion config na Allow ponownie je włącza. Destinations deliver on the service side dla async invokes, więc jedno seed invoke tworzy stealthy, code-free heartbeat/backdoor channel. Opcjonalnie throttle z reserved concurrency, aby utrzymać niski noise.

{{#ref}}
aws-lambda-async-self-loop-persistence.md
{{#endref}}

### AWS - Lambda Alias-Scoped Resource Policy Backdoor

Stwórz ukrytą wersję Lambdy z logiką atakującego i ogranicz politykę opartą na zasobie do tej konkretnej wersji (lub aliasu) używając parametru `--qualifier` w `lambda add-permission`. Nadaj tylko `lambda:InvokeFunction` na `arn:aws:lambda:REGION:ACCT:function:FN:VERSION` dla principal atakującego. Normalne wywołania przez nazwę funkcji lub główny alias pozostają niezmienione, podczas gdy atakujący może bezpośrednio invoke'ować backdoored version ARN.

To jest bardziej stealthy niż expose Function URL i nie zmienia primary traffic alias.

{{#ref}}
aws-lambda-alias-version-policy-backdoor.md
{{#endref}}

### Freezing AWS Lambda Runtimes

Atakujący, który ma uprawnienia lambda:InvokeFunction, logs:FilterLogEvents, lambda:PutRuntimeManagementConfig oraz lambda:GetRuntimeManagementConfig może modyfikować runtime management configuration funkcji. Ten atak jest szczególnie skuteczny, gdy celem jest utrzymanie Lambdy na podatnej wersji runtime lub zachowanie kompatybilności z malicious layers, które mogą być niekompatybilne z nowszymi runtime'ami.

Atakujący modyfikuje runtime management configuration, aby przypiąć wersję runtime:
```bash
# Invoke the function to generate runtime logs
aws lambda invoke \
--function-name $TARGET_FN \
--payload '{}' \
--region us-east-1 /tmp/ping.json

sleep 5

# Freeze automatic runtime updates on function update
aws lambda put-runtime-management-config \
--function-name $TARGET_FN \
--update-runtime-on FunctionUpdate \
--region us-east-1
```
Zweryfikuj zastosowaną konfigurację:
```bash
aws lambda get-runtime-management-config \
--function-name $TARGET_FN \
--region us-east-1
```
Opcjonalnie: przypnij do konkretnej wersji runtime
```bash
# Extract Runtime Version ARN from INIT_START logs
RUNTIME_ARN=$(aws logs filter-log-events \
--log-group-name /aws/lambda/$TARGET_FN \
--filter-pattern "INIT_START" \
--query 'events[0].message' \
--output text | grep -o 'Runtime Version ARN: [^,]*' | cut -d' ' -f4)
```
Przypnij do konkretnej wersji runtime:
```bash
aws lambda put-runtime-management-config \
--function-name $TARGET_FN \
--update-runtime-on Manual \
--runtime-version-arn $RUNTIME_ARN \
--region us-east-1
```
{{#include ../../../../banners/hacktricks-training.md}}
