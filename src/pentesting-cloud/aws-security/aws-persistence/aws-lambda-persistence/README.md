# AWS - Lambda Kalıcılık

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

Daha fazla bilgi için bakın:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Lambda Layer Kalıcılığı

Lambda çalıştırıldığında gizlice arbitrary code çalıştırmak için bir layer introduce/backdoor etmek mümkündür:

{{#ref}}
aws-lambda-layers-persistence.md
{{#endref}}

### Lambda Extension Kalıcılığı

Lambda Layers'i kötüye kullanarak extensions'ları da suistimal etmek ve lambda içinde persist etmek, ayrıca istekleri çalmak ve değiştirmek mümkündür.

{{#ref}}
aws-abusing-lambda-extensions.md
{{#endref}}

### Via resource policies

Harici hesaplara farklı lambda eylemlerine (ör. invoke veya update code) erişim vermek mümkündür:

<figure><img src="../../../../images/image (255).png" alt=""><figcaption></figcaption></figure>

### Versiyonlar, Alias'lar & Ağırlıklar

Bir Lambda'nın **farklı versiyonları** olabilir (her versiyon farklı code ile).\
Daha sonra, lambda'nın **farklı versiyonlarıyla farklı aliases** oluşturabilir ve her birine farklı ağırlıklar atayabilirsiniz.\
Böylece bir saldırgan **backdoored version 1** oluşturup **sadece meşru code içeren version 2** oluşturabilir ve gizli kalmak için isteklerin yalnızca %1'inde version 1'i çalıştırabilir.

<figure><img src="../../../../images/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Lambda'nın orijinal code'unu kopyalayın
2. **Orijinal code'u backdooring yapan yeni bir version oluşturun** (veya sadece kötü amaçlı code ile). Yayınlayın ve bu **versiyonu** $LATEST'e deploy edin
1. Kodu çalıştırmak için lambda ile ilişkili API Gateway'i çağırın
3. **Orijinal code ile yeni bir versiyon oluşturun**, yayınlayın ve o **versiyonu** $LATEST'e deploy edin.
1. Bu, backdoored code'u önceki bir versiyonda gizleyecektir
4. API Gateway'e gidin ve backdoored versiyonu çalıştıracak yeni bir POST methodu oluşturun (veya başka bir method seçin): `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. ARN'in sonundaki :1'in **fonksiyon versiyonunu gösterdiğini** not edin (bu senaryoda version 1 backdoored olan olacaktır).
5. Oluşturulan POST metodunu seçin ve Actions'da **`Deploy API`**'yi seçin
6. Şimdi, POST ile fonksiyonu çağırdığınızda **Backdoor**'ınız tetiklenecektir

### Cron/Event tetikleyici

Lambda fonksiyonlarını bir şey olduğunda veya belirli zaman aralıklarında çalıştırabilme özelliği, Lambda'yı kalıcılık sağlama ve tespiti atlatma için yaygın bir yol yapar.\
İşte AWS içindeki varlığınızı daha gizli hale getirmek için lambda'lar oluşturarak kullanabileceğiniz bazı fikirler.

- Her yeni kullanıcı oluşturulduğunda lambda yeni bir kullanıcı anahtarı oluşturur ve bunu saldırgana gönderir.
- Her yeni role oluşturulduğunda lambda, ele geçirilmiş kullanıcılara assume role izinleri verir.
- Her yeni CloudTrail log'u oluşturulduğunda bunları silin/değiştirin

### RCE abusing AWS_LAMBDA_EXEC_WRAPPER + Lambda Layers

`AWS_LAMBDA_EXEC_WRAPPER` environment variable'ını kötüye kullanarak runtime/handler başlamadan önce saldırgan kontrollü bir wrapper script çalıştırın. Wrapper'ı bir Lambda Layer ile `/opt/bin/htwrap` yoluna dağıtın, `AWS_LAMBDA_EXEC_WRAPPER=/opt/bin/htwrap` olarak ayarlayın ve sonra fonksiyonu invoke edin. Wrapper fonksiyon runtime sürecinin içinde çalışır, fonksiyon execution role'unu miras alır ve sonunda gerçek runtime'ı `exec` eder; böylece orijinal handler normal şekilde çalışmaya devam eder.

{{#ref}}
aws-lambda-exec-wrapper-persistence.md
{{#endref}}

### AWS - Lambda Function URL Public Exposure

Lambda asynchronous destinations ile Recursion konfigürasyonunu birlikte kötüye kullanarak bir fonksiyonun harici bir scheduler olmadan (EventBridge, cron vb. olmadan) kendini sürekli yeniden invoke etmesini sağlayabilirsiniz. Varsayılan olarak Lambda recursive döngüleri sonlandırır, ancak recursion config'i Allow olarak ayarlamak bunları yeniden etkinleştirir. Destinations async invoke'lar için servis tarafında teslimat yapar, bu yüzden tek bir seed invoke kod gerektirmeyen, gizli bir heartbeat/backdoor kanalı oluşturur. Gürültüyü düşük tutmak için opsiyonel olarak reserved concurrency ile throttle edebilirsiniz.

{{#ref}}
aws-lambda-async-self-loop-persistence.md
{{#endref}}

### AWS - Lambda Alias-Scoped Resource Policy Backdoor

Saldırgan mantığı içeren gizli bir Lambda versiyonu oluşturun ve `lambda add-permission`'daki `--qualifier` parametresini kullanarak kaynak-temelli bir policy'yi o belirli versiyona (veya alias'a) uygulayın. Saldırgan principal'a sadece `lambda:InvokeFunction` iznini `arn:aws:lambda:REGION:ACCT:function:FN:VERSION` üzerinde verin. Fonksiyon adı veya birincil alias üzerinden yapılan normal invokasyonlar etkilenmezken, saldırgan backdoored versiyonun ARN'ini doğrudan invoke edebilir.

Bu, bir Function URL'i açmaktan daha gizlidir ve birincil trafik alias'ını değiştirmez.

{{#ref}}
aws-lambda-alias-version-policy-backdoor.md
{{#endref}}

### Freezing AWS Lambda Runtimes

Lambda'ya lambda:InvokeFunction, logs:FilterLogEvents, lambda:PutRuntimeManagementConfig ve lambda:GetRuntimeManagementConfig izinlerine sahip bir saldırgan, bir fonksiyonun runtime management configuration'ını değiştirebilir. Bu saldırı, Lambda fonksiyonunu zafiyetli bir runtime versiyonunda tutmak veya yeni runtimelerle uyumsuz olabilecek kötü amaçlı layer'larla uyumluluğu korumak amacıyla özellikle etkilidir.

Saldırgan runtime yönetim konfigürasyonunu runtime versiyonunu pinlemek için değiştirir:
```bash
# Invoke the function to generate runtime logs
aws lambda invoke \
--function-name $TARGET_FN \
--payload '{}' \
--region us-east-1 /tmp/ping.json

sleep 5

# Freeze automatic runtime updates on function update
aws lambda put-runtime-management-config \
--function-name $TARGET_FN \
--update-runtime-on FunctionUpdate \
--region us-east-1
```
Uygulanan yapılandırmayı doğrulayın:
```bash
aws lambda get-runtime-management-config \
--function-name $TARGET_FN \
--region us-east-1
```
İsteğe bağlı: Belirli bir runtime sürümüne sabitle
```bash
# Extract Runtime Version ARN from INIT_START logs
RUNTIME_ARN=$(aws logs filter-log-events \
--log-group-name /aws/lambda/$TARGET_FN \
--filter-pattern "INIT_START" \
--query 'events[0].message' \
--output text | grep -o 'Runtime Version ARN: [^,]*' | cut -d' ' -f4)
```
Belirli bir çalışma zamanı sürümüne sabitle:
```bash
aws lambda put-runtime-management-config \
--function-name $TARGET_FN \
--update-runtime-on Manual \
--runtime-version-arn $RUNTIME_ARN \
--region us-east-1
```
{{#include ../../../../banners/hacktricks-training.md}}
