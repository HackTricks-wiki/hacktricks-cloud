# AWS - Lambda Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

자세한 내용은 다음을 확인하세요:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Lambda Layer Persistence

Lambda가 실행될 때 은밀하게 **introduce/backdoor a layer to execute arbitrary code** 하는 레이어를 추가(백도어)할 수 있습니다:

{{#ref}}
aws-lambda-layers-persistence.md
{{#endref}}

### Lambda Extension Persistence

Lambda Layers를 악용하면 extensions를 악용해 Lambda에 persistence를 확보하고 요청을 훔치거나 수정할 수도 있습니다.

{{#ref}}
aws-abusing-lambda-extensions.md
{{#endref}}

### Via resource policies

외부 계정에 대해 invoke나 update code 같은 다양한 Lambda 액션에 대한 접근을 부여할 수 있습니다:

<figure><img src="../../../../images/image (255).png" alt=""><figcaption></figcaption></figure>

### Versions, Aliases & Weights

Lambda는 각기 다른 코드가 들어갈 수 있는 **여러 버전**을 가질 수 있습니다.  
그런 다음 서로 다른 버전을 가리키는 **여러 aliases**를 만들고 각 alias에 **weights**를 설정할 수 있습니다.  
이렇게 하면 공격자는 **backdoored version 1**과 **version 2 with only the legit code**를 만들고 요청의 1%에서만 **execute the version 1** 하도록 설정해 은밀하게 활동할 수 있습니다.

<figure><img src="../../../../images/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Lambda의 원본 코드를 복사합니다.
2. **Create a new version backdooring** the original code (or just with malicious code). Publish하고 **deploy that version**을 $LATEST로 합니다.
1. 관련된 API Gateway를 호출해 코드를 실행합니다.
3. **Create a new version with the original code**, Publish하고 해당 **version**을 $LATEST로 deploy합니다.
1. 이렇게 하면 백도어가 포함된 코드는 이전 버전에 숨겨집니다.
4. API Gateway로 이동해 백도어 버전의 Lambda를 실행할 **새 POST 메서드**(또는 다른 메서드)를 생성합니다: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. ARN의 끝 :1은 **함수의 버전**을 나타냅니다(이 시나리오에서 버전 1이 백도어 버전입니다).
5. 생성한 POST 메서드를 선택하고 Actions에서 **`Deploy API`**를 선택합니다.
6. 이제 POST로 함수를 호출하면 **당신의 Backdoor**가 호출됩니다.

### Cron/Event actuator

무언가가 발생하거나 일정 시간이 지나면 **Lambda 함수를 실행할 수 있다는 점**은 persistence를 얻고 탐지를 피하기 위한 일반적인 방법으로 Lambda를 유용하게 만듭니다.  
아래는 AWS에서의 존재를 더 은밀하게 하기 위해 Lambda를 생성할 때의 아이디어들입니다.

- 새 사용자가 생성될 때마다 Lambda가 새 사용자 키를 생성하고 공격자에게 전송합니다.
- 새 역할이 생성될 때마다 Lambda가 손상된 사용자에게 assume role 권한을 부여합니다.
- 새 CloudTrail 로그가 생성될 때마다 이를 삭제/변경합니다

### RCE abusing AWS_LAMBDA_EXEC_WRAPPER + Lambda Layers

환경 변수 `AWS_LAMBDA_EXEC_WRAPPER`를 악용하여 runtime/handler가 시작되기 전에 공격자가 제어하는 wrapper 스크립트를 실행하세요. Wrapper를 Lambda Layer로 `/opt/bin/htwrap`에 전달하고 `AWS_LAMBDA_EXEC_WRAPPER=/opt/bin/htwrap`로 설정한 뒤 함수를 호출합니다. Wrapper는 함수 런타임 프로세스 내에서 실행되며 함수 실행 역할(role)을 상속하고, 마지막에 실제 런타임을 `exec`하여 원래 핸들러가 정상적으로 실행되도록 합니다.

{{#ref}}
aws-lambda-exec-wrapper-persistence.md
{{#endref}}

### AWS - Lambda Function URL Public Exposure

Lambda의 asynchronous destinations와 Recursion 설정을 함께 악용해 외부 스케줄러(EventBridge, cron 등) 없이 함수가 스스로 지속적으로 재호출되게 만들 수 있습니다. 기본적으로 Lambda는 재귀 루프를 종료하지만, recursion 설정을 Allow로 변경하면 이를 다시 활성화할 수 있습니다. Destinations는 async invoke에 대해 서비스 측에서 전달되므로, 단 한 번의 seed invoke만으로 코드 없는 은밀한 heartbeat/backdoor 채널을 만들 수 있습니다. 원치 않는 소음을 줄이려면 reserved concurrency로 쓰로틀링할 수 있습니다.

{{#ref}}
aws-lambda-async-self-loop-persistence.md
{{#endref}}

### AWS - Lambda Alias-Scoped Resource Policy Backdoor

공격자 로직을 담은 숨겨진 Lambda 버전을 생성하고 `lambda add-permission`의 `--qualifier` 파라미터를 사용해 해당 특정 버전(또는 alias)에 리소스 기반 정책을 적용하세요. 공격자 주체에 대해 `arn:aws:lambda:REGION:ACCT:function:FN:VERSION`에 대해 `lambda:InvokeFunction`만 부여합니다. 함수 이름이나 기본 alias를 통한 정상 호출은 영향을 받지 않으며, 공격자는 백도어가 있는 버전 ARN을 직접 호출할 수 있습니다.

이는 Function URL을 노출하는 것보다 더 은밀하며 기본 트래픽 alias를 변경하지 않습니다.

{{#ref}}
aws-lambda-alias-version-policy-backdoor.md
{{#endref}}

### Freezing AWS Lambda Runtimes

lambda:InvokeFunction, logs:FilterLogEvents, lambda:PutRuntimeManagementConfig, lambda:GetRuntimeManagementConfig 권한을 가진 공격자는 함수의 runtime management configuration을 수정할 수 있습니다. 이 공격은 특히 Lambda 함수를 취약한 런타임 버전에 고정하거나 최신 런타임과 호환되지 않을 수 있는 악성 레이어와의 호환성을 유지하려는 경우에 효과적입니다.

공격자는 runtime management configuration을 수정하여 런타임 버전을 고정합니다:
```bash
# Invoke the function to generate runtime logs
aws lambda invoke \
--function-name $TARGET_FN \
--payload '{}' \
--region us-east-1 /tmp/ping.json

sleep 5

# Freeze automatic runtime updates on function update
aws lambda put-runtime-management-config \
--function-name $TARGET_FN \
--update-runtime-on FunctionUpdate \
--region us-east-1
```
적용된 구성을 확인하세요:
```bash
aws lambda get-runtime-management-config \
--function-name $TARGET_FN \
--region us-east-1
```
선택 사항: 특정 런타임 버전으로 고정
```bash
# Extract Runtime Version ARN from INIT_START logs
RUNTIME_ARN=$(aws logs filter-log-events \
--log-group-name /aws/lambda/$TARGET_FN \
--filter-pattern "INIT_START" \
--query 'events[0].message' \
--output text | grep -o 'Runtime Version ARN: [^,]*' | cut -d' ' -f4)
```
특정 런타임 버전으로 고정:
```bash
aws lambda put-runtime-management-config \
--function-name $TARGET_FN \
--update-runtime-on Manual \
--runtime-version-arn $RUNTIME_ARN \
--region us-east-1
```
{{#include ../../../../banners/hacktricks-training.md}}
