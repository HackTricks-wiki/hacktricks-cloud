# AWS - Lambda Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

Для додаткової інформації див.:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Lambda Layer Persistence

Можна **introduce/backdoor a layer to execute arbitrary code** коли Lambda виконується в прихованому режимі:

{{#ref}}
aws-lambda-layers-persistence.md
{{#endref}}

### Lambda Extension Persistence

Abusing Lambda Layers також можливо зловживати extensions і persist в Lambda, а також steal та modify requests.

{{#ref}}
aws-abusing-lambda-extensions.md
{{#endref}}

### Via resource policies

Можна надати доступ до різних дій Lambda (такі як invoke або update code) зовнішнім акаунтам:

<figure><img src="../../../../images/image (255).png" alt=""><figcaption></figcaption></figure>

### Versions, Aliases & Weights

Lambda може мати **different versions** (кожна версія з різним кодом).\
Далі можна створити **different aliases with different versions** функції та задати різні weights для кожного.\
Таким чином атакуючий може створити **backdoored version 1** і **version 2 with only the legit code** і **only execute the version 1 in 1%** запитів, щоб залишатися stealth.

<figure><img src="../../../../images/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Copy the original code of the Lambda
2. **Create a new version backdooring** the original code (or just with malicious code). Publish and **deploy that version** to $LATEST
1. Call the API gateway related to the lambda to execute the code
3. **Create a new version with the original code**, Publish and deploy that **version** to $LATEST.
1. This will hide the backdoored code in a previous version
4. Go to the API Gateway and **create a new POST method** (or choose any other method) that will execute the backdoored version of the lambda: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Note the final :1 of the arn **indicating the version of the function** (version 1 will be the backdoored one in this scenario).
5. Select the POST method created and in Actions select **`Deploy API`**
6. Now, when you **call the function via POST your Backdoor** will be invoked

### Cron/Event actuator

Те, що можна змусити **lambda functions run when something happen or when some time pass**, робить Lambda зручною і поширеною технікою для отримання persistence та уникнення детекції.\
Ось кілька ідей, як зробити вашу **presence in AWS more stealth by creating lambdas**.

- Every time a new user is created lambda generates a new user key and send it to the attacker.
- Every time a new role is created lambda gives assume role permissions to compromised users.
- Every time new cloudtrail logs are generated, delete/alter them

### RCE abusing AWS_LAMBDA_EXEC_WRAPPER + Lambda Layers

Зловживання environment variable `AWS_LAMBDA_EXEC_WRAPPER` дозволяє виконати wrapper-скрипт під контролем атакуючого перед запуском runtime/handler. Доставте wrapper через Lambda Layer у `/opt/bin/htwrap`, встановіть `AWS_LAMBDA_EXEC_WRAPPER=/opt/bin/htwrap`, а потім викличте функцію. Wrapper виконується всередині процесу runtime функції, успадковує function execution role і вкінці `exec`'ує реальний runtime так, щоб оригінальний handler все ще виконувався нормально.

{{#ref}}
aws-lambda-exec-wrapper-persistence.md
{{#endref}}

### AWS - Lambda Function URL Public Exposure

Abuse Lambda asynchronous destinations разом із Recursion configuration дозволяє змусити функцію постійно перевикликати себе без зовнішнього планувальника (без EventBridge, cron тощо). За замовчуванням Lambda припиняє recursive loops, але встановлення recursion config на Allow знову їх вмикає. Destinations доставляють на стороні сервісу для async invokes, тож один seed invoke створює stealthy, code-free heartbeat/backdoor канал. Опційно обмежуйте через reserved concurrency, щоб зменшити шум.

{{#ref}}
aws-lambda-async-self-loop-persistence.md
{{#endref}}

### AWS - Lambda Alias-Scoped Resource Policy Backdoor

Створіть приховану Lambda version з логікою атакуючого і scope-ніть resource-based policy на цю конкретну версію (або alias) використовуючи параметр `--qualifier` в `lambda add-permission`. Надайте лише `lambda:InvokeFunction` на `arn:aws:lambda:REGION:ACCT:function:FN:VERSION` для принципала атакуючого. Звичайні виклики через ім'я функції або primary alias лишаються незмінними, тоді як атакуючий може напряму викликати backdoored version ARN.

Це stealthier ніж exposure через Function URL і не змінює primary traffic alias.

{{#ref}}
aws-lambda-alias-version-policy-backdoor.md
{{#endref}}


{{#include ../../../../banners/hacktricks-training.md}}
