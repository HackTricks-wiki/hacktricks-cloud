# AWS - Lambda Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

有关更多信息，请查看：

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Lambda Layer Persistence

可以**引入/后门一个层以在隐秘的方式下执行任意代码**，当lambda被执行时：

{{#ref}}
aws-lambda-layers-persistence.md
{{#endref}}

### Lambda Extension Persistence

利用Lambda Layers，也可以利用扩展并在lambda中持久化，同时窃取和修改请求。

{{#ref}}
aws-abusing-lambda-extensions.md
{{#endref}}

### 通过资源策略

可以授予外部账户对不同lambda操作（如调用或更新代码）的访问权限：

<figure><img src="../../../../images/image (255).png" alt=""><figcaption></figcaption></figure>

### 版本、别名和权重

一个Lambda可以有**不同的版本**（每个版本有不同的代码）。\
然后，您可以创建**不同版本的不同别名**并为每个设置不同的权重。\
这样，攻击者可以创建一个**后门版本1**和一个**仅包含合法代码的版本2**，并**仅在1%的请求中执行版本1**以保持隐秘。

<figure><img src="../../../../images/image (120).png" alt=""><figcaption></figcaption></figure>

### 版本后门 + API Gateway

1. 复制Lambda的原始代码
2. **创建一个新的版本，后门化**原始代码（或仅包含恶意代码）。发布并**将该版本部署**到$LATEST
1. 调用与lambda相关的API网关以执行代码
3. **创建一个包含原始代码的新版本**，发布并将该**版本**部署到$LATEST。
1. 这将隐藏之前版本中的后门代码
4. 转到API Gateway并**创建一个新的POST方法**（或选择任何其他方法），该方法将执行lambda的后门版本：`arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. 注意arn的最后部分：1 **指示函数的版本**（在此场景中，版本1将是后门版本）。
5. 选择创建的POST方法，在操作中选择**`部署API`**
6. 现在，当您**通过POST调用函数时，您的后门**将被调用

### Cron/Event actuator

您可以使**lambda函数在某些事件发生或经过一段时间后运行**，这使得lambda成为获得持久性和避免检测的良好且常见的方法。\
在这里，您有一些想法，可以通过创建lambdas使您的**AWS存在更加隐秘**。

- 每当创建新用户时，lambda生成一个新用户密钥并将其发送给攻击者。
- 每当创建新角色时，lambda授予被攻陷用户假设角色的权限。
- 每当生成新的cloudtrail日志时，删除/更改它们。

{{#include ../../../../banners/hacktricks-training.md}}
