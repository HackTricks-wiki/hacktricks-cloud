# AWS - Lambda Persistensie

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

Vir meer inligting, kyk:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Lambda Laag Persistensie

Dit is moontlik om **'n laag in te voer/terugdeur te maak om arbitrêre kode uit te voer** wanneer die lambda op 'n stil manier uitgevoer word:

{{#ref}}
aws-lambda-layers-persistence.md
{{#endref}}

### Lambda Uitbreiding Persistensie

Deur Lambda Lae te misbruik, is dit ook moontlik om uitbreidings te misbruik en in die lambda te bly, maar ook versoeke te steel en te wysig.

{{#ref}}
aws-abusing-lambda-extensions.md
{{#endref}}

### Deur hulpbronbeleide

Dit is moontlik om toegang tot verskillende lambda aksies (soos aanroep of kode opdateer) aan eksterne rekeninge te verleen:

<figure><img src="../../../../images/image (255).png" alt=""><figcaption></figcaption></figure>

### Weergawes, Aliasse & Gewigte

'n Lambda kan **verskillende weergawes** hê (met verskillende kode in elke weergawe).\
Dan kan jy **verskillende aliasse met verskillende weergawes** van die lambda skep en verskillende gewigte aan elkeen toeken.\
Op hierdie manier kan 'n aanvaller 'n **terugdeur weergawe 1** en 'n **weergave 2 met slegs die wettige kode** skep en **slegs die weergawe 1 in 1%** van die versoeke uitvoer om stil te bly.

<figure><img src="../../../../images/image (120).png" alt=""><figcaption></figcaption></figure>

### Weergave Terugdeur + API Gateway

1. Kopieer die oorspronklike kode van die Lambda
2. **Skep 'n nuwe weergawe wat die** oorspronklike kode terugdeur maak (of net met kwaadwillige kode). Publiseer en **ontplooi daardie weergawe** na $LATEST
1. Roep die API-gateway wat met die lambda verband hou aan om die kode uit te voer
3. **Skep 'n nuwe weergawe met die oorspronklike kode**, Publiseer en ontplooi daardie **weergave** na $LATEST.
1. Dit sal die terugdeurkode in 'n vorige weergawe verberg
4. Gaan na die API Gateway en **skep 'n nuwe POST-metode** (of kies enige ander metode) wat die terugdeur weergawe van die lambda sal uitvoer: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Let op die finale :1 van die arn **wat die weergawe van die funksie aandui** (weergave 1 sal die terugdeur een in hierdie scenario wees).
5. Kies die POST-metode wat geskep is en in Aksies kies **`Ontplooi API`**
6. Nou, wanneer jy **die funksie via POST aanroep, sal jou Terugdeur** geaktiveer word

### Cron/Event aktuator

Die feit dat jy **lambda funksies kan laat loop wanneer iets gebeur of wanneer 'n tyd verbygaan** maak lambda 'n goeie en algemene manier om volharding te verkry en opsporing te vermy.\
Hier is 'n paar idees om jou **teenwoordigheid in AWS meer stil te maak deur lambdas** te skep.

- Elke keer wanneer 'n nuwe gebruiker geskep word, genereer lambda 'n nuwe gebruikerssleutel en stuur dit na die aanvaller.
- Elke keer wanneer 'n nuwe rol geskep word, gee lambda aanneemrol toestemmings aan gecompromitteerde gebruikers.
- Elke keer wanneer nuwe cloudtrail logs gegenereer word, verwyder/wysig hulle

{{#include ../../../../banners/hacktricks-training.md}}
