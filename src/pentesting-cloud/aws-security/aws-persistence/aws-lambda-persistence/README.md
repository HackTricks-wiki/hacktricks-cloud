# AWS - Persistência do Lambda

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

Para mais informações, consulte:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Persistência da Camada do Lambda

É possível **introduzir/backdoor uma camada para executar código arbitrário** quando o lambda é executado de forma furtiva:

{{#ref}}
aws-lambda-layers-persistence.md
{{#endref}}

### Persistência da Extensão do Lambda

Abusando das Camadas do Lambda, também é possível abusar das extensões e persistir no lambda, mas também roubar e modificar solicitações.

{{#ref}}
aws-abusing-lambda-extensions.md
{{#endref}}

### Via políticas de recursos

É possível conceder acesso a diferentes ações do lambda (como invocar ou atualizar código) a contas externas:

<figure><img src="../../../../images/image (255).png" alt=""><figcaption></figcaption></figure>

### Versões, Aliases & Pesos

Um Lambda pode ter **diferentes versões** (com código diferente em cada versão).\
Então, você pode criar **diferentes aliases com diferentes versões** do lambda e definir pesos diferentes para cada um.\
Dessa forma, um atacante poderia criar uma **versão 1 com backdoor** e uma **versão 2 com apenas o código legítimo** e **executar apenas a versão 1 em 1%** das solicitações para permanecer furtivo.

<figure><img src="../../../../images/image (120).png" alt=""><figcaption></figcaption></figure>

### Backdoor de Versão + API Gateway

1. Copie o código original do Lambda
2. **Crie uma nova versão backdooring** o código original (ou apenas com código malicioso). Publique e **implante essa versão** em $LATEST
1. Chame o API gateway relacionado ao lambda para executar o código
3. **Crie uma nova versão com o código original**, publique e implante essa **versão** em $LATEST.
1. Isso ocultará o código com backdoor em uma versão anterior
4. Vá para o API Gateway e **crie um novo método POST** (ou escolha qualquer outro método) que executará a versão com backdoor do lambda: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Observe o final :1 do arn **indicando a versão da função** (a versão 1 será a com backdoor neste cenário).
5. Selecione o método POST criado e em Ações selecione **`Implantar API`**
6. Agora, quando você **chamar a função via POST, seu Backdoor** será invocado

### Ativador Cron/Event

O fato de que você pode fazer **funções lambda serem executadas quando algo acontece ou quando algum tempo passa** torna o lambda uma maneira agradável e comum de obter persistência e evitar detecção.\
Aqui estão algumas ideias para tornar sua **presença na AWS mais furtiva criando lambdas**.

- Sempre que um novo usuário é criado, o lambda gera uma nova chave de usuário e a envia para o atacante.
- Sempre que um novo papel é criado, o lambda concede permissões de assumir papel a usuários comprometidos.
- Sempre que novos logs do cloudtrail são gerados, exclua/alterar eles.

{{#include ../../../../banners/hacktricks-training.md}}
