# AWS - Lambda Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

Para más información consulta:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Lambda Layer Persistence

Es posible **introduce/backdoor a layer to execute arbitrary code** cuando la lambda se ejecuta de forma sigilosa:

{{#ref}}
aws-lambda-layers-persistence.md
{{#endref}}

### Lambda Extension Persistence

Abusando de Lambda Layers también es posible abusar de extensions y persistir en la Lambda, además de robar y modificar requests.

{{#ref}}
aws-abusing-lambda-extensions.md
{{#endref}}

### Via resource policies

Es posible otorgar acceso a diferentes acciones de lambda (tales como invoke o update code) a cuentas externas:

<figure><img src="../../../../images/image (255).png" alt=""><figcaption></figcaption></figure>

### Versions, Aliases & Weights

A Lambda can have **different versions** (with different code each version).\
Then, you can create **different aliases with different versions** of the lambda and set different weights to each.\
This way an attacker could create a **backdoored version 1** and a **version 2 with only the legit code** and **only execute the version 1 in 1%** of the requests to remain stealth.

<figure><img src="../../../../images/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Copy the original code of the Lambda
2. **Create a new version backdooring** the original code (or just with malicious code). Publish and **deploy that version** to $LATEST
1. Call the API gateway related to the lambda to execute the code
3. **Create a new version with the original code**, Publish and deploy that **version** to $LATEST.
1. This will hide the backdoored code in a previous version
4. Go to the API Gateway and **create a new POST method** (or choose any other method) that will execute the backdoored version of the lambda: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Note the final :1 of the arn **indicating the version of the function** (version 1 will be the backdoored one in this scenario).
5. Select the POST method created and in Actions select **`Deploy API`**
6. Now, when you **call the function via POST your Backdoor** will be invoked

### Cron/Event actuator

El hecho de que puedas hacer que las funciones Lambda se ejecuten cuando ocurre algo o cuando pasa cierto tiempo convierte a Lambda en una forma común para obtener persistencia y evitar la detección.\
Aquí tienes algunas ideas para hacer tu presencia en AWS más sigilosa creando Lambdas.

- Cada vez que se crea un usuario nuevo, una Lambda genera una nueva clave de usuario y la envía al atacante.
- Cada vez que se crea un rol nuevo, una Lambda otorga permisos de assume role a usuarios comprometidos.
- Cada vez que se generan nuevos cloudtrail logs, eliminarlos/alterarlos

### RCE abusing AWS_LAMBDA_EXEC_WRAPPER + Lambda Layers

Abusa de la variable de entorno `AWS_LAMBDA_EXEC_WRAPPER` para ejecutar un script wrapper controlado por el atacante antes de que arranque el runtime/handler. Provee el wrapper mediante una Lambda Layer en `/opt/bin/htwrap`, configura `AWS_LAMBDA_EXEC_WRAPPER=/opt/bin/htwrap`, y luego invoca la función. El wrapper se ejecuta dentro del proceso runtime de la función, hereda el role de ejecución de la función y finalmente `exec`s el runtime real para que el handler original siga ejecutándose normalmente.

{{#ref}}
aws-lambda-exec-wrapper-persistence.md
{{#endref}}

### AWS - Lambda Function URL Public Exposure

Abusa de Lambda asynchronous destinations junto con la configuración de Recursion para hacer que una función se reinvoque continuamente sin un scheduler externo (no EventBridge, cron, etc.). Por defecto, Lambda termina loops recursivos, pero configurar recursion a Allow los vuelve a habilitar. Las destinations entregan en el lado del servicio para invocaciones async, por lo que una única invocación semilla crea un canal de heartbeat/backdoor sigiloso y sin código. Opcionalmente limita con reserved concurrency para mantener el ruido bajo.

{{#ref}}
aws-lambda-async-self-loop-persistence.md
{{#endref}}

### AWS - Lambda Alias-Scoped Resource Policy Backdoor

Crea una versión oculta de la Lambda con lógica del atacante y scopea una resource-based policy a esa versión específica (o alias) usando el parámetro `--qualifier` en `lambda add-permission`. Concede solo `lambda:InvokeFunction` sobre `arn:aws:lambda:REGION:ACCT:function:FN:VERSION` a un principal atacante. Las invocaciones normales vía el nombre de la función o el alias principal permanecen sin afectar, mientras que el atacante puede invocar directamente el ARN de la versión backdoored.

This is stealthier than exposing a Function URL and doesn’t change the primary traffic alias.

{{#ref}}
aws-lambda-alias-version-policy-backdoor.md
{{#endref}}

### Freezing AWS Lambda Runtimes

An attacker who has lambda:InvokeFunction, logs:FilterLogEvents, lambda:PutRuntimeManagementConfig, and lambda:GetRuntimeManagementConfig permissions can modify a function’s runtime management configuration. This attack is especially effective when the goal is to keep a Lambda function on a vulnerable runtime version or to preserve compatibility with malicious layers that might be incompatible with newer runtimes.

The attacker modifies the runtime management configuration to pin the runtime version:
```bash
# Invoke the function to generate runtime logs
aws lambda invoke \
--function-name $TARGET_FN \
--payload '{}' \
--region us-east-1 /tmp/ping.json

sleep 5

# Freeze automatic runtime updates on function update
aws lambda put-runtime-management-config \
--function-name $TARGET_FN \
--update-runtime-on FunctionUpdate \
--region us-east-1
```
Verifica la configuración aplicada:
```bash
aws lambda get-runtime-management-config \
--function-name $TARGET_FN \
--region us-east-1
```
Opcional: Fijar una versión específica del entorno de ejecución
```bash
# Extract Runtime Version ARN from INIT_START logs
RUNTIME_ARN=$(aws logs filter-log-events \
--log-group-name /aws/lambda/$TARGET_FN \
--filter-pattern "INIT_START" \
--query 'events[0].message' \
--output text | grep -o 'Runtime Version ARN: [^,]*' | cut -d' ' -f4)
```
Fijar a una versión específica del runtime:
```bash
aws lambda put-runtime-management-config \
--function-name $TARGET_FN \
--update-runtime-on Manual \
--runtime-version-arn $RUNTIME_ARN \
--region us-east-1
```
{{#include ../../../../banners/hacktricks-training.md}}
