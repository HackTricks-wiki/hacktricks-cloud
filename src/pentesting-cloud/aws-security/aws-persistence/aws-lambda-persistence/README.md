# AWS - Lambda Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

Για περισσότερες πληροφορίες δείτε:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Lambda Layer Persistence

Είναι δυνατό να **introduce/backdoor a layer to execute arbitrary code** όταν η Lambda εκτελείται με τρόπο stealthy:

{{#ref}}
aws-lambda-layers-persistence.md
{{#endref}}

### Lambda Extension Persistence

Abusing Lambda Layers είναι επίσης δυνατό να abuse extensions και να persist μέσα στη Lambda αλλά και να κλέψετε/τροποποιήσετε requests.

{{#ref}}
aws-abusing-lambda-extensions.md
{{#endref}}

### Via resource policies

Είναι δυνατό να χορηγηθεί πρόσβαση σε διαφορετικές lambda actions (όπως invoke ή update code) σε εξωτερικούς λογαριασμούς:

<figure><img src="../../../../images/image (255).png" alt=""><figcaption></figcaption></figure>

### Versions, Aliases & Weights

Ένα Lambda μπορεί να έχει **διαφορετικές versions** (με διαφορετικό code σε κάθε version).\
Στη συνέχεια, μπορείτε να δημιουργήσετε **διαφορετικά aliases με διαφορετικές versions** του Lambda και να ορίσετε διαφορετικά weights σε κάθε ένα.\
Με αυτόν τον τρόπο ένας attacker θα μπορούσε να δημιουργήσει ένα **backdoored version 1** και ένα **version 2 με μόνο το legit code** και να **εκτελεί το version 1 μόνο στο 1%** των requests για να παραμείνει stealth.

<figure><img src="../../../../images/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Copy the original code of the Lambda
2. **Create a new version backdooring** the original code (or just with malicious code). Publish and **deploy that version** to $LATEST
1. Call the API gateway related to the lambda to execute the code
3. **Create a new version with the original code**, Publish and deploy that **version** to $LATEST.
1. This will hide the backdoored code in a previous version
4. Go to the API Gateway and **create a new POST method** (or choose any other method) that will execute the backdoored version of the lambda: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Note the final :1 of the arn **indicating the version of the function** (version 1 will be the backdoored one in this scenario).
5. Select the POST method created and in Actions select **`Deploy API`**
6. Now, when you **call the function via POST your Backdoor** will be invoked

### Cron/Event actuator

Το ότι μπορείτε να κάνετε **lambda functions run when something happen or when some time pass** καθιστά τη Lambda έναν βολικό και κοινό τρόπο για να αποκτήσετε persistence και να αποφύγετε την ανίχνευση.\
Εδώ έχετε μερικές ιδέες για να κάνετε την **presence in AWS more stealth by creating lambdas**.

- Every time a new user is created lambda generates a new user key and send it to the attacker.
- Every time a new role is created lambda gives assume role permissions to compromised users.
- Every time new cloudtrail logs are generated, delete/alter them

### RCE abusing AWS_LAMBDA_EXEC_WRAPPER + Lambda Layers

Abuse the environment variable `AWS_LAMBDA_EXEC_WRAPPER` για να εκτελέσετε ένα attacker-controlled wrapper script πριν ξεκινήσει το runtime/handler. Παραδώστε το wrapper μέσω ενός Lambda Layer στο `/opt/bin/htwrap`, ορίστε `AWS_LAMBDA_EXEC_WRAPPER=/opt/bin/htwrap`, και στη συνέχεια invoke τη function. Το wrapper τρέχει μέσα στη διαδικασία του function runtime, κληρονομεί το function execution role, και τελικά `exec`-άρει το πραγματικό runtime ώστε ο αρχικός handler να εκτελεστεί κανονικά.

{{#ref}}
aws-lambda-exec-wrapper-persistence.md
{{#endref}}

### AWS - Lambda Function URL Public Exposure

Abuse Lambda asynchronous destinations μαζί με το Recursion configuration για να κάνετε μια function να re-invoke τον εαυτό της συνεχώς χωρίς εξωτερικό scheduler (χωρίς EventBridge, cron, κ.λπ.). Από προεπιλογή, η Lambda τερματίζει recursive loops, αλλά ορισμός του recursion config σε Allow τα επανενεργοποιεί. Τα destinations παραδίδουν στην πλευρά του service για async invokes, οπότε ένα single seed invoke δημιουργεί ένα stealthy, code-free heartbeat/backdoor channel. Προαιρετικά μπορείτε να throttle με reserved concurrency για να κρατήσετε το θόρυβο χαμηλό.

{{#ref}}
aws-lambda-async-self-loop-persistence.md
{{#endref}}

### AWS - Lambda Alias-Scoped Resource Policy Backdoor

Create a hidden Lambda version with attacker logic and scope a resource-based policy to that specific version (or alias) using the `--qualifier` parameter in `lambda add-permission`. Grant only `lambda:InvokeFunction` on `arn:aws:lambda:REGION:ACCT:function:FN:VERSION` to an attacker principal. Normal invocations via the function name or primary alias remain unaffected, while the attacker can directly invoke the backdoored version ARN.

This is stealthier than exposing a Function URL and doesn’t change the primary traffic alias.

{{#ref}}
aws-lambda-alias-version-policy-backdoor.md
{{#endref}}


{{#include ../../../../banners/hacktricks-training.md}}
