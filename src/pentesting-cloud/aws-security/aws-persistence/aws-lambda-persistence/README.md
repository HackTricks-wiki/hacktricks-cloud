# AWS - Lambda Kalıcılığı

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

Daha fazla bilgi için bakınız:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Lambda Layer Persistence

Lambda çalıştırıldığında gizli bir şekilde rastgele kod çalıştırmak için bir **layer eklemek/backdoor koymak** mümkündür:

{{#ref}}
aws-lambda-layers-persistence.md
{{#endref}}

### Lambda Extension Persistence

Lambda Layers'ı kötüye kullanarak extension'ları da istismar etmek ve lambda içinde kalıcılık sağlamak; ayrıca istekleri çalmak ve değiştirmek mümkündür.

{{#ref}}
aws-abusing-lambda-extensions.md
{{#endref}}

### Via resource policies

Harici hesaplara farklı lambda eylemleri (ör. invoke veya update code) için erişim verebilmek mümkündür:

<figure><img src="../../../../images/image (255).png" alt=""><figcaption></figcaption></figure>

### Versions, Aliases & Weights

Bir Lambda'nın **farklı versiyonları** (her versiyonda farklı kod olabilir) olabilir.\
Sonra, lambda'nın **farklı versiyonlarına işaret eden farklı alias'lar** oluşturup her birine farklı weight'ler atayabilirsiniz.\
Böylece bir saldırgan **backdoor'lu version 1** ve sadece meşru kod içeren **version 2** oluşturup, tespit edilmemek için isteklerin sadece %1'inde version 1'i çalıştırabilir.

<figure><img src="../../../../images/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Lambda'nın orijinal kodunu kopyalayın  
2. Orijinal koda **backdoor ekleyerek yeni bir versiyon oluşturun** (veya sadece kötü amaçlı kod). Publish edin ve bu versiyonu **$LATEST** olarak deploy edin  
3. Lambda ile ilişkili API gateway'i çağırarak kodu çalıştırın  
4. Orijinal kodla **yeni bir versiyon oluşturun**, Publish edin ve o **versiyonu** $LATEST olarak deploy edin.  
   - Bu, backdoor'lu kodu önceki bir versiyon olarak gizler  
5. API Gateway'e gidin ve backdoor'lu versiyonu çalıştıracak yeni bir POST methodu oluşturun (veya herhangi bir method seçin): `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`  
   - ARN sonundaki :1 **fonksiyonun versiyonunu** gösterir (bu senaryoda versiyon 1 backdoor'lu olandır).  
6. Oluşturduğunuz POST methodunu seçin ve Actions menüsünden **`Deploy API`** seçeneğini tıklayın  
7. Artık fonksiyonu POST ile çağırdığınızda **Backdoor** tetiklenecektir

### Cron/Event actuator

Lambda fonksiyonlarını bir şey olduğunda veya belli bir süre geçtiğinde çalıştırabilmeniz, lambda'yı kalıcılık sağlamak ve tespiti atlatmak için yaygın bir yol yapar.\
Aşağıda AWS içinde varlığınızı daha gizli tutmak için lambda oluşturarak yapabileceğiniz bazı fikirler var.

- Yeni bir kullanıcı oluşturulduğunda lambda yeni bir user key yaratıp saldırgana gönderir.  
- Yeni bir role oluşturulduğunda lambda, ele geçirilmiş kullanıcılara assume role izinleri verir.  
- Yeni cloudtrail log'ları üretildiğinde bunları siler/değiştirir.

### RCE abusing AWS_LAMBDA_EXEC_WRAPPER + Lambda Layers

Çalışma zamanı/handler başlamadan önce saldırgan kontrollü bir wrapper script çalıştırmak için `AWS_LAMBDA_EXEC_WRAPPER` environment variable'ını istismar edin. Wrapper'ı bir Lambda Layer ile `/opt/bin/htwrap` olarak sağlayın, `AWS_LAMBDA_EXEC_WRAPPER=/opt/bin/htwrap` olarak ayarlayın ve ardından fonksiyonu invoke edin. Wrapper, fonksiyon runtime sürecinde çalışır, fonksiyon execution role'unu miras alır ve en sonunda gerçek runtime'ı `exec`lediği için orijinal handler normal şekilde çalışmaya devam eder.

{{#ref}}
aws-lambda-exec-wrapper-persistence.md
{{#endref}}

### AWS - Lambda Function URL Public Exposure

Asenkron destinasyonları ve Recursion konfigürasyonunu kullanarak bir fonksiyonun kendi kendini dış bir scheduler olmadan (EventBridge, cron, vb. olmadan) sürekli yeniden invoke etmesini sağlayın. Varsayılan olarak, Lambda recursive döngüleri sonlandırır; ancak recursion config'i Allow olarak ayarlamak bunları yeniden etkinleştirir. Destinations, async invoke'lar için servis tarafında teslimat yaptığından, tek bir seed invoke gizli, kod gerektirmeyen bir heartbeat/backdoor kanalı yaratır. Gürültüyü düşük tutmak için isteğe bağlı olarak reserved concurrency ile throttle edebilirsiniz.

{{#ref}}
aws-lambda-async-self-loop-persistence.md
{{#endref}}

### AWS - Lambda Alias-Scoped Resource Policy Backdoor

Saldırgan mantığı içeren gizli bir Lambda versiyonu oluşturun ve `lambda add-permission` çalıştırırken `--qualifier` parametresi ile o özel versiyona (veya alias'a) resource-based policy scope edin. Sadece `lambda:InvokeFunction` yetkisini `arn:aws:lambda:REGION:ACCT:function:FN:VERSION` üzerinde saldırgan-principal'e verin. Fonksiyon adı veya birincil alias üzerinden yapılan normal çağrılar etkilenmez; saldırgan doğrudan backdoor'lu versiyon ARN'sini invoke edebilir.

Bu, Function URL açmaktan daha gizlidir ve ana trafik alias'ını değiştirmez.

{{#ref}}
aws-lambda-alias-version-policy-backdoor.md
{{#endref}}


{{#include ../../../../banners/hacktricks-training.md}}
