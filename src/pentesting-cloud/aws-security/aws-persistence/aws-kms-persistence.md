# AWS - KMS 持久性

{{#include ../../../banners/hacktricks-training.md}}

## KMS

有关更多信息，请查看：

{{#ref}}
../aws-services/aws-kms-enum.md
{{#endref}}

### 通过 KMS 策略授予访问权限

攻击者可以使用权限 **`kms:PutKeyPolicy`** 来 **授予访问** 一个密钥给他控制的用户或甚至是一个外部账户。有关更多信息，请查看 [**KMS 权限提升页面**](../aws-privilege-escalation/aws-kms-privesc.md)。

### 永久授权

授权是另一种方式，可以让主体对特定密钥拥有一些权限。可以授予一个授权，允许用户创建授权。此外，用户可以对同一个密钥拥有多个授权（甚至是相同的）。

因此，用户可以拥有 10 个具有所有权限的授权。攻击者应该不断监控这一点。如果在某个时刻 1 个授权被移除，应该生成另外 10 个授权。

（我们使用 10 而不是 2，以便能够检测到一个授权被移除，而用户仍然拥有一些授权）
```bash
# To generate grants, generate 10 like this one
aws kms create-grant \
--key-id <key-id> \
--grantee-principal <user_arn> \
--operations "CreateGrant" "Decrypt"

# To monitor grants
aws kms list-grants --key-id <key-id>
```
> [!NOTE]
> 授予只能从此处授予权限: [https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations](https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations)

{{#include ../../../banners/hacktricks-training.md}}
