# AWS - KMS Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## KMS

Kwa taarifa zaidi angalia:

{{#ref}}
../../aws-services/aws-kms-enum.md
{{#endref}}

### Grant acces via KMS policies

Mshambuliaji anaweza kutumia ruhusa **`kms:PutKeyPolicy`** ili **kumpa upatikanaji** kwa key kwa mtumiaji aliye chini ya udhibiti wake au hata kwa akaunti ya nje. Angalia [**KMS Privesc page**](../../aws-privilege-escalation/aws-kms-privesc/README.md) kwa taarifa zaidi.

### Eternal Grant

Grants ni njia nyingine ya kumpa principal ruhusa fulani juu ya key maalum. Inawezekana kutoa grant inayomruhusu mtumiaji kuunda grants. Zaidi ya hayo, mtumiaji anaweza kuwa na grants kadhaa (hata sawa) juu ya key ile ile.

Kwa hivyo, inawezekana kwa mtumiaji kuwa na grants 10 zenye ruhusa zote. Mshambuliaji anapaswa kusimamia hili mara kwa mara. Na ikiwa kwa wakati fulani grant 1 itaondolewa, grants nyingine 10 zinapaswa kuundwa.

(Tunatumia 10 badala ya 2 ili kuweza kutambua kwamba grant iliondolewa huku mtumiaji bado akiwa na grant nyingine)
```bash
# To generate grants, generate 10 like this one
aws kms create-grant \
--key-id <key-id> \
--grantee-principal <user_arn> \
--operations "CreateGrant" "Decrypt"

# To monitor grants
aws kms list-grants --key-id <key-id>
```
> [!NOTE]
> Grant inaweza kutoa ruhusa tu kutoka hapa: [https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations](https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations)

{{#include ../../../../banners/hacktricks-training.md}}
