# AWS - Persistência EC2

{{#include ../../../banners/hacktricks-training.md}}

## EC2

Para mais informações, consulte:

{{#ref}}
../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/
{{#endref}}

### Persistência de Rastreamento de Conexão do Grupo de Segurança

Se um defensor descobrir que uma **instância EC2 foi comprometida**, ele provavelmente tentará **isolar** a **rede** da máquina. Ele poderia fazer isso com um **Deny NACL** explícito (mas os NACLs afetam toda a sub-rede), ou **mudando o grupo de segurança** para não permitir **qualquer tipo de tráfego de entrada ou saída**.

Se o atacante tiver um **reverse shell originado da máquina**, mesmo que o SG seja modificado para não permitir tráfego de entrada ou saída, a **conexão não será encerrada devido ao** [**Rastreamento de Conexão do Grupo de Segurança**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/security-group-connection-tracking.html)**.**

### Gerenciador de Ciclo de Vida EC2

Este serviço permite **agendar** a **criação de AMIs e snapshots** e até mesmo **compartilhá-los com outras contas**.\
Um atacante poderia configurar a **geração de AMIs ou snapshots** de todas as imagens ou de todos os volumes **toda semana** e **compartilhá-los com sua conta**.

### Instâncias Agendadas

É possível agendar instâncias para serem executadas diariamente, semanalmente ou até mensalmente. Um atacante poderia executar uma máquina com altos privilégios ou acesso interessante onde ele poderia acessar.

### Solicitação de Frota Spot

Instâncias spot são **mais baratas** do que instâncias regulares. Um atacante poderia lançar uma **pequena solicitação de frota spot por 5 anos** (por exemplo), com **atribuição automática de IP** e um **user data** que envia para o atacante **quando a instância spot iniciar** e o **endereço IP** e com um **papel IAM de alto privilégio**.

### Instâncias de Backdoor

Um atacante poderia obter acesso às instâncias e backdoor elas:

- Usando um **rootkit** tradicional, por exemplo
- Adicionando uma nova **chave SSH pública** (ver [opções de privesc EC2](../aws-privilege-escalation/aws-ec2-privesc.md))
- Backdooring os **User Data**

### **Configuração de Lançamento de Backdoor**

- Backdoor a AMI utilizada
- Backdoor os User Data
- Backdoor o Par de Chaves

### VPN

Criar uma VPN para que o atacante possa se conectar diretamente através dela ao VPC.

### Peering VPC

Criar uma conexão de peering entre o VPC da vítima e o VPC do atacante para que ele possa acessar o VPC da vítima.

{{#include ../../../banners/hacktricks-training.md}}
