# AWS - EC2 Persistence

{{#include ../../../banners/hacktricks-training.md}}

## EC2

詳細については、次を確認してください：

{{#ref}}
../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/
{{#endref}}

### セキュリティグループ接続追跡持続性

防御者が**EC2インスタンスが侵害された**ことを発見した場合、彼はおそらく**ネットワーク**を**隔離**しようとするでしょう。彼は明示的な**Deny NACL**を使用することができます（ただし、NACLはサブネット全体に影響します）、または**セキュリティグループを変更して**、**いかなる種類のインバウンドまたはアウトバウンド**トラフィックも許可しないようにします。

攻撃者が**マシンから発生したリバースシェル**を持っていた場合、SGがインバウンドまたはアウトバウンドトラフィックを許可しないように変更されても、**接続は**[**セキュリティグループ接続追跡**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/security-group-connection-tracking.html)**のために切断されません。**

### EC2ライフサイクルマネージャー

このサービスは**AMIとスナップショットの作成をスケジュール**し、他のアカウントと**共有する**ことを可能にします。\
攻撃者は**すべてのイメージまたはすべてのボリュームのAMIまたはスナップショットの生成を**毎週**スケジュール**し、**自分のアカウントと共有**することができます。

### スケジュールされたインスタンス

インスタンスを毎日、毎週、または毎月実行するようにスケジュールすることが可能です。攻撃者は高い権限または興味深いアクセスを持つマシンを実行することができます。

### スポットフリートリクエスト

スポットインスタンスは**通常のインスタンスよりも安価**です。攻撃者は**5年間の小さなスポットフリートリクエストを**起動することができ、**自動IP**割り当てと、スポットインスタンスが**起動したときに攻撃者に送信する**ユーザーデータを持ち、**高権限のIAMロール**を持つことができます。

### バックドアインスタンス

攻撃者はインスタンスにアクセスし、バックドアを仕掛けることができます：

- 伝統的な**ルートキット**を使用する例
- 新しい**公開SSHキー**を追加する（[EC2特権昇格オプション](../aws-privilege-escalation/aws-ec2-privesc.md)を確認）
- **ユーザーデータ**にバックドアを仕掛ける

### **バックドア起動構成**

- 使用されるAMIにバックドアを仕掛ける
- ユーザーデータにバックドアを仕掛ける
- キーペアにバックドアを仕掛ける

### VPN

攻撃者がVPCに直接接続できるようにVPNを作成します。

### VPCピアリング

被害者のVPCと攻撃者のVPCの間にピアリング接続を作成し、攻撃者が被害者のVPCにアクセスできるようにします。

{{#include ../../../banners/hacktricks-training.md}}
