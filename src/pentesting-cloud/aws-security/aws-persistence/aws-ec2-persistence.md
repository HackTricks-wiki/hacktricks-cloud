# AWS - EC2 Persistence

{{#include ../../../banners/hacktricks-training.md}}

## EC2

Για περισσότερες πληροφορίες ελέγξτε:

{{#ref}}
../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/
{{#endref}}

### Παρακολούθηση Σύνδεσης Ομάδας Ασφαλείας

Εάν ένας αμυντικός διαπιστώσει ότι μια **EC2 instance έχει παραβιαστεί**, πιθανότατα θα προσπαθήσει να **απομονώσει** το **δίκτυο** της μηχανής. Θα μπορούσε να το κάνει με μια ρητή **Deny NACL** (αλλά οι NACL επηρεάζουν ολόκληρο το υποδίκτυο), ή **αλλάζοντας την ομάδα ασφαλείας** ώστε να μην επιτρέπει **κανένα είδος εισερχόμενης ή εξερχόμενης** κίνησης.

Εάν ο επιτιθέμενος είχε μια **reverse shell που προήλθε από τη μηχανή**, ακόμη και αν η SG τροποποιηθεί ώστε να μην επιτρέπει εισερχόμενη ή εξερχόμενη κίνηση, η **σύνδεση δεν θα τερματιστεί λόγω** [**Παρακολούθησης Σύνδεσης Ομάδας Ασφαλείας**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/security-group-connection-tracking.html)**.**

### EC2 Lifecycle Manager

Αυτή η υπηρεσία επιτρέπει να **προγραμματίσετε** τη **δημιουργία AMIs και snapshots** και ακόμη και να **τα μοιραστείτε με άλλους λογαριασμούς**.\
Ένας επιτιθέμενος θα μπορούσε να ρυθμίσει τη **δημιουργία AMIs ή snapshots** όλων των εικόνων ή όλων των όγκων **κάθε εβδομάδα** και να **τα μοιραστεί με τον λογαριασμό του**.

### Προγραμματισμένες Εγκαταστάσεις

Είναι δυνατόν να προγραμματίσετε εγκαταστάσεις να τρέχουν καθημερινά, εβδομαδιαία ή ακόμη και μηνιαία. Ένας επιτιθέμενος θα μπορούσε να τρέξει μια μηχανή με υψηλά προνόμια ή ενδιαφέροντα πρόσβαση όπου θα μπορούσε να έχει πρόσβαση.

### Αίτημα Spot Fleet

Οι spot instances είναι **φθηνότερες** από τις κανονικές εγκαταστάσεις. Ένας επιτιθέμενος θα μπορούσε να εκκινήσει ένα **μικρό αίτημα spot fleet για 5 χρόνια** (για παράδειγμα), με **αυτόματη ανάθεση IP** και **user data** που στέλνει στον επιτιθέμενο **όταν η spot instance ξεκινήσει** και τη **διεύθυνση IP** και με έναν **ρόλο IAM υψηλών προνομίων**.

### Backdoor Instances

Ένας επιτιθέμενος θα μπορούσε να αποκτήσει πρόσβαση στις εγκαταστάσεις και να τις backdoor:

- Χρησιμοποιώντας ένα παραδοσιακό **rootkit** για παράδειγμα
- Προσθέτοντας ένα νέο **δημόσιο SSH key** (ελέγξτε [EC2 privesc options](../aws-privilege-escalation/aws-ec2-privesc.md))
- Backdooring το **User Data**

### **Backdoor Launch Configuration**

- Backdoor το χρησιμοποιούμενο AMI
- Backdoor το User Data
- Backdoor το Key Pair

### VPN

Δημιουργήστε ένα VPN ώστε ο επιτιθέμενος να μπορεί να συνδεθεί απευθείας μέσω αυτού στο VPC.

### VPC Peering

Δημιουργήστε μια σύνδεση peering μεταξύ του VPC του θύματος και του VPC του επιτιθέμενου ώστε να μπορεί να έχει πρόσβαση στο VPC του θύματος.

{{#include ../../../banners/hacktricks-training.md}}
