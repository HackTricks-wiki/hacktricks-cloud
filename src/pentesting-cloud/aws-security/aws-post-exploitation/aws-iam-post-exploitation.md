# AWS - IAM Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## IAM

For more information about IAM access:

{{#ref}}
../aws-services/aws-iam-enum.md
{{#endref}}

## Confused Deputy Problem

Eğer **harici bir hesabın (A) erişmesine izin verirseniz** hesabınızdaki bir **role**'e, muhtemelen **o harici hesaba tam olarak kimin erişebildiği konusunda 0 görünürlüğe** sahip olacaksınız. Bu bir sorundur, çünkü başka bir harici hesap (B), harici hesap (A)'ya erişebiliyorsa, **B de hesabınıza erişebilecek** olabilir.

Bu nedenle, bir harici hesabın hesabınızdaki bir role erişmesine izin verirken bir `ExternalId` belirtmek mümkündür. Bu, harici hesap (A)'nın **belirtmesi gereken** "gizli" bir dizgedir ve kuruluşunuzdaki **role'ü üstlenmek için** gereklidir. **Harici hesap B bu dizgeyi bilmeyeceği için**, A'ya erişimi olsa bile **role'a erişemeyecektir**.

<figure><img src="../../../images/image (95).png" alt=""><figcaption></figcaption></figure>

Ancak, bu `ExternalId` "gizlisi"nin **gizli olmadığını** unutmayın; `IAM assume role policy`'yi **okuyabilen herkes** bunu görebilecektir. Fakat harici hesap A bunu biliyorsa ve harici hesap **B bunu bilmiyorsa**, bu durum **B'nin A'yı kötüye kullanarak hesabınızdaki role'a erişmesini engeller**.

Örnek:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
> [!WARNING]
> Bir attacker'ın bir confused deputy'yi exploit edebilmesi için, current account'taki principals'ların diğer accounts'taki roles'ları impersonate edip edemeyeceğini bir şekilde tespit etmesi gerekir.

### Beklenmeyen Güven İlişkileri

#### Wildcard olarak principal
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" }
}
```
Bu politika **tüm AWS'nin** rolü üstlenmesine izin verir.

#### Hizmet principal olarak
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
Bu politika **herhangi bir hesabın** apigateway'ini bu Lambda'yı çağırmak üzere yapılandırmasına izin verir.

#### S3 özne olarak
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
Eğer bir S3 bucket principal olarak verilmişse, çünkü S3 bucket'ların bir Account ID'si yoktur, eğer siz **bucket'ınızı sildiyseniz ve attacker onu kendi hesabında oluşturduysa**, bunu kötüye kullanabilirler.

#### Desteklenmiyor
```json
{
"Effect": "Allow",
"Principal": { "Service": "cloudtrail.amazonaws.com" },
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
Confused Deputy sorunlarından kaçınmanın yaygın bir yolu, kaynak ARN'yi kontrol etmek için `AWS:SourceArn` ile bir koşul kullanmaktır. Ancak, **bazı servisler bunu desteklemeyebilir** (örneğin bazı kaynaklara göre CloudTrail).

### Kimlik Bilgilerinin Silinmesi
Aşağıdaki izinlerden herhangi biriyle — `iam:DeleteAccessKey`, `iam:DeleteLoginProfile`, `iam:DeleteSSHPublicKey`, `iam:DeleteServiceSpecificCredential`, `iam:DeleteInstanceProfile`, `iam:DeleteServerCertificate`, `iam:DeleteCloudFrontPublicKey`, `iam:RemoveRoleFromInstanceProfile` — bir aktör erişim anahtarlarını, giriş profillerini, SSH anahtarlarını, servis-özgü kimlik bilgilerini, instance profillerini, sertifikaları veya CloudFront açık anahtarlarını silebilir ya da rollerin instance profillerinden ayrılmasına neden olabilir. Bu tür eylemler meşru kullanıcıları ve uygulamaları derhal engelleyebilir ve hizmet reddi (denial-of-service) veya bu kimlik bilgilerine bağımlı sistemlerin erişimini kaybetmesine yol açabilir; bu nedenle bu IAM izinleri sıkı şekilde kısıtlanmalı ve izlenmelidir.
```bash
# Remove Access Key of a user
aws iam delete-access-key \
--user-name <Username> \
--access-key-id AKIAIOSFODNN7EXAMPLE

## Remove ssh key of a user
aws iam delete-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE
```
### Kimlik Silme
`iam:DeleteUser`, `iam:DeleteGroup`, `iam:DeleteRole` veya `iam:RemoveUserFromGroup` gibi izinlere sahip bir aktör, kullanıcıları, rolleri veya grupları silebilir ya da grup üyeliğini değiştirebilir — böylece kimlikleri ve ilişkili izleri kaldırır. Bu, bu kimliklere bağlı kişiler ve hizmetler için erişimi derhal kesebilir, denial-of-service veya erişim kaybına yol açabilir; bu yüzden bu IAM eylemleri sıkı şekilde sınırlandırılmalı ve izlenmelidir.
```bash
# Delete a user
aws iam delete-user \
--user-name <Username>

# Delete a group
aws iam delete-group \
--group-name <Username>

# Delete a role
aws iam delete-role \
--role-name <Role>
```
###
Şu izinlerden herhangi birine sahip bir aktör — `iam:DeleteGroupPolicy`, `iam:DeleteRolePolicy`, `iam:DeleteUserPolicy`, `iam:DeletePolicy`, `iam:DeletePolicyVersion`, `iam:DeleteRolePermissionsBoundary`, `iam:DeleteUserPermissionsBoundary`, `iam:DetachGroupPolicy`, `iam:DetachRolePolicy`, `iam:DetachUserPolicy` — yönetilen veya inline politikaları silebilir veya ayırabilir, politika sürümlerini veya izin sınırlarını kaldırabilir ve politikaları kullanıcılar, gruplar veya rollerden ayırabilir. Bu, yetkilendirmeleri yok eder ve izin modelini değiştirebilir; bu nedenle bu politikalara bağlı olan varlıklar için anında erişim kaybına veya denial-of-service'e yol açabilir, bu yüzden bu IAM eylemleri sıkı şekilde kısıtlanmalı ve izlenmelidir.
```bash
# Delete a group policy
aws iam delete-group-policy \
--group-name <GroupName> \
--policy-name <PolicyName>

# Delete a role policy
aws iam delete-role-policy \
--role-name <RoleName> \
--policy-name <PolicyName>
```
### Federe Kimlik Sağlayıcılarının Silinmesi
`iam:DeleteOpenIDConnectProvider`, `iam:DeleteSAMLProvider`, ve `iam:RemoveClientIDFromOpenIDConnectProvider` ile bir aktör OIDC/SAML kimlik sağlayıcılarını silebilir veya istemci kimliklerini kaldırabilir. Bu, federe kimlik doğrulamayı bozarak token doğrulamasını engeller ve IdP veya yapılandırmalar geri yüklenene kadar SSO'ya bağlı kullanıcılar ve hizmetler için erişimi anında reddeder.
```bash
# Delete OIDCP provider
aws iam delete-open-id-connect-provider \
--open-id-connect-provider-arn arn:aws:iam::111122223333:oidc-provider/accounts.google.com

# Delete SAML provider
aws iam delete-saml-provider \
--saml-provider-arn arn:aws:iam::111122223333:saml-provider/CorporateADFS
```
### Yetkisiz MFA Etkinleştirme
`iam:EnableMFADevice` ile bir aktör, bir kullanıcının kimliğine bir MFA cihazı kaydederek meşru kullanıcının oturum açmasını engelleyebilir. Yetkisiz bir MFA etkinleştirildiğinde, cihaz kaldırılana veya sıfırlanana kadar kullanıcı kilitlenebilir (not: eğer birden fazla MFA cihazı kayıtlıysa, oturum açmak için yalnızca birine ihtiyaç vardır, bu nedenle bu saldırı erişimi engellemede etkili olmayacaktır).
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
### Sertifika/Anahtar Meta Veri Değiştirme
`iam:UpdateSSHPublicKey`, `iam:UpdateCloudFrontPublicKey`, `iam:UpdateSigningCertificate`, `iam:UpdateServerCertificate` izinleriyle bir aktör açık anahtarların ve sertifikaların durumunu veya meta verisini değiştirebilir. Anahtarları/sertifikaları etkin olmayan olarak işaretleyerek veya referansları değiştirerek SSH kimlik doğrulamayı bozabilir, X.509/TLS doğrulamalarını geçersiz kılabilir ve bu kimlik bilgilerine bağımlı hizmetleri anında aksatabilir; bu da erişim kaybına veya kullanılabilirlik sorunlarına yol açar.
```bash
aws iam update-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE \
--status Inactive

aws iam update-server-certificate \
--server-certificate-name <Certificate_Name> \
--new-path /prod/
```
## Referanslar

- [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{{#include ../../../banners/hacktricks-training.md}}
