# AWS - IAM Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## IAM

关于 IAM 访问的更多信息：

{{#ref}}
../aws-services/aws-iam-enum.md
{{#endref}}

## Confused Deputy 问题

如果你 **允许外部账号 (A)** 访问你账号中的 **角色**，你很可能对 **谁能确切访问该外部账号** 完全 **没有可见性**。这是一个问题，因为如果另一个外部账号 (B) 能访问外部账号 (A)，那么 **B 也可能能够访问你的账号**。

因此，当允许外部账号访问你账号中的角色时，可以指定一个 `ExternalId`。这是一个“秘密”字符串，外部账号 (A) 需要**指定**它，以便**在你的组织中假定该角色**。由于**外部账号 B 不会知道这个字符串**，即使他能访问 A，也**无法访问你的角色**。

<figure><img src="../../../images/image (95).png" alt=""><figcaption></figcaption></figure>

然而，请注意这个 `ExternalId` “秘密” **并不是真正的秘密**，任何能够**读取 IAM 假定角色策略的人都能看到它**。但只要外部账号 A 知道它，而外部账号 **B 不知道它**，它就**可以防止 B 滥用 A 来访问你的角色**。

示例：
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
> [!WARNING]
> 为了利用 confused deputy，攻击者需要以某种方式确认当前 account 的 principals 是否能够冒充其他 account 中的 roles。

### 意外的信任

#### 通配符作为 principal
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" }
}
```
此策略**允许所有 AWS** 假定该角色。

#### 服务作为主体
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
此策略 **允许任何账户** 配置其 apigateway 以调用此 Lambda。

#### S3 作为主体
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
如果将 S3 bucket 指定为 principal，因为 S3 buckets 没有 Account ID，如果你 **删除了你的 bucket 并且攻击者在他们自己的账户中创建了它**，那么他们就可以滥用这一点。

#### 不支持
```json
{
"Effect": "Allow",
"Principal": { "Service": "cloudtrail.amazonaws.com" },
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
A common way to avoid Confused Deputy problems is the use of a condition with `AWS:SourceArn` to check the origin ARN. However, **some services might not support that** (like CloudTrail according to some sources).

### 凭证删除
With any of the following permissions — `iam:DeleteAccessKey`, `iam:DeleteLoginProfile`, `iam:DeleteSSHPublicKey`, `iam:DeleteServiceSpecificCredential`, `iam:DeleteInstanceProfile`, `iam:DeleteServerCertificate`, `iam:DeleteCloudFrontPublicKey`, `iam:RemoveRoleFromInstanceProfile` — an actor can remove access keys, login profiles, SSH keys, service-specific credentials, instance profiles, certificates or CloudFront public keys, or disassociate roles from instance profiles. Such actions can immediately block legitimate users and applications and cause denial-of-service or loss of access for systems that depend on those credentials, so these IAM permissions must be tightly restricted and monitored.
```bash
# Remove Access Key of a user
aws iam delete-access-key \
--user-name <Username> \
--access-key-id AKIAIOSFODNN7EXAMPLE

## Remove ssh key of a user
aws iam delete-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE
```
### 身份删除
拥有类似 `iam:DeleteUser`、`iam:DeleteGroup`、`iam:DeleteRole` 或 `iam:RemoveUserFromGroup` 的权限，行为者可以删除用户、角色或组——或更改组成员关系——从而移除身份及其相关痕迹。这会立即中断依赖这些身份的人员和服务的访问，导致 denial-of-service 或访问丧失，因此这些 IAM 操作必须被严格限制和监控。
```bash
# Delete a user
aws iam delete-user \
--user-name <Username>

# Delete a group
aws iam delete-group \
--group-name <Username>

# Delete a role
aws iam delete-role \
--role-name <Role>
```
###
有了以下任一权限 — `iam:DeleteGroupPolicy`, `iam:DeleteRolePolicy`, `iam:DeleteUserPolicy`, `iam:DeletePolicy`, `iam:DeletePolicyVersion`, `iam:DeleteRolePermissionsBoundary`, `iam:DeleteUserPermissionsBoundary`, `iam:DetachGroupPolicy`, `iam:DetachRolePolicy`, `iam:DetachUserPolicy` — 行为者可以删除或解除附加的托管/内联策略、移除策略版本或权限边界，并将策略与用户、组或角色解绑。此类操作会破坏授权并可能改变权限模型，导致依赖这些策略的主体立即失去访问权限或发生拒绝服务，因此这些 IAM 操作必须严格限制并进行监控。
```bash
# Delete a group policy
aws iam delete-group-policy \
--group-name <GroupName> \
--policy-name <PolicyName>

# Delete a role policy
aws iam delete-role-policy \
--role-name <RoleName> \
--policy-name <PolicyName>
```
### 联邦身份删除
使用 `iam:DeleteOpenIDConnectProvider`、`iam:DeleteSAMLProvider` 和 `iam:RemoveClientIDFromOpenIDConnectProvider`，攻击者可以删除 OIDC/SAML 身份提供者或移除 client IDs。 这会破坏联邦身份验证，阻止令牌验证，并立即拒绝依赖 SSO 的用户和服务的访问，直到 IdP 或配置恢复为止。
```bash
# Delete OIDCP provider
aws iam delete-open-id-connect-provider \
--open-id-connect-provider-arn arn:aws:iam::111122223333:oidc-provider/accounts.google.com

# Delete SAML provider
aws iam delete-saml-provider \
--saml-provider-arn arn:aws:iam::111122223333:saml-provider/CorporateADFS
```
### Illegitimate MFA Activation
通过 `iam:EnableMFADevice`，攻击者可以在某个用户的身份上注册一个 MFA 设备，从而阻止合法用户登录。一旦启用未授权的 MFA，用户可能会被锁定，直到该设备被移除或重置（注：如果注册了多个 MFA 设备，登录只需要其中之一，因此该攻击在阻止访问方面不会生效）。
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
### 证书/密钥元数据篡改
通过 `iam:UpdateSSHPublicKey`、`iam:UpdateCloudFrontPublicKey`、`iam:UpdateSigningCertificate`、`iam:UpdateServerCertificate`，攻击者可以更改公钥和证书的状态或元数据。通过将密钥/证书标记为不活动或修改引用，他们可以破坏 SSH 认证、使 X.509/TLS 验证失效，并立即中断依赖这些凭证的服务，从而造成访问或可用性丧失。
```bash
aws iam update-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE \
--status Inactive

aws iam update-server-certificate \
--server-certificate-name <Certificate_Name> \
--new-path /prod/
```
## 参考资料

- [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{{#include ../../../banners/hacktricks-training.md}}
