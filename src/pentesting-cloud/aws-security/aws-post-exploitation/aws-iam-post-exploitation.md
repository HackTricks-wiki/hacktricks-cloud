# AWS - IAM Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## IAM

Kwa habari zaidi kuhusu ufikiaji wa IAM:

{{#ref}}
../aws-services/aws-iam-enum.md
{{#endref}}

## Confused Deputy Problem

Ikiwa **unamruhusu akaunti ya nje (A)** kufikia **role** kwenye akaunti yako, huenda ukawa na **uonekano 0** juu ya **ni nani hasa anaweza kufikia akaunti hiyo ya nje**. Hii ni tatizo, kwa sababu ikiwa akaunti nyingine ya nje (B) inaweza kufikia akaunti ya nje (A) inawezekana kwamba **B pia ataweza kufikia akaunti yako**.

Hivyo, unapomruhusu akaunti ya nje kufikia role kwenye akaunti yako inawezekana kubainisha `ExternalId`. Hii ni kamba "secret" ambayo akaunti ya nje (A) **inahitaji kuibainisha** ili **assume the role in your organization**. Kwa kuwa **akaunti ya nje B haitajui kamba hii**, hata kama ina ufikiaji wa A **haitaweza kufikia role yako**.

<figure><img src="../../../images/image (95).png" alt=""><figcaption></figcaption></figure>

Hata hivyo, kumbuka kwamba `ExternalId` "secret" **sio siri**, yeyote anayeeza **read the IAM assume role policy will be able to see it**. Lakini mradi akaunti ya nje A inajua, na akaunti ya nje **B haitajui**, hiyo **prevents B abusing A to access your role**.

Mfano:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
> [!WARNING]
> Ili mshambulizi afaidike na confused deputy, atahitaji kwa namna fulani kugundua kama principals za akaunti ya sasa zinaweza kujifanya roles katika akaunti nyingine.

### Uaminifu usiotarajiwa

#### Wildcard kama principal
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" }
}
```
Sera hii **inaruhusu AWS zote** kuchukua jukumu.

#### Huduma kama mwenye mamlaka
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
Sera hii **inaruhusu akaunti yoyote** kusanidi apigateway yao kuitisha Lambda hii.

#### S3 kama mhusika
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
Ikiwa S3 bucket imepewa kama principal, kwa sababu S3 buckets hazina Account ID, ikiwa **ulifuta bucket yako na mshambuliaji akaijenga** katika akaunti yao wenyewe, basi wangeweza kuvitumia vibaya.

#### Not supported
```json
{
"Effect": "Allow",
"Principal": { "Service": "cloudtrail.amazonaws.com" },
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
Njia ya kawaida ya kuepuka matatizo ya Confused Deputy ni kutumia sharti lenye `AWS:SourceArn` kuangalia origin ARN. Hata hivyo, **huduma baadhi huenda zisiziiunge mkono** (kama CloudTrail kwa mujibu wa baadhi ya vyanzo).

### Kufuta Vyeti
Kwa yoyote ya ruhusa zifuatazo — `iam:DeleteAccessKey`, `iam:DeleteLoginProfile`, `iam:DeleteSSHPublicKey`, `iam:DeleteServiceSpecificCredential`, `iam:DeleteInstanceProfile`, `iam:DeleteServerCertificate`, `iam:DeleteCloudFrontPublicKey`, `iam:RemoveRoleFromInstanceProfile` — mhusika anaweza kuondoa access keys, login profiles, SSH keys, service-specific credentials, instance profiles, certificates au CloudFront public keys, au kutenganisha roles kutoka kwenye instance profiles. Vitendo hivyo vinaweza mara moja kuzuia watumiaji halali na applications na kusababisha denial-of-service au kupoteza ufikiaji kwa mifumo inayotegemea vyeti hivyo, kwa hiyo ruhusa hizi za IAM lazima ziwekwe kwa ukomo mkubwa na kufuatiliwa.
```bash
# Remove Access Key of a user
aws iam delete-access-key \
--user-name <Username> \
--access-key-id AKIAIOSFODNN7EXAMPLE

## Remove ssh key of a user
aws iam delete-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE
```
### Ufutaji wa Utambulisho
Kwa ruhusa kama `iam:DeleteUser`, `iam:DeleteGroup`, `iam:DeleteRole`, au `iam:RemoveUserFromGroup`, mhusika anaweza kufuta watumiaji, majukumu, au vikundi—au kubadili uanachama wa kikundi—akiwaondoa vitambulisho na alama zinazohusiana. Hii inaweza kuvunja mara moja upatikanaji kwa watu na huduma zinazoegemea vitambulisho hivyo, ikisababisha denial-of-service au upotezaji wa upatikanaji, hivyo vitendo hivi vya IAM lazima viwekwe vizuizi vikali na kufuatiliwa.
```bash
# Delete a user
aws iam delete-user \
--user-name <Username>

# Delete a group
aws iam delete-group \
--group-name <Username>

# Delete a role
aws iam delete-role \
--role-name <Role>
```
###
Kwa ruhusa yoyote kati ya zifuatazo — `iam:DeleteGroupPolicy`, `iam:DeleteRolePolicy`, `iam:DeleteUserPolicy`, `iam:DeletePolicy`, `iam:DeletePolicyVersion`, `iam:DeleteRolePermissionsBoundary`, `iam:DeleteUserPermissionsBoundary`, `iam:DetachGroupPolicy`, `iam:DetachRolePolicy`, `iam:DetachUserPolicy` — mtendaji anaweza kufuta au kutenganisha managed/inline policies, kuondoa matoleo ya policies au permissions boundaries, na kuondoa uhusiano wa policies kutoka kwa watumiaji, vikundi, au roles. Hii hubomoa idhini na inaweza kubadilisha muundo wa ruhusa, ikasababisha kupoteza mara moja ufikiaji au denial-of-service kwa wadau waliotegemea policies hizo, hivyo vitendo hivi vya IAM vinapaswa kuzuiwa kwa ukali na kusimamiwa.
```bash
# Delete a group policy
aws iam delete-group-policy \
--group-name <GroupName> \
--policy-name <PolicyName>

# Delete a role policy
aws iam delete-role-policy \
--role-name <RoleName> \
--policy-name <PolicyName>
```
### Kufuta Utambulisho uliounganishwa
Kwa `iam:DeleteOpenIDConnectProvider`, `iam:DeleteSAMLProvider`, and `iam:RemoveClientIDFromOpenIDConnectProvider`, mtumiaji mwenye mamlaka anaweza kufuta OIDC/SAML identity providers au kuondoa client IDs. Hii inavunja uthibitishaji uliounganishwa, ikizuia token validation na mara moja kukataa ufikiaji kwa watumiaji na huduma zinazotegemea SSO hadi IdP au mipangilio itakaporejeshwa.
```bash
# Delete OIDCP provider
aws iam delete-open-id-connect-provider \
--open-id-connect-provider-arn arn:aws:iam::111122223333:oidc-provider/accounts.google.com

# Delete SAML provider
aws iam delete-saml-provider \
--saml-provider-arn arn:aws:iam::111122223333:saml-provider/CorporateADFS
```
### Uanzishaji Haramu wa MFA
Kwa kutumia `iam:EnableMFADevice`, mhusika anaweza kusajili kifaa cha MFA kwenye utambulisho wa mtumiaji, akizuia mtumiaji halali kuingia. Mara MFA isiyoruhusiwa itakapowashwa, mtumiaji anaweza kufungiwa hadi kifaa hicho kiondolewe au kirekebishwe (kumbuka: ikiwa vifaa vingi vya MFA vimesajiliwa, kuingia kunahitaji kimoja tu, kwa hiyo shambulio hili halitaathiri kuzuia upatikanaji).
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
### Certificate/Key Metadata Tampering
Kwa `iam:UpdateSSHPublicKey`, `iam:UpdateCloudFrontPublicKey`, `iam:UpdateSigningCertificate`, `iam:UpdateServerCertificate`, mhusika anaweza kubadilisha hali au metadata ya funguo za umma na vyeti. Kwa kufanya funguo/vyeti zisizotumika au kubadilisha rejea, wanaweza kuvunja uthibitisho wa SSH, kufuta uhalali wa X.509/TLS, na kuathiri mara moja huduma zinazotegemea nyaraka hizo za uthibitisho, kusababisha kupoteza ufikiaji au upatikanaji.
```bash
aws iam update-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE \
--status Inactive

aws iam update-server-certificate \
--server-certificate-name <Certificate_Name> \
--new-path /prod/
```
## Marejeo

- [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{{#include ../../../banners/hacktricks-training.md}}
