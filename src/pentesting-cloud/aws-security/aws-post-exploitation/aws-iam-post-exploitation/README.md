# AWS - IAM Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## IAM

IAM 접근에 대한 자세한 내용은:

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

## Confused Deputy 문제

만약 귀하의 계정에 있는 **role**에 대해 **외부 계정 (A)** 에게 접근을 허용하면, 해당 외부 계정을 정확히 **누가 액세스할 수 있는지에 대한 가시성은 사실상 0입니다**. 이는 문제가 됩니다. 왜냐하면 다른 외부 계정 (B)이 외부 계정 (A)에 접근할 수 있다면 **B가 귀하의 계정에도 접근할 수 있게 될 수 있기 때문**입니다.

따라서 귀하의 계정에서 외부 계정이 role에 접근하도록 허용할 때 `ExternalId`를 지정할 수 있습니다. 이는 외부 계정 (A)이 귀하의 조직에서 역할을 **assume**하기 위해 지정해야 하는 "비밀" 문자열입니다. 외부 계정 B는 이 문자열을 모를 것이므로, 설령 B가 A에 접근권을 가지고 있더라도 **귀하의 role에 접근할 수 없습니다**.

<figure><img src="../../../images/image (95).png" alt=""><figcaption></figcaption></figure>

그러나 이 `ExternalId` "비밀"은 **비밀이 아닙니다**, IAM assume role policy를 **읽을 수 있는 누구나 확인할 수 있습니다**. 하지만 외부 계정 A만 알고 있고 외부 계정 **B가 모르는 한**, 이는 **B가 A를 악용하여 귀하의 role에 접근하는 것을 방지합니다**.

Example:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
> [!WARNING]
> 공격자가 confused deputy를 악용하려면 principals of the current account가 roles in other accounts를 가장할 수 있는지 어떻게든 찾아내야 한다.

### 예상치 못한 신뢰

#### 와일드카드를 principal로 사용
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" }
}
```
이 정책은 **모든 AWS**가 역할을 맡도록 허용합니다.

#### 서비스가 주체인 경우
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
이 정책은 **모든 계정이** 자신의 apigateway를 구성하여 이 Lambda를 호출할 수 있도록 허용합니다.

#### S3를 주체로
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
S3 bucket이 principal로 지정되어 있고, S3 buckets에는 계정 ID가 없기 때문에, 당신이 **버킷을 삭제했고 attacker가** 자신의 계정에 생성했다면, 그들은 이를 악용할 수 있습니다.

#### 지원되지 않음
```json
{
"Effect": "Allow",
"Principal": { "Service": "cloudtrail.amazonaws.com" },
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
A common way to avoid Confused Deputy problems is the use of a condition with `AWS:SourceArn` to check the origin ARN. However, **일부 서비스는 이를 지원하지 않을 수 있습니다** (예: 일부 자료에 따르면 CloudTrail).

### 자격 증명 삭제
다음 권한 중 어느 하나라도 — `iam:DeleteAccessKey`, `iam:DeleteLoginProfile`, `iam:DeleteSSHPublicKey`, `iam:DeleteServiceSpecificCredential`, `iam:DeleteInstanceProfile`, `iam:DeleteServerCertificate`, `iam:DeleteCloudFrontPublicKey`, `iam:RemoveRoleFromInstanceProfile` — 가 있으면 행위자는 액세스 키, 로그인 프로필, SSH 키, 서비스 전용 자격 증명, 인스턴스 프로필, 인증서 또는 CloudFront 공개 키를 삭제하거나 인스턴스 프로필에서 역할을 분리할 수 있습니다. 이러한 조치는 정당한 사용자와 애플리케이션의 접근을 즉시 차단하고, 해당 자격 증명에 의존하는 시스템에 대해 denial-of-service 또는 접근 상실을 초래할 수 있으므로, 이러한 IAM 권한은 엄격하게 제한되고 모니터링되어야 합니다.
```bash
# Remove Access Key of a user
aws iam delete-access-key \
--user-name <Username> \
--access-key-id AKIAIOSFODNN7EXAMPLE

## Remove ssh key of a user
aws iam delete-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE
```
### 아이덴티티 삭제
예를 들어 `iam:DeleteUser`, `iam:DeleteGroup`, `iam:DeleteRole`, `iam:RemoveUserFromGroup` 같은 권한이 있으면 행위자는 사용자, 역할, 그룹을 삭제하거나 그룹 구성원을 변경하여 아이덴티티와 관련된 흔적을 제거할 수 있습니다. 이는 해당 아이덴티티에 의존하는 사람과 서비스의 접근을 즉시 차단해 서비스 거부나 접근 상실을 초래할 수 있으므로, 이러한 IAM 액션은 엄격히 제한되고 모니터링되어야 합니다.
```bash
# Delete a user
aws iam delete-user \
--user-name <Username>

# Delete a group
aws iam delete-group \
--group-name <Username>

# Delete a role
aws iam delete-role \
--role-name <Role>
```
###
다음 권한 중 하나라도 있으면 — `iam:DeleteGroupPolicy`, `iam:DeleteRolePolicy`, `iam:DeleteUserPolicy`, `iam:DeletePolicy`, `iam:DeletePolicyVersion`, `iam:DeleteRolePermissionsBoundary`, `iam:DeleteUserPermissionsBoundary`, `iam:DetachGroupPolicy`, `iam:DetachRolePolicy`, `iam:DetachUserPolicy` — 행위자는 관리형/인라인 정책을 삭제하거나 분리(detach)하고, 정책 버전을 제거하거나 permissions boundaries를 삭제하며, 사용자·그룹·역할에서 정책 연결을 해제할 수 있습니다. 이는 권한을 파괴하고 권한 모델을 변경하여 해당 정책에 의존하던 주체의 즉각적인 접근 상실이나 서비스 거부를 초래할 수 있으므로 이러한 IAM 작업은 엄격히 제한되고 모니터링되어야 합니다.
```bash
# Delete a group policy
aws iam delete-group-policy \
--group-name <GroupName> \
--policy-name <PolicyName>

# Delete a role policy
aws iam delete-role-policy \
--role-name <RoleName> \
--policy-name <PolicyName>
```
### 연합 신원 삭제
`iam:DeleteOpenIDConnectProvider`, `iam:DeleteSAMLProvider`, 및 `iam:RemoveClientIDFromOpenIDConnectProvider` 권한으로 공격자는 OIDC/SAML identity providers를 삭제하거나 client ID를 제거할 수 있습니다. 이는 연합 인증을 중단시켜 토큰 검증을 방해하고 IdP 또는 설정이 복구될 때까지 SSO에 의존하는 사용자 및 서비스의 접근을 즉시 차단합니다.
```bash
# Delete OIDCP provider
aws iam delete-open-id-connect-provider \
--open-id-connect-provider-arn arn:aws:iam::111122223333:oidc-provider/accounts.google.com

# Delete SAML provider
aws iam delete-saml-provider \
--saml-provider-arn arn:aws:iam::111122223333:saml-provider/CorporateADFS
```
### 무단 MFA 활성화
`iam:EnableMFADevice` 권한을 통해 행위자는 사용자의 계정에 MFA 디바이스를 등록하여 정당한 사용자의 로그인을 차단할 수 있습니다. 무단 MFA가 활성화되면 해당 디바이스가 제거되거나 재설정될 때까지 사용자가 로그인을 하지 못할 수 있습니다(참고: 여러 MFA 디바이스가 등록된 경우 로그인을 위해 하나만 필요하므로 이 공격은 접근 차단에는 영향을 미치지 않습니다).
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
### 인증서/키 메타데이터 변조
`iam:UpdateSSHPublicKey`, `iam:UpdateCloudFrontPublicKey`, `iam:UpdateSigningCertificate`, `iam:UpdateServerCertificate` 권한을 통해 공격자는 공개 키와 인증서의 상태 또는 메타데이터를 변경할 수 있습니다. 키/인증서를 비활성화하거나 참조를 변경함으로써 SSH 인증을 중단시키고 X.509/TLS 검증을 무효화하며, 해당 자격 증명에 의존하는 서비스를 즉시 중단시켜 접근 또는 가용성 상실을 초래할 수 있습니다.
```bash
aws iam update-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE \
--status Inactive

aws iam update-server-certificate \
--server-certificate-name <Certificate_Name> \
--new-path /prod/
```
### `iam:Delete*`

The IAM wildcard iam:Delete*은 users, roles, groups, policies, keys, certificates, MFA devices, policy versions 등 많은 종류의 IAM 리소스를 제거할 수 있는 권한을 부여합니다 — 따라서 영향 범위가 매우 큽니다: iam:Delete* 권한을 가진 행위자는 identities, credentials, policies 및 관련 산출물을 영구적으로 파괴하고, 감사/증거를 제거하며, 서비스 또는 운영 중단을 초래할 수 있습니다. 몇 가지 예는
```bash
# Delete a user
aws iam delete-user --user-name <Username>

# Delete a role
aws iam delete-role --role-name <RoleName>

# Delete a managed policy
aws iam delete-policy --policy-arn arn:aws:iam::<ACCOUNT_ID>:policy/<PolicyName>
```
### `iam:EnableMFADevice`

iam:EnableMFADevice 권한이 부여된 행위자는 해당 계정의 아이덴티티에 대해 MFA 장치를 등록할 수 있습니다(해당 사용자가 이미 활성화하지 않은 경우에 한함). 이는 사용자의 접근을 방해하는 데 사용할 수 있습니다: 공격자가 MFA 장치를 등록하면 정당한 사용자는 공격자가 등록한 MFA를 제어하지 못해 로그인할 수 없게 될 수 있습니다.

이 접근 차단 공격은 사용자가 MFA를 전혀 등록하지 않은 경우에만 작동합니다; 공격자가 해당 사용자에 대해 MFA 장치를 등록하면 정당한 사용자는 그 새로운 MFA가 필요한 모든 흐름에서 차단됩니다. 사용자가 이미 하나 이상의 MFA 장치를 가지고 있다면 공격자가 제어하는 MFA를 추가해도 정당한 사용자는 차단되지 않습니다 — 사용자는 이미 보유한 어떤 MFA로든 계속 인증할 수 있습니다.

사용자에 대해 MFA 장치를 활성화(등록)하려면 공격자는 다음을 실행할 수 있습니다:
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
## 참조

- [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{{#include ../../../../banners/hacktricks-training.md}}
