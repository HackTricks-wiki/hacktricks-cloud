# AWS - IAM Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## IAM

For more information about IAM access:

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

## Confused Deputy Problem

Якщо ви **дозволяєте зовнішньому обліковому запису (A)** отримати доступ до **ролі** у вашому обліковому записі, ви, ймовірно, матимете **0 видимості** щодо **того, хто саме може отримати доступ до цього зовнішнього облікового запису**. Це проблема, тому що якщо інший зовнішній обліковий запис (B) може отримати доступ до зовнішнього облікового запису (A), можливо, що **B також зможе отримати доступ до вашого облікового запису**.

Тому, дозволяючи зовнішньому обліковому запису доступ до ролі у вашому обліковому записі, можна вказати `ExternalId`. Це "секретний" рядок, який зовнішній обліковий запис (A) **повинен вказати**, щоб **отримати роль у вашій організації**. Оскільки **зовнішній обліковий запис B не знає цього рядка**, навіть якщо він має доступ до A, він **не зможе отримати доступ до вашої ролі**.

<figure><img src="../../../images/image (95).png" alt=""><figcaption></figcaption></figure>

Зверніть увагу, що цей `ExternalId` "секрет" **не є секретом** — будь-хто, хто може **прочитати IAM assume role policy, зможе його побачити**. Але доки зовнішній обліковий запис A його знає, а зовнішній обліковий запис **B — ні**, це **перешкоджає B зловживати A для доступу до вашої ролі**.

Example:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
> [!WARNING]
> Щоб attacker міг експлуатувати confused deputy, йому потрібно якимось чином з'ясувати, чи можуть principals поточного облікового запису імітувати roles в інших облікових записах.

### Неочікувані довірчі відносини

#### Wildcard як principal
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" }
}
```
Ця політика **дозволяє всім AWS** приймати цю роль.

#### Сервіс як суб'єкт
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
Ця політика **дозволяє будь-якому обліковому запису** налаштувати свій apigateway для виклику цього Lambda.

#### S3 як principal
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
Якщо як principal вказано S3 bucket, оскільки S3 buckets не мають Account ID, якщо ви **видалили свій bucket і зловмисник створив** його в своєму акаунті, то зловмисник міг би цим зловживати.

#### Не підтримується
```json
{
"Effect": "Allow",
"Principal": { "Service": "cloudtrail.amazonaws.com" },
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
Звичний спосіб уникнення проблем Confused Deputy — використання умови з `AWS:SourceArn` для перевірки ARN джерела. Однак **деякі сервіси можуть цього не підтримувати** (наприклад, CloudTrail, за деякими джерелами).

### Видалення облікових даних
Маючи будь-який із наступних дозволів — `iam:DeleteAccessKey`, `iam:DeleteLoginProfile`, `iam:DeleteSSHPublicKey`, `iam:DeleteServiceSpecificCredential`, `iam:DeleteInstanceProfile`, `iam:DeleteServerCertificate`, `iam:DeleteCloudFrontPublicKey`, `iam:RemoveRoleFromInstanceProfile` — актор може видаляти access keys, login profiles, SSH keys, service-specific credentials, instance profiles, certificates або CloudFront public keys, або відв'язувати ролі від instance profiles. Такі дії можуть негайно заблокувати легітимних користувачів та додатки і спричинити denial-of-service або втрату доступу для систем, що залежать від цих облікових даних, тому ці IAM permissions мають бути суворо обмежені та відстежувані.
```bash
# Remove Access Key of a user
aws iam delete-access-key \
--user-name <Username> \
--access-key-id AKIAIOSFODNN7EXAMPLE

## Remove ssh key of a user
aws iam delete-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE
```
### Видалення ідентичностей
Маючи дозволи на кшталт `iam:DeleteUser`, `iam:DeleteGroup`, `iam:DeleteRole` або `iam:RemoveUserFromGroup`, актор може видаляти користувачів, ролі або групи — або змінювати членство в групі — видаляючи ідентичності та пов'язані сліди. Це може негайно порушити доступ для людей та сервісів, які залежать від цих ідентичностей, спричинивши denial-of-service або втрату доступу, тому ці дії IAM мають бути суворо обмежені й моніторовані.
```bash
# Delete a user
aws iam delete-user \
--user-name <Username>

# Delete a group
aws iam delete-group \
--group-name <Username>

# Delete a role
aws iam delete-role \
--role-name <Role>
```
###
Маючи будь-який із наступних дозволів — `iam:DeleteGroupPolicy`, `iam:DeleteRolePolicy`, `iam:DeleteUserPolicy`, `iam:DeletePolicy`, `iam:DeletePolicyVersion`, `iam:DeleteRolePermissionsBoundary`, `iam:DeleteUserPermissionsBoundary`, `iam:DetachGroupPolicy`, `iam:DetachRolePolicy`, `iam:DetachUserPolicy` — актор може видаляти або від'єднувати керовані/вбудовані (inline) політики, видаляти версії політик або межі дозволів (permissions boundaries), а також відв'язувати політики від користувачів, груп чи ролей. Це руйнує авторизації та може змінити модель дозволів, спричиняючи негайну втрату доступу або відмову в обслуговуванні для суб'єктів, які покладалися на ці політики, тому ці IAM‑дії повинні бути суворо обмежені та підлягати моніторингу.
```bash
# Delete a group policy
aws iam delete-group-policy \
--group-name <GroupName> \
--policy-name <PolicyName>

# Delete a role policy
aws iam delete-role-policy \
--role-name <RoleName> \
--policy-name <PolicyName>
```
### Видалення федеративної ідентичності
За допомогою `iam:DeleteOpenIDConnectProvider`, `iam:DeleteSAMLProvider` та `iam:RemoveClientIDFromOpenIDConnectProvider` зловмисник може видалити провайдерів ідентичності OIDC/SAML або видалити client IDs. Це порушує федеративну автентифікацію, перешкоджаючи валідації токенів і негайно відмовляючи у доступі користувачам та сервісам, які залежать від SSO, доки IdP або конфігурації не буде відновлено.
```bash
# Delete OIDCP provider
aws iam delete-open-id-connect-provider \
--open-id-connect-provider-arn arn:aws:iam::111122223333:oidc-provider/accounts.google.com

# Delete SAML provider
aws iam delete-saml-provider \
--saml-provider-arn arn:aws:iam::111122223333:saml-provider/CorporateADFS
```
### Нелегітимна активація MFA
За допомогою `iam:EnableMFADevice` зловмисник може зареєструвати MFA-пристрій на ідентичності користувача, що завадить легітимному користувачу увійти в систему. Після того як несанкціонований MFA увімкнено, користувач може бути заблокований до видалення або скидання пристрою (примітка: якщо зареєстровано кілька MFA-пристроїв, для входу достатньо одного, тож ця атака не впливатиме на відмову в доступі).
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
### Маніпуляція метаданими сертифікатів/ключів
За допомогою `iam:UpdateSSHPublicKey`, `iam:UpdateCloudFrontPublicKey`, `iam:UpdateSigningCertificate`, `iam:UpdateServerCertificate` актор може змінити статус або метадані публічних ключів та сертифікатів. Позначивши ключі/сертифікати як неактивні або змінивши їхні посилання, він може порушити автентифікацію SSH, зробити недійсними перевірки X.509/TLS і негайно порушити роботу сервісів, які залежать від цих облікових даних, спричиняючи втрату доступу або доступності.
```bash
aws iam update-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE \
--status Inactive

aws iam update-server-certificate \
--server-certificate-name <Certificate_Name> \
--new-path /prod/
```
### `iam:Delete*`

Шаблон IAM iam:Delete* надає можливість видаляти багато типів ресурсів IAM — користувачів, ролей, груп, політик, ключів, сертифікатів, пристроїв MFA, версій політик тощо — і тому має дуже велику зону ураження: суб'єкт, якому надано iam:Delete*, може назавжди знищити ідентичності, облікові дані, політики та пов'язані артефакти, видалити аудиторські дані/докази та спричинити відмови сервісів або операційні перебої. Деякі приклади:
```bash
# Delete a user
aws iam delete-user --user-name <Username>

# Delete a role
aws iam delete-role --role-name <RoleName>

# Delete a managed policy
aws iam delete-policy --policy-arn arn:aws:iam::<ACCOUNT_ID>:policy/<PolicyName>
```
### `iam:EnableMFADevice`

Актор, якому надано дію iam:EnableMFADevice, може зареєструвати MFA device для identity в акаунті, за умови, що user раніше не мав увімкненого MFA. Це може використовуватись, щоб перешкодити доступу user: якщо attacker зареєструє MFA device, легітимному user може бути заборонено увійти, оскільки він не контролює MFA, зареєстроване attacker.

Ця атака відмови в доступі працює тільки якщо user не мав зареєстрованого MFA; якщо attacker зареєструє MFA device для цього user, легітимний user буде заблокований у будь-яких потоках, що вимагають цього нового MFA. Якщо user вже має один або більше MFA devices під своїм контролем, додавання attacker-controlled MFA не блокує легітимного user — він може продовжувати автентифікуватися, використовуючи будь-який наявний MFA.

Щоб увімкнути (зареєструвати) MFA device для user, attacker може виконати:
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
## Посилання

- [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{{#include ../../../../banners/hacktricks-training.md}}
