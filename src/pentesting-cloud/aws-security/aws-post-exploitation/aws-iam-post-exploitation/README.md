# AWS - IAM 后渗透

{{#include ../../../../banners/hacktricks-training.md}}

## IAM

关于 IAM 访问的更多信息：

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

## Confused Deputy Problem

如果你**允许外部账户 (A)** 访问你账户中的**role**，你很可能对**0 可见性**以及**究竟谁能够访问该外部账户**没有任何可见性。这是个问题，因为如果另一个外部账户 (B) 可以访问外部账户 (A)，就有可能**B 也能够访问你的账户**。

因此，在允许外部账户访问你账户中的 role 时，可以指定一个 `ExternalId`。这是一个“秘密”字符串，外部账户 (A) **需要指定**它，以便**假定你组织中的 role**。由于**外部账户 B 不会知道该字符串**，即使他可以访问 A，他也**无法访问你的 role**。

<figure><img src="../../../images/image (95).png" alt=""><figcaption></figcaption></figure>

但是请注意，这个 `ExternalId` “秘密”**并不是真正的秘密**，任何能够**读取 IAM assume role policy 的人都能看到它**。但只要外部账户 A 知道它，而外部账户 **B 不知道它**，它就能**阻止 B 滥用 A 来访问你的 role**。

示例：
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
> [!WARNING]
> 要让攻击者利用 confused deputy，他需要以某种方式确认当前 account 的 principals 是否能 impersonate 其他 accounts 中的 roles。

### 意外的信任关系

#### 通配符作为 principal
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" }
}
```
此策略**允许所有 AWS** 假设该角色。

#### 服务作为主体
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
该策略**允许任意账户**配置其 apigateway 来调用此 Lambda。

#### S3 作为主体
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
如果将 S3 bucket 指定为 principal，因为 S3 buckets 没有 Account ID，若你 **删除了你的 bucket 并且攻击者创建了** 它在他们自己的账户中，那么他们可能会滥用这一点。

#### 不支持
```json
{
"Effect": "Allow",
"Principal": { "Service": "cloudtrail.amazonaws.com" },
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
A common way to avoid Confused Deputy problems is the use of a condition with `AWS:SourceArn` to check the origin ARN. However, **some services might not support that** (like CloudTrail according to some sources).

### 凭证删除
拥有下列任一权限 — `iam:DeleteAccessKey`, `iam:DeleteLoginProfile`, `iam:DeleteSSHPublicKey`, `iam:DeleteServiceSpecificCredential`, `iam:DeleteInstanceProfile`, `iam:DeleteServerCertificate`, `iam:DeleteCloudFrontPublicKey`, `iam:RemoveRoleFromInstanceProfile` — 的主体可以删除访问密钥、登录配置文件、SSH 密钥、服务特定凭据、实例配置文件、证书或 CloudFront 公钥，或将角色从实例配置文件中解除关联。此类操作会立即阻止合法用户和应用，并可能导致 denial-of-service 或依赖这些凭证的系统失去访问，因此这些 IAM 权限必须严格限制并监控。
```bash
# Remove Access Key of a user
aws iam delete-access-key \
--user-name <Username> \
--access-key-id AKIAIOSFODNN7EXAMPLE

## Remove ssh key of a user
aws iam delete-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE
```
### Identity Deletion
拥有诸如 `iam:DeleteUser`、`iam:DeleteGroup`、`iam:DeleteRole` 或 `iam:RemoveUserFromGroup` 等权限时，行为者可以删除用户、角色或组——或更改组成员资格——移除身份及相关痕迹。 这可能立即中断依赖这些身份的人员和服务的访问，导致 denial-of-service 或访问丢失，因此这些 IAM 操作必须受到严格限制和监控。
```bash
# Delete a user
aws iam delete-user \
--user-name <Username>

# Delete a group
aws iam delete-group \
--group-name <Username>

# Delete a role
aws iam delete-role \
--role-name <Role>
```
###
拥有以下任一权限 — `iam:DeleteGroupPolicy`, `iam:DeleteRolePolicy`, `iam:DeleteUserPolicy`, `iam:DeletePolicy`, `iam:DeletePolicyVersion`, `iam:DeleteRolePermissionsBoundary`, `iam:DeleteUserPermissionsBoundary`, `iam:DetachGroupPolicy`, `iam:DetachRolePolicy`, `iam:DetachUserPolicy` — 的行为者可以删除或分离托管/内联策略、移除策略版本或权限边界，并将策略与用户、组或角色解除关联。这会破坏授权并可能改变权限模型，导致依赖这些策略的主体立即失去访问权限或遭遇拒绝服务，因此这些 IAM 操作必须被严格限制并监控。
```bash
# Delete a group policy
aws iam delete-group-policy \
--group-name <GroupName> \
--policy-name <PolicyName>

# Delete a role policy
aws iam delete-role-policy \
--role-name <RoleName> \
--policy-name <PolicyName>
```
### 联邦身份删除
使用 `iam:DeleteOpenIDConnectProvider`、`iam:DeleteSAMLProvider` 和 `iam:RemoveClientIDFromOpenIDConnectProvider`，攻击者可以删除 OIDC/SAML 身份提供者或移除客户端 ID。这样会破坏联邦认证，阻止令牌验证，并立即拒绝依赖 SSO 的用户和服务的访问，直到 IdP 或配置恢复。
```bash
# Delete OIDCP provider
aws iam delete-open-id-connect-provider \
--open-id-connect-provider-arn arn:aws:iam::111122223333:oidc-provider/accounts.google.com

# Delete SAML provider
aws iam delete-saml-provider \
--saml-provider-arn arn:aws:iam::111122223333:saml-provider/CorporateADFS
```
### Illegitimate MFA Activation
使用 `iam:EnableMFADevice`，攻击者可以在用户的身份上注册一个 MFA 设备，从而阻止合法用户登录。一旦启用了未授权的 MFA，用户可能会被锁定无法访问，直到该设备被移除或重置（注意：如果注册了多个 MFA 设备，登录只需要其中一个，因此此攻击不会影响阻止访问）。
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
### Certificate/Key Metadata Tampering
使用 `iam:UpdateSSHPublicKey`、`iam:UpdateCloudFrontPublicKey`、`iam:UpdateSigningCertificate`、`iam:UpdateServerCertificate`，攻击者可以更改公钥和证书的状态或元数据。通过将密钥/证书标记为失效或更改引用，他们可以破坏 SSH 认证、使 X.509/TLS 验证失效，并立即中断依赖这些凭证的服务，导致访问或可用性丧失。
```bash
aws iam update-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE \
--status Inactive

aws iam update-server-certificate \
--server-certificate-name <Certificate_Name> \
--new-path /prod/
```
### `iam:Delete*`

IAM 通配符 iam:Delete* 赋予删除多种 IAM 资源（用户、角色、组、策略、密钥、证书、MFA 设备、策略版本等）的能力——因此具有非常大的影响范围：被授予 iam:Delete* 的主体可以永久销毁身份、凭证、策略及相关工件，删除审计/证据，并导致服务或运营中断。以下是一些示例：
```bash
# Delete a user
aws iam delete-user --user-name <Username>

# Delete a role
aws iam delete-role --role-name <RoleName>

# Delete a managed policy
aws iam delete-policy --policy-arn arn:aws:iam::<ACCOUNT_ID>:policy/<PolicyName>
```
### `iam:EnableMFADevice`

被授予 `iam:EnableMFADevice` 操作的 actor 可以在账户中的某个 identity 上为其注册一个 MFA device，前提是该 user 之前没有启用过 MFA。攻击者可以利用这一点干扰 user 的访问：一旦 attacker 注册了 MFA device，legitimate user 可能会无法登录，因为他们无法控制 attacker 注册的 MFA。

这种拒绝访问攻击仅在 user 之前未注册任何 MFA 时有效；如果 attacker 为该 user 注册了 MFA device，legitimate user 将会在任何需要该新 MFA 的流程中被锁定。如果该 user 已经拥有一个或多个 MFA devices，添加一个 attacker 控制的 MFA 并不会阻止 legitimate user —— 他们仍可使用已经拥有的任意 MFA 继续进行身份验证。

为了为某个 user 启用（注册）MFA device，attacker 可以运行：
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
## 参考资料

- [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{{#include ../../../../banners/hacktricks-training.md}}
