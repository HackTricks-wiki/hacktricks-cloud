# AWS - IAM Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## IAM

Για περισσότερες πληροφορίες σχετικά με την πρόσβαση στο IAM:

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

## Confused Deputy Problem

Εάν **επιτρέψετε σε έναν εξωτερικό λογαριασμό (A)** να αποκτήσει πρόσβαση σε έναν **role** στον λογαριασμό σας, πιθανότατα θα έχετε **μηδενική ορατότητα** για το **ποιος ακριβώς μπορεί να αποκτήσει πρόσβαση σε αυτόν τον εξωτερικό λογαριασμό**. Αυτό είναι πρόβλημα, επειδή αν ένας άλλος εξωτερικός λογαριασμός (B) μπορεί να αποκτήσει πρόσβαση στον εξωτερικό λογαριασμό (A), τότε είναι πιθανό ότι **και ο B θα μπορεί επίσης να αποκτήσει πρόσβαση στον λογαριασμό σας**.

Συνεπώς, όταν επιτρέπετε σε έναν εξωτερικό λογαριασμό να αποκτήσει πρόσβαση σε έναν role στον λογαριασμό σας, είναι δυνατόν να καθορίσετε ένα `ExternalId`. Αυτή είναι μια "μυστική" συμβολοσειρά που ο εξωτερικός λογαριασμός (A) **πρέπει να καθορίσει** προκειμένου να **assume the role in your organization**. Καθώς ο **εξωτερικός λογαριασμός B δεν θα γνωρίζει αυτή τη συμβολοσειρά**, ακόμα κι αν έχει πρόσβαση στον A, **δεν θα μπορεί να αποκτήσει πρόσβαση στον role σας**.

<figure><img src="../../../images/image (95).png" alt=""><figcaption></figcaption></figure>

Ωστόσο, σημειώστε ότι αυτό το `ExternalId` "μυστικό" **δεν είναι μυστικό** — οποιοσδήποτε που μπορεί να **διαβάσει την IAM assume role policy θα μπορεί να το δει**. Αλλά όσο ο εξωτερικός λογαριασμός A το γνωρίζει, και ο εξωτερικός λογαριασμός **B δεν το γνωρίζει**, αυτό **αποτρέπει τον B από το να καταχραστεί τον A για να αποκτήσει πρόσβαση στον role σας**.

Παράδειγμα:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
> [!WARNING]
> Για να εκμεταλλευτεί ένας attacker έναν confused deputy, θα χρειαστεί να βρει με κάποιο τρόπο αν οι principals του τρέχοντος account μπορούν να impersonate roles σε άλλα accounts.

### Απροσδόκητες εμπιστοσύνες

#### Wildcard ως principal
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" }
}
```
Αυτή η πολιτική **επιτρέπει όλα τα AWS** να αναλάβουν τον ρόλο.

#### Υπηρεσία ως principal
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
Αυτή η πολιτική **επιτρέπει σε οποιονδήποτε λογαριασμό** να διαμορφώσει το apigateway τους για να καλέσει αυτό το Lambda.

#### S3 ως principal
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
Εάν ένα S3 bucket δοθεί ως principal, επειδή τα S3 buckets δεν έχουν Account ID, αν **διαγράψατε το bucket σας και ο attacker το δημιούργησε** στο δικό του account, τότε θα μπορούσαν να το εκμεταλλευτούν.

#### Δεν υποστηρίζεται
```json
{
"Effect": "Allow",
"Principal": { "Service": "cloudtrail.amazonaws.com" },
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
Ένας κοινός τρόπος για να αποφύγετε προβλήματα Confused Deputy είναι η χρήση μιας συνθήκης με `AWS:SourceArn` για να ελεγχθεί το origin ARN. Ωστόσο, **κάποιες υπηρεσίες μπορεί να μην το υποστηρίζουν** (όπως το CloudTrail σύμφωνα με ορισμένες πηγές).

### Διαγραφή διαπιστευτηρίων
Με οποιαδήποτε από τις ακόλουθες άδειες — `iam:DeleteAccessKey`, `iam:DeleteLoginProfile`, `iam:DeleteSSHPublicKey`, `iam:DeleteServiceSpecificCredential`, `iam:DeleteInstanceProfile`, `iam:DeleteServerCertificate`, `iam:DeleteCloudFrontPublicKey`, `iam:RemoveRoleFromInstanceProfile` — ένας actor μπορεί να αφαιρέσει access keys, login profiles, SSH keys, service-specific credentials, instance profiles, certificates ή CloudFront public keys, ή να αποσυνδέσει roles από instance profiles. Τέτοιες ενέργειες μπορούν να μπλοκάρουν άμεσα νόμιμους χρήστες και εφαρμογές και να προκαλέσουν denial-of-service ή απώλεια πρόσβασης για συστήματα που εξαρτώνται από αυτά τα credentials, γι' αυτό αυτές οι IAM permissions πρέπει να περιορίζονται αυστηρά και να παρακολουθούνται.
```bash
# Remove Access Key of a user
aws iam delete-access-key \
--user-name <Username> \
--access-key-id AKIAIOSFODNN7EXAMPLE

## Remove ssh key of a user
aws iam delete-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE
```
### Διαγραφή ταυτότητας
Με δικαιώματα όπως `iam:DeleteUser`, `iam:DeleteGroup`, `iam:DeleteRole`, ή `iam:RemoveUserFromGroup`, ένας παράγοντας μπορεί να διαγράψει χρήστες, ρόλους ή ομάδες — ή να αλλάξει τη συμμετοχή σε ομάδα — αφαιρώντας ταυτότητες και τα συνοδευτικά τους ίχνη. Αυτό μπορεί να διακόψει άμεσα την πρόσβαση για άτομα και υπηρεσίες που εξαρτώνται από αυτές τις ταυτότητες, προκαλώντας denial-of-service ή απώλεια πρόσβασης, οπότε αυτές οι IAM ενέργειες πρέπει να περιορίζονται αυστηρά και να παρακολουθούνται.
```bash
# Delete a user
aws iam delete-user \
--user-name <Username>

# Delete a group
aws iam delete-group \
--group-name <Username>

# Delete a role
aws iam delete-role \
--role-name <Role>
```
###
Με οποιαδήποτε από τις ακόλουθες permissions — `iam:DeleteGroupPolicy`, `iam:DeleteRolePolicy`, `iam:DeleteUserPolicy`, `iam:DeletePolicy`, `iam:DeletePolicyVersion`, `iam:DeleteRolePermissionsBoundary`, `iam:DeleteUserPermissionsBoundary`, `iam:DetachGroupPolicy`, `iam:DetachRolePolicy`, `iam:DetachUserPolicy` — ένας δράστης μπορεί να διαγράψει ή να αποσυνδέσει managed/inline policies, να αφαιρέσει policy versions ή permissions boundaries, και να αποσυνδέσει policies από users, groups ή roles. Αυτό καταστρέφει εξουσιοδοτήσεις και μπορεί να αλλάξει το permissions model, προκαλώντας άμεση απώλεια πρόσβασης ή denial-of-service για principals που εξαρτώνταν από αυτές τις policies, οπότε αυτές οι IAM ενέργειες πρέπει να περιορίζονται αυστηρά και να παρακολουθούνται.
```bash
# Delete a group policy
aws iam delete-group-policy \
--group-name <GroupName> \
--policy-name <PolicyName>

# Delete a role policy
aws iam delete-role-policy \
--role-name <RoleName> \
--policy-name <PolicyName>
```
### Federated Identity Deletion
Με `iam:DeleteOpenIDConnectProvider`, `iam:DeleteSAMLProvider`, και `iam:RemoveClientIDFromOpenIDConnectProvider`, ένας δράστης μπορεί να διαγράψει παρόχους ταυτότητας OIDC/SAML ή να αφαιρέσει client IDs. Αυτό διακόπτει την ομοσπονδοποιημένη αυθεντικοποίηση, εμποδίζοντας την επικύρωση token και οδηγώντας σε άμεση άρνηση πρόσβασης σε χρήστες και υπηρεσίες που βασίζονται στο SSO μέχρι να αποκατασταθεί ο IdP ή οι ρυθμίσεις.
```bash
# Delete OIDCP provider
aws iam delete-open-id-connect-provider \
--open-id-connect-provider-arn arn:aws:iam::111122223333:oidc-provider/accounts.google.com

# Delete SAML provider
aws iam delete-saml-provider \
--saml-provider-arn arn:aws:iam::111122223333:saml-provider/CorporateADFS
```
### Μη εξουσιοδοτημένη Ενεργοποίηση MFA
Με το `iam:EnableMFADevice`, ένας δράστης μπορεί να εγγράψει μια συσκευή MFA στην ταυτότητα ενός χρήστη, εμποδίζοντας τον νόμιμο χρήστη να συνδεθεί. Μόλις ενεργοποιηθεί μια μη εξουσιοδοτημένη συσκευή MFA, ο χρήστης μπορεί να αποκλειστεί μέχρι να αφαιρεθεί ή να επαναρυθμιστεί η συσκευή (σημείωση: εάν καταχωρηθούν πολλές συσκευές MFA, για τη σύνδεση απαιτείται μόνο μία, οπότε αυτή η επίθεση δεν θα έχει αποτέλεσμα στον αποκλεισμό πρόσβασης).
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
### Παραποίηση μεταδεδομένων πιστοποιητικού/κλειδιού
Με τις `iam:UpdateSSHPublicKey`, `iam:UpdateCloudFrontPublicKey`, `iam:UpdateSigningCertificate`, `iam:UpdateServerCertificate`, ένας δράστης μπορεί να αλλάξει την κατάσταση ή τα μεταδεδομένα των δημόσιων κλειδιών και πιστοποιητικών. Με την επισήμανση κλειδιών/πιστοποιητικών ως ανενεργά ή την τροποποίηση αναφορών, μπορούν να διακόψουν την αυθεντικοποίηση SSH, να ακυρώσουν τους ελέγχους εγκυρότητας X.509/TLS και να διαταράξουν άμεσα υπηρεσίες που εξαρτώνται από αυτά τα διαπιστευτήρια, προκαλώντας απώλεια πρόσβασης ή διαθεσιμότητας.
```bash
aws iam update-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE \
--status Inactive

aws iam update-server-certificate \
--server-certificate-name <Certificate_Name> \
--new-path /prod/
```
### `iam:Delete*`

Το IAM wildcard iam:Delete* δίνει τη δυνατότητα να αφαιρεθούν πολλοί τύποι πόρων IAM — χρήστες, ρόλοι, ομάδες, πολιτικές, κλειδιά, πιστοποιητικά, συσκευές MFA, εκδόσεις πολιτικών κ.λπ. — και ως εκ τούτου έχει πολύ μεγάλο blast radius: ένας παράγοντας που του έχει χορηγηθεί iam:Delete* μπορεί να καταστρέψει μόνιμα ταυτότητες, διαπιστευτήρια, πολιτικές και σχετικά αντικείμενα, να αφαιρέσει audit/evidence, και να προκαλέσει διακοπές υπηρεσίας ή λειτουργίας. Μερικά παραδείγματα είναι
```bash
# Delete a user
aws iam delete-user --user-name <Username>

# Delete a role
aws iam delete-role --role-name <RoleName>

# Delete a managed policy
aws iam delete-policy --policy-arn arn:aws:iam::<ACCOUNT_ID>:policy/<PolicyName>
```
### `iam:EnableMFADevice`

Ένας παράγων που του έχει χορηγηθεί η ενέργεια iam:EnableMFADevice μπορεί να εγγράψει μια συσκευή MFA σε μια ταυτότητα στον λογαριασμό, εφόσον ο χρήστης δεν είχε ήδη κάποια ενεργοποιημένη. Αυτό μπορεί να χρησιμοποιηθεί για να παρεμποδίσει την πρόσβαση ενός χρήστη: μόλις ένας attacker εγγράψει μια συσκευή MFA, ο νόμιμος χρήστης ενδέχεται να εμποδιστεί από το να πραγματοποιήσει σύνδεση επειδή δεν ελέγχει την attacker-registered MFA.

Αυτή η επίθεση άρνησης πρόσβασης λειτουργεί μόνο αν ο χρήστης δεν είχε καμία MFA εγγεγραμμένη· αν ο attacker εγγράψει μια συσκευή MFA για εκείνον τον χρήστη, ο νόμιμος χρήστης θα αποκλειστεί από οποιεσδήποτε ροές που απαιτούν αυτή τη νέα MFA. Εάν ο χρήστης ήδη διαθέτει μια ή περισσότερες συσκευές MFA υπό τον έλεγχό του, η προσθήκη μιας attacker-controlled MFA δεν μπλοκάρει τον νόμιμο χρήστη — μπορεί να συνεχίσει να πιστοποιείται χρησιμοποιώντας οποιαδήποτε MFA έχει ήδη.

Για να ενεργοποιήσει (εγγράψει) μια συσκευή MFA για έναν χρήστη, ένας attacker θα μπορούσε να εκτελέσει:
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
## Αναφορές

- [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{{#include ../../../../banners/hacktricks-training.md}}
