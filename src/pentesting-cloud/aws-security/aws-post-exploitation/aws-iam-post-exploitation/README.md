# AWS - IAM Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## IAM

IAM erişimi hakkında daha fazla bilgi için:

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

## Confused Deputy Problemi

Eğer bir **harici hesaba (A)** hesabınızdaki bir **role** erişim izni verirseniz, muhtemelen **bu harici hesaba kimin tam olarak erişebildiği** konusunda **hiç (0) görünürlüğe** sahip olmazsınız. Bu bir sorundur; çünkü başka bir harici hesap (B), A'ya erişebiliyorsa, **B'nin de hesabınıza erişebilmesi** mümkündür.

Bu nedenle, bir harici hesaba hesabınızdaki bir role erişim izni verirken bir `ExternalId` belirtmek mümkündür. Bu, harici hesap (A)'nın organizasyonunuzdaki role'ü üstlenebilmek için belirtmesi gereken bir "gizli" dizgedir. Harici hesap B bu dizgeyi bilmediğinden, A'ya erişimi olsa bile hesabınızdaki role'e erişemeyecektir.

<figure><img src="../../../images/image (95).png" alt=""><figcaption></figcaption></figure>

Ancak, bu `ExternalId` "gizli" bilgisinin **aslında gizli olmadığını** unutmayın; IAM assume role policy'yi **okuyabilen herkes bunu görebilir**. Yine de, harici hesap A bunu bildiği sürece ve harici hesap **B bunu bilmediği sürece**, bu durum **B'nin A'yı kötüye kullanarak hesabınızdaki role'e erişmesini engeller**.

Örnek:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
> [!WARNING]
> Bir saldırganın bir confused deputy'i istismar edebilmesi için, mevcut hesapta yer alan principals'ın diğer hesaplardaki roles'leri impersonate edip edemediğini bir şekilde tespit etmesi gerekir.

### Beklenmeyen Güven İlişkileri

#### Principal olarak wildcard
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" }
}
```
Bu politika **tüm AWS'nin** rolü üstlenmesini sağlar.

#### Hizmetin principal olarak kullanılması
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
#### S3 principal olarak

Bu politika **herhangi bir hesabın** apigateway'ini yapılandırarak bu Lambda'yı çağırmasına izin verir.
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
Eğer bir S3 bucket principal olarak verildiyse — çünkü S3 bucket'ların bir Account ID'si yoktur — siz **deleted your bucket and the attacker created** ise ve attacker bunu kendi hesabında oluşturduysa, bunu suistimal edebilirler.

#### Desteklenmiyor
```json
{
"Effect": "Allow",
"Principal": { "Service": "cloudtrail.amazonaws.com" },
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
Confused Deputy sorunlarından kaçınmanın yaygın yollarından biri, kaynağın ARN'sini kontrol etmek için `AWS:SourceArn` ile bir koşul kullanmaktır. Ancak, **bazı servisler bunu desteklemeyebilir** (bazı kaynaklara göre CloudTrail gibi).

### Kimlik Bilgilerinin Silinmesi
With any of the following permissions — `iam:DeleteAccessKey`, `iam:DeleteLoginProfile`, `iam:DeleteSSHPublicKey`, `iam:DeleteServiceSpecificCredential`, `iam:DeleteInstanceProfile`, `iam:DeleteServerCertificate`, `iam:DeleteCloudFrontPublicKey`, `iam:RemoveRoleFromInstanceProfile` — an actor can remove access keys, login profiles, SSH keys, service-specific credentials, instance profiles, certificates or CloudFront public keys, or disassociate roles from instance profiles. Such actions can immediately block legitimate users and applications and cause denial-of-service or loss of access for systems that depend on those credentials, so these IAM permissions must be tightly restricted and monitored.
```bash
# Remove Access Key of a user
aws iam delete-access-key \
--user-name <Username> \
--access-key-id AKIAIOSFODNN7EXAMPLE

## Remove ssh key of a user
aws iam delete-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE
```
### Kimlik Silme
`iam:DeleteUser`, `iam:DeleteGroup`, `iam:DeleteRole` veya `iam:RemoveUserFromGroup` gibi izinlerle bir aktör kullanıcıları, rolleri veya grupları silebilir ya da grup üyeliğini değiştirebilir — böylece kimlikleri ve bunlarla ilişkili izleri kaldırır. Bu, bu kimliklere bağlı kişi ve hizmetlerin erişimini anında bozarak hizmet reddine veya erişim kaybına neden olabilir; bu yüzden bu IAM eylemleri sıkı şekilde kısıtlanmalı ve izlenmelidir.
```bash
# Delete a user
aws iam delete-user \
--user-name <Username>

# Delete a group
aws iam delete-group \
--group-name <Username>

# Delete a role
aws iam delete-role \
--role-name <Role>
```
###
Bu izinlerden herhangi biri — `iam:DeleteGroupPolicy`, `iam:DeleteRolePolicy`, `iam:DeleteUserPolicy`, `iam:DeletePolicy`, `iam:DeletePolicyVersion`, `iam:DeleteRolePermissionsBoundary`, `iam:DeleteUserPermissionsBoundary`, `iam:DetachGroupPolicy`, `iam:DetachRolePolicy`, `iam:DetachUserPolicy` — bir aktörün yönetilen/inline politikaları silmesine veya ayırmasına, politika sürümlerini veya izin sınırlarını kaldırmasına ve politikaların kullanıcılar, gruplar veya rollerle bağlantısını kesmesine olanak tanır. Bu yetkilendirmeleri yok eder ve izin modelini değiştirebilir; bu da bu politikalara bağlı olan principal'lar için anında erişim kaybına veya denial-of-service'e yol açabilir, bu yüzden bu IAM eylemleri sıkı şekilde kısıtlanmalı ve izlenmelidir.
```bash
# Delete a group policy
aws iam delete-group-policy \
--group-name <GroupName> \
--policy-name <PolicyName>

# Delete a role policy
aws iam delete-role-policy \
--role-name <RoleName> \
--policy-name <PolicyName>
```
### Federated Kimlik Silme
With `iam:DeleteOpenIDConnectProvider`, `iam:DeleteSAMLProvider`, and `iam:RemoveClientIDFromOpenIDConnectProvider`, bir aktör OIDC/SAML kimlik sağlayıcılarını silebilir veya client ID'lerini kaldırabilir. Bu, federated authentication'ı bozarak token doğrulamayı engeller ve IdP veya yapılandırmalar geri yüklenene kadar SSO'ya dayanan kullanıcılar ve servisler için erişimi derhal engeller.
```bash
# Delete OIDCP provider
aws iam delete-open-id-connect-provider \
--open-id-connect-provider-arn arn:aws:iam::111122223333:oidc-provider/accounts.google.com

# Delete SAML provider
aws iam delete-saml-provider \
--saml-provider-arn arn:aws:iam::111122223333:saml-provider/CorporateADFS
```
### Yetkisiz MFA Etkinleştirme
`iam:EnableMFADevice` ile bir aktör, bir kullanıcının kimliğine bir MFA cihazı kaydedebilir ve meşru kullanıcının oturum açmasını engelleyebilir. Yetkisiz bir MFA etkinleştirildiğinde kullanıcı, cihaz kaldırılana veya sıfırlanana kadar kilitlenebilir (Not: birden fazla MFA cihazı kaydedildiyse, oturum açmak için yalnızca biri yeterlidir; bu nedenle bu saldırı erişimi engellemede etkili olmayacaktır).
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
### Sertifika/Anahtar Meta Veri Değiştirme
With `iam:UpdateSSHPublicKey`, `iam:UpdateCloudFrontPublicKey`, `iam:UpdateSigningCertificate`, `iam:UpdateServerCertificate`, bir aktör açık anahtarların ve sertifikaların durumunu veya meta verilerini değiştirebilir. Anahtarları/sertifikaları devre dışı bırakarak veya referansları değiştirerek SSH kimlik doğrulamayı bozabilir, X.509/TLS doğrulamalarını geçersiz kılabilir ve bu kimlik bilgilerine bağımlı hizmetleri derhal aksatabilir; bu da erişim veya kullanılabilirlik kaybına neden olur.
```bash
aws iam update-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE \
--status Inactive

aws iam update-server-certificate \
--server-certificate-name <Certificate_Name> \
--new-path /prod/
```
## Kaynaklar

- [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{{#include ../../../../banners/hacktricks-training.md}}
