# AWS - IAM Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## IAM

Za više informacija o pristupu IAM-u:

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

## Problem "Confused Deputy"

Ako dozvolite eksternom nalogu (A) da pristupi roli u vašem nalogu, verovatno nećete imati nikakvu vidljivost ko tačno može da pristupi tom eksternom nalogu. To je problem, jer ako drugi eksterni nalog (B) može da pristupi eksternom nalogu (A), moguće je da će i B moći da pristupi vašem nalogu.

Zato, kada dozvoljavate eksternom nalogu pristup roli u vašem nalogu, moguće je navesti `ExternalId`. To je "tajni" string koji eksterni nalog (A) mora da navede da bi preuzeo rolu u vašoj organizaciji. Pošto eksterni nalog B neće znati ovaj string, čak i ako ima pristup nalogu A, neće moći da pristupi vašoj roli.

<figure><img src="../../../images/image (95).png" alt=""><figcaption></figcaption></figure>

Međutim, imajte na umu da ovaj `ExternalId` "tajni" **nije tajna** — svako ko može da pročita IAM assume role policy će ga moći videti. Ali dokle god eksterni nalog A zna taj string, a eksterni nalog **B ga ne zna**, to **sprečava B da zloupotrebi A kako bi pristupio vašoj roli**.

Primer:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
> [!WARNING]
> Da bi attacker iskoristio confused deputy, moraće na neki način da otkrije da li principals trenutnog account-a mogu da impersonate roles u drugim account-ima.

### Neočekivana poverenja

#### Wildcard kao principal
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" }
}
```
Ova politika **dozvoljava svim AWS servisima** da preuzmu ulogu.

#### Servis kao principal
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
Ova politika **dozvoljava bilo kojem nalogu** da konfiguriše svoj apigateway da pozove ovu Lambda.

#### S3 as principal
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
Ako je S3 bucket naveden kao principal, pošto S3 buckets nemaju Account ID, ukoliko ste **obrisali svoj bucket i attacker ga je kreirao** u svom account-u, onda to mogu zloupotrebiti.

#### Nije podržano
```json
{
"Effect": "Allow",
"Principal": { "Service": "cloudtrail.amazonaws.com" },
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
A common way to avoid Confused Deputy problems is the use of a condition with `AWS:SourceArn` to check the origin ARN. However, **neke usluge možda to ne podržavaju** (kao CloudTrail prema nekim izvorima).

### Brisanje kredencijala
Sa bilo kojom od sledećih dozvola — `iam:DeleteAccessKey`, `iam:DeleteLoginProfile`, `iam:DeleteSSHPublicKey`, `iam:DeleteServiceSpecificCredential`, `iam:DeleteInstanceProfile`, `iam:DeleteServerCertificate`, `iam:DeleteCloudFrontPublicKey`, `iam:RemoveRoleFromInstanceProfile` — napadač može ukloniti pristupne ključeve, profile za prijavu, SSH ključeve, kredencijale specifične za uslugu, instance profile, sertifikate ili CloudFront public keys, ili ukloniti uloge sa instance profila. Takve radnje mogu odmah blokirati legitimne korisnike i aplikacije i prouzrokovati denial-of-service ili gubitak pristupa za sisteme koji zavise od tih kredencijala, zato ove IAM dozvole moraju biti strogo ograničene i nadzirane.
```bash
# Remove Access Key of a user
aws iam delete-access-key \
--user-name <Username> \
--access-key-id AKIAIOSFODNN7EXAMPLE

## Remove ssh key of a user
aws iam delete-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE
```
### Brisanje identiteta
Sa privilegijama kao što su `iam:DeleteUser`, `iam:DeleteGroup`, `iam:DeleteRole`, ili `iam:RemoveUserFromGroup`, napadač može obrisati korisnike, role ili grupe — ili promeniti članstvo u grupi — uklanjajući identitete i povezane tragove. Ovo može odmah prekinuti pristup ljudima i servisima koji zavise od tih identiteta, izazivajući denial-of-service ili gubitak pristupa, zato ove IAM akcije moraju biti strogo ograničene i nadgledane.
```bash
# Delete a user
aws iam delete-user \
--user-name <Username>

# Delete a group
aws iam delete-group \
--group-name <Username>

# Delete a role
aws iam delete-role \
--role-name <Role>
```
###
Sa bilo kojom od sledećih dozvola — `iam:DeleteGroupPolicy`, `iam:DeleteRolePolicy`, `iam:DeleteUserPolicy`, `iam:DeletePolicy`, `iam:DeletePolicyVersion`, `iam:DeleteRolePermissionsBoundary`, `iam:DeleteUserPermissionsBoundary`, `iam:DetachGroupPolicy`, `iam:DetachRolePolicy`, `iam:DetachUserPolicy` — akter može da obriše ili odvoji managed/inline politike, ukloni verzije politika ili permissions boundaries, i odveže politike od korisnika, grupa ili rola. Ovo uništava autorizacije i može izmeniti model dozvola, prouzrokujući trenutni gubitak pristupa ili denial-of-service za entitete koji su zavisili od tih politika, zato ove IAM akcije moraju biti strogo ograničene i nadgledane.
```bash
# Delete a group policy
aws iam delete-group-policy \
--group-name <GroupName> \
--policy-name <PolicyName>

# Delete a role policy
aws iam delete-role-policy \
--role-name <RoleName> \
--policy-name <PolicyName>
```
### Brisanje federisanog identiteta
Sa `iam:DeleteOpenIDConnectProvider`, `iam:DeleteSAMLProvider` i `iam:RemoveClientIDFromOpenIDConnectProvider`, akter može obrisati OIDC/SAML provajdere identiteta ili ukloniti client IDs. Ovo prekida federisanu autentikaciju, sprečava validaciju tokena i odmah uskraćuje pristup korisnicima i servisima koji se oslanjaju na SSO dok se IdP ili konfiguracije ne obnove.
```bash
# Delete OIDCP provider
aws iam delete-open-id-connect-provider \
--open-id-connect-provider-arn arn:aws:iam::111122223333:oidc-provider/accounts.google.com

# Delete SAML provider
aws iam delete-saml-provider \
--saml-provider-arn arn:aws:iam::111122223333:saml-provider/CorporateADFS
```
### Neovlašćena aktivacija MFA
Sa `iam:EnableMFADevice`, napadač može registrovati MFA uređaj na identitet korisnika, sprečavajući legitimnog korisnika da se prijavi. Kada je neovlašćeno MFA omogućeno, korisnik može biti zaključan dok se uređaj ne ukloni ili ne resetuje (napomena: ako je registrovano više MFA uređaja, za prijavu je dovoljan samo jedan, tako da ovaj napad neće onemogućiti pristup).
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
### Certificate/Key Metadata Tampering
Pomoću `iam:UpdateSSHPublicKey`, `iam:UpdateCloudFrontPublicKey`, `iam:UpdateSigningCertificate`, `iam:UpdateServerCertificate`, napadač može promeniti status ili metapodatke javnih ključeva i sertifikata. Označavanjem ključeva/sertifikata kao neaktivnih ili izmenom referenci, mogu onemogućiti SSH autentifikaciju, poništiti X.509/TLS verifikacije i odmah poremetiti servise koji zavise od tih kredencijala, što dovodi do gubitka pristupa ili dostupnosti.
```bash
aws iam update-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE \
--status Inactive

aws iam update-server-certificate \
--server-certificate-name <Certificate_Name> \
--new-path /prod/
```
### `iam:Delete*`

IAM wildcard iam:Delete* daje mogućnost uklanjanja mnogih vrsta IAM resursa — korisnika, rola, grupa, politika, ključeva, sertifikata, MFA uređaja, verzija politika itd. — i zbog toga ima veoma veliki domet štete: akter kojem je dodeljen iam:Delete* može trajno uništiti identitete, kredencijale, politike i povezane artefakte, ukloniti revizijske zapise/dokaze i prouzrokovati prekide usluge ili operativne zastoje. Neki primeri su
```bash
# Delete a user
aws iam delete-user --user-name <Username>

# Delete a role
aws iam delete-role --role-name <RoleName>

# Delete a managed policy
aws iam delete-policy --policy-arn arn:aws:iam::<ACCOUNT_ID>:policy/<PolicyName>
```
### `iam:EnableMFADevice`

Akter kojem je dodeljena akcija iam:EnableMFADevice može registrovati MFA uređaj na identitetu u nalogu, pod uslovom da korisnik prethodno nije imao omogućen MFA. Ovo se može iskoristiti za ometanje pristupa korisniku: kada napadač registruje MFA uređaj, legitimni korisnik može biti sprečen da se prijavi zato što ne kontroliše MFA koji je registrovao napadač.

Ovaj napad uskraćivanja pristupa funkcioniše samo ako korisnik nije imao registrovan MFA; ako napadač registruje MFA uređaj za tog korisnika, legitimni korisnik će biti zaključan iz svih tokova koji zahtevaju taj novi MFA. Ako korisnik već ima jedan ili više MFA uređaja pod svojom kontrolom, dodavanje MFA uređaja pod kontrolom napadača ne blokira legitimnog korisnika — on može nastaviti da se autentifikuje koristeći bilo koji MFA koji već poseduje.

Da bi omogućio (registrovao) MFA uređaj za korisnika, napadač bi mogao pokrenuti:
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
## Reference

- [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{{#include ../../../../banners/hacktricks-training.md}}
