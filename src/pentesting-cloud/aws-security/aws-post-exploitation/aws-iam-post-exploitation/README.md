# AWS - IAM Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## IAM

Więcej informacji o dostępie IAM:

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

## Problem zdezorientowanego zastępcy

Jeśli **pozwolisz zewnętrznemu kontu (A)** na dostęp do **roli** w Twoim koncie, prawdopodobnie będziesz mieć **0 widoczności** kto dokładnie może uzyskać dostęp do tego zewnętrznego konta. To jest problem, ponieważ jeśli inne zewnętrzne konto (B) może uzyskać dostęp do zewnętrznego konta (A), możliwe że **B również będzie mogło uzyskać dostęp do Twojego konta**.

Dlatego, przy udzielaniu zewnętrznemu kontu dostępu do roli w Twoim koncie, można określić `ExternalId`. Jest to "sekretny" ciąg znaków, który zewnętrzne konto (A) **musi podać**, aby **przyjąć rolę w Twojej organizacji**. Ponieważ zewnętrzne konto B nie będzie znało tego ciągu, nawet jeśli ma dostęp do A, **nie będzie w stanie uzyskać dostępu do Twojej roli**.

<figure><img src="../../../images/image (95).png" alt=""><figcaption></figcaption></figure>

Jednakże warto zauważyć, że ten "sekret" `ExternalId` **nie jest tajny** — każdy, kto potrafi **odczytać politykę IAM dotyczącą assume role**, będzie w stanie go zobaczyć. Ale dopóki zewnętrzne konto A go zna, a zewnętrzne konto **B go nie zna**, to **uniemożliwia B wykorzystanie A do dostępu do Twojej roli**.

Przykład:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
> [!WARNING]
> Aby atakujący mógł wykorzystać confused deputy, będzie musiał w jakiś sposób ustalić, czy podmioty (principals) bieżącego konta mogą podszywać się pod role w innych kontach.

### Nieoczekiwane zaufania

#### Wildcard jako principal
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" }
}
```
Ta polityka **pozwala wszystkim AWS** na przejęcie roli.

#### Usługa jako podmiot
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
Ta polityka **pozwala dowolnemu kontu** skonfigurować swój apigateway, aby wywołać tę Lambdę.

#### S3 jako principal
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
Jeśli S3 bucket jest podany jako principal — ponieważ S3 buckety nie mają Account ID — to jeśli **usuniesz swój bucket, a attacker go utworzy** w swoim koncie, będą mogli to wykorzystać.

#### Nieobsługiwane
```json
{
"Effect": "Allow",
"Principal": { "Service": "cloudtrail.amazonaws.com" },
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
Częstym sposobem uniknięcia problemów Confused Deputy jest użycie warunku z `AWS:SourceArn` do sprawdzenia ARN źródła. Jednakże, **niektóre usługi mogą tego nie obsługiwać** (np. CloudTrail według niektórych źródeł).

### Credential Deletion
Posiadając dowolne z następujących uprawnień — `iam:DeleteAccessKey`, `iam:DeleteLoginProfile`, `iam:DeleteSSHPublicKey`, `iam:DeleteServiceSpecificCredential`, `iam:DeleteInstanceProfile`, `iam:DeleteServerCertificate`, `iam:DeleteCloudFrontPublicKey`, `iam:RemoveRoleFromInstanceProfile` — podmiot może usunąć klucze dostępu, profile logowania, klucze SSH, poświadczenia specyficzne dla usługi, profile instancji, certyfikaty lub publiczne klucze CloudFront, albo odłączyć role od profili instancji. Takie działania mogą natychmiast zablokować uprawnionych użytkowników i aplikacje oraz spowodować denial-of-service lub utratę dostępu dla systemów, które polegają na tych poświadczeniach, dlatego te uprawnienia IAM muszą być ściśle ograniczone i monitorowane.
```bash
# Remove Access Key of a user
aws iam delete-access-key \
--user-name <Username> \
--access-key-id AKIAIOSFODNN7EXAMPLE

## Remove ssh key of a user
aws iam delete-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE
```
### Usuwanie tożsamości
Z uprawnieniami takimi jak `iam:DeleteUser`, `iam:DeleteGroup`, `iam:DeleteRole` lub `iam:RemoveUserFromGroup` podmiot może usuwać użytkowników, role lub grupy — albo zmieniać członkostwo w grupie — usuwając tożsamości i powiązane ślady. Może to natychmiast przerwać dostęp dla osób i usług zależnych od tych tożsamości, powodując denial-of-service lub utratę dostępu, dlatego te akcje IAM muszą być ściśle ograniczone i monitorowane.
```bash
# Delete a user
aws iam delete-user \
--user-name <Username>

# Delete a group
aws iam delete-group \
--group-name <Username>

# Delete a role
aws iam delete-role \
--role-name <Role>
```
Z którąkolwiek z następujących uprawnień — `iam:DeleteGroupPolicy`, `iam:DeleteRolePolicy`, `iam:DeleteUserPolicy`, `iam:DeletePolicy`, `iam:DeletePolicyVersion`, `iam:DeleteRolePermissionsBoundary`, `iam:DeleteUserPermissionsBoundary`, `iam:DetachGroupPolicy`, `iam:DetachRolePolicy`, `iam:DetachUserPolicy` — podmiot może usuwać lub odłączać polityki zarządzane/inline, usuwać wersje polityk lub granice uprawnień oraz odłączać polityki od użytkowników, grup lub ról. To niszczy uprawnienia i może zmienić model uprawnień, powodując natychmiastową utratę dostępu lub odmowę usługi dla tożsamości, które polegały na tych politykach, dlatego te akcje IAM muszą być ściśle ograniczone i monitorowane.
```bash
# Delete a group policy
aws iam delete-group-policy \
--group-name <GroupName> \
--policy-name <PolicyName>

# Delete a role policy
aws iam delete-role-policy \
--role-name <RoleName> \
--policy-name <PolicyName>
```
### Usuwanie tożsamości federacyjnej
Posiadając uprawnienia `iam:DeleteOpenIDConnectProvider`, `iam:DeleteSAMLProvider` oraz `iam:RemoveClientIDFromOpenIDConnectProvider`, aktor może usunąć dostawców tożsamości OIDC/SAML lub usunąć client IDs. To łamie uwierzytelnianie federacyjne, uniemożliwiając weryfikację tokenów i natychmiast odcinając dostęp użytkownikom i usługom polegającym na SSO, dopóki IdP lub konfiguracje nie zostaną przywrócone.
```bash
# Delete OIDCP provider
aws iam delete-open-id-connect-provider \
--open-id-connect-provider-arn arn:aws:iam::111122223333:oidc-provider/accounts.google.com

# Delete SAML provider
aws iam delete-saml-provider \
--saml-provider-arn arn:aws:iam::111122223333:saml-provider/CorporateADFS
```
### Nieuprawniona aktywacja MFA
Z użyciem `iam:EnableMFADevice` atakujący może zarejestrować MFA device w tożsamości użytkownika, uniemożliwiając prawowitemu użytkownikowi zalogowanie się. Po włączeniu nieautoryzowanego MFA device użytkownik może zostać zablokowany aż do usunięcia lub zresetowania urządzenia (uwaga: jeśli zarejestrowanych jest wiele MFA devices, do logowania wymagana jest tylko jedna, więc ten atak nie spowoduje odmowy dostępu).
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
### Modyfikacja metadanych certyfikatów/kluczy
Dzięki `iam:UpdateSSHPublicKey`, `iam:UpdateCloudFrontPublicKey`, `iam:UpdateSigningCertificate`, `iam:UpdateServerCertificate` aktor może zmienić status lub metadane kluczy publicznych i certyfikatów. Poprzez oznaczenie kluczy/certyfikatów jako nieaktywnych lub zmianę referencji mogą przerwać uwierzytelnianie SSH, unieważnić walidacje X.509/TLS i natychmiast zakłócić działanie usług zależnych od tych poświadczeń, powodując utratę dostępu lub dostępności.
```bash
aws iam update-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE \
--status Inactive

aws iam update-server-certificate \
--server-certificate-name <Certificate_Name> \
--new-path /prod/
```
### `iam:Delete*`

Wildcard IAM iam:Delete* przyznaje możliwość usunięcia wielu rodzajów zasobów IAM — użytkowników, ról, grup, polityk, kluczy, certyfikatów, urządzeń MFA, wersji polityk itp. — i dlatego ma bardzo duży blast radius: podmiot z przydzielonym iam:Delete* może trwale zniszczyć tożsamości, poświadczenia, polityki i powiązane artefakty, usunąć audyt/dowody oraz spowodować przerwy w działaniu usług lub awarie operacyjne. Kilka przykładów to
```bash
# Delete a user
aws iam delete-user --user-name <Username>

# Delete a role
aws iam delete-role --role-name <RoleName>

# Delete a managed policy
aws iam delete-policy --policy-arn arn:aws:iam::<ACCOUNT_ID>:policy/<PolicyName>
```
### `iam:EnableMFADevice`

Podmiot, któremu przyznano uprawnienie iam:EnableMFADevice, może zarejestrować urządzenie MFA dla tożsamości w koncie, pod warunkiem że użytkownik nie miał już włączonego takiego urządzenia. Można to wykorzystać do zakłócenia dostępu użytkownika: gdy attacker zarejestruje urządzenie MFA, prawowity użytkownik może zostać zablokowany przed zalogowaniem się, ponieważ nie ma kontroli nad zarejestrowanym przez attackera urządzeniem MFA.

Ten atak polegający na odmowie dostępu działa tylko wtedy, gdy użytkownik nie miał zarejestrowanego urządzenia MFA; jeśli attacker zarejestruje urządzenie MFA dla tego użytkownika, prawowity użytkownik zostanie zablokowany we wszystkich procesach wymagających tego nowego MFA. Jeśli użytkownik już ma jedno lub więcej urządzeń MFA pod swoją kontrolą, dodanie urządzenia MFA kontrolowanego przez attackera nie zablokuje prawowitego użytkownika — może on nadal uwierzytelniać się przy użyciu dowolnego posiadanego wcześniej MFA.

Aby włączyć (zarejestrować) urządzenie MFA dla użytkownika, attacker mógłby uruchomić:
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
## Źródła

- [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{{#include ../../../../banners/hacktricks-training.md}}
