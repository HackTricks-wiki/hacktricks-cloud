# AWS - IAM Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## IAM

IAM एक्सेस के बारे में अधिक जानकारी के लिए:

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

## Confused Deputy समस्या

यदि आप **किसी बाहरी अकाउंट (A)** को अपने खाते में किसी **role** तक पहुँच देने की अनुमति देते हैं, तो आम तौर पर आपके पास यह देखने की **0 visibility** होगी कि **ठीक कौन उस बाहरी अकाउंट तक पहुँच सकता है**। यह एक समस्या है, क्योंकि अगर कोई दूसरा बाहरी अकाउंट (B) बाहरी अकाउंट (A) तक पहुँच सकता है, तो संभव है कि **B भी आपके खाते तक पहुँच सके**।

इसलिए, जब आप किसी बाहरी अकाउंट को अपने खाते के किसी role तक पहुँच देने की अनुमति देते हैं, तो आप एक `ExternalId` निर्दिष्ट कर सकते हैं। यह एक "secret" स्ट्रिंग है जिसे बाहरी अकाउंट (A) को आपकी organization में role को assume करने के लिए **निर्दिष्ट करना आवश्यक** होता है। चूंकि **बाहरी अकाउंट B को यह स्ट्रिंग पता नहीं होगी**, भले ही उसके पास A पर पहुँच हो, वह **आपकी role तक पहुँच नहीं पाएगा**।

<figure><img src="../../../images/image (95).png" alt=""><figcaption></figcaption></figure>

हालाँकि, ध्यान दें कि यह `ExternalId` "secret" **कोई secret नहीं है**, कोई भी जो **IAM assume role policy को पढ़ सकता है वह इसे देख पाएगा**। लेकिन जब तक बाहरी अकाउंट A को यह पता है, और बाहरी अकाउंट **B को यह पता नहीं है**, यह **B को A का दुरुपयोग कर आपके role तक पहुँचने से रोकता है**।

उदाहरण:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
> [!WARNING]
> किसी attacker के लिए confused deputy को exploit करने हेतु उसे किसी तरह यह पता लगाना होगा कि क्या principals of the current account other accounts में roles को impersonate कर सकते हैं।

### अनपेक्षित ट्रस्ट्स

#### Wildcard को principal के रूप में
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" }
}
```
यह नीति **allows all AWS** को role assume करने की अनुमति देती है।

#### Service as principal
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
यह नीति **किसी भी अकाउंट को अनुमति देती है** कि वे अपने apigateway को इस Lambda को कॉल करने के लिए कॉन्फ़िगर कर सकें।

#### S3 को प्रिंसिपल के रूप में
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
यदि किसी principal के रूप में एक S3 bucket दिया गया है, क्योंकि S3 buckets का कोई खाता ID नहीं होता है, अगर आपने **अपना bucket हटा दिया और हमलावर ने** इसे अपने खाते में बना लिया, तो वे इसका दुरुपयोग कर सकते हैं।

#### समर्थित नहीं
```json
{
"Effect": "Allow",
"Principal": { "Service": "cloudtrail.amazonaws.com" },
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
Confused Deputy समस्याओं से बचने का एक सामान्य तरीका origin ARN की जाँच करने के लिए `AWS:SourceArn` के साथ एक शर्त (condition) का उपयोग करना है। हालाँकि, **कुछ सेवाएँ यह समर्थन नहीं कर सकतीं** (कुछ स्रोतों के अनुसार, जैसे CloudTrail)।

### क्रेडेंशियल हटाना
निम्नलिखित किसी भी अनुमतियों — `iam:DeleteAccessKey`, `iam:DeleteLoginProfile`, `iam:DeleteSSHPublicKey`, `iam:DeleteServiceSpecificCredential`, `iam:DeleteInstanceProfile`, `iam:DeleteServerCertificate`, `iam:DeleteCloudFrontPublicKey`, `iam:RemoveRoleFromInstanceProfile` — के साथ कोई actor access keys, login profiles, SSH keys, service-specific credentials, instance profiles, certificates या CloudFront public keys हटा सकता है, या instance profiles से roles को disassociate कर सकता है। ऐसी क्रियाएँ वैध उपयोगकर्ताओं और एप्लिकेशनों को तुरंत ब्लॉक कर सकती हैं और उन सिस्टमों के लिए denial-of-service या पहुँच में कमी का कारण बन सकती हैं जो उन क्रेडेंशियल्स पर निर्भर करते हैं, इसलिए इन IAM अनुमतियों को सख्ती से सीमित और मॉनिटर किया जाना चाहिए।
```bash
# Remove Access Key of a user
aws iam delete-access-key \
--user-name <Username> \
--access-key-id AKIAIOSFODNN7EXAMPLE

## Remove ssh key of a user
aws iam delete-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE
```
### पहचान हटाना
`iam:DeleteUser`, `iam:DeleteGroup`, `iam:DeleteRole`, या `iam:RemoveUserFromGroup` जैसी अनुमतियाँ होने पर, कोई कर्ता उपयोगकर्ताओं, भूमिकाओं, या समूहों को हटा सकता है—या समूह सदस्यता बदल सकता है—जिससे पहचानें और उनसे जुड़े ट्रेस मिट सकते हैं। इससे उन लोगों और सेवाओं की पहुँच तुरंत टूट सकती है जो उन पहचानों पर निर्भर हैं, जिससे denial-of-service या पहुँच खोने की स्थिति पैदा हो सकती है, इसलिए इन IAM क्रियाओं को कड़ाई से सीमित और निगरानी में रखा जाना चाहिए।
```bash
# Delete a user
aws iam delete-user \
--user-name <Username>

# Delete a group
aws iam delete-group \
--group-name <Username>

# Delete a role
aws iam delete-role \
--role-name <Role>
```
निम्नलिखित अनुमतियों में से किसी के साथ — `iam:DeleteGroupPolicy`, `iam:DeleteRolePolicy`, `iam:DeleteUserPolicy`, `iam:DeletePolicy`, `iam:DeletePolicyVersion`, `iam:DeleteRolePermissionsBoundary`, `iam:DeleteUserPermissionsBoundary`, `iam:DetachGroupPolicy`, `iam:DetachRolePolicy`, `iam:DetachUserPolicy` — कोई actor managed/inline नीतियों को delete या detach कर सकता है, policy versions या permissions boundaries को हटा सकता है, और users, groups, या roles से नीतियों को unlink कर सकता है। यह authorizations को नष्ट कर देता है और permissions मॉडल को बदल सकता है, जिसके परिणामस्वरूप उन principals के लिए तुरंत पहुँच खोना या denial-of-service हो सकता है जो इन नीतियों पर निर्भर थे, इसलिए इन IAM क्रियाओं को कड़ाई से सीमित और मॉनिटर किया जाना चाहिए।
```bash
# Delete a group policy
aws iam delete-group-policy \
--group-name <GroupName> \
--policy-name <PolicyName>

# Delete a role policy
aws iam delete-role-policy \
--role-name <RoleName> \
--policy-name <PolicyName>
```
### फ़ेडरेटेड पहचान हटाना
With `iam:DeleteOpenIDConnectProvider`, `iam:DeleteSAMLProvider`, and `iam:RemoveClientIDFromOpenIDConnectProvider`, कोई व्यक्ति OIDC/SAML पहचान प्रदाताओं को हटा सकता है या client IDs निकाल सकता है। यह फेडरेटेड प्रमाणीकरण को तोड़ देता है, टोकन सत्यापन रोकता है और उन उपयोगकर्ताओं व सेवाओं की पहुँच तुरंत रोक देता है जो SSO पर निर्भर हैं, जब तक कि IdP या कॉन्फ़िगरेशन पुनर्स्थापित न किए जाएँ।
```bash
# Delete OIDCP provider
aws iam delete-open-id-connect-provider \
--open-id-connect-provider-arn arn:aws:iam::111122223333:oidc-provider/accounts.google.com

# Delete SAML provider
aws iam delete-saml-provider \
--saml-provider-arn arn:aws:iam::111122223333:saml-provider/CorporateADFS
```
### अवैध MFA सक्रियकरण
`iam:EnableMFADevice` के साथ, एक हमलावर किसी उपयोगकर्ता की पहचान पर एक MFA device रजिस्टर कर सकता है, जिससे वैध उपयोगकर्ता का साइन-इन रोका जा सकता है। एक बार अनधिकृत MFA सक्षम हो जाने पर उपयोगकर्ता तब तक लॉक आउट हो सकता है जब तक डिवाइस हटाया या रीसेट न किया जाए (नोट: यदि एकाधिक MFA devices पंजीकृत हैं, तो साइन-इन के लिए केवल एक की आवश्यकता होती है, इसलिए यह हमला एक्सेस को रोकने पर कोई प्रभाव नहीं डालेगा)।
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
### प्रमाणपत्र/कुंजी मेटाडेटा छेड़छाड़
`iam:UpdateSSHPublicKey`, `iam:UpdateCloudFrontPublicKey`, `iam:UpdateSigningCertificate`, `iam:UpdateServerCertificate` के साथ, एक हमलावर सार्वजनिक कुंजियों और प्रमाणपत्रों की स्थिति या मेटाडेटा बदल सकता है। कुंजियों/प्रमाणपत्रों को निष्क्रिय चिह्नित करके या संदर्भ बदलकर वे SSH प्रमाणीकरण को तोड़ सकते हैं, X.509/TLS सत्यापनों को अमान्य कर सकते हैं, और तुरंत उन सेवाओं को बाधित कर सकते हैं जो उन क्रेडेंशियल्स पर निर्भर हैं, जिससे पहुँच या उपलब्धता खो सकती है।
```bash
aws iam update-ssh-public-key \
--user-name <Username> \
--ssh-public-key-id APKAEIBAERJR2EXAMPLE \
--status Inactive

aws iam update-server-certificate \
--server-certificate-name <Certificate_Name> \
--new-path /prod/
```
### `iam:Delete*`

IAM wildcard iam:Delete* कई प्रकार के IAM resources—users, roles, groups, policies, keys, certificates, MFA devices, policy versions, आदि—हटाने की क्षमता देता है — और इसलिए इसका प्रभाव क्षेत्र बहुत बड़ा है: जिसे iam:Delete* दिया गया है वह पहचानों, क्रेडेंशियल्स, नीतियों और संबंधित आर्टिफैक्ट्स को स्थायी रूप से नष्ट कर सकता है, ऑडिट/सबूत हटा सकता है, और सेवा या संचालन में व्यवधान पैदा कर सकता है। कुछ उदाहरण हैं
```bash
# Delete a user
aws iam delete-user --user-name <Username>

# Delete a role
aws iam delete-role --role-name <RoleName>

# Delete a managed policy
aws iam delete-policy --policy-arn arn:aws:iam::<ACCOUNT_ID>:policy/<PolicyName>
```
### `iam:EnableMFADevice`

जिस actor को iam:EnableMFADevice action दिया गया है, वह अकाउंट में किसी identity पर एक MFA device register कर सकता है, बशर्ते कि उस user के पास पहले से कोई MFA enabled न हो। इसे user के access में बाधा डालने के लिए इस्तेमाल किया जा सकता है: एक बार attacker ने MFA device register कर दिया, तो वैध user को sign in करने से रोका जा सकता है क्योंकि वे attacker द्वारा register किए गए MFA को नियंत्रित नहीं करते।

यह denial-of-access attack केवल तब काम करता है जब user के पास कोई MFA registered न हो; अगर attacker उस user के लिए MFA device register कर देता है, तो वैध user उन किसी भी flows से लॉक आउट हो जाएगा जिन्हें उस नए MFA की आवश्यकता होती है। अगर user के पास पहले से एक या अधिक MFA devices उनके नियंत्रण में हों, तो attacker-नियंत्रित MFA जोड़ने से वैध user का मार्ग अवरुद्ध नहीं होता — वे किसी भी मौजूदा MFA का उपयोग करके authenticate करना जारी रख सकते हैं।

To enable (register) an MFA device for a user an attacker could run:
```bash
aws iam enable-mfa-device \
--user-name <Username> \
--serial-number arn:aws:iam::111122223333:mfa/alice \
--authentication-code1 123456 \
--authentication-code2 789012
```
## संदर्भ

- [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

{{#include ../../../../banners/hacktricks-training.md}}
