# AWS - CodeBuild Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## CodeBuild

Para más información, consulta:

{{#ref}}
../../aws-services/aws-codebuild-enum.md
{{#endref}}

### Revisar Secrets

Si se han establecido credenciales en CodeBuild para conectar con Github, Gitlab o Bitbucket en forma de personal tokens, passwords o OAuth token access, estas **credenciales van a almacenarse como secrets en el secret manager**.\
Por lo tanto, si tienes acceso para leer el secret manager podrás obtener esos secrets y pivotar a la plataforma conectada.

{{#ref}}
../../aws-privilege-escalation/aws-secrets-manager-privesc/README.md
{{#endref}}

### Abusar del acceso al repo de CodeBuild

Para configurar **CodeBuild**, necesitará **acceso al repo de código** que va a usar. Varias plataformas podrían alojar ese código:

<figure><img src="../../../../images/image (96).png" alt=""><figcaption></figcaption></figure>

El **proyecto de CodeBuild debe tener acceso** al proveedor de origen configurado, ya sea mediante **IAM role** o con un github/bitbucket **token u OAuth access**.

Un atacante con **permisos elevados sobre un CodeBuild** podría abusar de este acceso configurado para leak el código del repo configurado y de otros a los que las creds configuradas tengan acceso.\
Para hacerlo, el atacante solo necesitaría **cambiar la URL del repositorio por cada repo al que las credenciales de la configuración tengan acceso** (nota: la web de aws listará todos ellos por ti):

<figure><img src="../../../../images/image (107).png" alt=""><figcaption></figcaption></figure>

Y **cambiar los comandos del Buildspec para exfiltrar cada repo**.

> [!WARNING]
> Sin embargo, esta **tarea es repetitiva y tediosa** y si un github token fue configurado con **write permissions**, un atacante **no podrá (ab)usar esos permisos** porque no tiene acceso al token.\
> ¿O sí? Revisa la siguiente sección

### Leaking Access Tokens from AWS CodeBuild

You can leak access given in CodeBuild to platforms like Github. Check if any access to external platforms was given with:
```bash
aws codebuild list-source-credentials
```
{{#ref}}
aws-codebuild-token-leakage.md
{{#endref}}

### Ejecución de PR no confiable por mala configuración de filtros de webhook

Si los filtros de webhook son débiles, atacantes externos pueden conseguir que sus PRs se construyan en proyectos CodeBuild privilegiados y luego ejecutar código arbitrario en CI.

{{#ref}}
aws-codebuild-untrusted-pr-webhook-bypass.md
{{#endref}}

### `codebuild:DeleteProject`

Un atacante podría eliminar por completo un proyecto CodeBuild, provocando la pérdida de la configuración del proyecto y afectando a las aplicaciones que dependen de él.
```bash
aws codebuild delete-project --name <value>
```
**Impacto potencial**: Pérdida de la configuración del proyecto e interrupción del servicio para las aplicaciones que usan el proyecto eliminado.

### `codebuild:TagResource` , `codebuild:UntagResource`

Un atacante podría añadir, modificar o eliminar etiquetas de recursos de CodeBuild, interrumpiendo la asignación de costos de su organización, el seguimiento de recursos y las políticas de control de acceso basadas en etiquetas.
```bash
aws codebuild tag-resource --resource-arn <value> --tags <value>
aws codebuild untag-resource --resource-arn <value> --tag-keys <value>
```
**Impacto potencial**: Interrupción de la asignación de costos, el seguimiento de recursos y las políticas de control de acceso basadas en etiquetas.

### `codebuild:DeleteSourceCredentials`

Un atacante podría eliminar las credenciales de origen de un repositorio Git, afectando el funcionamiento normal de las aplicaciones que dependen del repositorio.
```sql
aws codebuild delete-source-credentials --arn <value>
```
**Impacto potencial**: Interrupción del funcionamiento normal de las aplicaciones que dependen del repositorio afectado debido a la eliminación de las credenciales de origen.

{{#include ../../../../banners/hacktricks-training.md}}
