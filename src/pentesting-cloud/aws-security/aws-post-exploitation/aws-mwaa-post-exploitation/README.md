# Ranjivost: AWS MWAA Execution Role Account Wildcard

{{#include ../../../../banners/hacktricks-training.md}}

## Ranjivost

Execution role MWAA-a (IAM role koji Airflow workers koriste za pristup AWS resources) zahteva ovu obaveznu policy da bi funkcionisao:
```json
{
"Effect": "Allow",
"Action": [
"sqs:ChangeMessageVisibility",
"sqs:DeleteMessage",
"sqs:GetQueueAttributes",
"sqs:GetQueueUrl",
"sqs:ReceiveMessage",
"sqs:SendMessage"
],
"Resource": "arn:aws:sqs:us-east-1:*:airflow-celery-*"
}
```
The wildcard (`*`) in the account ID position allows the role to interact with **any SQS queue in any AWS account** that starts with `airflow-celery-`. This is required because AWS provisions MWAA's internal queues in a separate AWS-managed account. There is no restriction on making queues with the `airflow-celery-` prefix.

**Ne može se popraviti:** Uklanjanje wildcard-a pre-deploy-a potpuno lomi MWAA — scheduler ne može staviti zadatke na queue za workere.

Dokumentacija koja verifikuje ranjivost i priznaje vektor: [AWS Documentation](https://docs.aws.amazon.com/mwaa/latest/userguide/mwaa-create-role.html)

## Eksploatacija

Svi Airflow DAG-ovi se izvršavaju sa permisijama execution role. DAG-ovi su Python skripte koje mogu izvršavati proizvoljan kod — mogu koristiti `yum` ili `curl` da instaliraju alate, preuzmu zlonamerne skripte, ili importuju bilo koju Python biblioteku. DAG-ovi se vuku iz dodeljenog S3 foldera i automatski se pokreću po rasporedu; sve što je napadaču potrebno je mogućnost da izvrši PUT na taj bucket path.

Bilo ko ko može da piše DAG-ove (obično većina korisnika u MWAA okruženjima) može zloupotrebiti ovu dozvolu:

1. **Data Exfiltration**: Kreirati queue nazvan `airflow-celery-exfil` u eksternom nalogu, napisati DAG koji šalje osetljive podatke ka njemu putem `boto3`

2. **Command & Control**: Povlačiti komande iz eksternog queue-a, izvršavati ih, vraćati rezultate — kreirajući persistent backdoor kroz SQS APIs

3. **Cross-Account Attacks**: Injektovati zlonamerne poruke u queue-e drugih organizacija ako slede obrazac imenovanja

Svi napadi zaobilaze mrežne kontrole jer koriste AWS API-je, a ne direktne internet konekcije.

## Uticaj

Ovo je arhitektonski nedostatak u MWAA bez IAM-based mitigacije. Svaka MWAA deployment koja sledi AWS dokumentaciju ima ovu ranjivost.

**Network Control Bypass:** Ovi napadi funkcionišu čak i u privatnim VPC-ima bez pristupa internetu. SQS API pozivi koriste AWS-ovu internu mrežu i VPC endpoints, potpuno zaobilazeći tradicionalne mrežne sigurnosne kontrole, firewalle i egress monitoring. Organizacije ne mogu detektovati ili blokirati ovaj put za data exfiltration kroz network-level controls.
{{#include ../../../../banners/hacktricks-training.md}}
