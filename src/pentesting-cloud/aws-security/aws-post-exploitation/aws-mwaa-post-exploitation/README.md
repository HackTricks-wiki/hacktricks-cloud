# AWS MWAA Execution Role Account Wildcard Vulnerability

{{#include ../../../../banners/hacktricks-training.md}}

## Zafiyet

MWAA'nın execution role'ü (Airflow workers'ın AWS kaynaklarına erişmek için kullandığı IAM role) çalışması için bu zorunlu politikaya ihtiyaç duyar:
```json
{
"Effect": "Allow",
"Action": [
"sqs:ChangeMessageVisibility",
"sqs:DeleteMessage",
"sqs:GetQueueAttributes",
"sqs:GetQueueUrl",
"sqs:ReceiveMessage",
"sqs:SendMessage"
],
"Resource": "arn:aws:sqs:us-east-1:*:airflow-celery-*"
}
```
The wildcard (`*`) in the account ID position allows the role to interact with **any SQS queue in any AWS account** that starts with `airflow-celery-`. This is required because AWS provisions MWAA's internal queues in a separate AWS-managed account. There is no restriction on making queues with the `airflow-celery-` prefix.

**Cannot be fixed:** Removing the wildcard pre-deployment breaks MWAA completely - the scheduler can't queue tasks for workers.

Zafiyeti Doğrulayan ve Vektörü Kabul Eden Dokümantasyon: [AWS Documentation](https://docs.aws.amazon.com/mwaa/latest/userguide/mwaa-create-role.html)

## Sömürü

Tüm Airflow DAG'ları yürütme rolünün izinleriyle çalışır. DAG'lar arbitrary code çalıştırabilen Python scriptleridir - `yum` veya `curl` kullanarak araç yükleyebilir, kötü amaçlı scriptler indirebilir veya herhangi bir Python kütüphanesini import edebilirler. DAG'lar atanan bir S3 klasöründen çekilir ve zamanlanmış olarak otomatik çalıştırılır; bir saldırıcının ihtiyacı olan tek şey o bucket yoluna PUT yapabilme yetkisidir.

DAG yazabilen herkes (genellikle MWAA ortamlarındaki çoğu kullanıcı) bu izni kötüye kullanabilir:

1. **Veri Sızdırma**: Harici bir hesapta `airflow-celery-exfil` adlı bir kuyruk oluşturun, hassas verileri `boto3` ile ona gönderen bir DAG yazın

2. **Komut & Kontrol**: Harici bir kuyruktan komutları sorgulayın, bunları çalıştırın, sonuçları geri gönderin - SQS API'leri üzerinden kalıcı bir arka kapı oluşturur

3. **Hesaplar Arası Saldırılar**: İsimlendirme desenini takip ediyorlarsa diğer organizasyonların kuyruklarına kötü amaçlı mesajlar enjekte edin

Tüm saldırılar ağ kontrollerini atlar çünkü doğrudan internet bağlantıları değil, AWS API'leri kullanılır.

## Etki

Bu, IAM tabanlı bir çözümü olmayan MWAA mimarisinde bir hata. AWS dokümantasyonunu takip eden her MWAA dağıtımı bu zafiyete sahiptir.

**Ağ Kontrolü Atlama:** Bu saldırılar internet erişimi olmayan özel VPC'lerde bile çalışır. SQS API çağrıları AWS'in dahili ağı ve VPC endpoint'lerini kullanır; geleneksel ağ güvenlik kontrollerini, firewall'ları ve egress izlemeyi tamamen atlar. Organizasyonlar ağ düzeyindeki kontrollerle bu veri sızdırma yolunu tespit edemez veya engelleyemez.
{{#include ../../../../banners/hacktricks-training.md}}
