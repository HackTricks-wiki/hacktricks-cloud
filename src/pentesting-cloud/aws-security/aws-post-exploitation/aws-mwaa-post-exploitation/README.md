# AWS MWAA Uitvoeringsrol-rekening Wildcard Kwetsbaarheid

{{#include ../../../../banners/hacktricks-training.md}}

## Die Kwetsbaarheid

MWAA se uitvoeringsrol (die IAM-rol wat Airflow-werkers gebruik om toegang tot AWS-bronne te kry) vereis hierdie verpligte beleid om te funksioneer:
```json
{
"Effect": "Allow",
"Action": [
"sqs:ChangeMessageVisibility",
"sqs:DeleteMessage",
"sqs:GetQueueAttributes",
"sqs:GetQueueUrl",
"sqs:ReceiveMessage",
"sqs:SendMessage"
],
"Resource": "arn:aws:sqs:us-east-1:*:airflow-celery-*"
}
```
Die wildcard (`*`) in die account ID-posisie laat die rol toe om met **any SQS queue in any AWS account** te kommunikeer wat begin met `airflow-celery-`. Dit is nodig omdat AWS MWAA se interne queues in 'n aparte AWS-managed account voorsien. Daar is geen beperking op die skep van queues met die `airflow-celery-` voorvoegsel nie.

**Cannot be fixed:** Verwydering van die wildcard voor deployment breek MWAA heeltemal - die scheduler kan nie take in die ry plaas vir workers nie.

Dokumentasie wat die kwesbaarheid verifieer en die vektor erken: [AWS Documentation](https://docs.aws.amazon.com/mwaa/latest/userguide/mwaa-create-role.html)

## Uitbuiting

Alle Airflow DAGs word met die uitvoeringsrol se toestemmings uitgevoer. DAGs is Python-skripte wat arbitrêre kode kan uitvoer - hulle kan `yum` of `curl` gebruik om tools te installeer, kwaadwillige skripte af te laai, of enige Python-biblioteek te importeer. DAGs word uit 'n aangewese S3-lêergids getrek en outomaties volgens skedule uitgevoer; al wat 'n aanvaller nodig het, is die vermoë om te PUT na daardie bucket-pad.

Enigiemand wat DAGs kan skryf (typies die meeste gebruikers in MWAA-omgewings) kan hierdie toestemming misbruik:

1. **Data Exfiltration**: Skep 'n queue met die naam `airflow-celery-exfil` in 'n eksterne account, skryf 'n DAG wat sensitiewe data daarheen stuur via `boto3`

2. **Command & Control**: Poll opdragte vanaf 'n eksterne queue, voer dit uit, stuur resultate terug - en skep 'n permanente backdoor deur SQS APIs

3. **Cross-Account Attacks**: Injiseer kwaadwillige boodskappe in ander organisasies se queues as hulle die naamgewingpatroon volg

Al die aanvalle omseil netwerkbeheer omdat hulle AWS APIs gebruik, nie direkte internetverbindinge nie.

## Impak

Dit is 'n argitektoniese fout in MWAA sonder IAM-gebaseerde mitigasie. Elke MWAA-deployment wat AWS-dokumentasie volg het hierdie kwesbaarheid.

**Netwerkbeheer-omseiling:** Hierdie aanvalle werk selfs in private VPCs sonder internettoegang. Die SQS API-aanroepe gebruik AWS se interne netwerk en VPC-endpoints, en omseil volledig tradisionele netwerksekuriteitskontroles, firewalls en egress-monitering. Organisasies kan nie hierdie data exfiltration-pad op netwerkvlak opspoor of blokkeer nie.
{{#include ../../../../banners/hacktricks-training.md}}
