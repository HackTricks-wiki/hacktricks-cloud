# AWS - S3 Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## S3

Daha fazla bilgi için bakınız:

{{#ref}}
../../aws-services/aws-s3-athena-and-glacier-enum.md
{{#endref}}

### Hassas Bilgiler

Bazen bucket'larda okunabilir halde hassas bilgiler bulabilirsiniz. Örneğin, terraform state'teki secrets.

### Pivoting

Farklı platformlar hassas varlıkları depolamak için S3'ü kullanıyor olabilir.\
Örneğin, **airflow** orada **DAGs** **code** depoluyor olabilir veya **web pages** doğrudan S3'ten servis ediliyor olabilir. Yazma izinlerine sahip bir saldırgan bucket içindeki **code**'u değiştirerek diğer platformlara **pivot** yapabilir veya JS dosyalarını değiştirerek hesapları **takeover** edebilir.

### S3 Ransomware

Bu senaryoda, saldırgan kendi AWS hesabında veya ele geçirilmiş başka bir hesapta bir KMS (Key Management Service) key oluşturur. Ardından bu key'i dünyadaki herhangi birinin kullanımına açık hale getirir; böylece herhangi bir AWS user, role veya account bu key ile objeleri şifreleyebilir. Ancak bu objeler decrypt edilemez.

Saldırgan hedef S3 bucket'ı belirler ve çeşitli yöntemlerle ona yazma düzeyinde erişim elde eder. Bu, bucket'ın yanlış konfigürasyonu nedeniyle kamuya açık olması ya da saldırganın AWS ortamına erişim kazanması sonucu olabilir. Saldırgan tipik olarak kişisel olarak tanımlanabilir bilgiler (PII), korumalı sağlık bilgileri (PHI), loglar, yedekler ve benzeri hassas bilgileri içeren bucket'ları hedef alır.

Bucket'ın ransomware hedefi olup olmadığını belirlemek için saldırgan konfigürasyonu kontrol eder. Bu, S3 Object Versioning'in etkin olup olmadığını ve multi-factor authentication delete (MFA delete)'in etkin olup olmadığını doğrulamayı içerir. Eğer Object Versioning etkin değilse saldırgan ilerleyebilir. Object Versioning etkin ancak MFA delete devre dışıysa saldırgan Object Versioning'i devre dışı bırakabilir. Hem Object Versioning hem de MFA delete etkinse, o belirli bucket'ı ransomware yapmak saldırgan için daha zorlaşır.

AWS API'lerini kullanarak saldırgan bucket'taki her objeyi kendi KMS key'ini kullanarak şifrelenmiş bir kopya ile değiştirir. Bu, bucket'taki veriyi erişilemez hale getirir.

Daha fazla baskı uygulamak için saldırgan saldırıda kullandığı KMS key'in silinmesini zamanlayabilir. Bu, hedefe anahtar silinmeden ve veriler kalıcı olarak kaybolmadan önce kurtarma için 7 günlük bir pencere verir.

Son olarak saldırgan genellikle "ransom-note.txt" adında bir son dosya yükleyebilir; bu dosya hedefe dosyalarını nasıl geri alacağına dair talimatlar içerir. Bu dosya şifrelenmeden yüklenir; muhtemelen hedefin dikkatini çekmek ve ransomwarenın farkına varmasını sağlamak için.

### `s3:RestoreObject`

s3:RestoreObject permission'a sahip bir saldırgan Glacier veya Deep Archive'da arşivlenmiş objeleri yeniden etkinleştirebilir ve bunları geçici olarak erişilebilir hale getirebilir. Bu, normalde erişilemez olan geçmişe yönelik arşivlenmiş verilerin (yedekler, snapshot'lar, loglar, sertifikalar, eski secret'lar) kurtarılması ve exfiltration'ı için imkan sağlar. Eğer saldırgan bu izinleri okuma izinleriyle (ör. s3:GetObject) birleştirirse, hassas verilerin tam kopyalarını elde edebilir.
```bash
aws s3api restore-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--restore-request '{
"Days": <NUMBER_OF_DAYS>,
"GlacierJobParameters": { "Tier": "Standard" }
}'
```
### `s3:Delete*`

s3:Delete* iznine sahip bir saldırgan nesneleri, sürümleri ve tüm bucket'ları silebilir, yedekleri bozabilir ve anında ve geri döndürülemez veri kaybına, delillerin yok edilmesine ve yedek veya kurtarma varlıklarının tehlikeye atılmasına neden olabilir.
```bash
# Delete an object from a bucket
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY>

# Delete a specific version
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--version-id <VERSION_ID>

# Delete a bucket
aws s3api delete-bucket \
--bucket <BUCKET_NAME>
```
**Daha fazla bilgi için** [**check the original research**](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/)**.**

{{#include ../../../../banners/hacktricks-training.md}}
