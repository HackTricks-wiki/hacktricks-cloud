# AWS - S3 Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## S3

For more information check:

{{#ref}}
../../aws-services/aws-s3-athena-and-glacier-enum.md
{{#endref}}

### Sensitive Information

때때로 버킷에서 읽을 수 있는 형태로 민감한 정보를 발견할 수 있습니다. 예를 들어, terraform state secrets.

### Pivoting

Different platforms could be using S3 to store sensitive assets.\
예를 들어, **airflow**는 **DAGs** **code**를 그곳에 저장할 수 있고, 또는 **web pages**가 S3에서 직접 제공될 수 있습니다. 쓰기 권한을 가진 공격자는 버킷의 **modify the code**를 통해 다른 플랫폼으로 **pivot**하거나, JS 파일을 수정하여 **takeover accounts**할 수 있습니다.

### S3 Ransomware

이 시나리오에서, **attacker creates a KMS (Key Management Service) key in their own AWS account** 또는 다른 탈취된 계정에서 키를 생성합니다. 그런 다음 이 **key를 전 세계 누구나 사용할 수 있게** 설정하여, 어떤 AWS 사용자, 역할 또는 계정이든 이 키로 객체를 암호화할 수 있게 만듭니다. 그러나 해당 객체들은 복호화될 수 없습니다.

공격자는 대상 **S3 bucket을 식별하고 write-level access를 획득**합니다. 이는 버킷 설정 미비로 공개되어 있거나 공격자가 AWS 환경 자체에 접근했기 때문일 수 있습니다. 공격자는 일반적으로 개인 식별 정보(PII), 보호된 건강 정보(PHI), 로그, 백업 등 민감한 정보를 포함한 버킷을 표적으로 삼습니다.

버킷이 랜섬웨어 대상으로 적합한지 판단하기 위해 공격자는 구성 설정을 확인합니다. 여기에는 **S3 Object Versioning**이 활성화되어 있는지, **multi-factor authentication delete (MFA delete)**가 활성화되어 있는지를 확인하는 것이 포함됩니다. Object Versioning이 활성화되어 있지 않다면 공격자는 계속 진행할 수 있습니다. Object Versioning이 활성화되어 있지만 MFA delete가 비활성화된 경우 공격자는 **Object Versioning을 비활성화**할 수 있습니다. Object Versioning과 MFA delete가 모두 활성화되어 있다면 해당 버킷에 대해 랜섬웨어 공격을 수행하기가 더 어려워집니다.

공격자는 AWS API를 사용하여 **버킷 내 각 객체를 자신의 KMS key로 암호화된 복사본으로 대체**합니다. 이로 인해 버킷의 데이터가 사실상 암호화되어 키 없이는 접근할 수 없게 됩니다.

추가 압박을 위해 공격자는 공격에 사용된 KMS 키의 삭제를 예약할 수 있습니다. 이렇게 하면 대상은 키가 삭제되어 데이터가 영구적으로 손실되기 전 7일의 복구 기간을 갖게 됩니다.

마지막으로 공격자는 보통 "ransom-note.txt"라는 이름의 최종 파일을 업로드하여 대상에게 파일 복구 방법을 안내하는 지침을 남길 수 있습니다. 이 파일은 주의를 끌고 랜섬웨어 공격을 알리기 위해 암호화되지 않은 상태로 업로드됩니다.

### `s3:RestoreObject`

An attacker with the s3:RestoreObject permission can reactivate objects archived in Glacier or Deep Archive, making them temporarily accessible. This enables recovery and exfiltration of historically archived data (백업, 스냅샷, 로그, 인증서, 오래된 비밀 등) that would normally be out of reach. If the attacker combines this permission with read permissions (e.g., s3:GetObject), they can obtain full copies of sensitive data.
```bash
aws s3api restore-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--restore-request '{
"Days": <NUMBER_OF_DAYS>,
"GlacierJobParameters": { "Tier": "Standard" }
}'
```
### `s3:Delete*`

s3:Delete* 권한을 가진 공격자는 객체, 버전 및 전체 버킷을 삭제할 수 있어 백업을 무력화하고 즉각적이며 되돌릴 수 없는 데이터 손실, 증거 파괴 및 백업 또는 복구 아티팩트의 손상을 초래할 수 있습니다.
```bash
# Delete an object from a bucket
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY>

# Delete a specific version
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--version-id <VERSION_ID>

# Delete a bucket
aws s3api delete-bucket \
--bucket <BUCKET_NAME>
```
**자세한 내용은** [**원문 연구를 확인하세요**](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/)**.**

{{#include ../../../../banners/hacktricks-training.md}}
