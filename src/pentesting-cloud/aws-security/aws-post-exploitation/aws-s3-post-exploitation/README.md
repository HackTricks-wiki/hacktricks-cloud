# AWS - S3 Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## S3

Daha fazla bilgi için bakınız:

{{#ref}}
../../aws-services/aws-s3-athena-and-glacier-enum.md
{{#endref}}

### Sensitive Information

Bazen bucket'larda okunabilir halde hassas bilgiler bulabilirsiniz. Örneğin, terraform state içindeki sırlar.

### Pivoting

Farklı platformlar hassas varlıkları saklamak için S3 kullanıyor olabilir.\
Örneğin, **airflow** orada **DAGs** **code** saklıyor olabilir, veya **web sayfaları** doğrudan S3'ten sunuluyor olabilir. Yazma izinlerine sahip bir saldırgan, bucket'taki **modify the code** ile diğer platformlara **pivot** yapabilir veya JS dosyalarını değiştirerek **takeover accounts** gerçekleştirebilir.

### S3 Ransomware

Bu senaryoda, saldırgan kendi AWS hesabında veya başka bir ele geçirilmiş hesapta bir **KMS (Key Management Service) key** oluşturur. Ardından bu **key'i dünyadaki herkesin erişebileceği** şekilde yapılandırır; böylece herhangi bir AWS kullanıcı, role veya hesap bu anahtarı kullanarak objeleri şifreleyebilir. Ancak objeler geri çözülemez.

Saldırgan hedef **S3 bucket'ı belirler ve ona yazma düzeyinde erişim elde eder**. Bu, bucket'ın kötü yapılandırılması nedeniyle kamuya açık olması veya saldırganın AWS ortamına erişim kazanması yoluyla olabilir. Saldırgan tipik olarak kişisel tanımlayıcı bilgiler (PII), korunmuş sağlık bilgileri (PHI), loglar, yedeklemeler gibi hassas bilgiler içeren bucket'ları hedef alır.

Bucket'ın ransomware hedefi olup olmadığını belirlemek için saldırgan yapılandırmasını kontrol eder. Bu, **S3 Object Versioning**'in etkin olup olmadığını ve **multi-factor authentication delete (MFA delete)**'in etkin olup olmadığını doğrulamayı içerir. Eğer Object Versioning etkin değilse, saldırgan ilerleyebilir. Eğer Object Versioning etkin ama MFA delete devre dışıysa, saldırgan **Object Versioning'i devre dışı bırakabilir**. Hem Object Versioning hem de MFA delete etkinse, belirli bucket'ı ransomware ile hedeflemek saldırgan için daha zorlaşır.

AWS API'lerini kullanarak saldırgan, **bucket'taki her objeyi kendi KMS key'iyle şifrelenmiş bir kopyayla değiştirir**. Bu, bucket'taki veriyi etkili şekilde şifreleyerek anahtar olmadan erişilemez hale getirir.

Daha fazla baskı uygulamak için saldırgan, saldırıda kullandığı KMS key'in silinmesini zamanlayabilir. Bu, hedefe verilerini geri kazanmak için anahtarın silinmesinden önce 7 günlük bir pencere verir.

Son olarak, saldırgan genellikle "ransom-note.txt" adında bir dosya yükleyebilir; bu dosya hedefe dosyalarını nasıl geri alacaklarına dair talimatlar içerir. Bu dosya şifrelenmeden yüklenir; muhtemelen hedefin dikkatini çekmek ve ransomware saldırısının farkına varmalarını sağlamak için.

### `s3:RestoreObject`

s3:RestoreObject iznine sahip bir saldırgan, Glacier veya Deep Archive'da arşivlenmiş objeleri yeniden aktifleştirebilir ve bunları geçici olarak erişilebilir hale getirebilir. Bu, normalde ulaşılamayan tarihsel arşivlenmiş verilerin (yedekler, snapshot'lar, loglar, sertifikalar, eski sırlar) kurtarılmasına ve exfiltrate edilmesine olanak sağlar. Saldırgan bu izinleri okuma izinleriyle (ör. s3:GetObject) birleştirirse, hassas verilerin tam kopyalarını elde edebilir.
```bash
aws s3api restore-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--restore-request '{
"Days": <NUMBER_OF_DAYS>,
"GlacierJobParameters": { "Tier": "Standard" }
}'
```
### `s3:Delete*`

Bir saldırgan s3:Delete* iznine sahip olduğunda objects, versions ve entire buckets'ı silebilir, backups'ı bozabilir ve anında ve geri döndürülemez veri kaybına, delillerin yok edilmesine ve backup veya recovery artifacts'in tehlikeye girmesine neden olabilir.
```bash
# Delete an object from a bucket
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY>

# Delete a specific version
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--version-id <VERSION_ID>

# Delete a bucket
aws s3api delete-bucket \
--bucket <BUCKET_NAME>
```
**Daha fazla bilgi için** [**check the original research**](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/)**.**

{{#include ../../../../banners/hacktricks-training.md}}
