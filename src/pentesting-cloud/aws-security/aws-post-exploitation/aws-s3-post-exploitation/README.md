# AWS - S3 Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## S3

For more information check:

{{#ref}}
../../aws-services/aws-s3-athena-and-glacier-enum.md
{{#endref}}

### Sensitive Information

Μερικές φορές θα μπορέσετε να βρείτε ευαίσθητες πληροφορίες αναγνώσιμες μέσα στα buckets. Για παράδειγμα, terraform state secrets.

### Pivoting

Διάφορες πλατφόρμες μπορεί να χρησιμοποιούν το S3 για αποθήκευση ευαίσθητων assets.\
Για παράδειγμα, **airflow** μπορεί να αποθηκεύει **DAGs** **code** εκεί, ή **web pages** να σερβίρονται απευθείας από το S3. Ένας attacker με write permissions θα μπορούσε να **modify the code** από το bucket για να **pivot** σε άλλες πλατφόρμες, ή να **takeover accounts** τροποποιώντας JS files.

### S3 Ransomware

Σε αυτό το σενάριο, ο **attacker δημιουργεί ένα KMS (Key Management Service) key στο δικό του AWS account** ή σε άλλο compromised account. Στη συνέχεια κάνει αυτό το **key accessible to anyone in the world**, επιτρέποντας σε οποιονδήποτε AWS user, role, ή account να κρυπτογραφήσει objects χρησιμοποιώντας αυτό το key. Ωστόσο, τα αντικείμενα δεν μπορούν να αποκρυπτογραφηθούν.

Ο attacker εντοπίζει έναν στοχευόμενο **S3 bucket και αποκτά write-level access** σε αυτό με διάφορες μεθόδους. Αυτό μπορεί να οφείλεται σε κακή ρύθμιση του bucket που το εκθέτει δημόσια ή στο ότι ο attacker απέκτησε πρόσβαση στο AWS environment καθαυτό. Ο attacker συνήθως στοχεύει buckets που περιέχουν ευαίσθητες πληροφορίες όπως PII, PHI, logs, backups κ.λπ.

Για να προσδιορίσει αν το bucket μπορεί να αποτελέσει στόχο για ransomware, ο attacker ελέγχει τη διαμόρφωσή του. Αυτό περιλαμβάνει την επαλήθευση αν είναι ενεργοποιημένο το **S3 Object Versioning** και αν είναι ενεργοποιημένο το **multi-factor authentication delete (MFA delete)**. Αν το Object Versioning δεν είναι ενεργοποιημένο, o attacker μπορεί να προχωρήσει. Αν το Object Versioning είναι ενεργοποιημένο αλλά το MFA delete είναι απενεργοποιημένο, ο attacker μπορεί να **disable Object Versioning**. Αν και το Object Versioning και το MFA delete είναι ενεργοποιημένα, γίνεται πιο δύσκολο για τον attacker να κάνει ransomware σε εκείνο το συγκεκριμένο bucket.

Χρησιμοποιώντας το AWS API, ο attacker **αντικαθιστά κάθε object στο bucket με ένα κρυπτογραφημένο αντίγραφο χρησιμοποιώντας το KMS key του**. Αυτό ουσιαστικά κρυπτογραφεί τα δεδομένα στο bucket, καθιστώντας τα μη προσβάσιμα χωρίς το key.

Για να ασκήσει περαιτέρω πίεση, ο attacker προγραμματίζει τη διαγραφή του KMS key που χρησιμοποιήθηκε στην επίθεση. Αυτό δίνει στον στόχο ένα παράθυρο 7 ημερών για να ανακτήσει τα δεδομένα του πριν το key διαγραφεί και τα δεδομένα χαθούν μόνιμα.

Τέλος, ο attacker μπορεί να ανεβάσει ένα τελικό αρχείο, συνήθως ονομαζόμενο "ransom-note.txt", το οποίο περιέχει οδηγίες για τον στόχο σχετικά με το πώς να ανακτήσει τα αρχεία του. Αυτό το αρχείο ανεβαίνει χωρίς κρυπτογράφηση, πιθανώς για να τραβήξει την προσοχή του θύματος και να το κάνει να αντιληφθεί την επίθεση ransomware.

### `s3:RestoreObject`

Ένας attacker με την άδεια s3:RestoreObject μπορεί να επανενεργοποιήσει objects που έχουν αρχειοθετηθεί σε Glacier ή Deep Archive, καθιστώντας τα προσωρινά προσβάσιμα. Αυτό επιτρέπει την ανάκτηση και exfiltration ιστορικών αρχειοθετημένων δεδομένων (backups, snapshots, logs, certifications, παλιά secrets) που κανονικά θα ήταν εκτός εμβέλειας. Αν ο attacker συνδυάσει αυτή την άδεια με read permissions (π.χ. s3:GetObject), μπορεί να αποκτήσει πλήρη αντίγραφα ευαίσθητων δεδομένων.
```bash
aws s3api restore-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--restore-request '{
"Days": <NUMBER_OF_DAYS>,
"GlacierJobParameters": { "Tier": "Standard" }
}'
```
### `s3:Delete*`

Ένας attacker με την άδεια s3:Delete* μπορεί να διαγράψει objects, versions και ολόκληρα buckets, να διαταράξει backups και να προκαλέσει άμεση και μη αναστρέψιμη απώλεια δεδομένων, καταστροφή αποδεικτικών στοιχείων και συμβιβασμό των backup ή recovery artifacts.
```bash
# Delete an object from a bucket
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY>

# Delete a specific version
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--version-id <VERSION_ID>

# Delete a bucket
aws s3api delete-bucket \
--bucket <BUCKET_NAME>
```
**Για περισσότερες πληροφορίες** [**check the original research**](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/)**.**

{{#include ../../../../banners/hacktricks-training.md}}
