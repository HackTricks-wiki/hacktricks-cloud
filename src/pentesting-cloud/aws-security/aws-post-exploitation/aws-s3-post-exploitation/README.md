# AWS - S3 Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## S3

For more information check:

{{#ref}}
../../aws-services/aws-s3-athena-and-glacier-enum.md
{{#endref}}

### Sensitive Information

Κάποιες φορές θα μπορείτε να βρείτε ευαίσθητες πληροφορίες προσβάσιμες μέσα στα buckets. Για παράδειγμα, terraform state secrets.

### Pivoting

Διάφορες πλατφόρμες μπορεί να χρησιμοποιούν το S3 για αποθήκευση ευαίσθητων assets.\
Για παράδειγμα, **airflow** μπορεί να αποθηκεύει **DAGs** **code** εκεί, ή **web pages** να σερβίρονται απευθείας από S3. Ένας attacker με write permissions θα μπορούσε να **modify the code** από το bucket για να **pivot** σε άλλες πλατφόρμες, ή να **takeover accounts** τροποποιώντας αρχεία JS.

### S3 Ransomware

Σε αυτό το σενάριο, ο **attacker δημιουργεί ένα KMS (Key Management Service) key in their own AWS account** ή σε άλλο compromised account. Στη συνέχεια κάνει αυτό το **key accessible to anyone in the world**, επιτρέποντας σε οποιονδήποτε AWS user, role, ή account να encrypt objects χρησιμοποιώντας αυτό το key. Ωστόσο, τα αντικείμενα δεν μπορούν να αποκρυπτογραφηθούν.

Ο attacker εντοπίζει έναν στοχευμένο **S3 bucket and gains write-level access** σε αυτόν χρησιμοποιώντας διάφορες μεθόδους. Αυτό μπορεί να οφείλεται σε κακή διαμόρφωση του bucket που το εκθέτει δημόσια ή στο ότι ο attacker αποκτά πρόσβαση στο AWS περιβάλλον καθ' αυτό. Ο attacker συνήθως στοχεύει buckets που περιέχουν ευαίσθητες πληροφορίες όπως personally identifiable information (PII), protected health information (PHI), logs, backups, και άλλα.

Για να καθορίσει αν το bucket μπορεί να στοχευθεί για ransomware, ο attacker ελέγχει τη διαμόρφωσή του. Αυτό περιλαμβάνει την επαλήθευση αν **S3 Object Versioning** είναι enabled και αν **multi-factor authentication delete (MFA delete)** είναι enabled. Αν Object Versioning δεν είναι enabled, ο attacker μπορεί να προχωρήσει. Αν Object Versioning είναι enabled αλλά MFA delete είναι disabled, ο attacker μπορεί να **disable Object Versioning**. Αν και τα δύο Object Versioning και MFA delete είναι enabled, γίνεται πιο δύσκολο για τον attacker να ransomware εκείνο το συγκεκριμένο bucket.

Χρησιμοποιώντας το AWS API, ο attacker **replaces each object in the bucket with an encrypted copy using their KMS key**. Αυτό ουσιαστικά encrypts τα δεδομένα στο bucket, καθιστώντας τα μη προσβάσιμα χωρίς το key.

Για να αυξήσει την πίεση, ο attacker προγραμματίζει τη διαγραφή του KMS key που χρησιμοποιήθηκε στην επίθεση. Αυτό δίνει στο θύμα ένα παράθυρο 7 ημερών για να ανακτήσει τα δεδομένα του πριν το key διαγραφεί και τα δεδομένα χαθούν οριστικά.

Τέλος, ο attacker μπορεί να ανεβάσει ένα τελικό αρχείο, συνήθως με όνομα "ransom-note.txt", που περιέχει οδηγίες για το θύμα σχετικά με το πώς να ανακτήσει τα αρχεία του. Αυτό το αρχείο ανεβαίνει χωρίς κρυπτογράφηση, πιθανώς για να τραβήξει την προσοχή του θύματος και να το ενημερώσει για την επίθεση ransomware.

### `s3:RestoreObject`

Ένας attacker με την άδεια `s3:RestoreObject` μπορεί να επανενεργοποιήσει αντικείμενα που έχουν αρχειοθετηθεί στο Glacier ή Deep Archive, καθιστώντας τα προσωρινά προσβάσιμα. Αυτό επιτρέπει την ανάκτηση και την exfiltration ιστορικά αρχειοθετημένων δεδομένων (backups, snapshots, logs, certifications, old secrets) που κανονικά θα ήταν εκτός προσέγγισης. Αν ο attacker συνδυάσει αυτή την άδεια με read permissions (π.χ., `s3:GetObject`), μπορεί να αποκτήσει πλήρη αντίγραφα ευαίσθητων δεδομένων.
```bash
aws s3api restore-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--restore-request '{
"Days": <NUMBER_OF_DAYS>,
"GlacierJobParameters": { "Tier": "Standard" }
}'
```
### `s3:Delete*`

Ένας attacker με την άδεια s3:Delete* μπορεί να διαγράψει objects, versions και ολόκληρα buckets, να διαταράξει backups, και να προκαλέσει άμεση και μη αναστρέψιμη απώλεια δεδομένων, καταστροφή αποδεικτικών στοιχείων και συμβιβασμό των backup ή recovery artifacts.
```bash
# Delete an object from a bucket
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY>

# Delete a specific version
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--version-id <VERSION_ID>

# Delete a bucket
aws s3api delete-bucket \
--bucket <BUCKET_NAME>
```
**Για περισσότερες πληροφορίες** [**ελέγξτε την πρωτότυπη έρευνα**](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/)**.**

{{#include ../../../../banners/hacktricks-training.md}}
