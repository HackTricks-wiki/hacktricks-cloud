# AWS - S3 Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## S3

Для додаткової інформації перегляньте:

{{#ref}}
../../aws-services/aws-s3-athena-and-glacier-enum.md
{{#endref}}

### Sensitive Information

Іноді у відкритих для читання бакетах можна знайти чутливу інформацію. Наприклад, секрети terraform state.

### Pivoting

Різні платформи можуть використовувати S3 для зберігання чутливих ресурсів.\  
Наприклад, **airflow** може зберігати там **DAGs** **code**, або **веб-сторінки** можуть безпосередньо обслуговуватись зі S3. Атакуючий з правами запису може **modify the code** у бакеті, щоб **pivot** на інші платформи, або **takeover accounts**, змінюючи JS файли.

### S3 Ransomware

У цьому сценарії **атакуючий створює KMS (Key Management Service) key у власному AWS account** або в іншому скомпрометованому акаунті. Потім він робить цей **ключ доступним будь-кому у світі**, дозволяючи будь-якому AWS user, role або account шифрувати об'єкти за допомогою цього ключа. Проте об'єкти не можна буде розшифрувати.

Атакуючий визначає цільовий **S3 bucket and gains write-level access** до нього різними способами. Це може бути через погану конфігурацію бакета, через відкритий доступ, або через отримання доступу до самої AWS environment. Зазвичай атакуються бакети, які містять чутливу інформацію, таку як personally identifiable information (PII), protected health information (PHI), логи, резервні копії тощо.

Щоб визначити, чи можна цільовий бакет використати для ransomware, атакуючий перевіряє його конфігурацію. Це включає перевірку, чи увімкнено **S3 Object Versioning** і чи увімкнено **multi-factor authentication delete (MFA delete)**. Якщо Object Versioning не увімкнено, атакуючий може продовжити. Якщо Object Versioning увімкнено, але MFA delete вимкнено, атакуючий може **disable Object Versioning**. Якщо і Object Versioning, і MFA delete увімкнені, виконати ransomware проти цього бакета стає складніше.

Використовуючи AWS API, атакуючий **замінює кожний об'єкт у бакеті зашифрованою копією, використовуючи свій KMS key**. Це фактично шифрує дані в бакеті, роблячи їх недоступними без ключа.

Щоб додатково посилити тиск, атакуючий планує видалення KMS key, який використовувався в атаці. Це дає цілі 7-денне вікно для відновлення даних перед тим, як ключ буде видалено і дані стануть остаточно втраченими.

Нарешті, атакуючий може завантажити фінальний файл, зазвичай з іменем "ransom-note.txt", який містить інструкції для жертви щодо відновлення файлів. Цей файл завантажується без шифрування, щоб привернути увагу цілі та повідомити про ransomware-атаку.

### `s3:RestoreObject`

Атакуючий з дозволом s3:RestoreObject може реактівувати об'єкти, заархівовані в Glacier або Deep Archive, роблячи їх тимчасово доступними. Це дозволяє відновлення та ексфільтрацію історично заархівованих даних (резервні копії, snapshots, логи, сертифікати, старі секрети), які зазвичай недосяжні. Якщо атакуючий поєднає цей дозвіл з правами на читання (наприклад, s3:GetObject), він може отримати повні копії чутливих даних.
```bash
aws s3api restore-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--restore-request '{
"Days": <NUMBER_OF_DAYS>,
"GlacierJobParameters": { "Tier": "Standard" }
}'
```
### `s3:Delete*`

Зловмисник з дозволом s3:Delete* може видаляти objects, versions і entire buckets, порушувати резервні копії та спричиняти негайну й незворотну втрату даних, знищення доказів і компрометацію артефактів резервного копіювання або відновлення.
```bash
# Delete an object from a bucket
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY>

# Delete a specific version
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--version-id <VERSION_ID>

# Delete a bucket
aws s3api delete-bucket \
--bucket <BUCKET_NAME>
```
**Для отримання додаткової інформації** [**перегляньте оригінальне дослідження**](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/)**.**

{{#include ../../../../banners/hacktricks-training.md}}
