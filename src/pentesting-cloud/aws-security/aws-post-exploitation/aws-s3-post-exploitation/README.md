# AWS - S3 Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## S3

有关更多信息，请参见：

{{#ref}}
../../aws-services/aws-s3-athena-and-glacier-enum.md
{{#endref}}

### 敏感信息

有时你可以在可读的 buckets 中发现敏感信息。例如，terraform state 中的 secrets。

### Pivoting

不同的平台可能使用 S3 来存储敏感资产。\
例如，**airflow** 可能将 **DAGs** **code** 存放在那里，或者 **web pages** 可能直接由 S3 提供。拥有写权限的攻击者可以 **modify the code** 从 bucket 中 **pivot** 到其他平台，或通过修改 JS 文件 **takeover accounts**。

### S3 Ransomware

在这种情形下，**attacker creates a KMS (Key Management Service) key in their own AWS account** 或在另一个被攻陷的账户中创建该 key。接着他们将该 **key accessible to anyone in the world**，允许任何 AWS user、role 或 account 使用此 key 对对象进行加密。然而，这些对象无法被解密。

攻击者通过各种方法识别目标 **S3 bucket and gains write-level access**。这可能是由于 bucket 配置不当导致公开暴露，或攻击者获得了 AWS 环境的访问权限。攻击者通常以包含敏感信息的 buckets 为目标，例如 personally identifiable information (PII)、protected health information (PHI)、日志、备份等。

为了确定该 bucket 是否可被用于 ransomware，攻击者会检查其配置。这包括确认 **S3 Object Versioning** 是否启用以及 **multi-factor authentication delete (MFA delete) is enabled**。如果未启用 Object Versioning，攻击者可以继续。如果启用了 Object Versioning 但 MFA delete 未启用，攻击者可以 **disable Object Versioning**。如果同时启用了 Object Versioning 和 MFA delete，则攻击者对该特定 bucket 发起 ransomware 将更加困难。

攻击者使用 AWS API **replaces each object in the bucket with an encrypted copy using their KMS key**。这会有效地加密 bucket 中的数据，没有该 key 则无法访问。

为了进一步施压，攻击者会安排删除用于攻击的 KMS key。这会给目标一个 7 天的窗口在 key 被删除前恢复数据，否则数据将永久丢失。

最后，攻击者可能会上传一个最终文件，通常名为 "ransom-note.txt"，其中包含关于如何取回文件的说明。该文件以未加密形式上传，可能是为了吸引目标注意并让其意识到发生了 ransomware 攻击。

**For more info** [**check the original research**](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/)**.**

{{#include ../../../../banners/hacktricks-training.md}}
