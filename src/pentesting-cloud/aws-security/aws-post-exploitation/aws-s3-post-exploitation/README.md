# AWS - S3 Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## S3

Para más información consulta:

{{#ref}}
../../aws-services/aws-s3-athena-and-glacier-enum.md
{{#endref}}

### Información sensible

A veces podrás encontrar información sensible legible en los buckets. Por ejemplo, secretos del state de terraform.

### Pivoting

Diferentes plataformas podrían usar S3 para almacenar activos sensibles.\
Por ejemplo, **airflow** podría estar almacenando **DAGs** **code** allí, o **web pages** podrían ser servidas directamente desde S3. Un atacante con permisos de escritura podría **modify the code** desde el bucket para **pivot** hacia otras plataformas, o **takeover accounts** modificando archivos JS.

### S3 Ransomware

En este escenario, el **atacante crea una KMS (Key Management Service) key en su propia cuenta de AWS** o en otra cuenta comprometida. Luego hacen que esta **key accesible para cualquier persona en el mundo**, permitiendo a cualquier usuario, role o cuenta de AWS cifrar objetos usando esta key. Sin embargo, los objetos no pueden ser descifrados.

El atacante identifica un objetivo que es un **S3 bucket and gains write-level access** a él usando varios métodos. Esto puede deberse a una configuración pobre del bucket que lo expone públicamente o a que el atacante obtiene acceso al entorno de AWS. Normalmente el atacante apunta a buckets que contienen información sensible como personally identifiable information (PII), protected health information (PHI), logs, backups, y más.

Para determinar si el bucket puede ser objetivo de ransomware, el atacante revisa su configuración. Esto incluye verificar si **S3 Object Versioning** está habilitado y si **multi-factor authentication delete (MFA delete) está habilitado**. Si Object Versioning no está habilitado, el atacante puede proceder. Si Object Versioning está habilitado pero MFA delete está deshabilitado, el atacante puede **disable Object Versioning**. Si tanto Object Versioning como MFA delete están habilitados, se vuelve más difícil para el atacante realizar ransomware en ese bucket específico.

Usando la API de AWS, el atacante **reemplaza cada objeto en el bucket con una copia cifrada usando su KMS key**. Esto efectivamente cifra los datos en el bucket, haciéndolos inaccesibles sin la key.

Para aumentar la presión, el atacante programa la eliminación de la KMS key usada en el ataque. Esto le da al objetivo una ventana de 7 días para recuperar sus datos antes de que la key sea eliminada y los datos se pierdan de forma permanente.

Finalmente, el atacante podría subir un archivo final, normalmente llamado "ransom-note.txt", que contiene instrucciones para el objetivo sobre cómo recuperar sus archivos. Este archivo se sube sin cifrar, probablemente para llamar la atención del objetivo y hacerle saber del ataque de ransomware.

**Para más info** [**revisa la investigación original**](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/)**.**

{{#include ../../../../banners/hacktricks-training.md}}
