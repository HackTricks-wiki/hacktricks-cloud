# AWS - S3 Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## S3

For more information check:

{{#ref}}
../../aws-services/aws-s3-athena-and-glacier-enum.md
{{#endref}}

### Sensitive Information

有时你会在 buckets 中以可读形式发现敏感信息。例如，terraform state secrets。

### Pivoting

Different platforms could be using S3 to store sensitive assets.\
For example, **airflow** could be storing **DAGs** **code** in there, or **web pages** could be directly served from S3. 拥有写权限的攻击者可以**从 bucket 修改 code**以**pivot**到其他平台，或通过修改 JS files **接管账户**。

### S3 Ransomware

在这种情景下，**攻击者在其自己的 AWS account**或另一个被攻陷的账户中创建一个 KMS (Key Management Service) key。然后他们使该 **key 对全世界任何人可访问**，允许任何 AWS 用户、角色或账户使用该 key 对对象进行加密。但这些对象无法被解密。

攻击者识别目标 **S3 bucket 并获得写权限**，这可能通过多种方法实现。可能是由于 bucket 配置不当导致公开暴露，或攻击者获取了 AWS 环境的访问权限。攻击者通常会选择包含敏感信息的 buckets，例如个人身份信息 (PII)、受保护的健康信息 (PHI)、日志、备份等。

为了确定该 bucket 是否可作为勒索目标，攻击者会检查其配置，包括验证 **S3 Object Versioning** 是否启用，以及 **multi-factor authentication delete (MFA delete)** 是否启用。如果 Object Versioning 未启用，攻击者可以继续。如果 Object Versioning 启用但 MFA delete 未启用，攻击者可以**禁用 Object Versioning**。如果 Object Versioning 和 MFA delete 都启用，那么对该 bucket 发起 ransomware 就更加困难。

使用 AWS API，攻击者会使用他们的 KMS key **替换 bucket 中的每个对象为加密副本**。这会有效地加密 bucket 中的数据，使其在没有该 key 的情况下无法访问。

为进一步施压，攻击者会安排删除用于攻击的 KMS key。这会给目标一个 7-day 的时间窗口来恢复数据，在 key 被删除并导致数据永久丢失之前。

最后，攻击者可能会上传一个最终文件，通常命名为 "ransom-note.txt"，其中包含目标如何取回其文件的说明。该文件以未加密形式上传，可能是为了吸引目标注意并让他们意识到发生了勒索攻击。

### `s3:RestoreObject`

拥有 s3:RestoreObject 权限的攻击者可以重新激活被存档到 Glacier 或 Deep Archive 的对象，使其临时可访问。这样可以恢复并外泄通常无法触及的历史归档数据（备份、快照、日志、证书、旧的 secrets）。如果攻击者将此权限与读取权限结合（例如，s3:GetObject），他们就能获取敏感数据的完整副本。
```bash
aws s3api restore-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--restore-request '{
"Days": <NUMBER_OF_DAYS>,
"GlacierJobParameters": { "Tier": "Standard" }
}'
```
### `s3:Delete*`

拥有 `s3:Delete*` 权限的攻击者可以删除对象、版本和整个存储桶，破坏备份，并导致立即且不可逆的数据丢失、证据毁灭，以及备份或恢复工件的妥协。
```bash
# Delete an object from a bucket
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY>

# Delete a specific version
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--version-id <VERSION_ID>

# Delete a bucket
aws s3api delete-bucket \
--bucket <BUCKET_NAME>
```
**欲了解更多信息** [**查看原始研究**](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/)**.**

{{#include ../../../../banners/hacktricks-training.md}}
