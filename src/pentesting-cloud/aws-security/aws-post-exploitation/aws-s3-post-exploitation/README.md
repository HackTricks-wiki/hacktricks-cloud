# AWS - S3 Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## S3

Za više informacija pogledajte:

{{#ref}}
../../aws-services/aws-s3-athena-and-glacier-enum.md
{{#endref}}

### Sensitive Information

Ponekad ćete moći da pronađete osetljive informacije čitljive u bucket-ovima. Na primer, terraform state secrets.

### Pivoting

Različite platforme mogu koristiti S3 za čuvanje osetljivih resursa.\
Na primer, **airflow** može čuvati **DAGs** **code** tamo, ili **web pages** mogu biti direktno servirane iz S3. Napadač sa dozvolama za upis može **izmeniti kod** u bucket-u da bi **pivotovao** na druge platforme, ili **preuzeo naloge** modifikacijom JS fajlova.

### S3 Ransomware

U ovom scenariju, napadač kreira KMS (Key Management Service) key u svom AWS nalogu ili u drugom kompromitovanom nalogu. Zatim taj key čini dostupan bilo kome u svetu, omogućavajući bilo kom AWS korisniku, rolu ili nalogu da enkriptuje objekte koristeći taj key. Međutim, objekti ne mogu biti dekriptovani.

Napadač identifikuje ciljanu S3 bucket i dobija write-level pristup toj bucket-i koristeći različite metode. To može biti posledica loše konfiguracije bucket-a koja je javno izložila bucket ili zbog toga što je napadač dobio pristup samom AWS okruženju. Napadač obično cilja bucket-ove koji sadrže osetljive informacije kao što su PII, PHI, logovi, backup-ovi i slično.

Da bi utvrdio da li bucket može biti meta ransomware-a, napadač proverava njegovu konfiguraciju. To uključuje verifikaciju da li je **S3 Object Versioning** omogućen i da li je **multi-factor authentication delete (MFA delete)** omogućen. Ako Object Versioning nije omogućen, napadač može nastaviti. Ako je Object Versioning omogućen, ali je MFA delete onemogućen, napadač može **onemogućiti Object Versioning**. Ako su i Object Versioning i MFA delete omogućeni, postaje teže za napadača da izvrši ransomware nad tom bucket-om.

Koristeći AWS API, napadač **zamenjuje svaki objekat u bucket-u enkriptovanom kopijom koristeći njihov KMS key**. Ovo efikasno enkriptuje podatke u bucket-u, čineći ih nedostupnim bez ključa.

Da bi dodatno izvršio pritisak, napadač zakazuje brisanje KMS key-a korišćenog u napadu. To daje meti 7-dnevni rok da oporavi podatke pre nego što key bude obrisan i podaci postanu trajno izgubljeni.

Na kraju, napadač može upload-ovati finalni fajl, obično nazvan "ransom-note.txt", koji sadrži instrukcije za metu kako da povrati svoje fajlove. Ovaj fajl se upload-uje bez enkripcije, verovatno da privuče pažnju mete i obavesti je o ransomware napadu.

### `s3:RestoreObject`

Napadač sa dozvolom s3:RestoreObject može reaktivirati objekte arhivirane u Glacier ili Deep Archive, čineći ih privremeno dostupnim. Ovo omogućava oporavak i eksfiltraciju istorijski arhiviranih podataka (backup-ova, snapshot-ova, logova, sertifikata, starih tajni) koji bi inače bili nedostupni. Ako napadač kombinuje ovu dozvolu sa read dozvolama (npr. s3:GetObject), može dobiti pune kopije osetljivih podataka.
```bash
aws s3api restore-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--restore-request '{
"Days": <NUMBER_OF_DAYS>,
"GlacierJobParameters": { "Tier": "Standard" }
}'
```
### `s3:Delete*`

Napadač sa s3:Delete* dozvolom može obrisati objekte, verzije i čitave buckets, narušiti backups i prouzrokovati trenutni i nepovratni gubitak podataka, uništenje dokaza i kompromitovanje backup ili recovery artefakata.
```bash
# Delete an object from a bucket
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY>

# Delete a specific version
aws s3api delete-object \
--bucket <BUCKET_NAME> \
--key <OBJECT_KEY> \
--version-id <VERSION_ID>

# Delete a bucket
aws s3api delete-bucket \
--bucket <BUCKET_NAME>
```
**Za više informacija** [**pogledajte originalno istraživanje**](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/)**.**

{{#include ../../../../banners/hacktricks-training.md}}
