# AWS - Lambda Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

For more information check:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Exfilrtate Lambda Credentials

Lambda는 런타임에 환경 변수로 credentials를 주입합니다. `/proc/self/environ`을 읽거나 취약한 함수를 통해 해당 변수들에 접근할 수 있다면 이를 직접 사용할 수 있습니다. 기본 변수 이름은 `AWS_SESSION_TOKEN`, `AWS_SECRET_ACCESS_KEY`, 및 `AWS_ACCESS_KEY_ID`입니다.

기본적으로 이 자격 증명들은 CloudWatch log group에 쓰기 권한(그 이름은 `AWS_LAMBDA_LOG_GROUP_NAME`에 저장됨)과 임의의 log group을 생성할 권한을 가집니다. 그러나 Lambda 함수들은 의도된 용도에 따라 더 많은 권한이 할당되는 경우가 자주 있습니다.

### Steal Others Lambda URL Requests

공격자가 Lambda 내부에서 RCE를 얻으면 다른 사용자의 Lambda로 향하는 HTTP 요청을 훔칠 수 있습니다. 요청에 민감한 정보(cookies, credentials...)가 포함되어 있다면 이를 탈취할 수 있습니다.

{{#ref}}
aws-warm-lambda-persistence.md
{{#endref}}

### Steal Others Lambda URL Requests & Extensions Requests

Lambda Layers를 악용하면 extensions를 남용해 Lambda에 persistence를 확보하고 요청을 훔치거나 수정할 수도 있습니다.

{{#ref}}
../../aws-persistence/aws-lambda-persistence/aws-abusing-lambda-extensions.md
{{#endref}}

### AWS Lambda – VPC Egress Bypass

빈 VpcConfig(SubnetIds=[], SecurityGroupIds=[])로 구성 업데이트하여 제한된 VPC에서 Lambda 함수를 강제로 내보내면, 함수는 Lambda가 관리하는 네트워킹 평면에서 실행되어 아웃바운드 인터넷 접근을 회복합니다. 이렇게 하면 NAT이 없는 private VPC 서브넷에 의해 적용된 egress 제어를 우회할 수 있습니다.

{{#ref}}
aws-lambda-vpc-egress-bypass.md
{{#endref}}

### AWS Lambda – Runtime Pinning/Rollback Abuse

`lambda:PutRuntimeManagementConfig`를 악용해 함수를 특정 runtime 버전(Manual)에 고정하거나 업데이트를 동결(FunctionUpdate)할 수 있습니다. 이는 악의적인 layers/wrappers와의 호환성을 유지하고 취약한 오래된 runtime에 함수를 머무르게 해 exploitation 및 장기적인 persistence에 도움을 줄 수 있습니다.

{{#ref}}
aws-lambda-runtime-pinning-abuse.md
{{#endref}}

### AWS Lambda – Log Siphon via LoggingConfig.LogGroup Redirection

`lambda:UpdateFunctionConfiguration`의 고급 로깅 제어를 악용해 함수의 로그를 공격자가 선택한 CloudWatch Logs log group으로 리디렉션할 수 있습니다. 코드나 실행 역할을 변경할 필요가 없으며(대부분의 Lambda 역할에는 이미 `logs:CreateLogGroup/CreateLogStream/PutLogEvents`가 `AWSLambdaBasicExecutionRole`을 통해 포함되어 있습니다), 함수가 secrets/request bodies를 출력하거나 stack trace로 크래시하면 새 log group에서 이를 수집할 수 있습니다.

{{#ref}}
aws-lambda-loggingconfig-redirection.md
{{#endref}}

### AWS - Lambda Function URL Public Exposure

Function URL AuthType을 NONE으로 전환하고 모든 사용자에게 lambda:InvokeFunctionUrl 권한을 부여하는 resource-based policy를 첨부하면, private Lambda Function URL을 공개된 인증 없는 엔드포인트로 만들 수 있습니다. 이는 내부 함수를 익명으로 호출할 수 있게 하여 민감한 백엔드 작업을 노출시킬 수 있습니다.

{{#ref}}
aws-lambda-function-url-public-exposure.md
{{#endref}}

### AWS Lambda – Event Source Mapping Target Hijack

`UpdateEventSourceMapping`을 악용해 기존 Event Source Mapping(ESM)의 대상 Lambda 함수를 변경하면 DynamoDB Streams, Kinesis, 또는 SQS의 레코드가 공격자가 제어하는 함수로 전달되도록 할 수 있습니다. 이렇게 하면 생산자나 원래 함수 코드를 건드리지 않고 실시간 데이터를 은밀히 전환할 수 있습니다.

{{#ref}}
aws-lambda-event-source-mapping-hijack.md
{{#endref}}

### AWS Lambda – EFS Mount Injection data exfiltration

`lambda:UpdateFunctionConfiguration`를 악용해 기존 EFS Access Point를 Lambda에 연결한 뒤, 마운트된 경로에서 파일을 나열/읽는 간단한 코드를 배포해 함수가 이전에는 접근하지 못했던 공유된 secrets/config를 exfiltrate할 수 있습니다.

{{#ref}}
aws-lambda-efs-mount-injection.md
{{#endref}}



{{#include ../../../../banners/hacktricks-training.md}}
