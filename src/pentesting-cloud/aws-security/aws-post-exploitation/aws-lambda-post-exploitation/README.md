# AWS - Lambda Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

자세한 내용은 다음을 확인하세요:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Lambda 자격 증명 유출

Lambda는 런타임에 자격 증명을 주입하기 위해 환경 변수를 사용합니다. `/proc/self/environ`을 읽거나 취약한 함수를 이용해 접근할 수 있다면 해당 값을 획득해 직접 사용할 수 있습니다. 이 값들은 기본 환경 변수명 `AWS_SESSION_TOKEN`, `AWS_SECRET_ACCESS_KEY`, `AWS_ACCESS_KEY_ID`에 저장됩니다.

기본적으로 해당 자격 증명은 cloudwatch log group에 쓰기 권한(그 이름은 `AWS_LAMBDA_LOG_GROUP_NAME`에 저장됨)과 임의의 로그 그룹을 생성할 권한을 가집니다. 그러나 lambda functions는 용도에 따라 더 많은 권한이 할당되는 경우가 많습니다.

### `lambda:Delete*`
lambda:Delete* 권한을 부여받은 공격자는 Lambda functions, versions/aliases, layers, event source mappings 및 기타 관련 구성들을 삭제할 수 있습니다.
```bash
aws lambda delete-function \
--function-name <LAMBDA_NAME>
```
### 다른 사용자의 Lambda URL 요청 탈취

공격자가 어떤 방법으로든 Lambda 내부에서 RCE를 획득하면 다른 사용자의 Lambda에 대한 HTTP 요청을 탈취할 수 있습니다. 요청에 민감한 정보(예: cookies, credentials...)가 포함되어 있으면 이를 탈취할 수 있습니다.

{{#ref}}
aws-warm-lambda-persistence.md
{{#endref}}

### 다른 사용자의 Lambda URL 요청 및 Extensions 요청 탈취

Lambda Layers를 악용하면 extensions를 악용해 Lambda에 지속적으로 남아 요청을 탈취하거나 수정할 수도 있습니다.

{{#ref}}
../../aws-persistence/aws-lambda-persistence/aws-abusing-lambda-extensions.md
{{#endref}}

### AWS Lambda – VPC 이그레스 우회

빈 VpcConfig(SubnetIds=[], SecurityGroupIds=[])로 구성 업데이트하여 제한된 VPC에서 Lambda 함수를 밖으로 빼낼 수 있습니다. 그러면 함수는 Lambda가 관리하는 네트워킹 영역에서 실행되어 아웃바운드 인터넷 접근을 회복하고 NAT 없는 private VPC 서브넷에서 적용되는 egress 제어를 우회하게 됩니다.

{{#ref}}
aws-lambda-vpc-egress-bypass.md
{{#endref}}

### AWS Lambda – Runtime Pinning/Rollback 악용

`lambda:PutRuntimeManagementConfig`를 악용해 함수를 특정 runtime 버전(Manual)에 고정하거나 업데이트를 동결(FunctionUpdate)할 수 있습니다. 이렇게 하면 악성 layers/wrappers와의 호환성을 유지하고 함수가 오래된 취약한 runtime에 머물러 익스플로잇 및 장기 persistence에 도움이 될 수 있습니다.

{{#ref}}
aws-lambda-runtime-pinning-abuse.md
{{#endref}}

### AWS Lambda – LoggingConfig.LogGroup 리디렉션을 통한 로그 탈취

`lambda:UpdateFunctionConfiguration`의 고급 로깅 제어를 악용해 함수 로그를 공격자가 선택한 CloudWatch Logs 로그 그룹으로 리디렉션할 수 있습니다. 이 방법은 코드나 실행 역할을 변경하지 않고도 작동합니다(대부분의 Lambda 역할은 이미 `AWSLambdaBasicExecutionRole`을 통해 `logs:CreateLogGroup/CreateLogStream/PutLogEvents` 권한을 포함). 함수가 secrets/request bodies를 출력하거나 스택 트레이스로 크래시하면 새로운 로그 그룹에서 이를 수집할 수 있습니다.

{{#ref}}
aws-lambda-loggingconfig-redirection.md
{{#endref}}

### AWS - Lambda Function URL 공개 노출

Function URL AuthType를 NONE으로 변경하고 모든 사용자에게 lambda:InvokeFunctionUrl 권한을 부여하는 resource-based policy를 연결하면 private Lambda Function URL을 public 무인증 엔드포인트로 만들 수 있습니다. 이는 내부 함수의 익명 호출을 가능하게 하며 민감한 백엔드 작업을 노출할 수 있습니다.

{{#ref}}
aws-lambda-function-url-public-exposure.md
{{#endref}}

### AWS Lambda – Event Source Mapping 대상 하이재크

`UpdateEventSourceMapping`을 악용해 기존 Event Source Mapping(ESM)의 대상 Lambda 함수를 변경하면 DynamoDB Streams, Kinesis 또는 SQS의 레코드가 공격자 제어 함수로 전달됩니다. 이는 프로듀서나 원래 함수 코드를 건드리지 않고 실시간 데이터를 은밀히 우회시킵니다.

{{#ref}}
aws-lambda-event-source-mapping-hijack.md
{{#endref}}

### AWS Lambda – EFS Mount Injection 데이터 exfiltration

`lambda:UpdateFunctionConfiguration`을 악용해 기존 EFS Access Point를 Lambda에 연결한 다음, 마운트된 경로에서 파일을 나열/읽는 간단한 코드를 배포하여 함수가 이전에 접근할 수 없었던 공유된 secrets/config를 exfiltrate할 수 있습니다.

{{#ref}}
aws-lambda-efs-mount-injection.md
{{#endref}}



{{#include ../../../../banners/hacktricks-training.md}}
