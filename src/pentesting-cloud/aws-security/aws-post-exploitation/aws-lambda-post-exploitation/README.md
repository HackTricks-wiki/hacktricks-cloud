# AWS - Lambda Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## Lambda

For more information check:

{{#ref}}
../../aws-services/aws-lambda-enum.md
{{#endref}}

### Exfilrtate Lambda Credentials

Lambda 使用环境变量在运行时注入凭证。如果你能访问这些变量（例如读取 `/proc/self/environ` 或直接利用存在漏洞的函数），就可以自行使用这些凭证。它们存放在默认变量名 `AWS_SESSION_TOKEN`、`AWS_SECRET_ACCESS_KEY` 和 `AWS_ACCESS_KEY_ID` 中。

默认情况下，这些凭证具有写入 cloudwatch log group 的权限（该 log group 的名称保存在 `AWS_LAMBDA_LOG_GROUP_NAME`），并且可以创建任意 log group。不过根据函数的用途，lambda functions 通常会被赋予更多权限。

### `lambda:Delete*`
被授予 lambda:Delete* 权限的攻击者可以删除 Lambda functions、versions/aliases、layers、event source mappings 以及其他相关配置。
```bash
aws lambda delete-function \
--function-name <LAMBDA_NAME>
```
### 窃取其他人的 Lambda URL 请求

如果攻击者以某种方式在 Lambda 内获得了 RCE，就能够窃取其他用户发送到该 Lambda 的 HTTP 请求。如果这些请求包含敏感信息（cookies, credentials...），攻击者就可以窃取它们。

{{#ref}}
aws-warm-lambda-persistence.md
{{#endref}}

### 窃取其他 Lambda URL 请求 & Extensions 请求

滥用 Lambda Layers 也可以滥用 extensions，在 Lambda 中实现持久化，同时窃取并修改请求。

{{#ref}}
../../aws-persistence/aws-lambda-persistence/aws-abusing-lambda-extensions.md
{{#endref}}

### AWS Lambda – VPC Egress Bypass

通过将其配置更新为空的 VpcConfig (SubnetIds=[], SecurityGroupIds=[])，可以强制将 Lambda 函数移出受限的 VPC。该函数随后将在 Lambda 管理的网络平面中运行，重新获得出站互联网访问，从而绕过私有 VPC 子网（无 NAT）实施的 egress 控制。

{{#ref}}
aws-lambda-vpc-egress-bypass.md
{{#endref}}

### AWS Lambda – Runtime Pinning/Rollback Abuse

滥用 `lambda:PutRuntimeManagementConfig` 将函数固定到特定的 runtime 版本（Manual）或冻结更新（FunctionUpdate）。这可保持与恶意 layers/wrappers 的兼容性，并可能使函数停留在过时、易受攻击的 runtime 上，便于利用和长期持久化。

{{#ref}}
aws-lambda-runtime-pinning-abuse.md
{{#endref}}

### AWS Lambda – Log Siphon via LoggingConfig.LogGroup Redirection

滥用 `lambda:UpdateFunctionConfiguration` 的高级日志控制，将函数的日志重定向到攻击者选择的 CloudWatch Logs 日志组。此方法无需更改代码或执行角色（大多数 Lambda 角色已有通过 `AWSLambdaBasicExecutionRole` 授予的 `logs:CreateLogGroup/CreateLogStream/PutLogEvents`）。如果函数打印了 secrets/request bodies 或因崩溃产生堆栈跟踪，可以从新的日志组中收集这些信息。

{{#ref}}
aws-lambda-loggingconfig-redirection.md
{{#endref}}

### AWS - Lambda Function URL Public Exposure

通过将 Function URL 的 AuthType 切换为 NONE，并附加授予 lambda:InvokeFunctionUrl 给所有人的基于资源的策略，可将私有 Lambda Function URL 变为公共的无认证端点。这允许匿名调用内部函数，并可能暴露敏感的后端操作。

{{#ref}}
aws-lambda-function-url-public-exposure.md
{{#endref}}

### AWS Lambda – Event Source Mapping Target Hijack

滥用 `UpdateEventSourceMapping` 更改现有 Event Source Mapping (ESM) 的目标 Lambda 函数，使来自 DynamoDB Streams、Kinesis 或 SQS 的记录被投递到攻击者控制的函数。这样可以在不接触生产者或原始函数代码的情况下，静默地劫持实时数据。

{{#ref}}
aws-lambda-event-source-mapping-hijack.md
{{#endref}}

### AWS Lambda – EFS Mount Injection data exfiltration

滥用 `lambda:UpdateFunctionConfiguration` 将现有的 EFS Access Point 挂载到 Lambda，然后部署简单代码列出/读取挂载路径下的文件，以外传函数之前无法访问的共享 secrets/config。

{{#ref}}
aws-lambda-efs-mount-injection.md
{{#endref}}



{{#include ../../../../banners/hacktricks-training.md}}
