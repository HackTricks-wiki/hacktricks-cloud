# AWS - Secrets Manager Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Secrets Manager

For more information check:

{{#ref}}
../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### Lees geheime

Die **geheime self is sensitiewe inligting**, [kyk na die privesc bladsy](../aws-privilege-escalation/aws-secrets-manager-privesc.md) om te leer hoe om dit te lees.

### DoS — Verander geheime waarde

Deur die waarde van die geheim te verander, kan jy **'n DoS op al die stelsels wat van daardie waarde afhanklik is veroorsaak.**

> [!WARNING]
> Let wel dat vorige waardes ook gestoor word, so dit is maklik om net terug te keer na die vorige waarde.
```bash
# Requires permission secretsmanager:PutSecretValue
aws secretsmanager put-secret-value \
--secret-id MyTestSecret \
--secret-string "{\"user\":\"diegor\",\"password\":\"EXAMPLE-PASSWORD\"}"
```
### DoS Change KMS key

As die aanvaller die secretsmanager:UpdateSecret toestemming het, kan hulle die geheim konfigureer om 'n KMS key te gebruik wat deur die aanvaller besit word. Daardie sleutel word aanvanklik so opgestel dat enigiemand daartoe toegang het en dit kan gebruik, sodat die geheim met die nuwe sleutel bygewerk kan word. As die sleutel nie toeganklik was nie, kon die geheim nie bygewerk word nie.

Na die verandering van die sleutel vir die geheim, wysig die aanvaller die konfigurasie van hul sleutel sodat slegs hulle daartoe toegang het. Op hierdie manier sal toekomstige weergawes van die geheim met die nuwe sleutel geënkripteer word, en aangesien daar geen toegang tot daardie sleutel is nie, sal die vermoë om die geheim op te haal verlore gaan.

Dit is belangrik om te let dat hierdie ontoeganklikheid slegs in latere weergawes sal voorkom, nadat die inhoud van die geheim verander is, aangesien die huidige weergawe steeds met die oorspronklike KMS key geënkripteer is.
```bash
aws secretsmanager update-secret \
--secret-id MyTestSecret \
--kms-key-id arn:aws:kms:us-west-2:123456789012:key/EXAMPLE1-90ab-cdef-fedc-ba987EXAMPLE
```
### DoS Deleting Secret

Die minimum aantal dae om 'n secret te verwyder is 7
```bash
aws secretsmanager delete-secret \
--secret-id MyTestSecret \
--recovery-window-in-days 7
```
## secretsmanager:RestoreSecret

Dit is moontlik om 'n geheim te herstel, wat die herstel van geheime wat vir verwydering geskeduleer is moontlik maak, aangesien die minimum verwyderingsperiode vir geheime 7 dae is en die maksimum 30 dae. Saam met die secretsmanager:GetSecretValue toestemming maak dit moontlik om hul inhoud te bekom.

Om 'n geheim wat in die proses van verwydering is te herstel, gebruik jy die volgende opdrag:
```bash
aws secretsmanager restore-secret \
--secret-id <Secret_Name>
```
## secretsmanager:DeleteResourcePolicy

Hierdie aksie maak dit moontlik om die hulpbronbeleid te verwyder wat beheer wie toegang tot 'n geheim het. Dit kan tot 'n DoS lei indien die hulpbronbeleid gekonfigureer was om toegang aan 'n spesifieke groep gebruikers toe te laat.

Om die hulpbronbeleid te verwyder:
```bash
aws secretsmanager delete-resource-policy \
--secret-id <Secret_Name>
```
## secretsmanager:UpdateSecretVersionStage

Die state van 'n geheim word gebruik om weergawes van 'n geheim te bestuur. AWSCURRENT merk die aktiewe weergawe wat toepassings gebruik, AWSPREVIOUS hou die vorige weergawe sodat jy terug kan rol indien nodig, en AWSPENDING word in die rotasieproses gebruik om 'n nuwe weergawe voor te berei en te valideer voordat dit die huidige gemaak word.

Toepassings lees altyd die weergawe met AWSCURRENT. As iemand daardie etiket na die verkeerde weergawe skuif, sal die toepassings ongeldige inlogbewyse gebruik en kan misluk.

AWSPREVIOUS word nie outomaties gebruik nie. As AWSCURRENT egter verwyder of verkeerd toegewys word, kan dit lyk asof alles steeds op die vorige weergawe loop.
```bash
aws secretsmanager update-secret-version-stage \
--secret-id <your-secret-name-or-arn> \
--version-stage AWSCURRENT \
--move-to-version-id <target-version-id> \
--remove-from-version-id <previous-version-id>
```
{{#include ../../../banners/hacktricks-training.md}}
