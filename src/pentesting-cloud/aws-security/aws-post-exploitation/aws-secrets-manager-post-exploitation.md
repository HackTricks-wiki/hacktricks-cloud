# AWS - Secrets Manager Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Secrets Manager

Kwa maelezo zaidi angalia:

{{#ref}}
../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### Read Secrets

**secrets zenyewe ni taarifa nyeti**, [angalia ukurasa wa privesc](../aws-privilege-escalation/aws-secrets-manager-privesc.md) ili kujifunza jinsi ya kuvisoma.

### DoS Change Secret Value

Kubadilisha thamani ya secret kunaweza **kusababisha DoS kwa mifumo yote inayotegemea thamani hiyo.**

> [!WARNING]
> Kumbuka kwamba thamani za awali pia zinahifadhiwa, hivyo ni rahisi kurudisha thamani ya awali.
```bash
# Requires permission secretsmanager:PutSecretValue
aws secretsmanager put-secret-value \
--secret-id MyTestSecret \
--secret-string "{\"user\":\"diegor\",\"password\":\"EXAMPLE-PASSWORD\"}"
```
### DoS Badilisha KMS key

Ikiwa mshambuliaji ana ruhusa secretsmanager:UpdateSecret, anaweza kusanidi siri kutumia KMS key inayomilikiwa na mshambuliaji. Ufunguo huo awali umewekwa kwa njia kwamba mtu yeyote anaweza kuufikia na kutumia, hivyo kusasisha siri kwa kutumia KMS key mpya kunawezekana. Ikiwa ufunguo haukufikiwa, siri haiwezi kusasishwa.

Baada ya kubadilisha ufunguo wa siri, mshambuliaji hubadilisha usanidi wa ufunguo wake ili ufikivu uke kwa yeye pekee. Kwa njia hii, kwenye matoleo yanayofuata ya siri, itafichwa kwa kutumia ufunguo mpya, na kwa kuwa hakuna njia ya kuufikia, uwezo wa kupata siri utapotea.

Ni muhimu kutaja kwamba ukosefu huu wa ufikivu utatokea tu katika matoleo ya baadaye, baada ya yaliyomo kwenye siri kubadilika, kwani toleo la sasa bado limefichwa kwa kutumia KMS key ya awali.
```bash
aws secretsmanager update-secret \
--secret-id MyTestSecret \
--kms-key-id arn:aws:kms:us-west-2:123456789012:key/EXAMPLE1-90ab-cdef-fedc-ba987EXAMPLE
```
### DoS Kufuta Siri

Idadi ya chini ya siku za kufuta siri ni 7.
```bash
aws secretsmanager delete-secret \
--secret-id MyTestSecret \
--recovery-window-in-days 7
```
## secretsmanager:RestoreSecret

Iwezekana kurejesha secret, jambo linaloruhusu urejesho wa secrets zilizowekwa kufutwa, kwa sababu kipindi cha chini cha kufutwa kwa secrets ni siku 7 na kipindi cha juu ni siku 30. Pamoja na ruhusa secretsmanager:GetSecretValue, hili linafanya iwezekane kupata yaliyomo ndani yao.

Ili kurejesha secret ambayo iko katika mchakato wa kufutwa, unaweza kutumia amri ifuatayo:
```bash
aws secretsmanager restore-secret \
--secret-id <Secret_Name>
```
## secretsmanager:DeleteResourcePolicy

Kitendo hiki kinaruhusu kufuta resource policy inayodhibiti nani anaweza kupata secret. Hii inaweza kusababisha DoS ikiwa resource policy ilipangwa kuruhusu ufikiaji kwa kundi maalum la watumiaji.

Ili kufuta resource policy:
```bash
aws secretsmanager delete-resource-policy \
--secret-id <Secret_Name>
```
## secretsmanager:UpdateSecretVersionStage

Hali za siri hutumika kusimamia matoleo ya siri. AWSCURRENT inaonyesha toleo linalofanya kazi ambalo programu zinalitumia, AWSPREVIOUS inahifadhi toleo la awali ili uweze kurudi nyuma ikiwa inahitajika, na AWSPENDING inatumiwa katika mchakato wa rotation kuandaa na kuthibitisha toleo jipya kabla ya kulifanya kuwa toleo la sasa.

Programu daima husoma toleo lenalo lebo ya AWSCURRENT. Ikiwa mtu atahamisha lebo hiyo kwa toleo lisilo sahihi, programu zitatumia credentials zisizo halali na zinaweza kushindwa.

AWSPREVIOUS haitumiki moja kwa moja. Hata hivyo, ikiwa AWSCURRENT itaondolewa au itatoleweshwa vibaya, kunaweza kuonekana kwamba kila kitu bado kinaendesha kwa toleo la awali.
```bash
aws secretsmanager update-secret-version-stage \
--secret-id <your-secret-name-or-arn> \
--version-stage AWSCURRENT \
--move-to-version-id <target-version-id> \
--remove-from-version-id <previous-version-id>
```
{{#include ../../../banners/hacktricks-training.md}}
