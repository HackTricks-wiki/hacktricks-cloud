# AWS - Secrets Manager Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Secrets Manager

Daha fazla bilgi için bakın:

{{#ref}}
../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### Read Secrets

**secrets kendileri hassas bilgilerdir**, nasıl okunacağını öğrenmek için [privesc sayfasına bakın](../aws-privilege-escalation/aws-secrets-manager-privesc.md).

### DoS Change Secret Value

secret değerini değiştirerek, o değere bağımlı tüm sistemleri **DoS** edebilirsiniz.

> [!WARNING]
> Önceki değerlerin de saklandığını unutmayın, bu yüzden önceki değere geri dönmek kolaydır.
```bash
# Requires permission secretsmanager:PutSecretValue
aws secretsmanager put-secret-value \
--secret-id MyTestSecret \
--secret-string "{\"user\":\"diegor\",\"password\":\"EXAMPLE-PASSWORD\"}"
```
### DoS Change KMS key

Eğer saldırganın secretsmanager:UpdateSecret izni varsa, secret'i saldırgana ait bir KMS key kullanacak şekilde yapılandırabilir. Bu KMS key başlangıçta herkesin erişip kullanabileceği şekilde ayarlanmıştır, bu yüzden secret'i yeni anahtarla güncellemek mümkündür. KMS key erişilebilir olmasaydı, secret güncellenemezdi.

Secret için anahtarı değiştirdikten sonra saldırgan, KMS key'in yapılandırmasını yalnızca kendisinin erişebileceği şekilde değiştirir. Böylece secret'in sonraki sürümleri yeni KMS key ile şifrelenir ve anahtara erişim olmadığından secret'i geri alma yeteneği kaybolur.

Bu erişilemezliğin yalnızca secret içeriği değiştikten sonraki sürümlerde meydana geleceğini not etmek önemlidir; çünkü mevcut sürüm hâlâ orijinal KMS key ile şifrelenmiş durumdadır.
```bash
aws secretsmanager update-secret \
--secret-id MyTestSecret \
--kms-key-id arn:aws:kms:us-west-2:123456789012:key/EXAMPLE1-90ab-cdef-fedc-ba987EXAMPLE
```
### DoS Secret Silme

Bir secret'i silmek için minimum süre 7 gündür.
```bash
aws secretsmanager delete-secret \
--secret-id MyTestSecret \
--recovery-window-in-days 7
```
## secretsmanager:RestoreSecret

Bir secret'i geri yüklemek mümkündür; bu, silinmek üzere planlanmış secret'ların geri yüklenmesine olanak tanır, çünkü secret'lar için minimum silme süresi 7 gün ve maksimum 30 gündür. secretsmanager:GetSecretValue izniyle birlikte, bu secret'ların içeriklerini almak mümkün olur.

Silinme işlemi devam eden bir secret'ı kurtarmak için aşağıdaki komutu kullanabilirsiniz:
```bash
aws secretsmanager restore-secret \
--secret-id <Secret_Name>
```
## secretsmanager:DeleteResourcePolicy

Bu eylem, bir secret'e kimlerin erişebileceğini kontrol eden resource policy'yi silmeye izin verir. Eğer resource policy erişimi belirli bir kullanıcı grubuna verecek şekilde yapılandırılmışsa, bu bir DoS'e yol açabilir.

Resource policy'yi silmek için:
```bash
aws secretsmanager delete-resource-policy \
--secret-id <Secret_Name>
```
## secretsmanager:UpdateSecretVersionStage

Bir secret'in durumları, secret sürümlerini yönetmek için kullanılır. AWSCURRENT, uygulamaların kullandığı aktif sürümü işaret eder; AWSPREVIOUS, gerekirse geri dönebileceğiniz önceki sürümü saklar; AWSPENDING ise rotation sürecinde yeni bir sürümü aktif yapmadan önce hazırlamak ve doğrulamak için kullanılır.

Uygulamalar her zaman AWSCURRENT etiketli sürümü okur. Birisi o etiketi yanlış sürüme taşırsa, uygulamalar geçersiz kimlik bilgilerini kullanır ve başarısız olabilir.

AWSPREVIOUS otomatik olarak kullanılmaz. Ancak, AWSCURRENT kaldırılır veya yanlış atanırsa, her şey hâlâ önceki sürümle çalışıyor gibi görünebilir.
```bash
aws secretsmanager update-secret-version-stage \
--secret-id <your-secret-name-or-arn> \
--version-stage AWSCURRENT \
--move-to-version-id <target-version-id> \
--remove-from-version-id <previous-version-id>
```
{{#include ../../../banners/hacktricks-training.md}}
