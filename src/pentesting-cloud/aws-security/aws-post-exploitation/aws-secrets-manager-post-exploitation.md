# AWS - Secrets Manager Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Secrets Manager

Więcej informacji:

{{#ref}}
../aws-services/aws-secrets-manager-enum.md
{{#endref}}

### Read Secrets

**Sekrety same w sobie są informacjami wrażliwymi**, [sprawdź stronę privesc](../aws-privilege-escalation/aws-secrets-manager-privesc.md) aby dowiedzieć się, jak je odczytać.

### DoS Change Secret Value

Zmieniając wartość sekretu możesz **spowodować DoS wszystkich systemów, które zależą od tej wartości.**

> [!WARNING]
> Należy pamiętać, że poprzednie wartości są również przechowywane, więc łatwo jest po prostu powrócić do poprzedniej wartości.
```bash
# Requires permission secretsmanager:PutSecretValue
aws secretsmanager put-secret-value \
--secret-id MyTestSecret \
--secret-string "{\"user\":\"diegor\",\"password\":\"EXAMPLE-PASSWORD\"}"
```
### DoS Change KMS key

Jeśli attacker ma uprawnienie secretsmanager:UpdateSecret, może skonfigurować secret tak, aby używał KMS key należącego do attacker. Ten KMS key jest początkowo ustawiony w taki sposób, że każdy może mieć do niego dostęp i go używać, więc aktualizacja secret z użyciem nowego KMS key jest możliwa. Gdyby KMS key nie był dostępny, secret nie mógłby zostać zaktualizowany.

Po zmianie KMS key dla secret, attacker modyfikuje konfigurację swojego KMS key tak, aby tylko on miał do niego dostęp. W ten sposób w kolejnych wersjach secret będzie szyfrowany nowym KMS key, a ponieważ nie będzie dostępu do tego KMS key, możliwość pobrania secret zostanie utracona.

Ważne jest, aby zauważyć, że ta niedostępność wystąpi dopiero w późniejszych wersjach, po zmianie zawartości secret, ponieważ bieżąca wersja jest nadal zaszyfrowana oryginalnym KMS key.
```bash
aws secretsmanager update-secret \
--secret-id MyTestSecret \
--kms-key-id arn:aws:kms:us-west-2:123456789012:key/EXAMPLE1-90ab-cdef-fedc-ba987EXAMPLE
```
### DoS Usuwanie sekretu

Minimalna liczba dni potrzebna do usunięcia sekretu wynosi 7
```bash
aws secretsmanager delete-secret \
--secret-id MyTestSecret \
--recovery-window-in-days 7
```
## secretsmanager:RestoreSecret

Możliwe jest przywrócenie secretu, co pozwala na przywrócenie secretów zaplanowanych do usunięcia — minimalny okres usuwania secretów to 7 dni, a maksymalny 30 dni. W połączeniu z uprawnieniem secretsmanager:GetSecretValue umożliwia to pobranie ich zawartości.

Aby odzyskać secret, który jest w trakcie usuwania, możesz użyć następującego polecenia:
```bash
aws secretsmanager restore-secret \
--secret-id <Secret_Name>
```
## secretsmanager:DeleteResourcePolicy

Ta akcja pozwala usunąć politykę zasobów, która kontroluje, kto może uzyskać dostęp do secret. Może to doprowadzić do DoS, jeśli polityka zasobów była skonfigurowana tak, aby zezwalać na dostęp tylko określonej grupie użytkowników.

Aby usunąć politykę zasobów:
```bash
aws secretsmanager delete-resource-policy \
--secret-id <Secret_Name>
```
## secretsmanager:UpdateSecretVersionStage

Stany sekretu są używane do zarządzania wersjami sekretu. AWSCURRENT oznacza aktywną wersję, której używają aplikacje, AWSPREVIOUS przechowuje poprzednią wersję, aby można było przywrócić ją w razie potrzeby, a AWSPENDING jest używany w procesie rotacji do przygotowania i walidacji nowej wersji przed ustawieniem jej jako bieżącej.

Aplikacje zawsze odczytują wersję oznaczoną AWSCURRENT. Jeśli ktoś przeniesie tę etykietę na niewłaściwą wersję, aplikacje będą używać nieprawidłowych poświadczeń i mogą nie działać.

AWSPREVIOUS nie jest używane automatycznie. Jednak jeśli AWSCURRENT zostanie usunięte lub przypisane nieprawidłowo, może się wydawać, że wszystko nadal działa na poprzedniej wersji.
```bash
aws secretsmanager update-secret-version-stage \
--secret-id <your-secret-name-or-arn> \
--version-stage AWSCURRENT \
--move-to-version-id <target-version-id> \
--remove-from-version-id <previous-version-id>
```
{{#include ../../../banners/hacktricks-training.md}}
