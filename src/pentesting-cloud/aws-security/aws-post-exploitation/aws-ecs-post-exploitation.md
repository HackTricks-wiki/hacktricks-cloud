# AWS - ECS Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## ECS

Για περισσότερες πληροφορίες ελέγξτε:

{{#ref}}
../aws-services/aws-ecs-enum.md
{{#endref}}

### Host IAM Roles

Στο ECS, ένα **IAM role μπορεί να ανατεθεί στην εργασία** που εκτελείται μέσα στο κοντέινερ. **Εάν** η εργασία εκτελείται μέσα σε μια **EC2** παρουσία, η **EC2 παρουσία** θα έχει **ένα άλλο IAM** ρόλο συσχετισμένο με αυτήν.\
Αυτό σημαίνει ότι αν καταφέρετε να **συμβιβάσετε** μια παρουσία ECS, μπορείτε δυνητικά να **αποκτήσετε τον IAM ρόλο που σχετίζεται με το ECR και με την EC2 παρουσία**. Για περισσότερες πληροφορίες σχετικά με το πώς να αποκτήσετε αυτά τα διαπιστευτήρια, ελέγξτε:

{{#ref}}
https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf
{{#endref}}

> [!CAUTION]
> Σημειώστε ότι αν η EC2 παρουσία επιβάλλει το IMDSv2, [**σύμφωνα με τα έγγραφα**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html), η **απάντηση του PUT request** θα έχει **όριο hop 1**, καθιστώντας αδύνατη την πρόσβαση στα μεταδεδομένα EC2 από ένα κοντέινερ μέσα στην EC2 παρουσία.

### Privesc to node to steal other containers creds & secrets

Αλλά επιπλέον, η EC2 χρησιμοποιεί το docker για να εκτελεί τις εργασίες EC, οπότε αν μπορείτε να διαφύγετε στον κόμβο ή **να αποκτήσετε πρόσβαση στο docker socket**, μπορείτε να **ελέγξετε** ποιες **άλλες κοντέινερ** εκτελούνται, και ακόμη και **να μπείτε μέσα τους** και **να κλέψετε τους IAM ρόλους** που είναι συσχετισμένοι.

#### Making containers run in current host

Επιπλέον, ο **ρόλος της EC2 παρουσίας** θα έχει συνήθως αρκετές **άδειες** για να **ενημερώσει την κατάσταση της παρουσίας κοντέινερ** των EC2 παρουσιών που χρησιμοποιούνται ως κόμβοι μέσα στο cluster. Ένας επιτιθέμενος θα μπορούσε να τροποποιήσει την **κατάσταση μιας παρουσίας σε DRAINING**, τότε η ECS θα **αφαιρέσει όλες τις εργασίες από αυτήν** και αυτές που εκτελούνται ως **REPLICA** θα εκτελούνται **σε μια διαφορετική παρουσία,** δυνητικά μέσα στην **παρουσία του επιτιθέμενου** ώστε να μπορεί να **κλέψει τους IAM ρόλους τους** και πιθανές ευαίσθητες πληροφορίες από μέσα στο κοντέινερ.
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
Η ίδια τεχνική μπορεί να γίνει με **την απεγγραφή της EC2 παρουσίας από το cluster**. Αυτό είναι δυνητικά λιγότερο κρυφό αλλά θα **αναγκάσει τις εργασίες να εκτελούνται σε άλλες παρουσίες:**
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
Μια τελική τεχνική για να αναγκάσετε την επανεκτέλεση των εργασιών είναι να υποδείξετε στο ECS ότι το **έργο ή το κοντέινερ σταμάτησε**. Υπάρχουν 3 πιθανά APIs για να το κάνετε αυτό:
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### Κλοπή ευαίσθητων πληροφοριών από κοντέινερ ECR

Η EC2 παρουσία θα έχει πιθανώς επίσης την άδεια `ecr:GetAuthorizationToken` επιτρέποντάς της να **κατεβάσει εικόνες** (μπορείτε να αναζητήσετε ευαίσθητες πληροφορίες σε αυτές). 

{{#include ../../../banners/hacktricks-training.md}}
