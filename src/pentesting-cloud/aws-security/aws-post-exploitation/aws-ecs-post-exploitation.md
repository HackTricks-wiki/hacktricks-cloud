# AWS - ECS Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## ECS

Aby uzyskać więcej informacji, sprawdź:

{{#ref}}
../aws-services/aws-ecs-enum.md
{{#endref}}

### Role IAM hosta

W ECS **rola IAM może być przypisana do zadania** działającego w kontenerze. **Jeśli** zadanie jest uruchamiane w **instancji EC2**, **instancja EC2** będzie miała **inną rolę IAM** przypisaną do niej.\
Co oznacza, że jeśli uda ci się **skomprymować** instancję ECS, możesz potencjalnie **uzyskać rolę IAM przypisaną do ECR i do instancji EC2**. Aby uzyskać więcej informacji na temat tego, jak zdobyć te poświadczenia, sprawdź:

{{#ref}}
https://book.hacktricks.wiki/en/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf.html
{{#endref}}

> [!CAUTION]
> Zauważ, że jeśli instancja EC2 wymusza IMDSv2, [**zgodnie z dokumentacją**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html), **odpowiedź na żądanie PUT** będzie miała **limit skoków równy 1**, co uniemożliwia dostęp do metadanych EC2 z kontenera wewnątrz instancji EC2.

### Privesc do węzła w celu kradzieży poświadczeń i sekretów innych kontenerów

Co więcej, EC2 używa dockera do uruchamiania zadań EC, więc jeśli możesz uciec do węzła lub **uzyskać dostęp do gniazda dockera**, możesz **sprawdzić**, które **inne kontenery** są uruchamiane, a nawet **dostać się do nich** i **ukraść ich przypisane role IAM**.

#### Uruchamianie kontenerów na bieżącym hoście

Ponadto, **rola instancji EC2** zazwyczaj będzie miała wystarczające **uprawnienia** do **aktualizacji stanu instancji kontenera** instancji EC2 używanych jako węzły w klastrze. Atakujący mógłby zmodyfikować **stan instancji na DRAINING**, wtedy ECS **usunie wszystkie zadania z niej**, a te uruchamiane jako **REPLICA** będą **uruchamiane w innej instancji,** potencjalnie wewnątrz **instancji atakującego**, aby mógł **ukraść ich role IAM** i potencjalnie wrażliwe informacje z wnętrza kontenera.
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
Ta sama technika może być zastosowana poprzez **wyrejestrowanie instancji EC2 z klastra**. To może być potencjalnie mniej dyskretne, ale **wymusi uruchomienie zadań na innych instancjach:**
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
Ostatnią techniką wymuszania ponownego wykonania zadań jest wskazanie ECS, że **zadanie lub kontener został zatrzymany**. Istnieją 3 potencjalne API, aby to zrobić:
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### Kradnij wrażliwe informacje z kontenerów ECR

Instancja EC2 prawdopodobnie będzie miała również uprawnienie `ecr:GetAuthorizationToken`, co pozwala na **pobieranie obrazów** (możesz szukać w nich wrażliwych informacji).

{{#include ../../../banners/hacktricks-training.md}}
