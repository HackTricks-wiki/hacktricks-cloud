# AWS - ECS 后期利用

{{#include ../../../banners/hacktricks-training.md}}

## ECS

有关更多信息，请查看：

{{#ref}}
../aws-services/aws-ecs-enum.md
{{#endref}}

### 主机 IAM 角色

在 ECS 中，**IAM 角色可以分配给在容器内运行的任务**。**如果**任务在 **EC2** 实例内运行，**EC2 实例**将附加 **另一个 IAM** 角色。\
这意味着如果你成功 **攻陷** 一个 ECS 实例，你可能会 **获得与 ECR 和 EC2 实例相关联的 IAM 角色**。有关如何获取这些凭据的更多信息，请查看：

{{#ref}}
https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf
{{#endref}}

> [!CAUTION]
> 请注意，如果 EC2 实例强制使用 IMDSv2， [**根据文档**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html)，**PUT 请求的响应**将具有 **跳数限制为 1**，使得无法从 EC2 实例内的容器访问 EC2 元数据。

### 提权到节点以窃取其他容器的凭据和秘密

此外，EC2 使用 docker 来运行 ECs 任务，因此如果你能够逃逸到节点或 **访问 docker 套接字**，你可以 **检查** 哪些 **其他容器** 正在运行，甚至可以 **进入它们** 并 **窃取** 附加的 IAM 角色。

#### 使容器在当前主机上运行

此外，**EC2 实例角色**通常会拥有足够的 **权限** 来 **更新集群内作为节点使用的 EC2 实例的容器实例状态**。攻击者可以将 **实例的状态修改为 DRAINING**，然后 ECS 将 **从中移除所有任务**，而作为 **REPLICA** 运行的任务将 **在不同的实例中运行，** 可能在 **攻击者的实例** 内，这样他就可以 **窃取它们的 IAM 角色** 和潜在的敏感信息。
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
相同的技术可以通过 **从集群中注销 EC2 实例** 来实现。这可能不那么隐蔽，但它将 **强制任务在其他实例中运行：**
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
一种强制重新执行任务的最终技术是通过指示ECS **任务或容器已停止**。有3个潜在的API可以做到这一点：
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### 从ECR容器中窃取敏感信息

EC2实例可能还具有权限`ecr:GetAuthorizationToken`，允许它**下载镜像**（您可以在其中搜索敏感信息）。

{{#include ../../../banners/hacktricks-training.md}}
