# GWS - Persistence

{{#include ../../banners/hacktricks-training.md}}

> [!CAUTION]
> Усі дії, згадані в цьому розділі, які змінюють налаштування, генеруватимуть **сповіщення про безпеку на електронну пошту та навіть push-сповіщення на будь-який мобільний пристрій, синхронізований** з обліковим записом.

## **Постійність у Gmail**

- Ви можете створити **фільтри для приховування** сповіщень про безпеку від Google
- `from: (no-reply@accounts.google.com) "Security Alert"`
- Це запобігатиме надходженню електронних листів про безпеку на електронну пошту (але не запобігатиме push-сповіщенням на мобільний телефон)

<details>

<summary>Кроки для створення фільтра в gmail</summary>

(Інструкції з [**тут**](https://support.google.com/mail/answer/6579))

1. Відкрийте [Gmail](https://mail.google.com/).
2. У полі пошуку вгорі натисніть Показати параметри пошуку ![photos tune](https://lh3.googleusercontent.com/cD6YR_YvqXqNKxrWn2NAWkV6tjJtg8vfvqijKT1_9zVCrl2sAx9jROKhLqiHo2ZDYTE=w36).
3. Введіть свої критерії пошуку. Якщо ви хочете перевірити, чи правильно спрацював ваш пошук, подивіться, які електронні листи з'являються, натиснувши **Пошук**.
4. У нижній частині вікна пошуку натисніть **Створити фільтр**.
5. Виберіть, що ви хочете, щоб фільтр робив.
6. Натисніть **Створити фільтр**.

Перевірте свій поточний фільтр (щоб видалити їх) на [https://mail.google.com/mail/u/0/#settings/filters](https://mail.google.com/mail/u/0/#settings/filters)

</details>

<figure><img src="../../images/image (331).png" alt=""><figcaption></figcaption></figure>

- Створіть **адресу пересилання для пересилання чутливої інформації** (або всього) - Вам потрібен ручний доступ.
- Створіть адресу пересилання на [https://mail.google.com/mail/u/2/#settings/fwdandpop](https://mail.google.com/mail/u/2/#settings/fwdandpop)
- Адреса отримувача повинна підтвердити це
- Потім налаштуйте пересилання всіх електронних листів, зберігаючи копію (не забудьте натиснути зберегти зміни):

<figure><img src="../../images/image (332).png" alt=""><figcaption></figcaption></figure>

Також можливо створити фільтри та пересилати лише певні електронні листи на іншу електронну адресу.

## Паролі додатків

Якщо вам вдалося **зламати сесію користувача Google** і у користувача була **2FA**, ви можете **згенерувати** [**пароль додатка**](https://support.google.com/accounts/answer/185833?hl=en) (перейдіть за посиланням, щоб побачити кроки). Зверніть увагу, що **Паролі додатків більше не рекомендуються Google і скасовуються**, коли користувач **змінює пароль свого облікового запису Google.**

**Навіть якщо у вас відкрита сесія, вам потрібно знати пароль користувача, щоб створити пароль додатка.**

> [!NOTE]
> Паролі додатків можуть **використовуватися лише з обліковими записами, у яких увімкнено 2-етапну перевірку**.

## Зміна 2-FA та подібне

Також можливо **вимкнути 2-FA або зареєструвати новий пристрій** (або номер телефону) на цій сторінці [**https://myaccount.google.com/security**](https://myaccount.google.com/security)**.**\
**Також можливо згенерувати ключі доступу (додати свій пристрій), змінити пароль, додати мобільні номери для телефонів перевірки та відновлення, змінити електронну пошту для відновлення та змінити запитання безпеки).**

> [!CAUTION]
> Щоб **запобігти сповіщенням про безпеку** на телефон користувача, ви можете **вийти з його смартфона** (хоча це буде дивно), оскільки ви не можете знову увійти з цього місця.
>
> Також можливо **знайти пристрій.**

**Навіть якщо у вас відкрита сесія, вам потрібно знати пароль користувача, щоб змінити ці налаштування.**

## Постійність через OAuth Apps

Якщо ви **зламали обліковий запис користувача**, ви можете просто **прийняти** надати всі можливі дозволи **OAuth App**. Єдина проблема в тому, що Workspace може бути налаштований на **заборону не перевірених зовнішніх та/або внутрішніх OAuth додатків.**\
Досить поширено, що організації Workspace за замовчуванням не довіряють зовнішнім OAuth додаткам, але довіряють внутрішнім, тому, якщо у вас є **достатні дозволи для створення нового OAuth додатку** всередині організації, а зовнішні додатки заборонені, створіть його та **використовуйте цей новий внутрішній OAuth додаток для підтримки постійності**.

Перевірте наступну сторінку для отримання додаткової інформації про OAuth Apps:

{{#ref}}
gws-google-platforms-phishing/
{{#endref}}

## Постійність через делегування

Ви можете просто **делегувати обліковий запис** на інший обліковий запис, контрольований зловмисником (якщо вам дозволено це зробити). У Workspace **Організаціях** ця опція повинна бути **увімкнена**. Вона може бути вимкнена для всіх, увімкнена для деяких користувачів/груп або для всіх (зазвичай вона увімкнена лише для деяких користувачів/груп або повністю вимкнена).

<details>

<summary>Якщо ви адміністратор Workspace, перевірте це, щоб увімкнути функцію</summary>

(Інформація [скопійована з документації](https://support.google.com/a/answer/7223765))

Як адміністратор вашої організації (наприклад, вашої роботи або школи), ви контролюєте, чи можуть користувачі делегувати доступ до свого облікового запису Gmail. Ви можете дозволити всім мати можливість делегувати свій обліковий запис. Або лише дозволити людям з певних відділів налаштувати делегування. Наприклад, ви можете:

- Додати адміністративного асистента як делегата на свій обліковий запис Gmail, щоб вони могли читати та надсилати електронні листи від вашого імені.
- Додати групу, таку як ваш відділ продажів, у Групи як делегата, щоб надати всім доступ до одного облікового запису Gmail.

Користувачі можуть делегувати доступ лише іншому користувачу в тій же організації, незалежно від їх домену чи організаційної одиниці.

#### Обмеження та обмеження делегування

- **Дозволити користувачам надавати доступ до своєї поштової скриньки Google групі**: Щоб використовувати цю опцію, вона повинна бути увімкнена для ОУ делегованого облікового запису та для кожного члена групи ОУ. Члени групи, які належать до ОУ без увімкненої цієї опції, не можуть отримати доступ до делегованого облікового запису.
- При звичайному використанні 40 делегованих користувачів можуть отримати доступ до облікового запису Gmail одночасно. Вище середнього використання одним або кількома делегатами може зменшити цю кількість.
- Автоматизовані процеси, які часто отримують доступ до Gmail, також можуть зменшити кількість делегатів, які можуть отримати доступ до облікового запису одночасно. Ці процеси включають API або розширення браузера, які часто отримують доступ до Gmail.
- Один обліковий запис Gmail підтримує до 1,000 унікальних делегатів. Група в Групах вважається одним делегатом у межах ліміту.
- Делегування не збільшує ліміти для облікового запису Gmail. Облікові записи Gmail з делегованими користувачами мають стандартні ліміти та політики облікового запису Gmail. Для отримання додаткової інформації відвідайте [Ліміти та політики Gmail](https://support.google.com/a/topic/28609).

#### Крок 1: Увімкніть делегування Gmail для своїх користувачів

**Перед початком:** Щоб застосувати налаштування для певних користувачів, помістіть їхні облікові записи в [організаційну одиницю](https://support.google.com/a/topic/1227584).

1.  [Увійдіть](https://admin.google.com/) у свою [консоль адміністратора Google](https://support.google.com/a/answer/182076).

Увійдіть, використовуючи _обліковий запис адміністратора_, а не свій поточний обліковий запис CarlosPolop@gmail.com

2.  У консолі адміністратора перейдіть до Меню ![](https://storage.googleapis.com/support-kms-prod/JxKYG9DqcsormHflJJ8Z8bHuyVI5YheC0lAp)![і потім](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)![](https://storage.googleapis.com/support-kms-prod/ocGtUSENh4QebLpvZcmLcNRZyaTBcolMRSyl) **Додатки**![і потім](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Google Workspace**![і потім](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Gmail**![і потім](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Налаштування користувача**.
3.  Щоб застосувати налаштування для всіх, залиште вибраною верхню організаційну одиницю. В іншому випадку виберіть дочірню [організаційну одиницю](https://support.google.com/a/topic/1227584).
4.  Натисніть **Делегування пошти**.
5.  Поставте галочку в полі **Дозволити користувачам делегувати доступ до своїх поштових скриньок іншим користувачам у домені**.
6.  (Необов'язково) Щоб дозволити користувачам вказати, яка інформація про відправника включена в делеговані повідомлення, поставте галочку в полі **Дозволити користувачам налаштувати це налаштування**.
7.  Виберіть опцію для інформації про відправника за замовчуванням, яка включена в повідомлення, надіслані делегатами:
- **Показати власника облікового запису та делегата, який надіслав електронний лист**—Повідомлення містять адреси електронної пошти власника облікового запису Gmail та делегата.
- **Показати лише власника облікового запису**—Повідомлення містять адресу електронної пошти лише власника облікового запису Gmail. Адреса електронної пошти делегата не включена.
8.  (Необов'язково) Щоб дозволити користувачам додати групу в Групи як делегата, поставте галочку в полі **Дозволити користувачам надавати доступ до своєї поштової скриньки Google групі**.
9.  Натисніть **Зберегти**. Якщо ви налаштували дочірню організаційну одиницю, ви можете **успадкувати** або **перезаписати** налаштування батьківської організаційної одиниці.
10. (Необов'язково) Щоб увімкнути делегування Gmail для інших організаційних одиниць, повторіть кроки 3–9.

Зміни можуть зайняти до 24 годин, але зазвичай відбуваються швидше. [Дізнайтеся більше](https://support.google.com/a/answer/7514107)

#### Крок 2: Нехай користувачі налаштують делегатів для своїх облікових записів

Після того, як ви увімкнете делегування, ваші користувачі переходять до налаштувань Gmail, щоб призначити делегатів. Делегати можуть читати, надсилати та отримувати повідомлення від імені користувача.

Для отримання додаткової інформації направте користувачів до [Делегування та співпраця в електронній пошті](https://support.google.com/a/users/answer/138350).

</details>

<details>

<summary>Як звичайний користувач, перевірте тут інструкції, щоб спробувати делегувати свій доступ</summary>

(Інформація скопійована [**з документації**](https://support.google.com/mail/answer/138350))

Ви можете додати до 10 делегатів.

Якщо ви використовуєте Gmail через свою роботу, школу або іншу організацію:

- Ви можете додати до 1000 делегатів у межах вашої організації.
- При звичайному використанні 40 делегатів можуть отримати доступ до облікового запису Gmail одночасно.
- Якщо ви використовуєте автоматизовані процеси, такі як API або розширення браузера, кілька делегатів можуть отримати доступ до облікового запису Gmail одночасно.

1. На своєму комп'ютері відкрийте [Gmail](https://mail.google.com/). Ви не можете додати делегатів з програми Gmail.
2. У правому верхньому куті натисніть Налаштування ![Settings](https://lh3.googleusercontent.com/p3J-ZSPOLtuBBR_ofWTFDfdgAYQgi8mR5c76ie8XQ2wjegk7-yyU5zdRVHKybQgUlQ=w36-h36) ![і потім](https://lh3.googleusercontent.com/3_l97rr0GvhSP2XV5OoCkV2ZDTIisAOczrSdzNCBxhIKWrjXjHucxNwocghoUa39gw=w36-h36) **Переглянути всі налаштування**.
3. Натисніть вкладку **Облікові записи та імпорт** або **Облікові записи**.
4. У розділі "Надати доступ до свого облікового запису" натисніть **Додати інший обліковий запис**. Якщо ви використовуєте Gmail через свою роботу або школу, ваша організація може обмежити делегування електронної пошти. Якщо ви не бачите цього налаштування, зв'яжіться зі своїм адміністратором.
- Якщо ви не бачите "Надати доступ до свого облікового запису", то це обмежено.
5. Введіть адресу електронної пошти особи, яку ви хочете додати. Якщо ви використовуєте Gmail через свою роботу, школу або іншу організацію, і ваш адміністратор це дозволяє, ви можете ввести адресу електронної пошти групи. Ця група повинна мати той же домен, що й ваша організація. Зовнішнім членам групи відмовлено в доступі до делегування.\
\
**Важливо:** Якщо обліковий запис, який ви делегуєте, є новим обліковим записом або пароль був скинутий, адміністратор повинен вимкнути вимогу змінити пароль, коли ви вперше входите.

- [Дізнайтеся, як адміністратор може створити користувача](https://support.google.com/a/answer/33310).
- [Дізнайтеся, як адміністратор може скинути паролі](https://support.google.com/a/answer/33319).

6\. Натисніть **Наступний крок** ![і потім](https://lh3.googleusercontent.com/QbWcYKta5vh_4-OgUeFmK-JOB0YgLLoGh69P478nE6mKdfpWQniiBabjF7FVoCVXI0g=h36) **Надіслати електронний лист для надання доступу**.

Людина, яку ви додали, отримає електронний лист з проханням підтвердити. Запрошення закінчується через тиждень.

Якщо ви додали групу, усі члени групи стануть делегатами без необхідності підтвердження.

Примітка: Може знадобитися до 24 годин, щоб делегування почало діяти.

</details>

## Постійність через Android App

Якщо у вас є **сесія в обліковому записі Google жертви**, ви можете перейти до **Play Store** і, можливо, зможете **встановити шкідливе ПЗ**, яке ви вже завантажили в магазин, безпосередньо **на телефон**, щоб підтримувати постійність і отримати доступ до телефону жертви.

## **Постійність через** App Scripts

Ви можете створити **тригери на основі часу** в App Scripts, тому, якщо App Script буде прийнято користувачем, він буде **активовано** навіть **без доступу користувача**. Для отримання додаткової інформації про те, як це зробити, перевірте:

{{#ref}}
gws-google-platforms-phishing/gws-app-scripts.md
{{#endref}}

## Посилання

- [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Метью Брайант - Злам G Suite: Сила темної магії Apps Script
- [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Майк Фелч і Боу Буллок - ОК Google, як мені провести Red Team GSuite?

{{#include ../../banners/hacktricks-training.md}}
