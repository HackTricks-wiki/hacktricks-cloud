# GWS - Persistence

{{#include ../../banners/hacktricks-training.md}}

> [!CAUTION]
> Wszystkie działania wymienione w tej sekcji, które zmieniają ustawienia, wygenerują **powiadomienie o bezpieczeństwie na e-mail oraz powiadomienie push na każdym urządzeniu mobilnym zsynchronizowanym** z kontem.

## **Utrzymywanie dostępu w Gmailu**

- Możesz stworzyć **filtry, aby ukryć** powiadomienia o bezpieczeństwie od Google
- `from: (no-reply@accounts.google.com) "Security Alert"`
- To zapobiegnie dotarciu e-maili o bezpieczeństwie do skrzynki (ale nie zapobiegnie powiadomieniom push na telefonie)

<details>

<summary>Kroki do stworzenia filtru w Gmailu</summary>

(Instrukcje [**tutaj**](https://support.google.com/mail/answer/6579))

1. Otwórz [Gmail](https://mail.google.com/).
2. W polu wyszukiwania na górze kliknij Pokaż opcje wyszukiwania ![photos tune](https://lh3.googleusercontent.com/cD6YR_YvqXqNKxrWn2NAWkV6tjJtg8vfvqijKT1_9zVCrl2sAx9jROKhLqiHo2ZDYTE=w36).
3. Wprowadź kryteria wyszukiwania. Jeśli chcesz sprawdzić, czy wyszukiwanie działa poprawnie, zobacz, jakie e-maile się pojawią, klikając **Szukaj**.
4. Na dole okna wyszukiwania kliknij **Utwórz filtr**.
5. Wybierz, co chciałbyś, aby filtr robił.
6. Kliknij **Utwórz filtr**.

Sprawdź swoje aktualne filtry (aby je usunąć) w [https://mail.google.com/mail/u/0/#settings/filters](https://mail.google.com/mail/u/0/#settings/filters)

</details>

<figure><img src="../../images/image (331).png" alt=""><figcaption></figcaption></figure>

- Stwórz **adres przekazywania, aby przekazywać wrażliwe informacje** (lub wszystko) - Potrzebujesz dostępu manualnego.
- Stwórz adres przekazywania w [https://mail.google.com/mail/u/2/#settings/fwdandpop](https://mail.google.com/mail/u/2/#settings/fwdandpop)
- Odbierający adres będzie musiał to potwierdzić
- Następnie ustaw, aby przekazywać wszystkie e-maile, zachowując kopię (pamiętaj, aby kliknąć zapisz zmiany):

<figure><img src="../../images/image (332).png" alt=""><figcaption></figcaption></figure>

Możliwe jest również stworzenie filtrów i przekazywanie tylko konkretnych e-maili na inny adres e-mail.

## Hasła aplikacji

Jeśli udało ci się **przejąć sesję użytkownika Google** i użytkownik miał **2FA**, możesz **wygenerować** [**hasło aplikacji**](https://support.google.com/accounts/answer/185833?hl=en) (postępuj zgodnie z linkiem, aby zobaczyć kroki). Zauważ, że **Hasła aplikacji nie są już zalecane przez Google i są cofane**, gdy użytkownik **zmienia hasło do swojego konta Google.**

**Nawet jeśli masz otwartą sesję, będziesz musiał znać hasło użytkownika, aby utworzyć hasło aplikacji.**

> [!NOTE]
> Hasła aplikacji mogą **być używane tylko z kontami, które mają włączoną Weryfikację dwuetapową**.

## Zmiana 2-FA i podobne

Możliwe jest również **wyłączenie 2-FA lub zarejestrowanie nowego urządzenia** (lub numeru telefonu) na tej stronie [**https://myaccount.google.com/security**](https://myaccount.google.com/security)**.**\
**Możliwe jest również wygenerowanie kluczy dostępu (dodanie własnego urządzenia), zmiana hasła, dodanie numerów telefonów do weryfikacji i odzyskiwania, zmiana e-maila do odzyskiwania oraz zmiana pytań zabezpieczających).**

> [!CAUTION]
> Aby **zapobiec powiadomieniom push o bezpieczeństwie** dotarciu do telefonu użytkownika, możesz **wylogować jego smartfona** (chociaż byłoby to dziwne), ponieważ nie możesz ponownie zalogować go stąd.
>
> Możliwe jest również **zlokalizowanie urządzenia.**

**Nawet jeśli masz otwartą sesję, będziesz musiał znać hasło użytkownika, aby zmienić te ustawienia.**

## Utrzymywanie dostępu za pomocą aplikacji OAuth

Jeśli **przejąłeś konto użytkownika**, możesz po prostu **zaakceptować** przyznanie wszystkich możliwych uprawnień aplikacji **OAuth**. Jedynym problemem jest to, że Workspace może być skonfigurowany tak, aby **zabraniać nieprzeglądanych zewnętrznych i/lub wewnętrznych aplikacji OAuth.**\
Jest dość powszechne, że organizacje Workspace domyślnie nie ufają zewnętrznym aplikacjom OAuth, ale ufają wewnętrznym, więc jeśli masz **wystarczające uprawnienia, aby wygenerować nową aplikację OAuth** w organizacji, a zewnętrzne aplikacje są zabronione, wygeneruj ją i **użyj tej nowej wewnętrznej aplikacji OAuth, aby utrzymać dostęp**.

Sprawdź następującą stronę, aby uzyskać więcej informacji na temat aplikacji OAuth:

{{#ref}}
gws-google-platforms-phishing/
{{#endref}}

## Utrzymywanie dostępu poprzez delegację

Możesz po prostu **delegować konto** do innego konta kontrolowanego przez atakującego (jeśli masz na to pozwolenie). W organizacjach **Workspace** ta opcja musi być **włączona**. Może być wyłączona dla wszystkich, włączona dla niektórych użytkowników/grup lub dla wszystkich (zwykle jest włączona tylko dla niektórych użytkowników/grup lub całkowicie wyłączona).

<details>

<summary>Jeśli jesteś administratorem Workspace, sprawdź to, aby włączyć funkcję</summary>

(Informacje [skopiowane z dokumentacji](https://support.google.com/a/answer/7223765))

Jako administrator swojej organizacji (na przykład w pracy lub szkole) kontrolujesz, czy użytkownicy mogą delegować dostęp do swojego konta Gmail. Możesz pozwolić wszystkim na opcję delegowania swojego konta. Lub tylko pozwolić osobom w niektórych działach na ustawienie delegacji. Na przykład możesz:

- Dodać asystenta administracyjnego jako delegata na swoim koncie Gmail, aby mógł czytać i wysyłać e-maile w twoim imieniu.
- Dodać grupę, taką jak twój dział sprzedaży, w Grupach jako delegata, aby dać wszystkim dostęp do jednego konta Gmail.

Użytkownicy mogą delegować dostęp tylko do innego użytkownika w tej samej organizacji, niezależnie od ich domeny lub jednostki organizacyjnej.

#### Limity i ograniczenia delegacji

- **Zezwól użytkownikom na przyznanie dostępu do swojej skrzynki pocztowej grupie Google**: Aby użyć tej opcji, musi być włączona dla OU delegowanego konta i dla każdego członka grupy OU. Członkowie grupy, którzy należą do OU bez tej opcji włączonej, nie mogą uzyskać dostępu do delegowanego konta.
- Przy typowym użyciu 40 delegowanych użytkowników może uzyskać dostęp do konta Gmail w tym samym czasie. Powyższe średnie użycie przez jednego lub więcej delegatów może zmniejszyć tę liczbę.
- Zautomatyzowane procesy, które często uzyskują dostęp do Gmaila, mogą również zmniejszyć liczbę delegatów, którzy mogą uzyskać dostęp do konta w tym samym czasie. Procesy te obejmują API lub rozszerzenia przeglądarki, które często uzyskują dostęp do Gmaila.
- Jedno konto Gmail obsługuje do 1 000 unikalnych delegatów. Grupa w Grupach liczy się jako jeden delegat w kierunku limitu.
- Delegacja nie zwiększa limitów dla konta Gmail. Konta Gmail z delegowanymi użytkownikami mają standardowe limity i zasady konta Gmail. Aby uzyskać szczegóły, odwiedź [Limity i zasady Gmaila](https://support.google.com/a/topic/28609).

#### Krok 1: Włącz delegację Gmaila dla swoich użytkowników

**Zanim zaczniesz:** Aby zastosować ustawienie dla niektórych użytkowników, umieść ich konta w [jednostce organizacyjnej](https://support.google.com/a/topic/1227584).

1.  [Zaloguj się](https://admin.google.com/) do swojego [konsoli administracyjnej Google](https://support.google.com/a/answer/182076).

Zaloguj się używając _konta administratora_, a nie swojego aktualnego konta CarlosPolop@gmail.com

2.  W konsoli administracyjnej przejdź do Menu ![](https://storage.googleapis.com/support-kms-prod/JxKYG9DqcsormHflJJ8Z8bHuyVI5YheC0lAp)![a następnie](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)![](https://storage.googleapis.com/support-kms-prod/ocGtUSENh4QebLpvZcmLcNRZyaTBcolMRSyl) **Aplikacje**![a następnie](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Google Workspace**![a następnie](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Gmail**![a następnie](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Ustawienia użytkownika**.
3.  Aby zastosować ustawienie dla wszystkich, pozostaw wybraną jednostkę organizacyjną na górze. W przeciwnym razie wybierz podrzędną [jednostkę organizacyjną](https://support.google.com/a/topic/1227584).
4.  Kliknij **Delegacja poczty**.
5.  Zaznacz pole **Zezwól użytkownikom na delegowanie dostępu do swojej skrzynki pocztowej innym użytkownikom w domenie**.
6.  (Opcjonalnie) Aby pozwolić użytkownikom określić, jakie informacje o nadawcy są zawarte w delegowanych wiadomościach wysyłanych z ich konta, zaznacz pole **Zezwól użytkownikom na dostosowanie tego ustawienia**.
7.  Wybierz opcję dla domyślnych informacji o nadawcy, które są zawarte w wiadomościach wysyłanych przez delegatów:
- **Pokaż właściciela konta i delegata, który wysłał e-mail**—Wiadomości zawierają adresy e-mail właściciela konta Gmail i delegata.
- **Pokaż tylko właściciela konta**—Wiadomości zawierają adres e-mail tylko właściciela konta Gmail. Adres e-mail delegata nie jest zawarty.
8.  (Opcjonalnie) Aby pozwolić użytkownikom dodać grupę w Grupach jako delegata, zaznacz pole **Zezwól użytkownikom na przyznanie dostępu do swojej skrzynki pocztowej grupie Google**.
9.  Kliknij **Zapisz**. Jeśli skonfigurowałeś podrzędną jednostkę organizacyjną, możesz być w stanie **Dziedziczyć** lub **Nadpisać** ustawienia jednostki organizacyjnej nadrzędnej.
10. (Opcjonalnie) Aby włączyć delegację Gmaila dla innych jednostek organizacyjnych, powtórz kroki 3–9.

Zmiany mogą zająć do 24 godzin, ale zazwyczaj zachodzą szybciej. [Dowiedz się więcej](https://support.google.com/a/answer/7514107)

#### Krok 2: Niech użytkownicy skonfigurują delegatów dla swoich kont

Po włączeniu delegacji użytkownicy przechodzą do ustawień Gmaila, aby przypisać delegatów. Delegaci mogą następnie czytać, wysyłać i odbierać wiadomości w imieniu użytkownika.

Aby uzyskać szczegóły, skieruj użytkowników do [Delegowanie i współpraca w e-mailu](https://support.google.com/a/users/answer/138350).

</details>

<details>

<summary>Jako zwykły użytkownik, sprawdź tutaj instrukcje, aby spróbować delegować swój dostęp</summary>

(Informacje skopiowane [**z dokumentacji**](https://support.google.com/mail/answer/138350))

Możesz dodać do 10 delegatów.

Jeśli korzystasz z Gmaila przez swoją pracę, szkołę lub inną organizację:

- Możesz dodać do 1000 delegatów w swojej organizacji.
- Przy typowym użyciu 40 delegatów może uzyskać dostęp do konta Gmail w tym samym czasie.
- Jeśli korzystasz z zautomatyzowanych procesów, takich jak API lub rozszerzenia przeglądarki, kilku delegatów może uzyskać dostęp do konta Gmail w tym samym czasie.

1. Na swoim komputerze otwórz [Gmail](https://mail.google.com/). Nie możesz dodać delegatów z aplikacji Gmail.
2. W prawym górnym rogu kliknij Ustawienia ![Settings](https://lh3.googleusercontent.com/p3J-ZSPOLtuBBR_ofWTFDfdgAYQgi8mR5c76ie8XQ2wjegk7-yyU5zdRVHKybQgUlQ=w36-h36) ![a następnie](https://lh3.googleusercontent.com/3_l97rr0GvhSP2XV5OoCkV2ZDTIisAOczrSdzNCBxhIKWrjXjHucxNwocghoUa39gw=w36-h36) **Zobacz wszystkie ustawienia**.
3. Kliknij zakładkę **Konta i import** lub **Konta**.
4. W sekcji "Przyznaj dostęp do swojego konta" kliknij **Dodaj inne konto**. Jeśli korzystasz z Gmaila przez swoją pracę lub szkołę, twoja organizacja może ograniczyć delegację e-maili. Jeśli nie widzisz tego ustawienia, skontaktuj się z administratorem.
- Jeśli nie widzisz Przyznaj dostęp do swojego konta, to jest to ograniczone.
5. Wprowadź adres e-mail osoby, którą chcesz dodać. Jeśli korzystasz z Gmaila przez swoją pracę, szkołę lub inną organizację, a twój administrator na to pozwala, możesz wprowadzić adres e-mail grupy. Ta grupa musi mieć tę samą domenę co twoja organizacja. Zewnętrzni członkowie grupy nie mają dostępu do delegacji.\
\
**Ważne:** Jeśli konto, które delegujesz, jest nowym kontem lub hasło zostało zresetowane, administrator musi wyłączyć wymóg zmiany hasła przy pierwszym logowaniu.

- [Dowiedz się, jak administrator może utworzyć użytkownika](https://support.google.com/a/answer/33310).
- [Dowiedz się, jak administrator może zresetować hasła](https://support.google.com/a/answer/33319).

6. Kliknij **Następny krok** ![a następnie](https://lh3.googleusercontent.com/QbWcYKta5vh_4-OgUeFmK-JOB0YgLLoGh69P478nE6mKdfpWQniiBabjF7FVoCVXI0g=h36) **Wyślij e-mail, aby przyznać dostęp**.

Osoba, którą dodałeś, otrzyma e-mail z prośbą o potwierdzenie. Zaproszenie wygasa po tygodniu.

Jeśli dodałeś grupę, wszyscy członkowie grupy staną się delegatami bez konieczności potwierdzania.

Uwaga: Może zająć do 24 godzin, aby delegacja zaczęła obowiązywać.

</details>

## Utrzymywanie dostępu za pomocą aplikacji Android

Jeśli masz **sesję w koncie Google ofiary**, możesz przeglądać **Sklep Play** i być może będziesz w stanie **zainstalować złośliwe oprogramowanie**, które już przesłałeś do sklepu bezpośrednio **na telefonie**, aby utrzymać dostęp i uzyskać dostęp do telefonu ofiary.

## **Utrzymywanie dostępu za pomocą** Skryptów Aplikacji

Możesz stworzyć **wyzwalacze oparte na czasie** w Skryptach Aplikacji, więc jeśli Skrypt Aplikacji zostanie zaakceptowany przez użytkownika, zostanie **wyzwolony** nawet **bez dostępu użytkownika**. Aby uzyskać więcej informacji na ten temat, sprawdź:

{{#ref}}
gws-google-platforms-phishing/gws-app-scripts.md
{{#endref}}

## Referencje

- [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
- [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch i Beau Bullock - OK Google, Jak mogę przeprowadzić Red Team GSuite?

{{#include ../../banners/hacktricks-training.md}}
