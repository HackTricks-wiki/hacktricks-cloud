# GWS - 持久性

{{#include ../../banners/hacktricks-training.md}}

> [!CAUTION]
> 本节中提到的所有更改设置的操作将生成**安全警报到电子邮件，并且还会推送通知到与账户同步的任何手机**。

## **Gmail中的持久性**

- 您可以创建**过滤器以隐藏**来自Google的安全通知
- `from: (no-reply@accounts.google.com) "Security Alert"`
- 这将防止安全电子邮件到达邮箱（但不会阻止推送通知到手机）

<details>

<summary>创建gmail过滤器的步骤</summary>

（来自[**这里**](https://support.google.com/mail/answer/6579)的说明）

1. 打开[Gmail](https://mail.google.com/)。
2. 在顶部的搜索框中，点击显示搜索选项 ![photos tune](https://lh3.googleusercontent.com/cD6YR_YvqXqNKxrWn2NAWkV6tjJtg8vfvqijKT1_9zVCrl2sAx9jROKhLqiHo2ZDYTE=w36) 。
3. 输入您的搜索条件。如果您想检查搜索是否正确，请点击**搜索**查看显示的电子邮件。
4. 在搜索窗口的底部，点击**创建过滤器**。
5. 选择您希望过滤器执行的操作。
6. 点击**创建过滤器**。

在[https://mail.google.com/mail/u/0/#settings/filters](https://mail.google.com/mail/u/0/#settings/filters)检查您当前的过滤器（以删除它们）

</details>

<figure><img src="../../images/image (331).png" alt=""><figcaption></figcaption></figure>

- 创建**转发地址以转发敏感信息**（或所有信息） - 您需要手动访问。
- 在[https://mail.google.com/mail/u/2/#settings/fwdandpop](https://mail.google.com/mail/u/2/#settings/fwdandpop)创建转发地址
- 接收地址需要确认此操作
- 然后，设置转发所有电子邮件，同时保留副本（记得点击保存更改）：

<figure><img src="../../images/image (332).png" alt=""><figcaption></figcaption></figure>

还可以创建过滤器，仅将特定电子邮件转发到其他电子邮件地址。

## 应用密码

如果您成功**入侵了一个Google用户会话**，并且该用户启用了**2FA**，您可以**生成**一个[**应用密码**](https://support.google.com/accounts/answer/185833?hl=en)（请遵循链接查看步骤）。请注意，**Google不再推荐应用密码，并且在用户**更改其Google账户密码时会被撤销。**

**即使您有一个开放的会话，您仍然需要知道用户的密码才能创建应用密码。**

> [!NOTE]
> 应用密码**仅可用于启用2步验证的账户**。

## 更改2-FA和类似操作

您还可以在此页面[**https://myaccount.google.com/security**](https://myaccount.google.com/security)**上**关闭2-FA或注册新设备（或电话号码）。\
**还可以生成密码密钥（添加您自己的设备）、更改密码、添加用于验证的手机号码和恢复、修改恢复电子邮件以及更改安全问题）。**

> [!CAUTION]
> 为了**防止安全推送通知**到达用户的手机，您可以**将他的智能手机注销**（尽管这会很奇怪），因为您无法从这里重新登录。
>
> 还可以**定位设备。**

**即使您有一个开放的会话，您仍然需要知道用户的密码才能更改这些设置。**

## 通过OAuth应用程序实现持久性

如果您**入侵了用户的账户**，您可以直接**接受**授予所有可能的权限给一个**OAuth应用程序**。唯一的问题是Workspace可以配置为**不允许未经审查的外部和/或内部OAuth应用程序。**\
Workspace组织通常默认不信任外部OAuth应用程序，但信任内部应用程序，因此如果您**有足够的权限在组织内部生成新的OAuth应用程序**并且外部应用程序被禁止，请生成它并**使用该新的内部OAuth应用程序来维持持久性**。

有关OAuth应用程序的更多信息，请查看以下页面：

{{#ref}}
gws-google-platforms-phishing/
{{#endref}}

## 通过委派实现持久性

您可以直接**将账户委派**给攻击者控制的不同账户（如果您被允许这样做）。在Workspace **组织**中，此选项必须**启用**。它可以对所有人禁用，或从某些用户/组启用，或对所有人启用（通常仅对某些用户/组启用或完全禁用）。

<details>

<summary>如果您是Workspace管理员，请检查此处以启用该功能</summary>

（信息[复制自文档](https://support.google.com/a/answer/7223765)）

作为您组织的管理员（例如，您的工作或学校），您控制用户是否可以委派访问其Gmail账户。您可以让每个人都有委派其账户的选项。或者，仅允许某些部门的人设置委派。例如，您可以：

- 将行政助理添加为您Gmail账户的委派，以便他们可以代表您阅读和发送电子邮件。
- 将一个组（例如您的销售部门）添加到Groups中作为委派，以便每个人都可以访问一个Gmail账户。

用户只能将访问权限委派给同一组织中的其他用户，无论其域或组织单位如何。

#### 委派限制和限制

- **允许用户将其邮箱访问权限授予Google组**选项：要使用此选项，必须为被委派账户的OU和每个组成员的OU启用此选项。属于没有启用此选项的OU的组成员无法访问被委派账户。
- 在典型使用情况下，40个被委派用户可以同时访问一个Gmail账户。一个或多个被委派用户的超出平均使用可能会减少此数字。
- 经常访问Gmail的自动化过程也可能减少可以同时访问账户的委派数量。这些过程包括频繁访问Gmail的API或浏览器扩展。
- 单个Gmail账户支持最多1,000个唯一委派。Groups中的一个组算作一个委派，计入限制。
- 委派不会增加Gmail账户的限制。具有被委派用户的Gmail账户具有标准的Gmail账户限制和政策。有关详细信息，请访问[Gmail限制和政策](https://support.google.com/a/topic/28609)。

#### 第1步：为您的用户启用Gmail委派

**在开始之前：**要将设置应用于某些用户，请将其账户放入[组织单位](https://support.google.com/a/topic/1227584)。

1. [登录](https://admin.google.com/)到您的[Google管理员控制台](https://support.google.com/a/answer/182076)。

使用_管理员账户_登录，而不是您当前的账户CarlosPolop@gmail.com

2. 在管理员控制台中，转到菜单 ![](https://storage.googleapis.com/support-kms-prod/JxKYG9DqcsormHflJJ8Z8bHuyVI5YheC0lAp)![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)![](https://storage.googleapis.com/support-kms-prod/ocGtUSENh4QebLpvZcmLcNRZyaTBcolMRSyl) **应用**![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Google Workspace**![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Gmail**![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**用户设置**。
3. 要将设置应用于所有人，请保留选定的顶级组织单位。否则，选择一个子[组织单位](https://support.google.com/a/topic/1227584)。
4. 点击**邮件委派**。
5. 勾选**允许用户将其邮箱访问权限委派给域内其他用户**框。
6. （可选）要让用户指定委派消息中包含的发件人信息，请勾选**允许用户自定义此设置**框。
7. 选择一个选项，作为委派发送的消息中包含的默认发件人信息：
- **显示账户所有者和发送电子邮件的委派**—消息包括Gmail账户所有者和委派的电子邮件地址。
- **仅显示账户所有者**—消息仅包括Gmail账户所有者的电子邮件地址。委派的电子邮件地址不包括在内。
8. （可选）要让用户将Groups中的一个组添加为委派，请勾选**允许用户将其邮箱访问权限授予Google组**框。
9. 点击**保存**。如果您配置了子组织单位，您可能能够**继承**或**覆盖**父组织单位的设置。
10. （可选）要为其他组织单位启用Gmail委派，请重复步骤3-9。

更改可能需要最多24小时，但通常会更快发生。[了解更多](https://support.google.com/a/answer/7514107)

#### 第2步：让用户为其账户设置委派

启用委派后，您的用户可以转到其Gmail设置以分配委派。委派可以代表用户阅读、发送和接收消息。

有关详细信息，请引导用户查看[委派和协作电子邮件](https://support.google.com/a/users/answer/138350)。

</details>

<details>

<summary>作为普通用户，请查看此处的说明以尝试委派您的访问权限</summary>

（信息复制[**自文档**](https://support.google.com/mail/answer/138350)）

您最多可以添加10个委派。

如果您通过工作、学校或其他组织使用Gmail：

- 您可以在组织内添加最多1000个委派。
- 在典型使用情况下，40个委派可以同时访问一个Gmail账户。
- 如果您使用自动化过程，例如API或浏览器扩展，少数委派可以同时访问一个Gmail账户。

1. 在您的计算机上，打开[Gmail](https://mail.google.com/)。您无法从Gmail应用程序添加委派。
2. 在右上角，点击设置 ![Settings](https://lh3.googleusercontent.com/p3J-ZSPOLtuBBR_ofWTFDfdgAYQgi8mR5c76ie8XQ2wjegk7-yyU5zdRVHKybQgUlQ=w36-h36) ![然后](https://lh3.googleusercontent.com/3_l97rr0GvhSP2XV5OoCkV2ZDTIisAOczrSdzNCBxhIKWrjXjHucxNwocghoUa39gw=w36-h36) **查看所有设置**。
3. 点击**账户和导入**或**账户**选项卡。
4. 在“授予对您账户的访问权限”部分，点击**添加另一个账户**。如果您通过工作或学校使用Gmail，您的组织可能会限制电子邮件委派。如果您没有看到此设置，请联系您的管理员。
- 如果您没有看到授予对您账户的访问权限，那么它是受限的。
5. 输入您想要添加的人的电子邮件地址。如果您通过工作、学校或其他组织使用Gmail，并且您的管理员允许，您可以输入一个组的电子邮件地址。该组必须与您的组织具有相同的域。组的外部成员被拒绝委派访问。\
\
**重要：**如果您委派的账户是新账户或密码被重置，管理员必须关闭首次登录时更改密码的要求。

- [了解管理员如何创建用户](https://support.google.com/a/answer/33310)。
- [了解管理员如何重置密码](https://support.google.com/a/answer/33319)。

6. 点击**下一步** ![然后](https://lh3.googleusercontent.com/QbWcYKta5vh_4-OgUeFmK-JOB0YgLLoGh69P478nE6mKdfpWQniiBabjF7FVoCVXI0g=h36) **发送电子邮件以授予访问权限**。

您添加的人将收到一封电子邮件，要求他们确认。邀请在一周后过期。

如果您添加了一个组，所有组成员将成为委派，而无需确认。

注意：委派生效可能需要最多24小时。

</details>

## 通过Android应用程序实现持久性

如果您在受害者的Google账户中有一个**会话**，您可以浏览到**Play Store**，并可能能够**直接将您已经上传到商店的恶意软件安装到手机上**以维持持久性并访问受害者的手机。

## **通过**应用脚本实现持久性

您可以在应用脚本中创建**基于时间的触发器**，因此如果应用脚本被用户接受，它将**被触发**，即使**用户没有访问它**。有关如何做到这一点的更多信息，请查看：

{{#ref}}
gws-google-platforms-phishing/gws-app-scripts.md
{{#endref}}

## 参考

- [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
- [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch和Beau Bullock - OK Google, How do I Red Team GSuite?

{{#include ../../banners/hacktricks-training.md}}
