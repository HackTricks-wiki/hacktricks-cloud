# Εκμετάλλευση Cloudflare Workers ως pass-through proxies (IP rotation, FireProx-style)

{{#include ../../banners/hacktricks-training.md}}

Τα Cloudflare Workers μπορούν να αναπτυχθούν ως διαφανείς HTTP pass-through proxies όπου το upstream target URL παρέχεται από τον client. Τα requests εξέρχονται από το δίκτυο της Cloudflare, οπότε ο στόχος βλέπει Cloudflare IPs αντί για εκείνα του client. Αυτό αντικατοπτρίζει την γνωστή τεχνική FireProx στο AWS API Gateway, αλλά χρησιμοποιεί Cloudflare Workers.

### Κύριες δυνατότητες
- Υποστήριξη όλων των HTTP μεθόδων (GET, POST, PUT, DELETE, PATCH, OPTIONS, HEAD)
- Ο στόχος μπορεί να δοθεί μέσω query parameter (?url=...), ενός header (X-Target-URL), ή ακόμα και κωδικοποιημένος στο path (π.χ. /https://target)
- Τα headers και το body προωθούνται μέσω proxy με hop-by-hop/header filtering όπως απαιτείται
- Οι απαντήσεις προωθούνται πίσω, διατηρώντας τον status code και τα περισσότερα headers
- Προαιρετικό spoofing του X-Forwarded-For (εάν ο Worker το θέτει από ένα user-controlled header)
- Εξαιρετικά γρήγορη/εύκολη rotation με την ανάπτυξη πολλαπλών Worker endpoints και την κατανομή των requests

### Πώς λειτουργεί (flow)
1) Ο client στέλνει ένα HTTP request σε ένα Worker URL (`<name>.<account>.workers.dev` ή σε ένα custom domain route).
2) Ο Worker εξάγει τον στόχο είτε από ένα query parameter (?url=...), είτε από το header X-Target-URL, είτε από ένα path segment αν υλοποιηθεί έτσι.
3) Ο Worker προωθεί την εισερχόμενη μέθοδο, τα headers και το body προς το καθορισμένο upstream URL (φιλτράροντας προβληματικά headers).
4) Η upstream απάντηση μεταδίδεται streaming πίσω στον client μέσω Cloudflare· η origin βλέπει Cloudflare egress IPs.

### Worker implementation example
- Διαβάζει το target URL από query param, header ή path
- Αντιγράφει ένα ασφαλές υποσύνολο headers και προωθεί την αρχική μέθοδο/body
- Προαιρετικά θέτει X-Forwarded-For χρησιμοποιώντας ένα user-controlled header (X-My-X-Forwarded-For) ή ένα τυχαίο IP
- Προσθέτει permissive CORS και χειρίζεται preflight

<details>
<summary>Example Worker (JavaScript) for pass-through proxying</summary>
```javascript
/**
* Minimal Worker pass-through proxy
* - Target URL from ?url=, X-Target-URL, or /https://...
* - Proxies method/headers/body to upstream; relays response
*/
addEventListener('fetch', event => {
event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
try {
const url = new URL(request.url)
const targetUrl = getTargetUrl(url, request.headers)

if (!targetUrl) {
return errorJSON('No target URL specified', 400, {
usage: {
query_param: '?url=https://example.com',
header: 'X-Target-URL: https://example.com',
path: '/https://example.com'
}
})
}

let target
try { target = new URL(targetUrl) } catch (e) {
return errorJSON('Invalid target URL', 400, { provided: targetUrl })
}

// Forward original query params except control ones
const passthru = new URLSearchParams()
for (const [k, v] of url.searchParams) {
if (!['url', '_cb', '_t'].includes(k)) passthru.append(k, v)
}
if (passthru.toString()) target.search = passthru.toString()

// Build proxied request
const proxyReq = buildProxyRequest(request, target)
const upstream = await fetch(proxyReq)

return buildProxyResponse(upstream, request.method)
} catch (error) {
return errorJSON('Proxy request failed', 500, {
message: error.message,
timestamp: new Date().toISOString()
})
}
}

function getTargetUrl(url, headers) {
let t = url.searchParams.get('url') || headers.get('X-Target-URL')
if (!t && url.pathname !== '/') {
const p = url.pathname.slice(1)
if (p.startsWith('http')) t = p
}
return t
}

function buildProxyRequest(request, target) {
const h = new Headers()
const allow = [
'accept','accept-language','accept-encoding','authorization',
'cache-control','content-type','origin','referer','user-agent'
]
for (const [k, v] of request.headers) {
if (allow.includes(k.toLowerCase())) h.set(k, v)
}
h.set('Host', target.hostname)

// Optional: spoof X-Forwarded-For if provided
const spoof = request.headers.get('X-My-X-Forwarded-For')
h.set('X-Forwarded-For', spoof || randomIP())

return new Request(target.toString(), {
method: request.method,
headers: h,
body: ['GET','HEAD'].includes(request.method) ? null : request.body
})
}

function buildProxyResponse(resp, method) {
const h = new Headers()
for (const [k, v] of resp.headers) {
if (!['content-encoding','content-length','transfer-encoding'].includes(k.toLowerCase())) {
h.set(k, v)
}
}
// Permissive CORS for tooling convenience
h.set('Access-Control-Allow-Origin', '*')
h.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS, PATCH, HEAD')
h.set('Access-Control-Allow-Headers', '*')

if (method === 'OPTIONS') return new Response(null, { status: 204, headers: h })
return new Response(resp.body, { status: resp.status, statusText: resp.statusText, headers: h })
}

function errorJSON(msg, status=400, extra={}) {
return new Response(JSON.stringify({ error: msg, ...extra }), {
status, headers: { 'Content-Type': 'application/json' }
})
}

function randomIP() { return [1,2,3,4].map(() => Math.floor(Math.random()*255)+1).join('.') }
```
</details>

### Αυτοματισμός ανάπτυξης και εναλλαγής με FlareProx

FlareProx είναι ένα εργαλείο Python που χρησιμοποιεί το Cloudflare API για να αναπτύσσει πολλαπλά Worker endpoints και να κάνει εναλλαγή μεταξύ τους. Αυτό παρέχει εναλλαγή IP τύπου FireProx από το δίκτυο της Cloudflare.

Ρύθμιση
1) Δημιουργήστε ένα Cloudflare API Token χρησιμοποιώντας το πρότυπο “Edit Cloudflare Workers” και λάβετε το Account ID σας από το dashboard.
2) Ρυθμίστε το FlareProx:
```bash
git clone https://github.com/MrTurvey/flareprox
cd flareprox
pip install -r requirements.txt
```
**Δημιουργήστε το αρχείο config flareprox.json:**
```json
{
"cloudflare": {
"api_token": "your_cloudflare_api_token",
"account_id": "your_cloudflare_account_id"
}
}
```
**Χρήση CLI**

- Δημιούργησε N Worker proxies:
```bash
python3 flareprox.py create --count 2
```
- Λίστα endpoints:
```bash
python3 flareprox.py list
```
- Endpoints ελέγχου υγείας:
```bash
python3 flareprox.py test
```
- Διαγράψτε όλα τα endpoints:
```bash
python3 flareprox.py cleanup
```
**Δρομολόγηση της κίνησης μέσω ενός Worker**
- Μορφή παραμέτρου ερωτήματος:
```bash
curl "https://your-worker.account.workers.dev?url=https://httpbin.org/ip"
```
- Φόρμα κεφαλίδας:
```bash
curl -H "X-Target-URL: https://httpbin.org/ip" https://your-worker.account.workers.dev
```
- Μορφή διαδρομής (αν υλοποιηθεί):
```bash
curl https://your-worker.account.workers.dev/https://httpbin.org/ip
```
- Παραδείγματα μεθόδων:
```bash
# GET
curl "https://your-worker.account.workers.dev?url=https://httpbin.org/get"

# POST (form)
curl -X POST -d "username=admin" \
"https://your-worker.account.workers.dev?url=https://httpbin.org/post"

# PUT (JSON)
curl -X PUT -d '{"username":"admin"}' -H "Content-Type: application/json" \
"https://your-worker.account.workers.dev?url=https://httpbin.org/put"

# DELETE
curl -X DELETE \
"https://your-worker.account.workers.dev?url=https://httpbin.org/delete"
```
**`X-Forwarded-For` έλεγχος**

Εάν ο Worker σεβαστεί το `X-My-X-Forwarded-For`, μπορείτε να επηρεάσετε την upstream τιμή του `X-Forwarded-For`:
```bash
curl -H "X-My-X-Forwarded-For: 203.0.113.10" \
"https://your-worker.account.workers.dev?url=https://httpbin.org/headers"
```
**Προγραμματική χρήση**

Χρησιμοποιήστε τη βιβλιοθήκη FlareProx για να δημιουργήσετε, να ανακτήσετε και να δοκιμάσετε endpoints και να δρομολογήσετε requests από Python.

<details>
<summary>Python example: Send a POST via a random Worker endpoint</summary>
```python
#!/usr/bin/env python3
from flareprox import FlareProx, FlareProxError
import json

# Initialize
flareprox = FlareProx(config_file="flareprox.json")
if not flareprox.is_configured:
print("FlareProx not configured. Run: python3 flareprox.py config")
exit(1)

# Ensure endpoints exist
endpoints = flareprox.sync_endpoints()
if not endpoints:
print("Creating proxy endpoints...")
flareprox.create_proxies(count=2)

# Make a POST request through a random endpoint
try:
post_data = json.dumps({
"username": "testuser",
"message": "Hello from FlareProx!",
"timestamp": "2025-01-01T12:00:00Z"
})

headers = {
"Content-Type": "application/json",
"User-Agent": "FlareProx-Client/1.0"
}

response = flareprox.redirect_request(
target_url="https://httpbin.org/post",
method="POST",
headers=headers,
data=post_data
)

if response.status_code == 200:
result = response.json()
print("✓ POST successful via FlareProx")
print(f"Origin IP: {result.get('origin', 'unknown')}")
print(f"Posted data: {result.get('json', {})}")
else:
print(f"Request failed with status: {response.status_code}")

except FlareProxError as e:
print(f"FlareProx error: {e}")
except Exception as e:
print(f"Request error: {e}")
```
</details>

**Burp/Scanner integration**
- Ρυθμίστε το tooling (για παράδειγμα, Burp Suite) ώστε να δείχνει στο Worker URL.
- Παρέχετε το πραγματικό upstream χρησιμοποιώντας ?url= ή X-Target-URL.
- Η σημασιολογία του HTTP (methods/headers/body) διατηρείται ενώ η πηγή IP σας αποκρύπτεται πίσω από το Cloudflare.

**Λειτουργικές σημειώσεις και όρια**
- Το Cloudflare Workers Free plan επιτρέπει περίπου 100.000 requests/ημέρα ανά account· χρησιμοποιήστε πολλαπλά endpoints για να διανείμετε την κίνηση αν χρειάζεται.
- Οι Workers τρέχουν στο δίκτυο της Cloudflare· πολλοί στόχοι θα δουν μόνο Cloudflare IPs/ASN, κάτι που μπορεί να παρακάμψει απλές λίστες allow/deny για IP ή γεω-ευριστικές μεθόδους.
- Χρησιμοποιήστε υπεύθυνα και μόνο με εξουσιοδότηση. Σεβαστείτε τους ToS και το robots.txt.

## Αναφορές
- [FlareProx (Cloudflare Workers pass-through/rotation)](https://github.com/MrTurvey/flareprox)
- [Cloudflare Workers fetch() API](https://developers.cloudflare.com/workers/runtime-apis/fetch/)
- [Cloudflare Workers pricing and free tier](https://developers.cloudflare.com/workers/platform/pricing/)
- [FireProx (AWS API Gateway)](https://github.com/ustayready/fireprox)

{{#include ../../banners/hacktricks-training.md}}
