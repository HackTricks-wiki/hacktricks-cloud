# Cloudflare Security

{{#include ../../banners/hacktricks-training.md}}

В обліковому записі Cloudflare є декілька загальних налаштувань та сервісів, які можна сконфігурувати. На цій сторінці ми збираємося проаналізувати налаштування, пов'язані з безпекою, для кожного розділу:

<figure><img src="../../images/image (117).png" alt=""><figcaption></figcaption></figure>

## Websites

Перевіряйте кожен з:

{{#ref}}
cloudflare-domains.md
{{#endref}}

### Domain Registration

- [ ] У розділі **`Transfer Domains`** перевірити, що неможливо передати (transfer) жоден домен.

Перевіряйте кожен з:

{{#ref}}
cloudflare-domains.md
{{#endref}}

## Analytics

_Я не знайшов нічого для перевірки під час конфігураційного огляду безпеки._

## Pages

У кожній сторінці Cloudflare:

- [ ] Перевірити наявність **чутливої інформації** у **`Build log`**.
- [ ] Перевірити наявність **чутливої інформації** в репозиторії Github, прив'язаному до pages.
- [ ] Перевірити можливий компроміс github repo через **workflow command injection** або компроміс `pull_request_target`. Більше інформації на сторінці [**Github Security page**](../github-security/index.html).
- [ ] Перевірити наявність вразливих функцій у каталозі `/fuctions` (якщо є), перевірити **redirects** у файлі `_redirects` (якщо є) та **misconfigured headers** у файлі `_headers` (якщо є).
- [ ] Перевірити наявність **вразливостей** у веб-сторінці за допомогою **blackbox** або **whitebox**, якщо доступний код.
- [ ] У деталях кожної сторінки `/<page_id>/pages/view/blocklist/settings/functions` перевірити наявність **чутливої інформації** в **`Environment variables`**.
- [ ] На сторінці деталей також перевірити **build command** та **root directory** на предмет потенційних ін'єкцій для компрометації сторінки.

## **Workers**

У кожного Cloudflare worker перевірити:

- [ ] Тригер: що викликає worker? Чи може **користувач відправити дані**, які будуть **використані** worker?
- [ ] У **`Settings`** перевірити **`Variables`** на наявність **чутливої інформації**
- [ ] Переглянути **код worker** та шукати **вразливості** (особливо в місцях, де користувач може контролювати ввід)
- Перевірити SSRF, що повертає вказану сторінку, яку ви можете контролювати
- Перевірити XSS, що виконує JS всередині svg-зображення
- Можливо, worker взаємодіє з іншими внутрішніми сервісами. Наприклад, worker може звертатися до R2 bucket і зберігати туди інформацію, отриману з вводу. У такому випадку потрібно перевірити, які права має worker щодо R2 bucket і як це можна зловживати через користувацький ввід.

> [!WARNING]
> Note that by default a **Worker is given a URL** such as `<worker-name>.<account>.workers.dev`. The user can set it to a **subdomain** but you can always access it with that **original URL** if you know it.

Для практичного зловживання Workers як pass-through proxy (IP rotation, FireProx-style) див.:

{{#ref}}
cloudflare-workers-pass-through-proxy-ip-rotation.md
{{#endref}}

## R2

У кожному R2 bucket перевірити:

- [ ] Налаштувати **CORS Policy**.

## Stream

TODO

## Images

TODO

## Security Center

- [ ] Якщо можливо, запустити скан **`Security Insights`** та скан **`Infrastructure`**, оскільки вони можуть виділити цікаву інформацію з точки зору безпеки.
- [ ] Перевірити цю інформацію на предмет misconfigurations та цікавих деталей

## Turnstile

TODO

## **Zero Trust**

{{#ref}}
cloudflare-zero-trust-network.md
{{#endref}}

## Bulk Redirects

> [!NOTE]
> Unlike [Dynamic Redirects](https://developers.cloudflare.com/rules/url-forwarding/dynamic-redirects/), [**Bulk Redirects**](https://developers.cloudflare.com/rules/url-forwarding/bulk-redirects/) are essentially static — they do **not support any string replacement** operations or regular expressions. However, you can configure URL redirect parameters that affect their URL matching behavior and their runtime behavior.

- [ ] Перевірити, що **expressions** та **requirements** для redirect-ів мають сенс.
- [ ] Також перевірити наявність **чутливих прихованих endpoint-ів**, які можуть містити цікаву інформацію.

## Notifications

- [ ] Перевірити **notifications.** Ці сповіщення рекомендовані для безпеки:
- `Usage Based Billing`
- `HTTP DDoS Attack Alert`
- `Layer 3/4 DDoS Attack Alert`
- `Advanced HTTP DDoS Attack Alert`
- `Advanced Layer 3/4 DDoS Attack Alert`
- `Flow-based Monitoring: Volumetric Attack`
- `Route Leak Detection Alert`
- `Access mTLS Certificate Expiration Alert`
- `SSL for SaaS Custom Hostnames Alert`
- `Universal SSL Alert`
- `Script Monitor New Code Change Detection Alert`
- `Script Monitor New Domain Alert`
- `Script Monitor New Malicious Domain Alert`
- `Script Monitor New Malicious Script Alert`
- `Script Monitor New Malicious URL Alert`
- `Script Monitor New Scripts Alert`
- `Script Monitor New Script Exceeds Max URL Length Alert`
- `Advanced Security Events Alert`
- `Security Events Alert`
- [ ] Перевірити всі **destinations**, оскільки у webhook URL-ах може бути **чутлива інформація** (basic http auth). Також переконатися, що webhook URLs використовують **HTTPS**
- [ ] Як додаткову перевірку, можна спробувати **імітувати cloudflare notification** для третьої сторони — можливо, вдасться щось інжектувати небезпечне

## Manage Account

- [ ] У **`Billing` -> `Payment info`** можна побачити **останні 4 цифри кредитної картки**, **строк дії** та **платіжну адресу**.
- [ ] У **`Billing` -> `Subscriptions`** можна побачити тип плану, що використовується в обліковому записі.
- [ ] У **`Members`** можна побачити всіх членів облікового запису та їхні **ролі**. Зауважте, що якщо план не Enterprise, існує лише 2 ролі: Administrator та Super Administrator. Але якщо використовується **Enterprise** план, можна застосовувати [**more roles**](https://developers.cloudflare.com/fundamentals/account-and-billing/account-setup/account-roles/) для принципу мінімальних привілеїв.
- Тому, коли це можливо, **рекомендовано** використовувати **Enterprise plan**.
- [ ] У Members можна перевірити, які **members** мають увімкнений **2FA**. **Усі** користувачі повинні мати його увімкненим.

> [!NOTE]
> Note that fortunately the role **`Administrator`** doesn't give permissions to manage memberships (**cannot escalate privs or invite** new members)

## DDoS Investigation

[Check this part](cloudflare-domains.md#cloudflare-ddos-protection).

{{#include ../../banners/hacktricks-training.md}}
