# Seguridad de Cloudflare

{{#include ../../banners/hacktricks-training.md}}

En una cuenta de Cloudflare hay algunos **ajustes y servicios generales** que se pueden configurar. En esta página vamos a **analizar los ajustes relacionados con la seguridad de cada sección:**

<figure><img src="../../images/image (117).png" alt=""><figcaption></figcaption></figure>

## Sitios web

Revisar cada uno con:

{{#ref}}
cloudflare-domains.md
{{#endref}}

### Registro de dominios

- [ ] En **`Transfer Domains`** comprueba que no sea posible transferir ningún dominio.

Revisar cada uno con:

{{#ref}}
cloudflare-domains.md
{{#endref}}

## Analítica

_I couldn't find anything to check for a config security review._

## Pages

En cada Pages de Cloudflare:

- [ ] Busca **información sensible** en el **`Build log`**.
- [ ] Busca **información sensible** en el repositorio de **Github** asignado a Pages.
- [ ] Comprueba un posible compromiso del repo de Github vía **workflow command injection** o compromiso de `pull_request_target`. Más info en la [**Github Security page**](../github-security/index.html).
- [ ] Busca **vulnerable functions** en el directorio `/fuctions` (si existe), revisa los **redirects** en el archivo `_redirects` (si existe) y las **misconfigured headers** en el archivo `_headers` (si existe).
- [ ] Busca **vulnerabilidades** en la **web** mediante **blackbox** o **whitebox** si puedes **acceder al código**
- [ ] En los detalles de cada page `/<page_id>/pages/view/blocklist/settings/functions`. Busca **información sensible** en las **`Environment variables`**.
- [ ] En la página de detalles revisa también el **build command** y el **root directory** por **posibles inyecciones** para comprometer la página.

## **Workers**

En cada Worker de Cloudflare, comprueba:

- [ ] Los triggers: ¿Qué hace que se dispare el worker? ¿Puede un **usuario enviar datos** que serán **usados** por el worker?
- [ ] En los **`Settings`**, comprueba las **`Variables`** que contengan **información sensible**
- [ ] Revisa el **código del worker** y busca **vulnerabilidades** (especialmente en lugares donde el usuario puede manejar la entrada)
- Comprueba SSRFs que retornen la página indicada que puedas controlar
- Comprueba XSSs que ejecuten JS dentro de una imagen svg
- Es posible que el worker interactúe con otros servicios internos. Por ejemplo, un worker puede interactuar con un bucket R2 almacenando información en él obtenida desde la entrada. En ese caso, sería necesario comprobar qué capacidades tiene el worker sobre el bucket R2 y cómo podría ser abusado a partir de la entrada del usuario.

> [!WARNING]
> Ten en cuenta que por defecto a un **Worker se le asigna una URL** como `<worker-name>.<account>.workers.dev`. El usuario puede configurarla a un **subdominio** pero siempre puedes accederla con esa **URL original** si la conoces.

Para un abuso práctico de Workers como pass-through proxies (rotación de IP, FireProx-style), consulta:

{{#ref}}
cloudflare-workers-pass-through-proxy-ip-rotation.md
{{#endref}}

## R2

En cada bucket R2 comprueba:

- [ ] Configura la **CORS Policy**.

## Stream

TODO

## Images

TODO

## Security Center

- [ ] Si es posible, ejecuta un **`Security Insights`** **scan** y un **`Infrastructure`** **scan**, ya que resaltarán información interesante desde el punto de vista **de seguridad**.
- [ ] Simplemente **revisa esta información** en busca de malas configuraciones de seguridad e información interesante

## Turnstile

TODO

## **Zero Trust**

{{#ref}}
cloudflare-zero-trust-network.md
{{#endref}}

## Bulk Redirects

> [!NOTE]
> A diferencia de [Dynamic Redirects](https://developers.cloudflare.com/rules/url-forwarding/dynamic-redirects/), [**Bulk Redirects**](https://developers.cloudflare.com/rules/url-forwarding/bulk-redirects/) son esencialmente estáticos — no soportan operaciones de reemplazo de cadenas ni expresiones regulares. Sin embargo, puedes configurar parámetros de redirección URL que afectan su comportamiento de matching y su comportamiento en tiempo de ejecución.

- [ ] Comprueba que las **expresiones** y **requisitos** para las redirecciones **tengan sentido**.
- [ ] Revisa también por **endpoints ocultos sensibles** que contengan información interesante.

## Notifications

- [ ] Revisa las **notificaciones.** Estas notificaciones se recomiendan para seguridad:
- `Usage Based Billing`
- `HTTP DDoS Attack Alert`
- `Layer 3/4 DDoS Attack Alert`
- `Advanced HTTP DDoS Attack Alert`
- `Advanced Layer 3/4 DDoS Attack Alert`
- `Flow-based Monitoring: Volumetric Attack`
- `Route Leak Detection Alert`
- `Access mTLS Certificate Expiration Alert`
- `SSL for SaaS Custom Hostnames Alert`
- `Universal SSL Alert`
- `Script Monitor New Code Change Detection Alert`
- `Script Monitor New Domain Alert`
- `Script Monitor New Malicious Domain Alert`
- `Script Monitor New Malicious Script Alert`
- `Script Monitor New Malicious URL Alert`
- `Script Monitor New Scripts Alert`
- `Script Monitor New Script Exceeds Max URL Length Alert`
- `Advanced Security Events Alert`
- `Security Events Alert`
- [ ] Revisa todos los **destinos**, ya que podría haber **información sensible** (basic http auth) en las webhook urls. Asegúrate también de que las webhook urls usen **HTTPS**
- [ ] Como comprobación extra, podrías intentar **suplantar una notificación de cloudflare** a un tercero, quizás puedas de algún modo **inyectar algo peligroso**

## Manage Account

- [ ] Es posible ver los **últimos 4 dígitos de la tarjeta de crédito**, la **fecha de expiración** y la **dirección de facturación** en **`Billing` -> `Payment info`**.
- [ ] Es posible ver el **tipo de plan** usado en la cuenta en **`Billing` -> `Subscriptions`**.
- [ ] En **`Members`** es posible ver todos los miembros de la cuenta y su **role**. Ten en cuenta que si el tipo de plan no es Enterprise, solo existen 2 roles: Administrator y Super Administrator. Pero si el **plan es Enterprise**, se pueden usar [**más roles**](https://developers.cloudflare.com/fundamentals/account-and-billing/account-setup/account-roles/) para seguir el principio de menor privilegio.
- Por lo tanto, siempre que sea posible se **recomienda** usar el **Enterprise plan**.
- [ ] En Members es posible comprobar qué **miembros** tienen **2FA habilitado**. **Todos** los usuarios deberían tenerlo activado.

> [!NOTE]
> Ten en cuenta que afortunadamente el role **`Administrator`** no otorga permisos para gestionar membresías (**no puede escalar privilegios o invitar** nuevos miembros)

## DDoS Investigation

[Revisa esta parte](cloudflare-domains.md#cloudflare-ddos-protection).

{{#include ../../banners/hacktricks-training.md}}
