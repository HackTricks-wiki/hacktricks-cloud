# Cloudflare 安全

{{#include ../../banners/hacktricks-training.md}}

在 Cloudflare 帐户中，有一些可以配置的 **常规设置和服务**。在本页中，我们将 **分析每个部分与安全相关的设置：**

<figure><img src="../../images/image (117).png" alt=""><figcaption></figcaption></figure>

## Websites

逐一检查：

{{#ref}}
cloudflare-domains.md
{{#endref}}

### Domain Registration

- [ ] 在 **`Transfer Domains`** 中检查是否不可能转移任何域名。

逐一检查：

{{#ref}}
cloudflare-domains.md
{{#endref}}

## Analytics

_我找不到任何可以在配置安全审查中检查的内容。_

## Pages

对于每个 Cloudflare 的 page：

- [ ] 在 **`Build log`** 中检查 **敏感信息**。
- [ ] 检查分配给 pages 的 **Github repository** 中的 **敏感信息**。
- [ ] 检查通过 **workflow command injection** 或 `pull_request_target` 导致的潜在 github repo 被入侵。更多信息见 [**Github Security page**](../github-security/index.html)。
- [ ] 检查 `/fuctions` 目录（如果有）中是否存在 **易受攻击的函数**，检查 `_redirects` 文件（如果有）中的 **redirects**，以及 `_headers` 文件（如果有）中的 **错误配置的 headers**。
- [ ] 如果你可以 **访问代码**，通过黑盒或白盒方法检查 **web page** 的 **漏洞**。
- [ ] 在每个 page 的详情 `/<page_id>/pages/view/blocklist/settings/functions` 中，检查 **`Environment variables`** 是否包含 **敏感信息**。
- [ ] 在详情页还要检查 **build command** 和 **root directory** 是否存在可导致页面被攻破的 **注入**。

## **Workers**

在每个 Cloudflare 的 worker 上检查：

- [ ] 触发条件：是什么触发 worker？用户能否发送会被 worker 使用的数据？
- [ ] 在 **`Settings`** 中，检查包含 **敏感信息** 的 **`Variables`**
- [ ] 检查 worker 的 **代码** 并搜索 **漏洞**（尤其是在用户可以控制输入的地方）
- 检查 SSRFs 返回你可以控制的指定页面
- 检查 XSSs 在 svg 图像内执行 JS
- worker 可能会与其他内部服务交互。例如，worker 可能会与一个 R2 bucket 交互，将从输入获得的信息存储在其中。在这种情况下，需要检查 worker 对该 R2 bucket 拥有哪些能力，以及如何可能被用户输入滥用。

> [!WARNING]
> 注意，默认情况下 **Worker 会被分配一个 URL**，例如 `<worker-name>.<account>.workers.dev`。用户可以将其设置为一个子域名，但如果你知道该 **原始 URL**，仍然可以通过它访问。

有关将 Workers 作为透传代理（IP 轮换、FireProx 风格）的实用滥用示例，请查看：

{{#ref}}
cloudflare-workers-pass-through-proxy-ip-rotation.md
{{#endref}}

## R2

在每个 R2 bucket 上检查：

- [ ] 配置 **CORS Policy**。

## Stream

TODO

## Images

TODO

## Security Center

- [ ] 如果可能，运行一次 **`Security Insights`** 扫描和一次 **`Infrastructure`** 扫描，因为它们会在安全方面 **突出显示** 有趣的信息。
- [ ] 仅需检查这些信息以发现安全错误配置和有趣的信息

## Turnstile

TODO

## **Zero Trust**

{{#ref}}
cloudflare-zero-trust-network.md
{{#endref}}

## Bulk Redirects

> [!NOTE]
> Unlike [Dynamic Redirects](https://developers.cloudflare.com/rules/url-forwarding/dynamic-redirects/), [**Bulk Redirects**](https://developers.cloudflare.com/rules/url-forwarding/bulk-redirects/) are essentially static — they do **not support any string replacement** operations or regular expressions. However, you can configure URL redirect parameters that affect their URL matching behavior and their runtime behavior.

- [ ] 检查重定向的 **expressions** 和 **requirements** 是否合理。
- [ ] 还要检查是否存在包含有趣信息的 **敏感隐藏端点**。

## Notifications

- [ ] 检查 **notifications。** 推荐用于安全的通知包括：
- `Usage Based Billing`
- `HTTP DDoS Attack Alert`
- `Layer 3/4 DDoS Attack Alert`
- `Advanced HTTP DDoS Attack Alert`
- `Advanced Layer 3/4 DDoS Attack Alert`
- `Flow-based Monitoring: Volumetric Attack`
- `Route Leak Detection Alert`
- `Access mTLS Certificate Expiration Alert`
- `SSL for SaaS Custom Hostnames Alert`
- `Universal SSL Alert`
- `Script Monitor New Code Change Detection Alert`
- `Script Monitor New Domain Alert`
- `Script Monitor New Malicious Domain Alert`
- `Script Monitor New Malicious Script Alert`
- `Script Monitor New Malicious URL Alert`
- `Script Monitor New Scripts Alert`
- `Script Monitor New Script Exceeds Max URL Length Alert`
- `Advanced Security Events Alert`
- `Security Events Alert`
- [ ] 检查所有 **destinations**，因为 webhook urls 中可能包含 **敏感信息**（如 basic http auth）。还要确保 webhook urls 使用 **HTTPS**
- [ ] 作为额外检查，你可以尝试 **冒充 cloudflare 通知** 发送给第三方，或许你可以以某种方式 **注入一些危险内容**

## Manage Account

- [ ] 在 **`Billing` -> `Payment info`** 中可以看到信用卡的 **后四位数字**、**到期时间** 和 **账单地址**。
- [ ] 在 **`Billing` -> `Subscriptions`** 中可以看到帐户使用的 **plan type**。
- [ ] 在 **`Members`** 中可以看到帐户的所有成员及其 **role**。注意，如果 plan type 不是 Enterprise，则只有两个角色：Administrator 和 Super Administrator。但如果使用的是 **Enterprise** 计划，可以使用 [**更多角色**](https://developers.cloudflare.com/fundamentals/account-and-billing/account-setup/account-roles/) 以遵循最小权限原则。
- 因此，尽可能 **建议** 使用 **Enterprise plan**。
- [ ] 在 Members 中可以检查哪些 **成员** 已启用 **2FA**。**每个**用户都应启用它。

> [!NOTE]
> 注意，幸运的是角色 **`Administrator`** 并不赋予管理成员资格的权限（**不能提升权限或邀请** 新成员）

## DDoS Investigation

[Check this part](cloudflare-domains.md#cloudflare-ddos-protection).

{{#include ../../banners/hacktricks-training.md}}
