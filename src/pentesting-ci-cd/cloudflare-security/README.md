# Cloudflare セキュリティ

{{#include ../../banners/hacktricks-training.md}}

In a Cloudflare account there are some **一般的な設定とサービス** that can be configured. In this page we are going to **各セクションのセキュリティ関連設定を分析します:**

<figure><img src="../../images/image (117).png" alt=""><figcaption></figcaption></figure>

## Webサイト

Review each with:

{{#ref}}
cloudflare-domains.md
{{#endref}}

### ドメイン登録

- [ ] In **`Transfer Domains`** check that it's not possible to transfer any domain.
  - **`Transfer Domains`** で任意のドメインを転送できないことを確認する。

Review each with:

{{#ref}}
cloudflare-domains.md
{{#endref}}

## Analytics

_I couldn't find anything to check for a config security review._

## Pages

On each Cloudflare's page:

- [ ] Check for **機密情報** in the **`Build log`**.
- [ ] Check for **機密情報** in the **Github repository** assigned to the pages.
- [ ] Check for potential github repo compromise via **workflow command injection** or `pull_request_target` compromise. More info in the [**Github Security page**](../github-security/index.html).
- [ ] Check for **vulnerable functions** in the `/fuctions` directory (if any), check the **redirects** in the `_redirects` file (if any) and **misconfigured headers** in the `_headers` file (if any).
  - `/fuctions` ディレクトリ（存在する場合）の脆弱な関数を確認し、`_redirects` ファイル（存在する場合）のリダイレクトと `_headers` ファイル（存在する場合）の誤設定されたヘッダを確認する。
- [ ] Check for **vulnerabilities** in the **web page** via **blackbox** or **whitebox** if you can **access the code**
  - コードにアクセスできる場合は、**blackbox** または **whitebox** によってウェブページの脆弱性を確認する。
- [ ] In the details of each page `/<page_id>/pages/view/blocklist/settings/functions`. Check for **sensitive information** in the **`Environment variables`**.
  - 各ページの詳細 `/<page_id>/pages/view/blocklist/settings/functions` で、**`Environment variables`** に機密情報が含まれていないか確認する。
- [ ] In the details page check also the **build command** and **root directory** for **potential injections** to compromise the page.
  - 詳細ページで **build command** と **root directory** を確認し、ページを乗っ取る可能性のある注入がないか確認する。

## **Workers**

On each Cloudflare's worker check:

- [ ] The triggers: What makes the worker trigger? Can a **user send data** that will be **used** by the worker?
  - トリガー: Worker を起動する要因は何か？**ユーザがデータを送信**して、それが **使用される** か？
- [ ] In the **`Settings`**, check for **`Variables`** containing **sensitive information**
  - **`Settings`** で **`Variables`** に機密情報が含まれていないか確認する
- [ ] Check the **code of the worker** and search for **vulnerabilities** (specially in places where the user can manage the input)
  - Worker のコードを確認し、特にユーザが入力を扱う箇所で脆弱性がないか確認する
- Check for SSRFs returning the indicated page that you can control
  - あなたが制御できるページを返す SSRF を確認する
- Check XSSs executing JS inside a svg image
  - svg 画像内で JS を実行する XSS を確認する
- It is possible that the worker interacts with other internal services. For example, a worker may interact with a R2 bucket storing information in it obtained from the input. In that case, it would be necessary to check what capabilities does the worker have over the R2 bucket and how could it be abused from the user input.
  - Worker が他の内部サービスと連携している可能性がある。例えば、Worker が入力から得た情報を保存する R2 バケットとやり取りする場合、その Worker が R2 バケットに対してどのような権限を持っているか、ユーザ入力からどのように悪用され得るかを確認する必要がある。

> [!WARNING]
> デフォルトでは **Worker に割り当てられる URL** は `<worker-name>.<account>.workers.dev` のようになります。ユーザはそれを **サブドメイン** に設定できますが、知っていれば常にその **元の URL** でアクセスできます。

For a practical abuse of Workers as pass-through proxies (IP rotation, FireProx-style), check:

{{#ref}}
cloudflare-workers-pass-through-proxy-ip-rotation.md
{{#endref}}

## R2

On each R2 bucket check:

- [ ] Configure **CORS Policy**.
  - **CORS Policy** を設定する。

## Stream

TODO

## Images

TODO

## Security Center

- [ ] If possible, run a **`Security Insights`** **scan** and an **`Infrastructure`** **scan**, as they will **highlight** interesting information **security** wise.
  - 可能なら **`Security Insights`** スキャンと **`Infrastructure`** スキャンを実行する。これらはセキュリティ上興味深い情報を強調表示する。
- [ ] Just **check this information** for security misconfigurations and interesting info
  - この情報をセキュリティの誤設定や興味深い情報のために確認する

## Turnstile

TODO

## **Zero Trust**

{{#ref}}
cloudflare-zero-trust-network.md
{{#endref}}

## Bulk Redirects

> [!NOTE]
> Unlike [Dynamic Redirects](https://developers.cloudflare.com/rules/url-forwarding/dynamic-redirects/), [**Bulk Redirects**](https://developers.cloudflare.com/rules/url-forwarding/bulk-redirects/) は本質的に静的で、文字列置換操作や正規表現を**サポートしません**。ただし、URL のマッチング動作や実行時の動作に影響する URL redirect parameters を設定することはできます。

- [ ] Check that the **expressions** and **requirements** for redirects **make sense**.
  - リダイレクトの **expressions** と **requirements** が妥当であるか確認する。
- [ ] Check also for **sensitive hidden endpoints** that you contain interesting info.
  - 興味深い情報を含む **機密の隠しエンドポイント** がないかも確認する。

## Notifications

- [ ] Check the **notifications.** These notifications are recommended for security:
- `Usage Based Billing`
- `HTTP DDoS Attack Alert`
- `Layer 3/4 DDoS Attack Alert`
- `Advanced HTTP DDoS Attack Alert`
- `Advanced Layer 3/4 DDoS Attack Alert`
- `Flow-based Monitoring: Volumetric Attack`
- `Route Leak Detection Alert`
- `Access mTLS Certificate Expiration Alert`
- `SSL for SaaS Custom Hostnames Alert`
- `Universal SSL Alert`
- `Script Monitor New Code Change Detection Alert`
- `Script Monitor New Domain Alert`
- `Script Monitor New Malicious Domain Alert`
- `Script Monitor New Malicious Script Alert`
- `Script Monitor New Malicious URL Alert`
- `Script Monitor New Scripts Alert`
- `Script Monitor New Script Exceeds Max URL Length Alert`
- `Advanced Security Events Alert`
- `Security Events Alert`
- [ ] Check all the **destinations**, as there could be **sensitive info** (basic http auth) in webhook urls. Make also sure webhook urls use **HTTPS**
  - すべての **destinations** を確認する。webhook URL に基本認証などの **機密情報** が含まれている可能性があるため。また webhook URL が **HTTPS** を使用していることを確認する。
- [ ] As extra check, you could try to **impersonate a cloudflare notification** to a third party, maybe you can somehow **inject something dangerous**
  - 追加の確認として、Cloudflare 通知を第三者に**偽装**してみることが考えられる。何らかの方法で**危険な注入**ができないか検証する。

## Manage Account

- [ ] It's possible to see the **last 4 digits of the credit card**, **expiration** time and **billing address** in **`Billing` -> `Payment info`**.
  - **`Billing` -> `Payment info`** でクレジットカードの**下4桁**、**有効期限**、**請求先住所**を確認できる。
- [ ] It's possible to see the **plan type** used in the account in **`Billing` -> `Subscriptions`**.
  - **`Billing` -> `Subscriptions`** でアカウントの**プラン種別**を確認できる。
- [ ] In **`Members`** it's possible to see all the members of the account and their **role**. Note that if the plan type isn't Enterprise, only 2 roles exist: Administrator and Super Administrator. But if the used **plan is Enterprise**, [**more roles**](https://developers.cloudflare.com/fundamentals/account-and-billing/account-setup/account-roles/) can be used to follow the least privilege principle.
  - **`Members`** ではアカウントの全メンバーとそのロールを確認できる。プランが Enterprise でない場合、ロールは Administrator と Super Administrator の2種類のみである。使用中のプランが Enterprise の場合は、最小権限の原則に従うために [**more roles**](https://developers.cloudflare.com/fundamentals/account-and-billing/account-setup/account-roles/) を利用できる。
- Therefore, whenever possible is **recommended** to use the **Enterprise plan**.
  - したがって、可能な限り **Enterprise プラン** を利用することを**推奨**する。
- [ ] In Members it's possible to check which **members** has **2FA enabled**. **Every** user should have it enabled.
  - **`Members`** でどのメンバーが **2FA を有効化しているか** を確認できる。すべてのユーザが有効化しているべきである。

> [!NOTE]
> Note that fortunately the role **`Administrator`** doesn't give permissions to manage memberships (**cannot escalate privs or invite** new members)
> 
> 幸いなことに、ロール **`Administrator`** はメンバーシップを管理する権限を与えない（**権限昇格や新規メンバー招待はできない**）。

## DDoS Investigation

[Check this part](cloudflare-domains.md#cloudflare-ddos-protection).

{{#include ../../banners/hacktricks-training.md}}
