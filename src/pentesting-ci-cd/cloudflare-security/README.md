# Cloudflare Security

{{#include ../../banners/hacktricks-training.md}}

在 Cloudflare 账户中，有一些 **通用设置和服务** 可以进行配置。在本页面中，我们将 **分析每个部分的安全相关设置：**

<figure><img src="../../images/image (117).png" alt=""><figcaption></figcaption></figure>

## Websites

逐一检查：

{{#ref}}
cloudflare-domains.md
{{#endref}}

### Domain Registration

- [ ] 在 **`Transfer Domains`** 中检查是否无法转移任何域名。

逐一检查：

{{#ref}}
cloudflare-domains.md
{{#endref}}

## Analytics

_我找不到任何可以检查配置安全审查的内容。_

## Pages

在每个 Cloudflare 页面上：

- [ ] 检查 **`Build log`** 中的 **敏感信息**。
- [ ] 检查分配给页面的 **Github 仓库** 中的 **敏感信息**。
- [ ] 检查通过 **workflow command injection** 或 `pull_request_target` 可能导致的 GitHub 仓库泄露。更多信息请参见 [**Github Security page**](../github-security/)。
- [ ] 检查 `/fuctions` 目录中的 **脆弱函数**（如果有），检查 `_redirects` 文件中的 **重定向**（如果有）和 `_headers` 文件中的 **错误配置的头部**（如果有）。
- [ ] 通过 **blackbox** 或 **whitebox** 检查 **网页** 中的 **漏洞**，如果您可以 **访问代码**。
- [ ] 在每个页面的详细信息 `/<page_id>/pages/view/blocklist/settings/functions` 中检查 **`Environment variables`** 中的 **敏感信息**。
- [ ] 在详细信息页面中，还要检查 **构建命令** 和 **根目录** 以查找 **潜在注入** 以危害页面。

## **Workers**

在每个 Cloudflare 的 worker 中检查：

- [ ] 触发器：是什么使 worker 触发？用户是否可以发送将被 worker **使用** 的数据？
- [ ] 在 **`Settings`** 中，检查包含 **敏感信息** 的 **`Variables`**。
- [ ] 检查 **worker 的代码** 并搜索 **漏洞**（特别是在用户可以管理输入的地方）。
- 检查 SSRFs 返回您可以控制的指定页面。
- 检查 XSS 在 svg 图像内执行 JS。
- worker 可能与其他内部服务交互。例如，worker 可能与存储从输入中获得的信息的 R2 存储桶交互。在这种情况下，需要检查 worker 对 R2 存储桶的能力以及如何可能被用户输入滥用。

> [!WARNING]
> 请注意，默认情况下，**Worker 会被赋予一个 URL**，例如 `<worker-name>.<account>.workers.dev`。用户可以将其设置为 **子域名**，但如果您知道该 **原始 URL**，您始终可以通过该 URL 访问它。

## R2

在每个 R2 存储桶中检查：

- [ ] 配置 **CORS Policy**。

## Stream

TODO

## Images

TODO

## Security Center

- [ ] 如果可能，运行 **`Security Insights`** **扫描** 和 **`Infrastructure`** **扫描**，因为它们将 **突出** 有趣的信息 **安全** 方面。
- [ ] 仅检查此信息以查找安全错误配置和有趣的信息。

## Turnstile

TODO

## **Zero Trust**

{{#ref}}
cloudflare-zero-trust-network.md
{{#endref}}

## Bulk Redirects

> [!NOTE]
> 与 [Dynamic Redirects](https://developers.cloudflare.com/rules/url-forwarding/dynamic-redirects/) 不同， [**Bulk Redirects**](https://developers.cloudflare.com/rules/url-forwarding/bulk-redirects/) 本质上是静态的——它们不支持任何字符串替换操作或正则表达式。但是，您可以配置影响其 URL 匹配行为和运行时行为的 URL 重定向参数。

- [ ] 检查 **重定向的表达式** 和 **要求** 是否 **合理**。
- [ ] 还要检查 **敏感隐藏端点**，其中可能包含有趣的信息。

## Notifications

- [ ] 检查 **通知**。这些通知建议用于安全：
- `Usage Based Billing`
- `HTTP DDoS Attack Alert`
- `Layer 3/4 DDoS Attack Alert`
- `Advanced HTTP DDoS Attack Alert`
- `Advanced Layer 3/4 DDoS Attack Alert`
- `Flow-based Monitoring: Volumetric Attack`
- `Route Leak Detection Alert`
- `Access mTLS Certificate Expiration Alert`
- `SSL for SaaS Custom Hostnames Alert`
- `Universal SSL Alert`
- `Script Monitor New Code Change Detection Alert`
- `Script Monitor New Domain Alert`
- `Script Monitor New Malicious Domain Alert`
- `Script Monitor New Malicious Script Alert`
- `Script Monitor New Malicious URL Alert`
- `Script Monitor New Scripts Alert`
- `Script Monitor New Script Exceeds Max URL Length Alert`
- `Advanced Security Events Alert`
- `Security Events Alert`
- [ ] 检查所有 **目的地**，因为 webhook urls 中可能存在 **敏感信息**（基本 http auth）。还要确保 webhook urls 使用 **HTTPS**。
- [ ] 作为额外检查，您可以尝试 **冒充 Cloudflare 通知** 给第三方，也许您可以以某种方式 **注入一些危险的东西**。

## Manage Account

- [ ] 可以在 **`Billing` -> `Payment info`** 中查看 **信用卡的最后 4 位数字**、**到期** 时间和 **账单地址**。
- [ ] 可以在 **`Billing` -> `Subscriptions`** 中查看账户中使用的 **计划类型**。
- [ ] 在 **`Members`** 中，可以查看账户的所有成员及其 **角色**。请注意，如果计划类型不是企业版，则仅存在 2 个角色：管理员和超级管理员。但如果使用的 **计划是企业版**，则可以使用 [**更多角色**](https://developers.cloudflare.com/fundamentals/account-and-billing/account-setup/account-roles/) 来遵循最小权限原则。
- 因此，尽可能 **建议** 使用 **企业计划**。
- [ ] 在成员中，可以检查哪些 **成员** 启用了 **2FA**。**每个** 用户都应该启用它。

> [!NOTE]
> 请注意，幸运的是，角色 **`Administrator`** 不授予管理成员资格的权限（**无法提升权限或邀请** 新成员）。

## DDoS Investigation

[检查此部分](cloudflare-domains.md#cloudflare-ddos-protection)。

{{#include ../../banners/hacktricks-training.md}}
