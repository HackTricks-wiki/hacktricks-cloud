# Gitea 安全

{{#include ../../banners/hacktricks-training.md}}

## 什么是 Gitea

**Gitea** 是一个 **自托管的社区管理轻量级代码托管** 解决方案，使用 Go 编写。

![](<../../images/image (160).png>)

### 基本信息

{{#ref}}
basic-gitea-information.md
{{#endref}}

## 实验室

要在本地运行 Gitea 实例，您只需运行一个 docker 容器：
```bash
docker run -p 3000:3000 gitea/gitea
```
连接到端口 3000 以访问网页。

您也可以使用 kubernetes 运行它：
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## 未经身份验证的枚举

- 公共仓库: [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
- 注册用户: [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
- 注册组织: [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

请注意，**默认情况下 Gitea 允许新用户注册**。这不会给新用户提供对其他组织/用户仓库的特别有趣的访问权限，但**登录用户**可能能够**查看更多的仓库或组织**。

## 内部利用

在这个场景中，我们假设你已经获得了一些对 GitHub 账户的访问权限。

### 使用用户凭据/网页 Cookie

如果你以某种方式已经获得了组织内某个用户的凭据（或者你窃取了一个会话 Cookie），你可以**直接登录**并检查你对哪些**仓库**拥有**权限**，你在哪些**团队**中，**列出其他用户**，以及**仓库是如何保护的**。

请注意，**可能会使用 2FA**，因此你只有在能够**通过该检查**的情况下才能访问这些信息。

> [!NOTE]
> 请注意，如果你**设法窃取了 `i_like_gitea` Cookie**（当前配置为 SameSite: Lax），你可以**完全冒充该用户**而无需凭据或 2FA。

### 使用用户 SSH 密钥

Gitea 允许**用户**设置**SSH 密钥**，该密钥将作为**代表他们部署代码的身份验证方法**（不适用 2FA）。

使用此密钥，你可以对用户拥有某些权限的**仓库进行更改**，但是你不能使用它访问 Gitea API 来枚举环境。然而，你可以**枚举本地设置**以获取有关你有访问权限的仓库和用户的信息：
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
如果用户将其用户名配置为他的 gitea 用户名，您可以访问他在 _https://github.com/\<gitea_username>.keys_ 中设置的 **公钥**，您可以检查此内容以确认您找到的私钥是否可以使用。

**SSH 密钥** 也可以在仓库中设置为 **部署密钥**。任何拥有此密钥的人都将能够 **从仓库启动项目**。通常在具有不同部署密钥的服务器上，本地文件 **`~/.ssh/config`** 将提供与密钥相关的信息。

#### GPG 密钥

如 [**这里**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md) 所述，有时需要签署提交，否则您可能会被发现。

在本地检查当前用户是否有任何密钥：
```shell
gpg --list-secret-keys --keyid-format=long
```
### 使用用户令牌

有关[**用户令牌的介绍，请查看基本信息**](basic-gitea-information.md#personal-access-tokens)。

用户令牌可以**替代密码**来**认证**Gitea服务器[**通过API**](https://try.gitea.io/api/swagger#/)。它将对用户具有**完全访问权限**。

### 使用Oauth应用程序

有关[**Gitea Oauth应用程序的介绍，请查看基本信息**](./#with-oauth-application)。

攻击者可能创建一个**恶意Oauth应用程序**来访问接受它们的用户的特权数据/操作，这可能是网络钓鱼活动的一部分。

如基本信息中所述，该应用程序将对用户帐户具有**完全访问权限**。

### 绕过分支保护

在Github中，我们有**github actions**，默认情况下会获得对仓库的**写入访问权限**的**令牌**，可以用来**绕过分支保护**。在这种情况下**不存在**，因此绕过的方式更有限。但让我们看看可以做些什么：

- **启用推送**：如果任何具有写入权限的人可以推送到该分支，只需推送即可。
- **白名单限制推送**：同样，如果您是此列表的一部分，则可以推送到该分支。
- **启用合并白名单**：如果有合并白名单，您需要在其中。
- **需要的批准大于0**：那么...您需要妥协另一个用户。
- **限制批准给白名单用户**：如果只有白名单用户可以批准...您需要妥协另一个在该列表中的用户。
- **撤销过期批准**：如果批准没有随着新提交而被移除，您可以劫持一个已经批准的PR来注入您的代码并合并PR。

请注意**如果您是组织/仓库管理员**，您可以绕过保护。

### 枚举Webhooks

**Webhooks**能够**将特定的gitea信息发送到某些地方**。您可能能够**利用这种通信**。\
然而，通常在**webhook**中设置了一个您**无法检索**的**密钥**，这将**防止**外部用户知道webhook的URL但不知道密钥来**利用该webhook**。\
但在某些情况下，人们不是将**密钥**设置在其位置，而是将其**作为参数设置在URL中**，因此**检查URL**可能允许您**找到密钥**和其他您可以进一步利用的地方。

Webhooks可以在**仓库和组织级别**设置。

## 后期利用

### 服务器内部

如果您以某种方式设法进入运行gitea的服务器，您应该搜索gitea配置文件。默认情况下，它位于`/data/gitea/conf/app.ini`

在此文件中，您可以找到**密钥**和**密码**。

在gitea路径（默认：/data/gitea）中，您还可以找到有趣的信息，例如：

- **sqlite**数据库：如果gitea不使用外部数据库，它将使用sqlite数据库。
- **会话**在会话文件夹中：运行`cat sessions/*/*/*`可以看到已登录用户的用户名（gitea也可以将会话保存在数据库中）。
- **jwt私钥**在jwt文件夹中。
- 该文件夹中可能找到更多**敏感信息**。

如果您在服务器内部，您还可以**使用`gitea`二进制文件**来访问/修改信息：

- `gitea dump`将转储gitea并生成一个.zip文件。
- `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET`将生成指定类型的令牌（持久性）。
- `gitea admin user change-password --username admin --password newpassword`更改密码。
- `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token`创建新管理员用户并获取访问令牌。

{{#include ../../banners/hacktricks-training.md}}
