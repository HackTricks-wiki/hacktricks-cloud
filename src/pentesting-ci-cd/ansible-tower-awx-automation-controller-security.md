# Ansible Tower / AWX / Automation controller Security

{{#include ../banners/hacktricks-training.md}}

## 基本情報

**Ansible Tower** またはそのオープンソース版 [**AWX**](https://github.com/ansible/awx) は、**Ansibleのユーザーインターフェース、ダッシュボード、REST API** として知られています。**ロールベースのアクセス制御**、ジョブスケジューリング、グラフィカルなインベントリ管理を使用して、最新のUIからAnsibleインフラストラクチャを管理できます。TowerのREST APIとコマンドラインインターフェースにより、現在のツールやワークフローに簡単に統合できます。

**Automation Controllerは新しい** バージョンのAnsible Towerで、より多くの機能を備えています。

### 違い

[**こちら**](https://blog.devops.dev/ansible-tower-vs-awx-under-the-hood-65cfec78db00)によると、Ansible TowerとAWXの主な違いは受けたサポートであり、Ansible Towerにはロールベースのアクセス制御、カスタムAPIのサポート、ユーザー定義のワークフローなどの追加機能があります。

### テクノロジースタック

- **Webインターフェース**: これは、ユーザーがインベントリ、資格情報、テンプレート、ジョブを管理できるグラフィカルインターフェースです。直感的に設計されており、オートメーションジョブの状態や結果を理解するのに役立つ視覚化を提供します。
- **REST API**: Webインターフェースでできるすべてのことは、REST APIを介しても行えます。つまり、AWX/Towerを他のシステムと統合したり、インターフェースで通常実行するアクションをスクリプト化したりできます。
- **データベース**: AWX/Towerは、構成、ジョブ結果、その他の必要な運用データを保存するためにデータベース（通常はPostgreSQL）を使用します。
- **RabbitMQ**: これは、AWX/Towerが異なるコンポーネント間、特にWebサービスとタスクランナー間で通信するために使用するメッセージングシステムです。
- **Redis**: Redisは、キャッシュおよびタスクキューのバックエンドとして機能します。

### 論理コンポーネント

- **インベントリ**: インベントリは、**ジョブ**（Ansibleプレイブック）を**実行**できる**ホスト（またはノード）のコレクション**です。AWX/Towerは、インベントリを定義およびグループ化することを許可し、AWS、Azureなどの他のシステムから**ホストリストを取得する**動的インベントリもサポートしています。
- **プロジェクト**: プロジェクトは、**バージョン管理システム**（Gitなど）から取得した**Ansibleプレイブックのコレクション**です。必要に応じて最新のプレイブックを取得します。
- **テンプレート**: ジョブテンプレートは、**特定のプレイブックがどのように実行されるか**を定義し、ジョブのための**インベントリ**、**資格情報**、およびその他の**パラメータ**を指定します。
- **資格情報**: AWX/Towerは、SSHキー、パスワード、APIトークンなどの秘密を**管理および保存する**安全な方法を提供します。これらの資格情報は、プレイブックが実行されるときに必要なアクセスを持つように、ジョブテンプレートに関連付けることができます。
- **タスクエンジン**: ここで魔法が起こります。タスクエンジンはAnsibleに基づいて構築されており、**プレイブックを実行する**責任があります。ジョブはタスクエンジンに送信され、指定されたインベントリに対して指定された資格情報を使用してAnsibleプレイブックが実行されます。
- **スケジューラーとコールバック**: これらはAWX/Towerの高度な機能で、**ジョブを特定の時間にスケジュール**したり、外部イベントによってトリガーしたりできます。
- **通知**: AWX/Towerは、ジョブの成功または失敗に基づいて通知を送信できます。メール、Slackメッセージ、Webhookなど、さまざまな通知手段をサポートしています。
- **Ansibleプレイブック**: Ansibleプレイブックは、構成、デプロイメント、およびオーケストレーションツールです。自動化された再現可能な方法でシステムの望ましい状態を記述します。YAMLで記述され、プレイブックはAnsibleの宣言型自動化言語を使用して、実行する必要がある構成、タスク、およびステップを記述します。

### ジョブ実行フロー

1. **ユーザーインタラクション**: ユーザーは、**Webインターフェース**または**REST API**を介してAWX/Towerと対話できます。これにより、AWX/Towerが提供するすべての機能にフロントエンドアクセスが提供されます。
2. **ジョブの開始**:
- ユーザーは、WebインターフェースまたはAPIを介して、**ジョブテンプレート**に基づいてジョブを開始します。
- ジョブテンプレートには、**インベントリ**、**プロジェクト**（プレイブックを含む）、および**資格情報**への参照が含まれています。
- ジョブの開始時に、実行のためにジョブをキューに入れるリクエストがAWX/Towerのバックエンドに送信されます。
3. **ジョブのキューイング**:
- **RabbitMQ**は、Webコンポーネントとタスクランナー間のメッセージングを処理します。ジョブが開始されると、RabbitMQを使用してタスクエンジンにメッセージが送信されます。
- **Redis**は、実行待ちのキューに入れられたジョブを管理するタスクキューのバックエンドとして機能します。
4. **ジョブの実行**:
- **タスクエンジン**がキューに入れられたジョブを取得します。タスクエンジンは、ジョブに関連付けられたプレイブック、インベントリ、および資格情報に関する必要な情報を**データベース**から取得します。
- 関連する**プロジェクト**から取得したAnsibleプレイブックを使用して、タスクエンジンは指定された**インベントリ**ノードに対して提供された**資格情報**を使用してプレイブックを実行します。
- プレイブックが実行されると、その実行出力（ログ、ファクトなど）がキャプチャされ、**データベース**に保存されます。
5. **ジョブ結果**:
- プレイブックの実行が終了すると、結果（成功、失敗、ログ）が**データベース**に保存されます。
- ユーザーは、Webインターフェースを介して結果を表示したり、REST APIを介してクエリを実行したりできます。
- ジョブの結果に基づいて、**通知**が送信され、ユーザーや外部システムにジョブの状態を通知できます。通知はメール、Slackメッセージ、Webhookなどです。
6. **外部システムとの統合**:
- **インベントリ**は外部システムから動的に取得でき、AWX/TowerはAWS、Azure、VMwareなどのソースからホストを取得できます。
- **プロジェクト**（プレイブック）はバージョン管理システムから取得でき、ジョブ実行中に最新のプレイブックを使用することが保証されます。
- **スケジューラーとコールバック**は、他のシステムやツールと統合するために使用でき、AWX/Towerが外部トリガーに反応したり、事前に決められた時間にジョブを実行したりします。

### AWXラボの作成とテスト

[**ドキュメントに従って**](https://github.com/ansible/awx/blob/devel/tools/docker-compose/README.md)、docker-composeを使用してAWXを実行することが可能です:
```bash
git clone -b x.y.z https://github.com/ansible/awx.git # Get in x.y.z the latest release version

cd awx

# Build
make docker-compose-build

# Run
make docker-compose

# Or to create a more complex env
MAIN_NODE_TYPE=control EXECUTION_NODE_COUNT=2 COMPOSE_TAG=devel make docker-compose

# Clean and build the UI
docker exec tools_awx_1 make clean-ui ui-devel

# Once migrations are completed and the UI is built, you can begin using AWX. The UI can be reached in your browser at https://localhost:8043/#/home, and the API can be found at https://localhost:8043/api/v2.

# Create an admin user
docker exec -ti tools_awx_1 awx-manage createsuperuser

# Load demo data
docker exec tools_awx_1 awx-manage create_preload_data
```
## RBAC

### Supported roles

最も特権のある役割は**System Administrator**と呼ばれています。この役割を持つ者は**何でも変更することができます**。

**ホワイトボックスセキュリティ**レビューでは、**System Auditor role**が必要で、これにより**すべてのシステムデータを表示**できますが、変更はできません。別の選択肢として**Organization Auditor role**を取得することもできますが、前者を取得する方が良いでしょう。

<details>

<summary>利用可能な役割の詳細な説明を表示するにはここを展開してください</summary>

1. **System Administrator**:
- これは、システム内の任意のリソースにアクセスし、変更する権限を持つスーパーユーザーの役割です。
- 彼らはすべての組織、チーム、プロジェクト、インベントリ、ジョブテンプレートなどを管理できます。
2. **System Auditor**:
- この役割を持つユーザーは、すべてのシステムデータを表示できますが、変更はできません。
- この役割は、コンプライアンスと監視のために設計されています。
3. **Organization Roles**:
- **Admin**: 組織のリソースに対する完全な制御。
- **Auditor**: 組織のリソースへの表示専用アクセス。
- **Member**: 特定の権限なしで組織の基本メンバーシップ。
- **Execute**: 組織内でジョブテンプレートを実行できます。
- **Read**: 組織のリソースを表示できます。
4. **Project Roles**:
- **Admin**: プロジェクトを管理および変更できます。
- **Use**: ジョブテンプレートでプロジェクトを使用できます。
- **Update**: SCM（ソース管理）を使用してプロジェクトを更新できます。
5. **Inventory Roles**:
- **Admin**: インベントリを管理および変更できます。
- **Ad Hoc**: インベントリ上でアドホックコマンドを実行できます。
- **Update**: インベントリソースを更新できます。
- **Use**: ジョブテンプレートでインベントリを使用できます。
- **Read**: 表示専用アクセス。
6. **Job Template Roles**:
- **Admin**: ジョブテンプレートを管理および変更できます。
- **Execute**: ジョブを実行できます。
- **Read**: 表示専用アクセス。
7. **Credential Roles**:
- **Admin**: 資格情報を管理および変更できます。
- **Use**: ジョブテンプレートやその他の関連リソースで資格情報を使用できます。
- **Read**: 表示専用アクセス。
8. **Team Roles**:
- **Member**: チームの一部ですが、特定の権限はありません。
- **Admin**: チームのメンバーと関連リソースを管理できます。
9. **Workflow Roles**:
- **Admin**: ワークフローを管理および変更できます。
- **Execute**: ワークフローを実行できます。
- **Read**: 表示専用アクセス。

</details>

{{#include ../banners/hacktricks-training.md}}
