# Pentesting CI/CD Metodologie

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS staan vir **Version Control System**, hierdie stelsels laat ontwikkelaars toe om hul **bronkode te bestuur**. Die mees algemene is **git** en jy sal gewoonlik maatskappye vind wat dit gebruik op een van die volgende **platforms**:

- Github
- Gitlab
- Bitbucket
- Gitea
- Gitblit
- Cloud providers (they offer their own VCS platforms)


## CI/CD Pipelines

CI/CD pipelines stel ontwikkelaars in staat om die **uitvoering van kode te outomatiseer** vir verskeie doeleindes, insluitend bou, toetsing en ontplooiing van toepassings. Hierdie geoutomatiseerde workflows word **getriggers deur spesifieke aksies**, soos code pushes, pull requests of geskeduleerde take. Hulle help om die proses van ontwikkeling na produksie te stroomlyn.

Hierdie stelsels moet egter **ergens uitgevoer word** en gewoonlik met **bevoorregte credentials om kode te ontplooi of sensitiewe inligting te bereik**.

## VCS Pentesting Metodologie

> [!NOTE]
> Selfs al laat sommige VCS platforms toe om pipelines te skep, gaan ons in hierdie afdeling slegs potensiële aanvalle ontleed wat op die beheer van die bronkode fokus.

Platforme wat die bronkode van jou projek bevat, hou sensitiewe inligting en mense moet baie versigtig wees met die permissies wat binne hierdie platform gegee word. Dit is 'n paar algemene probleme oor VCS-platforms wat 'n aanvaller kan misbruik:

- **Leaks**: If your code contains leaks in the commits and the attacker can access the repo (because it's public or because he has access), he could discover the leaks.
- **Toegang**: As 'n aanvaller toegang tot 'n rekening binne die VCS-platform kry, kan hy **meer sigbaarheid en permissies** verkry.
- **Registrasie**: Sommige platforms laat bloot eksterne gebruikers toe om 'n rekening te skep.
- **SSO**: Sommige platforms sal gebruikers nie toelaat om te registreer nie, maar sal enigiemand met 'n geldige SSO toelaat om in te gaan (byvoorbeeld 'n aanvaller kan sy Github-rekening gebruik om toegang te kry).
- **Credentials**: Username+Pwd, personal tokens, ssh keys, Oauth tokens, cookies... daar is verskeie soorte tokens wat 'n gebruiker kan steel om op een of ander manier toegang tot 'n repo te kry.
- **Webhooks**: VCS platforms laat toe om webhooks te genereer. As hulle **nie beskerm** is met nie-sigbare secrets nie, **kan 'n aanvaller hulle misbruik**.
- As geen geheim in plek is nie, kan die aanvaller die webhook van die derdeparty-platform misbruik.
- As die geheim in die URL is, gebeur dieselfde en die aanvaller het ook die geheim.
- **Code compromise:** As 'n kwaadwillige akteur 'n vorm van **write** toegang oor die repos het, kan hy probeer om **kwaadaardige kode te inject**. Om suksesvol te wees, mag hy nodig hê om **branch protections te omseil**. Hierdie aksies kan met verskillende doelwitte uitgevoer word:
  - Kompromitteer die main branch om **produksie te kompromitteer**.
  - Kompromitteer die main (of ander branches) om **ontwikkelaars se masjiene te kompromitteer** (aangesien hulle gewoonlik toetse, terraform of ander dinge binne die repo op hul masjiene uitvoer).
- **Kompromitteer die pipeline** (sien volgende afdeling)

## Pipelines Pentesting Metodologie

Die mees algemene manier om 'n pipeline te definieer, is deur 'n **CI-konfigurasielêer wat in die repository gehuisves is** te gebruik. Hierdie lêer beskryf die volgorde van uitgevoerde jobs, toestande wat die vloei beïnvloed, en bou-omgewinginstellings.\
Hierdie lêers het tipies 'n konsekwente naam en formaat, byvoorbeeld — Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), en die GitHub Actions YAML-lêers onder .github/workflows. Wanneer getrigger, sal die pipeline job die **kode pull** vanaf die gekose bron (bv. commit / branch), en **voer die opdragte wat in die CI-konfigurasielêer gespesifiseer is** teen daardie kode uit.

Dus is die uiteindelike doel van die aanvaller om op een of ander wyse daardie konfigurasielêers of die opdragte wat hulle uitvoer, te **kompromitteer**.

> [!TIP]
> Sommige gehoste builders laat contributors toe om die Docker build context en Dockerfile path te kies. As die context aanvallers-beheerd is, kan jy dit buite die repo stel (bv. "..") om host-lêers tydens build in te sluk en secrets uit te voer. Sien:
>
>{{#ref}}
>docker-build-context-abuse.md
>{{#endref}}

### PPE - Poisoned Pipeline Execution

Die Poisoned Pipeline Execution (PPE) pad benut permissies in 'n SCM-repository om 'n CI-pipeline te manipuleer en skadelike opdragte uit te voer. Gebruikers met die nodige permissies kan CI-konfigurasielêers of ander lêers wat deur die pipeline job gebruik word, wysig om kwaadwillige opdragte in te sluit. Dit "vergiftig" die CI-pipeline, wat tot die uitvoering van hierdie kwaadwillige opdragte lei.

Vir 'n kwaadwillige akteur om suksesvol 'n PPE-aanval uit te voer, moet hy in staat wees om:

- Skryf toegang te hê tot die VCS-platform, aangesien pipelines gewoonlik getrigger word wanneer 'n push of 'n pull request uitgevoer word. (Sien die VCS pentesting metodologie vir 'n opsomming van maniere om toegang te kry).
- Let wel dat soms 'n **eksterne PR as "skryf toegang" kan tel**.
- Selfs as hy skryfpermissies het, moet hy seker maak dat hy die CI-konfigurasielêer of ander lêers waarop die konfigurasie staatmaak, **kan wysig**.
- Hiervoor mag hy in staat wees om **branch protections te omseil**.

Daar is 3 PPE-variante:

- **D-PPE**: 'n **Direct PPE** aanval gebeur wanneer die akteur die **CI-konfig** lêer wysig wat uitgevoer gaan word.
- **I-DDE**: 'n **Indirect PPE** aanval gebeur wanneer die akteur 'n **lêer** wysig waarop die CI-konfig lêer wat uitgevoer gaan word, **verwys** (soos 'n make-lêer of 'n terraform-config).
- **Public PPE or 3PE**: In sommige gevalle kan pipelines **getrigger word deur gebruikers wat geen write toegang tot die repo het nie** (en wat moontlik nie eers deel van die org is nie) omdat hulle 'n PR kan stuur.
- **3PE Command Injection**: Gewoonlik stel CI/CD pipelines **omgewingveranderlikes** met **inligting oor die PR**. As daardie waarde deur 'n aanvaller beheer kan word (soos die titel van die PR) en dit in 'n **gevaarlike plek** gebruik word (soos die uitvoer van **sh commands**), kan 'n aanvaller **opdragte daarin inject**.

### Exploitation Benefits

Deur die 3 variante te ken om 'n pipeline te vergiftig, kom ons kyk wat 'n aanvaller kan verkry na 'n suksesvolle uitbuiting:

- **Secrets**: Soos reeds genoem, vereis pipelines **privileges** vir hul jobs (kode ophaal, bou, ontplooi, ens.) en hierdie privileges word gewoonlik in **secrets** gestoor. Hierdie secrets is tipies toeganklik via **env variables of lêers binne die stelsel**. Daarom sal 'n aanvaller altyd probeer om soveel secrets as moontlik uit te voer.
- Afhangende van die pipeline platform mag die aanvaller **moet spesifiseer watter secrets in die config** is. Dit beteken dat as die aanvaller nie die CI-konfigurasielêer kan wysig nie (**I-PPE** byvoorbeeld), hy slegs die secrets wat daardie pipeline het, kan exfiltrateer.
- **Rekenvermoë**: Die kode word elders uitgevoer; afhangende van waar dit uitgevoer word, mag 'n aanvaller verder kan pivot.
- **On-Premises**: As die pipelines op ondernemingsinfrastruktuur uitgevoer word, kan 'n aanvaller in 'n **interne netwerk met toegang tot meer hulpbronne** eindig.
- **Cloud**: Die aanvaller kan toegang kry tot **ander masjiene in die cloud** en ook IAM-rolle/service accounts **tokens** uit dwarsoor die omgewing exfiltrateer om verdere toegang in die cloud te bekom.
- **Platform se masjien**: Soms sal die jobs binne die **pipelines platform se masjiene** uitgevoer word, wat gewoonlik in 'n cloud sit en **geen verdere toegang** het nie.
- **Kies dit:** Soms het die **pipelines platform verskeie masjiene geconfigureer** en as jy die CI-konfigurasielêer kan wysig, kan jy aandui waar jy die kwaadwillige kode wil laat loop. In so 'n situasie sal 'n aanvaller waarskynlik 'n reverse shell op elke moontlike masjien laat loop om dit verder te probeer benut.
- **Kompromitteer produksie**: As jy binne die pipeline is en die finale weergawe daarvandaan gebou en ontplooi word, kan jy die kode wat in produksie gaan hardloop, **kompromitteer**.

## Meer relevante inligting

### Tools & CIS Benchmark

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) is 'n open-source hulpmiddel om jou software supply chain stack vir sekuriteitskompliance te oudit gebaseer op 'n nuwe [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). Die oudit fokus op die hele SDLC-proses, waar dit risiko's kan openbaar vanaf code-tyd tot ontplooiingstyd.

### Top 10 CI/CD Security Risk

Kyk na hierdie interessante artikel oor die top 10 CI/CD-risiko's volgens Cider: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

- Op elke platform wat jy plaaslik kan laat loop sal jy instruksies vind oor hoe om dit plaaslik te begin sodat jy dit kan konfigureer soos jy wil om dit te toets
- Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatic Tools

- [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** is 'n static code analysis tool vir infrastructure-as-code.

## References

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&utm_medium=github_page&utm_campaign=ci%2fcd%20goat_060422)


{{#include ../banners/hacktricks-training.md}}
