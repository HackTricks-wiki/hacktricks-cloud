# Pentesting CI/CD Методологія

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS означає **систему контролю версій**, ця система дозволяє розробникам **керувати своїм вихідним кодом**. Найпоширеніша — **git**, і зазвичай компанії використовують її на одній з наступних **платформ**:

- Github
- Gitlab
- Bitbucket
- Gitea
- Gitblit
- Провайдери хмар (вони пропонують власні VCS платформи)


## CI/CD Pipelines

CI/CD pipelines дозволяють розробникам **автоматизувати виконання коду** для різних цілей, включаючи збірку, тестування та розгортання додатків. Ці автоматизовані робочі процеси **тригеряться певними діями**, такими як push коду, pull request або заплановані завдання. Вони корисні для оптимізації процесу від розробки до продакшну.

Однак ці системи потрібно **дещо запускати десь**, і зазвичай з **привілейованими обліковими даними для деплою коду або доступу до чутливої інформації**.

## VCS Pentesting Методологія

> [!NOTE]
> Навіть якщо деякі VCS платформи дозволяють створювати pipelines для цього розділу, ми будемо аналізувати лише потенційні атаки на контроль над вихідним кодом.

Платформи, що містять вихідний код вашого проєкту, містять чутливу інформацію, і потрібно дуже ретельно ставитися до прав, що надаються в цій платформі. Ось деякі поширені проблеми на VCS платформах, які може використати зловмисник:

- **Leaks**: Якщо ваш код містить leak у комітах і нападник може отримати доступ до репозиторію (бо він публічний або бо він має доступ), він може виявити ці leak.
- **Access**: Якщо нападник може **отримати доступ до облікового запису в VCS платформі**, він може здобути **більше видимості та прав**.
- **Register**: Деякі платформи просто дозволяють зовнішнім користувачам створювати обліковий запис.
- **SSO**: Деякі платформи не дозволяють реєстрацію, але дозволяють будь-кому увійти через дійсний SSO (тому нападник, наприклад, може використати свій github акаунт для входу).
- **Credentials**: Username+Pwd, personal tokens, ssh keys, Oauth tokens, cookies... існує кілька типів токенів, які користувач може вкрасти, щоб у такий чи інший спосіб отримати доступ до репо.
- **Webhooks**: VCS платформи дозволяють генерувати webhooks. Якщо вони **не захищені** невидимими секретами, **нападник може ними зловживати**.
- Якщо секрету немає, нападник може зловживати webhook третьої сторони.
- Якщо секрет знаходиться в URL, трапляється те саме і нападник також отримує секрет.
- **Code compromise:** Якщо зловмисник має якийсь рівень **запису (write)** у репозиторіях, він може спробувати **інжектувати шкідливий код**. Щоб бути успішним, йому може знадобитися **обійти branch protections**. Ці дії можуть виконуватися з різними цілями:
  - Скомпрометувати main branch, щоб **скомпрометувати production**.
  - Скомпрометувати main (або інші branch) щоб **скомпрометувати машини розробників** (оскільки вони зазвичай виконують тести, terraform чи інше всередині репо на своїх машинах).
- **Compromise the pipeline** (див. наступний розділ)

## Pipelines Pentesting Методологія

Найпоширеніший спосіб визначити pipeline — використати **CI configuration file, розміщений в репозиторії**, який збирається. Цей файл описує порядок виконуваних jobs, умови, що впливають на потік, та налаштування середовища збірки.\
Ці файли зазвичай мають усталені імена й формати, наприклад — Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), та GitHub Actions YAML файли в .github/workflows. Коли pipeline тригериться, job **забирає код** з обраного джерела (наприклад commit / branch) і **виконує команди, вказані в CI конфігураційному файлі**, над цим кодом.

Отже кінцева мета нападника — якимось чином **скомпрометувати ці конфігураційні файли** або **команди, які вони виконують**.

### PPE - Poisoned Pipeline Execution

The Poisoned Pipeline Execution (PPE) path exploits permissions in an SCM repository to manipulate a CI pipeline and execute harmful commands. Users with the necessary permissions can modify CI configuration files or other files used by the pipeline job to include malicious commands. This "poisons" the CI pipeline, leading to the execution of these malicious commands.

For a malicious actor to be successful performing a PPE attack he needs to be able to:

- Have **write access to the VCS platform**, as usually pipelines are triggered when a push or a pull request is performed. (Check the VCS pentesting methodology for a summary of ways to get access).
- Note that sometimes an **external PR count as "write access"**.
- Even if he has write permissions, he needs to be sure he can **modify the CI config file or other files the config is relying on**.
- For this, he might need to be able to **bypass branch protections**.

There are 3 PPE flavours:

- **D-PPE**: A **Direct PPE** attack occurs when the actor **modifies the CI config** file that is going to be executed.
- **I-DDE**: An **Indirect PPE** attack occurs when the actor **modifies** a **file** the CI config file that is going to be executed **relays on** (like a make file or a terraform config).
- **Public PPE or 3PE**: In some cases the pipelines can be **triggered by users that doesn't have write access in the repo** (and that might not even be part of the org) because they can send a PR.
- **3PE Command Injection**: Usually, CI/CD pipelines will **set environment variables** with **information about the PR**. If that value can be controlled by an attacker (like the title of the PR) and is **used** in a **dangerous place** (like executing **sh commands**), an attacker might **inject commands in there**.

### Exploitation Benefits

Knowing the 3 flavours to poison a pipeline, lets check what an attacker could obtain after a successful exploitation:

- **Secrets**: Як згадувалося раніше, pipelines вимагають **привілеїв** для своїх job-ів (отримати код, зібрати його, задеплоїти тощо), і ці привілеї зазвичай **надаються у вигляді секретів**. Ці секрети зазвичай доступні через **env variables або файли всередині системи**. Тому нападник завжди буде намагатися ексфільтрувати якомога більше секретів.
- Залежно від платформи pipeline, нападнику **може знадобитися вказати секрети в конфігу**. Це означає, що якщо нападник не може модифікувати CI конфігурацію pipeline (наприклад I-PPE), він може **експфільтрувати лише ті секрети, які має цей pipeline**.
- **Computation**: Код виконується десь; залежно від того, де він виконується, нападник може мати можливість пересунутися далі.
- **On-Premises**: Якщо pipelines виконуються on-premises, нападник може опинитися в **внутрішній мережі з доступом до додаткових ресурсів**.
- **Cloud**: Нападник може отримати доступ до **інших машин у хмарі**, а також може **ексфільтрувати** токени IAM ролей/сервісних акаунтів, щоб здобути **подальший доступ у хмарі**.
- **Platforms machine**: Іноді job-и виконуються на **машинах платформи pipeline**, які зазвичай знаходяться в хмарі й не мають додаткового доступу.
- **Select it:** Іноді **платформа pipeline має декілька типів машин**, і якщо ви можете **модифікувати CI конфігураційний файл**, ви можете **вказати, де запускати шкідливий код**. У цьому випадку нападник, ймовірно, запустить зворотний шелл на кожній можливій машині, щоб спробувати розширити експлуатацію.
- **Compromise production**: Якщо ви всередині pipeline і фінальна версія будується та задеплоюється звідти, ви можете **скомпрометувати код, який потрапить у production**.

## More relevant info

### Tools & CIS Benchmark

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) is an open-source tool for auditing your software supply chain stack for security compliance based on a new [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). The auditing focuses on the entire SDLC process, where it can reveal risks from code time into deploy time.

### Top 10 CI/CD Security Risk

Check this interesting article about the top 10 CI/CD risks according to Cider: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

- На кожній платформі, яку ви можете запускати локально, ви знайдете інструкції, як її запустити локально, щоб налаштувати її на тестування.
- Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatic Tools

- [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** — це інструмент статичного аналізу коду для infrastructure-as-code.

## References

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&utm_medium=github_page&utm_campaign=ci%2fcd%20goat_060422)


{{#include ../banners/hacktricks-training.md}}
