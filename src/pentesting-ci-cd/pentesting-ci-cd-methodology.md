# Pentesting CI/CD Methodology

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS는 **Version Control System**의 약자로, 개발자가 **소스 코드를 관리**할 수 있게 해줍니다. 가장 일반적인 것은 **git**이며 보통 다음과 같은 **플랫폼** 중 하나에서 사용됩니다:

- Github
- Gitlab
- Bitbucket
- Gitea
- Gitblit
- Cloud providers (they offer their own VCS platforms)


## CI/CD Pipelines

CI/CD pipelines는 개발자가 애플리케이션을 빌드, 테스트, 배포하는 등 다양한 목적을 위해 **코드 실행을 자동화**할 수 있게 합니다. 이러한 자동화된 워크플로우는 코드 푸시, 풀 리퀘스트 또는 예약 작업과 같은 **특정 동작에 의해 트리거**됩니다. 이는 개발에서 운영까지의 과정을 간소화하는 데 유용합니다.

하지만 이러한 시스템은 **어디선가 실행되어야 하며**, 일반적으로 **코드를 배포하거나 민감한 정보에 접근하기 위한 권한이 있는 자격증명으로 실행**됩니다.

## VCS Pentesting Methodology

> [!NOTE]
> 일부 VCS 플랫폼이 이 섹션을 위해 파이프라인을 생성하도록 허용하더라도, 여기서는 소스 코드의 제어에 대한 잠재적 공격만 분석합니다.

프로젝트의 소스 코드를 포함하는 플랫폼에는 민감한 정보가 포함되어 있으므로 플랫폼 내 권한 관리를 매우 신중하게 해야 합니다. 공격자가 악용할 수 있는 VCS 플랫폼 전반의 일반적인 문제는 다음과 같습니다:

- **Leaks**: 코드에 leaks가 커밋에 포함되어 있고 공격자가 저장소에 접근할 수 있다면(공개이거나 접근 권한이 있는 경우) 해당 leaks를 발견할 수 있습니다.
- **Access**: 공격자가 **VCS 플랫폼 내의 계정에 접근**할 수 있다면 더 많은 가시성과 권한을 얻을 수 있습니다.
- **Register**: 일부 플랫폼은 외부 사용자가 계정을 생성할 수 있게 허용합니다.
- **SSO**: 일부 플랫폼은 사용자가 등록하는 것을 허용하지 않지만 유효한 SSO로는 누구나 접근할 수 있게 하는 경우가 있습니다(예: 공격자가 자신의 github 계정으로 접근).
- **Credentials**: Username+Pwd, personal tokens, ssh keys, Oauth tokens, cookies... 사용자가 저장소에 어떤 방식으로든 접근하기 위해 훔칠 수 있는 다양한 종류의 토큰이 있습니다.
- **Webhooks**: VCS 플랫폼은 webhooks를 생성할 수 있게 합니다. 만약 이들이 보이지 않는 비밀값으로 **보호되지 않았다면 공격자가 이를 악용할 수 있습니다**.
- If no secret is in place, the attacker could abuse the webhook of the third party platform
- If the secret is in the URL, the same happens and the attacker also have the secret
- **Code compromise:** 악의적인 행위자가 레포에 대해 어떤 형태의 **쓰기** 권한을 가지고 있다면 악성 코드를 **주입**하려 할 수 있습니다. 성공하려면 **branch protections를 우회**해야 할 수 있습니다. 이러한 동작은 다양한 목적을 위해 수행될 수 있습니다:
  - 메인 브랜치를 손상시켜 **production을 침해**.
  - 메인(또는 다른) 브랜치를 손상시켜 **개발자 머신을 침해**(개발자들이 테스트, terraform 또는 다른 작업을 저장소 내에서 실행하는 경우).
- **Compromise the pipeline** (check next section)

## Pipelines Pentesting Methodology

파이프라인을 정의하는 가장 일반적인 방법은 **저장소에 호스팅된 CI 구성 파일**을 사용하는 것입니다. 이 파일은 실행되는 작업의 순서, 흐름에 영향을 미치는 조건 및 빌드 환경 설정을 설명합니다.\
이 파일들은 일반적으로 일관된 이름과 형식을 가지며 예를 들어 — Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), 그리고 .github/workflows 아래의 GitHub Actions YAML 파일들이 있습니다. 트리거되면 파이프라인 작업은 선택된 소스(예: 커밋/브랜치)에서 **코드를 pull**하고, CI 구성 파일에 명시된 **명령을 해당 코드에 대해 실행**합니다.

따라서 공격자의 궁극적 목표는 어떻게든 이러한 구성 파일이나 **실행되는 명령**을 **손상시키는 것**입니다.

### PPE - Poisoned Pipeline Execution

The Poisoned Pipeline Execution (PPE) 경로는 SCM 저장소의 권한을 악용하여 CI 파이프라인을 조작하고 해로운 명령을 실행하게 합니다. 필요한 권한을 가진 사용자는 CI 구성 파일이나 파이프라인 작업에서 사용하는 다른 파일을 수정해 악성 명령을 포함시킬 수 있습니다. 이렇게 CI 파이프라인이 "poison"되면 이 악성 명령들이 실행됩니다.

악의적 행위자가 PPE 공격을 성공적으로 수행하려면 다음이 필요합니다:

- 일반적으로 파이프라인은 push나 pull request 시 트리거되므로 **VCS 플랫폼에 대한 write access**가 있어야 합니다. (VCS pentesting methodology에서 접근 방법 요약을 확인하세요).
- 때때로 **외부 PR도 "write access"로 간주될 수 있습니다**.
- 쓰기 권한이 있더라도 CI 구성 파일 또는 구성에서 의존하는 다른 파일을 **수정할 수 있어야** 합니다.
- 이를 위해서는 **branch protections를 우회할 수 있어야** 할 수 있습니다.

PPE에는 3가지 변형이 있습니다:

- **D-PPE**: **Direct PPE** 공격은 공격자가 **실행될 CI config** 파일을 **직접 수정**할 때 발생합니다.
- **I-DDE**: **Indirect PPE** 공격은 공격자가 CI config 파일이 **의존하는 파일**(예: make 파일이나 terraform 구성)을 **수정**할 때 발생합니다.
- **Public PPE or 3PE**: 경우에 따라 파이프라인은 저장소에 write access가 없는 사용자(조직의 일원이 아닐 수도 있음)도 PR을 보낼 수 있기 때문에 **이들에 의해 트리거될 수 있습니다**.
- **3PE Command Injection**: 보통 CI/CD 파이프라인은 PR에 대한 정보로 **환경 변수를 설정**합니다. 만약 그 값이 공격자에 의해 제어될 수 있고(예: PR 제목) **위험한 위치**(예: **sh 명령 실행**)에서 **사용**된다면 공격자는 그 안에 **명령을 주입**할 수 있습니다.

### Exploitation Benefits

PPE의 3가지 변형을 알았으니, 성공적인 악용 후 공격자가 얻을 수 있는 것을 살펴봅시다:

- **Secrets**: 앞서 언급했듯이 파이프라인 작업은 (코드 가져오기, 빌드, 배포 등) **권한**이 필요하며 이러한 권한은 일반적으로 **secrets**으로 부여됩니다. 이 secrets는 보통 **env 변수나 시스템 내 파일**을 통해 접근 가능하므로 공격자는 가능한 한 많은 secrets를 항상 유출하려 할 것입니다.
- 파이프라인 플랫폼에 따라 공격자는 **구성에서 secrets를 명시해야 할 수도** 있습니다. 이는 공격자가 CI 구성 파이프라인을 수정할 수 없다면(**I-PPE** 등) 해당 파이프라인이 가진 **secrets만 유출할 수 있다**는 의미입니다.
- **Computation**: 코드는 어딘가에서 실행되며 실행 위치에 따라 공격자는 더 멀리 피벗할 수 있습니다.
- **On-Premises**: 파이프라인이 온프레미스에서 실행된다면 공격자는 **내부 네트워크에 침투하여 더 많은 자원에 접근**할 수 있습니다.
- **Cloud**: 공격자는 클라우드 내 다른 머신에 접근할 수 있고, IAM roles/service accounts **tokens**을 탈취해 클라우드 내부에서 **추가 권한을 획득**할 수 있습니다.
- **Platforms machine**: 때로 작업은 **파이프라인 플랫폼의 머신** 내에서 실행되며, 이는 대개 추가 접근 권한이 없는 클라우드 상의 격리된 환경일 수 있습니다.
- **Select it:** 때로는 **파이프라인 플랫폼이 여러 머신을 구성**해 두고 있으며 CI 구성 파일을 수정할 수 있다면 **악성 코드를 어떤 머신에서 실행할지 지정**할 수 있습니다. 이런 경우 공격자는 가능한 각 머신에 리버스 셸을 열어 추가 취약점을 노릴 것입니다.
- **Compromise production**: 파이프라인 내부에 침투해 최종 버전이 거기서 빌드되어 배포된다면, 운영 환경에서 실행될 코드를 **침해할 수 있습니다**.

## More relevant info

### Tools & CIS Benchmark

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) 는 새로운 [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf)를 기반으로 소프트웨어 공급망 스택의 보안 준수를 감 audit하는 오픈소스 도구입니다. 이 감사는 전체 SDLC 프로세스에 초점을 맞추며, 코드 시점부터 배포 시점까지의 위험을 드러낼 수 있습니다.

### Top 10 CI/CD Security Risk

Cider에 따르면 상위 10개의 CI/CD 리스크에 관한 흥미로운 기사: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

- 로컬에서 실행할 수 있는 각 플랫폼에 대해 로컬로 실행하는 방법이 제공되어 원하는 대로 구성하여 테스트할 수 있습니다.
- Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatic Tools

- [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov**는 infrastructure-as-code에 대한 정적 코드 분석 도구입니다.

## References

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&utm_medium=github_page&utm_campaign=ci%2fcd%20goat_060422)


{{#include ../banners/hacktricks-training.md}}
