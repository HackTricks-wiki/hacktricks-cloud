# Méthodologie Pentesting CI/CD

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS signifie **système de contrôle de version**, ce système permet aux développeurs de **gérer leur code source**. Le plus courant est **git** et vous trouverez généralement des entreprises qui l'utilisent sur l'une des **plateformes** suivantes :

- Github
- Gitlab
- Bitbucket
- Gitea
- Gitblit
- Fournisseurs Cloud (ils offrent leurs propres plateformes VCS)


## CI/CD Pipelines

Les pipelines CI/CD permettent aux développeurs d'**automatiser l'exécution du code** pour divers objectifs, notamment la compilation, les tests et le déploiement des applications. Ces workflows automatisés sont **déclenchés par des actions spécifiques**, telles que des push de code, des pull requests ou des tâches planifiées. Ils servent à rationaliser le processus du développement à la production.

Cependant, ces systèmes doivent être **exécutés quelque part** et généralement avec des **identifiants privilégiés pour déployer du code ou accéder à des informations sensibles**.

## VCS Pentesting Methodology

> [!NOTE]
> Même si certaines plateformes VCS permettent de créer des pipelines pour cette section, nous allons analyser uniquement les attaques potentielles visant le contrôle du code source.

Les plateformes qui contiennent le code source de votre projet renferment des informations sensibles et il faut être très vigilant avec les permissions accordées au sein de ces plateformes. Voici quelques problèmes courants sur les plateformes VCS que des attaquants pourraient exploiter :

- **Leaks** : Si votre code contient des leaks dans les commits et que l'attaquant peut accéder au repo (parce qu'il est public ou parce qu'il a un accès), il pourrait découvrir les leaks.
- **Accès** : Si un attaquant peut **accéder à un compte au sein de la plateforme VCS**, il pourrait obtenir **plus de visibilité et de permissions**.
- **Enregistrement** : Certaines plateformes permettent simplement aux utilisateurs externes de créer un compte.
- **SSO** : Certaines plateformes n'autorisent pas l'enregistrement, mais permettent à quiconque de se connecter avec un SSO valide (donc un attaquant pourrait utiliser son compte github pour entrer, par exemple).
- **Credentials** : Username+Pwd, personal tokens, ssh keys, Oauth tokens, cookies... il existe plusieurs types de tokens qu'un utilisateur pourrait voler pour accéder d'une manière ou d'une autre à un repo.
- **Webhooks** : Les plateformes VCS permettent de générer des webhooks. S'ils ne sont **pas protégés** par des secrets non visibles, un **attaquant pourrait en abuser**.
- Si aucun secret n'est en place, l'attaquant pourrait abuser du webhook de la plateforme tierce.
- Si le secret est dans l'URL, la même chose se produit et l'attaquant possède aussi le secret.
- **Compromission du code :** Si un acteur malveillant a un certain type d'**accès en écriture** sur les repos, il pourrait tenter d'**injecter du code malveillant**. Pour réussir, il pourrait devoir **contourner les protections de branche**. Ces actions peuvent être réalisées avec différents objectifs :
  - Compromettre la branche principale pour **compromettre la production**.
  - Compromettre la branche principale (ou d'autres branches) pour **compromettre les machines des développeurs** (car ils exécutent généralement des tests, terraform ou d'autres choses depuis le repo sur leurs machines).
  - **Compromettre le pipeline** (voir section suivante)

## Pipelines Pentesting Methodology

La façon la plus courante de définir un pipeline est d'utiliser un **fichier de configuration CI hébergé dans le repository** que le pipeline construit. Ce fichier décrit l'ordre des jobs exécutés, les conditions qui affectent le flux et les paramètres de l'environnement de build.\
Ces fichiers ont typiquement un nom et un format cohérents, par exemple — Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), et les fichiers YAML GitHub Actions situés sous .github/workflows. Lorsqu'il est déclenché, le job du pipeline **récupère le code** depuis la source sélectionnée (par ex. commit / branch), et **exécute les commandes spécifiées dans le fichier de configuration CI** sur ce code.

Par conséquent, l'objectif ultime de l'attaquant est d'une manière ou d'une autre de **compromettre ces fichiers de configuration** ou les **commandes qu'ils exécutent**.

> [!TIP]
> Certains builders hébergés laissent les contributeurs choisir le Docker build context et le chemin du Dockerfile. Si le context est contrôlé par l'attaquant, vous pouvez le définir en dehors du repo (p.ex., "..") pour ingérer des fichiers hôtes pendant le build et exfiltrer des secrets. Voir :
>
>{{#ref}}
>docker-build-context-abuse.md
>{{#endref}}

### PPE - Poisoned Pipeline Execution

Le chemin Poisoned Pipeline Execution (PPE) exploite des permissions dans un repository SCM pour manipuler un pipeline CI et exécuter des commandes nuisibles. Les utilisateurs disposant des permissions nécessaires peuvent modifier les fichiers de configuration CI ou d'autres fichiers utilisés par le job du pipeline pour y inclure des commandes malveillantes. Cela "empoisonne" le pipeline CI, conduisant à l'exécution de ces commandes malveillantes.

Pour qu'un acteur malveillant réussisse une attaque PPE, il doit :

- Avoir **un accès en écriture à la plateforme VCS**, car en général les pipelines sont déclenchés lorsqu'un push ou une pull request est effectué. (Consultez la méthodologie VCS pour un résumé des moyens d'obtenir un accès).
- Notez que parfois une **PR externe compte comme un "write access"**.
- Même s'il a des permissions d'écriture, il doit s'assurer qu'il peut **modifier le fichier de config CI ou d'autres fichiers dont la config dépend**.
- Pour cela, il pourrait devoir être capable de **contourner les protections de branche**.

Il existe 3 variantes de PPE :

- **D-PPE** : Une attaque **Direct PPE** se produit lorsque l'acteur **modifie le fichier de config CI** qui sera exécuté.
- **I-DDE** : Une attaque **Indirect PPE** se produit lorsque l'acteur **modifie** un **fichier** sur lequel le fichier de config CI s'appuie (comme un makefile ou une config terraform).
- **Public PPE ou 3PE** : Dans certains cas, les pipelines peuvent être **déclenchés par des utilisateurs qui n'ont pas d'accès en écriture au repo** (et qui ne font peut‑être même pas partie de l'org) parce qu'ils peuvent envoyer une PR.
- **3PE Command Injection** : Habituellement, les pipelines CI/CD vont **définir des variables d'environnement** avec **des informations sur la PR**. Si cette valeur peut être contrôlée par un attaquant (comme le titre de la PR) et qu'elle est **utilisée** dans un **endroit dangereux** (comme l'exécution de commandes sh), un attaquant pourrait **y injecter des commandes**.

### Exploitation Benefits

Connaissant les 3 variantes pour empoisonner un pipeline, voyons ce qu'un attaquant pourrait obtenir après une exploitation réussie :

- **Secrets** : Comme mentionné précédemment, les pipelines requièrent des **privilèges** pour leurs jobs (récupérer le code, le builder, le déployer...) et ces privilèges sont généralement stockés en **secrets**. Ces secrets sont souvent accessibles via des **variables d'environnement ou des fichiers dans le système**. Par conséquent, un attaquant cherchera toujours à exfiltrer un maximum de secrets.
- Selon la plateforme de pipeline, l'attaquant **pourrait devoir spécifier les secrets dans la config**. Cela signifie que si l'attaquant ne peut pas modifier la configuration CI (**I-PPE** par exemple), il pourrait **seulement exfiltrer les secrets que le pipeline possède**.
- **Computation** : Le code s'exécute quelque part ; selon l'endroit d'exécution, un attaquant pourrait être en mesure de pivoter plus loin.
- **On-Premises** : Si les pipelines sont exécutés on-premises, un attaquant pourrait se retrouver dans un **réseau interne avec accès à davantage de ressources**.
- **Cloud** : L'attaquant pourrait accéder **à d'autres machines dans le cloud** mais aussi pourrait **exfiltrer** des tokens de rôles IAM / service accounts **pour obtenir davantage d'accès dans le cloud**.
- **Machines de la plateforme** : Parfois les jobs seront exécutés dans les **machines de la plateforme de pipelines**, qui sont généralement dans un cloud avec **aucun accès supplémentaire**.
- **Choisir la cible :** Parfois la **plateforme de pipelines aura configuré plusieurs machines** et si vous pouvez **modifier le fichier de configuration CI** vous pouvez **indiquer où vous voulez exécuter le code malveillant**. Dans ce cas, un attaquant lancera probablement une reverse shell sur chaque machine possible pour tenter de l'exploiter davantage.
- **Compromettre la production** : Si vous êtes à l'intérieur du pipeline et que la version finale est construite et déployée depuis celui-ci, vous pourriez **compromettre le code qui sera exécuté en production**.

## More relevant info

### Tools & CIS Benchmark

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) est un outil open-source pour auditer votre stack de supply chain logicielle pour la conformité de sécurité basé sur un nouveau [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). L'audit se concentre sur l'ensemble du processus SDLC, où il peut révéler des risques depuis le temps du code jusqu'au temps de déploiement.

### Top 10 CI/CD Security Risk

Consultez cet article intéressant sur les top 10 risques CI/CD selon Cider : [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

- Sur chaque plateforme que vous pouvez exécuter localement, vous trouverez comment la lancer localement afin de la configurer comme vous le souhaitez pour la tester
- Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatic Tools

- [**Checkov**](https://github.com/bridgecrewio/checkov) : **Checkov** est un outil d'analyse statique pour l'infrastructure-as-code.

## References

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&utm_medium=github_page&utm_campaign=ci%2fcd%20goat_060422)


{{#include ../banners/hacktricks-training.md}}
