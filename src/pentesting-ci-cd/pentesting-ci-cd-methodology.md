# Pentesting CI/CD 方法論

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS は **Version Control System** の略で、開発者が **ソース code を管理する** ためのシステムです。最も一般的なのは **git** で、企業では通常次のいずれかの **platforms** を利用しています:

- Github
- Gitlab
- Bitbucket
- Gitea
- Gitblit
- Cloud providers（独自の VCS プラットフォームを提供していることが多い）

## CI/CD Pipelines

CI/CD pipelines は開発者が **code の実行を自動化する** のに使われます。ビルド、テスト、デプロイなどを目的として、コードの push、pull request、スケジュールされたタスクなどの **特定のアクションでトリガー** される自動化ワークフローです。開発から本番までのプロセスを効率化します。

しかし、これらのシステムはどこかで **実行される必要があり**、通常は **code をデプロイしたり機密情報へアクセスするための特権的な資格情報を使って実行される** ことが多いです。

## VCS Pentesting Methodology

> [!NOTE]
> 一部の VCS platforms がパイプライン作成を許可している場合でも、このセクションではソース code のコントロールに対する潜在的な攻撃のみを分析します。

プロジェクトの source が含まれるプラットフォームには機密情報が存在する可能性があり、プラットフォーム内で付与される権限には細心の注意が必要です。攻撃者が悪用できる VCS プラットフォーム全般の一般的な問題点は次のとおりです:

- **Leaks**: もしあなたの code がコミット内に leaks を含んでおり、攻撃者がリポジトリにアクセスできる（公開されている、あるいはアクセス権がある）場合、攻撃者はそれらの leaks を発見できます。
- **Access**: 攻撃者が VCS platform 内のアカウントへアクセスできれば、**より多くの可視性や権限** を得る可能性があります。
- **Register**: 一部のプラットフォームは外部ユーザがアカウントを作成できてしまいます。
- **SSO**: ユーザ登録を許可しないプラットフォームでも、有効な SSO であれば誰でもアクセスできる場合があり（例: 攻撃者が自身の github アカウントでログインする）、これが攻撃経路になります。
- **Credentials**: Username+Pwd、personal tokens、ssh keys、Oauth tokens、cookies... ユーザが盗めるトークン類はさまざまです。
- **Webhooks**: VCS platforms は webhooks を生成できます。これらが可視化されない secret で保護されていない場合、**攻撃者が悪用する** 可能性があります。
  - secret が設定されていない場合、攻撃者はサードパーティプラットフォームの webhook を悪用できます。
  - secret が URL に含まれている場合、同様に攻撃者はその URL と secret を入手できます。
- **Code compromise:** 悪意ある者がリポジトリに対して何らかの **write 権限** を持っている場合、**悪意あるコードを注入** することが可能です。成功させるには **branch protections をバイパス** する必要がある場合があります。これらの行為は目的がいくつか考えられます:
  - main ブランチを改ざんして **production を侵害** する。
  - main（または他のブランチ）を改ざんして **開発者のマシンを侵害** する（開発者は通常リポジトリ内でテスト、terraform 等を実行するため）。
- **Compromise the pipeline**（次節を参照）

## Pipelines Pentesting Methodology

パイプラインを定義する最も一般的な方法は、ビルドするリポジトリにホストされる **CI 設定ファイル** を使うことです。このファイルは実行されるジョブの順序、フローに影響する条件、ビルド環境の設定などを記述します。\
これらのファイルは一貫した名前とフォーマットを持つことが多く、例えば Jenkinsfile (Jenkins)、.gitlab-ci.yml (GitLab)、.circleci/config.yml (CircleCI)、および .github/workflows 以下にある GitHub Actions の YAML ファイルなどがあります。トリガーされると、パイプラインジョブは選択されたソース（例: commit / branch）から **コードを pull し**、そして **CI 設定ファイルで指定されたコマンドをそのコードに対して実行** します。

したがって、攻撃者の最終的な目的は何らかの方法でこれらの設定ファイルか、設定ファイルが実行する **コマンドを侵害する** ことです。

> [!TIP]
> 一部の hosted builders はコントリビュータに Docker build context と Dockerfile のパスを選ばせます。context が攻撃者にコントロールされている場合、repo の外（例: ".."）を指定してビルド中にホストファイルを取り込み、シークレットを外部へ持ち出す（exfiltrate）ことができます。参照:
>
>{{#ref}}
>docker-build-context-abuse.md
>{{#endref}}

### PPE - Poisoned Pipeline Execution

The Poisoned Pipeline Execution (PPE) パスは、SCM リポジトリ内の権限を悪用して CI パイプラインを操作し、悪意のあるコマンドを実行させる手法です。必要な権限を持つユーザは CI 設定ファイルやパイプラインジョブで使用される他のファイルを変更して悪意あるコマンドを含めることができます。この操作がパイプラインを「poison」し、これらの悪意あるコマンドが実行されます。

攻撃者が PPE 攻撃を成功させるには次の条件が必要になることが多いです:

- 通常、パイプラインは push や pull request 時にトリガーされるため、**VCS platform への write 権限** を持っていること。（アクセス取得手段の概要は VCS pentesting methodology を参照）
- 外部 PR が「write 権限」とみなされる場合がある点に注意。
- write 権限があっても、CI 設定ファイルや設定が依存する他のファイルを **修正できること** を確認する必要がある。
- これには branch protections を **バイパス** する能力が必要な場合がある。

PPE には 3 つの派生があります:

- **D-PPE**: CI 設定ファイル自体を直接 **修正する** 場合の Direct PPE。
- **I-DDE**: CI 設定ファイルが **依存しているファイル**（makefile や terraform コンフィグなど）を **修正する** 間接的な攻撃。
- **Public PPE or 3PE**: 場合によっては、リポジトリへの write 権限がないユーザ（組織のメンバーでないユーザを含む）が PR を送ることでパイプラインをトリガーできることがある。
- **3PE Command Injection**: 多くの CI/CD パイプラインは PR に関する情報を **環境変数** に設定します。もしその値を攻撃者がコントロールでき（例: PR のタイトル）、かつそれが危険な場所（sh コマンドの実行など）で利用される場合、攻撃者は **コマンドインジェクション** を行える可能性があります。

### Exploitation Benefits

PPE の 3 種類を理解した上で、成功した場合に攻撃者が得られるものを確認します:

- **Secrets**: 前述の通り、パイプラインのジョブはコードの取得、ビルド、デプロイなどのために **特権** を必要とし、これらの特権は通常 **シークレット** として付与されています。これらのシークレットは **環境変数やシステム内のファイル** 経由でアクセス可能なことが多いため、攻撃者は可能な限りシークレットを exfiltrate しようとします。
- パイプラインプラットフォームによっては、攻撃者がシークレットを使うために設定ファイル内で明示的に指定する必要がある場合があります。そのため、攻撃者が CI 設定を修正できない（例: I-PPE）場合、攻撃者はそのパイプラインがすでに持っているシークレットしか exfiltrate できないことがあります。
- **計算リソース**: code がどこかで実行されるため、実行場所次第で攻撃者は横展開できる可能性があります。
- **オンプレミス**: パイプラインがオンプレミスで実行される場合、攻撃者は内部ネットワークに到達し、より多くのリソースへアクセスできる可能性があります。
- **Cloud**: 攻撃者はクラウド内の他のマシンにアクセスしたり、IAM roles / service accounts のトークンを exfiltrate してクラウド内でさらに権限を拡大する可能性があります。
- **プラットフォーム側のマシン**: ジョブがパイプラインプラットフォームのマシン上で実行される場合、それらは通常クラウド内にあり、追加のアクセス権が特にないこともあります。
- **実行環境の選択**: 一部のパイプラインプラットフォームは複数の実行マシンを持っており、CI 設定ファイルを修正できれば「どのマシンで悪意あるコードを実行するか」を指定できることがあります。この場合、攻撃者は各候補マシンにリバースシェルを展開して追加の脆弱性を探すでしょう。
- **Production の侵害**: パイプライン内に入り、最終的なビルドやデプロイがそこから行われる場合、production で実行される code を直接侵害できます。

## More relevant info

### Tools & CIS Benchmark

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) は、ソフトウェアサプライチェーンのセキュリティコンプライアンスを監査するオープンソースツールで、新しい [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf) に基づいています。監査は SDLC 全体に焦点を当て、コード作成時からデプロイ時までのリスクを明らかにします。

### Top 10 CI/CD Security Risk

Cider による CI/CD のトップ10リスクに関する興味深い記事を確認してください: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

- 各プラットフォームでローカル実行できるものについては、ローカルで起動する手順が記載されており、自由に設定してテストできます。
- Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatic Tools

- [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** は Infrastructure-as-Code 向けの静的解析ツールです。

## References

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&utm_medium=github_page&utm_campaign=ci%2fcd%20goat_060422)


{{#include ../banners/hacktricks-training.md}}
