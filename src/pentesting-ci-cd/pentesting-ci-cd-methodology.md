# Методологія Pentesting CI/CD

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS означає **Version Control System**, ця система дозволяє розробникам **керувати своїм вихідним кодом**. Найпоширеніша — **git**, і зазвичай ви знайдете компанії, що використовують його на одній із наступних **платформ**:

- Github
- Gitlab
- Bitbucket
- Gitea
- Gitblit
- Cloud providers (вони пропонують власні VCS платформи)


## CI/CD Pipelines

CI/CD pipelines дозволяють розробникам **автоматизувати виконання коду** для різних цілей, включно зі збіркою, тестуванням та деплоєм додатків. Ці автоматизовані робочі процеси **тригеряться специфічними діями**, такими як push-і коду, pull requests або плановані завдання. Вони допомагають оптимізувати процес від розробки до production.

Однак такі системи потрібно **дещо виконувати десь**, і зазвичай з **привілейованими обліковими даними для деплою коду або доступу до чутливої інформації**.

## VCS Pentesting Methodology

> [!NOTE]
> Навіть якщо деякі VCS платформи дозволяють створювати pipelines для цього розділу, ми будемо аналізувати лише потенційні атаки на контроль над вихідним кодом.

Платформи, що містять вихідний код вашого проєкту, містять чутливу інформацію, тому потрібно дуже уважно ставитися до дозволів у цій платформі. Ось деякі поширені проблеми у VCS платформах, якими може зловживати атакувальник:

- **Leaks**: Якщо ваш код містить leaks у комітах і атакувальник може отримати доступ до репозиторію (бо він public або тому що в нього є доступ), він може виявити ці leaks.
- **Access**: Якщо атакувальник може **отримати доступ до облікового запису в VCS платформі**, він може отримати **більшу видимість і права**.
- **Register**: Деякі платформи дозволяють зовнішнім користувачам просто створювати облікові записи.
- **SSO**: Деякі платформи не дозволяють реєстрацію, але дозволяють входити через дійсний SSO (тому атакувальник, наприклад, може використати свій github обліковий запис для входу).
- **Credentials**: Username+Pwd, personal tokens, ssh keys, Oauth tokens, cookies... існує кілька типів токенів, які користувач може вкрасти, щоб отримати доступ до репо.
- **Webhooks**: VCS платформи дозволяють генерувати webhooks. Якщо вони **не захищені** невидимими секретами, **атакувальник може зловживати ними**.
- Якщо секрет відсутній, атакувальник може зловживати webhook-ом третьої сторони.
- Якщо секрет знаходиться в URL, те ж саме відбувається і атакувальник також має секрет.
- **Code compromise:** Якщо зловмисник має який-небудь **записувальний доступ** до репозиторіїв, він може спробувати **інжектувати шкідливий код**. Щоб бути успішним, йому може знадобитися **обійти branch protections**. Ці дії можуть виконуватися з різними цілями:
  - Компроментувати main branch, щоб **компрометувати production**.
  - Компрометувати main (або інші гілки), щоб **компрометувати машини розробників** (оскільки вони зазвичай виконують тести, terraform або інші речі з репо на своїх машинах).
- **Compromise the pipeline** (див. наступний розділ)

## Pipelines Pentesting Methodology

Найпоширеніший спосіб визначити pipeline — через **CI configuration file, який зберігається у репозиторії**, який pipeline збирає. Цей файл описує порядок виконуваних job-ів, умови, що впливають на потік, і налаштування середовища збірки.\
Такі файли зазвичай мають консистентну назву і формат, наприклад — Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), і GitHub Actions YAML файли під .github/workflows. Коли pipeline тригериться, job **забирає код** з обраного джерела (наприклад commit / branch) і **виконує команди, вказані в CI configuration file**, над цим кодом.

Отже кінцева мета атакувальника — якимось чином **компрометувати ці configuration files** або **команди, які вони виконують**.

> [!TIP]
> Деякі hosted builders дозволяють контрибьюторам обирати Docker build context та Dockerfile path. Якщо context контролюється атакувальником, ви можете вказати його за межами репо (наприклад, ".."), щоб інжестити файли хоста під час збірки і ексфільтрувати secrets. Див.:
>
>{{#ref}}
>docker-build-context-abuse.md
>{{#endref}}

### PPE - Poisoned Pipeline Execution

Poisoned Pipeline Execution (PPE) шлях експлуатує права в SCM репозиторії, щоб маніпулювати CI pipeline і виконувати шкідливі команди. Користувачі з необхідними дозволами можуть змінювати CI configuration files або інші файли, які використовує job pipeline, щоб включити шкідливі команди. Це "отруює" CI pipeline, призводячи до виконання цих шкідливих команд.

Щоб зловмисник міг успішно виконати PPE атаку, йому потрібно:

- Мати **write access до VCS платформи**, оскільки зазвичай pipelines тригеряться при push або pull request. (Див. VCS pentesting methodology для підсумку способів отримати доступ).
- Зверніть увагу, що інколи **зовнішній PR рахується як "write access"**.
- Навіть якщо в нього є права запису, йому потрібно бути впевненим, що він може **змінити CI config file або інші файли, на які опирається конфіг**.
- Для цього йому може знадобитися **обійти branch protections**.

Є 3 варіанти PPE:

- **D-PPE**: **Direct PPE** відбувається, коли актор **змінює CI config** файл, який буде виконано.
- **I-DDE**: **Indirect PPE** відбувається, коли актор **змінює** файл, на який **опирається CI config** (наприклад make file або terraform конфіг).
- **Public PPE or 3PE**: Іноді pipelines можуть бути **тригерені користувачами, які не мають write access в репо** (і які можуть навіть не входити до організації), тому що вони можуть надіслати PR.
- **3PE Command Injection**: Зазвичай CI/CD pipelines встановлюють environment variables з інформацією про PR. Якщо це значення може контролюватися атакувальником (наприклад заголовок PR) і **використовується** у **небезпечному місці** (наприклад при виконанні sh команд), атакувальник може **інжектувати команди туди**.

### Exploitation Benefits

Знаючи 3 варіанти отруєння pipeline, подивимося, що атакувальник може отримати після успішної експлуатації:

- **Secrets**: Як згадувалося раніше, pipelines потребують **привілеїв** для своїх job-ів (отримати код, збірка, деплой ...) і ці привілеї зазвичай **зберігаються в secrets**. Ці secrets зазвичай доступні через **env variables або файли в системі**. Тому атакувальник завжди намагатиметься ексфільтрувати якомога більше secrets.
- Залежно від платформи pipeline атакувальник **може бути вимушений вказати secrets у конфігу**. Це означає, що якщо атакувальник не може змінити CI configuration pipeline (**I-PPE** наприклад), він може **експортувати лише ті secrets, які має цей pipeline**.
- **Computation**: Код виконується десь, і залежно від місця виконання атакувальник може зуміти півертувати далі.
- **On-Premises**: Якщо pipelines виконуються on-premises, атакувальник може опинитися в **внутрішній мережі з доступом до додаткових ресурсів**.
- **Cloud**: Атакувальник може отримати доступ до **інших машин у cloud**, а також може **ексфільтрувати** IAM roles/service accounts **tokens** з нього, щоб отримати **дальший доступ усередині cloud**.
- **Platforms machine**: Іноді jobs виконуються всередині **pipelines platform machines**, які зазвичай знаходяться в cloud і не мають додаткового доступу.
- **Select it:** Інколи **pipelines platform має кілька машин**, і якщо ви можете **змінити CI configuration file**, ви можете **вказати, де ви хочете запускати шкідливий код**. У цій ситуації атакувальник, швидше за все, запустить reverse shell на кожній можливій машині, щоб спробувати експлуатувати її далі.
- **Compromise production**: Якщо ви всередині pipeline і фінальна версія збирається і деплоїться з нього, ви можете **компрометувати код, який потім запуститься в production**.

## More relevant info

### Tools & CIS Benchmark

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) — відкритий інструмент для аудиту вашого software supply chain стеку на відповідність безпеці на основі нового [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). Аудит фокусується на всьому SDLC процесі, де він може виявити ризики від часу створення коду до моменту деплою.

### Top 10 CI/CD Security Risk

Перегляньте цікаву статтю про топ-10 ризиків CI/CD згідно з Cider: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

- Для кожної платформи, яку ви можете запустити локально, описано, як її підняти, щоб ви могли налаштувати її як завгодно для тестування
- Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatic Tools

- [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** — це static code analysis інструмент для infrastructure-as-code.

## References

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&utm_medium=github_page&utm_campaign=ci%2fcd%20goat_060422)


{{#include ../banners/hacktricks-training.md}}
