# Pentesting CI/CD 방법론

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS는 **Version Control System**의 약자로, 이 시스템은 개발자가 **소스 코드를 관리**할 수 있게 해줍니다. 가장 일반적인 것은 **git**이며 보통 회사에서는 다음 **platforms** 중 하나를 사용합니다:

- Github
- Gitlab
- Bitbucket
- Gitea
- Gitblit
- Cloud providers (they offer their own VCS platforms)


## CI/CD Pipelines

CI/CD 파이프라인은 개발자가 애플리케이션을 빌드, 테스트, 배포하는 등 다양한 목적으로 **코드 실행을 자동화**할 수 있게 해줍니다. 이러한 자동화된 워크플로우는 코드 푸시, pull request, 스케줄된 작업 같은 **특정 액션에 의해 트리거**됩니다. 이들은 개발에서 운영까지의 과정을 간소화하는 데 유용합니다.

하지만 이 시스템들은 어딘가에서 **실행되어야 하고**, 보통은 **코드를 배포하거나 민감한 정보에 접근하기 위한 권한이 있는 자격 증명**으로 실행됩니다.

## VCS Pentesting 방법론

> [!NOTE]
> Even if some VCS platforms allow to create pipelines for this section we are going to analyze only potential attacks to the control of the source code.

프로젝트의 소스 코드를 포함하는 플랫폼은 민감한 정보를 담고 있으므로 플랫폼 내 권한 설정에 매우 유의해야 합니다. 공격자가 악용할 수 있는 VCS 플랫폼 전반의 일반적인 문제들은 다음과 같습니다:

- **Leaks**: 코드에 leak가 포함되어 있고 공격자가 repo에 접근할 수 있다면(퍼블릭이거나 접근 권한이 있는 경우) 해당 leak를 발견할 수 있습니다.
- **Access**: 공격자가 VCS platform 내의 계정에 **접근(access)**할 수 있다면 **더 많은 가시성 및 권한**을 얻을 수 있습니다.
- **Register**: 일부 플랫폼은 외부 사용자가 계정을 생성하는 것을 허용합니다.
- **SSO**: 일부 플랫폼은 사용자가 직접 등록하는 것은 허용하지 않지만 유효한 SSO로 누구나 접근할 수 있게 허용하기도 합니다(예: 공격자가 자신의 github 계정으로 접근할 수 있음).
- **Credentials**: Username+Pwd, personal tokens, ssh keys, Oauth tokens, cookies 등 다양한 종류의 토큰을 공격자가 훔쳐서 repo에 어떤 식으로든 접근할 수 있습니다.
- **Webhooks**: VCS 플랫폼은 webhooks를 생성할 수 있게 해줍니다. 만약 webhooks가 보이지 않는 비밀값으로 **보호되어 있지 않다면**, **공격자가 이를 악용할 수 있습니다**.
- 만약 시크릿이 없는 상태라면, 공격자는 서드파티 플랫폼의 webhook을 악용할 수 있습니다.
- 시크릿이 URL에 포함되어 있다면 동일하게 시크릿을 얻어 공격에 악용할 수 있습니다.
- **Code compromise:** 악의적인 행위자가 repo에 **write** 권한을 가지고 있다면 **악성 코드 주입**을 시도할 수 있습니다. 성공하려면 **branch protections를 우회**해야 할 수도 있습니다. 이러한 행위는 여러 목적을 가질 수 있습니다:
  - main branch를 손상시켜 **production을 침해**.
  - main(또는 다른) 브랜치를 손상시켜 **개발자 기기들을 침해** (개발자들이 테스트, terraform 등 repo 내에서 실행하기 때문).
  - **파이프라인 침해** (다음 섹션 참조)

## Pipelines Pentesting 방법론

파이프라인을 정의하는 가장 일반적인 방법은 **빌드되는 리포지토리에 호스팅된 CI 구성 파일**을 사용하는 것입니다. 이 파일은 실행되는 작업의 순서, 흐름에 영향을 미치는 조건, 빌드 환경 설정을 설명합니다.\
이 파일들은 일반적으로 일관된 이름과 포맷을 가지며, 예를 들어 Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), 그리고 .github/workflows 아래의 GitHub Actions YAML 파일들이 있습니다. 트리거되면 파이프라인 작업은 선택된 소스(예: 커밋/브랜치)에서 **코드를 pull**하고, CI 구성 파일에 명시된 **명령들을 해당 코드에 대해 실행**합니다.

따라서 공격자의 궁극적 목표는 해당 구성 파일들이나 **구성 파일이 실행하는 명령들**을 어떤 방식으로든 **침해(compromise)**하는 것입니다.

> [!TIP]
> Some hosted builders let contributors choose the Docker build context and Dockerfile path. If the context is attacker-controlled, you may set it outside the repo (e.g., "..") to ingest host files during build and exfiltrate secrets. See:
>
>{{#ref}}
>docker-build-context-abuse.md
>{{#endref}}

### PPE - Poisoned Pipeline Execution

Poisoned Pipeline Execution (PPE) 경로는 SCM 리포지토리의 권한을 악용하여 CI 파이프라인을 조작하고 유해한 명령을 실행하게 합니다. 필요한 권한이 있는 사용자는 CI 구성 파일이나 파이프라인 작업이 사용하는 다른 파일을 수정하여 악성 명령을 포함시킬 수 있습니다. 이렇게 CI 파이프라인이 "poison"되면 해당 악성 명령이 실행됩니다.

공격자가 PPE 공격을 성공적으로 수행하려면 다음이 필요합니다:

- 보통 파이프라인은 push나 pull request가 수행될 때 트리거되므로, **VCS platform에 대한 write access**가 필요합니다. (VCS pentesting 방법론 섹션에서 접근 획득 방법 요약을 확인하세요).
- 때로는 **외부 PR도 "write access"로 간주될 수 있다는 점**에 주의하세요.
- write 권한이 있더라도, **CI config 파일이나 config가 의존하는 다른 파일을 수정할 수 있어야** 합니다.
- 이를 위해서는 **branch protections를 우회**할 수 있어야 할 수 있습니다.

PPE에는 3가지 변형이 있습니다:

- **D-PPE**: 공격자가 실행될 CI config 파일을 직접 **수정**할 때 발생하는 **Direct PPE** 공격입니다.
- **I-DDE**: 공격자가 CI config가 **의존하는 파일(예: makefile, terraform config 등)**을 **수정**할 때 발생하는 **Indirect PPE** 공격입니다.
- **Public PPE or 3PE**: 경우에 따라 파이프라인은 repo에 write access가 없는 사용자(심지어 조직 외부 사용자)도 PR을 보내 트리거할 수 있습니다.
- **3PE Command Injection**: 보통 CI/CD 파이프라인은 PR에 대한 정보를 담은 **environment variables**를 설정합니다. 그 값이 공격자에 의해 제어될 수 있고(예: PR 제목) **위험한 곳(예: sh 명령 실행)에 사용**된다면 공격자는 그곳에 **명령을 주입**할 수 있습니다.

### Exploitation Benefits

세 가지 PPE 변형을 알았으니, 공격자가 성공적으로 악용했을 때 얻을 수 있는 것들을 살펴보겠습니다:

- **Secrets**: 앞서 언급했듯이 파이프라인 작업은 코드 검색, 빌드, 배포 등을 위해 **특권**이 필요하고, 이러한 특권은 보통 **시크릿**으로 부여됩니다. 이 시크릿들은 보통 **env variables 또는 시스템 내 파일**을 통해 접근 가능하므로 공격자는 가능한 많은 시크릿을 탈취하려고 합니다.
- 파이프라인 플랫폼에 따라 공격자는 **config에 시크릿을 명시해야 하는 경우**가 있습니다. 이는 공격자가 CI 구성 파일을 수정할 수 없는 경우(**I-PPE 등**)라면 해당 파이프라인이 가진 시크릿만 탈취할 수 있다는 의미입니다.
- **Computation**: 코드가 어딘가에서 실행되므로, 실행 위치에 따라 공격자는 추가로 피벗할 수 있습니다.
- **On-Premises**: 파이프라인이 온프레미스에서 실행된다면 공격자는 내부 네트워크에 도달하여 더 많은 자원에 접근할 수 있습니다.
- **Cloud**: 공격자는 클라우드 내 다른 머신에 접근하거나 IAM 역할/서비스 계정 토큰을 탈취해 클라우드 내부에서 더 많은 권한을 얻을 수 있습니다.
- **Platforms machine**: 때때로 작업은 파이프라인 플랫폼의 머신에서 실행되며, 이 머신들은 보통 더 이상의 접근 권한이 없는 클라우드 환경에 있습니다.
- **Select it:** 때때로 파이프라인 플랫폼은 여러 대의 머신을 구성해두고 있으며, CI 구성 파일을 수정할 수 있다면 **어떤 머신에서 악성 코드를 실행할지 지정**할 수 있습니다. 이 경우 공격자는 가능한 각 머신에 리버스 셸을 실행해 추가 취약점을 노릴 것입니다.
- **Compromise production**: 파이프라인 안에 있고 최종 버전이 파이프라인에서 빌드되어 배포된다면, 운영 환경에서 실행될 코드를 **침해**할 수 있습니다.

## 추가 관련 정보

### Tools & CIS Benchmark

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) 는 새로운 [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf)를 기반으로 소프트웨어 공급망 스택의 보안 규정 준수를 감사하는 오픈소스 도구입니다. 이 감사는 전체 SDLC 프로세스에 초점을 맞추며, 코드 단계부터 배포 단계까지의 리스크를 드러낼 수 있습니다.

### Top 10 CI/CD Security Risk

Cider에 따르면 CI/CD의 상위 10개 리스크에 관한 흥미로운 기사: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

- 로컬에서 실행할 수 있는 각 플랫폼에 대해 로컬로 어떻게 실행하는지 설명이 있으니 원하는 대로 구성하여 테스트할 수 있습니다.
- Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatic Tools

- [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov**는 infrastructure-as-code에 대한 정적 코드 분석 도구입니다.

## References

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&utm_medium=github_page&utm_campaign=ci%2fcd%20goat_060422)


{{#include ../banners/hacktricks-training.md}}
