# Pentesting CI/CD Methodology

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS inamaanisha **Version Control System**, mfumo huu unawawezesha watengenezaji **kusimamia source code yao**. Iliyo ya kawaida zaidi ni **git** na kawaida utapata kampuni zikitumia moja ya **platforms** zifuatazo:

- Github
- Gitlab
- Bitbucket
- Gitea
- Gitblit
- Cloud providers (hutoa VCS platforms zao)

## CI/CD Pipelines

CI/CD pipelines zinawawezesha watengenezaji **kuendesha kiotomatiki execution ya code** kwa madhumuni mbalimbali, ikiwa ni pamoja na kujenga, kujaribu, na ku-deploy applications. Workflows hizi za otomatiki huanza kwa **vitendo maalum**, kama vile code pushes, pull requests, au scheduled tasks. Zinasaidia kurahisisha mchakato kutoka development hadi production.

Hata hivyo, mifumo hii inahitaji kuendeshwa **mahali fulani** na kawaida kwa **credentials zilizo na privileges ili ku-deploy code au kufikia taarifa nyeti**.

## VCS Pentesting Methodology

> [!NOTE]
> Hata kama baadhi ya VCS platforms zinaruhusu kuunda pipelines kwa sehemu hii tutaangalia tu mashambulizi yanayowezekana kwa udhibiti wa source code.

Platforms zinazoendelea na source code ya project yako zina taarifa nyeti na watu wanapaswa kuwa makini sana na ruhusa zinazotolewa ndani ya platform hii. Hivi ni baadhi ya matatizo ya kawaida kwenye VCS platforms ambayo attacker anaweza kuyatumia:

- **Leaks**: Ikiwa code yako ina leaks katika commits na attacker anaweza kupata repo (kwa sababu ni public au kwa sababu ana access), anaweza kugundua leaks.
- **Access**: Ikiwa attacker anaweza **kupata account ndani ya VCS platform** anaweza kupata **uwazi zaidi na ruhusa**.
- **Register**: Baadhi ya platforms zitamruhusu tu watumiaji wa nje kuunda account.
- **SSO**: Baadhi ya platforms hazitaruhusu watumiaji kusajili, lakini zitawaweka watu kuingia kwa SSO halali (hivyo attacker anaweza kutumia github account yake kuingia kwa mfano).
- **Credentials**: Username+Pwd, personal tokens, ssh keys, Oauth tokens, cookies... kuna aina mbalimbali za tokens ambazo mtumiaji anaweza kuiba ili kufikia repo kwa namna fulani.
- **Webhooks**: VCS platforms zinaruhusu kuunda webhooks. Ikiwa hazilindwa na secrets zisizoonekana attacker anaweza kuzitumia.
  - Ikiwa hakuna secret, attacker anaweza kutumia webhook ya third party platform
  - Ikiwa secret iko kwenye URL, hali ni sawa na attacker pia atakuwa na secret
- **Code compromise:** Ikiwa mtu mwenye nia mbaya ana aina yoyote ya **write** access juu ya repos, anaweza kujaribu **kujaza code ya kibaya**. Ili kufanikiwa anaweza kuhitaji **kupitie branch protections**. Vitendo hivi vinaweza kufanywa kwa malengo tofauti:
  - Kuathiri main branch ili **kuathiri production**.
  - Kuathiri main (au branches nyingine) ili **kuathiri machines za developers** (kwa kuwa kawaida wanaendesha test, terraform au mambo mengine ndani ya repo kwenye mashine zao).
  - **Compromise the pipeline** (angalia sehemu inayofuata)

## Pipelines Pentesting Methodology

Njia ya kawaida ya kufafanua pipeline ni kwa kutumia **CI configuration file hosted in the repository** pipeline inajenga. File hii inaelezea mpangilio wa jobs zinazoendeshwa, masharti yanayoathiri flow, na settings za build environment.\
Files hizi kawaida zina jina na format inayofanana, kwa mfano â€” Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), na GitHub Actions YAML files zilizo chini ya .github/workflows. Wakati zinapoanzishwa, pipeline job **inapull code** kutoka source iliyochaguliwa (mfano commit / branch), na **inaendesha commands zilizobainishwa katika CI configuration file** dhidi ya code hiyo.

Kwa hivyo lengo kuu la attacker ni kwa namna fulani **kuathiri files za configuration** au **commands wanazoendesha**.

### PPE - Poisoned Pipeline Execution

The Poisoned Pipeline Execution (PPE) path hutumia permissions katika SCM repository ili kuathiri CI pipeline na kuendesha commands zenye madhara. Watumiaji wenye ruhusa wanazoweza kubadilisha CI configuration files au files nyingine zinazotumika na job ya pipeline ili kuwaweka commands za kigaidi. Hii "inafanya poison" CI pipeline, na kusababisha execution ya commands hizo.

Ili muasi afanikiwe kufanya udukuzi wa PPE anahitaji:

- Kuwa na **write access to the VCS platform**, kwani kawaida pipelines zinaanzishwa wakati push au pull request inafanywa. (Angalia VCS pentesting methodology kwa muhtasari wa njia za kupata access).
- Kumbuka kwamba wakati mwingine **external PR inaweza kuhesabiwa kama "write access"**.
- Hata kama ana write permissions, anahitaji kuhakikisha anaweza **kubadilisha CI config file au files nyingine ambazo config inategemea**.
- Kwa hili, anaweza kuhitaji kuweza **kupitia branch protections**.

Kuna flavours 3 za PPE:

- **D-PPE**: A **Direct PPE** attack hutokea wakati actor **anabadilisha CI config** file ambayo itatekelezwa.
- **I-DDE**: A **Indirect PPE** attack hutokea wakati actor **anabadilisha** **file** ambayo CI config file inayotekelezwa **inategemea** (kama make file au terraform config).
- **Public PPE or 3PE**: Katika baadhi ya kesi pipelines zinaweza kuanzishwa na watumiaji ambao hawana write access katika repo (na ambao huenda si sehemu ya org) kwa sababu wanaweza kutuma PR.
- **3PE Command Injection**: Kawaida, CI/CD pipelines huweka **environment variables** zenye **taarifa kuhusu PR**. Ikiwa thamani hiyo inaweza kudhibitiwa na attacker (kama title ya PR) na inatumiwa mahali hatari (kama kuendesha **sh commands**), attacker anaweza **kuingiza commands ndani yake**.

### Exploitation Benefits

Kujua flavours 3 za ku-poison pipeline, hebu tazame anachoweza kupata attacker baada ya exploitation iliyofanikiwa:

- **Secrets**: Kama ilivyoripotiwa awali, pipelines zinahitaji **privileges** kwa jobs zao (kupata code, kuijenga, ku-deploy...) na privileges hizi kawaida hutolewa kwa **secrets**. Secrets hizi kwa kawaida zinapatikana kupitia **env variables au files ndani ya system**. Kwa hivyo attacker atajaribu kila mara kutoa secrets nyingi iwezekanavyo.
- Kutegemea platform ya pipeline attacker **anaweza kuhitaji kubainisha secrets kwenye config**. Hii inamaanisha kwamba kama attacker hawezi kubadilisha CI configuration pipeline (**I-PPE** kwa mfano), anaweza **kutoa tu secrets ambazo pipeline ina**.
- **Computation**: Code inaendeshwa mahali fulani, kutegemea wapi inafanyika attacker anaweza kuweza pivot zaidi.
- **On-Premises**: Ikiwa pipelines zinaendeshwa on premises, attacker anaweza kuingia kwenye **internal network yenye access kwa rasilimali zaidi**.
- **Cloud**: attacker anaweza kufikia **mashine nyingine kwenye cloud** lakini pia anaweza **kutoa** IAM roles/service accounts **tokens** kutoka kwake kupata **access zaidi ndani ya cloud**.
- **Platforms machine**: Wakati mwingine jobs zitaendeshwa ndani ya **pipelines platform machines**, ambazo kawaida ziko ndani ya cloud na **hakuna access zaidi**.
- **Select it:** Wakati mwingine **pipelines platform itakuwa imesanidi mashine kadhaa** na kama unaweza **kubadilisha CI configuration file** unaweza **bainisha wapi unataka kuendesha malicious code**. Katika hali hii, attacker huenda akaendesha reverse shell kwenye kila mashine inayowezekana ili kujaribu kuzifanyia exploit zaidi.
- **Compromise production**: Ikiwa uko ndani ya pipeline na version ya mwisho inajengwa na ku-deploy kutoka kwake, unaweza **kuathiri code itakayofanya kazi production**.

## More relevant info

### Tools & CIS Benchmark

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) ni tool ya open-source kwa auditing software supply chain stack yako kwa security compliance kulingana na [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). Auditing inazingatia mchakato mzima wa SDLC, ambapo inaweza kufichua hatari kutoka wakati wa code hadi wakati wa deploy.

### Top 10 CI/CD Security Risk

Angalia makala hii ya kuvutia kuhusu top 10 CI/CD risks kulingana na Cider: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

- Kwenye kila platform ambayo unaweza kuendesha locally utapata jinsi ya kuilauch locally ili uweze kuisanidi kama unavyotaka kuijaribu
- Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatic Tools

- [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** ni static code analysis tool kwa infrastructure-as-code.

## References

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&utm_medium=github_page&utm_campaign=ci%2fcd%20goat_060422)


{{#include ../banners/hacktricks-training.md}}
