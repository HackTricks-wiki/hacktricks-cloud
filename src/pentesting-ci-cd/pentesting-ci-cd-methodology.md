# Pentesting CI/CD Μεθοδολογία

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS σημαίνει Σχήμα Ελέγχου Έκδοσης και αυτό το σύστημα επιτρέπει στους προγραμματιστές να διαχειρίζονται τον πηγαίο κώδικα τους. Το πιο κοινό είναι το **git** και συνήθως θα βρείτε εταιρείες να το χρησιμοποιούν σε μία από τις παρακάτω **πλατφόρμες**:

- Github
- Gitlab
- Bitbucket
- Gitea
- Gitblit
- Cloud providers (they offer their own VCS platforms)


## CI/CD Pipelines

Τα CI/CD pipelines επιτρέπουν στους προγραμματιστές να **αυτοματοποιήσουν την εκτέλεση κώδικα** για διάφορους σκοπούς, όπως build, testing και deployment εφαρμογών. Αυτά τα αυτοματοποιημένα workflows **εκκινούνται από συγκεκριμένες ενέργειες**, όπως pushes, pull requests ή προγραμματισμένα tasks. Είναι χρήσιμα για τη ροή από development προς production.

Ωστόσο, αυτά τα συστήματα πρέπει να **εκτελεστούν κάπου** και συνήθως με **privileged credentials για να κάνουν deploy κώδικα ή να έχουν πρόσβαση σε ευαίσθητες πληροφορίες**.

## VCS Pentesting Methodology

> [!NOTE]
> Even if some VCS platforms allow to create pipelines for this section we are going to analyze only potential attacks to the control of the source code.

Οι πλατφόρμες που περιέχουν τον πηγαίο κώδικα του project σας περιέχουν ευαίσθητες πληροφορίες και πρέπει να είστε πολύ προσεκτικοί με τα permissions που δίνονται μέσα σε αυτήν την πλατφόρμα. Αυτά είναι μερικά κοινά προβλήματα σε VCS πλατφόρμες που ένας attacker θα μπορούσε να εκμεταλλευτεί:

- **Leaks**: Αν ο κώδικάς σας περιέχει leak στα commits και ο attacker μπορεί να έχει πρόσβαση στο repo (επειδή είναι public ή επειδή έχει πρόσβαση), μπορεί να ανακαλύψει αυτά τα leak.
- **Access**: Αν ένας attacker μπορεί να **προσπελάσει έναν λογαριασμό μέσα στην VCS πλατφόρμα** μπορεί να αποκτήσει **περισσότερη ορατότητα και permissions**.
- **Register**: Κάποιες πλατφόρμες απλώς επιτρέπουν σε εξωτερικούς χρήστες να δημιουργήσουν λογαριασμό.
- **SSO**: Κάποιες πλατφόρμες δεν επιτρέπουν εγγραφή χρηστών, αλλά επιτρέπουν σε οποιονδήποτε να συνδεθεί με έγκυρο SSO (έτσι ένας attacker θα μπορούσε για παράδειγμα να χρησιμοποιήσει τον github λογαριασμό του για να μπει).
- **Credentials**: Username+Pwd, personal tokens, ssh keys, Oauth tokens, cookies... υπάρχουν πολλοί τύποι token που ένας χρήστης μπορεί να κλέψει για να αποκτήσει πρόσβαση με κάποιον τρόπο σε ένα repo.
- **Webhooks**: VCS πλατφόρμες επιτρέπουν τη δημιουργία webhooks. Αν δεν προστατεύονται με μη ορατά secrets, ένας attacker θα μπορούσε να τα εκμεταλλευτεί.
  - Αν δεν υπάρχει secret, ο attacker μπορεί να εκμεταλλευτεί το webhook της τρίτης πλατφόρμας
  - Αν το secret είναι στο URL, το ίδιο συμβαίνει και ο attacker αποκτά επίσης το secret
- **Code compromise:** Αν ένας malicious actor έχει κάποιο είδος **write** πρόσβασης στα repos, μπορεί να προσπαθήσει να **ενσωματώσει malicious code**. Για να έχει επιτυχία μπορεί να χρειαστεί να **παρακάμψει branch protections**. Αυτές οι ενέργειες μπορούν να έχουν διάφορους στόχους:
  - Να συμβιβαστεί το main branch για να **συμβιβαστεί το production**.
  - Να συμβιβαστεί το main (ή άλλα branches) για να **συμβιβαστούν οι μηχανές των developers** (καθώς συνήθως εκτελούν tests, terraform ή άλλα πράγματα μέσα στο repo στις μηχανές τους).
  - **Compromise the pipeline** (δείτε την επόμενη ενότητα)

## Pipelines Pentesting Methodology

Ο πιο κοινός τρόπος για να οριστεί ένα pipeline είναι με τη χρήση ενός **CI configuration file hosted in the repository** που το pipeline χτίζει. Αυτό το αρχείο περιγράφει τη σειρά των jobs που εκτελούνται, τις συνθήκες που επηρεάζουν τη ροή και τις ρυθμίσεις του build environment.\
Αυτά τα αρχεία συνήθως έχουν συνεπή όνομα και μορφή, για παράδειγμα — Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), και τα GitHub Actions YAML αρχεία που βρίσκονται κάτω από .github/workflows. Όταν ενεργοποιείται, το pipeline job **pulls the code** από την επιλεγμένη πηγή (π.χ. commit / branch), και **τρέχει τις εντολές που καθορίζονται στο CI configuration file** πάνω σε αυτόν τον κώδικα.

Επομένως ο τελικός στόχος του attacker είναι με κάποιο τρόπο να **συμβιβαστεί αυτά τα configuration files** ή οι **εντολές που εκτελούν**.

### PPE - Poisoned Pipeline Execution

Το Poisoned Pipeline Execution (PPE) path εκμεταλλεύεται permissions σε ένα SCM repository για να χειραγωγήσει ένα CI pipeline και να εκτελέσει επιβλαβείς εντολές. Χρήστες με τα απαραίτητα permissions μπορούν να τροποποιήσουν CI configuration files ή άλλα αρχεία που χρησιμοποιεί το pipeline job ώστε να συμπεριλάβουν malicious εντολές. Αυτό «poisons» το CI pipeline, οδηγώντας στην εκτέλεση αυτών των malicious εντολών.

Για να έχει επιτυχία ένας malicious actor εκτελώντας επίθεση PPE πρέπει να μπορεί να:

- Έχει **write access to the VCS platform**, καθώς συνήθως τα pipelines ενεργοποιούνται όταν γίνεται push ή pull request. (Δείτε τη VCS pentesting methodology για περίληψη τρόπων απόκτησης πρόσβασης).
- Σημειώστε ότι μερικές φορές ένα **external PR θεωρείται ως "write access"**.
- Ακόμα κι αν έχει write permissions, πρέπει να είναι βέβαιος ότι μπορεί να **τροποποιήσει το CI config file ή άλλα αρχεία στα οποία το config βασίζεται**.
- Για αυτό μπορεί να χρειαστεί να μπορέσει να **παρακάμψει branch protections**.

Υπάρχουν 3 flavours PPE:

- **D-PPE**: Μια **Direct PPE** επίθεση συμβαίνει όταν ο actor **τροποποιεί το CI config** αρχείο που πρόκειται να εκτελεστεί.
- **I-DDE**: Μια **Indirect PPE** επίθεση συμβαίνει όταν ο actor **τροποποιεί** ένα **file** στο οποίο το CI config βασίζεται (όπως ένα make file ή ένα terraform config).
- **Public PPE or 3PE**: Σε κάποιες περιπτώσεις τα pipelines μπορούν να **triggered by users that doesn't have write access in the repo** (και που μπορεί να μην είναι καν μέρος της org) επειδή μπορούν να στείλουν ένα PR.
- **3PE Command Injection**: Συνήθως, CI/CD pipelines θα **set environment variables** με **πληροφορίες σχετικά με το PR**. Αν αυτή η τιμή μπορεί να ελεγχθεί από έναν attacker (π.χ. ο τίτλος του PR) και **χρησιμοποιείται** σε ένα **επικίνδυνο σημείο** (όπως εκτέλεση **sh commands**), ένας attacker μπορεί να **εγχείρει εντολές εκεί**.

### Exploitation Benefits

Γνωρίζοντας τα 3 flavours για το poisoning ενός pipeline, ας δούμε τι μπορεί να αποκτήσει ένας attacker μετά από επιτυχημένη εκμετάλλευση:

- **Secrets**: Όπως αναφέρθηκε προηγουμένως, τα pipelines απαιτούν **privileges** για τα jobs τους (ανάκτηση κώδικα, build, deploy...) και αυτά τα privileges συνήθως **παρέχονται ως secrets**. Αυτά τα secrets είναι συνήθως προσβάσιμα μέσω **env variables ή αρχείων μέσα στο σύστημα**. Επομένως ένας attacker θα προσπαθήσει πάντα να εξαγάγει όσο το δυνατόν περισσότερα secrets.
- Ανάλογα με την πλατφόρμα pipeline, ο attacker **μπορεί να χρειαστεί να καθορίσει τα secrets στο config**. Αυτό σημαίνει ότι αν ο attacker δεν μπορεί να τροποποιήσει το CI configuration pipeline (**I-PPE** για παράδειγμα), μπορεί **να εξάγει μόνο τα secrets που έχει το pipeline**.
- **Computation**: Ο κώδικας εκτελείται κάπου. Ανάλογα με το πού εκτελείται, ένας attacker μπορεί να μπορέσει να pivot-άρει περαιτέρω.
- **On-Premises**: Αν τα pipelines εκτελούνται on-premises, ένας attacker μπορεί να βρεθεί σε ένα **εσωτερικό δίκτυο με πρόσβαση σε περισσότερους πόρους**.
- **Cloud**: Ο attacker μπορεί να αποκτήσει πρόσβαση **σε άλλες μηχανές στο cloud** αλλά επίσης να **εξαγάγει** IAM roles/service accounts **tokens** για να αποκτήσει **περαιτέρω πρόσβαση στο cloud**.
- **Platforms machine**: Κάποιες φορές τα jobs θα εκτελεστούν στις **μηχανές της πλατφόρμας των pipelines**, οι οποίες συνήθως είναι μέσα σε ένα cloud με **περιορισμένη περαιτέρω πρόσβαση**.
- **Select it:** Κάποιες φορές η **πλατφόρμα του pipeline θα έχει διαμορφώσει πολλαπλές μηχανές** και αν μπορείτε να **τροποποιήσετε το CI configuration file** μπορείτε να **υποδείξετε που θέλετε να τρέξει ο malicious κώδικας**. Σε αυτή την περίπτωση, ένας attacker πιθανόν θα τρέξει reverse shell σε κάθε διαθέσιμη μηχανή για να προσπαθήσει να την εκμεταλλευτεί περαιτέρω.
- **Compromise production**: Αν βρίσκεστε μέσα στο pipeline και η τελική έκδοση κατασκευάζεται και deploy-άρεται από αυτό, μπορείτε να **συμβιβάσετε τον κώδικα που θα τρέξει σε production**.

## More relevant info

### Tools & CIS Benchmark

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) είναι ένα open-source εργαλείο για auditing του software supply chain stack σας για συμμόρφωση ασφαλείας βάσει ενός νέου [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). Το auditing επικεντρώνεται σε όλη τη διαδικασία SDLC, όπου μπορεί να αποκαλύψει κινδύνους από τον χρόνο του κώδικα μέχρι τον χρόνο του deploy.

### Top 10 CI/CD Security Risk

Δείτε αυτό το ενδιαφέρον άρθρο για τα top 10 CI/CD risks σύμφωνα με την Cider: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

- Σε κάθε πλατφόρμα που μπορείτε να τρέξετε τοπικά θα βρείτε οδηγίες για το πώς να το εκκινήσετε τοπικά ώστε να το διαμορφώσετε όπως θέλετε για να το δοκιμάσετε
- Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatic Tools

- [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** είναι ένα static code analysis εργαλείο για infrastructure-as-code.

## References

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&utm_medium=github_page&utm_campaign=ci%2fcd%20goat_060422)


{{#include ../banners/hacktricks-training.md}}
