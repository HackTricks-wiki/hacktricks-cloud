# Pentesting CI/CD Methodology

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS steht für **Versionskontrollsystem**, dieses System erlaubt Entwicklern, **ihren Quellcode zu verwalten**. Das gebräuchlichste ist **git** und in Unternehmen findet man es üblicherweise auf einer der folgenden **Plattformen**:

- Github
- Gitlab
- Bitbucket
- Gitea
- Gitblit
- Cloud providers (they offer their own VCS platforms)


## CI/CD Pipelines

CI/CD pipelines ermöglichen es Entwicklern, die **Ausführung von Code zu automatisieren** für verschiedene Zwecke, einschließlich Build, Tests und Deployment von Anwendungen. Diese automatisierten Workflows werden durch **bestimmte Aktionen ausgelöst**, wie etwa Code-Pushes, Pull Requests oder geplante Aufgaben. Sie helfen, den Prozess von der Entwicklung bis zur Produktion zu straffen.

Diese Systeme müssen jedoch **irgendwo ausgeführt werden** und meist mit **privilegierten Anmeldeinformationen, um Code zu deployen oder auf sensible Informationen zuzugreifen**.

## VCS Pentesting Methodology

> [!NOTE]
> Even if some VCS platforms allow to create pipelines for this section we are going to analyze only potential attacks to the control of the source code.

Plattformen, die den Quellcode Ihres Projekts enthalten, beinhalten sensible Informationen, und man muss sehr vorsichtig mit den Berechtigungen innerhalb dieser Plattform sein. Dies sind einige häufige Probleme über VCS-Plattformen hinweg, die ein Angreifer ausnutzen könnte:

- **Leaks**: Wenn Ihr Code Leaks in den Commits enthält und der Angreifer auf das Repo zugreifen kann (weil es öffentlich ist oder weil er Zugriff hat), könnte er die Leaks entdecken.
- **Access**: Wenn ein Angreifer **Zugriff auf ein Konto innerhalb der VCS-Plattform** erlangt, könnte er **mehr Sichtbarkeit und Berechtigungen** gewinnen.
- **Register**: Manche Plattformen erlauben externen Nutzern einfach, ein Konto zu erstellen.
- **SSO**: Einige Plattformen erlauben keine Registrierung, aber jeder mit einem gültigen SSO kann sich anmelden (ein Angreifer könnte sich z. B. mit seinem Github-Account einloggen).
- **Credentials**: Username+Pwd, personal tokens, ssh keys, Oauth tokens, cookies... es gibt verschiedene Token-Arten, die ein Benutzer stehlen könnte, um auf irgendeine Weise auf ein Repo zuzugreifen.
- **Webhooks**: VCS-Plattformen erlauben das Erstellen von Webhooks. Wenn diese **nicht mit nicht sichtbaren Secrets geschützt** sind, könnte ein **Angreifer sie missbrauchen**.
- Wenn kein Secret vorhanden ist, könnte der Angreifer den Webhook der Drittanbieterplattform missbrauchen.
- Wenn das Secret in der URL steckt, gilt das Gleiche und der Angreifer hat ebenfalls das Secret.
- **Code compromise:** Wenn ein böswilliger Akteur irgendeine Art von **Write-Zugriff auf die Repos** hat, könnte er versuchen, **bösartigen Code zu injizieren**. Um erfolgreich zu sein, muss er möglicherweise **Branch-Protections umgehen**. Diese Aktionen können mit verschiedenen Zielen durchgeführt werden:
  - Das Main-Branch kompromittieren, um **Production zu kompromittieren**.
  - Main (oder andere Branches) kompromittieren, um **Entwickler-Rechner zu kompromittieren** (da diese oft Tests, Terraform oder andere Dinge local ausführen).
- **Compromise the pipeline** (siehe nächsten Abschnitt)

## Pipelines Pentesting Methodology

Die gebräuchlichste Art, eine Pipeline zu definieren, ist die Verwendung einer **CI-Konfigurationsdatei im Repository**, das die Pipeline baut. Diese Datei beschreibt die Reihenfolge der ausgeführten Jobs, Bedingungen, die den Ablauf beeinflussen, und Einstellungen der Build-Umgebung.\
Diese Dateien haben typischerweise konsistente Namen und Formate, z. B. — Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI) und die GitHub Actions YAML-Dateien unter .github/workflows. Wenn ausgelöst, zieht der Pipeline-Job **den Code** aus der gewählten Quelle (z. B. Commit / Branch) und **führt die in der CI-Konfigurationsdatei angegebenen Befehle** gegen diesen Code aus.

Daher ist das ultimative Ziel des Angreifers, diese Konfigurationsdateien oder die **Befehle, die sie ausführen**, irgendwie zu **kompromittieren**.

> [!TIP]
> Some hosted builders let contributors choose the Docker build context and Dockerfile path. If the context is attacker-controlled, you may set it outside the repo (e.g., "..") to ingest host files during build and exfiltrate secrets. See:
>
>{{#ref}}
>docker-build-context-abuse.md
>{{#endref}}

### PPE - Poisoned Pipeline Execution

Der Poisoned Pipeline Execution (PPE)-Pfad nutzt Berechtigungen in einem SCM-Repository aus, um eine CI-Pipeline zu manipulieren und schädliche Befehle auszuführen. Benutzer mit den erforderlichen Berechtigungen können CI-Konfigurationsdateien oder andere Dateien, die vom Pipeline-Job verwendet werden, so verändern, dass bösartige Befehle eingeschleust werden. Dadurch wird die CI-Pipeline "vergiftet" und diese bösartigen Befehle ausgeführt.

Damit ein böswilliger Akteur einen PPE-Angriff erfolgreich durchführen kann, muss er:

- Schreibzugriff auf die VCS-Plattform haben, da Pipelines normalerweise ausgelöst werden, wenn ein Push oder ein Pull Request durchgeführt wird. (Siehe die VCS pentesting methodology für eine Zusammenfassung der Möglichkeiten, Zugriff zu erhalten).
- Beachten Sie, dass manchmal ein **externer PR als "Write Access"** zählt.
- Selbst wenn er Schreibberechtigungen hat, muss er sicherstellen, dass er die **CI-Config-Datei oder andere Dateien, auf die die Config angewiesen ist, ändern kann**.
- Dafür muss er möglicherweise **Branch-Protections umgehen**.

Es gibt 3 PPE-Varianten:

- **D-PPE**: Ein **Direct PPE**-Angriff tritt auf, wenn der Akteur die **CI-Config** Datei direkt **modifiziert**, die ausgeführt werden soll.
- **I-DDE**: Ein **Indirect PPE**-Angriff tritt auf, wenn der Akteur eine **Datei** modifiziert, auf die sich die CI-Config stützt (z. B. ein Makefile oder eine Terraform-Konfiguration).
- **Public PPE or 3PE**: In manchen Fällen können Pipelines von Benutzern ausgelöst werden, die **keinen Write-Zugriff auf das Repo** haben (und vielleicht nicht einmal Teil der Organisation sind), weil sie einen PR senden können.
- **3PE Command Injection**: Üblicherweise setzen CI/CD-Pipelines **Umgebungsvariablen** mit **Informationen über den PR**. Wenn dieser Wert vom Angreifer kontrolliert werden kann (z. B. der Titel des PR) und an einer **gefährlichen Stelle** verwendet wird (wie bei der Ausführung von **sh-Befehlen**), könnte ein Angreifer **Befehle injizieren**.

### Exploitation Benefits

Wenn man die 3 Varianten kennt, schauen wir, was ein Angreifer nach erfolgreicher Ausnutzung erreichen könnte:

- **Secrets**: Wie zuvor erwähnt, benötigen Pipelines **Privilegien** für ihre Jobs (Code abrufen, bauen, deployen ...) und diese Privilegien werden meist in **Secrets** gespeichert. Diese Secrets sind üblicherweise über **env-Variablen oder Dateien im System** zugänglich. Daher wird ein Angreifer immer versuchen, so viele Secrets wie möglich zu exfiltrieren.
- Je nach Pipeline-Plattform **muss der Angreifer die Secrets in der Config angeben**. Das bedeutet, wenn der Angreifer die CI-Konfiguration nicht ändern kann (**I-PPE** zum Beispiel), könnte er **nur die Secrets exfiltrieren, die diese Pipeline ohnehin besitzt**.
- **Computation**: Der Code wird irgendwo ausgeführt; abhängig vom Ausführungsort kann ein Angreifer weiter pivotieren.
- **On-Premises**: Wenn die Pipelines on-premises ausgeführt werden, könnte ein Angreifer in einem **internen Netzwerk mit Zugriff auf weitere Ressourcen** landen.
- **Cloud**: Der Angreifer könnte **andere Maschinen in der Cloud** erreichen, aber auch IAM-Rollen/Service-Account-**Tokens** exfiltrieren, um **weiteren Zugriff in der Cloud** zu erhalten.
- **Platforms machine**: Manchmal werden Jobs innerhalb der **Pipelines-Plattformmaschinen** ausgeführt, die meist in einer Cloud liegen und **keinen weiteren Zugriff** bieten.
- **Select it:** Manchmal hat die **Pipelines-Plattform mehrere Maschinen konfiguriert** und wenn Sie die **CI-Config-Datei ändern**, können Sie **angeben, wo Sie den bösartigen Code ausführen möchten**. In diesem Fall wird ein Angreifer vermutlich auf jeder möglichen Maschine eine Reverse-Shell starten, um weitere Schwachstellen auszunutzen.
- **Compromise production**: Wenn Sie sich in der Pipeline befinden und die finale Version von dort gebaut und deployed wird, könnten Sie **den Code kompromittieren, der schließlich in Production ausgeführt wird**.

## More relevant info

### Tools & CIS Benchmark

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) ist ein Open-Source-Tool zum Auditieren Ihres Software-Supply-Chain-Stacks auf Sicherheitskonformität basierend auf einem neuen [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). Das Audit konzentriert sich auf den gesamten SDLC-Prozess und kann Risiken von Code-Zeit bis zur Deploy-Zeit aufdecken.

### Top 10 CI/CD Security Risk

Lesen Sie diesen interessanten Artikel zu den Top-10 CI/CD-Risiken laut Cider: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

- Auf jeder Plattform, die Sie lokal ausführen können, finden Sie Anleitungen, wie Sie sie lokal starten, damit Sie sie nach Belieben konfigurieren und testen können
- Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatic Tools

- [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** ist ein statisches Code-Analyse-Tool für infrastructure-as-code.

## References

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&utm_medium=github_page&utm_campaign=ci%2fcd%20goat_060422)


{{#include ../banners/hacktricks-training.md}}
