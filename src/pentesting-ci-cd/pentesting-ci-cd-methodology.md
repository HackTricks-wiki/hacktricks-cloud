# Pentesting CI/CD कार्यप्रणाली

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS का अर्थ है **Version Control System**, यह सिस्टम डेवलपर्स को उनके **source code** को **manage** करने की अनुमति देता है। सबसे आम वाला है **git** और आमतौर पर कंपनियाँ इसे निम्नलिखित **platforms** में से किसी एक पर उपयोग करती हैं:

- Github
- Gitlab
- Bitbucket
- Gitea
- Gitblit
- Cloud providers (they offer their own VCS platforms)


## CI/CD Pipelines

CI/CD pipelines डेवलपर्स को कोड के execution को **automate** करने में सक्षम बनाते हैं, जैसे कि build, test, और deploy करने के लिए। ये automated workflows विशिष्ट actions से **trigger** होते हैं, जैसे code pushes, pull requests, या scheduled tasks. ये development से production तक के प्रोसेस को streamline करने में उपयोगी हैं।

हालाँकि, इन सिस्टम्स को किसी न किसी जगह पर **execute** होना पड़ता है और आमतौर पर उन्हें **privileged credentials** चाहिए होते हैं ताकि वे code deploy कर सकें या sensitive information तक पहुँच पाएं।

## VCS Pentesting Methodology

> [!NOTE]
> Even if some VCS platforms allow to create pipelines for this section we are going to analyze only potential attacks to the control of the source code.

जो platforms आपके project का source code रखते हैं उनमें sensitive जानकारी होती है और लोगों को इस प्लेटफ़ॉर्म के अंदर दिए गए permissions के साथ बहुत सावधान रहना चाहिए। ये कुछ सामान्य समस्याएँ हैं जो VCS platforms में attackers द्वारा abused की जा सकती हैं:

- **Leaks**: यदि आपका code commits में leaks रखता है और attacker repo तक पहुँच सकता है (क्योंकि यह public है या उसके पास access है), तो वह उन leaks को खोज सकता है।
- **Access**: यदि एक attacker VCS platform के अंदर किसी account तक **access** प्राप्त कर लेता है तो वह और भी अधिक visibility और permissions प्राप्त कर सकता है।
- **Register**: कुछ platforms बाहरी users को बस अकाउंट बनाने की अनुमति देते हैं।
- **SSO**: कुछ platforms users को register करने की अनुमति नहीं देते, पर किसी valid SSO के साथ किसी को भी access देने की अनुमति देते हैं (तो एक attacker उदाहरण के लिए अपने github account का उपयोग करके अंदर आ सकता है)।
- **Credentials**: Username+Pwd, personal tokens, ssh keys, Oauth tokens, cookies... उपयोगकर्ता अनेक प्रकार के tokens चोरी कर सकता है ताकि किसी न किसी तरह से repo तक पहुँच सके।
- **Webhooks**: VCS platforms webhooks generate करने की अनुमति देते हैं। यदि वे **not protected** हैं गैर-दिखने वाले secrets के साथ तो **attacker उनका गलत इस्तेमाल कर सकता है**।
- यदि कोई secret inplace नहीं है, तो attacker तृतीय पक्ष platform के webhook का दुरुपयोग कर सकता है
- यदि secret URL में है, तो वही बात होती है और attacker के पास secret भी होता है
- **Code compromise:** यदि एक malicious actor के पास repos पर किसी तरह की **write** access है, तो वह **malicious code** inject करने की कोशिश कर सकता है। सफल होने के लिए उसे संभवतः **branch protections** को **bypass** करना होगा। ये क्रियाएँ विभिन्न लक्ष्यों के साथ की जा सकती हैं:
- main branch को compromise करके **production compromise** करना।
- main (या अन्य branches) को compromise करके **developers की machines compromise** करना (क्योंकि वे अक्सर repo के अंदर tests, terraform या अन्य चीज़ें अपने machines पर execute करते हैं)।
- **Compromise the pipeline** (अगला सेक्शन देखें)

## Pipelines Pentesting Methodology

Pipeline को define करने का सबसे सामान्य तरीका है **CI configuration file जो repository में host किया गया हो** जिसे pipeline build करता है। यह file executed jobs के order, flow को प्रभावित करने वाली conditions, और build environment settings का विवरण देती है.\
ये files आम तौर पर एक consistent name और format रखती हैं, जैसे — Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), और GitHub Actions YAML files जो .github/workflows के अंतर्गत होते हैं। जब trigger होता है, pipeline job चुने गए स्रोत (उदा. commit / branch) से **code को pull करता है**, और CI configuration file में निर्दिष्ट commands को उस code पर **run** करता है।

इसलिए attacker का अंतिम लक्ष्य किसी न किसी तरह से उन configuration files या उन commands को **compromise** करना है जिनको वे execute करते हैं।

### PPE - Poisoned Pipeline Execution

The Poisoned Pipeline Execution (PPE) path SCM repository में permissions का उपयोग करके CI pipeline को manipulate करने और हानिकारक commands execute कराने का exploit करता है। जिन users के पास आवश्यक permissions होते हैं वे CI configuration files या pipeline job द्वारा उपयोग की जाने वाली अन्य files को modify कर के malicious commands शामिल कर सकते हैं। यह CI pipeline को "poison" कर देता है, जिससे ये malicious commands execute हो जाते हैं।

एक malicious actor के लिए PPE attack सफल होने के लिए उसे सक्षम होना चाहिए कि:

- VCS platform पर उसके पास **write access** हो, क्योंकि आमतौर पर pipelines तब trigger होते हैं जब push या pull request किया जाता है। (Access पाने के तरीकों के सार के लिए VCS pentesting methodology देखें).
- ध्यान दें कि कभी-कभी एक **external PR को "write access" माना जा सकता है**।
- भले ही उसके पास write permissions हों, उसे यह सुनिश्चित करना होगा कि वह **CI config file या उन अन्य files को modify कर सके जिन पर config निर्भर करता है**।
- इसके लिए उसे संभवतः **branch protections** को **bypass** करने में सक्षम होना चाहिए।

PPE के 3 रूप हैं:

- **D-PPE**: A **Direct PPE** attack तब होता है जब actor उस CI config file को **modify** कर देता है जिसे execute किया जाना है।
- **I-DDE**: An **Indirect PPE** attack तब होता है जब actor उस **file** को **modify** करता है जिस पर CI config file निर्भर करती है (जैसे make file या terraform config)।
- **Public PPE or 3PE**: कुछ मामलों में pipelines उन users द्वारा trigger किए जा सकते हैं जिनके पास repo में write access नहीं होता (और जो org का हिस्सा भी नहीं हो सकते) क्योंकि वे PR भेज सकते हैं।
- **3PE Command Injection**: आम तौर पर, CI/CD pipelines **environment variables** सेट करते हैं जिनमें **PR के बारे में जानकारी** होती है। यदि उस value को attacker द्वारा नियंत्रित किया जा सकता है (जैसे PR का title) और वह value किसी **dangerous जगह** (जैसे sh commands execute करने में) उपयोग होती है, तो attacker वहाँ **command inject** कर सकता है।

### Exploitation Benefits

Poisoned pipeline के 3 रूपों को जानने के बाद, चलिए देखते हैं कि सफल exploitation के बाद attacker क्या प्राप्त कर सकता है:

- **Secrets**: जैसा कि पहले बताया गया, pipelines अपने jobs के लिए **privileges** चाहती हैं (code retrieve करना, build करना, deploy करना...) और ये privileges आमतौर पर **secrets** में store किए जाते हैं। ये secrets अक्सर **env variables या system के अंदर files** के माध्यम से उपलब्ध होते हैं। इसलिए attacker हमेशा अधिक से अधिक secrets exfiltrate करने की कोशिश करेगा।
- pipeline platform पर निर्भर करते हुए attacker को **config में secrets specify करने की आवश्यकता** पड़ सकती है। इसका मतलब है कि यदि attacker CI configuration pipeline को modify नहीं कर सकता (**I-PPE** उदाहरण), तो वह केवल उन्हीं secrets को exfiltrate कर सकता है जो उस pipeline के पास हैं।
- **Computation**: code कहीं execute होता है; कहाँ execute होता है इस पर निर्भर करते हुए attacker आगे pivot कर सकता है।
- **On-Premises**: यदि pipelines on premises execute होते हैं, तो attacker एक internal network में पहुँच सकता है जहाँ और भी resources उपलब्ध हो सकते हैं।
- **Cloud**: attacker अन्य machines तक access कर सकता है cloud में, पर साथ ही IAM roles/service accounts **tokens** exfiltrate कर के cloud के अंदर और आगे का access प्राप्त कर सकता है।
- **Platforms machine**: कभी-कभी jobs pipelines platform machines के अंदर execute होते हैं, जो आमतौर पर cloud के अंदर होते हैं और जिनके पास ज्यादा access नहीं होता।
- **Select it:** कभी-कभी **pipelines platform ने कई machines configure की होती हैं** और यदि आप CI configuration file को modify कर सकते हैं तो आप **निर्दिष्ट कर सकते हैं कि आप malicious code कहाँ चलाना चाहते हैं**। ऐसी स्थिति में attacker संभवतः प्रत्येक मशीन पर reverse shell चला कर आगे exploit करने की कोशिश करेगा।
- **Compromise production**: यदि आप pipeline के अंदर हैं और final version वहीं से build और deploy होता है, तो आप production में चलने वाले code को compromise कर सकते हैं।

## More relevant info

### Tools & CIS Benchmark

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) is an open-source tool for auditing your software supply chain stack for security compliance based on a new [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). The auditing focuses on the entire SDLC process, where it can reveal risks from code time into deploy time.

### Top 10 CI/CD Security Risk

Check this interesting article about the top 10 CI/CD risks according to Cider: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

- On each platform that you can run locally you will find how to launch it locally so you can configure it as you want to test it
- Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatic Tools

- [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** is a static code analysis tool for infrastructure-as-code.

## References

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&utm_medium=github_page&utm_campaign=ci%2fcd%20goat_060422)


{{#include ../banners/hacktricks-training.md}}
