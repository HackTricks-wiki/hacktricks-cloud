# Pentesting CI/CD 方法论

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS 代表 Version Control System，該系統允許開發者管理其源代碼。最常見的是 **git**，你通常會在以下平台之一看到公司使用它：

- Github
- Gitlab
- Bitbucket
- Gitea
- Gitblit
- Cloud providers (they offer their own VCS platforms)


## CI/CD Pipelines

CI/CD pipelines 允許開發者自動化執行代碼以達成多種目的，包括構建、測試和部署應用。這些自動化工作流會由特定動作觸發，例如 code pushes、pull requests 或排程任務。它們有助於精簡從開發到生產的流程。

然而，這些系統需要在某處被執行，且通常需要帶有特權的憑證來部署代碼或存取敏感資訊。

## VCS Pentesting Methodology

> [!NOTE]
> 即使有些 VCS 平台允許為本節建立 pipelines，我們將只分析對源代碼控制的潛在攻擊。

儲存專案源代碼的平台包含敏感資訊，因此需要非常小心在此平台內授予的權限。以下是攻擊者可能濫用的一些常見問題：

- **Leaks**: 如果你的代碼在提交中包含 leaks，且攻擊者能夠存取該 repo（因為是公開的或他有存取權），他可能會發現這些 leaks。
- **Access**: 如果攻擊者能夠存取 VCS 平台內的某個帳號，他可能會獲得更多的能見度和權限。
- **Register**: 有些平台允許外部使用者直接註冊帳號。
- **SSO**: 有些平台不允許註冊，但允許任何擁有有效 SSO 的人登入（例如攻擊者可以用他的 github 帳號登入）。
- **Credentials**: Username+Pwd、personal tokens、ssh keys、Oauth tokens、cookies……有多種類型的 token，使用者可能會被竊取來以某種方式存取 repo。
- **Webhooks**: VCS 平台允許產生 webhooks。如果它們沒有以不可見的 secret 保護，攻擊者可能會濫用它們。
- 如果沒有 secret，攻擊者可以濫用第三方平台的 webhook
- 如果 secret 在 URL 中，同樣會發生，而且攻擊者也會得到該 secret
- **Code compromise:** 如果惡意行為者對 repo 具有某種寫入權限，他可能會嘗試注入惡意代碼。為了成功，他可能需要繞過 branch protections。這些行為可為達成不同目標而執行：
  - 妥協 main branch 以便進一步妥協 production。
  - 妥協 main（或其他 branch）以妥協開發者的機器（因為他們通常會在自己的機器上執行測試、terraform 或其他來自 repo 的東西）。
- **Compromise the pipeline** (見下一節)


## Pipelines Pentesting Methodology

定義 pipeline 最常見的方式，是在被構建的 repository 中使用一個 **CI configuration file**。該檔描述了被執行 job 的順序、影響流程的條件，以及構建環境設定。\
這些檔案通常有一致的名稱與格式，例如 — Jenkinsfile (Jenkins)、.gitlab-ci.yml (GitLab)、.circleci/config.yml (CircleCI)，以及位於 .github/workflows 下的 GitHub Actions YAML 檔。當被觸發時，pipeline job 會從選定的來源（例如 commit / branch）**拉取代碼**，並針對該代碼**執行 CI configuration file 中指定的命令**。

因此，攻擊者的最終目標是以某種方式**妥協那些設定檔**或是**它們所執行的命令**。

> [!TIP]
> 有些 hosted builders 允許 contributors 選擇 Docker build context 與 Dockerfile 路徑。如果 context 可被攻擊者控制，你可能會將其設在 repo 之外（例如 ".."）以便在構建期間吸入主機檔案並外洩 secrets。詳見：
>
>{{#ref}}
>docker-build-context-abuse.md
>{{#endref}}

### PPE - Poisoned Pipeline Execution

Poisoned Pipeline Execution (PPE) 路徑利用 SCM repository 的權限來操控 CI pipeline 並執行有害命令。具有必要權限的使用者可以修改 CI configuration 檔或 pipeline job 使用的其他檔案，以包含惡意命令。這會「poison」CI pipeline，導致執行這些惡意命令。

要成功執行 PPE 攻擊，惡意行為者需要能夠：

- 擁有 **write access to the VCS platform**，因為通常 pipeline 是在 push 或 pull request 發生時被觸發。（查看 VCS pentesting methodology 以取得取得存取的摘要）
- 注意有時外部 PR 也會算作「write access」。
- 即便他有寫入權限，他還需要確定能**修改 CI config file 或其他 CI config 所依賴的檔案**。
- 為此，他可能需要能夠**繞過 branch protections**。

PPE 有 3 種變體：

- **D-PPE**: Direct PPE 發生在攻擊者直接**修改將要被執行的 CI config** 檔時。
- **I-DDE**: Indirect PPE 發生在攻擊者**修改**CI config 所依賴的**檔案**（例如 make file 或 terraform config）。
- **Public PPE or 3PE**: 在某些情況下，pipelines 可以被沒有寫入權限的使用者（甚至不是 org 成員）觸發，因為他們可以送出 PR。
- **3PE Command Injection**: 通常，CI/CD pipelines 會以環境變數設定有關 PR 的資訊。如果該值可被攻擊者控制（例如 PR 的標題），且被用在危險的位置（例如執行 sh 命令），攻擊者可能會在其中**注入命令**。

### Exploitation Benefits

了解三種 poison pipeline 的變體後，來看攻擊者在成功利用後可能獲得的東西：

- **Secrets**: 如前所述，pipeline 的 job 需要特權（取得代碼、構建、部署…），這些特權通常以 secrets 的形式存在。這些 secrets 通常可透過 **env variables 或系統內的檔案** 存取。因此攻擊者會盡可能嘗試外洩最多的 secrets。
- 根據 pipeline 平台，攻擊者可能**需要在 config 中指定 secrets**。這代表如果攻擊者無法修改 CI configuration pipeline（例如 I-PPE），他可能**只能外洩該 pipeline 本身擁有的 secrets**。
- **Computation**: 代碼會在某處被執行，視執行位置不同，攻擊者可能能夠進一步 pivot。
- **On-Premises**: 若 pipeline 在內部執行，攻擊者可能進入內網並存取更多資源。
- **Cloud**: 攻擊者可能存取雲端中的其他機器，或外洩 IAM roles/service accounts tokens 以在雲端內獲得更深入的存取。
- **Platforms machine**: 有時 job 會在 pipelines platform 的機器上執行，這些機器通常位於雲端且沒有更多的額外存取權限。
- **Select it:** 有時 pipelines platform 會配置多台機器，如果你能修改 CI configuration file，你可以指定在哪台機器上運行惡意代碼。在這種情況下，攻擊者可能會在每台可用機器上運行反向 shell 以進一步嘗試利用。
- **Compromise production**: 如果你已進入 pipeline，且最終版本是從 pipeline 建構並部署的，你可以妥協將在 production 運行的程式碼。

## More relevant info

### Tools & CIS Benchmark

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) 是一個開源工具，用以根據新的 [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf) 對你的 software supply chain stack 做安全合規性審核。該審核涵蓋整個 SDLC 流程，可揭露從代碼提交到部署階段的風險。

### Top 10 CI/CD Security Risk

參考 Cider 所列的 CI/CD 前十大風險，詳見： [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

- 對於每個可以在本機執行的平台，你會找到如何在本機啟動的說明，以便你可以按需配置來測試。
- Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatic Tools

- [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** 是一個針對 infrastructure-as-code 的靜態代碼分析工具。

## References

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&utm_medium=github_page&utm_campaign=ci%2fcd%20goat_060422)


{{#include ../banners/hacktricks-training.md}}
