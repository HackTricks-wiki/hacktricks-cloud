# Pentesting CI/CD Μεθοδολογία

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS σημαίνει **Version Control System**, αυτό το σύστημα επιτρέπει στους προγραμματιστές να **διαχειρίζονται τον source code τους**. Το πιο κοινό είναι το **git** και συνήθως θα βρείτε εταιρείες να το χρησιμοποιούν σε μία από τις παρακάτω **platforms**:

- Github
- Gitlab
- Bitbucket
- Gitea
- Gitblit
- Cloud providers (they offer their own VCS platforms)


## CI/CD Pipelines

Τα CI/CD pipelines επιτρέπουν στους developers να **αυτοματοποιήσουν την εκτέλεση κώδικα** για διάφορους σκοπούς, όπως build, test και deploy εφαρμογών. Αυτά τα αυτοματοποιημένα workflows **trigger-άρονται από συγκεκριμένες ενέργειες**, όπως code pushes, pull requests ή scheduled tasks. Είναι χρήσιμα για να απλοποιηθεί η ροή από development προς production.

Ωστόσο, αυτά τα συστήματα πρέπει να **τρέξουν κάπου** και συνήθως χρειάζονται **προνομιακά credentials για να κάνουν deploy code ή να έχουν πρόσβαση σε ευαίσθητες πληροφορίες**.

## VCS Pentesting Methodology

> [!NOTE]
> Ακόμα κι αν κάποιες πλατφόρμες VCS επιτρέπουν τη δημιουργία pipelines, σε αυτή την ενότητα θα αναλύσουμε μόνο πιθανές επιθέσεις που στοχεύουν τον έλεγχο του source code.

Οι πλατφόρμες που περιέχουν τον source code του project σας έχουν ευαίσθητες πληροφορίες και πρέπει να δοθεί μεγάλη προσοχή στα permissions που απονέμονται μέσα σε αυτήν την πλατφόρμα. Αυτά είναι μερικά κοινά προβλήματα σε VCS πλατφόρμες που ένας επιτιθέμενος θα μπορούσε να εκμεταλλευτεί:

- **Leaks**: Αν ο κώδικάς σας περιέχει leaks στα commits και ο επιτιθέμενος μπορεί να έχει πρόσβαση στο repo (επειδή είναι public ή γιατί έχει access), θα μπορούσε να ανακαλύψει τα leaks.
- **Access**: Αν ένας επιτιθέμενος μπορεί να **πρόσβαση σε έναν λογαριασμό μέσα στην VCS πλατφόρμα** θα μπορούσε να αποκτήσει **μεγαλύτερη ορατότητα και δικαιώματα**.
- **Register**: Κάποιες πλατφόρμες απλά επιτρέπουν σε εξωτερικούς χρήστες να δημιουργήσουν account.
- **SSO**: Κάποιες πλατφόρμες δεν επιτρέπουν εγγραφή χρηστών, αλλά επιτρέπουν σε οποιονδήποτε να κάνει login με ένα έγκυρο SSO (έτσι ένας επιτιθέμενος θα μπορούσε για παράδειγμα να χρησιμοποιήσει τον github account του για είσοδο).
- **Credentials**: Username+Pwd, personal tokens, ssh keys, Oauth tokens, cookies... υπάρχουν διάφοροι τύποι tokens που ένας χρήστης θα μπορούσε να κλέψει για να αποκτήσει με κάποιο τρόπο πρόσβαση σε ένα repo.
- **Webhooks**: Οι VCS πλατφόρμες επιτρέπουν τη δημιουργία webhooks. Αν δεν προστατεύονται με μη ορατά secrets, ένας επιτιθέμενος θα μπορούσε να τα εκμεταλλευτεί.
  - Αν δεν υπάρχει κάποιο secret, ο επιτιθέμενος μπορεί να εκμεταλλευτεί το webhook της τρίτης πλατφόρμας.
  - Αν το secret βρίσκεται στο URL, ισχύει το ίδιο και ο επιτιθέμενος έχει επίσης το secret.
- **Code compromise:** Αν ένας κακόβουλος παράγοντας έχει κάποια μορφή **write** πρόσβασης στα repos, μπορεί να προσπαθήσει να **inject malicious code**. Για να το πετύχει πιθανόν να χρειαστεί να **bypass branch protections**. Αυτές οι ενέργειες μπορούν να έχουν διάφορους στόχους:
  - Compromise το main branch για να **compromise production**.
  - Compromise το main (ή άλλα branches) για να **compromise τα machines των developers** (καθώς συνήθως εκτελούν tests, terraform ή άλλα πράγματα μέσα στο repo στους δικούς τους υπολογιστές).
  - **Compromise the pipeline** (βλέπε επόμενη ενότητα)

## Pipelines Pentesting Methodology

Ο πιο κοινός τρόπος για να ορίσετε ένα pipeline είναι με χρήση ενός **CI configuration file που φιλοξενείται στο repository** που το pipeline build-άρει. Αυτό το αρχείο περιγράφει τη σειρά των jobs που εκτελούνται, τις συνθήκες που επηρεάζουν τη ροή και τις ρυθμίσεις του build environment.\
Αυτά τα αρχεία συνήθως έχουν συνεπή ονόματα και format, για παράδειγμα — Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), και τα GitHub Actions YAML αρχεία κάτω από .github/workflows. Όταν trigger-άρεται, το pipeline job **τραβάει τον κώδικα** από την επιλεγμένη πηγή (π.χ. commit / branch) και **εκτελεί τις εντολές που ορίζονται στο CI configuration file** πάνω σε αυτόν τον κώδικα.

Άρα ο τελικός στόχος του επιτιθέμενου είναι με κάποιο τρόπο να **compromise αυτά τα configuration files** ή τις **εντολές που εκτελούν**.

### PPE - Poisoned Pipeline Execution

Το Poisoned Pipeline Execution (PPE) path εκμεταλλεύεται permissions σε ένα SCM repository για να χειραγωγήσει ένα CI pipeline και να εκτελέσει επιβλαβείς εντολές. Χρήστες με τα κατάλληλα permissions μπορούν να τροποποιήσουν CI configuration files ή άλλα αρχεία που χρησιμοποιεί το pipeline job ώστε να περιλάβουν κακόβουλες εντολές. Αυτό "δηλητηριάζει" το CI pipeline, οδηγώντας στην εκτέλεση αυτών των κακόβουλων εντολών.

Για να είναι επιτυχής ένας κακόβουλος παράγοντας σε μια PPE επίθεση χρειάζεται να:

- Έχει **write access στο VCS**, καθώς συνήθως τα pipelines trigger-άρονται όταν γίνεται push ή pull request. (Δες τη VCS pentesting methodology για σύνοψη τρόπων απόκτησης access).
- Σημειώστε ότι μερικές φορές ένα **external PR μετράει ως "write access"**.
- Ακόμα κι αν έχει write permissions, πρέπει να βεβαιωθεί ότι μπορεί να **τροποποιήσει το CI config file ή άλλα αρχεία από τα οποία εξαρτάται το config**.
- Γι' αυτό ίσως χρειαστεί να μπορέσει να **bypass branch protections**.

Υπάρχουν 3 flavours του PPE:

- **D-PPE**: Μια **Direct PPE** επίθεση συμβαίνει όταν ο παράγοντας **τροποποιεί απευθείας το CI config** που πρόκειται να εκτελεστεί.
- **I-DDE**: Μια **Indirect PPE** επίθεση συμβαίνει όταν ο παράγοντας **τροποποιεί** κάποιο **file** πάνω στο οποίο το CI config βασίζεται (π.χ. make file ή terraform config).
- **Public PPE or 3PE**: Σε ορισμένες περιπτώσεις τα pipelines μπορούν να **trigger-αριστούν από χρήστες που δεν έχουν write access στο repo** (και που ίσως δεν είναι καν μέλη της οργάνωσης) επειδή μπορούν να στείλουν ένα PR.
- **3PE Command Injection**: Συνήθως, τα CI/CD pipelines θα **ορίζουν env variables** με **πληροφορίες για το PR**. Αν αυτή η τιμή μπορεί να ελεγχθεί από έναν επιτιθέμενο (π.χ. ο τίτλος του PR) και **χρησιμοποιείται** σε ένα **επικίνδυνο σημείο** (όπως η εκτέλεση sh εντολών), ένας επιτιθέμενος μπορεί να **εγχύσει εντολές εκεί μέσα**.

### Exploitation Benefits

Γνωρίζοντας τα 3 flavours για να δηλητηριάσετε ένα pipeline, ας δούμε τι μπορεί να αποκτήσει ένας επιτιθέμενος μετά από επιτυχή εκμετάλλευση:

- **Secrets**: Όπως αναφέρθηκε νωρίτερα, τα pipelines απαιτούν **privileges** για τα jobs τους (τραβούν τον κώδικα, κάνουν build, deploy κ.λπ.) και αυτά τα privileges συνήθως **αποθηκεύονται σε secrets**. Αυτά τα secrets είναι συνήθως προσβάσιμα μέσω **env variables ή αρχείων μέσα στο σύστημα**. Επομένως ένας επιτιθέμενος θα προσπαθήσει πάντα να εξαγάγει όσο το δυνατόν περισσότερα secrets.
- Ανάλογα με την πλατφόρμα pipeline, ο επιτιθέμενος **μπορεί να χρειαστεί να δηλώσει τα secrets στο config**. Αυτό σημαίνει ότι αν ο επιτιθέμενος δεν μπορεί να τροποποιήσει το CI configuration pipeline (**I-PPE** για παράδειγμα), θα μπορούσε **μόνο να εξαγάγει τα secrets που ήδη έχει το pipeline**.
- **Computation**: Ο κώδικας εκτελείται κάπου· ανάλογα με το που εκτελείται, ένας επιτιθέμενος μπορεί να μπορέσει να κάνει pivot παραπέρα.
- **On-Premises**: Αν τα pipelines τρέχουν on-premises, ένας επιτιθέμενος μπορεί να βρεθεί σε ένα **εσωτερικό δίκτυο με πρόσβαση σε περισσότερους πόρους**.
- **Cloud**: Ο επιτιθέμενος μπορεί να αποκτήσει πρόσβαση σε **άλλες μηχανές στο cloud** αλλά και να **εξαγάγει** IAM roles/service accounts **tokens** για να αποκτήσει περαιτέρω πρόσβαση μέσα στο cloud.
- **Platforms machine**: Μερικές φορές τα jobs εκτελούνται μέσα στις μηχανές της pipelines πλατφόρμας, που συνήθως είναι μέσα σε ένα cloud και δεν έχουν περισσότερο access.
- **Select it:** Μερικές φορές η **πλατφόρμα pipelines έχει διαμορφώσει πολλές μηχανές** και αν μπορείτε να **τροποποιήσετε το CI configuration file** μπορείτε να **υποδείξετε πού θέλετε να τρέξει ο κακόβουλος κώδικας**. Σε αυτή την περίπτωση, ένας επιτιθέμενος πιθανώς θα τρέξει ένα reverse shell σε κάθε διαθέσιμη μηχανή για να προσπαθήσει να το εκμεταλλευτεί περαιτέρω.
- **Compromise production**: Αν βρίσκεστε μέσα στο pipeline και η τελική έκδοση build-άρεται και deploy-άρεται από αυτό, μπορείτε να **compromise τον κώδικα που θα τρέξει στην production**.

## Περισσότερες σχετικές πληροφορίες

### Tools & CIS Benchmark

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) είναι ένα open-source εργαλείο για auditing του software supply chain stack για security compliance βάσει ενός νέου [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). Το auditing εστιάζει σε όλη τη διαδικασία SDLC, όπου μπορεί να αποκαλύψει κινδύνους από το code μέχρι το deploy.

### Top 10 CI/CD Security Risk

Δείτε αυτό το ενδιαφέρον άρθρο σχετικά με τα top 10 CI/CD risks σύμφωνα με την Cider: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

- Σε κάθε πλατφόρμα που μπορείτε να τρέξετε τοπικά θα βρείτε οδηγίες για το πώς να την launch-άρετε τοπικά ώστε να την διαμορφώσετε όπως θέλετε για testing.
- Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatic Tools

- [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** είναι ένα static code analysis εργαλείο για infrastructure-as-code.

## Αναφορές

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&utm_medium=github_page&utm_campaign=ci%2fcd%20goat_060422)


{{#include ../banners/hacktricks-training.md}}
