# Pentesting CI/CD 手法

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS は **Version Control System** の略で、開発者が **ソースコードを管理する**ためのシステムです。最も一般的なのは **git** で、企業では通常次のような **platforms** のいずれかを使っています:

- Github
- Gitlab
- Bitbucket
- Gitea
- Gitblit
- Cloud providers (they offer their own VCS platforms)


## CI/CD Pipelines

CI/CD パイプラインは、アプリケーションのビルド、テスト、デプロイなどの目的で **コードの実行を自動化**する仕組みです。これらの自動ワークフローは、コードの push、pull request、スケジュールされたタスクなどの特定のアクションによって **トリガーされます**。開発から本番へのプロセスを効率化するのに役立ちます。

しかし、これらのシステムはどこかで **実行される必要があり**、通常は**コードをデプロイしたり機密情報にアクセスするための特権的な認証情報**を必要とします。

## VCS Pentesting Methodology

> [!NOTE]
> Even if some VCS platforms allow to create pipelines for this section we are going to analyze only potential attacks to the control of the source code.

リポジトリにソースコードが含まれているプラットフォームには機密情報が含まれることがあり、プラットフォーム内で付与される権限に細心の注意を払う必要があります。攻撃者が悪用できる一般的な問題は次のとおりです:

- **Leaks**: コードに commits に含まれる leaks があり、攻撃者がリポジトリにアクセスできる（公開やアクセス権がある場合）と、それらの leaks を発見する可能性があります。
- **Access**: 攻撃者が **VCS platform 内のアカウントにアクセスできる**と、**より多くの可視性や権限**を得ることができます。
- **Register**: 一部のプラットフォームでは外部ユーザがアカウントを作成できてしまいます。
- **SSO**: 一部のプラットフォームはユーザ登録を許可していないが、有効な SSO であれば誰でもアクセスできる場合があります（例: 攻撃者が自分の github アカウントで入れる、など）。
- **Credentials**: Username+Pwd、personal tokens、ssh keys、Oauth tokens、cookies... ユーザがリポジトリに何らかの形でアクセスするために盗めるトークンはいくつもあります。
- **Webhooks**: VCS プラットフォームは webhook を生成できます。これらが非表示の secret で**保護されていない**場合、**攻撃者が悪用**する可能性があります。
  - secret が設定されていない場合、攻撃者はサードパーティのプラットフォームの webhook を悪用できます。
  - secret が URL に含まれている場合も同様で、攻撃者はその secret を入手できます。
- **Code compromise:** 悪意のある行為者がリポジトリに対して何らかの **write** 権限を持っている場合、**悪意のあるコードを注入**しようとする可能性があります。成功するには **branch protections を回避**する必要があるかもしれません。これらの行為は様々な目的で実行され得ます:
  - main ブランチを妥協して **production を侵害**する。
  - main（または他のブランチ）を妥協して **開発者のマシンを侵害**する（開発者は通常リポジトリ内で test、terraform などを実行するため）。
  - **パイプラインを妥協する**（次のセクションを参照）

## Pipelines Pentesting Methodology

パイプラインを定義する最も一般的な方法は、**ビルド対象のリポジトリにホストされている CI 設定ファイル**を使用することです。このファイルは実行されるジョブの順序、フローに影響する条件、ビルド環境の設定などを記述します。\
これらのファイルは典型的に一貫した名前と形式を持ちます。例えば — Jenkinsfile (Jenkins)、.gitlab-ci.yml (GitLab)、.circleci/config.yml (CircleCI)、そして .github/workflows 以下にある GitHub Actions の YAML ファイルなどです。トリガーされると、パイプラインジョブは選択されたソース（例: commit / branch）から **コードを pull** し、そのコードに対して CI 設定ファイルで指定されたコマンドを **実行します**。

したがって、攻撃者の究極の目的はこれらの設定ファイルやそれらが実行するコマンドを何らかの形で **妥協すること**です。

### PPE - Poisoned Pipeline Execution

Poisoned Pipeline Execution (PPE) パスは、SCM リポジトリ内の権限を悪用して CI パイプラインを操作し、有害なコマンドを実行させる攻撃です。必要な権限を持つユーザは CI 設定ファイルやパイプラインジョブで使用されるファイルを修正して悪意あるコマンドを含めることができます。これにより CI パイプラインが「毒され」、その悪意あるコマンドが実行されます。

攻撃者が PPE 攻撃を成功させるために必要なもの:

- **VCS platform への write access** を持っていること。通常パイプラインは push や pull request が実行されたときにトリガーされます。（VCS pentesting methodology を参照してアクセスを得る方法の概要を確認してください。）
- 注: 場合によっては **外部の PR が "write access" と見なされる**ことがあります。
- 書き込み権限があっても、**CI config ファイルや config が依存している他のファイルを修正できるか**を確認する必要があります。
- そのためには branch protections を **回避できる**必要があるかもしれません。

PPE には 3 つのバリエーションがあります:

- **D-PPE**: CI config ファイル自体を直接 **修正する**ことで発生する **Direct PPE** 攻撃。
- **I-DDE**: CI config が依存している **ファイル**（Makefile や terraform 設定など）を **修正する**ことで発生する **Indirect PPE** 攻撃。
- **Public PPE or 3PE**: 場合によってはパイプラインがリポジトリへの write access を持たないユーザ（組織外のユーザを含む）が PR を送ることで **トリガーされる**ことがあります。
- **3PE Command Injection**: 通常、CI/CD パイプラインは **PR に関する情報を環境変数として設定**します。もしその値を攻撃者が制御でき（例: PR のタイトル）、かつそれが（sh コマンドの実行など）**危険な場所で使われている**と、攻撃者はそこに **コマンドを注入**できる可能性があります。

### Exploitation Benefits

PPE の 3 つのバリエーションを把握した上で、攻撃者が成功した場合に得られるものを見てみましょう:

- **Secrets**: 前述の通り、パイプラインのジョブは（コードを取得・ビルド・デプロイするなど）**特権**を必要とし、これらの特権は通常 **secrets** として付与されます。これらの secrets は通常 **env variables やシステム内のファイル**を通じてアクセス可能です。したがって攻撃者は可能な限り多くの secrets を常に抽出しようとします。
- パイプラインプラットフォームによっては、攻撃者が秘密情報を利用するためにそれらを config に明示する必要がある場合があります。つまり、攻撃者が CI 設定ファイルを変更できない場合（例: I-PPE の場合）、**そのパイプラインが持つ secrets のみを抽出**できる可能性があります。
- **Computation**: コードはどこかで実行されます。実行場所によっては攻撃者がさらにピボットできる可能性があります。
- **On-Premises**: パイプラインがオンプレミスで実行されている場合、攻撃者は **内部ネットワークに入り込み、より多くのリソースにアクセス**できる可能性があります。
- **Cloud**: 攻撃者はクラウド内の他のマシンにアクセスできるだけでなく、IAM ロール／service account の **トークンを exfiltrate**してクラウド内でさらに権限を得ることも可能です。
- **Platforms machine**: 場合によってはジョブが **パイプラインプラットフォームのマシン内で実行され**、これらは通常クラウド内にあり追加のアクセス権を持たないこともあります。
- **Select it:** 時には **パイプラインプラットフォームが複数のマシンを構成している**ことがあり、CI 設定ファイルを修正できれば **悪意あるコードを実行したいマシンを指定**できます。この状況では攻撃者は各マシンでリバースシェルを実行してさらに攻撃を仕掛けようとするでしょう。
- **Compromise production**: パイプライン内に侵入し、そのパイプラインから最終バージョンがビルド・デプロイされる場合、**本番で実行されるコードを妥協**できます。

## More relevant info

### Tools & CIS Benchmark

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) はオープンソースのツールで、新しい [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf) に基づきソフトウェアサプライチェーンスタックのセキュリティコンプライアンスを監査します。監査は SDLC 全体に焦点を当て、コード段階からデプロイ段階までのリスクを明らかにします。

### Top 10 CI/CD Security Risk

Cider による CI/CD のトップ10 リスクに関する興味深い記事を確認してください: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

- ローカルで実行できる各プラットフォームについて、ローカルで起動して設定を調整できる方法が記載されています。
- Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatic Tools

- [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** は infrastructure-as-code に対する静的コード解析ツールです。

## References

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&utm_medium=github_page&utm_campaign=ci%2fcd%20goat_060422)


{{#include ../banners/hacktricks-training.md}}
