# Pentesting CI/CD Metodolojisi

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS, **Version Control System** anlamına gelir; bu sistemler geliştiricilerin **kaynak kodlarını yönetmelerini** sağlar. En yaygın olanı **git**'tir ve şirketlerin genellikle aşağıdaki **platformlar**dan birini kullandığını görürsünüz:

- Github
- Gitlab
- Bitbucket
- Gitea
- Gitblit
- Cloud providers (they offer their own VCS platforms)


## CI/CD Pipelines

CI/CD pipelines geliştiricilerin kodu **otomatik olarak çalıştırmasını** sağlar; bu, build, test ve uygulamaların deploy edilmesi gibi amaçlar için kullanılır. Bu otomatik iş akışları, kod push'ları, pull request'ler veya zamanlanmış görevler gibi **belirli aksiyonlarla tetiklenir**. Geliştirmeden üretime giden süreci düzene sokmak için faydalıdır.

Ancak bu sistemlerin bir yerde **çalıştırılması gerekir** ve genellikle **kod deploy etmek veya hassas bilgilere erişmek için yetkili kimlik bilgileri** ile çalışırlar.

## VCS Pentesting Methodology

> [!NOTE]
> Even if some VCS platforms allow to create pipelines for this section we are going to analyze only potential attacks to the control of the source code.

Projenizin kaynak kodunu içeren platformlar hassas bilgiler barındırır ve insanlar bu platform içindeki izinler konusunda çok dikkatli olmalıdır. Saldırganların kötüye kullanabileceği VCS platformlarındaki yaygın sorunlardan bazıları şunlardır:

- **Leaks**: Kodunuz commit'lerde leaks içeriyorsa ve saldırgan repo'ya erişebiliyorsa (public olduğu için veya erişimi olduğu için) bu leak'leri keşfedebilir.
- **Access**: Bir saldırgan **VCS platformu içindeki bir hesaba erişim** sağlayabilirse daha fazla görünürlük ve izin elde edebilir.
- **Register**: Bazı platformlar dış kullanıcıların hesap oluşturmasına izin verir.
- **SSO**: Bazı platformlar kullanıcı kayıtına izin vermez, ancak geçerli bir SSO ile herkese erişim sağlar (örneğin bir saldırgan kendi github hesabını kullanarak girebilir).
- **Credentials**: Username+Pwd, personal tokens, ssh keys, Oauth tokens, cookies... bir kullanıcı bu tür çeşitli token'ları çalarak repo'ya bir şekilde erişebilir.
- **Webhooks**: VCS platformları webhook oluşturulmasına izin verir. Eğer bunlar görünmeyen secret'larla **korunmuyorsa**, bir **saldırgan bunları kötüye kullanabilir**.
- Eğer hiçbir secret kullanılmıyorsa, saldırgan üçüncü taraf platformun webhook'unu suistimal edebilir
- Eğer secret URL içinde ise aynı durum olur ve saldırgan ayrıca secret'a da sahip olur
- **Code compromise:** Kötü niyetli bir aktör repo'larda bir tür **write** erişimine sahipse, **zararlı kod enjekte etmeyi** deneyebilir. Başarılı olabilmek için **branch korumalarını aşması** gerekebilir. Bu eylemler farklı amaçlarla gerçekleştirilebilir:
- Ana branch'i ele geçirerek **production'ı kompromize etmek**.
- Ana (veya diğer) branch'leri ele geçirerek **geliştirici makinelerini kompromize etmek** (çünkü geliştiriciler genellikle test, terraform veya repo içindeki diğer işleri makinelerinde çalıştırır).
- **Pipeline'ı kompromize etmek** (bir sonraki bölüme bakın)

## Pipelines Pentesting Methodology

Bir pipeline'ı tanımlamanın en yaygın yolu, pipeline'ın buildlediği repository'de barındırılan **CI konfigürasyon dosyası** kullanmaktır. Bu dosya çalıştırılan job'ların sırasını, akışı etkileyen koşulları ve build ortamı ayarlarını tanımlar.\
Bu dosyalar genellikle tutarlı bir isim ve formata sahiptir, örneğin — Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), ve GitHub Actions YAML dosyaları .github/workflows altında bulunur. Tetiklendiğinde, pipeline job'ı seçili kaynaktan (ör. commit / branch) **kodu pull eder** ve o koda karşılık CI konfigürasyon dosyasında **belirtilen komutları çalıştırır**.

Dolayısıyla saldırganın nihai hedefi bir şekilde bu konfigürasyon dosyalarını veya **çalıştırdıkları komutları kompromize etmektir**.

> [!TIP]
> Some hosted builders let contributors choose the Docker build context and Dockerfile path. If the context is attacker-controlled, you may set it outside the repo (e.g., "..") to ingest host files during build and exfiltrate secrets. See:
>
>{{#ref}}
>docker-build-context-abuse.md
>{{#endref}}

### PPE - Poisoned Pipeline Execution

The Poisoned Pipeline Execution (PPE) path exploits permissions in an SCM repository to manipulate a CI pipeline and execute harmful commands. Users with the necessary permissions can modify CI configuration files or other files used by the pipeline job to include malicious commands. This "poisons" the CI pipeline, leading to the execution of these malicious commands.

Bir saldırganın PPE saldırısını başarılı şekilde gerçekleştirebilmesi için şunlara ihtiyacı vardır:

- VCS platformunda **write access** sahibi olmak; çünkü genellikle pipeline'lar bir push veya pull request gerçekleştirildiğinde tetiklenir. (Erişim elde etme yolları için VCS pentesting methodology bölümüne bakın).
- Bazen bir **external PR'in "write access" olarak sayılabileceğini** unutmayın.
- Yazma izinleri olsa bile, **CI config dosyasını veya konfigürasyonun dayandığı diğer dosyaları** değiştirebildiğinden emin olmalıdır.
- Bunun için branch korumalarını **aşabilmesi** gerekebilir.

3 PPE çeşidi vardır:

- **D-PPE**: Bir **Direct PPE** saldırısı, aktörün **çalıştırılacak CI config** dosyasını **doğrudan değiştirdiği** durumda gerçekleşir.
- **I-DDE**: Bir **Indirect PPE** saldırısı, aktörün CI config dosyasının **dayandığı** (ör. make file veya terraform konfigürü gibi) bir **dosyayı değiştirdiği** durumda gerçekleşir.
- **Public PPE or 3PE**: Bazı durumlarda pipeline'lar, repo'da write access'i olmayan kullanıcılar (hatta org üyesi olmayanlar) tarafından gönderilen PR'lerle **tetiklenebilir**.
- **3PE Command Injection**: Genellikle, CI/CD pipeline'ları **PR hakkında bilgileri içeren environment variable'lar** ayarlar. Eğer bu değer bir saldırgan tarafından kontrol edilebiliyorsa (ör. PR başlığı) ve **tehlikeli bir yerde** (ör. **sh komutları** çalıştırılan yerde) **kullanılıyorsa**, saldırgan buraya **komut enjekte edebilir**.

### Exploitation Benefits

3 PPE çeşidini bildiğimize göre, başarılı bir sömürü sonrasında bir saldırganın elde edebileceklerine bakalım:

- **Secrets**: Daha önce de belirtildiği gibi, pipeline job'ları için kodu retrieve etmek, build etmek, deploy etmek vb. için **privilegeler** gerekmektedir ve bu privilegeler genellikle **secret'larda saklanır**. Bu secret'lar genellikle **env variables veya sistem içindeki dosyalar** aracılığıyla erişilebilir. Bu nedenle saldırgan mümkün olduğunca çok secret'ı exfiltrate etmeye çalışacaktır.
- Pipeline platformuna bağlı olarak saldırgan **secret'ların config içinde belirtilmesini** isteyebilir. Bu, eğer saldırgan CI konfigürasyon dosyasını değiştiremiyorsa (**I-PPE** gibi), yalnızca o pipeline'ın sahip olduğu secret'ları exfiltrate edebileceği anlamına gelir.
- **Computation**: Kod bir yerde çalıştırılır; nerede çalıştırıldığına bağlı olarak saldırgan daha ileriye pivot yapabilir.
- **On-Premises**: Eğer pipeline'lar on-premises çalıştırılıyorsa, saldırgan **iç ağa** erişebilir ve daha fazla kaynağa ulaşabilir.
- **Cloud**: Saldırgan bulut içindeki diğer makinelere erişebilir ancak ayrıca IAM role/service account **token'larını** exfiltrate ederek bulut içinde **daha fazla erişim** elde edebilir.
- **Platforms machine**: Bazen job'lar, genellikle daha fazla erişimi olmayan bir bulut içinde bulunan **pipeline platform makinelerinde** çalıştırılır.
- **Select it:** Bazen **pipeline platformu birden fazla makine** yapılandırmıştır ve eğer CI config dosyasını değiştirebiliyorsanız, **zararlı kodu hangi makinelerde çalıştırmak istediğinizi belirtebilirsiniz**. Bu durumda saldırgan muhtemelen her bir olası makinede ters bağlanma (reverse shell) çalıştırıp daha fazla istismar deneyecektir.
- **Compromise production**: Eğer pipeline içindeyseniz ve nihai sürüm buradan build edilip deploy ediliyorsa, production'da çalışacak kodu **kompromize edebilirsiniz**.

## More relevant info

### Tools & CIS Benchmark

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) açık kaynaklı bir araçtır ve yeni bir [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf) temelinde yazılım tedarik zinciri yığınıınızı güvenlik uyumluluğu açısından denetler. Denetim, koddan deploy anına kadar tüm SDLC sürecine odaklanır ve riskleri ortaya çıkarabilir.

### Top 10 CI/CD Security Risk

Cider'a göre CI/CD risklerinin en önemli 10 tanesini anlatan ilginç makaleyi inceleyin: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

- Lokal olarak çalıştırabileceğiniz her platform için, onu yerel olarak başlatıp istediğiniz gibi yapılandırarak test edebilmeniz için talimatlar bulacaksınız
- Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatic Tools

- [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** infrastructure-as-code için statik kod analizi aracıdır.

## References

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github\&utm_medium=github_page\&utm_campaign=ci%2fcd%20goat_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm_source=github&utm_medium=github_page&utm_campaign=ci%2fcd%20goat_060422)


{{#include ../banners/hacktricks-training.md}}
