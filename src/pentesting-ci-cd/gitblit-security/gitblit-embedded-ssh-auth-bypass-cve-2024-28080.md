# Gitblit Embedded SSH Auth Bypass (CVE-2024-28080)

{{#include ../../banners/hacktricks-training.md}}

## Özet

CVE-2024-28080, Apache MINA SSHD ile entegrasyon sırasında oturum durumu işleme hatası nedeniyle Gitblit’in embedded SSH servisinde bir kimlik doğrulama atlatmasıdır. Bir kullanıcı hesabında en az bir SSH public key kayıtlıysa, kullanıcı adını ve o kullanıcının herhangi bir public key'ini bilen bir saldırgan, private key veya parola olmadan kimlik doğrulaması yapabilir.

- Etkilenen: Gitblit < 1.10.0 (1.9.3 üzerinde gözlemlendi)
- Düzeltilen sürüm: 1.10.0
- Sömürmek için gereksinimler:
- Git over SSH örnekte etkin olmalı
- Hedef hesabında Gitblit’te en az bir SSH public key kayıtlı olmalı
- Saldırgan hedef kullanıcı adını ve kullanıcıya ait public key'lerden birini bilmeli (çoğunlukla keşfedilebilir, örn. https://github.com/<username>.keys)

## Kök neden (state leaks between SSH methods)

RFC 4252’ye göre, public‑key authentication iki aşamada ilerler: sunucu önce verilen public key’in bir kullanıcı adı için kabul edilebilir olup olmadığını kontrol eder ve ancak bir challenge/response ile imza gerçekleştiğinde kullanıcıyı doğrular. MINA SSHD’de PublickeyAuthenticator iki kez çağrılır: key kabulünde (henüz imza yok) ve daha sonra istemci bir imza döndüğünde.

Gitblit’in PublickeyAuthenticator’ı imzadan önceki ilk çağrıda session bağlamını değiştirerek authenticated UserModel’i session’a bağladı ve true döndürerek ("key acceptable") anahtarı kabul etti. Daha sonra kimlik doğrulama parola yöntemine düştüğünde, PasswordAuthenticator bu değiştirilmiş session durumuna güvenip kısa devre yaptı ve parolayı doğrulamadan true döndürdü. Sonuç olarak, aynı kullanıcı için önceki bir public‑key "acceptance" sonrası herhangi bir parola (boş olan dahil) kabul edildi.

Yüksek seviyede hatalı akış:

1) İstemci kullanıcı adı + public key sunar (henüz imza yok)  
2) Sunucu anahtarın kullanıcıya ait olduğunu tanır ve oturuma kullanıcıyı erken bağlar, true döndürür ("acceptable")  
3) İstemci imzalayamaz (private key yok), bu yüzden kimlik doğrulama parola yöntemine düşer  
4) Parola doğrulaması oturumda zaten bir kullanıcı olduğunu görür ve koşulsuz olarak başarılı döner

## Adım adım istismar

- Hedefin kullanıcı adını ve public key'lerinden birini topla:
- GitHub public key'leri şu adreste sunar: https://github.com/<username>.keys
- Public sunucular genellikle authorized_keys’i açığa çıkarır
- İmza oluşturma başarısız olacak şekilde OpenSSH’yi sadece public half’ı sunacak biçimde yapılandırarak, sunucuda public‑key kabul yolunu tetiklerken imzalama başarısızlığı nedeniyle kimlik doğrulamanın parola yöntemine düşmesini sağla.

Example SSH client config (no private key available):
```sshconfig
# ~/.ssh/config
Host gitblit-target
HostName <host-or-ip>
User <victim-username>
PubkeyAuthentication yes
PreferredAuthentications publickey,password
IdentitiesOnly yes
IdentityFile ~/.ssh/victim.pub   # public half only (no private key present)
```
Bağlanın ve parola isteminde Enter tuşuna basın (veya herhangi bir dize yazın):
```bash
ssh gitblit-target
# or Git over SSH
GIT_SSH_COMMAND="ssh -F ~/.ssh/config" git ls-remote ssh://<victim-username>@<host>/<repo.git>
```
Authentication succeeds because the earlier public‑key phase mutated the session to an authenticated user, and password auth incorrectly trusts that state.

Note: If ControlMaster multiplexing is enabled in your SSH config, subsequent Git commands may reuse the authenticated connection, increasing impact.

## Etki

- Herhangi bir Gitblit kullanıcısının (en az bir kayıtlı SSH public key ile) tam taklidi
- Hedef kullanıcının izinlerine göre depolara okuma/yazma erişimi (source exfiltration, yetkisiz pushes, supply‑chain riskleri)
- Hedeflenen kullanıcı bir admin ise potansiyel yönetici etkisi
- Tamamen ağ üzerinden sömürü; brute force veya private key gerektirmez

## Tespit fikirleri

- SSH logslarını inceleyin: bir publickey denemesi sonrası boş veya çok kısa bir parola ile başarılı bir password authentication olması durumlarını arayın
- Aşağıdaki akışları arayın: unsupported/mismatched key material sunan publickey method’dan hemen sonra aynı kullanıcı adı için anında password başarısı

## Önlemler

- Gitblit'i v1.10.0+ sürümüne yükseltin
- Yükseltilene kadar:
- Gitblit üzerinde Git over SSH'yi devre dışı bırakın, veya
- SSH servisine ağ erişimini kısıtlayın, ve
- Yukarıda tanımlanan şüpheli desenleri izleyin
- İhlal şüphesi varsa etkilenen kullanıcı kimlik bilgilerini değiştirin

## Genel: abusing SSH auth method state‑leakage (MINA/OpenSSH‑based services)

Pattern: If a server’s public‑key authenticator mutates user/session state during the pre‑signature "key acceptable" phase and other authenticators (e.g., password) trust that state, you can bypass authentication by:

- Presenting a legitimate public key for the target user (no private key)
- Forcing the client to fail signing so the server falls back to password
- Supplying any password while the password authenticator short‑circuits on leaked state

Practical tips:

- Public key harvesting at scale: pull public keys from common sources such as https://github.com/<username>.keys, organizational directories, team pages, leaked authorized_keys
- Forcing signature failure (client‑side): point IdentityFile to only the .pub, set IdentitiesOnly yes, keep PreferredAuthentications to include publickey then password
- MINA SSHD integration pitfalls:
- PublickeyAuthenticator.authenticate(...) must not attach user/session state until the post‑signature verification path confirms the signature
- PasswordAuthenticator.authenticate(...) must not infer success from any state mutated during a prior, incomplete authentication method

Related protocol/design notes and literature:
- SSH userauth protocol: RFC 4252 (publickey method is a two‑stage process)
- Historical discussions on early acceptance oracles and auth races, e.g., CVE‑2016‑20012 disputes around OpenSSH behavior

## Referanslar

- [Gitblit CVE-2024-28080: SSH public‑key fallback to password authentication bypass (Silent Signal blog)](https://blog.silentsignal.eu/2025/06/14/gitblit-cve-CVE-2024-28080/)
- [Gitblit v1.10.0 release notes](https://github.com/gitblit-org/gitblit/releases/tag/v1.10.0)
- [Apache MINA SSHD project](https://mina.apache.org/sshd-project/)
- [PublickeyAuthenticator API](https://svn.apache.org/repos/infra/websites/production/mina/content/sshd-project/apidocs/org/apache/sshd/server/auth/pubkey/PublickeyAuthenticator.html)
- [RFC 4252: The Secure Shell (SSH) Authentication Protocol](https://datatracker.ietf.org/doc/html/rfc4252)


{{#include ../../banners/hacktricks-training.md}}
