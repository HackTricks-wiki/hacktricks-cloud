# Gitblit Embedded SSH Auth Bypass (CVE-2024-28080)

{{#include ../../banners/hacktricks-training.md}}

## सारांश

CVE-2024-28080 Gitblit के embedded SSH सर्विस में एक authentication bypass है जो Apache MINA SSHD के साथ एकीकरण करते समय session state के गलत हैंडलिंग के कारण हुआ। अगर किसी user अकाउंट में कम से कम एक SSH public key रजिस्टर्ड है, तो एक attacker जो username और उस user की किसी भी public key को जानता है, private key और password के बिना authenticate कर सकता है।

- प्रभावित: Gitblit < 1.10.0 (observed on 1.9.3)
- Fixed: 1.10.0
- शोषण के लिए आवश्यकताएँ:
- Git over SSH instance पर enabled होना चाहिए
- पीड़ित अकाउंट में कम से कम एक SSH public key Gitblit में रजिस्टर्ड होनी चाहिए
- Attacker को पीड़ित username और उनकी किसी एक public key का पता होना चाहिए (अकसर खोजने योग्य, उदाहरण के लिए https://github.com/<username>.keys)

## मूल कारण (state leaks between SSH methods)

RFC 4252 के अनुसार, public‑key authentication दो चरणों में होती है: सर्वर पहले जाँचता है कि दिया गया public key किसी username के लिए स्वीकार्य है या नहीं, और केवल challenge/response के साथ signature के बाद ही वह user को authenticate करता है। MINA SSHD में, PublickeyAuthenticator को दो बार बुलाया जाता है: key acceptance पर (अभी signature नहीं) और बाद में जब client signature लौटाता है।

Gitblit का PublickeyAuthenticator पहले, pre‑signature कॉल पर session context को बदल देता था (mutate) करके authenticated UserModel को session से जोड़ देता था और true लौटाता था ("key acceptable")। जब बाद में authentication password पर fallback हुआ, तो PasswordAuthenticator ने उस mutated session state पर भरोसा किया और short‑circuit करते हुए बिना password validate किए true लौटाया। परिणामस्वरूप, किसी भी password (खाली सहित) को एक prior public‑key "acceptance" के बाद उसी user के लिए स्वीकार कर लिया गया।

उच्च‑स्तरीय दोषपूर्ण flow:

1) Client username + public key भेजता है (अभी signature नहीं)
2) Server key को user का मानता है और जल्दबाजी में user को session से जोड़ देता है, true लौटाता है ("acceptable")
3) Client sign नहीं कर पाता (private key नहीं), तो auth password पर fallback होता है
4) Password auth session में पहले से मौजूद user देखता है और बिना शर्त success लौटाता है

## Step‑by‑step exploitation

- पीड़ित का username और उनकी किसी एक public key इकट्ठा करें:
- GitHub public keys को https://github.com/<username>.keys पर दिखाता है
- Public servers अक्सर authorized_keys एक्सपोज़ करते हैं
- Configure OpenSSH ताकि वह केवल public half प्रस्तुत करे जिससे signature generation fail हो, और password पर fallback मजबूर हो जबकि server पर public‑key acceptance path ट्रिगर हो रहा हो।

Example SSH client config (no private key available):
```sshconfig
# ~/.ssh/config
Host gitblit-target
HostName <host-or-ip>
User <victim-username>
PubkeyAuthentication yes
PreferredAuthentications publickey,password
IdentitiesOnly yes
IdentityFile ~/.ssh/victim.pub   # public half only (no private key present)
```
कनेक्ट करें और पासवर्ड प्रॉम्प्ट पर Enter दबाएँ (या कोई भी स्ट्रिंग टाइप करें):
```bash
ssh gitblit-target
# or Git over SSH
GIT_SSH_COMMAND="ssh -F ~/.ssh/config" git ls-remote ssh://<victim-username>@<host>/<repo.git>
```
प्रमाणीकरण इसलिए सफल हो जाता है क्योंकि पहले के public‑key चरण ने session को एक authenticated user में बदल दिया था, और password auth उस स्थिति पर गलत तरीके से भरोसा कर लेता है।

नोट: यदि ControlMaster multiplexing आपके SSH config में सक्षम है, तो बाद के Git कमांड्स वही authenticated connection reuse कर सकते हैं, जिससे प्रभाव बढ़ सकता है।

## प्रभाव

- किसी भी Gitblit user की पूर्ण impersonation जिसकी कम से कम एक registered SSH public key हो
- victim की permissions के अनुसार repositories तक read/write access (source exfiltration, unauthorized pushes, supply‑chain risks)
- यदि लक्ष्य admin user हो तो संभावित administrative प्रभाव
- शुद्ध network exploit; किसी brute force या private key की आवश्यकता नहीं

## पता लगाने के सुझाव

- SSH logs की समीक्षा करें उन सीक्वेंस के लिए जहाँ publickey प्रयास के बाद खाली या बहुत छोटा password देकर सफल password authentication होती है
- इन flows की तलाश करें: publickey method द्वारा unsupported/mismatched key material पेश किया जाना और उसके तुरंत बाद उसी username के लिए password के सफल होने की घटना

## निवारण

- Gitblit v1.10.0+ में upgrade करें
- जब तक upgrade नहीं हो जाता:
- Gitblit पर Git over SSH को Disable करें, या
- SSH service के network access को सीमित करें, और
- ऊपर बताए गए संदिग्ध पैटर्न की निगरानी करें
- यदि compromise का संदेह हो तो प्रभावित user credentials को rotate करें

## General: abusing SSH auth method state‑leakage (MINA/OpenSSH‑based services)

पैटर्न: यदि किसी server का public‑key authenticator pre‑signature "key acceptable" चरण के दौरान user/session state को बदल देता है और अन्य authenticators (जैसे password) उस स्थिति पर भरोसा करते हैं, तो आप निम्न तरीके से authentication bypass कर सकते हैं:

- लक्ष्य user के लिए एक वैध public key पेश करना (कोई private key आवश्यक नहीं)
- client को signing fail करने के लिए मजबूर करना ताकि server password पर fallback कर ले
- password authenticator किसी leaked state पर short‑circuit करते हुए किसी भी password को स्वीकार कर लेना

व्यावहारिक सुझाव:

- Public key harvesting at scale: https://github.com/<username>.keys, organizational directories, team pages, leaked authorized_keys जैसे सामान्य स्रोतों से public keys खींचें
- Forcing signature failure (client‑side): IdentityFile को केवल .pub पर पॉइंट करें, IdentitiesOnly yes सेट करें, और PreferredAuthentications में पहले publickey फिर password शामिल रखें
- MINA SSHD integration pitfalls:
- PublickeyAuthenticator.authenticate(...) को user/session state जोड़ने नहीं देना चाहिए जब तक कि post‑signature verification path signature की पुष्टि न कर दे
- PasswordAuthenticator.authenticate(...) को किसी prior, incomplete authentication method के दौरान mutated किसी भी state से सफलता infer नहीं करनी चाहिए

संबंधित protocol/design नोट्स और साहित्य:
- SSH userauth protocol: RFC 4252 (publickey method is a two‑stage process)
- प्रारम्भिक acceptance oracles और auth races पर ऐतिहासिक चर्चा, जैसे CVE‑2016‑20012 विवाद OpenSSH व्यवहार के इर्द‑गिर्द

## References

- [Gitblit CVE-2024-28080: SSH public‑key fallback to password authentication bypass (Silent Signal blog)](https://blog.silentsignal.eu/2025/06/14/gitblit-cve-CVE-2024-28080/)
- [Gitblit v1.10.0 release notes](https://github.com/gitblit-org/gitblit/releases/tag/v1.10.0)
- [Apache MINA SSHD project](https://mina.apache.org/sshd-project/)
- [PublickeyAuthenticator API](https://svn.apache.org/repos/infra/websites/production/mina/content/sshd-project/apidocs/org/apache/sshd/server/auth/pubkey/PublickeyAuthenticator.html)
- [RFC 4252: The Secure Shell (SSH) Authentication Protocol](https://datatracker.ietf.org/doc/html/rfc4252)


{{#include ../../banners/hacktricks-training.md}}
