# Gh Actions - Context Script Injections

{{#include ../../../banners/hacktricks-training.md}}

## 위험 이해하기

GitHub Actions는 step이 실행되기 전에 ${{ ... }} 표현식을 렌더링합니다. 렌더된 값은 step의 프로그램(특히 run 단계의 경우 shell script)에 삽입됩니다. 만약 신뢰할 수 없는 입력을 run: 안에 직접 보간하면, 공격자는 shell 프로그램의 일부분을 제어하여 임의의 명령을 실행할 수 있습니다.

Docs: https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions and contexts/functions: https://docs.github.com/en/actions/learn-github-actions/contexts

핵심 포인트:
- 렌더링은 실행 이전에 발생합니다. 모든 표현식이 해석된 상태로 run 스크립트가 생성되고, 그 다음 shell에서 실행됩니다.
- 많은 contexts는 트리거 이벤트에 따라 사용자 제어 필드를 포함합니다(issues, PRs, comments, discussions, forks, stars 등). 신뢰할 수 없는 입력에 대한 참고는 다음을 참조하세요: https://securitylab.github.com/resources/github-actions-untrusted-input/
- run: 안의 Shell 인용(quoting)은 신뢰할 수 있는 방어가 아닙니다. 인젝션은 템플릿 렌더링 단계에서 발생하기 때문입니다. 공격자는 조작된 입력으로 인용부를 탈출하거나 연산자(operator)를 주입할 수 있습니다.

## 취약한 패턴 → RCE on runner

취약한 workflow (누군가 새 issue를 열 때 트리거됨):
```yaml
name: New Issue Created
on:
issues:
types: [opened]
jobs:
deploy:
runs-on: ubuntu-latest
permissions:
issues: write
steps:
- name: New issue
run: |
echo "New issue ${{ github.event.issue.title }} created"
- name: Add "new" label to issue
uses: actions-ecosystem/action-add-labels@v1
with:
github_token: ${{ secrets.GITHUB_TOKEN }}
labels: new
```
공격자가 제목이 $(id)인 issue를 열면, 렌더된 step은 다음과 같다:
```sh
echo "New issue $(id) created"
```
명령 치환은 runner에서 id를 실행합니다. 예시 출력:
```
New issue uid=1001(runner) gid=118(docker) groups=118(docker),4(adm),100(users),999(systemd-journal) created
```
quoting이 안전을 보장하지 않는 이유:
- Expressions는 먼저 렌더링되고, 그 결과로 생성된 스크립트가 실행됩니다. 신뢰할 수 없는 값에 $(...), `;`, `"`/`'`, 또는 줄바꿈(newlines)이 포함되어 있으면, quoting에도 불구하고 프로그램 구조를 변경할 수 있습니다.

## 안전한 패턴 (shell variables via env)

올바른 완화 방법: 신뢰할 수 없는 입력을 환경 변수에 복사한 다음, run 스크립트에서 네이티브 shell 확장($VAR)을 사용하세요. 명령 안에서 ${{ ... }}로 다시 임베드하지 마세요.
```yaml
# safe
jobs:
deploy:
runs-on: ubuntu-latest
steps:
- name: New issue
env:
TITLE: ${{ github.event.issue.title }}
run: |
echo "New issue $TITLE created"
```
Notes:
- Avoid using ${{ env.TITLE }} inside run:. That reintroduces template rendering back into the command and brings the same injection risk.
- Prefer passing untrusted inputs via env: mapping and reference them with $VAR in run:.

## 사용자(읽기 권한)가 트리거할 수 있는 지점(신뢰할 수 없음으로 취급)

퍼블릭 저장소에 대해 읽기 권한만 있는 계정도 여전히 많은 이벤트를 트리거할 수 있습니다. 이러한 이벤트에서 유래한 컨텍스트의 모든 필드는 달리 증명되지 않는 한 공격자가 제어하는 것으로 간주해야 합니다. 예:
- issues, issue_comment
- discussion, discussion_comment (조직은 discussions를 제한할 수 있음)
- pull_request, pull_request_review, pull_request_review_comment
- pull_request_target (오용 시 위험, base repo 컨텍스트에서 실행됨)
- fork (누구나 public repos를 fork할 수 있음)
- watch (저장소에 스타를 표시하는 행위)
- Indirectly via workflow_run/workflow_call chains

어떤 특정 필드가 공격자에 의해 제어되는지는 이벤트마다 다릅니다. GitHub Security Lab의 신뢰할 수 없는 입력 가이드를 참조하세요: https://securitylab.github.com/resources/github-actions-untrusted-input/

## Practical tips

- Minimize use of expressions inside run:. Prefer env: mapping + $VAR.
- If you must transform input, do it in the shell using safe tools (printf %q, jq -r, etc.), still starting from a shell variable.
- 브랜치 이름, PR 제목, 사용자명, 레이블, 토론 제목, PR head refs 등을 스크립트, 명령줄 플래그 또는 파일 경로에 보간할 때는 각별히 주의하세요.
- For reusable workflows and composite actions, apply the same pattern: map to env then reference $VAR.

## References

- [GitHub Actions: A Cloudy Day for Security - Part 1](https://binarysecurity.no/posts/2025/08/securing-gh-actions-part1)
- [GitHub workflow syntax](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions)
- [Contexts and expression syntax](https://docs.github.com/en/actions/learn-github-actions/contexts)
- [Untrusted input reference for GitHub Actions](https://securitylab.github.com/resources/github-actions-untrusted-input/)

{{#include ../../../banners/hacktricks-training.md}}
