# Gh Actions - Context Script Injections

{{#include ../../../banners/hacktricks-training.md}}

## Κατανόηση του κινδύνου

Το GitHub Actions αποδίδει τις εκφράσεις ${{ ... }} πριν εκτελεστεί το step. Η αποδοσμένη τιμή επικολλάται στο πρόγραμμα του step (για run steps, a shell script). Εάν ενσωματώσετε μη αξιόπιστη είσοδο απευθείας μέσα σε run:, ο attacker ελέγχει μέρος του shell προγράμματος και μπορεί να εκτελέσει αυθαίρετες εντολές.

Docs: https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions and contexts/functions: https://docs.github.com/en/actions/learn-github-actions/contexts

Βασικά σημεία:
- Η απόδοση γίνεται πριν την εκτέλεση. Το run script δημιουργείται με όλες τις εκφράσεις επιλυμένες και στη συνέχεια εκτελείται από το shell.
- Πολλά contexts περιέχουν πεδία ελεγχόμενα από χρήστη ανάλογα με το γεγονός που προκαλεί το trigger (issues, PRs, comments, discussions, forks, stars, κ.λπ.). Δείτε την αναφορά για untrusted input: https://securitylab.github.com/resources/github-actions-untrusted-input/
- Το quoting του shell μέσα σε run: δεν αποτελεί αξιόπιστη άμυνα, επειδή η injection συμβαίνει στο στάδιο απόδοσης του template. Οι attackers μπορούν να βγουν από quotes ή να εισάγουν operators μέσω ειδικά κατασκευασμένης εισόδου.

## Vulnerable pattern → RCE on runner

Ευάλωτο workflow (ενεργοποιείται όταν κάποιος ανοίξει ένα νέο issue):
```yaml
name: New Issue Created
on:
issues:
types: [opened]
jobs:
deploy:
runs-on: ubuntu-latest
permissions:
issues: write
steps:
- name: New issue
run: |
echo "New issue ${{ github.event.issue.title }} created"
- name: Add "new" label to issue
uses: actions-ecosystem/action-add-labels@v1
with:
github_token: ${{ secrets.GITHUB_TOKEN }}
labels: new
```
Αν ένας επιτιθέμενος ανοίξει ένα issue με τίτλο $(id), το βήμα που αποδίδεται γίνεται:
```sh
echo "New issue $(id) created"
```
Η αντικατάσταση εντολής εκτελεί id στον runner. Παράδειγμα εξόδου:
```
New issue uid=1001(runner) gid=118(docker) groups=118(docker),4(adm),100(users),999(systemd-journal) created
```
Γιατί το quoting δεν σας σώζει:
- Οι εκφράσεις αποτιμώνται πρώτα, και μετά εκτελείται το προκύπτον script. Αν η μη αξιόπιστη τιμή περιέχει $(...), `;`, `"`/`'`, ή newlines, μπορεί να τροποποιήσει τη δομή του προγράμματος παρά την παράθεσή σας.

## Ασφαλές μοτίβο (shell variables via env)

Σωστή αντιμετώπιση: αντιγράψτε την μη αξιόπιστη είσοδο σε μια μεταβλητή περιβάλλοντος, και στη συνέχεια χρησιμοποιήστε την εγγενή επέκταση shell ($VAR) στο run script. Μην επαν-ενσωματώνετε με ${{ ... }} μέσα στην εντολή.
```yaml
# safe
jobs:
deploy:
runs-on: ubuntu-latest
steps:
- name: New issue
env:
TITLE: ${{ github.event.issue.title }}
run: |
echo "New issue $TITLE created"
```
Notes:
- Αποφύγετε τη χρήση του ${{ env.TITLE }} μέσα σε run:. Αυτό επανεισάγει το template rendering πίσω στην εντολή και φέρνει τον ίδιο κίνδυνο injection.
- Προτιμήστε τη μεταβίβαση untrusted inputs μέσω του env: mapping και αναφέρετέ τα με $VAR μέσα σε run:.

## Reader-triggerable surfaces (treat as untrusted)

Λογαριασμοί με μόνο read permission σε public repositories μπορούν ακόμα να ενεργοποιήσουν πολλά events. Οποιοδήποτε πεδίο σε contexts που προέρχονται από αυτά τα events πρέπει να θεωρείται attacker-controlled εκτός αν αποδειχθεί το αντίθετο. Παραδείγματα:
- issues, issue_comment
- discussion, discussion_comment (orgs can restrict discussions)
- pull_request, pull_request_review, pull_request_review_comment
- pull_request_target (dangerous if misused, runs in base repo context)
- fork (anyone can fork public repos)
- watch (starring a repo)
- Indirectly via workflow_run/workflow_call chains

Ποια συγκεκριμένα πεδία είναι attacker-controlled εξαρτάται από το event. Συμβουλευτείτε τον οδηγό του GitHub Security Lab για untrusted input: https://securitylab.github.com/resources/github-actions-untrusted-input/

## Practical tips

- Ελαχιστοποιήστε τη χρήση εκφράσεων μέσα σε run:. Προτιμήστε env: mapping + $VAR.
- Αν πρέπει οπωσδήποτε να μετασχηματίσετε input, κάντε το στο shell χρησιμοποιώντας ασφαλή εργαλεία (printf %q, jq -r, κ.λπ.), ξεκινώντας πάντα από μια shell μεταβλητή.
- Να είστε ιδιαίτερα προσεκτικοί όταν κάνετε interpolation σε branch names, PR titles, usernames, labels, discussion titles, και PR head refs μέσα σε scripts, command-line flags ή file paths.
- Για reusable workflows και composite actions, εφαρμόστε το ίδιο pattern: map στο env και μετά αναφερθείτε με $VAR.

## References

- [GitHub Actions: A Cloudy Day for Security - Part 1](https://binarysecurity.no/posts/2025/08/securing-gh-actions-part1)
- [GitHub workflow syntax](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions)
- [Contexts and expression syntax](https://docs.github.com/en/actions/learn-github-actions/contexts)
- [Untrusted input reference for GitHub Actions](https://securitylab.github.com/resources/github-actions-untrusted-input/)

{{#include ../../../banners/hacktricks-training.md}}
