# Gh Actions - Context Script Injections

{{#include ../../../banners/hacktricks-training.md}}

## Riskin anlaşılması

GitHub Actions, adım çalışmadan önce ${{ ... }} ifadelerini render eder. Render edilmiş değer adımın programına yapıştırılır (run adımları için bir shell script). Eğer untrusted input'u doğrudan run: içine interpolate ederseniz, saldırgan shell programının bir kısmını kontrol eder ve rastgele komutlar çalıştırabilir.

Dokümanlar: https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions ve contexts/functions: https://docs.github.com/en/actions/learn-github-actions/contexts

Önemli noktalar:
- Render işlemi yürütmeden önce gerçekleşir. run script, tüm ifadeler çözülmüş şekilde oluşturulur ve ardından shell tarafından çalıştırılır.
- Birçok contexts, tetikleyici olaya bağlı olarak kullanıcı kontrollü alanlar içerir (issues, PRs, comments, discussions, forks, stars, vb.). untrusted input referansına bakın: https://securitylab.github.com/resources/github-actions-untrusted-input/
- run: içindeki shell quoting güvenilir bir savunma değildir, çünkü enjeksiyon şablon render aşamasında gerçekleşir. Saldırganlar aldatıcı input ile tırnaklardan çıkabilir veya operatörler enjekte edebilir.

## Zafiyetli desen → runner üzerinde RCE

Zafiyetli workflow (birisi yeni bir issue açtığında tetiklenir):
```yaml
name: New Issue Created
on:
issues:
types: [opened]
jobs:
deploy:
runs-on: ubuntu-latest
permissions:
issues: write
steps:
- name: New issue
run: |
echo "New issue ${{ github.event.issue.title }} created"
- name: Add "new" label to issue
uses: actions-ecosystem/action-add-labels@v1
with:
github_token: ${{ secrets.GITHUB_TOKEN }}
labels: new
```
Eğer bir saldırgan $(id) başlıklı bir issue açarsa, render edilen adım şöyle olur:
```sh
echo "New issue $(id) created"
```
Command substitution, runner üzerinde id komutunu çalıştırır. Örnek çıktı:
```
New issue uid=1001(runner) gid=118(docker) groups=118(docker),4(adm),100(users),999(systemd-journal) created
```
Neden tırnaklama sizi kurtarmaz:
- İfadeler önce işlenir, sonra ortaya çıkan script çalıştırılır. Eğer güvenilmeyen değer $(...), `;`, `"`/`'`, veya yeni satırlar içeriyorsa, tırnaklamanıza rağmen program yapısını değiştirebilir.

## Güvenli yöntem (shell variables via env)

Doğru çözüm: güvenilmeyen girdiyi bir çevresel değişkene kopyalayın, sonra run script içinde yerel shell genişletmesini ($VAR) kullanın. Komut içinde ${{ ... }} ile yeniden gömmeyin.
```yaml
# safe
jobs:
deploy:
runs-on: ubuntu-latest
steps:
- name: New issue
env:
TITLE: ${{ github.event.issue.title }}
run: |
echo "New issue $TITLE created"
```
Notlar:
- run: içinde ${{ env.TITLE }} kullanmaktan kaçının. Bu, şablon işleme (template rendering)'i komuta geri sokar ve aynı enjeksiyon riskini getirir.
- Güvenilmeyen girdileri env: mapping üzerinden iletmeyi tercih edin ve run: içinde onları $VAR ile referanslayın.

## Okuyucu tarafından tetiklenebilen yüzeyler (güvenilmez sayın)

Public repository'lerde yalnızca okuma izni olan hesaplar yine de birçok olayı tetikleyebilir. Bu olaylardan türetilen bağlamlardaki herhangi bir alan, aksi kanıtlanana kadar saldırgan kontrollü olarak kabul edilmelidir. Örnekler:
- issues, issue_comment
- discussion, discussion_comment (orglar discussions'ı kısıtlayabilir)
- pull_request, pull_request_review, pull_request_review_comment
- pull_request_target (kötü kullanılırsa tehlikeli, base repo bağlamında çalışır)
- fork (herkes public repo'ları fork'layabilir)
- watch (bir repoya yıldız koyma)
- Dolaylı olarak workflow_run/workflow_call zincirleri aracılığıyla

Hangi spesifik alanların saldırgan kontrollü olduğu event'e özeldir. GitHub Security Lab’in untrusted input rehberine bakın: https://securitylab.github.com/resources/github-actions-untrusted-input/

## Pratik ipuçları

- run: içinde expressions kullanımını en aza indirin. env: mapping + $VAR tercih edin.
- Girdiyi dönüştürmeniz gerekiyorsa, bunu shell içinde güvenli araçlarla yapın (printf %q, jq -r, vb.), yine de bir shell değişkeninden başlayarak.
- branch isimlerini, PR başlıklarını, kullanıcı adlarını, label'ları, discussion başlıklarını ve PR head refs'lerini scriptlere, komut satırı bayraklarına veya dosya yollarına yerleştirirken ekstra dikkatli olun.
- Reusable workflows ve composite actions için aynı deseni uygulayın: env: üzerinden iletin, sonra $VAR ile referanslayın.

## References

- [GitHub Actions: A Cloudy Day for Security - Part 1](https://binarysecurity.no/posts/2025/08/securing-gh-actions-part1)
- [GitHub workflow syntax](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions)
- [Contexts and expression syntax](https://docs.github.com/en/actions/learn-github-actions/contexts)
- [Untrusted input reference for GitHub Actions](https://securitylab.github.com/resources/github-actions-untrusted-input/)

{{#include ../../../banners/hacktricks-training.md}}
