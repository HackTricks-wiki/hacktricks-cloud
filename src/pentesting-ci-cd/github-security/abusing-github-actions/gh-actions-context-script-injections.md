# Gh Actions - Context Script Injections

{{#include ../../../banners/hacktricks-training.md}}

## Kuelewa hatari

GitHub Actions hufasiri usemi ${{ ... }} kabla hatua haijatekelezwa. Thamani iliyofasiriwa inaingizwa kwenye programu ya hatua (kwa run steps, shell script). Ikiwa unachanganya input isiyoaminika moja kwa moja ndani ya run:, mshambuliaji anadhibiti sehemu ya programu ya shell na anaweza kutekeleza amri za aina yoyote.

Nyaraka: https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions na contexts/functions: https://docs.github.com/en/actions/learn-github-actions/contexts

Mambo muhimu:
- Ufasiri hutokea kabla ya utekelezaji. run script inaundwa ikiwa usemi wote umetatuliwa, kisha utekelezaji unafanywa na shell.
- Context nyingi zina nyField zinazoendeshwa na watumiaji kulingana na tukio linalochochea (issues, PRs, comments, discussions, forks, stars, n.k.). Angalia rejea ya untrusted input: https://securitylab.github.com/resources/github-actions-untrusted-input/
- Shell quoting ndani ya run: sio ulinzi wa kuaminika, kwa sababu injection hutokea katika hatua ya template rendering. Wadukuzi wanaweza kutoka nje ya nukuu au kuingiza operators kupitia input iliyotengenezwa kwa makusudi.

## Vulnerable pattern â†’ RCE on runner

Vulnerable workflow (triggered when someone opens a new issue):
```yaml
name: New Issue Created
on:
issues:
types: [opened]
jobs:
deploy:
runs-on: ubuntu-latest
permissions:
issues: write
steps:
- name: New issue
run: |
echo "New issue ${{ github.event.issue.title }} created"
- name: Add "new" label to issue
uses: actions-ecosystem/action-add-labels@v1
with:
github_token: ${{ secrets.GITHUB_TOKEN }}
labels: new
```
Ikiwa mshambuliaji anafungua issue yenye kichwa $(id), hatua inayoonyeshwa inakuwa:
```sh
echo "New issue $(id) created"
```
Ubadilishaji wa amri unatekeleza id kwenye runner. Mfano wa matokeo:
```
New issue uid=1001(runner) gid=118(docker) groups=118(docker),4(adm),100(users),999(systemd-journal) created
```
Kwa nini kutumia nukuu hakutakuokoa:
- Expressions zinaandaliwa kwanza, kisha script inayotokana inaendeshwa. Ikiwa thamani isiyokuwa ya kuaminika ina $(...), `;`, `"`/`'`, au newlines, inaweza kubadili muundo wa programu licha ya nukuu ulizoweka.

## Mfano salama (shell variables via env)

Kukabiliana sahihi: nakili pembejeo isiyokuwa ya kuaminika kwenye environment variable, kisha tumia upanuzi wa asili wa shell ($VAR) katika run script. Usire-embed tena kwa ${{ ... }} ndani ya amri.
```yaml
# safe
jobs:
deploy:
runs-on: ubuntu-latest
steps:
- name: New issue
env:
TITLE: ${{ github.event.issue.title }}
run: |
echo "New issue $TITLE created"
```
Vidokezo:
- Epuka kutumia ${{ env.TITLE }} inside run:. That reintroduces template rendering back into the command and brings the same injection risk.
- Prefer passing untrusted inputs via env: mapping and reference them with $VAR in run:.

## Nyenzo zinazoweza kuzinduliwa na msomaji (chukulia kama zisizoaminika)

Akaunti ambazo zina tu ruhusa ya kusoma kwenye public repositories bado zinaweza kuzindua matukio mengi. Kila field katika contexts zinazotokana na matukio haya inapaswa kuzingatiwa kuwa iko chini ya udhibiti wa mshambuliaji isipokuwa kuthibitishwa vinginevyo. Mifano:
- issues, issue_comment
- discussion, discussion_comment (orgs zinaweza kudhibiti discussions)
- pull_request, pull_request_review, pull_request_review_comment
- pull_request_target (hatari kama itatumiwa vibaya, inaendesha katika base repo context)
- fork (mtu yeyote anaweza kufork public repos)
- watch (kutoa nyota repo)
- Kwa njia zisizo za moja kwa moja kupitia workflow_run/workflow_call chains

Ni maalumu ni field zipi ziko chini ya udhibiti wa mshambuliaji hutegemea tukio. Konsulta mwongozo wa GitHub Security Lab kuhusu untrusted input: https://securitylab.github.com/resources/github-actions-untrusted-input/

## Vidokezo vya vitendo

- Minimize use of expressions inside run:. Prefer env: mapping + $VAR.
- If you must transform input, do it in the shell using safe tools (printf %q, jq -r, etc.), still starting from a shell variable.
- Kuwa mwangalifu zaidi unapokuwa unachanganya branch names, PR titles, usernames, labels, discussion titles, na PR head refs ndani ya scripts, command-line flags, au file paths.
- Kwa reusable workflows na composite actions, tumia pattern ile ile: map to env then reference $VAR.

## References

- [GitHub Actions: A Cloudy Day for Security - Part 1](https://binarysecurity.no/posts/2025/08/securing-gh-actions-part1)
- [GitHub workflow syntax](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions)
- [Contexts and expression syntax](https://docs.github.com/en/actions/learn-github-actions/contexts)
- [Untrusted input reference for GitHub Actions](https://securitylab.github.com/resources/github-actions-untrusted-input/)

{{#include ../../../banners/hacktricks-training.md}}
