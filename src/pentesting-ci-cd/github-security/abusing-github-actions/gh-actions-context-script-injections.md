# Gh Actions - Context Script Injections

{{#include ../../../banners/hacktricks-training.md}}

## Verstaan die risiko

GitHub Actions render expressions ${{ ... }} voordat die stap uitgevoer word. Die gerenderde waarde word in die stap se program geplak (vir run-stappe, 'n shell script). As jy onbetroubare invoer direk binne run: interpolleer, beheer die aanvaller 'n deel van die shell-program en kan willekeurige opdragte uitvoer.

Docs: https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions and contexts/functions: https://docs.github.com/en/actions/learn-github-actions/contexts

Belangrike punte:
- Rendering gebeur voordat uitvoering plaasvind. Die run script word gegenereer met al die uitdrukkings opgelos, en dan deur die shell uitgevoer.
- Baie contexts bevat deur die gebruiker beheerde velde afhangend van die triggering event (issues, PRs, comments, discussions, forks, stars, etc.). Sien die untrusted input reference: https://securitylab.github.com/resources/github-actions-untrusted-input/
- Shell quoting binne run: is nie 'n betroubare verdediging nie, omdat die injectie by die template rendering stadium plaasvind. Aanvallers kan uit aanhalingstekens breek of operatoren injekteer via vervaardigde invoer.

## Kwetsbare patroon → RCE on runner

Kwetsbare workflow (getrigger wanneer iemand 'n nuwe issue oopmaak):
```yaml
name: New Issue Created
on:
issues:
types: [opened]
jobs:
deploy:
runs-on: ubuntu-latest
permissions:
issues: write
steps:
- name: New issue
run: |
echo "New issue ${{ github.event.issue.title }} created"
- name: Add "new" label to issue
uses: actions-ecosystem/action-add-labels@v1
with:
github_token: ${{ secrets.GITHUB_TOKEN }}
labels: new
```
As 'n aanvaller 'n issue met die titel $(id) open, word die gerenderde stap:
```sh
echo "New issue $(id) created"
```
Die command substitution voer id op die runner uit. Voorbeelduitset:
```
New issue uid=1001(runner) gid=118(docker) groups=118(docker),4(adm),100(users),999(systemd-journal) created
```
Hoekom aanhaling jou nie red nie:
- Uitdrukkings word eers gerender, en dan word die resulterende skrip uitgevoer. As die onbetroubare waarde $(...), `;`, `"`/`'`, of newlines bevat, kan dit die programstruktuur verander ten spyte van jou aanhalings.

## Veilige patroon (shell variables via env)

Korrekte teenmaatreël: kopieer onbetroubare input na 'n environment variable, en gebruik dan die inheemse shell-expansie ($VAR) in die run-skrip. Moet dit nie weer inbed met ${{ ... }} binne die command nie.
```yaml
# safe
jobs:
deploy:
runs-on: ubuntu-latest
steps:
- name: New issue
env:
TITLE: ${{ github.event.issue.title }}
run: |
echo "New issue $TITLE created"
```
Notas:
- Avoid using ${{ env.TITLE }} inside run:. That reintroduces template rendering back into the command and brings the same injection risk.
- Prefer passing untrusted inputs via env: mapping and reference them with $VAR in run:.

## Oppervlakke wat deur lesers geaktiveer kan word (behandel as onbetroubaar)

Rekeninge met slegs leespermissie op openbare repositories kan steeds baie events trigger. Enige veld in contexts wat van hierdie events afgelei is, moet as attacker-controlled beskou word tensy anders bewys. Voorbeelde:
- issues, issue_comment
- discussion, discussion_comment (organisasies kan besprekings beperk)
- pull_request, pull_request_review, pull_request_review_comment
- pull_request_target (gevaarlik as dit misbruik word, runs in base repo context)
- fork (enigeen kan openbare repositories fork)
- watch (starring a repo)
- Indirectly via workflow_run/workflow_call chains

Watter spesifieke fields attacker-controlled is, is event-spesifiek. Raadpleeg GitHub Security Lab’s untrusted input guide: https://securitylab.github.com/resources/github-actions-untrusted-input/

## Praktiese wenke

- Minimize use of expressions inside run:. Prefer env: mapping + $VAR.
- If you must transform input, do it in the shell using safe tools (printf %q, jq -r, etc.), still starting from a shell variable.
- Wees ekstra versigtig wanneer takname, PR titles, usernames, labels, discussion titles, en PR head refs in scripts, command-line flags, of file paths geïnterpoleer word.
- For reusable workflows and composite actions, apply the same pattern: map to env then reference $VAR.

## References

- [GitHub Actions: A Cloudy Day for Security - Part 1](https://binarysecurity.no/posts/2025/08/securing-gh-actions-part1)
- [GitHub workflow syntax](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions)
- [Contexts and expression syntax](https://docs.github.com/en/actions/learn-github-actions/contexts)
- [Untrusted input reference for GitHub Actions](https://securitylab.github.com/resources/github-actions-untrusted-input/)

{{#include ../../../banners/hacktricks-training.md}}
