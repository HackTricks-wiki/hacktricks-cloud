# Gh Actions - Context Script Injections

{{#include ../../../banners/hacktricks-training.md}}

## リスクの理解

GitHub Actions は、ステップ実行前に ${{ ... }} 式をレンダリングします。レンダリングされた値はステップのプログラムに貼り付けられます（for run steps, a shell script）。未検証の入力を run: 内に直接埋め込むと、攻撃者がシェルプログラムの一部を制御して任意のコマンドを実行できます。

ドキュメント: https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions and contexts/functions: https://docs.github.com/en/actions/learn-github-actions/contexts

要点:
- レンダリングは実行の前に行われます。run スクリプトはすべての式が解決された状態で生成され、その後 shell によって実行されます。
- Many contexts contain user-controlled fields depending on the triggering event (issues, PRs, comments, discussions, forks, stars, etc.). See the untrusted input reference: https://securitylab.github.com/resources/github-actions-untrusted-input/
- Shell quoting inside run: は信頼できる防御ではありません。インジェクションはテンプレートのレンダリング段階で発生するため、攻撃者はクォートを破ったり細工された入力で演算子を注入したりできます。

## 脆弱なパターン → RCE on runner

脆弱なワークフロー（誰かが新しい issue を開いたときにトリガーされる）:
```yaml
name: New Issue Created
on:
issues:
types: [opened]
jobs:
deploy:
runs-on: ubuntu-latest
permissions:
issues: write
steps:
- name: New issue
run: |
echo "New issue ${{ github.event.issue.title }} created"
- name: Add "new" label to issue
uses: actions-ecosystem/action-add-labels@v1
with:
github_token: ${{ secrets.GITHUB_TOKEN }}
labels: new
```
攻撃者がタイトルを $(id) にした issue を開くと、レンダリングされたステップは次のようになります:
```sh
echo "New issue $(id) created"
```
コマンド置換はランナー上で id を実行します。出力例：
```
New issue uid=1001(runner) gid=118(docker) groups=118(docker),4(adm),100(users),999(systemd-journal) created
```
クォートでは防げない理由:
- 式はまずレンダリングされ、その結果できたスクリプトが実行されます。未検証の値に $(...), `;`, `"`/`'`, または改行が含まれていると、クォートしていてもプログラム構造を変更してしまう可能性があります。

## 安全なパターン (shell variables via env)

正しい対策: 未検証の入力を環境変数にコピーし、run スクリプト内でネイティブなシェル展開（$VAR）を使います。コマンド内で再び ${{ ... }} に埋め込んではいけません。
```yaml
# safe
jobs:
deploy:
runs-on: ubuntu-latest
steps:
- name: New issue
env:
TITLE: ${{ github.event.issue.title }}
run: |
echo "New issue $TITLE created"
```
注意:
- Avoid using ${{ env.TITLE }} inside run:. That reintroduces template rendering back into the command and brings the same injection risk.
- Prefer passing untrusted inputs via env: mapping and reference them with $VAR in run:.

## 読者によりトリガー可能な箇所（未信頼として扱う）

公開リポジトリに対して読み取り権限のみのアカウントでも多くのイベントをトリガーできます。これらのイベントから派生するコンテキスト内の任意のフィールドは、十分に検証されない限り攻撃者に制御されるものと見なすべきです。例:
- issues, issue_comment
- discussion, discussion_comment (orgs can restrict discussions)
- pull_request, pull_request_review, pull_request_review_comment
- pull_request_target (誤用すると危険、base repo コンテキストで実行される)
- fork (誰でも public repos を fork できる)
- watch (リポジトリにスターを付けること)
- workflow_run/workflow_call チェーン経由で間接的に

どの具体的なフィールドが攻撃者に制御されるかはイベントごとに異なります。GitHub Security Lab の untrusted input guide を参照してください: https://securitylab.github.com/resources/github-actions-untrusted-input/

## 実用的なヒント

- run: 内での expressions の使用を最小限にする。env: マッピング + $VAR を優先してください。
- 入力を変換する必要がある場合は、シェルで安全なツール（printf %q、jq -r、など）を使用して処理し、常にシェル変数から始めてください。
- ブランチ名、PR タイトル、ユーザー名、ラベル、discussion タイトル、PR head refs をスクリプト、コマンドラインフラグ、またはファイルパスに埋め込む際は特に注意してください。
- 再利用可能な workflows や composite actions に対しても同じパターンを適用してください: env にマップしてから $VAR を参照する。

## References

- [GitHub Actions: A Cloudy Day for Security - Part 1](https://binarysecurity.no/posts/2025/08/securing-gh-actions-part1)
- [GitHub workflow syntax](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions)
- [Contexts and expression syntax](https://docs.github.com/en/actions/learn-github-actions/contexts)
- [Untrusted input reference for GitHub Actions](https://securitylab.github.com/resources/github-actions-untrusted-input/)

{{#include ../../../banners/hacktricks-training.md}}
