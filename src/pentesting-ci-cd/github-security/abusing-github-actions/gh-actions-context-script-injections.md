# Gh Actions - Context Script Injections

{{#include ../../../banners/hacktricks-training.md}}

## 理解风险

GitHub Actions 会在步骤执行前渲染表达式 ${{ ... }}。渲染后的值会被粘贴到该步骤的程序中（对 run 步骤来说，是一个 shell 脚本）。如果你在 run: 中直接插入不受信任的输入，攻击者就能控制 shell 程序的一部分并执行任意命令。

文档: https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions and contexts/functions: https://docs.github.com/en/actions/learn-github-actions/contexts

要点:
- 渲染在执行之前发生。run 脚本会在所有表达式解析后生成，然后由 shell 执行。
- 许多 contexts 根据触发事件包含用户可控字段（issues、PRs、comments、discussions、forks、stars 等）。参见 untrusted input reference: https://securitylab.github.com/resources/github-actions-untrusted-input/
- 在 run: 中使用 shell 引号并不是可靠的防御，因为注入发生在模板渲染阶段。攻击者可以通过精心构造的输入跳出引号或注入操作符。

## Vulnerable pattern → RCE on runner

Vulnerable workflow (triggered when someone opens a new issue):
```yaml
name: New Issue Created
on:
issues:
types: [opened]
jobs:
deploy:
runs-on: ubuntu-latest
permissions:
issues: write
steps:
- name: New issue
run: |
echo "New issue ${{ github.event.issue.title }} created"
- name: Add "new" label to issue
uses: actions-ecosystem/action-add-labels@v1
with:
github_token: ${{ secrets.GITHUB_TOKEN }}
labels: new
```
如果攻击者打开一个标题为 $(id) 的 issue，渲染后的步骤变为：
```sh
echo "New issue $(id) created"
```
命令替换会在 runner 上运行 id。示例输出：
```
New issue uid=1001(runner) gid=118(docker) groups=118(docker),4(adm),100(users),999(systemd-journal) created
```
Why quoting doesn’t save you:
- Expressions 会先被渲染，然后生成的脚本被执行。如果 untrusted value 包含 $(...), `;`, `"`/`'`，或换行符，它仍然能改变程序结构，绕过你的 quoting。

## Safe pattern (shell variables via env)

正确的缓解办法：将 untrusted input 复制到一个 environment variable 中，然后在 run script 中使用 native shell expansion ($VAR)。不要在命令中用 ${{ ... }} 重新嵌入。
```yaml
# safe
jobs:
deploy:
runs-on: ubuntu-latest
steps:
- name: New issue
env:
TITLE: ${{ github.event.issue.title }}
run: |
echo "New issue $TITLE created"
```
注意：
- Avoid using ${{ env.TITLE }} inside run:. That reintroduces template rendering back into the command and brings the same injection risk.
- Prefer passing untrusted inputs via env: mapping and reference them with $VAR in run:.

## 可被读者触发的表面（视为不受信任）

对公共仓库只有只读权限的账户仍然可以触发许多事件。由这些事件派生的上下文中的任何字段都必须被视为由攻击者控制，除非另有证明。示例：
- issues, issue_comment
- discussion, discussion_comment (orgs can restrict discussions)
- pull_request, pull_request_review, pull_request_review_comment
- pull_request_target (如果滥用会很危险，会在基础仓库上下文中运行)
- fork (任何人都可以 fork 公共 repos)
- watch (starring a repo)
- 间接通过 workflow_run/workflow_call 链

哪些具体字段由攻击者控制取决于事件。请参考 GitHub Security Lab 的不受信任输入指南： https://securitylab.github.com/resources/github-actions-untrusted-input/

## 实用建议

- 尽量减少在 run: 中使用表达式。优先使用 env: 映射 + $VAR。
- 如果必须转换输入，请在 shell 中使用安全工具（printf %q, jq -r, 等），仍然以 shell 变量作为起点。
- 在将分支名、PR 标题、用户名、标签、讨论标题和 PR head refs 插入到脚本、命令行标志或文件路径时要格外小心。
- 对于 reusable workflows 和 composite actions，应用相同的模式：先映射到 env 然后引用 $VAR。

## References

- [GitHub Actions: A Cloudy Day for Security - Part 1](https://binarysecurity.no/posts/2025/08/securing-gh-actions-part1)
- [GitHub workflow syntax](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions)
- [Contexts and expression syntax](https://docs.github.com/en/actions/learn-github-actions/contexts)
- [Untrusted input reference for GitHub Actions](https://securitylab.github.com/resources/github-actions-untrusted-input/)

{{#include ../../../banners/hacktricks-training.md}}
