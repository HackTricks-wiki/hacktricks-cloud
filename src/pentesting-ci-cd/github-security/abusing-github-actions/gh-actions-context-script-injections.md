# Gh Actions - Context Script Injections

{{#include ../../../banners/hacktricks-training.md}}

## Verständnis des Risikos

GitHub Actions rendert Ausdrücke ${{ ... }} bevor der Schritt ausgeführt wird. Der gerenderte Wert wird in das Programm des Schritts eingefügt (bei run steps, ein Shell-Skript). Wenn du untrusted input direkt innerhalb von run: interpolierst, kontrolliert ein Angreifer Teile des Shell-Programms und kann beliebige Befehle ausführen.

Docs: https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions and contexts/functions: https://docs.github.com/en/actions/learn-github-actions/contexts

Wichtige Punkte:
- Rendering erfolgt vor der Ausführung. Das run script wird mit allen aufgelösten Ausdrücken erzeugt und dann von der Shell ausgeführt.
- Viele contexts enthalten vom Benutzer kontrollierte Felder, abhängig vom auslösenden Event (issues, PRs, comments, discussions, forks, stars, etc.). Siehe die untrusted input reference: https://securitylab.github.com/resources/github-actions-untrusted-input/
- Shell-Quoting innerhalb von run: ist keine zuverlässige Verteidigung, da die injection in der Template-Rendering-Phase erfolgt. Angreifer können aus Anführungszeichen ausbrechen oder Operatoren durch manipulierte Eingaben injizieren.

## Verwundbares Muster → RCE auf dem Runner

Verwundbarer workflow (ausgelöst, wenn jemand ein neues Issue öffnet):
```yaml
name: New Issue Created
on:
issues:
types: [opened]
jobs:
deploy:
runs-on: ubuntu-latest
permissions:
issues: write
steps:
- name: New issue
run: |
echo "New issue ${{ github.event.issue.title }} created"
- name: Add "new" label to issue
uses: actions-ecosystem/action-add-labels@v1
with:
github_token: ${{ secrets.GITHUB_TOKEN }}
labels: new
```
Wenn ein Angreifer ein Issue mit dem Titel $(id) eröffnet, wird der gerenderte Schritt zu:
```sh
echo "New issue $(id) created"
```
Die Kommando-Substitution führt id auf dem Runner aus. Beispielausgabe:
```
New issue uid=1001(runner) gid=118(docker) groups=118(docker),4(adm),100(users),999(systemd-journal) created
```
Warum Quoting dich nicht schützt:
- Ausdrücke werden zuerst ausgewertet, dann wird das resultierende script ausgeführt. Wenn der nicht vertrauenswürdige Wert $(...), `;`, `"`/`'`, oder Zeilenumbrüche enthält, kann er die Programmstruktur trotz Quoting verändern.

## Sicheres Muster (shell variables via env)

Korrekte Gegenmaßnahme: Kopiere nicht vertrauenswürdige Eingaben in eine Umgebungsvariable und verwende dann die native Shell-Expansion ($VAR) im run script. Verwende ${{ ... }} nicht erneut innerhalb des Befehls.
```yaml
# safe
jobs:
deploy:
runs-on: ubuntu-latest
steps:
- name: New issue
env:
TITLE: ${{ github.event.issue.title }}
run: |
echo "New issue $TITLE created"
```
Notes:
- Verwende ${{ env.TITLE }} nicht innerhalb von run:. Dadurch wird Template-Rendering wieder in den Befehl eingeführt und das gleiche injection risk entsteht.
- Übergib vorzugsweise nicht vertrauenswürdige Eingaben über ein env:-Mapping und referenziere sie in run: mit $VAR.

## Reader-triggerable surfaces (treat as untrusted)

Accounts with only read permission on public repositories can still trigger many events. Any field in contexts derived from these events must be considered attacker-controlled unless proven otherwise. Examples:
- issues, issue_comment
- discussion, discussion_comment (Organisationen können Diskussionen einschränken)
- pull_request, pull_request_review, pull_request_review_comment
- pull_request_target (gefährlich bei falscher Verwendung, läuft im Kontext des base repo)
- fork (jeder kann public repos forken)
- watch (starring a repo)
- Indirectly via workflow_run/workflow_call chains

Welche spezifischen Felder vom Angreifer kontrolliert sind, hängt vom Event ab. Siehe GitHub Security Lab’s untrusted input guide: https://securitylab.github.com/resources/github-actions-untrusted-input/

## Practical tips

- Minimiere die Verwendung von expressions in run:. Bevorzuge env:-Mapping + $VAR.
- Wenn du Eingaben transformieren musst, mach das in der Shell mit sicheren Tools (printf %q, jq -r, etc.), ausgehend weiterhin von einer Shell-Variablen.
- Sei besonders vorsichtig beim Interpolieren von Branch-Namen, PR-Titeln, Benutzernamen, Labels, Diskussionstiteln und PR-Head-Refs in Skripte, Kommandozeilenflags oder Dateipfade.
- Für wiederverwendbare Workflows und composite actions, wende dasselbe Muster an: auf env mappen und dann $VAR referenzieren.

## References

- [GitHub Actions: A Cloudy Day for Security - Part 1](https://binarysecurity.no/posts/2025/08/securing-gh-actions-part1)
- [GitHub workflow syntax](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions)
- [Contexts and expression syntax](https://docs.github.com/en/actions/learn-github-actions/contexts)
- [Untrusted input reference for GitHub Actions](https://securitylab.github.com/resources/github-actions-untrusted-input/)

{{#include ../../../banners/hacktricks-training.md}}
