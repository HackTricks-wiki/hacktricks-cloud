# 基本 Github 信息

{{#include ../../banners/hacktricks-training.md}}

## 基本结构

大型 **公司** 的基本 github 环境结构通常是拥有一个 **enterprise**，该 **enterprise** 拥有 **若干 organizations**，每个 **organization** 可能包含 **若干 repositories** 和 **若干 teams**。较小的公司可能只 **拥有一个 organization 而没有 enterprise**。

从用户角度来看，**用户** 可以是 **不同 enterprise 和 organization 的成员**。在这些范围内，用户可能拥有 **不同的 enterprise、organization 和 repository 角色**。

此外，用户也可能 **属于不同的 teams** 并在这些 team 中具有不同的 enterprise、organization 或 repository 角色。

最后，**repositories 可能具有特殊的保护机制**。

## 权限

### Enterprise Roles

- **Enterprise owner**：拥有此角色的人可以 **管理管理员、管理 enterprise 内的 organizations、管理 enterprise 设置、对 organizations 强制执行策略**。但是，除非他们被设置为 organization owner 或被授予对由 organization 拥有的仓库的直接访问权限，否则他们 **无法访问 organization 设置或内容**。
- **Enterprise members**：由 enterprise 拥有的 organizations 的成员 **也会自动成为该 enterprise 的成员**。

### Organization Roles

在一个 organization 中，用户可以有不同的角色：

- **Organization owners**：Organization owners 对你的 organization 拥有 **完全的管理访问权限**。这个角色应当限制在较少人数，但组织中至少不应少于两人。
- **Organization members**：对于 **organization 中的人**，默认的非管理角色是 organization member。默认情况下，organization members **拥有若干权限**。
- **Billing managers**：Billing managers 是可以 **管理你 organization 的计费设置（例如付款信息）** 的用户。
- **Security Managers**：这是 organization owners 可以分配给组织中某个团队的角色。应用该角色后，团队中的每个成员将获得 **管理整个 organization 的安全警报和设置的权限，以及对所有 repositories 的读取权限**。
- 如果你的 organization 有一个 security team，你可以使用 security manager 角色来给予团队成员组织中最少的必要访问权限。
- **Github App managers**：为了允许额外用户 **管理由 organization 拥有的 GitHub Apps**，owner 可以授予他们 GitHub App manager 权限。
- **Outside collaborators**：outside collaborator 是对一个或多个 organization 仓库有 **访问权限但并非明确成为该 organization 成员** 的人。

你可以在此表中 **比较这些角色的权限**: [https://docs.github.com/en/organizations/managing-peoples-access-to-your-organization-with-roles/roles-in-an-organization#permissions-for-organization-roles](https://docs.github.com/en/organizations/managing-peoples-access-to-your-organization-with-roles/roles-in-an-organization#permissions-for-organization-roles)

### 成员权限

在 _https://github.com/organizations/\<org_name>/settings/member_privileges_ 可以看到 **用户仅因成为该组织一员而拥有的权限**。

此处配置的设置将指示组织成员的以下权限：

- 对组织内所有仓库是否具有 admin、writer、reader 或无权限。
- 成员是否可以创建 private、internal 或 public 仓库。
- 是否允许 fork 仓库。
- 是否可以邀请 outside collaborators。
- 是否可以发布 public 或 private sites。
- admins 在仓库上的权限。
- 成员是否可以创建新 teams。

### Repository Roles

默认情况下创建的 repository 角色有：

- **Read**：建议用于希望查看或讨论项目的 **非代码贡献者**。
- **Triage**：建议用于需要在没有写权限的情况下 **主动管理 issues 和 pull requests 的贡献者**。
- **Write**：建议用于 **积极向项目推送的贡献者**。
- **Maintain**：建议用于 **需要管理仓库但不需要访问敏感或破坏性操作的项目经理**。
- **Admin**：建议用于需要对项目 **完全访问权限** 的人员，包括管理安全或删除仓库等敏感和破坏性操作。

你可以在此表中 **比较每个角色的权限**: [https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization#permissions-for-each-role](https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization#permissions-for-each-role)

你也可以在 _https://github.com/organizations/\<org_name>/settings/roles_ 创建你自己的角色。

### Teams

你可以在 _https://github.com/orgs/\<org_name>/teams/_ 列出 organization 中创建的 teams。注意，要查看作为其他 teams 子集的 teams，需要访问每个父 team。

### Users

organization 的用户可以在 _https://github.com/orgs/\<org_name>/people._ 列出。

在每个用户的信息中，你可以看到 **该用户所属的 teams**，以及 **该用户有权限访问的 repos**。

## Github Authentication

Github 提供了不同方式来对你的账户进行身份验证并代表你执行操作。

### Web Access

访问 **github.com** 时，你可以使用 **用户名和密码**（以及可能的 **2FA**）登录。

### **SSH Keys**

你可以为你的账户配置一把或多把公钥，允许相关的 **私钥代表你执行操作**。[https://github.com/settings/keys](https://github.com/settings/keys)

#### **GPG Keys**

你 **不能用这些密钥冒充用户**，但如果你不使用它，可能会因为 **提交没有签名** 而被发现。更多关于 [vigilant mode 的信息请见此处](https://docs.github.com/en/authentication/managing-commit-signature-verification/displaying-verification-statuses-for-all-of-your-commits#about-vigilant-mode)。

### **Personal Access Tokens**

你可以生成 personal access token 来 **赋予某个应用对你账户的访问权限**。在创建 personal access token 时，**用户** 需要 **指定 token 将拥有的权限**。[https://github.com/settings/tokens](https://github.com/settings/tokens)

### Oauth Applications

Oauth applications 可能会请求权限以 **访问你的一部分 github 信息或冒充你执行某些操作**。一个常见示例是某些平台上的 **login with github 按钮**。

- 你可以在 [https://github.com/settings/developers](https://github.com/settings/developers) 创建你自己的 **Oauth applications**。
- 你可以在 [https://github.com/settings/applications](https://github.com/settings/applications) 查看所有 **已获得你账户访问权限的 Oauth applications**。
- 你可以在 [https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps) 查看 **Oauth Apps 可以请求的 scopes**。
- 你可以在 _https://github.com/organizations/\<org_name>/settings/oauth_application_policy_ 查看组织中应用的第三方访问情况。

一些 **安全建议**：

- 一个 **OAuth App** 应始终 **以经过认证的 GitHub 用户身份在整个 GitHub 上行事**（例如，在提供用户通知时），并且仅访问指定的 scopes。
- 通过为经过认证的用户启用“Login with GitHub”，OAuth App 可以用作身份提供者。
- **不要** 为了让应用仅在 **单个仓库** 上操作而构建 OAuth App。使用 `repo` OAuth scope 时，OAuth Apps 可以 **对已认证用户的所有 repositories 进行操作**。
- **不要** 构建 OAuth App 来作为你的 **团队或公司的应用**。OAuth Apps 以 **单个用户** 身份进行认证，因此如果某人创建了一个供公司使用的 OAuth App，然后该人离职，其他人将无法访问它。
- 更多信息见 [here](https://docs.github.com/en/developers/apps/getting-started-with-apps/about-apps#about-oauth-apps)。

### Github Applications

Github applications 可以请求权限以 **访问你的 github 信息或冒充你** 对特定资源执行特定操作。在 Github Apps 中，你需要指定应用将有权访问的 repositories。

- 要安装 GitHub App，你必须是 **organization owner 或在某个仓库中具有 admin 权限**。
- GitHub App 应该 **连接到个人账户或 organization**。
- 你可以在 [https://github.com/settings/apps](https://github.com/settings/apps) 创建你自己的 Github application。
- 你可以在 [https://github.com/settings/apps/authorizations](https://github.com/settings/apps/authorizations) 查看所有 **已获得你账户访问权限的 Github applications**。
- 这些是 **Github Applications 的 API Endpoints**: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-app](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)。根据 App 的权限，它将能够访问其中的一部分。
- 你可以在 _https://github.com/organizations/\<org_name>/settings/installations_ 查看 organization 中已安装的 apps。

一些安全建议：

- GitHub App 应 **独立于用户执行操作**（除非该应用使用 [user-to-server](https://docs.github.com/en/apps/building-github-apps/identifying-and-authorizing-users-for-github-apps#user-to-server-requests) token）。为了使 user-to-server 访问令牌更安全，你可以使用将在 8 小时后过期的访问令牌，以及可以交换为新访问令牌的刷新令牌。更多信息见“[Refreshing user-to-server access tokens](https://docs.github.com/en/apps/building-github-apps/refreshing-user-to-server-access-tokens)。”
- 确保 GitHub App 与 **特定的 repositories 集成**。
- GitHub App 应 **连接到个人账户或 organization**。
- 不要期望 GitHub App 知道并做用户能做的一切。
- **如果你仅需要“Login with GitHub”服务，不要使用 GitHub App**。但 GitHub App 可以使用 [user identification flow](https://docs.github.com/en/apps/building-github-apps/identifying-and-authorizing-users-for-github-apps) 来登录用户并执行其他操作。
- 如果你仅想以 GitHub 用户身份行事并完成该用户能做的一切，也不要构建 GitHub App。
- 如果你在 GitHub Actions 中使用你的应用并想修改 workflow 文件，必须使用包含 `workflow` scope 的 OAuth token 以用户身份进行认证。该用户必须对包含 workflow 文件的仓库具有 admin 或 write 权限。更多信息见“[Understanding scopes for OAuth apps](https://docs.github.com/en/apps/building-oauth-apps/understanding-scopes-for-oauth-apps/#available-scopes)。”
- 更多信息见 [here](https://docs.github.com/en/developers/apps/getting-started-with-apps/about-apps#about-github-apps)。

### Github Actions

这 **并不是 github 的一种身份验证方式**，但恶意的 Github Action 可能会获得 **对 github 的未授权访问**，并且 **根据 Action 被授予的权限** 可以实施多种不同的 **攻击**。下面会提供更多信息。

## Git Actions

Git actions 允许在 **事件发生时自动执行代码**。通常执行的代码与仓库中的代码 **以某种方式相关**（例如构建 docker 容器或检查 PR 中是否包含 secrets）。

### Configuration

在 _https://github.com/organizations/\<org_name>/settings/actions_ 可以检查组织的 **github actions 配置**。

可以完全禁止使用 github actions，**允许所有 github actions**，或者仅允许某些 actions。

还可以配置 **谁需要批准运行某个 Github Action** 以及 Github Action 运行时 **GITHUB_TOKEN 的权限**。

### Git Secrets

Github Action 通常需要某种 secrets 来与 github 或第三方应用交互。为了 **避免将它们以明文放在仓库中**，github 允许将它们作为 **Secrets** 存放。

这些 secrets 可以为单个 repo 或整个 organization 配置。然后，为了让 **Action 能够访问该 secret**，你需要像下面这样声明它：
```yaml
steps:
- name: Hello world action
with: # Set the secret as an input
super_secret:${{ secrets.SuperSecret }}
env: # Or as an environment variable
super_secret:${{ secrets.SuperSecret }}
```
#### 示例：使用 Bash <a href="#example-using-bash" id="example-using-bash"></a>
```yaml
steps:
- shell: bash
env: SUPER_SECRET:${{ secrets.SuperSecret }}
run: |
example-command "$SUPER_SECRET"
```
> [!WARNING]
> Secrets **只能从声明了它们的 Github Actions 中访问**。

> 一旦在 repo 或 organizations 中配置，**github 的用户将无法再次访问它们**，他们只能**修改它们**。

因此，**窃取 github secrets 的唯一方法是能够访问正在执行该 Github Action 的机器**（在这种情况下，你只能访问为该 Action 声明的 secrets）。

### Git Environments

Github 允许创建 **environments**，在这些 environments 中可以保存 **secrets**。然后，你可以让 github action 访问该 environment 内的 secrets，例如：
```yaml
jobs:
deployment:
runs-on: ubuntu-latest
environment: env_name
```
您可以将环境配置为 **所有分支**（默认）可访问、**仅受保护分支**可访问，或 **指定** 哪些分支可以访问该环境。\
此外，环境保护还包括：
- **Required reviewers**：在目标环境的作业获批之前阻止其运行。启用 **Prevent self-review** 以在审批环节本身强制实施真正的四眼原则。
- **Deployment branches and tags**：限制哪些分支/标签可以部署到该环境。建议选择具体的分支/标签，并确保这些分支受保护。注意： “Protected branches only” 选项适用于经典的分支保护，如果使用 rulesets 可能不会按预期工作。
- **Wait timer**：延迟部署一段可配置的时间。

还可以设置在使用某个 **environment** 执行某个 **action** 之前所需的 **审查次数**，或者在允许部署继续之前 **等待** 一段 **时间**。

### Git Action Runner

A Github Action 可以在 github environment 内执行，也可以在用户配置的第三方基础设施中执行。

一些组织允许在第三方基础设施上运行 Github Actions，因为通常这样会更便宜。

你可以在 _https://github.com/organizations/\<org_name>/settings/actions/runners_ 列出一个组织的 self-hosted runners。

查找哪些 **Github Actions** 在非 Github 基础设施中执行的方法是搜索 Github Action 配置 yaml 中的 `runs-on: self-hosted`。

不可能在不同组织的 self hosted 机器上运行某个组织的 Github Action，因为在配置 Runner 时会为该 Runner 生成一个唯一的 token，用于识别该 Runner 属于哪个组织。

如果自定义的 Github Runner 部署在例如 AWS 或 GCP 中的机器上，该 Action 可能访问 metadata endpoint 并窃取该机器运行时所使用的 service account 的 token。

### Git Action Compromise

如果允许所有 actions（或某个恶意 action）运行，用户可能会使用一个 **malicious** 的 Github Action，从而**攻破**其执行所在的 **容器**。

> [!CAUTION]
> 恶意的 Github Action 运行可能被攻击者滥用以：
>
> - **窃取该 Action 可访问的所有 secrets**
> - 如果 Action 在可以访问 SA token 的第三方基础设施中执行（很可能通过 metadata service），则**横向移动**
> - **滥用 workflow 使用的 token** 来**窃取仓库代码**（Action 运行的仓库）或**甚至修改代码**

## Branch Protections

Branch protections 的设计目的是不给用户对仓库的完全控制权。目标是在能够向某个分支写入代码之前设置若干保护措施。

一个仓库的 **branch protections** 可以在 _https://github.com/\<orgname>/\<reponame>/settings/branches_ 找到。

> [!NOTE]
> 无法在组织级别设置分支保护。因此必须在每个仓库上逐一声明这些保护。

可以对某个分支（例如 master）应用不同的保护措施：

- 可以 **要求在合并前先创建 PR**（因此不能直接将代码合并到该分支）。如果选择此项，还可以启用其他保护：
- **要求一定数量的批准**。常见做法是要求 1 或 2 个以上的人批准你的 PR，这样单个用户就无法直接合并代码。
- **当有新提交推送时撤销批准**。否则，用户可能先批准合法代码，然后再添加恶意代码并合并。
- **Require approval of the most recent reviewable push**。确保在批准之后的任何新提交（包括其他协作者的推送）都会重新触发审查，以防止攻击者在批准后提交变更并合并。
- **Require reviews from Code Owners**。至少需要仓库的 1 位 code owner 批准 PR（这样“随机”用户不能批准）。
- **Restrict who can dismiss pull request reviews.** 可以指定允许撤销 PR 审查的人或团队。
- **Allow specified actors to bypass pull request requirements**。这些用户将能够绕过前面的限制。
- **Require status checks to pass before merging.** 在合并提交之前一些检查需要通过（例如报告 SAST 结果的 GitHub App）。提示：将必需的检查绑定到特定的 GitHub App；否则任何应用都可能通过 Checks API 假冒该检查，而且许多 bot 接受跳过指令（例如 “@bot-name skip”）。
- **Require conversation resolution before merging**。合并 PR 之前需要解决代码上的所有评论。
- **Require signed commits**。提交需要签名。
- **Require linear history.** 防止向匹配的分支推送 merge commits。
- **Include administrators**。如果未设置此项，管理员可以绕过这些限制。
- **Restrict who can push to matching branches**。限制谁可以推送到匹配分支（或发送 PR）。

> [!NOTE]
> 如你所见，即便你设法获取了某个用户的部分凭据，**仓库的保护措施可能仍会阻止你将代码推送到 master**，例如防止你通过修改 CI/CD 来进行破坏。

## Tag Protections

标签（如 latest、stable）默认是可变的。为在标签更新上实施四眼流程，应保护标签并通过环境与分支串联保护：

1) 在标签保护规则上启用 **Require deployments to succeed**，并要求对受保护环境（例如 prod）成功部署。
2) 在目标环境中，将 **Deployment branches and tags** 限制为发布分支（例如 main），并可选地为 **Required reviewers** 配置 **Prevent self-review**。
3) 在发布分支上，为分支配置保护以 **Require a pull request**，设置 approvals ≥ 1，并启用 **Dismiss approvals when new commits are pushed** 与 **Require approval of the most recent reviewable push**。

该链条可防止单个协作者通过编辑 workflow YAML 来重新打标签或强制发布 release，因为部署闸门是在 workflow 之外强制执行的。

## References

- [https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization](https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization)
- [https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-enterprise/roles-in-an-enterprise](https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-enterprise/roles-in-an-enterprise)[https://docs.github.com/en/enterprise-server](https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-enterprise/roles-in-an-enterprise)
- [https://docs.github.com/en/get-started/learning-about-github/access-permissions-on-github](https://docs.github.com/en/get-started/learning-about-github/access-permissions-on-github)
- [https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-github-user-account/managing-user-account-settings/permission-levels-for-user-owned-project-boards](https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-github-user-account/managing-user-account-settings/permission-levels-for-user-owned-project-boards)
- [https://docs.github.com/en/actions/security-guides/encrypted-secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
- [https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions)
- [https://securitylab.github.com/resources/github-actions-untrusted-input/](https://securitylab.github.com/resources/github-actions-untrusted-input/)
- [https://docs.github.com/en/rest/checks/runs](https://docs.github.com/en/rest/checks/runs)
- [https://docs.github.com/en/apps](https://docs.github.com/en/apps)
- [GitHub Actions: A Cloudy Day for Security - Part 1](https://binarysecurity.no/posts/2025/08/securing-gh-actions-part1)

{{#include ../../banners/hacktricks-training.md}}
