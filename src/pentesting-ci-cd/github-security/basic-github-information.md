# Githubの基本情報

{{#include ../../banners/hacktricks-training.md}}

## Basic Structure

大きな**company**の基本的なgithub環境構造は、**enterprise**を所有し、そのenterpriseが**複数のorganizations**を所有し、それぞれが**複数の repositories**や**複数の teams**を含む可能性がある、というものです。小規模な会社は**1つのorganizationのみを所有し、enterpriseを持たない**場合もあります。

ユーザの観点からは、**user**は**異なるenterpriseやorganizationのmember**である可能性があります。これらの中でuserは**enterprise、organization、repositoryごとに異なる役割**を持つことがあります。

さらに、userは**異なるチームに所属**しており、チームごとにenterprise、organization、またはrepositoryの異なる役割を持つことがあります。

最後に、**repositoriesには特別な保護メカニズムがある場合があります。**

## Privileges

### Enterprise Roles

- **Enterprise owner**: この役割を持つ人は **administratorsの管理、enterprise内のorganizations管理、enterprise設定の管理、organizations全体に対するポリシーの適用** ができます。ただし、organization ownerにされるかorganization所有のrepositoryへの直接アクセス権を与えられない限り、**organization設定やコンテンツへアクセスすることはできません。**
- **Enterprise members**: enterpriseが所有するorganizationsのメンバーは**自動的にenterpriseのmembersにもなります。**

### Organization Roles

Organization内ではユーザは異なる役割を持てます:

- **Organization owners**: Organization ownersは**organizationに対する完全な管理アクセス**を持ちます。この役割は制限すべきですが、組織内で2人未満にしてはいけません。
- **Organization members**: 組織内の人々に対する**デフォルトの非管理者ロール**はorganization memberです。デフォルトで、organization membersは**一定の権限を持ちます**。
- **Billing managers**: Billing managersは、支払い情報など**organizationのbilling設定を管理できるユーザ**です。
- **Security Managers**: Organization ownersがorganization内の任意のチームに割り当てられる役割です。適用されると、そのチームの全メンバーに**organization全体のsecurity alertsや設定の管理権限、ならびにorganization内のすべてのrepositoriesに対する読み取り権限**を与えます。
- organizationにsecurity teamがある場合、security managerロールを使用してチームメンバーに組織への最小限のアクセスを与えることができます。
- **Github App managers**: 組織が所有するGitHub Appsの管理を追加のユーザに許可するため、ownerは彼らにGitHub App manager権限を付与できます。
- **Outside collaborators**: Outside collaboratorは**1つ以上のorganizationのrepositoryにアクセスを持つが、明示的にorganizationのmemberではない人**です。

これらの役割の権限を比較するにはこの表を参照してください: [https://docs.github.com/en/organizations/managing-peoples-access-to-your-organization-with-roles/roles-in-an-organization#permissions-for-organization-roles](https://docs.github.com/en/organizations/managing-peoples-access-to-your-organization-with-roles/roles-in-an-organization#permissions-for-organization-roles)

### Members Privileges

_https://github.com/organizations/\<org_name>/settings/member_privileges_ では、**organizationに所属しているだけのユーザが持つ権限**を確認できます。

ここで設定された内容は組織メンバーの以下の権限を示します:

- 組織の全リポジトリに対して admin, writer, reader または権限なし のいずれかを持つかどうか。
- メンバーが private、internal、public リポジトリを作成できるかどうか。
- リポジトリの fork が可能かどうか。
- Outside collaborators を招待できるかどうか。
- public または private sites を公開できるかどうか。
- administrators がリポジトリに対して持つ権限。
- メンバーが新しい teams を作成できるかどうか。

### Repository Roles

デフォルトでリポジトリのロールは以下が作成されます:

- **Read**: プロジェクトを閲覧または議論したい**非コード貢献者**に推奨。
- **Triage**: 書き込み権限なしで **issues と pull requests を能動的に管理する必要がある貢献者**に推奨。
- **Write**: プロジェクトに**積極的に push する貢献者**に推奨。
- **Maintain**: 敏感または破壊的な操作へのアクセスなしで**リポジトリを管理するプロジェクトマネージャー**に推奨。
- **Admin**: セキュリティ管理やリポジトリ削除などの敏感で破壊的な操作を含む、**プロジェクトに対するフルアクセスが必要な人**に推奨。

各ロールの権限を比較するにはこの表を参照してください: [https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization#permissions-for-each-role](https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization#permissions-for-each-role)

独自のロールを作成することもできます: _https://github.com/organizations/\<org_name>/settings/roles_

### Teams

組織内で作成されたチームを一覧表示するには _https://github.com/orgs/\<org_name>/teams/_ を参照してください。子チーム（他のチームの子）を表示するには各親チームにアクセスする必要がある点に注意してください。

### Users

組織のユーザは _https://github.com/orgs/\<org_name>/people._ で**一覧表示**できます。

各ユーザの情報では、そのuserが**所属しているteams**や**アクセス権を持つrepos**を確認できます。

## Github Authentication

Githubはアカウントに認証し、代わりにアクションを実行するためのさまざまな方法を提供します。

### Web Access

**github.com**にアクセスすると、**username と password**（および**2FA**の場合あり）でログインできます。

### **SSH Keys**

アカウントに1つまたは複数のpublic keysを設定すると、対応する**private keyがあなたに代わってアクションを実行できる**ようになります。 [https://github.com/settings/keys](https://github.com/settings/keys)

#### **GPG Keys**

これらのkeysで**ユーザをなりすますことはできません**が、署名なしでコミットを送ると**発覚する可能性がある**ため、使用していないと検出されることがあります。[vigilant mode here](https://docs.github.com/en/authentication/managing-commit-signature-verification/displaying-verification-statuses-for-all-of-your-commits#about-vigilant-mode) を参照してください。

### **Personal Access Tokens**

personal access tokenを生成して、**アプリケーションにあなたのアカウントへのアクセスを与える**ことができます。personal access tokenを作成する際、**userはtokenが持つ権限を指定する必要があります。** [https://github.com/settings/tokens](https://github.com/settings/tokens)

### Oauth Applications

Oauth applicationsはあなたのgithub情報の一部にアクセスする、またはあなたをなりすましていくつかのアクションを実行するための権限を要求することがあります。一般的な例としては、他のプラットフォームで見かける**login with github ボタン**があります。

- 自分の **Oauth applications** は [https://github.com/settings/developers](https://github.com/settings/developers) で作成できます。
- あなたのアカウントにアクセス権を持つ **Oauth applications** の一覧は [https://github.com/settings/applications](https://github.com/settings/applications) で確認できます。
- Oauth Appsが要求できる **scopes** は [https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps) で確認できます。
- 組織におけるサードパーティアプリケーションのアクセスは _https://github.com/organizations/\<org_name>/settings/oauth_application_policy_ で確認できます。

いくつかの**セキュリティ推奨**:

- **OAuth App**は常に**認証されたGitHubユーザとしてGitHub全体で動作**すべき（例：ユーザ通知の提供時など）、かつ指定されたscopeのみにアクセスするべきです。
- OAuth Appは"Login with GitHub"を有効にすることで、identity providerとして使えます。
- **単一のリポジトリ上でアプリを動かしたい場合はOAuth Appを構築しないでください。** `repo` OAuth scopeを使うと、OAuth Appsは**認証ユーザのすべての repositories に対して動作できてしまいます。**
- **チームや会社として動作させたいだけならOAuth Appを作らないでください。** OAuth Appsは**単一のユーザとして認証**するため、ある人が会社用にOAuth Appを作成して退職すると、他の人がアクセスできなくなります。
- 詳細は [here](https://docs.github.com/en/developers/apps/getting-started-with-apps/about-apps#about-oauth-apps) を参照してください。

### Github Applications

Github applicationsは特定のリソースに対して**github情報へのアクセスやなりすましを行う権限**を要求できます。Github Appsではアプリがアクセスするrepositoriesを指定する必要があります。

- GitHub Appをインストールするには、**organization ownerであるかリポジトリのadmin権限を持っている必要**があります。
- GitHub Appは**personal accountかorganization**に接続する必要があります。
- 自分のGithub applicationは [https://github.com/settings/apps](https://github.com/settings/apps) で作成できます。
- あなたのアカウントにアクセス権を持つ **Github applications** の一覧は [https://github.com/settings/apps/authorizations](https://github.com/settings/apps/authorizations) で確認できます。
- これらが **Github ApplicationsのAPIエンドポイント** です: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-app](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)。アプリの権限に応じて一部にアクセスできます。
- 組織にインストールされている apps は _https://github.com/organizations/\<org_name>/settings/installations_ で確認できます。

いくつかのセキュリティ推奨:

- GitHub Appは**ユーザとは独立して動作すべき**です（ただしアプリが[user-to-server](https://docs.github.com/en/apps/building-github-apps/identifying-and-authorizing-users-for-github-apps#user-to-server-requests) トークンを使用している場合を除く）。user-to-serverアクセスをより安全に保つため、8時間で期限切れになるaccess tokensや、新しいaccess tokenに交換可能なrefresh tokenを使用できます。詳細は "[Refreshing user-to-server access tokens](https://docs.github.com/en/apps/building-github-apps/refreshing-user-to-server-access-tokens)." を参照してください。
- GitHub Appが**特定のrepositoriesと統合されていることを確認**してください。
- GitHub Appは**personal accountかorganization**に接続するべきです。
- GitHub Appにユーザができることをすべて期待しないでください。
- **単に"Login with GitHub"サービスが必要なだけならGitHub Appを使わないでください。** ただし、GitHub Appは[user identification flow](https://docs.github.com/en/apps/building-github-apps/identifying-and-authorizing-users-for-github-apps) を使ってユーザをログインさせつつ他の操作を行うことができます。
- GitHub userとしてのみ動作させたい場合はGitHub Appを作らないでください。
- GitHub Actionsと連携してワークフローファイルを変更したい場合、`workflow` scopeを含むOAuth tokenでユーザを代理して認証する必要があります。ユーザはそのワークフローファイルを含むリポジトリに対してadminまたはwrite権限を持っている必要があります。詳細は "[Understanding scopes for OAuth apps](https://docs.github.com/en/apps/building-oauth-apps/understanding-scopes-for-oauth-apps/#available-scopes)." を参照してください。
- 詳細は [here](https://docs.github.com/en/developers/apps/getting-started-with-apps/about-apps#about-github-apps) を参照してください。

### Github Actions

これは**githubへの認証方法ではありません**が、**悪意あるGithub Actionが不正にgithubへアクセスし得る**可能性があり、Actionに与えられた**privileges**によっては**様々な攻撃**が可能です。以下で詳述します。

## Git Actions

Git actionsは**イベント発生時にコードを実行することを自動化**できます。通常、実行されるコードは**リポジトリのコードに何らかの形で関連**しており（例：dockerコンテナのビルドやPR内に秘密情報が含まれていないかのチェックなど）。

### Configuration

_https://github.com/organizations/\<org_name>/settings/actions_ では、組織の**github actionsの設定**を確認できます。

github actionsの使用を完全に禁止したり、**すべてのgithub actionsを許可**したり、特定のactionsのみを許可する設定が可能です。

また、**誰がGithub Actionの実行に承認を要するか**や、実行時のGithub Actionの**GITHUB_TOKENの権限**を設定することもできます。

### Git Secrets

Github Actionは通常、githubやサードパーティアプリとやり取りするために何らかのsecretを必要とします。これらをリポジトリに平文で置かないように、githubは**Secrets**として格納することを許可しています。

これらのsecretsは**リポジトリ単位または組織全体**で設定できます。Actionがsecretにアクセスできるようにするには、そのsecretを次のように宣言する必要があります。
```yaml
steps:
- name: Hello world action
with: # Set the secret as an input
super_secret:${{ secrets.SuperSecret }}
env: # Or as an environment variable
super_secret:${{ secrets.SuperSecret }}
```
#### Bash を使った例 <a href="#example-using-bash" id="example-using-bash"></a>
```yaml
steps:
- shell: bash
env: SUPER_SECRET:${{ secrets.SuperSecret }}
run: |
example-command "$SUPER_SECRET"
```
> [!WARNING]
> Secrets **はそれらを宣言している Github Actions からのみアクセスできます**。

> リポジトリや組織に設定された後、**users of github won't be able to access them again**。ユーザーはそれらを**change them**することしかできません。

したがって、**the only way to steal github secrets is to be able to access the machine that is executing the Github Action**（そのシナリオでは Action に宣言されたシークレットにしかアクセスできません）。

### Git Environments

Github は **environments** を作成して、そこに **secrets** を保存できます。次に、環境内のシークレットへのアクセス権を github action に次のように付与できます:
```yaml
jobs:
deployment:
runs-on: ubuntu-latest
environment: env_name
```
You can configure an environment to be **accessed** by **all branches** (default), **only protected** branches or **specify** which branches can access it.\
Additionally, environment protections include:
- **Required reviewers**: gate jobs targeting the environment until approved. Enable **Prevent self-review** to enforce a proper four‑eyes principle on the approval itself.
- **Deployment branches and tags**: restrict which branches/tags may deploy to the environment. Prefer selecting specific branches/tags and ensure those branches are protected. Note: the "Protected branches only" option applies to classic branch protections and may not behave as expected if using rulesets.
- **Wait timer**: delay deployments for a configurable period.

It can also set a **number of required reviews** before **executing** an **action** using an **environment** or **wait** some **time** before allowing deployments to proceed.
### Git Action Runner

A Github Action can be **executed inside the github environment** or can be executed in a **third party infrastructure** configured by the user.

Several organizations will allow to run Github Actions in a **third party infrastructure** as it use to be **cheaper**.

You can **list the self-hosted runners** of an organization in _https://github.com/organizations/\<org_name>/settings/actions/runners_

The way to find which **Github Actions are being executed in non-github infrastructure** is to search for `runs-on: self-hosted` in the Github Action configuration yaml.

It's **not possible to run a Github Action of an organization inside a self hosted box** of a different organization because **a unique token is generated for the Runner** when configuring it to know where the runner belongs.

If the custom **Github Runner is configured in a machine inside AWS or GCP** for example, the Action **could have access to the metadata endpoint** and **steal the token of the service account** the machine is running with.

### Git Action Compromise

If all actions (or a malicious action) are allowed a user could use a **Github action** that is **malicious** and will **compromise** the **container** where it's being executed.

> [!CAUTION]
> A **malicious Github Action** run could be **abused** by the attacker to:
>
> - **Steal all the secrets** the Action has access to
> - **Move laterally** if the Action is executed inside a **third party infrastructure** where the SA token used to run the machine can be accessed (probably via the metadata service)
> - **Abuse the token** used by the **workflow** to **steal the code of the repo** where the Action is executed or **even modify it**.

## Branch Protections

Branch protections are designed to **not give complete control of a repository** to the users. The goal is to **put several protection methods before being able to write code inside some branch**.

The **branch protections of a repository** can be found in _https://github.com/\<orgname>/\<reponame>/settings/branches_

> [!NOTE]
> It's **not possible to set a branch protection at organization level**. So all of them must be declared on each repo.

Different protections can be applied to a branch (like to master):

- You can **require a PR before merging** (so you cannot directly merge code over the branch). If this is select different other protections can be in place:
- **Require a number of approvals**. It's very common to require 1 or 2 more people to approve your PR so a single user isn't capable of merge code directly.
- **Dismiss approvals when new commits are pushed**. If not, a user may approve legit code and then the user could add malicious code and merge it.
- **Require approval of the most recent reviewable push**. Ensures that any new commits after an approval (including pushes by other collaborators) re-trigger review so an attacker cannot push post-approval changes and merge.
- **Require reviews from Code Owners**. At least 1 code owner of the repo needs to approve the PR (so "random" users cannot approve it)
- **Restrict who can dismiss pull request reviews.** You can specify people or teams allowed to dismiss pull request reviews.
- **Allow specified actors to bypass pull request requirements**. These users will be able to bypass previous restrictions.
- **Require status checks to pass before merging.** Some checks need to pass before being able to merge the commit (like a GitHub App reporting SAST results). Tip: bind required checks to a specific GitHub App; otherwise any app could spoof the check via the Checks API, and many bots accept skip directives (e.g., "@bot-name skip").
- **Require conversation resolution before merging**. All comments on the code needs to be resolved before the PR can be merged.
- **Require signed commits**. The commits need to be signed.
- **Require linear history.** Prevent merge commits from being pushed to matching branches.
- **Include administrators**. If this isn't set, admins can bypass the restrictions.
- **Restrict who can push to matching branches**. Restrict who can send a PR.

> [!NOTE]
> As you can see, even if you managed to obtain some credentials of a user, **repos might be protected avoiding you to pushing code to master** for example to compromise the CI/CD pipeline.

## Tag Protections

Tags (like latest, stable) are mutable by default. To enforce a four‑eyes flow on tag updates, protect tags and chain protections through environments and branches:

1) On the tag protection rule, enable **Require deployments to succeed** and require a successful deployment to a protected environment (e.g., prod).
2) In the target environment, restrict **Deployment branches and tags** to the release branch (e.g., main) and optionally configure **Required reviewers** with **Prevent self-review**.
3) On the release branch, configure branch protections to **Require a pull request**, set approvals ≥ 1, and enable both **Dismiss approvals when new commits are pushed** and **Require approval of the most recent reviewable push**.

This chain prevents a single collaborator from retagging or force-publishing releases by editing workflow YAML, since deployment gates are enforced outside of workflows.

## References

- [https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization](https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization)
- [https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-enterprise/roles-in-an-enterprise](https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-enterprise/roles-in-an-enterprise)[https://docs.github.com/en/enterprise-server](https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-enterprise/roles-in-an-enterprise)
- [https://docs.github.com/en/get-started/learning-about-github/access-permissions-on-github](https://docs.github.com/en/get-started/learning-about-github/access-permissions-on-github)
- [https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-github-user-account/managing-user-account-settings/permission-levels-for-user-owned-project-boards](https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-github-user-account/managing-user-account-settings/permission-levels-for-user-owned-project-boards)
- [https://docs.github.com/en/actions/security-guides/encrypted-secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
- [https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions)
- [https://securitylab.github.com/resources/github-actions-untrusted-input/](https://securitylab.github.com/resources/github-actions-untrusted-input/)
- [https://docs.github.com/en/rest/checks/runs](https://docs.github.com/en/rest/checks/runs)
- [https://docs.github.com/en/apps](https://docs.github.com/en/apps)
- [GitHub Actions: A Cloudy Day for Security - Part 1](https://binarysecurity.no/posts/2025/08/securing-gh-actions-part1)

{{#include ../../banners/hacktricks-training.md}}
