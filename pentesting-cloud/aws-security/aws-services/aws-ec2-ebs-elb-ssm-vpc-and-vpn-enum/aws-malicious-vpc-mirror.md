# AWS - Malicious VPC Mirror

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!

Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)

Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)

**Join the** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/carlospolopm)**.**

**Share your hacking tricks submitting PRs to the** [**hacktricks github repo**](https://github.com/carlospolop/hacktricks)**.**

</details>

VPC traffic mirroring **duplicates inbound and outbound traffic for EC2 instances within a VPC** without the need to install anything on the instances themselves. This duplicated traffic would commonly be sent to something like a network intrusion detection system (IDS) for analysis and monitoring.

With the difficulty of general network inspection in the cloud, pentesters have resorted to other, simpler means, such as reviewing Elastic Load Balancer access logs. Those logs give you _something,_ but it is very limited when compared to full network traffic inspection.&#x20;

### Deploying a Malicious Mirror with Compromised AWS Credentials

It is important to note that **VPC Traffic Mirroring** is only **supported** by **EC2** instance types that are powered by the [**AWS Nitro system**](https://aws.amazon.com/ec2/nitro/) **** and that the **VPC mirror target must be within the same VPC** as any hosts that are being mirrored.

In the next few sections, we‚Äôll cover how malmirror works, what it does, and how to analyze the exfiltrated data. The script itself can be [found on our GitHub here](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/tree/master/AWS/malmirror/).

#### How malmirror Works

malmirror deploys the following resources into an account:

* An EC2 instance to mirror traffic to
* An EC2 security group for that EC2 instance
* A VPC Mirror Target, pointing to the created EC2 instance
* A VPC Mirror Filter that is configured to mirror all traffic
* A VPC Mirror Session for each supported EC2 instance in the account

![](<../../../../.gitbook/assets/image (72).png>)

After everything is deployed, **traffic will begin mirroring to the EC2 instance that was created**. The EC2 instance will begin listening for and logging all the mirrored network traffic that it receives in PCAP format. After about **100MB of data stored locally on the instance**, it will automatically **exfiltrate that data into an S3 bucket** of your choice (likely in your **own AWS account**) and **delete the local file** from the system. This prevents the instance from running out of space and allows us to exfiltrate the mirrored traffic in an automated fashion. Note that the 100MB limit is arbitrary and may be far too small for some networks where there is a greater amount of traffic flowing through it. The traffic is exfiltrated this way because there did not seem to be an easy way to mirror the traffic cross-account and this seemed like a reliable way to ensure the data makes it out of the environment.

As the traffic is being exfiltrated to your S3 bucket, you can download it locally for analysis. A simple way to do this would be with the [S3 ‚ÄúSync‚Äù command offered by the AWS CLI](https://docs.aws.amazon.com/cli/latest/reference/s3/sync.html) so that you only download the data that you are missing from the last time you synced with the bucket.

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!

Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)

Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)

**Join the** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/carlospolopm)**.**

**Share your hacking tricks submitting PRs to the** [**hacktricks github repo**](https://github.com/carlospolop/hacktricks)**.**

</details>
