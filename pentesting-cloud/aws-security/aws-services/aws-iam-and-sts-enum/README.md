# AWS - IAM & STS Enum

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## IAM

You can find a **description of IAM** in:

{% content-ref url="../../aws-basic-information/" %}
[aws-basic-information](../../aws-basic-information/)
{% endcontent-ref %}

### Enumeration

```bash
# All IAMs
## Retrieves  information about all IAM users, groups, roles, and policies
## in your Amazon Web Services account, including their relationships  to
##¬†one another. Use this operation to obtain a snapshot of the configura-
## tion of IAM permissions (users, groups, roles, and  policies)  in  your
## account.
aws iam get-account-authorization-details

# List users
aws iam list-users
aws iam list-ssh-public-keys #User keys for CodeCommit
aws iam get-ssh-public-key --user-name <username> --ssh-public-key-id <id> --encoding SSH #Get public key with metadata
aws iam list-service-specific-credentials #Get special permissions of the IAM user over specific services
aws iam get-user --user-name <username> #Get metadata of user
aws iam list-access-keys #List created access keys
## inline policies
aws iam list-user-policies --user-name <username> #Get inline policies of the user
aws iam get-user-policy --user-name <username> --policy-name <policyname> #Get inline policy details
## attached policies
aws iam list-attached-user-policies --user-name <username> #Get policies of user, it doesn't get inline policies

# List groups
aws iam list-groups #Get groups
aws iam list-groups-for-user --user-name <username> #Get groups of a user
aws iam get-group --group-name <name> #Get group name info
## inline policies
aws iam list-group-policies --group-name <username> #Get inline policies of the group
aws iam get-group-policy --group-name <username> --policy-name <policyname> #Get an inline policy info
## attached policies
aws iam list-attached-group-policies --group-name <name> #Get policies of group, it doesn't get inline policies

# List roles
aws iam list-roles #Get roles
aws iam get-role --role-name <role-name> #Get role

## inline policies
aws iam list-role-policies --role-name <name> #Get inline policies of a role
aws iam get-role-policy --role-name <name> --policy-name <name> #Get inline policy details
aws iam list-attached-role-policies --role-name <role-name> #Get policies of role, it doesn't get inline policies

# List policies
aws iam list-policies [--only-attached] [--scope Local]
aws iam list-policies-granting-service-access --arn <identity> --service-namespaces <svc> # Get list of policies that give access to the user to the service
## Get policy content
aws iam get-policy --policy-arn <policy_arn>
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn:aws:iam::975426262029:policy/list_apigateways> --version-id <VERSION_X>

# Misc
aws iam get-account-password-policy
aws iam list-mfa-devices
aws iam list-virtual-mfa-devices
aws iam list-open-id-connect-providers
aws iam list-saml-providers
```

{% hint style="warning" %}
If you are interested in your own permissions but you don't have access to query IAM you could always brute-force them using **** [**https://github.com/andresriancho/enumerate-iam**](https://github.com/andresriancho/enumerate-iam) **** (don't forget to **update the API file** as indicated in the instructions).

You could also use the tool [**weirdAAL**](https://github.com/carnal0wnage/weirdAAL/wiki) **** which will indicate in the output the actions you can perform in the most common AWS services.

```bash
# Install
git clone https://github.com/carnal0wnage/weirdAAL.git
cd weirdAAL
python3 -m venv weirdAAL
source weirdAAL/bin/activate
pip3 install -r requirements.txt

# Create a .env file with aws credentials such as
[default]
aws_access_key_id = <insert key id>
aws_secret_access_key = <insert secret key>

# Invoke it
python3 weirdAAL.py -m recon_all -t MyTarget
# You will see output such as:
# [+] elbv2 Actions allowed are [+]
# ['DescribeLoadBalancers', 'DescribeAccountLimits', 'DescribeTargetGroups']
```
{% endhint %}

### Privesc

In the following page you can check how to **abuse IAM permissions to escalate privileges**:

{% content-ref url="../../aws-privilege-escalation/aws-iam-privesc.md" %}
[aws-iam-privesc.md](../../aws-privilege-escalation/aws-iam-privesc.md)
{% endcontent-ref %}

### Privesc Abusing Confuse Deputy

{% content-ref url="aws-confused-deputy.md" %}
[aws-confused-deputy.md](aws-confused-deputy.md)
{% endcontent-ref %}

### Persistence

* create a user
* create access keys (of the new user or of all users)
* create a role and attach it to the principal

## STS

AWS provides AWS **Security Token Service (AWS STS)** as a web service that enables you to **request** temporary, limited-privilege **credentials** for **AWS Identity and Access Management** (IAM) users or for users you authenticate (federated users).

As the nature of the STS service is to **provide credentials to impersonate identities**, this service, eve if don't have a lot of options, will be very useful to **escalate privileges and obtain persistence**.

### Enumeration

```bash
# Get bais info of the creds
aws sts get-caller-identity
aws sts get-access-key-info --access-key-id <AccessKeyID>
```

### Privesc

In the following page you can check how to **abuse STS permissions to escalate privileges**:

{% content-ref url="../../aws-privilege-escalation/aws-sts-privesc.md" %}
[aws-sts-privesc.md](../../aws-privilege-escalation/aws-sts-privesc.md)
{% endcontent-ref %}

### Persistence

#### Assume role token

Temporary tokens cannot be listed, so maintaining an active temporary token is a way to maintain persistence.

<pre class="language-bash"><code class="lang-bash">aws sts get-session-token --duration-seconds 129600

# With MFA
aws sts get-session-token \
    --serial-number &#x3C;mfa-device-name> \
    --token-code &#x3C;code-from-token>

# Hardware device name is usually the number from the back of the device, such as GAHT12345678
<strong># SMS device name is the ARN in AWS, such as arn:aws:iam::123456789012:sms-mfa/username
</strong># Vritual device name is the ARN in AWS, such as arn:aws:iam::123456789012:mfa/username</code></pre>

#### Role Chain Juggling

****[**Role chaining**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_terms-and-concepts.html#Role%20chaining) is a recognized functionality of AWS in that you can use one **assumed role to assume another one**. When this happens the **expiration field of the credentials is refreshed**. This allows us to keep refreshing credentials over an over again. Through this, you can extend your access by **chaining** [**assume-role**](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/sts/assume-role.html) **calls**.

You can chain the same role multiple times so long as the Trust Policy is configured correctly. Additionally, **finding roles that can assume each other will allow you to cycle back and forth**.\
To automate this work Daniel Heinsen developed a **** [**tool**](https://github.com/hotnops/AWSRoleJuggler/) **** to keep the juggling going.

```bash
user@host:$ ./aws_role_juggler.py -h
usage: aws_role_juggler.py [-h] [-r ROLE_LIST [ROLE_LIST ...]]

optional arguments:
  -h, --help            show this help message and exit
  -r ROLE_LIST [ROLE_LIST ...], --role-list ROLE_LIST [ROLE_LIST ...]
```

### Post-Exploitation

#### From IAM Creds to Console

if you have managed to obtain some IAM credentials you might be interested on accessing the web console. You can **generate a web console link** with [https://github.com/NetSPI/aws\_consoler](https://github.com/NetSPI/aws\_consoler).

```bash
cd /tmp
python3 -m venv env
source ./env/bin/activate
pip install aws-consoler
aws_consoler [params...] #This will generate a link to login into the console
```

{% hint style="warning" %}
Ensure the IAM user has `sts:GetFederationToken` permission, or provide a role to assume.
{% endhint %}

#### aws-vault

****[**aws-vault**](https://github.com/99designs/aws-vault) is a tool to securely store and access AWS credentials in a development environment.

```bash
aws-vault list
aws-vault exec jonsmith -- aws s3 ls # Execute aws cli with jonsmith creds
aws-vault login jonsmith # Open a browser logged as jonsmith
```

{% hint style="info" %}
You can also use **aws-vault** to obtain an **browser console session**
{% endhint %}

#### From Console to IAM Creds

If you manage to compromise some access to a web console (maybe you stole cookies and could't access the .aws folder), you can obtain some IAM token credentials for that user through **CloudShell**.

CloudShell exposes IAM credentials via an **undocumented endpoint on port 1338**. After loading session cookies from the victim into your browser, you can navigate to CloudShell and issue the following commands to get IAM credentials.

```bash
TOKEN=$(curl -X PUT localhost:1338/latest/api/token -H "X-aws-ec2-metadata-token-ttl-seconds: 60")
curl localhost:1338/latest/meta-data/container/security-credentials -H "X-aws-ec2-metadata-token: $TOKEN"
```

## References

* [https://hackingthe.cloud/aws/post\_exploitation/role-chain-juggling/](https://hackingthe.cloud/aws/post\_exploitation/role-chain-juggling/)
* [https://hackingthe.cloud/aws/post\_exploitation/aws\_consoler/](https://hackingthe.cloud/aws/post\_exploitation/aws\_consoler/)
* [https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist)
* [https://frichetten.com/blog/ssm-agent-tomfoolery/](https://frichetten.com/blog/ssm-agent-tomfoolery/)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
